\input cwebmac
%\input pdfcwebmac
% $Id: mp.w 2005 2014-04-09 10:02:21Z taco $
%
% This file is part of MetaPost;
% the MetaPost program is in the public domain.
% See the <Show version...> code in mpost.w for more info.

% Here is TeX material that gets inserted after \input webmac
\def\hang{\hangindent 3em\noindent\ignorespaces}
\def\textindent#1{\hangindent2.5em\noindent\hbox to2.5em{\hss#1 }\ignorespaces}
\def\ps{PostScript}
\def\psqrt#1{\sqrt{\mathstrut#1}}
\def\k{_{k+1}}
\def\pct!{{\char`\%}} % percent sign in ordinary text
\font\tenlogo=logo10 % font used for the METAFONT logo
\font\logos=logosl10
\def\MF{{\tenlogo META}\-{\tenlogo FONT}}
\def\MP{{\tenlogo META}\-{\tenlogo POST}}
\def\<#1>{$\langle#1\rangle$}
\def\section{\mathhexbox278}
\let\swap=\leftrightarrow
\def\round{\mathop{\rm round}\nolimits}
\mathchardef\vbv="026A % synonym for `\|'
\def\vb{\relax\ifmmode\vbv\else$\vbv$\fi}

\def\(#1){} % this is used to make section names sort themselves better
\def\9#1{} % this is used for sort keys in the index via @:sort key}{entry@>
\def\title{MetaPost}
\pdfoutput=1
\pageno=3


\N{1}{1}Introduction.

This is \MP\ by John Hobby, a graphics-language processor based on D. E.
Knuth's \MF.

Much of the original Pascal version of this program was copied with
permission from MF.web Version 1.9. It interprets a language very
similar to D.E. Knuth's METAFONT, but with changes designed to make it
more suitable for PostScript output.

The main purpose of the following program is to explain the algorithms of \MP\
as clearly as possible. However, the program has been written so that it
can be tuned to run efficiently in a wide variety of operating environments
by making comparatively few changes. Such flexibility is possible because
the documentation that follows is written in the \.{WEB} language, which is
at a higher level than C.

A large piece of software like \MP\ has inherent complexity that cannot
be reduced below a certain level of difficulty, although each individual
part is fairly simple by itself. The \.{WEB} language is intended to make
the algorithms as readable as possible, by reflecting the way the
individual program pieces fit together and by providing the
cross-references that connect different parts. Detailed comments about
what is going on, and about why things were done in certain ways, have
been liberally sprinkled throughout the program.  These comments explain
features of the implementation, but they rarely attempt to explain the
\MP\ language itself, since the reader is supposed to be familiar with
{\sl The {\logos METAFONT\/}book} as well as the manual
{\sl A User's Manual for MetaPost}, Computing Science Technical Report 162,
AT\AM T Bell Laboratories.

\fi

\M{2}The present implementation is a preliminary version, but the possibilities
for new features are limited by the desire to remain as nearly compatible
with \MF\ as possible.

On the other hand, the \.{WEB} description can be extended without changing
the core of the program, and it has been designed so that such
extensions are not extremely difficult to make.
The \PB{\\{banner}} string defined here should be changed whenever \MP\
undergoes any modifications, so that it will be clear which version of
\MP\ might be the guilty party when a problem arises.

\Y\B\4\D$\\{default\_banner}$ \5
\.{"This\ is\ MetaPost,\ V}\)\.{ersion\ 1.999"}\C{ printed when \MP\ starts }%
\par
\B\4\D$\\{true}$ \5
\T{1}\par
\B\4\D$\\{false}$ \5
\T{0}\par
\Y\B\4\X2:Metapost version header\X${}\E{}$\6
\8\#\&{define} \\{metapost\_version} \5\.{"1.999"}\par
\U3.\fi

\M{3}The external library header for \MP\ is \PB{$\\{mplib}.\|h$}. It contains
a
few typedefs and the header defintions for the externally used
fuctions.

The most important of the typedefs is the definition of the structure
\PB{\\{MP\_options}}, that acts as a small, configurable front-end to the
fairly
large \PB{\\{MP\_instance}} structure.

\Y\B\4\X3:\.{mplib.h }\X${}\E{}$\6
\8\#\&{ifndef} \.{MPLIB\_H}\6
\8\#\&{define} \.{MPLIB\_H} \5\T{1}\6
\8\#\&{include} \.{<stdlib.h>}\6
\8\#\&{ifndef} \.{HAVE\_BOOLEAN}\6
\&{typedef} \&{int} \&{boolean};\6
\8\#\&{endif}\6
\X2:Metapost version header\X\1\1\6
\&{typedef} \&{struct} \\{MP\_instance} ${}{*}\&{MP};$ \X15:Exported types\X\1%
\1\6
\&{typedef} \&{struct} \&{MP\_options} ${}\{{}$\1\6
\X26:Option variables\X\2\6
${}\}{}$ \&{MP\_options}; \X18:Exported function headers\X\X201:MPlib header
stuff\X\6
\8\#\&{endif}\par
\fi

\M{4}The internal header file is much longer: it not only lists the complete
\PB{\\{MP\_instance}}, but also a lot of functions that have to be available to
the \ps\ backend, that is defined in a separate \.{WEB} file.

The variables from \PB{\&{MP\_options}} are included inside the \PB{\\{MP%
\_instance}}
wholesale.

\Y\B\4\X4:\.{mpmp.h }\X${}\E{}$\6
\8\#\&{ifndef} \.{MPMP\_H}\6
\8\#\&{define} \.{MPMP\_H} \5\T{1}\6
\8\#\&{include} \.{"avl.h"}\6
\8\#\&{include} \.{"mplib.h"}\6
\8\#\&{include} \.{<setjmp.h>}\6
\&{typedef} \&{struct} \\{psout\_data\_struct} ${}{*}\&{psout\_data};{}$\6
\&{typedef} \&{struct} \\{svgout\_data\_struct} ${}{*}\&{svgout\_data};{}$\6
\&{typedef} \&{struct} \\{pngout\_data\_struct} ${}{*}\&{pngout\_data};{}$\6
\8\#\&{ifndef} \.{HAVE\_BOOLEAN}\6
\&{typedef} \&{int} \&{boolean};\6
\8\#\&{endif}\6
\8\#\&{ifndef} \.{INTEGER\_TYPE}\6
\&{typedef} \&{int} \&{integer};\6
\8\#\&{endif}\7
\X165:Declare helpers\X;\6
\X185:Enumeration types\X;\6
\X33:Types in the outer block\X;\6
\X23:Constants in the outer block\X;\7
\&{typedef} \&{struct} \&{MP\_instance} ${}\{{}$\1\6
\X26:Option variables\X\X14:Global variables\X\2\6
${}\}{}$ \&{MP\_instance}; \X10:Internal library declarations\X\X6:MPlib
internal header stuff\X\6
\8\#\&{endif}\par
\fi

\M{5}\B\6
\8\#\&{define} \.{KPATHSEA\_DEBUG\_H} \5\T{1}\6
\8\#\&{include} \.{<w2c/config.h>}\6
\8\#\&{include} \.{<stdio.h>}\6
\8\#\&{include} \.{<stdlib.h>}\6
\8\#\&{include} \.{<string.h>}\6
\8\#\&{include} \.{<stdarg.h>}\6
\8\#\&{include} \.{<assert.h>}\6
\8\#\&{include} \.{<math.h>}\6
\8\#\&{ifdef} \.{HAVE\_UNISTD\_H}\6
\8\#\&{include} \.{<unistd.h>}\C{ for access }\6
\8\#\&{endif}\6
\8\#\&{include} \.{<time.h>}\C{ for struct tm \& co }\6
\8\#\&{include} \.{<zlib.h>}\C{ for ZLIB\_VERSION, zlibVersion() }\6
\8\#\&{include} \.{<png.h>}\C{ for PNG\_LIBPNG\_VER\_STRING, png\_libpng\_ver }\6
\8\#\&{include} \.{<pixman.h>}\C{ for PIXMAN\_VERSION\_STRING,
pixman\_version\_string() }\6
\8\#\&{include} \.{<cairo.h>}\C{ for CAIRO\_VERSION\_STRING,
cairo\_version\_string() }\6
\8\#\&{include} \.{<gmp.h>}\C{ for gmp\_version }\6
\8\#\&{include} \.{<mpfr.h>}\C{ for MPFR\_VERSION\_STRING, mpfr\_get\_version() }\6
\8\#\&{include} \.{"mplib.h"}\6
\8\#\&{include} \.{"mplibps.h"}\C{ external header }\6
\8\#\&{include} \.{"mplibsvg.h"}\C{ external header }\6
\8\#\&{include} \.{"mplibpng.h"}\C{ external header }\6
\8\#\&{include} \.{"mpmp.h"}\C{ internal header }\6
\8\#\&{include} \.{"mppsout.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpsvgout.h"}\C{ internal header }\6
\8\#\&{include} \.{"mppngout.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpmath.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpmathdouble.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpmathdecimal.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpmathbinary.h"}\C{ internal header }\6
\8\#\&{include} \.{"mpstrings.h"}\C{ internal header }\6
\&{extern} \\{font\_number}\\{mp\_read\_font\_info}(\&{MP} \\{mp}${},\39{}$%
\&{char} ${}{*}\\{fname}){}$;\C{ tfmin.w }\6
\ATH\7
\X8:Declarations\X;\6
\X85:Basic printing procedures\X;\6
\X112:Error handling procedures\X\par
\fi

\M{6}Some debugging support for development. The trick with the variadic macros
probably only works in gcc, as this preprocessor feature was not formalized
until the c99 standard (and that is too new for us). Lets' hope that at least
most compilers understand the non-debug version.

\Y\B\4\X6:MPlib internal header stuff\X${}\E{}$\6
\8\#\&{define} \.{DEBUG} \5\T{0}\6
\8\#\&{if} \.{DEBUG}\6
\8\#\&{define} \\{debug\_number}(\|A)\\{printf} \5${}(\.{"\%d:\ \%s=\%.32f\ (%
\%d)\\n}\)\.{"},\39\.{\_\_LINE\_\_},\39{\#}\|A,\39\\{number\_to\_double}(\|A),%
\39\\{number\_to\_scaled}(\|A)){}$\6
\8\#\&{else}\6
\8\#\&{define} \\{debug\_number} \5(\|A)\6
\8\#\&{endif}\6
\8\#\&{if} ${}\.{DEBUG}>\T{1}{}$\6
\&{void} \\{do\_debug\_printf}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{prefix},\39{}$\&{const} \&{char} ${}{*}\\{fmt},\39\,\ldots\,);{}$\6
\8\#\&{define} ${}\\{debug\_printf}(\\{a1},\39\\{a2},\39\\{a3})\\{do\_debug%
\_printf} \5(\\{mp},\39\.{""},\39\\{a1},\39\\{a2},\39\\{a3}){}$\6
\8\#\&{define} \.{FUNCTION\_TRACE1}(\\{a1})\\{do\_debug\_printf} \5${}(\\{mp},%
\39\.{"FTRACE:\ "},\39\\{a1}){}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE2}(\\{a1},\39\\{a2})\\{do\_debug\_printf} %
\5(\\{mp},\39\.{"FTRACE:\ "},\39\\{a1},\39\\{a2}){}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE3}(\\{a1},\39\\{a2},\39\\{a3})\\{do\_debug%
\_printf} \5(\\{mp},\39\.{"FTRACE:\ "},\39\\{a1},\39\\{a2},\39\\{a3}){}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE3X}(\\{a1},\39\\{a2},\39\\{a3})(\&{void}) %
\5\\{mp}{}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE4}(\\{a1},\39\\{a2},\39\\{a3},\39\\{a4})%
\\{do\_debug\_printf} \5(\\{mp},\39\.{"FTRACE:\ "},\39\\{a1},\39\\{a2},\39%
\\{a3},\39\\{a4}){}$\6
\8\#\&{else}\6
\8\#\&{define} \\{debug\_printf} \5${}(\\{a1},\39\\{a2},\39\\{a3}){}$\6
\8\#\&{define} \.{FUNCTION\_TRACE1}(\\{a1})(\&{void}) \5\\{mp}\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE2}(\\{a1},\39\\{a2})(\&{void}) \5\\{mp}{}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE3}(\\{a1},\39\\{a2},\39\\{a3})(\&{void}) \5%
\\{mp}{}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE3X}(\\{a1},\39\\{a2},\39\\{a3})(\&{void}) %
\5\\{mp}{}$\6
\8\#\&{define} ${}\.{FUNCTION\_TRACE4}(\\{a1},\39\\{a2},\39\\{a3},\39\\{a4})(%
\&{void}) \5\\{mp}{}$\6
\8\#\&{endif}\par
\As36, 67, 82, 174, 193, 235, 251, 262, 267, 270, 273, 455, 458, 462, 469, 473,
477, 482\ETs805.
\U4.\fi

\M{7}This function occasionally crashes (if something is written after the
log file is already closed), but that is not so important while debugging.

\Y\B\8\#\&{if} \.{DEBUG}\6
\&{void} \\{do\_debug\_printf}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{prefix},\39{}$\&{const} \&{char} ${}{*}\\{fmt},\39\,\ldots\,);$ \&{void} %
\\{do\_debug\_printf}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{prefix},\39{}$\&{const} \&{char} ${}{*}\\{fmt},\39\,\ldots\,){}$\1\1 $\{$ %
\&{va\_list} \\{ap};\6
\8\#\&{if} \T{0}\7
${}\\{va\_start}(\\{ap},\39\\{fmt});{}$\6
\&{if} ${}(\\{mp}\MG\\{log\_file}\W\R\\{ferror}{}$((\&{FILE} ${}{*}){}$ %
\\{mp}${}\MG\\{log\_file})){}$\5
${}\{{}$\1\6
${}\\{fputs}(\\{prefix},\39\\{mp}\MG\\{log\_file});{}$\6
${}\\{vfprintf}(\\{mp}\MG\\{log\_file},\39\\{fmt},\39\\{ap});{}$\6
\4${}\}{}$\2\6
\\{va\_end}(\\{ap});\6
\8\#\&{endif}\6
${}\\{va\_start}(\\{ap},\39\\{fmt});{}$\6
\8\#\&{if} \T{0}\6
\&{if} ${}(\\{mp}\MG\\{term\_out}\W\R\\{ferror}{}$((\&{FILE} ${}{*}){}$ %
\\{mp}${}\MG\\{term\_out})){}$\5
${}\{{}$\6
\8\#\&{else}\1\6
\&{if} (\\{false})\5
${}\{{}$\6
\8\#\&{endif}\1\6
${}\\{fputs}(\\{prefix},\39\\{mp}\MG\\{term\_out});{}$\6
${}\\{vfprintf}(\\{mp}\MG\\{term\_out},\39\\{fmt},\39\\{ap});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{fputs}(\\{prefix},\39\\{stdout});{}$\6
${}\\{vfprintf}(\\{stdout},\39\\{fmt},\39\\{ap});{}$\6
\4${}\}{}$\2\6
\\{va\_end}(\\{ap});\6
\4${}\}{}$\2\6
\8\#\&{endif}\par
\fi

\M{8}Here are the functions that set up the \MP\ instance.

\Y\B\4\X8:Declarations\X${}\E{}$\6
\&{MP\_options} ${}{*}\\{mp\_options}(\&{void});{}$\6
\&{MP} \\{mp\_initialize}(\&{MP\_options} ${}{*}\\{opt}){}$;\par
\As45, 70, 84, 95, 101, 107, 121, 177, 187, 205, 206, 214, 217, 223, 238, 241,
244, 246, 253, 255, 264, 279, 284, 286, 302, 310, 312, 314, 326, 347, 349, 359,
364, 370, 404, 418, 422, 433, 439, 468, 485, 491, 496, 501, 505, 512, 533, 551,
553, 556, 560, 567, 587, 622, 625, 627, 631, 636, 640, 643, 645, 647, 661, 666,
670, 680, 689, 708, 710, 726, 728, 731, 738, 750, 765, 780, 783, 786, 788, 796,
845, 856, 889, 896, 906, 917, 921, 924, 950, 954, 967, 972, 1033, 1036, 1038,
1042, 1044, 1056, 1059, 1088, 1095, 1171, 1234, 1238, 1240, 1272, 1274, 1283,
1288\ETs1296.
\U5.\fi

\M{9}\B\&{MP\_options} ${}{*}\\{mp\_options}(\&{void}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{MP\_options} ${}{*}\\{opt};{}$\6
\&{size\_t} \|l${}\K\&{sizeof}(\&{MP\_options});{}$\7
${}\\{opt}\K\\{malloc}(\|l);{}$\6
\&{if} ${}(\\{opt}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{memset}(\\{opt},\39\T{0},\39\|l);{}$\6
\4${}\}{}$\2\6
\&{return} \\{opt};\6
\4${}\}{}$\2\par
\fi

\M{10}\B\X10:Internal library declarations\X${}\E{}$\6
\X861:Declare subroutines for parsing file names\X\par
\As83, 93, 108, 113, 134, 136, 154, 172, 180, 329, 852, 870, 872, 1096, 1231,
1250, 1253\ETs1261.
\U4.\fi

\M{11}The whole instance structure is initialized with zeroes,
this greatly reduces the number of statements needed in
the \PB{$\\{Allocate}\Xor\\{initialize}\\{variables}$} block.

\Y\B\4\D$\\{set\_callback\_option}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{mp}\MG\|A\K\\{mp\_}\#{\#}\|A;{}$\6
\&{if} ${}(\\{opt}\MG\|A\I\NULL){}$\1\5
${}\\{mp}\MG\|A\K\\{opt}\MG\|A;{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{MP} \\{mp\_do\_new}(\&{jmp\_buf} ${}{*}\\{buf}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{MP} \\{mp}${}\K\\{malloc}(\&{sizeof}(\&{MP\_instance}));{}$\7
\&{if} ${}(\\{mp}\E\NULL){}$\5
${}\{{}$\1\6
\\{xfree}(\\{buf});\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\6
${}\\{memset}(\\{mp},\39\T{0},\39\&{sizeof}(\&{MP\_instance}));{}$\6
${}\\{mp}\MG\\{jump\_buf}\K\\{buf};{}$\6
\&{return} \\{mp};\6
\4${}\}{}$\2\par
\fi

\M{12}\B\&{static} \&{void} \\{mp\_free}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\C{ loop variable }\7
\X27:Dealloc variables\X;\6
\&{if} ${}(\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\X1065:Finish non-interactive use\X;\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{jump\_buf});{}$\6
\X183:Free table entries\X;\6
\\{free\_math}(\,);\6
\\{xfree}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{13}\B\&{static} \&{void} \\{mp\_do\_initialize}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\X35:Local variables for initialization\X;\6
\X38:Set initial values of key variables\X;\6
\4${}\}{}$\2\par
\fi

\M{14}For the retargetable math library, we need to have a pointer, at least.

\Y\B\4\X14:Global variables\X${}\E{}$\6
\&{void} ${}{*}\\{math}{}$;\par
\As25, 29, 37, 47, 60, 65, 73, 76, 77, 105, 109, 111, 138, 142, 150, 166, 175,
181, 194, 208, 210, 216, 225, 291, 325, 340, 345, 367, 384, 430, 447, 543, 545,
604, 605, 610, 614, 623, 634, 667, 674, 679, 685, 691, 719, 730, 762, 766, 807,
822, 841, 844, 865, 893, 899, 926, 929, 986, 999, 1057, 1130, 1141, 1150, 1158,
1167, 1197, 1205, 1211, 1225, 1227, 1247, 1255, 1263, 1279\ETs1282.
\U4.\fi

\M{15}\B\X15:Exported types\X${}\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{mp\_nan\_type}\K\T{0},\39\\{mp\_scaled\_type},\39\\{mp\_fraction\_type},%
\39\\{mp\_angle\_type},\39\\{mp\_double\_type},\39\\{mp\_binary\_type},\39\\{mp%
\_decimal\_type}{}$\2\6
${}\}{}$ \&{mp\_number\_type};\6
\&{typedef} \&{union} ${}\{{}$\1\6
\&{void} ${}{*}\\{num};{}$\6
\&{double} \\{dval};\6
\&{int} \\{val};\2\6
${}\}{}$ \&{mp\_number\_store};\6
\&{typedef} \&{struct} \&{mp\_number\_data} ${}\{{}$\1\6
\&{mp\_number\_store} \\{data};\6
\&{mp\_number\_type} \\{type};\2\6
${}\}{}$ \&{mp\_number\_data};\6
\&{typedef} \&{struct} \&{mp\_number\_data} \&{mp\_number};\6
\8\#\&{define} \\{is\_number}(\|A) \5${}((\|A).\\{type}\I\\{mp\_nan\_type}){}$\6
\&{typedef} ${}\&{void}({*}\\{convert\_func}){}$(\&{mp\_number} ${}{*}\|r);{}$\6
\&{typedef} ${}\&{void}({*}\\{m\_log\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a);\6
\&{typedef} ${}\&{void}({*}\\{m\_exp\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a);\6
\&{typedef} ${}\&{void}({*}\\{pyth\_add\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} \|b);\6
\&{typedef} ${}\&{void}({*}\\{pyth\_sub\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} \|b);\6
\&{typedef} ${}\&{void}({*}\\{n\_arg\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} \|b);\6
\&{typedef} ${}\&{void}({*}\\{velocity\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} \|b${},%
\39{}$\&{mp\_number} \|c${},\39{}$\&{mp\_number} \|d${},\39{}$\&{mp\_number} %
\|e);\6
\&{typedef} ${}\&{void}({*}\\{ab\_vs\_cd\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} %
\|b${},\39{}$\&{mp\_number} \|c${},\39{}$\&{mp\_number} \|d);\6
\&{typedef} ${}\&{void}({*}\\{crossing\_point\_func}){}$(\&{MP} \\{mp}${},%
\39{}$\&{mp\_number} ${}{*}\|r,\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number}
\|b${},\39{}$\&{mp\_number} \|c);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_int\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_boolean\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_scaled\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_double\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{double} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_addition\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_substraction\_func}){}$(\&{mp%
\_number} ${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_div\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_mul\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_int\_div\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{int} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_int\_mul\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B${},\39{}$\&{int} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_from\_oftheway\_func}){}$(\&{MP} %
\\{mp}${},\39{}$\&{mp\_number} ${}{*}\|A,\39{}$\&{mp\_number} \|t${},\39{}$%
\&{mp\_number} \|B${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{number\_negate\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_add\_func}){}$(\&{mp\_number} ${}{*}\|A,%
\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_substract\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_modulo\_func}){}$(\&{mp\_number} ${}{*}%
\|A,\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_half\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_halfp\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_double\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_abs\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_clone\_func}){}$(\&{mp\_number} ${}{*}%
\|A,\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{void}({*}\\{number\_swap\_func}){}$(\&{mp\_number} ${}{*}\|A,%
\39{}$\&{mp\_number} ${}{*}\|B);{}$\6
\&{typedef} ${}\&{void}({*}\\{number\_add\_scaled\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|b);\6
\&{typedef} ${}\&{void}({*}\\{number\_multiply\_int\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|b);\6
\&{typedef} ${}\&{void}({*}\\{number\_divide\_int\_func}){}$(\&{mp\_number}
${}{*}\|A,\39{}$\&{int} \|b);\6
\&{typedef} ${}\&{int}({*}\\{number\_to\_int\_func}){}$(\&{mp\_number} \|A);\6
\&{typedef} ${}\&{int}({*}\\{number\_to\_boolean\_func}){}$(\&{mp\_number} %
\|A);\6
\&{typedef} ${}\&{int}({*}\\{number\_to\_scaled\_func}){}$(\&{mp\_number} \|A);%
\6
\&{typedef} ${}\&{int}({*}\\{number\_round\_func}){}$(\&{mp\_number} \|A);\6
\&{typedef} ${}\&{void}({*}\\{number\_floor\_func}){}$(\&{mp\_number} ${}{*}%
\|A);{}$\6
\&{typedef} ${}\&{double}({*}\\{number\_to\_double\_func}){}$(\&{mp\_number} %
\|A);\6
\&{typedef} ${}\&{int}({*}\\{number\_odd\_func}){}$(\&{mp\_number} \|A);\6
\&{typedef} ${}\&{int}({*}\\{number\_equal\_func}){}$(\&{mp\_number} \|A${},%
\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{int}({*}\\{number\_less\_func}){}$(\&{mp\_number} \|A${},%
\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{int}({*}\\{number\_greater\_func}){}$(\&{mp\_number} \|A${},%
\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{int}({*}\\{number\_nonequalabs\_func}){}$(\&{mp\_number} %
\|A${},\39{}$\&{mp\_number} \|B);\6
\&{typedef} ${}\&{void}({*}\\{make\_scaled\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|A${},\39{}$\&{mp\_number} %
\|B);\6
\&{typedef} ${}\&{void}({*}\\{make\_fraction\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|A${},\39{}$\&{mp\_number} %
\|B);\6
\&{typedef} ${}\&{void}({*}\\{take\_fraction\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|A${},\39{}$\&{mp\_number} %
\|B);\6
\&{typedef} ${}\&{void}({*}\\{take\_scaled\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|A${},\39{}$\&{mp\_number} %
\|B);\6
\&{typedef} ${}\&{void}({*}\\{sin\_cos\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|A${},\39{}$\&{mp\_number} ${}{*}\|S,\39{}$\&{mp\_number} ${}{*}%
\|C);{}$\6
\&{typedef} ${}\&{void}({*}\\{slow\_add\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|A,\39{}$\&{mp\_number} \|S${},\39{}$\&{mp\_number} \|C);\6
\&{typedef} ${}\&{void}({*}\\{sqrt\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|A);\6
\&{typedef} ${}\&{void}({*}\\{init\_randoms\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{int} \\{seed});\6
\&{typedef} ${}\&{void}({*}\\{new\_number\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\|A,\39{}$\&{mp\_number\_type} \|t);\6
\&{typedef} ${}\&{void}({*}\\{free\_number\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\|n);{}$\6
\&{typedef} ${}\&{void}({*}\\{fraction\_to\_round\_scaled\_func}){}$(\&{mp%
\_number} ${}{*}\|n);{}$\6
\&{typedef} ${}\&{void}({*}\\{print\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|A);\6
\&{typedef} \&{char} ${}{*}({*}\&{tostring\_func}){}$(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} \|A);\6
\&{typedef} ${}\&{void}({*}\\{scan\_func}){}$(\&{MP} \\{mp}${},\39{}$\&{int} %
\|A);\6
\&{typedef} ${}\&{void}({*}\\{mp\_free\_func}){}$(\&{MP} \\{mp});\6
\&{typedef} ${}\&{void}({*}\\{set\_precision\_func}){}$(\&{MP} \\{mp});\6
\&{typedef} \&{struct} \&{math\_data} ${}\{{}$\1\6
\&{mp\_number} \\{precision\_default};\6
\&{mp\_number} \\{precision\_max};\6
\&{mp\_number} \\{precision\_min};\6
\&{mp\_number} \\{epsilon\_t};\6
\&{mp\_number} \\{inf\_t};\6
\&{mp\_number} \\{one\_third\_inf\_t};\6
\&{mp\_number} \\{zero\_t};\6
\&{mp\_number} \\{unity\_t};\6
\&{mp\_number} \\{two\_t};\6
\&{mp\_number} \\{three\_t};\6
\&{mp\_number} \\{half\_unit\_t};\6
\&{mp\_number} \\{three\_quarter\_unit\_t};\6
\&{mp\_number} \\{fraction\_one\_t};\6
\&{mp\_number} \\{fraction\_half\_t};\6
\&{mp\_number} \\{fraction\_three\_t};\6
\&{mp\_number} \\{fraction\_four\_t};\6
\&{mp\_number} \\{one\_eighty\_deg\_t};\6
\&{mp\_number} \\{three\_sixty\_deg\_t};\6
\&{mp\_number} \\{one\_k};\6
\&{mp\_number} \\{sqrt\_8\_e\_k};\6
\&{mp\_number} \\{twelve\_ln\_2\_k};\6
\&{mp\_number} \\{coef\_bound\_k};\6
\&{mp\_number} \\{coef\_bound\_minus\_1};\6
\&{mp\_number} \\{twelvebits\_3};\6
\&{mp\_number} \\{arc\_tol\_k};\6
\&{mp\_number} \\{twentysixbits\_sqrt2\_t};\6
\&{mp\_number} \\{twentyeightbits\_d\_t};\6
\&{mp\_number} \\{twentysevenbits\_sqrt2\_d\_t};\6
\&{mp\_number} \\{fraction\_threshold\_t};\6
\&{mp\_number} \\{half\_fraction\_threshold\_t};\6
\&{mp\_number} \\{scaled\_threshold\_t};\6
\&{mp\_number} \\{half\_scaled\_threshold\_t};\6
\&{mp\_number} \\{near\_zero\_angle\_t};\6
\&{mp\_number} \\{p\_over\_v\_threshold\_t};\6
\&{mp\_number} \\{equation\_threshold\_t};\6
\&{mp\_number} \\{tfm\_warn\_threshold\_t};\6
\&{mp\_number} \\{warning\_limit\_t};\7
\\{new\_number\_func}\\{allocate};\6
\\{free\_number\_func}\\{free};\6
\\{number\_from\_int\_func}\\{from\_int};\6
\\{number\_from\_boolean\_func}\\{from\_boolean};\6
\\{number\_from\_scaled\_func}\\{from\_scaled};\6
\\{number\_from\_double\_func}\\{from\_double};\6
\\{number\_from\_addition\_func}\\{from\_addition};\6
\\{number\_from\_substraction\_func}\\{from\_substraction};\6
\\{number\_from\_div\_func}\\{from\_div};\6
\\{number\_from\_mul\_func}\\{from\_mul};\6
\\{number\_from\_int\_div\_func}\\{from\_int\_div};\6
\\{number\_from\_int\_mul\_func}\\{from\_int\_mul};\6
\\{number\_from\_oftheway\_func}\\{from\_oftheway};\6
\\{number\_negate\_func}\\{negate};\6
\\{number\_add\_func}\\{add};\6
\\{number\_substract\_func}\\{substract};\6
\\{number\_half\_func}\\{half};\6
\\{number\_modulo\_func}\\{modulo};\6
\\{number\_halfp\_func}\\{halfp};\6
\\{number\_double\_func}\\{do\_double};\6
\\{number\_abs\_func}\\{abs};\6
\\{number\_clone\_func}\\{clone};\6
\\{number\_swap\_func}\\{swap};\6
\\{number\_add\_scaled\_func}\\{add\_scaled};\6
\\{number\_multiply\_int\_func}\\{multiply\_int};\6
\\{number\_divide\_int\_func}\\{divide\_int};\6
\\{number\_to\_int\_func}\\{to\_int};\6
\\{number\_to\_boolean\_func}\\{to\_boolean};\6
\\{number\_to\_scaled\_func}\\{to\_scaled};\6
\\{number\_to\_double\_func}\\{to\_double};\6
\\{number\_odd\_func}\\{odd};\6
\\{number\_equal\_func}\\{equal};\6
\\{number\_less\_func}\\{less};\6
\\{number\_greater\_func}\\{greater};\6
\\{number\_nonequalabs\_func}\\{nonequalabs};\6
\\{number\_round\_func}\\{round\_unscaled};\6
\\{number\_floor\_func}\\{floor\_scaled};\6
\\{make\_scaled\_func}\\{make\_scaled};\6
\\{make\_fraction\_func}\\{make\_fraction};\6
\\{take\_fraction\_func}\\{take\_fraction};\6
\\{take\_scaled\_func}\\{take\_scaled};\6
\\{velocity\_func}\\{velocity};\6
\\{ab\_vs\_cd\_func}\\{ab\_vs\_cd};\6
\\{crossing\_point\_func}\\{crossing\_point};\6
\\{n\_arg\_func}\\{n\_arg};\6
\\{m\_log\_func}\\{m\_log};\6
\\{m\_exp\_func}\\{m\_exp};\6
\\{pyth\_add\_func}\\{pyth\_add};\6
\\{pyth\_sub\_func}\\{pyth\_sub};\6
\\{fraction\_to\_round\_scaled\_func}\\{fraction\_to\_round\_scaled};\6
\\{convert\_func}\\{fraction\_to\_scaled};\6
\\{convert\_func}\\{scaled\_to\_fraction};\6
\\{convert\_func}\\{scaled\_to\_angle};\6
\\{convert\_func}\\{angle\_to\_scaled};\6
\\{init\_randoms\_func}\\{init\_randoms};\6
\\{sin\_cos\_func}\\{sin\_cos};\6
\\{sqrt\_func}\\{sqrt};\6
\\{slow\_add\_func}\\{slow\_add};\6
\\{print\_func}\\{print};\7
\&{tostring\_func} \\{tostring};\7
\\{scan\_func}\\{scan\_numeric};\6
\\{scan\_func}\\{scan\_fractional};\6
\\{mp\_free\_func}\\{free\_math};\6
\\{set\_precision\_func}\\{set\_precision};\2\6
${}\}{}$ \&{math\_data};\par
\As42, 72, 98, 104, 118, 162, 297, 298, 301, 886, 1054\ETs1276.
\U3.\fi

\M{16}This procedure gets things started properly.
\Y\B\&{MP} \\{mp\_initialize}(\&{MP\_options} ${}{*}\\{opt}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{MP} \\{mp};\6
\&{jmp\_buf} ${}{*}\\{buf}\K\\{malloc}(\&{sizeof}(\&{jmp\_buf}));{}$\7
\&{if} ${}(\\{buf}\E\NULL\V\\{setjmp}({*}\\{buf})\I\T{0}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{mp}\K\\{mp\_do\_new}(\\{buf});{}$\6
\&{if} ${}(\\{mp}\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{mp}\MG\\{userdata}\K\\{opt}\MG\\{userdata};{}$\6
${}\\{mp}\MG\\{noninteractive}\K\\{opt}\MG\\{noninteractive};{}$\6
\\{set\_callback\_option}(\\{find\_file});\6
\\{set\_callback\_option}(\\{open\_file});\6
\\{set\_callback\_option}(\\{read\_ascii\_file});\6
\\{set\_callback\_option}(\\{read\_binary\_file});\6
\\{set\_callback\_option}(\\{close\_file});\6
\\{set\_callback\_option}(\\{eof\_file});\6
\\{set\_callback\_option}(\\{flush\_file});\6
\\{set\_callback\_option}(\\{write\_ascii\_file});\6
\\{set\_callback\_option}(\\{write\_binary\_file});\6
\\{set\_callback\_option}(\\{shipout\_backend});\6
\&{if} ${}(\\{opt}\MG\\{banner}\W{*}(\\{opt}\MG\\{banner})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{banner}\K\\{xstrdup}(\\{opt}\MG\\{banner});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{banner}\K\\{xstrdup}(\\{default\_banner});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{opt}\MG\\{command\_line}\W{*}(\\{opt}\MG\\{command\_line})){}$\1\5
${}\\{mp}\MG\\{command\_line}\K\\{xstrdup}(\\{opt}\MG\\{command\_line});{}$\2\6
\&{if} ${}(\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\X1061:Prepare function pointers for non-interactive use\X;\6
\4${}\}{}$\C{ open the terminal for output }\2\6
\\{t\_open\_out}(\,);\6
\8\#\&{if} \.{DEBUG}\6
${}\\{setvbuf}(\\{stdout},\39{}$(\&{char} ${}{*}){}$ ${}\NULL,\39\.{\_IONBF},%
\39\T{0});{}$\6
${}\\{setvbuf}(\\{mp}\MG\\{term\_out},\39{}$(\&{char} ${}{*}){}$ ${}\NULL,\39%
\.{\_IONBF},\39\T{0});{}$\6
\8\#\&{endif}\6
\&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_scaled\_mode}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{math}\K\\{mp\_initialize\_scaled\_math}(\\{mp});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_decimal\_mode}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{math}\K\\{mp\_initialize\_decimal\_math}(\\{mp});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_binary\_mode}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{math}\K\\{mp\_initialize\_binary\_math}(\\{mp});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{math}\K\\{mp\_initialize\_double\_math}(\\{mp});{}$\6
\4${}\}{}$\2\6
\X854:Find and load preload file, if required\X;\6
\X28:Allocate or initialize variables\X;\6
${}\\{mp\_reallocate\_paths}(\\{mp},\39\T{1000});{}$\6
${}\\{mp\_reallocate\_fonts}(\\{mp},\39\T{8});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop}{}$;\C{ in case we quit
during initialization }\6
\X30:Check the ``constant'' values for consistency\X;\6
\&{if} ${}(\\{mp}\MG\\{bad}>\T{0}){}$\5
${}\{{}$\1\6
\&{char} \\{ss}[\T{256}];\7
${}\\{mp\_snprintf}(\\{ss},\39\T{256},\39\.{"Ouch---my\ internal\ }\)%
\.{constants\ have\ been\ }\)\.{clobbered!\\n"}\.{"---case\ \%i"},\39{}$(%
\&{int}) \\{mp}${}\MG\\{bad});{}$\6
\\{mp\_fputs}((\&{char} ${}{*}){}$ \\{ss}${},\39\\{mp}\MG\\{err\_out});{}$\6
;\6
\&{return} \\{mp};\6
\4${}\}{}$\2\6
\\{mp\_do\_initialize}(\\{mp});\C{ erase preloaded mem }\6
\\{mp\_init\_tab}(\\{mp});\C{ initialize the tables }\6
\&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_scaled\_mode}){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_number\_system},\39\\{mp\_intern}(\\{mp},%
\39\.{"scaled"}));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_decimal\_mode}){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_number\_system},\39\\{mp\_intern}(\\{mp},%
\39\.{"decimal"}));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{opt}\MG\\{math\_mode}\E\\{mp\_math\_binary\_mode}){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_number\_system},\39\\{mp\_intern}(\\{mp},%
\39\.{"binary"}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_number\_system},\39\\{mp\_intern}(\\{mp},%
\39\.{"double"}));{}$\6
\4${}\}{}$\2\6
\\{mp\_init\_prim}(\\{mp});\C{ call \PB{\\{primitive}} for each primitive }\6
\\{mp\_fix\_date\_and\_time}(\\{mp});\6
\&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\X81:Initialize the output routines\X;\6
\X1298:Get the first line of input and prepare to start\X;\6
\X17:Initializations after first line is read\X;\6
\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_spotless};{}$\6
\4${}\}{}$\2\6
\\{set\_precision}(\,);\6
\&{return} \\{mp};\6
\4${}\}{}$\2\par
\fi

\M{17}\B\X17:Initializations after first line is read\X${}\E{}$\6
\\{mp\_open\_log\_file}(\\{mp});\6
\\{mp\_set\_job\_id}(\\{mp});\6
${}\\{mp\_init\_map\_file}(\\{mp},\39\\{mp}\MG\\{troff\_mode});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_spotless}{}$;\C{ ready to go! }\6
\&{if} ${}(\\{mp}\MG\\{troff\_mode}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_gtroffmode}),\39\\{unity%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_prologues}),\39\\{unity%
\_t});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{start\_sym}\I\NULL){}$\5
${}\{{}$\C{ insert the `\&{everyjob}' symbol }\1\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{start\_sym});{}$\6
\\{mp\_back\_input}(\\{mp});\6
\4${}\}{}$\2\par
\U16.\fi

\M{18}\B\X18:Exported function headers\X${}\E{}$\6
\&{extern} \&{MP\_options} ${}{*}\\{mp\_options}(\&{void});{}$\6
\&{extern} \&{MP} \\{mp\_initialize}(\&{MP\_options} ${}{*}\\{opt});{}$\6
\&{extern} \&{int} \\{mp\_status}(\&{MP} \\{mp});\6
\&{extern} \&{void} ${}{*}{}$\\{mp\_userdata}(\&{MP} \\{mp});\par
\As116, 133, 197, 377, 379, 1053, 1062, 1070, 1237\ETs1293.
\U3.\fi

\M{19}\B\&{int} \\{mp\_status}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\par
\fi

\M{20}\B\&{void} ${}{*}{}$\\{mp\_userdata}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{mp}${}\MG\\{userdata};{}$\6
\4${}\}{}$\2\par
\fi

\M{21}The overall \MP\ program begins with the heading just shown, after which
comes a bunch of procedure declarations and function declarations.
Finally we will get to the main program, which begins with the
comment `\PB{\\{start\_here}}'. If you want to skip down to the
main program now, you can look up `\PB{\\{start\_here}}' in the index.
But the author suggests that the best way to understand this program
is to follow pretty much the order of \MP's components as they appear in the
\.{WEB} description you are now reading, since the present ordering is
intended to combine the advantages of the ``bottom up'' and ``top down''
approaches to the problem of understanding a somewhat complicated system.

\fi

\M{22}Some of the code below is intended to be used only when diagnosing the
strange behavior that sometimes occurs when \MP\ is being installed or
when system wizards are fooling around with \MP\ without quite knowing
what they are doing. Such code will not normally be compiled; it is
delimited by the preprocessor test `\PB{$\#$ \&{ifdef} \.{DEBUG} $\MRL{{.}{.}}$
$\#$ \&{endif}}'.

\fi

\M{23}The following parameters can be changed at compile time to extend or
reduce \MP's capacity.

\Y\B\4\X23:Constants in the outer block\X${}\E{}$\6
\8\#\&{define} \\{bistack\_size} \5\T{1500}\C{ size of stack for bisection
algorithms;                                    should probably be left at this
value }\par
\U4.\fi

\M{24}Like the preceding parameters, the following quantities can be changed
to extend or reduce \MP's capacity.

\fi

\M{25}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{pool\_size};\C{ maximum number of characters in strings, including
all                    error messages and help texts, and the names of all
identifiers }\6
\&{int} \\{max\_in\_open};\C{ maximum number of input files and error
insertions that                            can be going on simultaneously }\6
\&{int} \\{param\_size};\C{ maximum number of simultaneous macro parameters }%
\par
\fi

\M{26}\B\X26:Option variables\X${}\E{}$\6
\&{int} \\{error\_line};\C{ width of context lines on terminal error messages }%
\6
\&{int} \\{half\_error\_line};\C{ width of first lines of contexts in terminal
                          error messages; should be between 30 and \PB{$%
\\{error\_line}-\T{15}$} }\6
\&{int} \\{halt\_on\_error};\C{ do we quit at the first error? }\6
\&{int} \\{max\_print\_line};\C{ width of longest text lines output; should be
at least 60 }\6
\&{void} ${}{*}\\{userdata}{}$;\C{ this allows the calling application to setup
local }\6
\&{char} ${}{*}\\{banner}{}$;\C{ the banner that is printed to the screen and
log }\6
\&{int} \\{ini\_version};\par
\As43, 48, 50, 66, 99, 119, 151, 163, 195, 853, 866, 887\ETs1277.
\Us3\ET4.\fi

\M{27}\B\X27:Dealloc variables\X${}\E{}$\6
$\\{xfree}(\\{mp}\MG\\{banner}){}$;\par
\As62, 75, 80, 153, 168, 222, 341, 346, 369, 386, 432, 449, 607, 612, 616, 676,
683, 688, 843, 855, 869, 876, 928, 1064, 1098, 1169, 1199, 1213, 1229, 1257,
1281\ETs1290.
\U12.\fi

\M{28}
\Y\B\4\D$\\{set\_lower\_limited\_value}(\|a,\|b,\|c)$ \5
\&{do} \6
${}\{{}$\1\6
${}\|a\K\|c;{}$\6
\&{if} ${}(\|b>\|c){}$\1\5
${}\|a\K\|b;{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\4\X28:Allocate or initialize variables\X${}\E{}$\6
$\\{mp}\MG\\{param\_size}\K\T{4};{}$\6
${}\\{mp}\MG\\{max\_in\_open}\K\T{0};{}$\6
${}\\{mp}\MG\\{pool\_size}\K\T{10000};{}$\6
${}\\{set\_lower\_limited\_value}(\\{mp}\MG\\{error\_line},\39\\{opt}\MG%
\\{error\_line},\39\T{79});{}$\6
${}\\{set\_lower\_limited\_value}(\\{mp}\MG\\{half\_error\_line},\39\\{opt}\MG%
\\{half\_error\_line},\39\T{50});{}$\6
\&{if} ${}(\\{mp}\MG\\{half\_error\_line}>\\{mp}\MG\\{error\_line}-\T{15}){}$\1%
\5
${}\\{mp}\MG\\{half\_error\_line}\K\\{mp}\MG\\{error\_line}-\T{15};{}$\2\6
${}\\{mp}\MG\\{max\_print\_line}\K\T{100};{}$\6
${}\\{set\_lower\_limited\_value}(\\{mp}\MG\\{max\_print\_line},\39\\{opt}\MG%
\\{max\_print\_line},\39\T{79});{}$\6
${}\\{mp}\MG\\{halt\_on\_error}\K(\\{opt}\MG\\{halt\_on\_error}\?\\{true}:%
\\{false});{}$\6
${}\\{mp}\MG\\{ini\_version}\K(\\{opt}\MG\\{ini\_version}\?\\{true}:%
\\{false}){}$;\par
\As49, 51, 61, 74, 79, 100, 110, 120, 139, 143, 152, 164, 167, 196, 221, 606,
675, 682, 686, 867, 888, 894, 1168, 1228\ETs1280.
\U16.\fi

\M{29}In case somebody has inadvertently made bad settings of the
``constants,''
\MP\ checks them using a global variable called \PB{\\{bad}}.

This is the second of many sections of \MP\ where global variables are
defined.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{bad};\C{ is some ``constant'' wrong? }\par
\fi

\M{30}Later on we will say `\PB{ \&{if} ${}(\\{int\_packets}+\T{17}*\\{int%
\_increment}>\\{bistack\_size}){}$ ${}\\{mp}\MG\\{bad}\K\T{19};{}$}',
or something similar.

In case you are wondering about the non-consequtive values of \PB{\\{bad}}:
most
of the things that used to be WEB constants are now runtime variables
with checking at assignment time.

\Y\B\4\X30:Check the ``constant'' values for consistency\X${}\E{}$\6
$\\{mp}\MG\\{bad}\K\T{0}{}$;\par
\A608.
\U16.\fi

\M{31}Here are some macros for common programming idioms.

\Y\B\4\D$\\{incr}(\|A)$ \5
$(\|A)\K(\|A)+{}$\T{1}\C{ increase a variable by unity }\par
\B\4\D$\\{decr}(\|A)$ \5
$(\|A)\K(\|A)-{}$\T{1}\C{ decrease a variable by unity }\par
\B\4\D$\\{negate}(\|A)$ \5
$(\|A)\K{-}{}$(\|A)\C{ change the sign of a variable }\par
\B\4\D$\&{double}(\|A)$ \5
$(\|A)\K(\|A)+{}$(\|A)\par
\B\4\D$\\{odd}(\|A)$ \5
$((\|A)\MOD\T{2}\E\T{1}{}$)\par
\fi

\N{1}{32}The character set.
In order to make \MP\ readily portable to a wide variety of
computers, all of its input text is converted to an internal eight-bit
code that includes standard ASCII, the ``American Standard Code for
Information Interchange.''  This conversion is done immediately when each
character is read in. Conversely, characters are converted from ASCII to
the user's external representation just before they are output to a
text file.

Such an internal code is relevant to users of \MP\ only with respect to
the \&{char} and \&{ASCII} operations, and the comparison of strings.

\fi

\M{33}Characters of text that have been converted to \MP's internal form
are said to be of type \PB{\\{ASCII\_code}}, which is a subrange of the
integers.

\Y\B\4\X33:Types in the outer block\X${}\E{}$\6
\&{typedef} \&{unsigned} \&{char} \&{ASCII\_code};\C{ eight-bit numbers }\par
\As34, 41, 161, 192, 215, 248, 290, 383, 478, 673, 747, 821, 892, 1058\ETs1226.
\U4.\fi

\M{34}The present specification of \MP\ has been written under the assumption
that the character set contains at least the letters and symbols associated
with ASCII codes 040 through 0176; all of these characters are now
available on most computer terminals.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{unsigned} \&{char} \&{text\_char};\C{ the data type of
characters in text files }\par
\fi

\M{35}\B\X35:Local variables for initialization\X${}\E{}$\6
\&{integer} \|i;\par
\A149.
\U13.\fi

\M{36}The \MP\ processor converts between ASCII code and
the user's external character set by means of arrays \PB{\\{xord}} and \PB{%
\\{xchr}}
that are analogous to Pascal's \PB{\\{ord}} and \PB{\\{chr}} functions.

\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} ${}\\{xchr}(\|A)\\{mp}\MG\\{xchr} \5[(\|A)]{}$\6
\8\#\&{define} ${}\\{xord}(\|A)\\{mp}\MG\\{xord} \5[(\|A)]{}$\par
\fi

\M{37}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{ASCII\_code} \\{xord}[\T{256}];\C{ specifies conversion of input characters
}\6
\&{text\_char} \\{xchr}[\T{256}];\C{ specifies conversion of output characters
}\par
\fi

\M{38}The core system assumes all 8-bit is acceptable.  If it is not,
a change file has to alter the below section.

Additionally, people with extended character sets can
assign codes arbitrarily, giving an \PB{\\{xchr}} equivalent to whatever
characters the users of \MP\ are allowed to have in their input files.
Appropriate changes to \MP's \PB{\\{char\_class}} table should then be made.
(Unlike \TeX, each installation of \MP\ has a fixed assignment of category
codes, called the \PB{\\{char\_class}}.) Such changes make portability of
programs
more difficult, so they should be introduced cautiously if at all.

\Y\B\4\X38:Set initial values of key variables\X${}\E{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i\Z\T{\~377};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{xchr}(\|i)\K{}$(\&{text\_char}) \|i;\6
\4${}\}{}$\2\par
\As39, 199, 211, 292, 431, 546, 635, 767, 808, 823, 842, 900, 930, 987, 1142,
1151, 1170, 1232, 1248\ETs1256.
\U13.\fi

\M{39}The following system-independent code makes the \PB{\\{xord}} array
contain a
suitable inverse to the information in \PB{\\{xchr}}. Note that if \PB{$%
\\{xchr}[\|i]\K\\{xchr}[\|j]$}
where \PB{$\|i<\|j<\T{\~177}$}, the value of \PB{\\{xord}[\\{xchr}[\|i]]} will
turn out to be
\PB{\|j} or more; hence, standard ASCII code numbers will be used instead of
codes below 040 in case there is a coincidence.

\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i\Z\T{255};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{xord}(\\{xchr}(\|i))\K\T{\~177};{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|i\K\T{\~200};{}$ ${}\|i\Z\T{\~377};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{xord}(\\{xchr}(\|i))\K{}$(\&{ASCII\_code}) \|i;\6
\4${}\}{}$\2\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i\Z\T{\~176};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{xord}(\\{xchr}(\|i))\K{}$(\&{ASCII\_code}) \|i;\6
\4${}\}{}$\2\par
\fi

\N{1}{40}Input and output.
The bane of portability is the fact that different operating systems treat
input and output quite differently, perhaps because computer scientists
have not given sufficient attention to this problem. People have felt somehow
that input and output are not part of ``real'' programming. Well, it is true
that some kinds of programming are more fun than others. With existing
input/output conventions being so diverse and so messy, the only sources of
joy in such parts of the code are the rare occasions when one can find a
way to make the program a little less bad than it might have been. We have
two choices, either to attack I/O now and get it over with, or to postpone
I/O until near the end. Neither prospect is very attractive, so let's
get it over with.

The basic operations we need to do are (1)~inputting and outputting of
text, to or from a file or the user's terminal; (2)~inputting and
outputting of eight-bit bytes, to or from a file; (3)~instructing the
operating system to initiate (``open'') or to terminate (``close'') input or
output from a specified file; (4)~testing whether the end of an input
file has been reached; (5)~display of bits on the user's screen.
The bit-display operation will be discussed in a later section; we shall
deal here only with more traditional kinds of I/O.

\fi

\M{41}Finding files happens in a slightly roundabout fashion: the \MP\
instance object contains a field that holds a function pointer that finds a
file, and returns its name, or NULL. For this, it receives three
parameters: the non-qualified name \PB{\\{fname}}, the intended \PB{\\{fopen}}
operation type \PB{\\{fmode}}, and the type of the file \PB{\\{ftype}}.

The file types that are passed on in \PB{\\{ftype}} can be  used to
differentiate file searches if a library like kpathsea is used,
the fopen mode is passed along for the same reason.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{unsigned} \&{char} \&{eight\_bits};\C{ unsigned one-byte
quantity }\par
\fi

\M{42}\B\X15:Exported types\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_filetype} ${}\{{}$\1\6
${}\\{mp\_filetype\_terminal}\K\T{0},{}$\C{ the terminal }\6
\\{mp\_filetype\_error}${},{}$\C{ the terminal }\6
\\{mp\_filetype\_program}${},{}$\C{ \MP\ language input }\6
\\{mp\_filetype\_log}${},{}$\C{ the log file }\6
\\{mp\_filetype\_postscript}${},{}$\C{ the postscript output }\6
\\{mp\_filetype\_bitmap}${},{}$\C{ the bitmap output file }\6
\\{mp\_filetype\_memfile}${},{}$\C{ memory dumps, obsolete }\6
\\{mp\_filetype\_metrics}${},{}$\C{ TeX font metric files }\6
\\{mp\_filetype\_fontmap}${},{}$\C{ PostScript font mapping files }\6
\\{mp\_filetype\_font}${},{}$\C{  PostScript type1 font programs }\6
\\{mp\_filetype\_encoding}${},{}$\C{  PostScript font encoding files }\6
\\{mp\_filetype\_text}\C{ first text file for readfrom and writeto primitives }%
\2\6
${}\};{}$\6
\&{typedef} \&{char} ${}{*}({*}\&{mp\_file\_finder})(\&{MP},\39{}$\&{const} %
\&{char} ${}{*},\39{}$\&{const} \&{char} ${}{*},\39\&{int});{}$\6
\&{typedef} \&{void} ${}{*}({*}\&{mp\_file\_opener})(\&{MP},\39{}$\&{const} %
\&{char} ${}{*},\39{}$\&{const} \&{char} ${}{*},\39\&{int});{}$\6
\&{typedef} \&{char} ${}{*}({*}\&{mp\_file\_reader})(\&{MP},\39{}$\&{void}
${}{*},\39{}$\&{size\_t} ${}{*});{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_binfile\_reader})(\&{MP},\39{}$\&{void}
${}{*},\39{}$\&{void} ${}{*}{*},\39{}$\&{size\_t} ${}{*});{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_file\_closer})(\&{MP},\39{}$\&{void}
${}{*});{}$\6
\&{typedef} ${}\&{int}({*}\\{mp\_file\_eoftest})(\&{MP},\39{}$\&{void}
${}{*});{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_file\_flush})(\&{MP},\39{}$\&{void}
${}{*});{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_file\_writer})(\&{MP},\39{}$\&{void} ${}{*},%
\39{}$\&{const} \&{char} ${}{*});{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_binfile\_writer})(\&{MP},\39{}$\&{void}
${}{*},\39{}$\&{void} ${}{*},\39\&{size\_t}){}$;\par
\fi

\M{43}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{mp\_file\_finder} \\{find\_file};\6
\&{mp\_file\_opener} \\{open\_file};\6
\&{mp\_file\_reader} \\{read\_ascii\_file};\7
\\{mp\_binfile\_reader}\\{read\_binary\_file};\6
\\{mp\_file\_closer}\\{close\_file};\6
\\{mp\_file\_eoftest}\\{eof\_file};\6
\\{mp\_file\_flush}\\{flush\_file};\6
\\{mp\_file\_writer}\\{write\_ascii\_file};\6
\\{mp\_binfile\_writer}\\{write\_binary\_file};\par
\fi

\M{44}The default function for finding files is \PB{\\{mp\_find\_file}}. It is
pretty stupid: it will only find files in the current directory.

\Y\B\&{static} \&{char} ${}{*}{}$\\{mp\_find\_file}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},%
\39{}$\&{int} \\{ftype})\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\\{fmode}[\T{0}]\I\.{'r'}\V(\R\\{access}(\\{fname},\39\.{R\_OK}))\V%
\\{ftype}){}$\5
${}\{{}$\1\6
\&{return} \\{mp\_strdup}(\\{fname});\6
\4${}\}{}$\2\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{45}Because \PB{\\{mp\_find\_file}} is used so early, it has to be in the
helpers
section.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{char} ${}{*}{}$\\{mp\_find\_file}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},%
\39{}$\&{int} \\{ftype});\6
\&{static} \&{void} ${}{*}{}$\\{mp\_open\_file}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},%
\39{}$\&{int} \\{ftype});\6
\&{static} \&{char} ${}{*}{}$\\{mp\_read\_ascii\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\|f,\39{}$\&{size\_t} ${}{*}\\{size});{}$\6
\&{static} \&{void} \\{mp\_read\_binary\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{void} ${}{*}{*}\|d,\39{}$\&{size\_t} ${}{*}\\{size});{}$\6
\&{static} \&{void} \\{mp\_close\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\|f);{}$\6
\&{static} \&{int} \\{mp\_eof\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\|f);{}$\6
\&{static} \&{void} \\{mp\_flush\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\|f);{}$\6
\&{static} \&{void} \\{mp\_write\_ascii\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{const} \&{char} ${}{*}\|s);{}$\6
\&{static} \&{void} \\{mp\_write\_binary\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{void} ${}{*}\|s,\39{}$\&{size\_t} \|t);\par
\fi

\M{46}The function to open files can now be very short.

\Y\B\&{void} ${}{*}{}$\\{mp\_open\_file}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},\39{}$\&{int}
\\{ftype})\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{realmode}[\T{3}];\7
(\&{void}) \\{mp};\6
${}\\{realmode}[\T{0}]\K{*}\\{fmode};{}$\6
${}\\{realmode}[\T{1}]\K\.{'b'};{}$\6
${}\\{realmode}[\T{2}]\K\T{0};{}$\6
\&{if} ${}(\\{ftype}\E\\{mp\_filetype\_terminal}){}$\5
${}\{{}$\1\6
\&{return} ${}(\\{fmode}[\T{0}]\E\.{'r'}\?\\{stdin}:\\{stdout});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{ftype}\E\\{mp\_filetype\_error}){}$\5
${}\{{}$\1\6
\&{return} \\{stderr};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{fname}\I\NULL\W(\\{fmode}[\T{0}]\I\.{'r'}\V(\R%
\\{access}(\\{fname},\39\.{R\_OK})))){}$\5
${}\{{}$\1\6
\&{return} (\&{void} ${}{*}){}$ \\{fopen}${}(\\{fname},\39\\{realmode});{}$\6
\4${}\}{}$\2\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{47}(Almost) all file names pass through \PB{\\{name\_of\_file}}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{name\_of\_file}{}$;\C{ the name of a system file }\par
\fi

\M{48}If this parameter is true, the terminal and log will report the found
file names for input files instead of the requested ones.
It is off by default because it creates an extra filename lookup.

\Y\B\4\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{print\_found\_names};\C{ configuration parameter }\par
\fi

\M{49}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{print\_found\_names}\K(\\{opt}\MG\\{print\_found\_names}>\T{0}\?%
\\{true}:\\{false}){}$;\par
\fi

\M{50}The \PB{\\{file\_line\_error\_style}} parameter makes \MP\ use a more
standard compiler error message format instead of the Knuthian
exclamation mark. It needs the actual version of the current input
file name, that will be saved by \PB{\\{open\_in}} in the \PB{\\{long\_name}}.

TODO: currently these long strings cause memory leaks, because they cannot
be safely freed as they may appear in the \PB{\\{input\_stack}} multiple times.
In fact, the current implementation is just a quick hack in response
to a bug report for metapost 1.205.

\Y\B\4\D$\\{long\_name}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{long\_name\_field}\C{ long name of the current
file }\par
\Y\B\4\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{file\_line\_error\_style};\C{ configuration parameter }\par
\fi

\M{51}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{file\_line\_error\_style}\K(\\{opt}\MG\\{file\_line\_error%
\_style}>\T{0}\?\\{true}:\\{false}){}$;\par
\fi

\M{52}\MP's file-opening procedures return \PB{\\{false}} if no file identified
by
\PB{\\{name\_of\_file}} could be opened.

The \PB{\\{do\_open\_file}} function takes care of the \PB{\\{print\_found%
\_names}} parameter.

\Y\B\&{static} \&{boolean} \\{mp\_do\_open\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}{*}\|f,\39{}$\&{int} \\{ftype}${},\39{}$\&{const} \&{char}
${}{*}\\{mode}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{print\_found\_names}\V\\{mp}\MG\\{file\_line\_error%
\_style}){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\|s\K(\\{mp}\MG\\{find\_file})(\\{mp},\39\\{mp}\MG\\{name\_of%
\_file},\39\\{mode},\39\\{ftype});{}$\7
\&{if} ${}(\|s\I\NULL){}$\5
${}\{{}$\1\6
${}{*}\|f\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\\{mp}\MG\\{name\_of\_file},\39%
\\{mode},\39\\{ftype});{}$\6
\&{if} ${}(\\{mp}\MG\\{print\_found\_names}){}$\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{name\_of\_file});{}$\6
${}\\{mp}\MG\\{name\_of\_file}\K\\{xstrdup}(\|s);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(({*}\\{mode}\E\.{'r'})\W(\\{ftype}\E\\{mp\_filetype\_program})){}$\5
${}\{{}$\1\6
${}\\{long\_name}\K\\{xstrdup}(\|s);{}$\6
\4${}\}{}$\2\6
\\{xfree}(\|s);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}{*}\|f\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}{*}\|f\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\\{mp}\MG\\{name\_of\_file},\39%
\\{mode},\39\\{ftype});{}$\6
\4${}\}{}$\2\6
\&{return} ${}({*}\|f\?\\{true}:\\{false});{}$\6
\4${}\}{}$\2\7
\&{static} \&{boolean} \\{mp\_open\_in}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}{*}\|f,\39{}$\&{int} \\{ftype})\1\1\2\2\6
${}\{{}$\C{ open a file for input }\1\6
\&{return} \\{mp\_do\_open\_file}${}(\\{mp},\39\|f,\39\\{ftype},\39\.{"r"});{}$%
\6
\4${}\}{}$\2\7
\&{static} \&{boolean} \\{mp\_open\_out}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}{*}\|f,\39{}$\&{int} \\{ftype})\1\1\2\2\6
${}\{{}$\C{ open a file for output }\1\6
\&{return} \\{mp\_do\_open\_file}${}(\\{mp},\39\|f,\39\\{ftype},\39\.{"w"});{}$%
\6
\4${}\}{}$\2\par
\fi

\M{53}\B\&{static} \&{char} ${}{*}{}$\\{mp\_read\_ascii\_file}(\&{MP} %
\\{mp}${},\39{}$\&{void} ${}{*}\\{ff},\39{}$\&{size\_t} ${}{*}\\{size}){}$\1\1%
\2\2\6
${}\{{}$\1\6
\&{int} \|c;\6
\&{size\_t} \\{len}${}\K\T{0},{}$ \\{lim}${}\K\T{128};{}$\6
\&{char} ${}{*}\|s\K\NULL;{}$\6
\&{FILE} ${}{*}\|f\K{}$(\&{FILE} ${}{*}){}$ \\{ff};\7
${}{*}\\{size}\K\T{0};{}$\6
(\&{void}) \\{mp};\C{ for -Wunused }\6
\&{if} ${}(\|f\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|c\K\\{fgetc}(\|f);{}$\6
\&{if} ${}(\|c\E\.{EOF}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|s\K\\{malloc}(\\{lim});{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
\&{while} ${}(\|c\I\.{EOF}\W\|c\I\.{'\\n'}\W\|c\I\.{'\\r'}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{len}+\T{1})\E\\{lim}){}$\5
${}\{{}$\1\6
${}\|s\K\\{realloc}(\|s,\39(\\{lim}+(\\{lim}\GG\T{2})));{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{lim}\MRL{+{\K}}(\\{lim}\GG\T{2});{}$\6
\4${}\}{}$\2\6
${}\|s[\\{len}\PP]\K{}$(\&{char}) \|c;\6
${}\|c\K\\{fgetc}(\|f);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\E\.{'\\r'}){}$\5
${}\{{}$\1\6
${}\|c\K\\{fgetc}(\|f);{}$\6
\&{if} ${}(\|c\I\.{EOF}\W\|c\I\.{'\\n'}){}$\1\5
${}\\{ungetc}(\|c,\39\|f);{}$\2\6
\4${}\}{}$\2\6
${}\|s[\\{len}]\K\T{0};{}$\6
${}{*}\\{size}\K\\{len};{}$\6
\&{return} \|s;\6
\4${}\}{}$\2\par
\fi

\M{54}\B\&{void} \\{mp\_write\_ascii\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{const} \&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\5
${}\{{}$\1\6
${}\\{fputs}(\|s,\39{}$(\&{FILE} ${}{*}){}$ \|f);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{55}\B\&{void} \\{mp\_read\_binary\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{void} ${}{*}{*}\\{data},\39{}$\&{size\_t} ${}{*}\\{size}){}$%
\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \\{len}${}\K\T{0};{}$\7
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\1\5
${}\\{len}\K\\{fread}({*}\\{data},\39\T{1},\39{*}\\{size},\39{}$(\&{FILE}
${}{*}){}$ \|f);\2\6
${}{*}\\{size}\K\\{len};{}$\6
\4${}\}{}$\2\par
\fi

\M{56}\B\&{void} \\{mp\_write\_binary\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f,\39{}$\&{void} ${}{*}\|s,\39{}$\&{size\_t} \\{size})\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\1\5
(\&{void}) \\{fwrite}${}(\|s,\39\\{size},\39\T{1},\39{}$(\&{FILE} ${}{*}){}$ %
\|f);\2\6
\4${}\}{}$\2\par
\fi

\M{57}\B\&{void} \\{mp\_close\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\|f){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\1\5
\\{fclose}((\&{FILE} ${}{*}){}$ \|f);\2\6
\4${}\}{}$\2\par
\fi

\M{58}\B\&{int} \\{mp\_eof\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}\|f){}$%
\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\1\5
\&{return} \\{feof}((\&{FILE} ${}{*}){}$ \|f);\2\6
\&{else}\1\5
\&{return} \T{1};\2\6
\4${}\}{}$\2\par
\fi

\M{59}\B\&{void} \\{mp\_flush\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\|f){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|f\I\NULL){}$\1\5
\\{fflush}((\&{FILE} ${}{*}){}$ \|f);\2\6
\4${}\}{}$\2\par
\fi

\M{60}Input from text files is read one line at a time, using a routine called
\PB{\\{input\_ln}}. This function is defined in terms of global variables
called
\PB{\\{buffer}}, \PB{\\{first}}, and \PB{\\{last}} that will be described in
detail later; for
now, it suffices for us to know that \PB{\\{buffer}} is an array of \PB{%
\&{ASCII\_code}}
values, and that \PB{\\{first}} and \PB{\\{last}} are indices into this array
representing the beginning and ending of a line of text.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{size\_t} \\{buf\_size};\C{ maximum number of characters simultaneously
present in                            current lines of open files }\6
\&{ASCII\_code} ${}{*}\\{buffer}{}$;\C{ lines of characters being read }\6
\&{size\_t} \\{first};\C{ the first unused position in \PB{\\{buffer}} }\6
\&{size\_t} \\{last};\C{ end of the line just input to \PB{\\{buffer}} }\6
\&{size\_t} \\{max\_buf\_stack};\C{ largest index used in \PB{\\{buffer}} }\par
\fi

\M{61}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{buf\_size}\K\T{200};{}$\6
${}\\{mp}\MG\\{buffer}\K\\{xmalloc}((\\{mp}\MG\\{buf\_size}+\T{1}),\39%
\&{sizeof}(\&{ASCII\_code})){}$;\par
\fi

\M{62}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{buffer}){}$;\par
\fi

\M{63}\B\&{static} \&{void} \\{mp\_reallocate\_buffer}(\&{MP} \\{mp}${},\39{}$%
\&{size\_t} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{ASCII\_code} ${}{*}\\{buffer};{}$\7
\&{if} ${}(\|l>\\{max\_halfword}){}$\5
${}\{{}$\1\6
${}\\{mp\_confusion}(\\{mp},\39\.{"buffer\ size"}){}$;\C{ can't happen (I hope)
}\6
\4${}\}{}$\2\6
${}\\{buffer}\K\\{xmalloc}((\|l+\T{1}),\39\&{sizeof}(\&{ASCII\_code}));{}$\6
(\&{void}) \\{memcpy}${}(\\{buffer},\39\\{mp}\MG\\{buffer},\39(\\{mp}\MG\\{buf%
\_size}+\T{1}));{}$\6
${}\\{xfree}(\\{mp}\MG\\{buffer});{}$\6
${}\\{mp}\MG\\{buffer}\K\\{buffer};{}$\6
${}\\{mp}\MG\\{buf\_size}\K\|l;{}$\6
\4${}\}{}$\2\par
\fi

\M{64}The \PB{\\{input\_ln}} function brings the next line of input from the
specified
field into available positions of the buffer array and returns the value
\PB{\\{true}}, unless the file has already been entirely read, in which case it
returns \PB{\\{false}} and sets \PB{\\{last}: $\K$ \\{first}}.  In general, the
\PB{\&{ASCII\_code}}
numbers that represent the next line of the file are input into
\PB{\\{buffer}[\\{first}]}, \PB{$\\{buffer}[\\{first}+\T{1}]$}, \dots, \PB{$%
\\{buffer}[\\{last}-\T{1}]$}; and the
global variable \PB{\\{last}} is set equal to \PB{\\{first}} plus the length of
the
line. Trailing blanks are removed from the line; thus, either \PB{$\\{last}\K%
\\{first}$}
(in which case the line was entirely blank) or \PB{$\\{buffer}[\\{last}-\T{1}]%
\MRL{{<}{>}}\.{"\ "}$}.

The variable \PB{\\{max\_buf\_stack}}, which is used to keep track of how large
the \PB{\\{buf\_size}} parameter must be to accommodate the present job, is
also kept up to date by \PB{\\{input\_ln}}.

\Y\B\&{static} \&{boolean} \\{mp\_input\_ln}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|f){}$\1\1\2\2\6
${}\{{}$\C{ inputs the next line or returns \PB{\\{false}} }\1\6
\&{char} ${}{*}\|s;{}$\6
\&{size\_t} \\{size}${}\K\T{0};{}$\7
${}\\{mp}\MG\\{last}\K\\{mp}\MG\\{first}{}$;\C{ cf.\ Matthew 19\thinspace:%
\thinspace30 }\6
${}\|s\K(\\{mp}\MG\\{read\_ascii\_file})(\\{mp},\39\|f,\39{\AND}\\{size});{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} \\{false};\2\6
\&{if} ${}(\\{size}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{last}\K\\{mp}\MG\\{first}+\\{size};{}$\6
\&{if} ${}(\\{mp}\MG\\{last}\G\\{mp}\MG\\{max\_buf\_stack}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{max\_buf\_stack}\K\\{mp}\MG\\{last}+\T{1};{}$\6
\&{while} ${}(\\{mp}\MG\\{max\_buf\_stack}>\\{mp}\MG\\{buf\_size}){}$\5
${}\{{}$\1\6
${}\\{mp\_reallocate\_buffer}(\\{mp},\39(\\{mp}\MG\\{buf\_size}+(\\{mp}\MG%
\\{buf\_size}\GG\T{2})));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
(\&{void}) \\{memcpy}${}((\\{mp}\MG\\{buffer}+\\{mp}\MG\\{first}),\39\|s,\39%
\\{size});{}$\6
\4${}\}{}$\2\6
\\{free}(\|s);\6
\&{return} \\{true};\6
\4${}\}{}$\2\par
\fi

\M{65}The user's terminal acts essentially like other files of text, except
that it is used both for input and for output. When the terminal is
considered an input file, the file variable is called \PB{\\{term\_in}}, and
when it
is considered an output file the file variable is \PB{\\{term\_out}}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{term\_in}{}$;\C{ the terminal as an input file }\6
\&{void} ${}{*}\\{term\_out}{}$;\C{ the terminal as an output file }\6
\&{void} ${}{*}\\{err\_out}{}$;\C{ the terminal as an output file }\par
\fi

\M{66}Here is how to open the terminal files. In the default configuration,
nothing happens except that the command line (if there is one) is copied
to the input buffer.  The variable \PB{\\{command\_line}} will be filled by the
\PB{\\{main}} procedure.

\Y\B\4\D$\\{t\_open\_out}()$ \5
\&{do} \6
${}\{{}$\C{ open the terminal for text output }\1\6
${}\\{mp}\MG\\{term\_out}\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\.{"terminal"},%
\39\.{"w"},\39\\{mp\_filetype\_terminal});{}$\6
${}\\{mp}\MG\\{err\_out}\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\.{"error"},\39%
\.{"w"},\39\\{mp\_filetype\_error});{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{t\_open\_in}()$ \5
\&{do} \6
${}\{{}$\C{ open the terminal for text input }\1\6
${}\\{mp}\MG\\{term\_in}\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\.{"terminal"},%
\39\.{"r"},\39\\{mp\_filetype\_terminal});{}$\6
\&{if} ${}(\\{mp}\MG\\{command\_line}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{last}\K\\{strlen}(\\{mp}\MG\\{command\_line});{}$\6
(\&{void}) \\{memcpy}((\&{void} ${}{*}){}$ \\{mp}${}\MG\\{buffer},\39{}$(%
\&{void} ${}{*}){}$ \\{mp}${}\MG\\{command\_line},\39\\{mp}\MG\\{last});{}$\6
${}\\{xfree}(\\{mp}\MG\\{command\_line});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{last}\K\T{0};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\4\X26:Option variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{command\_line}{}$;\par
\fi

\M{67}Sometimes it is necessary to synchronize the input/output mixture that
happens on the user's terminal, and three system-dependent
procedures are used for this
purpose. The first of these, \PB{\\{update\_terminal}}, is called when we want
to make sure that everything we have output to the terminal so far has
actually left the computer's internal buffers and been sent.
The second, \PB{\\{clear\_terminal}}, is called when we wish to cancel any
input that the user may have typed ahead (since we are about to
issue an unexpected error message). The third, \PB{\\{wake\_up\_terminal}},
is supposed to revive the terminal if the user has disabled it by
some instruction to the operating system.  The following macros show how
these operations can be specified:

\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} ${}\\{update\_terminal}(\,)(\\{mp}\MG\\{flush\_file}) \5(\\{mp},%
\39\\{mp}\MG\\{term\_out}{}$)\C{ empty the terminal output buffer }\6
\8\#\&{define} \\{clear\_terminal} \5(\,)\C{ clear the terminal input buffer }\6
\8\#\&{define} ${}\\{wake\_up\_terminal}(\,)(\\{mp}\MG\\{flush\_file}) \5(%
\\{mp},\39\\{mp}\MG\\{term\_out}){}$\C{ cancel the user's cancellation of
output }\par
\fi

\M{68}We need a special routine to read the first line of \MP\ input from
the user's terminal. This line is different because it is read before we
have opened the transcript file; there is sort of a ``chicken and
egg'' problem here. If the user types `\.{input cmr10}' on the first
line, or if some macro invoked by that line does such an \.{input},
the transcript file will be named `\.{cmr10.log}'; but if no \.{input}
commands are performed during the first line of terminal input, the transcript
file will acquire its default name `\.{mpout.log}'. (The transcript file
will not contain error messages generated by the first line before the
first \.{input} command.)

The first line is even more special. It's nice to let the user start
running a \MP\ job by typing a command line like `\.{MP cmr10}'; in
such a case, \MP\ will operate as if the first line of input were
`\.{cmr10}', i.e., the first line will consist of the remainder of the
command line, after the part that invoked \MP.

\fi

\M{69}Different systems have different ways to get started. But regardless of
what conventions are adopted, the routine that initializes the terminal
should satisfy the following specifications:

\yskip\textindent{1)}It should open file \PB{\\{term\_in}} for input from the
terminal. (The file \PB{\\{term\_out}} will already be open for output to the
terminal.)

\textindent{2)}If the user has given a command line, this line should be
considered the first line of terminal input. Otherwise the
user should be prompted with `\.{**}', and the first line of input
should be whatever is typed in response.

\textindent{3)}The first line of input, which might or might not be a
command line, should appear in locations \PB{\\{first}} to \PB{$\\{last}-%
\T{1}$} of the
\PB{\\{buffer}} array.

\textindent{4)}The global variable \PB{\\{loc}} should be set so that the
character to be read next by \MP\ is in \PB{\\{buffer}[\\{loc}]}. This
character should not be blank, and we should have \PB{$\\{loc}<\\{last}$}.

\yskip\noindent(It may be necessary to prompt the user several times
before a non-blank line comes in. The prompt is `\.{**}' instead of the
later `\.*' because the meaning is slightly different: `\.{input}' need
not be typed immediately after~`\.{**}'.)

\Y\B\4\D$\\{loc}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{loc\_field}\C{ location of first unread
character in \PB{\\{buffer}} }\par
\Y\B\&{boolean} \\{mp\_init\_terminal}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ gets the terminal input started }\1\6
\\{t\_open\_in}(\,);\6
\&{if} ${}(\\{mp}\MG\\{last}\I\T{0}){}$\5
${}\{{}$\1\6
${}\\{loc}\K\T{0};{}$\6
${}\\{mp}\MG\\{first}\K\T{0};{}$\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\\{wake\_up\_terminal}(\,);\6
${}\\{mp\_fputs}(\.{"**"},\39\\{mp}\MG\\{term\_out});{}$\6
;\6
\\{update\_terminal}(\,);\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{mp\_input\_ln}(\\{mp},\39\\{mp}\MG\\{term\_in})){}$\5
${}\{{}$\C{ this shouldn't happen }\1\6
${}\\{mp\_fputs}(\.{"\\n!\ End\ of\ file\ on\ }\)\.{the\ terminal...\ why?}\)%
\.{"},\39\\{mp}\MG\\{term\_out});{}$\6
;\6
\&{return} \\{false};\6
\4${}\}{}$\2\6
${}\\{loc}\K(\\{halfword})\\{mp}\MG\\{first};{}$\6
\&{while} ${}((\\{loc}<{}$(\&{int}) \\{mp}${}\MG\\{last})\W(\\{mp}\MG%
\\{buffer}[\\{loc}]\E\.{'\ '})){}$\1\5
\\{incr}(\\{loc});\2\6
\&{if} ${}(\\{loc}<{}$(\&{int}) \\{mp}${}\MG\\{last}){}$\5
${}\{{}$\1\6
\&{return} \\{true};\C{ return unless the line was all blank }\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
${}\\{mp\_fputs}(\.{"Please\ type\ the\ nam}\)\.{e\ of\ your\ input\ file}\)%
\.{.\\n"},\39\\{mp}\MG\\{term\_out});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{70}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{boolean} \\{mp\_init\_terminal}(\&{MP} \\{mp});\par
\fi

\N{1}{71}Globals for strings.

\fi

\M{72}Symbolic token names and diagnostic messages are variable-length strings
of eight-bit characters. Many strings \MP\ uses are simply literals
in the compiled source, like the error messages and the names of the
internal parameters. Other strings are used or defined from the \MP\ input
language, and these have to be interned.

\MP\ uses strings more extensively than \MF\ does, but the necessary
operations can still be handled with a fairly simple data structure.
The avl tree \PB{\\{strings}} contains all of the known string structures.

Each structure contains an \PB{\&{unsigned} \&{char}} pointer containing the
eight-bit
data, a \PB{\&{size\_t}} that holds the length of that data, and an \PB{%
\&{int}} that
indicates how often this string is referenced (this will be explained below).
Such strings are referred to by structure pointers called \PB{\\{mp\_string}}.

Besides the avl tree, there is a set of three variables called \PB{\\{cur%
\_string}},
\PB{\\{cur\_length}} and \PB{\\{cur\_string\_size}} that are used for strings
while they are
being built.

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{unsigned} \&{char} ${}{*}\\{str}{}$;\C{ the string value }\6
\&{size\_t} \\{len};\C{ its length }\6
\&{int} \\{refs};\C{ number of references }\2\6
${}\}{}$ \&{mp\_lstring};\6
\&{typedef} \&{mp\_lstring} ${}{*}\&{mp\_string}{}$;\C{ for pointers to string
values }\par
\fi

\M{73}The string handling functions are in \.{mpstrings.w}, but strings
need a bunch of globals and those are defined here in the main file.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\\{avl\_tree}\\{strings};\C{ string avl tree }\7
\&{unsigned} \&{char} ${}{*}\\{cur\_string}{}$;\C{  current string buffer }\6
\&{size\_t} \\{cur\_length};\C{ current index in that buffer }\6
\&{size\_t} \\{cur\_string\_size};\C{  malloced size of \PB{\\{cur\_string}} }%
\par
\fi

\M{74}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
\\{mp\_initialize\_strings}(\\{mp});\par
\fi

\M{75}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\\{mp\_dealloc\_strings}(\\{mp});\par
\fi

\M{76}The next four variables are for keeping track of string memory usage.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{pool\_in\_use};\C{ total number of string bytes actually in use
}\6
\&{integer} \\{max\_pl\_used};\C{ maximum \PB{\\{pool\_in\_use}} so far }\6
\&{integer} \\{strs\_in\_use};\C{ total number of strings actually in use }\6
\&{integer} \\{max\_strs\_used};\C{ maximum \PB{\\{strs\_in\_use}} so far }\par
\fi

\N{1}{77}On-line and off-line printing.
Messages that are sent to a user's terminal and to the transcript-log file
are produced by several `\PB{\\{print}}' procedures. These procedures will
direct their output to a variety of places, based on the setting of
the global variable \PB{\\{selector}}, which has the following possible
values:

\yskip
\hang \PB{\\{term\_and\_log}}, the normal setting, prints on the terminal and
on the
transcript file.

\hang \PB{\\{log\_only}}, prints only on the transcript file.

\hang \PB{\\{term\_only}}, prints only on the terminal.

\hang \PB{\\{no\_print}}, doesn't print at all. This is used only in rare cases
before the transcript file is open.

\hang \PB{\\{pseudo}}, puts output into a cyclic buffer that is used
by the \PB{\\{show\_context}} routine; when we get to that routine we shall
discuss
the reasoning behind this curious mode.

\hang \PB{\\{new\_string}}, appends the output to the current string in the
string pool.

\hang \PB{$\G$ \\{write\_file}} prints on one of the files used for the %
\&{write}
command.

\yskip
\noindent The symbolic names `\PB{\\{term\_and\_log}}', etc., have been
assigned
numeric codes that satisfy the convenient relations \PB{$\\{no\_print}+\T{1}\K%
\\{term\_only}$},
\PB{$\\{no\_print}+\T{2}\K\\{log\_only}$}, \PB{$\\{term\_only}+\T{2}\K\\{log%
\_only}+\T{1}\K\\{term\_and\_log}$}.  These
relations are not used when \PB{\\{selector}} could be \PB{\\{pseudo}}, or \PB{%
\\{new\_string}}.
We need not check for unprintable characters when \PB{$\\{selector}<%
\\{pseudo}$}.

Three additional global variables, \PB{\\{tally}}, \PB{\\{term\_offset}} and %
\PB{\\{file\_offset}}
record the number of characters that have been printed
since they were most recently cleared to zero. We use \PB{\\{tally}} to record
the length of (possibly very long) stretches of printing; \PB{\\{term%
\_offset}},
and \PB{\\{file\_offset}}, on the other hand, keep track of how many
characters have appeared so far on the current line that has been output
to the terminal, the transcript file, or the \ps\ output file, respectively.

\Y\B\4\D$\\{new\_string}$ \5
\T{0}\C{ printing is deflected to the string pool }\par
\B\4\D$\\{pseudo}$ \5
\T{2}\C{ special \PB{\\{selector}} setting for \PB{\\{show\_context}} }\par
\B\4\D$\\{no\_print}$ \5
\T{3}\C{ \PB{\\{selector}} setting that makes data disappear }\par
\B\4\D$\\{term\_only}$ \5
\T{4}\C{ printing is destined for the terminal only }\par
\B\4\D$\\{log\_only}$ \5
\T{5}\C{ printing is destined for the transcript file only }\par
\B\4\D$\\{term\_and\_log}$ \5
\T{6}\C{ normal \PB{\\{selector}} setting }\par
\B\4\D$\\{write\_file}$ \5
\T{7}\C{ first write file selector }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{log\_file}{}$;\C{ transcript of \MP\ session }\6
\&{void} ${}{*}\\{output\_file}{}$;\C{ the generic font output goes here }\6
\&{unsigned} \&{int} \\{selector};\C{ where to print a message }\6
\&{integer} \\{tally};\C{ the number of characters recently printed }\6
\&{unsigned} \&{int} \\{term\_offset};\C{ the number of characters on the
current terminal line }\6
\&{unsigned} \&{int} \\{file\_offset};\C{ the number of characters on the
current file line }\6
\&{ASCII\_code} ${}{*}\\{trick\_buf}{}$;\C{ circular buffer for pseudoprinting
}\6
\&{integer} \\{trick\_count};\C{ threshold for pseudoprinting, explained later
}\6
\&{integer} \\{first\_count};\C{ another variable for pseudoprinting }\par
\fi

\M{78}The first 128 strings will contain 95 standard ASCII characters, and the
other 33 characters will be printed in three-symbol form like `\.{\^\^A}'
unless a system-dependent change is made here. Installations that have
an extended character set, where for example \PB{\\{xchr}[\T{\~32}] $\K\hbox{%
\.{'^^Z'}}$},
would like string 032 to be printed as the single character 032 instead
of the three characters 0136, 0136, 0132 (\.{\^\^Z}). On the other hand,
even people with an extended character set will want to represent string
015 by \.{\^\^M}, since 015 is ASCII's ``carriage return'' code; the idea is
to produce visible strings instead of tabs or line-feeds or carriage-returns
or bell-rings or characters that are treated anomalously in text files.

The boolean expression defined here should be \PB{\\{true}} unless \MP\
internal
code number~\PB{\|k} corresponds to a non-troublesome visible symbol in the
local character set.
If character \PB{\|k} cannot be printed, and \PB{$\|k<\T{\~200}$}, then
character \PB{$\|k+\T{\~100}$} or
\PB{$\|k-\T{\~100}$} must be printable; moreover, ASCII codes \PB{$[\T{\~60}.%
\T{.071},\T{\~141}.\T{.0146}]$}
must be printable.

\Y\B\4\X78:Character \PB{\|k} cannot be printed\X${}\E{}$\6
$(\|k<\.{'\ '})\V(\|k\E\T{127}{}$)\par
\U87.\fi

\M{79}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{trick\_buf}\K\\{xmalloc}((\\{mp}\MG\\{error\_line}+\T{1}),\39%
\&{sizeof}(\&{ASCII\_code})){}$;\par
\fi

\M{80}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{trick\_buf}){}$;\par
\fi

\M{81}\B\X81:Initialize the output routines\X${}\E{}$\6
$\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
${}\\{mp}\MG\\{tally}\K\T{0};{}$\6
${}\\{mp}\MG\\{term\_offset}\K\T{0};{}$\6
${}\\{mp}\MG\\{file\_offset}\K\T{0}{}$;\par
\A90.
\Us16\ET1066.\fi

\M{82}Macro abbreviations for output to the terminal and to the log file are
defined here for convenience. Some systems need special conventions
for terminal output, and it is possible to adhere to those conventions
by changing \PB{\\{wterm}}, \PB{\\{wterm\_ln}}, and \PB{\\{wterm\_cr}} here.

\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} ${}\\{mp\_fputs}(\|b,\39\|f)(\\{mp}\MG\\{write\_ascii\_file}) %
\5(\\{mp},\39\|f,\39\|b){}$\6
\8\#\&{define} \\{wterm}(\|A)\\{mp\_fputs} \5${}((\|A),\39\\{mp}\MG\\{term%
\_out}){}$\6
\8\#\&{define} \\{wterm\_chr}(\|A)\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \&{char} \\{ss}[\T{2}];\7
${}\\{ss}[\T{0}]\K(\|A);{}$\6
${}\\{ss}[\T{1}]\K\.{'\\0'};{}$\6
\\{wterm}((\&{char} ${}{*}){}$ \\{ss});\6
\4${}\}{}$\2\6
\8\#\&{define} \\{wterm\_cr}\\{mp\_fputs} \5${}(\.{"\\n"},\39\\{mp}\MG\\{term%
\_out}){}$\6
\8\#\&{define} \\{wterm\_ln}(\|A)\1\1\2\2\6
${}\{{}$\1\6
\\{wterm\_cr};\6
${}\\{mp\_fputs}((\|A),\39\\{mp}\MG\\{term\_out});{}$\6
\4${}\}{}$\2\6
\8\#\&{define} \\{wlog}(\|A)\\{mp\_fputs} \5${}((\|A),\39\\{mp}\MG\\{log%
\_file}){}$\6
\8\#\&{define} \\{wlog\_chr}(\|A)\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \&{char} \\{ss}[\T{2}];\7
${}\\{ss}[\T{0}]\K(\|A);{}$\6
${}\\{ss}[\T{1}]\K\.{'\\0'};{}$\6
\\{wlog}((\&{char} ${}{*}){}$ \\{ss});\6
\4${}\}{}$\2\6
\8\#\&{define} \\{wlog\_cr}\\{mp\_fputs} \5${}(\.{"\\n"},\39\\{mp}\MG\\{log%
\_file}){}$\6
\8\#\&{define} \\{wlog\_ln}(\|A)\1\1\2\2\6
${}\{{}$\1\6
\\{wlog\_cr};\6
${}\\{mp\_fputs}((\|A),\39\\{mp}\MG\\{log\_file});{}$\6
\4${}\}{}$\2\par
\fi

\M{83}To end a line of text output, we call \PB{\\{print\_ln}}.  Cases \PB{%
\T{0..}\\{max\_write\_files}}
use an array \PB{\\{wr\_file}} that will be declared later.

\Y\B\4\D$\\{mp\_print\_text}(\|A)$ \5
$\\{mp\_print\_str}(\\{mp},\39\\{text}((\|A)){}$)\par
\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}\|s);{}$%
\6
\&{void} \\{mp\_printf}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}\\{ss},%
\39\,\ldots\,);{}$\6
\&{void} \\{mp\_print\_ln}(\&{MP} \\{mp});\6
\&{void} \\{mp\_print\_char}(\&{MP} \\{mp}${},\39{}$\&{ASCII\_code} \|k);\6
\&{void} \\{mp\_print\_str}(\&{MP} \\{mp}${},\39{}$\&{mp\_string} \|s);\6
\&{void} \\{mp\_print\_nl}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\|s);{}$\6
\&{void} \\{mp\_print\_two}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} \|x${},\39{}$%
\&{mp\_number} \|y);\par
\fi

\M{84}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_visible\_char}(\&{MP} \\{mp}${},\39{}$%
\&{ASCII\_code} \|s);\par
\fi

\M{85}\B\X85:Basic printing procedures\X${}\E{}$\6
\&{void} \\{mp\_print\_ln}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ prints an end-of-line }\1\6
\&{switch} ${}(\\{mp}\MG\\{selector}){}$\5
${}\{{}$\1\6
\4\&{case} \\{term\_and\_log}:\5
\\{wterm\_cr};\6
\\{wlog\_cr};\6
${}\\{mp}\MG\\{term\_offset}\K\T{0};{}$\6
${}\\{mp}\MG\\{file\_offset}\K\T{0};{}$\6
\&{break};\6
\4\&{case} \\{log\_only}:\5
\\{wlog\_cr};\6
${}\\{mp}\MG\\{file\_offset}\K\T{0};{}$\6
\&{break};\6
\4\&{case} \\{term\_only}:\5
\\{wterm\_cr};\6
${}\\{mp}\MG\\{term\_offset}\K\T{0};{}$\6
\&{break};\6
\4\&{case} \\{no\_print}:\5
\&{case} \\{pseudo}:\5
\&{case} \\{new\_string}:\5
\&{break};\6
\4\&{default}:\5
${}\\{mp\_fputs}(\.{"\\n"},\39\\{mp}\MG\\{wr\_file}[(\\{mp}\MG\\{selector}-%
\\{write\_file})]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ note that \PB{\\{tally}} is not affected }\2\par
\As86, 87, 88, 89, 91, 92, 147, 188, 207, 209\ETs849.
\U5.\fi

\M{86}The \PB{\\{print\_visible\_char}} procedure sends one character to the
desired
destination, using the \PB{\\{xchr}} array to map it into an external character
compatible with \PB{\\{input\_ln}}.  (It assumes that it is always called with
a visible ASCII character.)  All printing comes through \PB{\\{print\_ln}} or
\PB{\\{print\_char}}, which ultimately calls \PB{\\{print\_visible\_char}},
hence these
routines are the ones that limit lines to at most \PB{\\{max\_print\_line}}
characters.
But we must make an exception for the \ps\ output file since it is not safe
to cut up lines arbitrarily in \ps.

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_visible\_char}(\&{MP} \\{mp}${},\39{}$%
\&{ASCII\_code} \|s)\1\1\2\2\6
${}\{{}$\C{ prints a single character }\1\6
\&{switch} ${}(\\{mp}\MG\\{selector}){}$\5
${}\{{}$\1\6
\4\&{case} \\{term\_and\_log}:\5
\\{wterm\_chr}(\\{xchr}(\|s));\6
\\{wlog\_chr}(\\{xchr}(\|s));\6
${}\\{incr}(\\{mp}\MG\\{term\_offset});{}$\6
${}\\{incr}(\\{mp}\MG\\{file\_offset});{}$\6
\&{if} ${}(\\{mp}\MG\\{term\_offset}\E{}$(\&{unsigned}) \\{mp}${}\MG\\{max%
\_print\_line}){}$\5
${}\{{}$\1\6
\\{wterm\_cr};\6
${}\\{mp}\MG\\{term\_offset}\K\T{0};{}$\6
\4${}\}{}$\2\6
;\6
\&{if} ${}(\\{mp}\MG\\{file\_offset}\E{}$(\&{unsigned}) \\{mp}${}\MG\\{max%
\_print\_line}){}$\5
${}\{{}$\1\6
\\{wlog\_cr};\6
${}\\{mp}\MG\\{file\_offset}\K\T{0};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{log\_only}:\5
\\{wlog\_chr}(\\{xchr}(\|s));\6
${}\\{incr}(\\{mp}\MG\\{file\_offset});{}$\6
\&{if} ${}(\\{mp}\MG\\{file\_offset}\E{}$(\&{unsigned}) \\{mp}${}\MG\\{max%
\_print\_line}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{term\_only}:\5
\\{wterm\_chr}(\\{xchr}(\|s));\6
${}\\{incr}(\\{mp}\MG\\{term\_offset});{}$\6
\&{if} ${}(\\{mp}\MG\\{term\_offset}\E{}$(\&{unsigned}) \\{mp}${}\MG\\{max%
\_print\_line}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{no\_print}:\5
\&{break};\6
\4\&{case} \\{pseudo}:\6
\&{if} ${}(\\{mp}\MG\\{tally}<\\{mp}\MG\\{trick\_count}){}$\1\5
${}\\{mp}\MG\\{trick\_buf}[\\{mp}\MG\\{tally}\MOD\\{mp}\MG\\{error\_line}]\K%
\|s;{}$\2\6
\&{break};\6
\4\&{case} \\{new\_string}:\5
\\{append\_char}(\|s);\6
\&{break};\6
\4\&{default}:\6
${}\{{}$\1\6
\&{text\_char} \\{ss}[\T{2}]${}\K\{\T{0},\39\T{0}\};{}$\7
${}\\{ss}[\T{0}]\K\\{xchr}(\|s);{}$\6
\\{mp\_fputs}((\&{char} ${}{*}){}$ \\{ss}${},\39\\{mp}\MG\\{wr\_file}[(\\{mp}%
\MG\\{selector}-\\{write\_file})]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{incr}(\\{mp}\MG\\{tally});{}$\6
\4${}\}{}$\2\par
\fi

\M{87}The \PB{\\{print\_char}} procedure sends one character to the desired
destination.
File names and string expressions might contain \PB{\&{ASCII\_code}} values
that
can't be printed using \PB{\\{print\_visible\_char}}.  These characters will be
printed in three- or four-symbol form like `\.{\^\^A}' or `\.{\^\^e4}'.
(This procedure assumes that it is safe to bypass all checks for unprintable
characters when \PB{\\{selector}} is in the range \PB{$\T{0..}\\{max\_write%
\_files}-\T{1}$}.
The user might want to write unprintable characters.

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_char}(\&{MP} \\{mp}${},\39{}$\&{ASCII\_code} \|k)\1\1\2%
\2\6
${}\{{}$\C{ prints a single character }\1\6
\&{if} ${}(\\{mp}\MG\\{selector}<\\{pseudo}\V\\{mp}\MG\\{selector}\G\\{write%
\_file}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39\|k);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\X78:Character \PB{\|k} cannot be printed\X)\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\^\^"});{}$\6
\&{if} ${}(\|k<\T{\~100}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39(\&{ASCII\_code})(\|k+\T{\~100}));{}$%
\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|k<\T{\~200}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39(\&{ASCII\_code})(\|k-\T{\~100}));{}$%
\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{int} \|l;\C{ small index or counter }\7
${}\|l\K(\|k/\T{16});{}$\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39\\{xord}(\|l<\T{10}\?\|l+\.{'0'}:\|l-%
\T{10}+\.{'a'}));{}$\6
${}\|l\K(\|k\MOD\T{16});{}$\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39\\{xord}(\|l<\T{10}\?\|l+\.{'0'}:\|l-%
\T{10}+\.{'a'}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_visible\_char}(\\{mp},\39\|k);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{88}An entire string is output by calling \PB{\\{print}}. Note that if we are
outputting
the single standard ASCII character \.c, we could call \PB{\\{print}(\.{"c"})},
since
\PB{$\.{"c"}\K\T{99}$} is the number of a single-character string, as explained
above. But
\PB{\\{print\_char}(\.{"c"})} is quicker, so \MP\ goes directly to the \PB{%
\\{print\_char}}
routine when it knows that this is safe. (The present implementation
assumes that it is always safe to print a visible ASCII character.)

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_print}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\\{ss},\39{}$\&{size\_t} \\{len})\1\1\2\2\6
${}\{{}$\C{ prints string \PB{\|s} }\1\6
\&{if} ${}(\\{len}\E\T{0}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp}\MG\\{selector}\E\\{new\_string}){}$\5
${}\{{}$\1\6
\\{str\_room}(\\{len});\6
${}\\{memcpy}((\\{mp}\MG\\{cur\_string}+\\{mp}\MG\\{cur\_length}),\39\\{ss},\39%
\\{len});{}$\6
${}\\{mp}\MG\\{cur\_length}\MRL{+{\K}}\\{len};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{size\_t} \|j${}\K\T{0};{}$\7
\&{while} ${}(\|j<\\{len}){}$\5
${}\{{}$\C{ this was \PB{\\{xord}((\&{int}) \\{ss}[\|j])} but that doesnt work
}\1\6
${}\\{mp\_print\_char}(\\{mp},\39{}$(\&{ASCII\_code}) \\{ss}[\|j]);\6
${}\|j\PP;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{89}
\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{ss}){}$\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\\{ss}\I\NULL);{}$\6
${}\\{mp\_do\_print}(\\{mp},\39\\{ss},\39\\{strlen}(\\{ss}));{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_printf}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}\\{ss},%
\39\,\ldots\,){}$\1\1\2\2\6
${}\{{}$\1\6
\&{va\_list} \\{ap};\6
\&{char} \\{pval}[\T{256}];\7
${}\\{assert}(\\{ss}\I\NULL);{}$\6
${}\\{va\_start}(\\{ap},\39\\{ss});{}$\6
${}\\{vsnprintf}(\\{pval},\39\T{256},\39\\{ss},\39\\{ap});{}$\6
${}\\{mp\_do\_print}(\\{mp},\39\\{pval},\39\\{strlen}(\\{pval}));{}$\6
\\{va\_end}(\\{ap});\6
\4${}\}{}$\2\7
\&{void} \\{mp\_print\_str}(\&{MP} \\{mp}${},\39{}$\&{mp\_string} \|s)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|s\I\NULL);{}$\6
${}\\{mp\_do\_print}(\\{mp},\39{}$(\&{const} \&{char} ${}{*}){}$ \|s${}\MG%
\\{str},\39\|s\MG\\{len});{}$\6
\4${}\}{}$\2\par
\fi

\M{90}Here is the very first thing that \MP\ prints: a headline that identifies
the version number and base name. The \PB{\\{term\_offset}} variable is
temporarily
incorrect, but the discrepancy is not serious since we assume that the banner
and mem identifier together will occupy at most \PB{\\{max\_print\_line}}
character positions.

\Y\B\4\X81:Initialize the output routines\X${}\mathrel+\E{}$\6
$\\{wterm}(\\{mp}\MG\\{banner});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
\\{update\_terminal}(\,);\par
\fi

\M{91}The procedure \PB{\\{print\_nl}} is like \PB{\\{print}}, but it makes
sure that the
string appears at the beginning of a new line.

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_nl}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\|s){}$\1\1\2\2\6
${}\{{}$\C{ prints string \PB{\|s} at beginning of line }\1\6
\&{switch} ${}(\\{mp}\MG\\{selector}){}$\5
${}\{{}$\1\6
\4\&{case} \\{term\_and\_log}:\6
\&{if} ${}((\\{mp}\MG\\{term\_offset}>\T{0})\V(\\{mp}\MG\\{file\_offset}>%
\T{0})){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{log\_only}:\6
\&{if} ${}(\\{mp}\MG\\{file\_offset}>\T{0}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{term\_only}:\6
\&{if} ${}(\\{mp}\MG\\{term\_offset}>\T{0}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{no\_print}:\5
\&{case} \\{pseudo}:\5
\&{case} \\{new\_string}:\5
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
${}\\{mp\_print}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\par
\fi

\M{92}The following procedure, which prints out the decimal representation of a
given integer \PB{\|n}, assumes that all integers fit nicely into a \PB{%
\&{int}}.

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_int}(\&{MP} \\{mp}${},\39{}$\&{integer} \|n)\1\1\2\2\6
${}\{{}$\C{ prints an integer in decimal form }\1\6
\&{char} \|s[\T{12}];\7
${}\\{mp\_snprintf}(\|s,\39\T{12},\39\.{"\%d"},\39{}$(\&{int}) \|n);\6
${}\\{mp\_print}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_print\_pointer}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}\|n){}$\1%
\1\2\2\6
${}\{{}$\C{ prints an pointer in hexadecimal form }\1\6
\&{char} \|s[\T{12}];\7
${}\\{mp\_snprintf}(\|s,\39\T{12},\39\.{"\%p"},\39\|n);{}$\6
${}\\{mp\_print}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\par
\fi

\M{93}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_int}(\&{MP} \\{mp}${},\39{}$\&{integer} \|n);\6
\&{void} \\{mp\_print\_pointer}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}\|n){}$;%
\par
\fi

\M{94}\MP\ also makes use of a trivial procedure to print two digits. The
following subroutine is usually called with a parameter in the range \PB{$\T{0}%
\Z\|n\Z\T{99}$}.

\Y\B\&{static} \&{void} \\{mp\_print\_dd}(\&{MP} \\{mp}${},\39{}$\&{integer} %
\|n)\1\1\2\2\6
${}\{{}$\C{ prints two least significant digits }\1\6
${}\|n\K\\{abs}(\|n)\MOD\T{100};{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'0'}+(\|n/\T{10})));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'0'}+(\|n\MOD\T{10})));{}$\6
\4${}\}{}$\2\par
\fi

\M{95}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_dd}(\&{MP} \\{mp}${},\39{}$\&{integer} \|n);%
\par
\fi

\M{96}Here is a procedure that asks the user to type a line of input,
assuming that the \PB{\\{selector}} setting is either \PB{\\{term\_only}} or %
\PB{\\{term\_and\_log}}.
The input is placed into locations \PB{\\{first}} through \PB{$\\{last}-\T{1}$}
of the
\PB{\\{buffer}} array, and echoed on the transcript file if appropriate.

This procedure is never called when \PB{$\\{interaction}<\\{mp\_scroll%
\_mode}$}.

\Y\B\4\D$\\{prompt\_input}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\\{wake\_up\_terminal}(\,);\6
${}\\{mp\_print}(\\{mp},\39(\|A));{}$\6
\4${}\}{}$\2\6
\\{mp\_term\_input}(\\{mp});\6
\4${}\}{}$\2\6
\&{while} (\T{0})\C{ prints a string and gets a line of input }\par
\Y\B\&{void} \\{mp\_term\_input}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ gets a line from the terminal }\1\6
\&{size\_t} \|k;\C{ index into \PB{\\{buffer}} }\7
\&{if} ${}(\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_input\_ln}(\\{mp},\39\\{mp}\MG\\{term\_in})){}$\1\5
${}\\{longjmp}({*}(\\{mp}\MG\\{jump\_buf}),\39\T{1}){}$;\C{ chunk finished }\2\6
${}\\{mp}\MG\\{buffer}[\\{mp}\MG\\{last}]\K\\{xord}(\.{'\%'});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{update\_terminal}(\,);\C{ Now the user sees the prompt for sure }\6
\&{if} ${}(\R\\{mp\_input\_ln}(\\{mp},\39\\{mp}\MG\\{term\_in})){}$\5
${}\{{}$\1\6
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"End\ of\ file\ on\ the\ }\)%
\.{terminal!"});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{term\_offset}\K\T{0}{}$;\C{ the user's line ended with \<\rm
return> }\6
${}\\{decr}(\\{mp}\MG\\{selector}){}$;\C{ prepare to echo the input }\6
\&{if} ${}(\\{mp}\MG\\{last}\I\\{mp}\MG\\{first}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|k\K\\{mp}\MG\\{first};{}$ ${}\|k<\\{mp}\MG\\{last};{}$ ${}\|k%
\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{buffer}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{buffer}[\\{mp}\MG\\{last}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{incr}(\\{mp}\MG\\{selector}){}$;\C{ restore previous status }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{97}Reporting errors.

The \PB{\\{print\_err}} procedure supplies a `\.!' before the official message,
and makes sure that the terminal is awake if a stop is going to occur.
The \PB{\&{error}} procedure supplies a `\..' after the official message, then
it
shows the location of the error; and if \PB{$\\{interaction}\K\\{error\_stop%
\_mode}$},
it also enters into a dialog with the user, during which time the help
message may be printed.

\fi

\M{98}The global variable \PB{\\{interaction}} has four settings, representing
increasing
amounts of user interaction:

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_interaction\_mode} ${}\{{}$\1\6
${}\\{mp\_unspecified\_mode}\K\T{0},{}$\C{ extra value for command-line switch
}\6
\\{mp\_batch\_mode}${},{}$\C{ omits all stops and omits terminal output }\6
\\{mp\_nonstop\_mode}${},{}$\C{ omits all stops }\6
\\{mp\_scroll\_mode}${},{}$\C{ omits error stops }\6
\\{mp\_error\_stop\_mode}\C{ stops at every opportunity to interact }\2\6
${}\}{}$;\par
\fi

\M{99}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{interaction};\C{ current level of interaction }\6
\&{int} \\{noninteractive};\C{ do we have a terminal? }\par
\fi

\M{100}Set it here so it can be overwritten by the commandline

\Y\B\4\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{interaction}\K\\{opt}\MG\\{interaction};{}$\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_unspecified\_mode}\V\\{mp}\MG%
\\{interaction}>\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_error\_stop\_mode};{}$\2\6
\&{if} ${}(\\{mp}\MG\\{interaction}<\\{mp\_unspecified\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_batch\_mode}{}$;\2\par
\fi

\M{101}\PB{\\{print\_err}} is not merged in \PB{\&{error}} because it is also
used in \PB{\\{prompt\_file\_name}},
where \PB{\&{error}} is not called at all.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_err}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|A){}$;\par
\fi

\M{102}\B\&{static} \&{void} \\{mp\_print\_err}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\|A){}$\1\1 $\{$ \6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
\\{wake\_up\_terminal}(\,);\2\6
\&{if} ${}(\\{mp}\MG\\{file\_line\_error\_style}\W\\{file\_state}\W\R%
\\{terminal\_input})$ $\{$ $\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
\&{if} ${}(\\{long\_name}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\\{long\_name});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\\{mp\_str}(\\{mp},\39\\{name}));{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{":"});$ \\{mp\_print\_int} $(\\{mp},\39$ \&{line}
)  ;\6
${}\\{mp\_print}(\\{mp},\39\.{":\ "});$ $\}$ \6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"!\ "});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\|A);$ $\}{}$\par
\fi

\M{103}\MP\ is careful not to call \PB{\&{error}} when the print \PB{%
\\{selector}} setting
might be unusual. The only possible values of \PB{\\{selector}} at the time of
error messages are

\yskip\hang\PB{\\{no\_print}} (when \PB{$\\{interaction}\K\\{mp\_batch\_mode}$}
and \PB{\\{log\_file}} not yet open);

\hang\PB{\\{term\_only}} (when \PB{$\\{interaction}>\\{mp\_batch\_mode}$} and %
\PB{\\{log\_file}} not yet open);

\hang\PB{\\{log\_only}} (when \PB{$\\{interaction}\K\\{mp\_batch\_mode}$} and %
\PB{\\{log\_file}} is open);

\hang\PB{\\{term\_and\_log}} (when \PB{$\\{interaction}>\\{mp\_batch\_mode}$}
and \PB{\\{log\_file}} is open).

\Y\B\4\D$\\{initialize\_print\_selector}()$ \5
$\\{mp}\MG\\{selector}\K(\\{mp}\MG\\{interaction}\E\\{mp\_batch\_mode}\?\\{no%
\_print}:\\{term\_only}){}$;\par
\fi

\M{104}The global variable \PB{\\{history}} records the worst level of error
that
has been detected. It has four possible values: \PB{\\{spotless}}, \PB{%
\\{warning\_issued}},
\PB{\\{error\_message\_issued}}, and \PB{\\{fatal\_error\_stop}}.

Another global variable, \PB{\\{error\_count}}, is increased by one when an
\PB{\&{error}} occurs without an interactive dialog, and it is reset to zero at
the end of every statement.  If \PB{\\{error\_count}} reaches 100, \MP\ decides
that there is no point in continuing further.

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_history\_state} ${}\{{}$\1\6
${}\\{mp\_spotless}\K\T{0},{}$\C{ \PB{\\{history}} value when nothing has been
amiss yet }\6
\\{mp\_warning\_issued}${},{}$\C{ \PB{\\{history}} value when \PB{\\{begin%
\_diagnostic}} has been called }\6
\\{mp\_error\_message\_issued}${},{}$\C{ \PB{\\{history}} value when \PB{%
\&{error}} has been called }\6
\\{mp\_fatal\_error\_stop}${},{}$\C{ \PB{\\{history}} value when termination
was premature }\6
\\{mp\_system\_error\_stop}\C{ \PB{\\{history}} value when termination was due
to disaster }\2\6
${}\}{}$;\par
\fi

\M{105}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{history};\C{ has the source input been clean so far? }\6
\&{int} \\{error\_count};\C{ the number of scrolled errors since the last
statement ended }\par
\fi

\M{106}The value of \PB{\\{history}} is initially \PB{\\{fatal\_error\_stop}},
but it will
be changed to \PB{\\{spotless}} if \MP\ survives the initialization process.

\fi

\M{107}Since errors can be detected almost anywhere in \MP, we want to declare
the
error procedures near the beginning of the program. But the error procedures
in turn use some other procedures, which need to be declared \PB{\\{forward}}
before we get to \PB{\&{error}} itself.

It is possible for \PB{\&{error}} to be called recursively if some error arises
when \PB{\\{get\_next}} is being used to delete a token, and/or if some fatal
error
occurs while \MP\ is trying to fix a non-fatal one. But such recursion
is never more than two levels deep.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_get\_next}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_term\_input}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_show\_context}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_begin\_file\_reading}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_open\_log\_file}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_clear\_for\_error\_prompt}(\&{MP} \\{mp});\par
\fi

\M{108}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_normalize\_selector}(\&{MP} \\{mp});\par
\fi

\M{109}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{use\_err\_help};\C{ should the \PB{\\{err\_help}} string be
shown? }\6
\&{mp\_string} \\{err\_help};\C{ a string set up by \&{errhelp} }\par
\fi

\M{110}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{use\_err\_help}\K\\{false}{}$;\par
\fi

\M{111}The \PB{\\{jump\_out}} procedure just cuts across all active procedure
levels and
goes to \PB{\\{end\_of\_MP}}. This is the only nonlocal \PB{\&{goto}} statement
in the
whole program. It is used when there is no recovery from a particular error.

The program uses a \PB{\\{jump\_buf}} to handle this, this is initialized at
three
spots: the start of \PB{\\{mp\_new}}, the start of \PB{\\{mp\_initialize}}, and
the start
of \PB{\\{mp\_run}}. Those are the only library enty points.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{jmp\_buf} ${}{*}\\{jump\_buf}{}$;\par
\fi

\M{112}If the array of internals is still \PB{$\NULL$} when \PB{\\{jump\_out}}
is called, a
crash occured during initialization, and it is not safe to run the normal
cleanup routine.

\Y\B\4\X112:Error handling procedures\X${}\E{}$\6
\&{void} \\{mp\_jump\_out}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{internal}\I\NULL\W\\{mp}\MG\\{history}<\\{mp\_system%
\_error\_stop}){}$\1\5
\\{mp\_close\_files\_and\_terminate}(\\{mp});\2\6
${}\\{longjmp}({*}(\\{mp}\MG\\{jump\_buf}),\39\T{1});{}$\6
\4${}\}{}$\2\par
\As114, 132, 135\ETs137.
\U5.\fi

\M{113}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_jump\_out}(\&{MP} \\{mp});\par
\fi

\M{114}

\Y\B\4\X112:Error handling procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_warn}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{msg}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \\{saved\_selector}${}\K\\{mp}\MG\\{selector};{}$\7
\\{mp\_normalize\_selector}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Warning:\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{msg});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{selector}\K\\{saved\_selector};{}$\6
\4${}\}{}$\2\par
\fi

\M{115}Here now is the general \PB{\&{error}} routine.

The argument \PB{\\{deletions\_allowed}} is set \PB{\\{false}} if the \PB{%
\\{get\_next}}
routine is active when \PB{\&{error}} is called; this ensures that \PB{\\{get%
\_next}}
will never be called recursively.

Individual lines of help are recorded in the array \PB{\\{help\_line}}, which
contains entries in positions \PB{$\T{0..}(\\{help\_ptr}-\T{1})$}. They should
be printed
in reverse order, i.e., with \PB{\\{help\_line}[\T{0}]} appearing last.

\Y\B\&{void} \\{mp\_error}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\\{msg},\39{}$\&{const} \&{char} ${}{*}{*}\\{hlp},\39{}$\&{boolean} %
\\{deletions\_allowed})\1\1\2\2\6
${}\{{}$\1\6
\&{ASCII\_code} \|c;\C{ what the user types }\6
\&{integer} \\{s1}${},{}$ \\{s2};\C{ used to save global variables when
deleting tokens }\7
\\{mp\_sym}\\{s3};\C{ likewise }\7
\&{int} \|i${}\K\T{0};{}$\6
\&{const} \&{char} ${}{*}\\{help\_line}[\T{6}]{}$;\C{ helps for the next \PB{%
\&{error}} }\6
\&{unsigned} \&{int} \\{help\_ptr};\C{ the number of help lines present }\6
\&{const} \&{char} ${}{*}{*}\\{cnt}\K\NULL;{}$\7
${}\\{mp\_print\_err}(\\{mp},\39\\{msg});{}$\6
\&{if} (\\{hlp})\5
${}\{{}$\1\6
${}\\{cnt}\K\\{hlp};{}$\6
\&{while} ${}({*}\\{cnt}){}$\5
${}\{{}$\1\6
${}\|i\PP;{}$\6
${}\\{cnt}\PP;{}$\6
\4${}\}{}$\2\6
${}\\{cnt}\K\\{hlp};{}$\6
\4${}\}{}$\2\6
${}\\{help\_ptr}\K\|i;{}$\6
\&{while} ${}(\|i>\T{0}){}$\5
${}\{{}$\1\6
${}\\{help\_line}[\MM\|i]\K{*}\\{cnt}\PP;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{history}<\\{mp\_error\_message\_issued}){}$\1\5
${}\\{mp}\MG\\{history}\K\\{mp\_error\_message\_issued};{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'.'}));{}$\6
\\{mp\_show\_context}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{halt\_on\_error}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\&{if} ${}((\R\\{mp}\MG\\{noninteractive})\W(\\{mp}\MG\\{interaction}\E\\{mp%
\_error\_stop\_mode})){}$\5
${}\{{}$\1\6
\X117:Get user's advice and \PB{\&{return}}\X;\6
\4${}\}{}$\2\6
${}\\{incr}(\\{mp}\MG\\{error\_count});{}$\6
\&{if} ${}(\\{mp}\MG\\{error\_count}\E\T{100}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(That\ makes\ 100\ err}\)\.{ors;\ please\
try\ agai}\)\.{n.)"});{}$\6
;\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\X130:Put help message on the transcript file\X;\6
\4${}\}{}$\2\par
\fi

\M{116}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{extern} \&{void} \\{mp\_error}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\\{msg},\39{}$\&{const} \&{char} ${}{*}{*}\\{hlp},\39{}$\&{boolean} %
\\{deletions\_allowed});\6
\&{extern} \&{void} \\{mp\_warn}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\\{msg}){}$;\par
\fi

\M{117}\B\X117:Get user's advice and \PB{\&{return}}\X${}\E{}$\6
\&{while} (\\{true})\5
${}\{{}$\1\6
\4\.{CONTINUE}:\5
\\{mp\_clear\_for\_error\_prompt}(\\{mp});\6
\\{prompt\_input}(\.{"?\ "});\6
;\6
\&{if} ${}(\\{mp}\MG\\{last}\E\\{mp}\MG\\{first}){}$\1\5
\&{return};\2\6
${}\|c\K\\{mp}\MG\\{buffer}[\\{mp}\MG\\{first}];{}$\6
\&{if} ${}(\|c\G\.{'a'}){}$\1\5
${}\|c\K(\&{ASCII\_code})(\|c+\.{'A'}-\.{'a'}){}$;\C{ convert to uppercase }\2\6
\X123:Interpret code \PB{\|c} and \PB{\&{return}} if done\X;\6
\4${}\}{}$\2\par
\U115.\fi

\M{118}It is desirable to provide an `\.E' option here that gives the user
an easy way to return from \MP\ to the system editor, with the offending
line ready to be edited. But such an extension requires some system
wizardry, so the present implementation simply types out the name of the
file that should be
edited and the relevant line number.

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_editor\_cmd})(\&{MP},\39{}$\&{char} ${}{*},%
\39\&{int}){}$;\par
\fi

\M{119}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\\{mp\_editor\_cmd}\\{run\_editor};\par
\fi

\M{120}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
\\{set\_callback\_option}(\\{run\_editor});\par
\fi

\M{121}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_run\_editor}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}%
\\{fname},\39{}$\&{int} \\{fline});\par
\fi

\M{122}\B\&{void} \\{mp\_run\_editor}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}%
\\{fname},\39{}$\&{int} \\{fline})\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{xmalloc}(\T{256},\39\T{1});{}$\7
${}\\{mp\_snprintf}(\|s,\39\T{256},\39\.{"You\ want\ to\ edit\ fi}\)\.{le\ \%s\
at\ line\ \%d\\n"},\39\\{fname},\39\\{fline});{}$\6
\\{wterm\_ln}(\|s);\6
\4${}\}{}$\2\par
\fi

\M{123}

\Y\B\4\X123:Interpret code \PB{\|c} and \PB{\&{return}} if done\X${}\E{}$\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \.{'0'}:\5
\&{case} \.{'1'}:\5
\&{case} \.{'2'}:\5
\&{case} \.{'3'}:\5
\&{case} \.{'4'}:\5
\&{case} \.{'5'}:\5
\&{case} \.{'6'}:\5
\&{case} \.{'7'}:\5
\&{case} \.{'8'}:\5
\&{case} \.{'9'}:\6
\&{if} (\\{deletions\_allowed})\5
${}\{{}$\1\6
\X127:Delete tokens and \PB{\&{continue}}\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \.{'E'}:\6
\&{if} ${}(\\{mp}\MG\\{file\_ptr}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode};{}$\6
\\{mp\_close\_files\_and\_terminate}(\\{mp});\6
${}(\\{mp}\MG\\{run\_editor})(\\{mp},\39\\{mp\_str}(\\{mp},\39\\{mp}\MG\\{input%
\_stack}[\\{mp}\MG\\{file\_ptr}].\\{name\_field}),\39\\{mp\_true\_line}(%
\\{mp}));{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \.{'H'}:\5
\X128:Print the help information and \PB{\&{continue}}\X;\C{ \PB{\&{break};} }\6
\4\&{case} \.{'I'}:\5
\X126:Introduce new material from the terminal and \PB{\&{return}}\X;\C{ \PB{%
\&{break};} }\6
\4\&{case} \.{'Q'}:\5
\&{case} \.{'R'}:\5
\&{case} \.{'S'}:\5
\X125:Change the interaction level and \PB{\&{return}}\X;\C{ \PB{\&{break};} }\6
\4\&{case} \.{'X'}:\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
\X124:Print the menu of available options\X\par
\U117.\fi

\M{124}\B\X124:Print the menu of available options\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"Type\ <return>\ to\ pr}\)\.{oceed,\ S\ to\
scroll\ f}\)\.{uture\ error\ messages}\)\.{,"});{}$\6
;\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"R\ to\ run\ without\ st}\)\.{opping,\ Q\ to\
run\ qui}\)\.{etly,"});{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"I\ to\ insert\ somethi}\)\.{ng,\ "});{}$\6
\&{if} ${}(\\{mp}\MG\\{file\_ptr}>\T{0}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"E\ to\ edit\ your\ file}\)\.{,"});{}$\2\6
\&{if} (\\{deletions\_allowed})\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"1\ or\ ...\ or\ 9\ to\ ig}\)\.{nore\ the\
next\ 1\ to\ 9}\)\.{\ tokens\ of\ input,"});{}$\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"H\ for\ help,\ X\ to\ qu}\)\.{it."});{}$\6
\4${}\}{}$\2\par
\U123.\fi

\M{125}\B\X125:Change the interaction level and \PB{\&{return}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp}\MG\\{error\_count}\K\T{0};{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"OK,\ entering\ "});{}$\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \.{'Q'}:\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_batch\_mode};{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"batchmode"});{}$\6
${}\\{decr}(\\{mp}\MG\\{selector});{}$\6
\&{break};\6
\4\&{case} \.{'R'}:\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_nonstop\_mode};{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"nonstopmode"});{}$\6
\&{break};\6
\4\&{case} \.{'S'}:\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode};{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"scrollmode"});{}$\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
${}\\{mp\_print}(\\{mp},\39\.{"..."});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
\\{update\_terminal}(\,);\6
\&{return};\6
\4${}\}{}$\2\par
\U123.\fi

\M{126}When the following code is executed, \PB{$\\{buffer}[(\\{first}+\T{1})%
\MRL{{.}{.}}(\\{last}-\T{1})]$} may
contain the material inserted by the user; otherwise another prompt will
be given. In order to understand this part of the program fully, you need
to be familiar with \MP's input stacks.

\Y\B\4\X126:Introduce new material from the terminal and \PB{\&{return}}\X${}%
\E{}$\6
${}\{{}$\1\6
\\{mp\_begin\_file\_reading}(\\{mp});\C{ enter a new syntactic level for
terminal input }\6
\&{if} ${}(\\{mp}\MG\\{last}>\\{mp}\MG\\{first}+\T{1}){}$\5
${}\{{}$\1\6
${}\\{loc}\K(\\{halfword})(\\{mp}\MG\\{first}+\T{1});{}$\6
${}\\{mp}\MG\\{buffer}[\\{mp}\MG\\{first}]\K\\{xord}(\.{'\ '});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{prompt\_input}(\.{"insert>"});\6
${}\\{loc}\K(\\{halfword})\\{mp}\MG\\{first};{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{first}\K\\{mp}\MG\\{last}+\T{1};{}$\6
${}\\{mp}\MG\\{cur\_input}.\\{limit\_field}\K(\\{halfword})\\{mp}\MG%
\\{last};{}$\6
\&{return};\6
\4${}\}{}$\2\par
\U123.\fi

\M{127}We allow deletion of up to 99 tokens at a time.

\Y\B\4\X127:Delete tokens and \PB{\&{continue}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{s1}\K\\{cur\_cmd}(\,);{}$\6
${}\\{s2}\K\\{cur\_mod}(\,);{}$\6
${}\\{s3}\K\\{cur\_sym}(\,);{}$\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{false};{}$\6
\&{if} ${}((\\{mp}\MG\\{last}>\\{mp}\MG\\{first}+\T{1})\W(\\{mp}\MG\\{buffer}[%
\\{mp}\MG\\{first}+\T{1}]\G\.{'0'})\W(\\{mp}\MG\\{buffer}[\\{mp}\MG\\{first}+%
\T{1}]\Z\.{'9'})){}$\1\5
${}\|c\K\\{xord}(\|c*\T{10}+\\{mp}\MG\\{buffer}[\\{mp}\MG\\{first}+\T{1}]-%
\.{'0'}*\T{11});{}$\2\6
\&{else}\1\5
${}\|c\K(\&{ASCII\_code})(\|c-\.{'0'});{}$\2\6
\&{while} ${}(\|c>\T{0}){}$\5
${}\{{}$\1\6
\\{mp\_get\_next}(\\{mp});\C{ one-level recursive call of \PB{\&{error}} is
possible }\6
\X812:Decrease the string reference count, if the current token is a string\X;\6
${}\|c\MM;{}$\6
\4${}\}{}$\2\6
;\6
\\{set\_cur\_cmd}(\\{s1});\6
\\{set\_cur\_mod}(\\{s2});\6
\\{set\_cur\_sym}(\\{s3});\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{true};{}$\6
${}\\{help\_ptr}\K\T{2};{}$\6
${}\\{help\_line}[\T{1}]\K\.{"I\ have\ just\ deleted}\)\.{\ some\ text,\ as\
you\ a}\)\.{sked."};{}$\6
${}\\{help\_line}[\T{0}]\K\.{"You\ can\ now\ delete\ }\)\.{more,\ or\ insert,\
or\ }\)\.{whatever."};{}$\6
\\{mp\_show\_context}(\\{mp});\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\par
\U123.\fi

\M{128}Some wriggling with \PB{\\{help\_line}} is done here to avoid giving no
information whatsoever, or presenting the same information twice
in a row.

\Y\B\4\X128:Print the help information and \PB{\&{continue}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{use\_err\_help}){}$\5
${}\{{}$\1\6
\X129:Print the string \PB{\\{err\_help}}, possibly on several lines\X;\6
${}\\{mp}\MG\\{use\_err\_help}\K\\{false};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{help\_ptr}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{help\_ptr}\K\T{2};{}$\6
${}\\{help\_line}[\T{1}]\K\.{"Sorry,\ I\ don't\ know}\)\.{\ how\ to\ help\ in\
this}\)\.{\ situation."};{}$\6
${}\\{help\_line}[\T{0}]\K\.{"Maybe\ you\ should\ tr}\)\.{y\ asking\ a\
human?"};{}$\6
\4${}\}{}$\2\6
\&{do}\5
${}\{{}$\1\6
\\{decr}(\\{help\_ptr});\6
${}\\{mp\_print}(\\{mp},\39\\{help\_line}[\\{help\_ptr}]);{}$\6
\\{mp\_print\_ln}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{help\_ptr}\I\T{0});{}$\6
\4${}\}{}$\2\6
;\6
${}\\{help\_ptr}\K\T{4};{}$\6
${}\\{help\_line}[\T{3}]\K\.{"Sorry,\ I\ already\ ga}\)\.{ve\ what\ help\ I\
could}\)\.{..."};{}$\6
${}\\{help\_line}[\T{2}]\K\.{"Maybe\ you\ should\ tr}\)\.{y\ asking\ a\
human?"};{}$\6
${}\\{help\_line}[\T{1}]\K\.{"An\ error\ might\ have}\)\.{\ occurred\ before\ I%
\ n}\)\.{oticed\ any\ problems.}\)\.{"};{}$\6
${}\\{help\_line}[\T{0}]\K\.{"``If\ all\ else\ fails}\)\.{,\ read\ the\
instructi}\)\.{ons.''"};{}$\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\par
\U123.\fi

\M{129}\B\X129:Print the string \PB{\\{err\_help}}, possibly on several lines%
\X${}\E{}$\6
${}\{{}$\1\6
\&{size\_t} \|j${}\K\T{0};{}$\7
\&{while} ${}(\|j<\\{mp}\MG\\{err\_help}\MG\\{len}){}$\5
${}\{{}$\1\6
\&{if} ${}({*}(\\{mp}\MG\\{err\_help}\MG\\{str}+\|j)\I\.{'\%'}){}$\1\5
${}\\{mp\_print}(\\{mp},\39{}$(\&{const} \&{char} ${}{*})(\\{mp}\MG\\{err%
\_help}\MG\\{str}+\|j));{}$\2\6
\&{else} \&{if} ${}(\|j+\T{1}\E\\{mp}\MG\\{err\_help}\MG\\{len}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{else} \&{if} ${}({*}(\\{mp}\MG\\{err\_help}\MG\\{str}+\|j)\I\.{'\%'}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{else}\5
${}\{{}$\1\6
${}\|j\PP;{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\%'}));{}$\6
\4${}\}{}$\2\6
;\6
${}\|j\PP;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\Us128\ET130.\fi

\M{130}\B\X130:Put help message on the transcript file\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{interaction}>\\{mp\_batch\_mode}){}$\1\5
${}\\{decr}(\\{mp}\MG\\{selector}){}$;\C{ avoid terminal output }\2\6
\&{if} ${}(\\{mp}\MG\\{use\_err\_help}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
\X129:Print the string \PB{\\{err\_help}}, possibly on several lines\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{while} ${}(\\{help\_ptr}>\T{0}){}$\5
${}\{{}$\1\6
\\{decr}(\\{help\_ptr});\6
${}\\{mp\_print\_nl}(\\{mp},\39\\{help\_line}[\\{help\_ptr}]);{}$\6
\4${}\}{}$\2\6
;\6
\\{mp\_print\_ln}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{interaction}>\\{mp\_batch\_mode}){}$\1\5
${}\\{incr}(\\{mp}\MG\\{selector}){}$;\C{ re-enable terminal output }\2\6
\\{mp\_print\_ln}(\\{mp});\6
\4${}\}{}$\2\par
\U115.\fi

\M{131}In anomalous cases, the print selector might be in an unknown state;
the following subroutine is called to fix things just enough to keep
running a bit longer.

\Y\B\&{void} \\{mp\_normalize\_selector}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp}\MG\\{selector}\K\\{term\_and\_log};{}$\2\6
\&{else}\1\5
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\2\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\1\5
\\{mp\_open\_log\_file}(\\{mp});\2\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_batch\_mode}){}$\1\5
${}\\{decr}(\\{mp}\MG\\{selector});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{132}The following procedure prints \MP's last words before dying.

\Y\B\4\X112:Error handling procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_fatal\_error}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\|s){}$\1\1\2\2\6
${}\{{}$\C{ prints \PB{\|s}, and that's it }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\|s,\39\NULL\};{}$\7
\\{mp\_normalize\_selector}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode}{}$;\C{ no more interaction }%
\2\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\.{"Emergency\ stop"},\39\\{hlp},\39\\{true});{}$\2\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\C{ irrecoverable error }\6
\4${}\}{}$\2\par
\fi

\M{133}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{extern} \&{void} \\{mp\_fatal\_error}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s){}$;\par
\fi

\M{134}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_overflow}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}\|s,%
\39{}$\&{integer} \|n);\par
\fi

\M{135}\B\X112:Error handling procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_overflow}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}\|s,%
\39{}$\&{integer} \|n)\1\1\2\2\6
${}\{{}$\C{ stop due to finiteness }\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"If\ you\ really\ absol}\)\.{utely\
need\ more\ capa}\)\.{city,"},\39\.{"you\ can\ ask\ a\ wizar}\)\.{d\ to\
enlarge\ me."},\39\NULL\};{}$\7
\\{mp\_normalize\_selector}(\\{mp});\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"MetaPost\ capacity\ e}\)%
\.{xceeded,\ sorry\ [\%s=\%}\)\.{d]"},\39\|s,\39{}$(\&{int}) \|n);\6
;\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode}{}$;\C{ no more interaction }%
\2\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\2\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\C{ irrecoverable error }\6
\4${}\}{}$\2\par
\fi

\M{136}The program might sometime run completely amok, at which point there is
no choice but to stop. If no previous error has been detected, that's bad
news; a message is printed that is really intended for the \MP\
maintenance person instead of the user (unless the user has been
particularly diabolical).  The index entries for `this can't happen' may
help to pinpoint the problem.

\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_confusion}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\|s){}$;\par
\fi

\M{137}Consistency check violated; \PB{\|s} tells where.
\Y\B\4\X112:Error handling procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_confusion}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char} ${}{*}%
\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"One\ of\ your\ faux\ pa}\)\.{s\
seems\ to\ have\ woun}\)\.{ded\ me\ deeply..."},\39\.{"in\ fact,\ I'm\ barely}%
\)\.{\ conscious.\ Please\ f}\)\.{ix\ it\ and\ try\ again.}\)\.{"},\39\NULL%
\};{}$\7
\\{mp\_normalize\_selector}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{history}<\\{mp\_error\_message\_issued}){}$\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"This\ can't\ happen\ (}\)\.{%
\%s)"},\39\|s);{}$\6
;\6
${}\\{hlp}[\T{0}]\K\.{"I'm\ broken.\ Please\ }\)\.{show\ this\ to\ someone}\)%
\.{\ who\ can\ fix\ can\ fix}\)\.{"};{}$\6
${}\\{hlp}[\T{1}]\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"I\ can\\'t\ go\ on\ meet}\)\.{ing%
\ you\ like\ this"});{}$\6
;\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode}{}$;\C{ no more interaction }%
\2\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\2\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\C{ irrecoverable error }\6
\4${}\}{}$\2\par
\fi

\M{138}Users occasionally want to interrupt \MP\ while it's running.
If the runtime system allows this, one can implement
a routine that sets the global variable \PB{\\{interrupt}} to some nonzero
value
when such an interrupt is signaled. Otherwise there is probably at least
a way to make \PB{\\{interrupt}} nonzero using the C debugger.

\Y\B\4\D$\\{check\_interrupt}$ \6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{interrupt}\I\T{0}){}$\1\5
\\{mp\_pause\_for\_instructions}(\\{mp});\2\6
\4${}\}{}$\2\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{interrupt};\C{ should \MP\ pause for instructions? }\6
\&{boolean} \\{OK\_to\_interrupt};\C{ should interrupts be observed? }\6
\&{integer} \\{run\_state};\C{ are we processing input ? }\6
\&{boolean} \\{finished};\C{ set true by \PB{\\{close\_files\_and\_terminate}}
}\6
\&{boolean} \\{reading\_preload};\par
\fi

\M{139}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{OK\_to\_interrupt}\K\\{true};{}$\6
${}\\{mp}\MG\\{finished}\K\\{false}{}$;\par
\fi

\M{140}When an interrupt has been detected, the program goes into its
highest interaction level and lets the user have the full flexibility of
the \PB{\&{error}} routine.  \MP\ checks for interrupts only at times when it
is
safe to do this.

\Y\B\&{static} \&{void} \\{mp\_pause\_for\_instructions}(\&{MP} \\{mp})\1\1\2\2%
\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You\ rang?"},\39\.{"Try\ to\ insert%
\ some\ }\)\.{instructions\ for\ me\ }\)\.{(e.g.,`I\ show\ x'),"},\39\.{"unless%
\ you\ just\ wan}\)\.{t\ to\ quit\ by\ typing\ }\)\.{`X'."},\39\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{OK\_to\_interrupt}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{interaction}\K\\{mp\_error\_stop\_mode};{}$\6
\&{if} ${}((\\{mp}\MG\\{selector}\E\\{log\_only})\V(\\{mp}\MG\\{selector}\E%
\\{no\_print})){}$\1\5
${}\\{incr}(\\{mp}\MG\\{selector});{}$\2\6
;\6
${}\\{mp\_error}(\\{mp},\39\.{"Interruption"},\39\\{hlp},\39\\{false});{}$\6
${}\\{mp}\MG\\{interrupt}\K\T{0};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{141}Arithmetic with scaled numbers.
The principal computations performed by \MP\ are done entirely in terms of
integers less than $2^{31}$ in magnitude; thus, the arithmetic specified in
this
program can be carried out in exactly the same way on a wide variety of
computers, including some small ones.

But C does not rigidly define the \PB{$/$} operation in the case of negative
dividends; for example, the result of \PB{$({-}\T{2}*\|n-\T{1})/\T{2}$} is %
\PB{${-}(\|n+\T{1})$} on some
computers and \PB{${-}\|n$} on others (is this true ?).  There are two
principal
types of arithmetic: ``translation-preserving,'' in which the identity
\PB{$(\|a+\|q*\|b)/\|b\K(\|a/\|b)+\|q$} is valid; and ``negation-preserving,''
in which
\PB{$({-}\|a)/\|b\K{-}(\|a/\|b)$}. This leads to two \MP s, which can produce
different results, although the differences should be negligible when the
language is being used properly.  The \TeX\ processor has been defined
carefully so that both varieties of arithmetic will produce identical
output, but it would be too inefficient to constrain \MP\ in a similar way.

\Y\B\4\D$\\{inf\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{inf\_t}\par
\fi

\M{142}A single computation might use several subroutine calls, and it is
desirable to avoid producing multiple error messages in case of arithmetic
overflow. So the routines below set the global variable \PB{\\{arith\_error}}
to \PB{\\{true}}
instead of reporting errors directly to the user.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{arith\_error};\C{ has arithmetic overflow occurred recently? }%
\par
\fi

\M{143}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{arith\_error}\K\\{false}{}$;\par
\fi

\M{144}At crucial points the program will say \PB{\\{check\_arith}}, to test if
an arithmetic error has been detected.

\Y\B\4\D$\\{check\_arith}()$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{arith\_error}){}$\1\5
\\{mp\_clear\_arith}(\\{mp});\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{void} \\{mp\_clear\_arith}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Uh,\ oh.\ A\ little\ wh}\)\.{ile\
ago\ one\ of\ the\ q}\)\.{uantities\ that\ I\ was}\)\.{"},\39\.{"computing\ got%
\ too\ l}\)\.{arge,\ so\ I'm\ afraid\ }\)\.{your\ answers\ will\ be}\)\.{"},\39%
\.{"somewhat\ askew.\ You}\)\.{'ll\ probably\ have\ to}\)\.{\ adopt\
different"},\39\.{"tactics\ next\ time.\ }\)\.{But\ I\ shall\ try\ to\ c}\)%
\.{arry\ on\ anyway."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Arithmetic\ overflow}\)\.{"},\39\\{hlp},\39%
\\{true});{}$\6
;\6
${}\\{mp}\MG\\{arith\_error}\K\\{false};{}$\6
\4${}\}{}$\2\par
\fi

\M{145}The definitions of these are set up by the math initialization.

\Y\B\4\D$\\{arc\_tol\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{arc\_tol\_k}\par
\B\4\D$\\{coef\_bound\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{coef\_bound\_k}\par
\B\4\D$\\{coef\_bound\_minus\_1}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{coef\_bound\_minus%
\_1}\par
\B\4\D$\\{sqrt\_8\_e\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{sqrt\_8\_e\_k}\par
\B\4\D$\\{twelve\_ln\_2\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{twelve\_ln\_2\_k}\par
\B\4\D$\\{twelvebits\_3}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{twelvebits\_3}\par
\B\4\D$\\{one\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{one\_k}\par
\B\4\D$\\{epsilon\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{epsilon\_t}\par
\B\4\D$\\{unity\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{unity\_t}\par
\B\4\D$\\{zero\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{zero\_t}\par
\B\4\D$\\{two\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{two\_t}\par
\B\4\D$\\{three\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{three\_t}\par
\B\4\D$\\{half\_unit\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{half\_unit\_t}\par
\B\4\D$\\{three\_quarter\_unit\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{three\_quarter\_unit%
\_t}\par
\B\4\D$\\{twentysixbits\_sqrt2\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{twentysixbits\_sqrt2%
\_t}\par
\B\4\D$\\{twentyeightbits\_d\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{twentyeightbits\_d%
\_t}\par
\B\4\D$\\{twentysevenbits\_sqrt2\_d\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{twentysevenbits%
\_sqrt2\_d\_t}\par
\B\4\D$\\{warning\_limit\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{warning\_limit\_t}\par
\B\4\D$\\{precision\_default}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{precision\_default}%
\par
\B\4\D$\\{precision\_max}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{precision\_max}\par
\B\4\D$\\{precision\_min}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{precision\_min}\par
\fi

\M{146}In fact, the two sorts of scaling discussed above aren't quite
sufficient; \MP\ has yet another, used internally to keep track of angles.

\fi

\M{147}We often want to print two scaled quantities in parentheses,
separated by a comma.

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_two}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} \|x${},\39{}$%
\&{mp\_number} \|y)\1\1\2\2\6
${}\{{}$\C{ prints `\PB{$(\|x,\|y)$}' }\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
\\{print\_number}(\|x);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
\\{print\_number}(\|y);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\fi

\M{148}
\Y\B\4\D$\\{fraction\_one\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{fraction\_one\_t}\par
\B\4\D$\\{fraction\_half\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{fraction\_half\_t}\par
\B\4\D$\\{fraction\_three\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{fraction\_three\_t}%
\par
\B\4\D$\\{fraction\_four\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{fraction\_four\_t}\par
\B\4\D$\\{one\_eighty\_deg\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{one\_eighty\_deg\_t}%
\par
\B\4\D$\\{three\_sixty\_deg\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{three\_sixty\_deg\_t}%
\par
\fi

\M{149}\B\X35:Local variables for initialization\X${}\mathrel+\E{}$\6
\&{integer} \|k;\C{ all-purpose loop index }\par
\fi

\M{150}And now let's complete our collection of numeric utility routines
by considering random number generation.
\MP\ generates pseudo-random numbers with the additive scheme recommended
in Section 3.6 of {\sl The Art of Computer Programming}; however, the
results are random fractions between 0 and \PB{$\\{fraction\_one}-\T{1}$},
inclusive.

There's an auxiliary array \PB{\\{randoms}} that contains 55 pseudo-random
fractions. Using the recurrence $x_n=(x_{n-55}-x_{n-31})\bmod 2^{28}$,
we generate batches of 55 new $x_n$'s at a time by calling \PB{\\{new%
\_randoms}}.
The global variable \PB{\\{j\_random}} tells which element has most recently
been consumed.
The global variable \PB{\\{random\_seed}} was introduced in version 0.9,
for the sole reason of stressing the fact that the initial value of the
random seed is system-dependant. The initialization code below will initialize
this variable to \PB{$(\\{internal}[\\{mp\_time}]\\{div}\\{unity})+%
\\{internal}[\\{mp\_day}]$}, but this
is not good enough on modern fast machines that are capable of running
multiple MetaPost processes within the same second.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{randoms}[\T{55}];\C{ the last 55 random values generated }\6
\&{int} \\{j\_random};\C{ the number of unused \PB{\\{randoms}} }\par
\fi

\M{151}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{random\_seed};\C{ the default random seed }\par
\fi

\M{152}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{random\_seed}\K\\{opt}\MG\\{random\_seed};{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\T{55};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{new\_fraction}(\\{mp}\MG\\{randoms}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{153}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\T{55};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{randoms}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{154}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_new\_randoms}(\&{MP} \\{mp});\par
\fi

\M{155}\B\&{void} \\{mp\_new\_randoms}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\C{ index into \PB{\\{randoms}} }\6
\&{mp\_number} \|x;\C{ accumulator }\7
\\{new\_number}(\|x);\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{23};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\|x,\39\\{mp}\MG\\{randoms}[\|k],\39%
\\{mp}\MG\\{randoms}[\|k+\T{31}]);{}$\6
\&{if} (\\{number\_negative}(\|x))\1\5
${}\\{number\_add}(\|x,\39\\{fraction\_one\_t});{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{randoms}[\|k],\39\|x);{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{24};{}$ ${}\|k\Z\T{54};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\|x,\39\\{mp}\MG\\{randoms}[\|k],\39%
\\{mp}\MG\\{randoms}[\|k-\T{24}]);{}$\6
\&{if} (\\{number\_negative}(\|x))\1\5
${}\\{number\_add}(\|x,\39\\{fraction\_one\_t});{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{randoms}[\|k],\39\|x);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|x);\6
${}\\{mp}\MG\\{j\_random}\K\T{54};{}$\6
\4${}\}{}$\2\par
\fi

\M{156}To consume a random fraction, the program below will say `\PB{\\{next%
\_random}}'.

\Y\B\&{static} \&{void} \\{mp\_next\_random}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{j\_random}\E\T{0}){}$\1\5
\\{mp\_new\_randoms}(\\{mp});\2\6
\&{else}\1\5
${}\\{decr}(\\{mp}\MG\\{j\_random});{}$\2\6
${}\\{number\_clone}({*}\\{ret},\39\\{mp}\MG\\{randoms}[\\{mp}\MG\\{j%
\_random}]);{}$\6
\4${}\}{}$\2\par
\fi

\M{157}To produce a uniform random number in the range \PB{$\T{0}\Z\|u<\|x$} or
\PB{$\T{0}\G\|u>\|x$}
or \PB{$\T{0}\K\|u\K\|x$}, given a \PB{\\{scaled}} value~\PB{\|x}, we proceed
as shown here.

Note that the call of \PB{\\{take\_fraction}} will produce the values 0 and~%
\PB{\|x}
with about half the probability that it will produce any other particular
values between 0 and~\PB{\|x}, because it rounds its answers.

\Y\B\&{static} \&{void} \\{mp\_unif\_rand}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \\{x\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|y;\C{ trial value }\6
\&{mp\_number} \|x${},{}$ \\{abs\_x};\6
\&{mp\_number} \|u;\7
\\{new\_fraction}(\|y);\6
\\{new\_number}(\|x);\6
\\{new\_number}(\\{abs\_x});\6
\\{new\_number}(\|u);\6
${}\\{number\_clone}(\|x,\39\\{x\_orig});{}$\6
${}\\{number\_clone}(\\{abs\_x},\39\|x);{}$\6
\\{number\_abs}(\\{abs\_x});\6
${}\\{mp\_next\_random}(\\{mp},\39{\AND}\|u);{}$\6
${}\\{take\_fraction}(\|y,\39\\{abs\_x},\39\|u);{}$\6
\\{free\_number}(\|u);\6
\&{if} ${}(\\{number\_equal}(\|y,\39\\{abs\_x})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\|x))\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\\{ret},\39\|y);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\\{ret},\39\|y);{}$\6
${}\\{number\_negate}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abs\_x});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\|y);\6
\4${}\}{}$\2\par
\fi

\M{158}Finally, a normal deviate with mean zero and unit standard deviation
can readily be obtained with the ratio method (Algorithm 3.4.1R in
{\sl The Art of Computer Programming\/}).

\Y\B\&{static} \&{void} \\{mp\_norm\_rand}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{abs\_x};\6
\&{mp\_number} \|u;\6
\&{mp\_number} \|r;\6
\&{mp\_number} \\{la}${},{}$ \\{xa};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{new\_number}(\\{la});\6
\\{new\_number}(\\{xa});\6
\\{new\_number}(\\{abs\_x});\6
\\{new\_number}(\|u);\6
\\{new\_number}(\|r);\6
\&{do}\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
\&{mp\_number} \|v;\7
\\{new\_number}(\|v);\6
${}\\{mp\_next\_random}(\\{mp},\39{\AND}\|v);{}$\6
${}\\{number\_substract}(\|v,\39\\{fraction\_half\_t});{}$\6
${}\\{take\_fraction}(\\{xa},\39\\{sqrt\_8\_e\_k},\39\|v);{}$\6
\\{free\_number}(\|v);\6
${}\\{mp\_next\_random}(\\{mp},\39{\AND}\|u);{}$\6
${}\\{number\_clone}(\\{abs\_x},\39\\{xa});{}$\6
\\{number\_abs}(\\{abs\_x});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{number\_greaterequal}(\\{abs\_x},\39\|u));{}$\6
${}\\{make\_fraction}(\|r,\39\\{xa},\39\|u);{}$\6
${}\\{number\_clone}(\\{xa},\39\|r);{}$\6
${}\\{m\_log}(\\{la},\39\|u);{}$\6
${}\\{set\_number\_from\_substraction}(\\{la},\39\\{twelve\_ln\_2\_k},\39%
\\{la});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{one\_k},\39\\{la},\39\\{xa},\39%
\\{xa});{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_negative}(\\{ab\_vs\_cd}));\6
${}\\{number\_clone}({*}\\{ret},\39\\{xa});{}$\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\|r);\6
\\{free\_number}(\\{abs\_x});\6
\\{free\_number}(\\{la});\6
\\{free\_number}(\\{xa});\6
\\{free\_number}(\|u);\6
\4${}\}{}$\2\par
\fi

\N{1}{159}Packed data.

\Y\B\4\D$\\{max\_quarterword}$ \5
\T{\^3FFF}\C{ largest allowable value in a \PB{\\{quarterword}} }\par
\B\4\D$\\{max\_halfword}$ \5
\T{\^FFFFFFF}\C{ largest allowable value in a \PB{\\{halfword}} }\par
\fi

\M{160}The macros \PB{\\{qi}} and \PB{\\{qo}} are used for input to and output
from quarterwords. These are legacy macros.

\Y\B\4\D$\\{qo}(\|A)$ \5
(\|A)\C{ to read eight bits from a quarterword }\par
\B\4\D$\\{qi}(\|A)$ \5
(\\{quarterword})(\|A)\C{ to store eight bits in a quarterword }\par
\fi

\M{161}The reader should study the following definitions closely:

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \\{mp\_value\_node\_data} ${}{*}\&{mp\_value\_node};{}$\6
\&{typedef} \&{struct} \\{mp\_node\_data} ${}{*}\&{mp\_node};{}$\6
\&{typedef} \&{struct} \\{mp\_symbol\_entry} ${}{*}\&{mp\_sym};{}$\6
\&{typedef} \&{short} \&{quarterword};\C{ 1/4 of a word }\6
\&{typedef} \&{int} \&{halfword};\C{ 1/2 of a word }\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{integer} \\{scale};\C{ only for \PB{\\{indep\_scale}}, used together with %
\PB{\\{serial}} }\6
\&{integer} \\{serial};\C{ only for \PB{\\{indep\_value}}, used together with %
\PB{\\{scale}} }\2\6
${}\}{}$ \&{mp\_independent\_data};\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{mp\_independent\_data} \\{indep};\6
\&{mp\_number} \|n;\6
\&{mp\_string} \\{str};\6
\&{mp\_sym} \\{sym};\6
\&{mp\_node} \\{node};\7
\\{mp\_knot}\|p;\2\6
${}\}{}$ \&{mp\_value\_data};\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\\{mp\_variable\_type}\\{type};\7
\&{mp\_value\_data} \\{data};\2\6
${}\}{}$ \&{mp\_value};\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{quarterword} \\{b0}${},{}$ \\{b1}${},{}$ \\{b2}${},{}$ \\{b3};\2\6
${}\}{}$ \&{four\_quarters};\6
\&{typedef} \&{union} ${}\{{}$\1\6
\&{integer} \\{sc};\6
\&{four\_quarters} \\{qqqq};\2\6
${}\}{}$ \&{font\_data};\par
\fi

\M{162}The global variable \PB{\\{math\_mode}} has four settings, representing
the
math value type that will be used in this run.

the typedef for \PB{\&{mp\_number}} is here because it has to come very early.

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{mp\_math\_scaled\_mode}\K\T{0},\39\\{mp\_math\_double\_mode}\K\T{1},\39%
\\{mp\_math\_binary\_mode}\K\T{2},\39\\{mp\_math\_decimal\_mode}\K\T{3}{}$\2\6
${}\}{}$ \&{mp\_math\_mode};\par
\fi

\M{163}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{math\_mode};\C{ math mode }\par
\fi

\M{164}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{math\_mode}\K\\{opt}\MG\\{math\_mode}{}$;\par
\fi

\M{165}
\Y\B\4\D$\\{xfree}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\\{mp\_xfree}(\|A);\6
${}\|A\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{xrealloc}(\|P,\|A,\|B)$ \5
$\\{mp\_xrealloc}(\\{mp},\39\|P,\39{}$(\&{size\_t}) \|A${},\39\|B{}$)\par
\B\4\D$\\{xmalloc}(\|A,\|B)$ \5
$\\{mp\_xmalloc}(\\{mp},\39{}$(\&{size\_t}) \|A${},\39\|B{}$)\par
\B\4\D$\\{xstrdup}(\|A)$ \5
$\\{mp\_xstrdup}(\\{mp},\39\|A{}$)\par
\B\4\D$\.{XREALLOC}(\|a,\|b,\|c)$ \5
$\|a\K\\{xrealloc}(\|a,\39(\|b+\T{1}),\39{}$\&{sizeof} (\|c));\par
\Y\B\4\X165:Declare helpers\X${}\E{}$\6
\&{extern} \&{void} \\{mp\_xfree}(\&{void} ${}{*}\|x);{}$\6
\&{extern} \&{void} ${}{*}{}$\\{mp\_xrealloc}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|p,\39{}$\&{size\_t} \\{nmem}${},\39{}$\&{size\_t} \\{size});\6
\&{extern} \&{void} ${}{*}{}$\\{mp\_xmalloc}(\&{MP} \\{mp}${},\39{}$\&{size\_t}
\\{nmem}${},\39{}$\&{size\_t} \\{size});\6
\&{extern} \&{void} \\{mp\_do\_snprintf}(\&{char} ${}{*}\\{str},\39{}$\&{int} %
\\{size}${},\39{}$\&{const} \&{char} ${}{*}\\{fmt},\39\,\ldots\,);{}$\6
\&{extern} \&{void} ${}{*}{}$\\{do\_alloc\_node}(\&{MP} \\{mp}${},\39{}$\&{size%
\_t} \\{size});\par
\U4.\fi

\M{166}This is an attempt to spend less time in \PB{\\{malloc}(\,)}:

\Y\B\4\D$\\{max\_num\_token\_nodes}$ \5
\T{1000}\par
\B\4\D$\\{max\_num\_pair\_nodes}$ \5
\T{1000}\par
\B\4\D$\\{max\_num\_knot\_nodes}$ \5
\T{1000}\par
\B\4\D$\\{max\_num\_value\_nodes}$ \5
\T{1000}\par
\B\4\D$\\{max\_num\_symbolic\_nodes}$ \5
\T{1000}\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} \\{token\_nodes};\6
\&{int} \\{num\_token\_nodes};\6
\&{mp\_node} \\{pair\_nodes};\6
\&{int} \\{num\_pair\_nodes};\7
\\{mp\_knot}\\{knot\_nodes};\7
\&{int} \\{num\_knot\_nodes};\6
\&{mp\_node} \\{value\_nodes};\6
\&{int} \\{num\_value\_nodes};\6
\&{mp\_node} \\{symbolic\_nodes};\6
\&{int} \\{num\_symbolic\_nodes};\par
\fi

\M{167}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{token\_nodes}\K\NULL;{}$\6
${}\\{mp}\MG\\{num\_token\_nodes}\K\T{0};{}$\6
${}\\{mp}\MG\\{pair\_nodes}\K\NULL;{}$\6
${}\\{mp}\MG\\{num\_pair\_nodes}\K\T{0};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\NULL;{}$\6
${}\\{mp}\MG\\{num\_knot\_nodes}\K\T{0};{}$\6
${}\\{mp}\MG\\{value\_nodes}\K\NULL;{}$\6
${}\\{mp}\MG\\{num\_value\_nodes}\K\T{0};{}$\6
${}\\{mp}\MG\\{symbolic\_nodes}\K\NULL;{}$\6
${}\\{mp}\MG\\{num\_symbolic\_nodes}\K\T{0}{}$;\par
\fi

\M{168}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{while} ${}(\\{mp}\MG\\{value\_nodes}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\\{mp}\MG\\{value\_nodes};{}$\7
${}\\{mp}\MG\\{value\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\|p,\39\\{value\_node\_size});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{symbolic\_nodes}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\\{mp}\MG\\{symbolic\_nodes};{}$\7
${}\\{mp}\MG\\{symbolic\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\|p,\39\\{symbolic\_node\_size});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{pair\_nodes}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\\{mp}\MG\\{pair\_nodes};{}$\7
${}\\{mp}\MG\\{pair\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\|p,\39\\{pair\_node\_size});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{token\_nodes}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\\{mp}\MG\\{token\_nodes};{}$\7
${}\\{mp}\MG\\{token\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\|p,\39\\{token\_node\_size});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{knot\_nodes}){}$\5
${}\{{}$\1\6
${}\\{mp\_knot}\|p\K\\{mp}\MG\\{knot\_nodes};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\|p\MG\\{next};{}$\6
${}\\{mp\_free\_knot}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{169}This is a nicer way of allocating nodes.

\Y\B\4\D$\\{malloc\_node}(\|A)$ \5
$\\{do\_alloc\_node}(\\{mp},\39(\|A){}$)\par
\fi

\M{170}
\Y\B\&{void} ${}{*}{}$\\{do\_alloc\_node}(\&{MP} \\{mp}${},\39{}$\&{size\_t} %
\\{size})\1\1\2\2\6
${}\{{}$\1\6
\&{void} ${}{*}\|p;{}$\7
${}\|p\K\\{xmalloc}(\T{1},\39\\{size});{}$\6
\\{add\_var\_used}(\\{size});\6
((\&{mp\_node}) \|p)${}\MG\\{link}\K\NULL;{}$\6
((\&{mp\_node}) \|p)${}\MG\\{has\_number}\K\T{0};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{171}The \PB{\\{max\_size\_test}} guards against overflow, on the assumption
that
\PB{\&{size\_t}} is at least 31bits wide.

\Y\B\4\D$\\{max\_size\_test}$ \5
\T{\^7FFFFFFF}\par
\Y\B\&{void} \\{mp\_xfree}(\&{void} ${}{*}\|x){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|x\I\NULL){}$\1\5
\\{free}(\|x);\2\6
\4${}\}{}$\2\7
\&{void} ${}{*}{}$\\{mp\_xrealloc}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}\|p,%
\39{}$\&{size\_t} \\{nmem}${},\39{}$\&{size\_t} \\{size})\1\1\2\2\6
${}\{{}$\1\6
\&{void} ${}{*}\|w;{}$\7
\&{if} ${}((\\{max\_size\_test}/\\{size})<\\{nmem}){}$\5
${}\{{}$\1\6
${}\\{mp\_fputs}(\.{"Memory\ size\ overflo}\)\.{w!\\n"},\39\\{mp}\MG\\{err%
\_out});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
${}\|w\K\\{realloc}(\|p,\39(\\{nmem}*\\{size}));{}$\6
\&{if} ${}(\|w\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_fputs}(\.{"Out\ of\ memory!\\n"},\39\\{mp}\MG\\{err\_out});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_system\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\&{return} \|w;\6
\4${}\}{}$\2\7
\&{void} ${}{*}{}$\\{mp\_xmalloc}(\&{MP} \\{mp}${},\39{}$\&{size\_t} %
\\{nmem}${},\39{}$\&{size\_t} \\{size})\1\1\2\2\6
${}\{{}$\1\6
\&{void} ${}{*}\|w;{}$\6
\8\#\&{if} \.{DEBUG}\7
\&{if} ${}((\\{max\_size\_test}/\\{size})<\\{nmem}){}$\5
${}\{{}$\1\6
${}\\{mp\_fputs}(\.{"Memory\ size\ overflo}\)\.{w!\\n"},\39\\{mp}\MG\\{err%
\_out});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\8\#\&{endif}\6
${}\|w\K\\{malloc}(\\{nmem}*\\{size});{}$\6
\&{if} ${}(\|w\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_fputs}(\.{"Out\ of\ memory!\\n"},\39\\{mp}\MG\\{err\_out});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_system\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\&{return} \|w;\6
\4${}\}{}$\2\par
\fi

\M{172}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\8\#\&{define} \\{mp\_snprintf}(\&{void}) \5\\{snprintf}\par
\fi

\N{1}{173}Dynamic memory allocation.

The \MP\ system does nearly all of its own memory allocation, so that it
can readily be transported into environments that do not have automatic
facilities for strings, garbage collection, etc., and so that it can be in
control of what error messages the user receives.

\Y\B\4\D$\.{MP\_VOID}$ \5
(\&{mp\_node})(\T{1})\C{ \PB{$\NULL+\T{1}$}, a \PB{$\NULL$} pointer different
from \PB{$\NULL$} }\par
\B\4\D$\\{mp\_link}(\|A)$ \5
$(\|A)\MG{}$\\{link}\C{ the \PB{\\{link}} field of a node }\par
\B\4\D$\\{set\_mp\_link}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
\&{mp\_node} \|d${}\K(\|B){}$;\C{ \PB{$\\{printf}(\.{"set\ link\ \ \ \ of\ \%p\
t}\)\.{o\ \%p\ on\ line\ \%d\\n"},(\|A),\|d,\.{\_\_LINE\_\_});$} }\7
${}\\{mp\_link}((\|A))\K\|d;{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{mp\_type}(\|A)$ \5
$(\|A)\MG{}$\\{type}\C{ identifies what kind of value this is }\par
\B\4\D$\\{mp\_name\_type}(\|A)$ \5
$(\|A)\MG{}$\\{name\_type}\C{ a clue to the name of this value }\par
\fi

\M{174}\B\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} \.{NODE\_BODY}\\{mp\_variable\_type}\\{type};\6
\\{mp\_name\_type\_type}\\{name\_type};\7
\&{unsigned} \&{short} \\{has\_number}; \&{struct} \\{mp\_node\_data} ${}{*}%
\\{link}$ \6
\&{typedef} \&{struct} \&{mp\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_value\_data} \\{data};\2\6
${}\}{}$ \&{mp\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_node\_data} ${}{*}\&{mp\_symbolic\_node}{}$;\par
\fi

\M{175}Users who wish to study the memory requirements of particular
applications can
can use the special features that keep track of current and maximum memory
usage.
\MP\ will report these statistics when \PB{\\{mp\_tracing\_stats}} is positive.

\Y\B\4\D$\\{add\_var\_used}(\|a)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{mp}\MG\\{var\_used}\MRL{+{\K}}(\|a);{}$\6
\&{if} ${}(\\{mp}\MG\\{var\_used}>\\{mp}\MG\\{var\_used\_max}){}$\1\5
${}\\{mp}\MG\\{var\_used\_max}\K\\{mp}\MG\\{var\_used};{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{size\_t} \\{var\_used};\C{ how much memory is in use }\6
\&{size\_t} \\{var\_used\_max};\C{ how much memory was in use max }\par
\fi

\M{176}These redirect to function to aid in debugging.

\Y\B\8\#\&{if} \.{DEBUG}\6
\8\#\&{define} \\{mp\_sym\_info}(\|A)\\{get\_mp\_sym\_info} \5${}(\\{mp},\39(%
\|A)){}$\6
\8\#\&{define} ${}\\{set\_mp\_sym\_info}(\|A,\39\|B)\\{do\_set\_mp\_sym\_info} %
\5(\\{mp},\39(\|A),\39(\|B)){}$\6
\8\#\&{define} \\{mp\_sym\_sym}(\|A)\\{get\_mp\_sym\_sym} \5${}(\\{mp},\39(%
\|A)){}$\6
\8\#\&{define} ${}\\{set\_mp\_sym\_sym}(\|A,\39\|B)\\{do\_set\_mp\_sym\_sym} %
\5(\\{mp},\39(\|A),\39(\&{mp\_sym})(\|B)){}$\6
\&{static} \&{void} \\{do\_set\_mp\_sym\_info}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{halfword} \|v)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"do\_set\_mp\_sym\_info(}\)\.{\%p,\%d)\\n"},\39\|p,%
\39\|v);{}$\6
${}\\{assert}(\|p\MG\\{type}\E\\{mp\_symbol\_node});{}$\6
${}\\{set\_indep\_value}(\|p,\39\|v);{}$\6
\4${}\}{}$\2\7
\&{static} \&{halfword} \\{get\_mp\_sym\_info}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%d\ =\ get\_mp\_sym\_inf}\)\.{o(\%p)\\n"},\39%
\\{indep\_value}(\|p),\39\|p);{}$\6
${}\\{assert}(\|p\MG\\{type}\E\\{mp\_symbol\_node});{}$\6
\&{return} \\{indep\_value}(\|p);\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_mp\_sym\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{mp\_sym} \|v)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_symbolic\_node} \\{pp}${}\K{}$(\&{mp\_symbolic\_node}) \|p;\7
${}\.{FUNCTION\_TRACE3}(\.{"do\_set\_mp\_sym\_sym(\%}\)\.{p,\%p)\\n"},\39%
\\{pp},\39\|v);{}$\6
${}\\{assert}(\\{pp}\MG\\{type}\E\\{mp\_symbol\_node});{}$\6
${}\\{pp}\MG\\{data}.\\{sym}\K\|v;{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_sym} \\{get\_mp\_sym\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_symbolic\_node} \\{pp}${}\K{}$(\&{mp\_symbolic\_node}) \|p;\7
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_mp\_sym\_sym}\)\.{(\%p)\\n"},\39\\{pp}%
\MG\\{data}.\\{sym},\39\\{pp});{}$\6
${}\\{assert}(\\{pp}\MG\\{type}\E\\{mp\_symbol\_node});{}$\6
\&{return} \\{pp}${}\MG\\{data}.\\{sym};{}$\6
\4${}\}{}$\2\6
\8\#\&{else}\6
\8\#\&{define} \\{mp\_sym\_info}(\|A)\\{indep\_value} \5(\|A)\6
\8\#\&{define} ${}\\{set\_mp\_sym\_info}(\|A,\39\|B)\\{set\_indep\_value} \5(%
\|A,\39(\|B)){}$\6
\8\#\&{define} ${}\\{mp\_sym\_sym}(\|A)(\|A)\MG\\{data}.\\{sym}{}$\6
\8\#\&{define} ${}\\{set\_mp\_sym\_sym}(\|A,\39\|B)(\|A)\MG\\{data}.\\{sym}\K(%
\&{mp\_sym})(\|B){}$\6
\8\#\&{endif}\par
\fi

\M{177}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\8\#\&{if} \.{DEBUG}\6
\&{static} \&{void} \\{do\_set\_mp\_sym\_info}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|A${},\39{}$\&{halfword} \|B);\6
\&{static} \&{halfword} \\{get\_mp\_sym\_info}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\6
\&{static} \&{void} \\{do\_set\_mp\_sym\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|A${},\39{}$\&{mp\_sym} \|B);\6
\&{static} \&{mp\_sym} \\{get\_mp\_sym\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\6
\8\#\&{endif}\par
\fi

\M{178}The function \PB{\\{get\_symbolic\_node}} returns a pointer to a new
symbolic node whose
\PB{\\{link}} field is null.

\Y\B\4\D$\\{symbolic\_node\_size}$ \5
\&{sizeof}(\&{mp\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_symbolic\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_symbolic\_node} \|p;\7
\&{if} ${}(\\{mp}\MG\\{symbolic\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\K{}$(\&{mp\_symbolic\_node}) \\{mp}${}\MG\\{symbolic\_nodes};{}$\6
${}\\{mp}\MG\\{symbolic\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp}\MG\\{num\_symbolic\_nodes}\MM;{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{malloc\_node}(\\{symbolic\_node\_size});{}$\6
${}\\{new\_number}(\|p\MG\\{data}.\|n);{}$\6
${}\|p\MG\\{has\_number}\K\T{1};{}$\6
\4${}\}{}$\2\6
${}\|p\MG\\{type}\K\\{mp\_symbol\_node};{}$\6
${}\|p\MG\\{name\_type}\K\\{mp\_normal\_sym};{}$\6
${}\.{FUNCTION\_TRACE2}(\.{"\%p\ =\ mp\_get\_symboli}\)\.{c\_node()\\n"},\39%
\|p);{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{179}Conversely, when some node \PB{\|p} of size \PB{\|s} is no longer
needed,
the operation \PB{$\\{free\_node}(\|p,\|s)$} will make its words available, by
inserting
\PB{\|p} as a new empty node just before where \PB{\\{rover}} now points.

A symbolic node is recycled by calling \PB{\\{free\_symbolic\_node}}.

\Y\B\&{void} \\{mp\_free\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p${},%
\39{}$\&{size\_t} \\{siz})\1\1\2\2\6
${}\{{}$\C{ node liberation }\1\6
${}\.{FUNCTION\_TRACE3}(\.{"mp\_free\_node(\%p,\%d)}\)\.{\\n"},\39\|p,\39{}$(%
\&{int}) \\{siz});\6
\&{if} ${}(\R\|p){}$\1\5
\&{return};\2\6
${}\\{mp}\MG\\{var\_used}\MRL{-{\K}}\\{siz};{}$\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|p\MG\\{has\_number}\G\T{1}\W\\{is\_number}{}$(((\&{mp\_symbolic%
\_node}) \|p)${}\MG\\{data}.\|n)){}$\5
${}\{{}$\1\6
\\{free\_number}(((\&{mp\_symbolic\_node}) \|p)${}\MG\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\MG\\{has\_number}\E\T{2}\W\\{is\_number}{}$(((\&{mp\_value%
\_node}) \|p)${}\MG\\{subscript\_})){}$\5
${}\{{}$\1\6
\\{free\_number}(((\&{mp\_value\_node}) \|p)${}\MG\\{subscript\_});{}$\6
\4${}\}{}$\C{ There was a quite large \PB{\&{switch}} here first, but the \PB{%
\\{mp\_dash\_node}}        case was the only one that did anything ... }\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_dash\_node\_type}){}$\5
${}\{{}$\1\6
${}\\{free\_number}(((\\{mp\_dash\_node})\|p)\MG\\{start\_x});{}$\6
${}\\{free\_number}(((\\{mp\_dash\_node})\|p)\MG\\{stop\_x});{}$\6
${}\\{free\_number}(((\\{mp\_dash\_node})\|p)\MG\\{dash\_y});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{xfree}(\|p);\6
\4${}\}{}$\2\7
\&{void} \\{mp\_free\_symbolic\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)%
\1\1\2\2\6
${}\{{}$\C{ node liberation }\1\6
${}\.{FUNCTION\_TRACE2}(\.{"mp\_free\_symbolic\_no}\)\.{de(\%p)\\n"},\39%
\|p);{}$\6
\&{if} ${}(\R\|p){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp}\MG\\{num\_symbolic\_nodes}<\\{max\_num\_symbolic\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{symbolic\_nodes};{}$\6
${}\\{mp}\MG\\{symbolic\_nodes}\K\|p;{}$\6
${}\\{mp}\MG\\{num\_symbolic\_nodes}\PP;{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{var\_used}\MRL{-{\K}}\\{symbolic\_node\_size};{}$\6
\\{xfree}(\|p);\6
\4${}\}{}$\2\7
\&{void} \\{mp\_free\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1\1%
\2\2\6
${}\{{}$\C{ node liberation }\1\6
${}\.{FUNCTION\_TRACE2}(\.{"mp\_free\_value\_node(}\)\.{\%p)\\n"},\39\|p);{}$\6
\&{if} ${}(\R\|p){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp}\MG\\{num\_value\_nodes}<\\{max\_num\_value\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{value\_nodes};{}$\6
${}\\{mp}\MG\\{value\_nodes}\K\|p;{}$\6
${}\\{mp}\MG\\{num\_value\_nodes}\PP;{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{var\_used}\MRL{-{\K}}\\{value\_node\_size};{}$\6
${}\\{assert}(\|p\MG\\{has\_number}\E\T{2});{}$\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
\\{free\_number}(((\&{mp\_value\_node}) \|p)${}\MG\\{data}.\|n);{}$\6
\\{free\_number}(((\&{mp\_value\_node}) \|p)${}\MG\\{subscript\_});{}$\6
\4${}\}{}$\2\6
\\{xfree}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{180}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_free\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p${},\39{}$%
\&{size\_t} \\{siz});\6
\&{void} \\{mp\_free\_symbolic\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);%
\6
\&{void} \\{mp\_free\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);\par
\fi

\N{1}{181}Memory layout.
Some nodes are created statically, since static allocation is
more efficient than dynamic allocation when we can get away with it.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\\{mp\_dash\_node}\\{null\_dash};\7
\&{mp\_value\_node} \\{dep\_head};\6
\&{mp\_node} \\{inf\_val};\6
\&{mp\_node} \\{zero\_val};\6
\&{mp\_node} \\{temp\_val};\6
\&{mp\_node} \\{end\_attr};\6
\&{mp\_node} \\{bad\_vardef};\6
\&{mp\_node} \\{temp\_head};\6
\&{mp\_node} \\{hold\_head};\6
\&{mp\_node} \\{spec\_head};\par
\fi

\M{182}The following code gets the memory off to a good start.

\Y\B\4\X182:Initialize table entries\X${}\E{}$\6
$\\{mp}\MG\\{spec\_head}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{mp}\MG\\{last\_pending}\K\\{mp}\MG\\{spec\_head};{}$\6
${}\\{mp}\MG\\{temp\_head}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{mp}\MG\\{hold\_head}\K\\{mp\_get\_symbolic\_node}(\\{mp}){}$;\par
\As202, 203, 226, 227, 258, 368, 385, 448, 479, 611, 615, 628, 668, 763, 830,
927, 970, 1000, 1193, 1198, 1207\ETs1212.
\U1297.\fi

\M{183}\B\X183:Free table entries\X${}\E{}$\6
$\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{mp}\MG\\{spec\_head});{}$\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{mp}\MG\\{temp\_head});{}$\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{mp}\MG\\{hold\_head}){}$;\par
\As259, 480, 629, 669, 764, 901, 971, 1001, 1194\ETs1208.
\U12.\fi

\M{184}The procedure \PB{\\{flush\_node\_list}(\|p)} frees an entire linked
list of
nodes that starts at a given position, until coming to a \PB{$\NULL$} pointer.

\Y\B\&{static} \&{void} \\{mp\_flush\_node\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the node being recycled }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_flush\_node\_list(}\)\.{\%p)\\n"},\39\|p);{}$\6
\&{while} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
${}\|p\K\|p\MG\\{link};{}$\6
\&{if} ${}(\|q\MG\\{type}\I\\{mp\_symbol\_node}){}$\1\5
${}\\{mp\_free\_token\_node}(\\{mp},\39\|q);{}$\2\6
\&{else}\1\5
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|q);{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{185}The command codes.
Before we can go much further, we need to define symbolic names for the
internal
code numbers that represent the various commands obeyed by \MP. These codes
are somewhat arbitrary, but not completely so. For example,
some codes have been made adjacent so that \PB{\&{case}} statements in the
program need not consider cases that are widely spaced, or so that \PB{%
\&{case}}
statements can be replaced by \PB{\&{if}} statements. A command can begin an
expression if and only if its code lies between \PB{\\{min\_primary\_command}}
and
\PB{\\{max\_primary\_command}}, inclusive. The first token of a statement that
doesn't
begin with an expression has a command code between \PB{\\{min\_command}} and
\PB{\\{max\_statement\_command}}, inclusive. Anything less than \PB{\\{min%
\_command}} is
eliminated during macro expansions, and anything no more than \PB{\\{max\_pre%
\_command}}
is eliminated when expanding \TeX\ material.  Ranges such as
\PB{$\\{min\_secondary\_command}\MRL{{.}{.}}\\{max\_secondary\_command}$} are
used when parsing
expressions, but the relative ordering within such a range is generally not
critical.

The ordering of the highest-numbered commands
(\PB{$\\{comma}<\\{semicolon}<\\{end\_group}<\\{stop}$}) is crucial for the
parsing and
error-recovery methods of this program as is the ordering \PB{$\\{if\_test}<%
\\{fi\_or\_else}$}
for the smallest two commands.  The ordering is also important in the ranges
\PB{$\\{numeric\_token}\MRL{{.}{.}}\\{plus\_or\_minus}$} and \PB{$\\{left%
\_brace}\MRL{{.}{.}}\\{ampersand}$}.

At any rate, here is the list, for future reference.

\Y\B\4\D$\\{mp\_max\_command\_code}$ \5
\\{mp\_stop}\par
\B\4\D$\\{mp\_max\_pre\_command}$ \5
\\{mp\_mpx\_break}\par
\B\4\D$\\{mp\_min\_command}$ \5
$(\\{mp\_defined\_macro}+\T{1}{}$)\par
\B\4\D$\\{mp\_max\_statement\_command}$ \5
\\{mp\_type\_name}\par
\B\4\D$\\{mp\_min\_primary\_command}$ \5
\\{mp\_type\_name}\par
\B\4\D$\\{mp\_min\_suffix\_token}$ \5
\\{mp\_internal\_quantity}\par
\B\4\D$\\{mp\_max\_suffix\_token}$ \5
\\{mp\_numeric\_token}\par
\B\4\D$\\{mp\_max\_primary\_command}$ \5
\\{mp\_plus\_or\_minus}\C{ should also be \PB{$\\{numeric\_token}+\T{1}$} }\par
\B\4\D$\\{mp\_min\_tertiary\_command}$ \5
\\{mp\_plus\_or\_minus}\par
\B\4\D$\\{mp\_max\_tertiary\_command}$ \5
\\{mp\_tertiary\_binary}\par
\B\4\D$\\{mp\_min\_expression\_command}$ \5
\\{mp\_left\_brace}\par
\B\4\D$\\{mp\_max\_expression\_command}$ \5
\\{mp\_equals}\par
\B\4\D$\\{mp\_min\_secondary\_command}$ \5
\\{mp\_and\_command}\par
\B\4\D$\\{mp\_max\_secondary\_command}$ \5
\\{mp\_secondary\_binary}\par
\B\4\D$\\{mp\_end\_of\_statement}$ \5
$(\\{cur\_cmd}(\,)>\\{mp\_comma}{}$)\par
\Y\B\4\X185:Enumeration types\X${}\E{}$\6
\&{typedef} \&{enum} ${}\{$ $\\{mp\_start\_tex}\K\T{1},{}$\C{ begin \TeX\
material (\&{btex}, \&{verbatimtex}) }\6
\\{mp\_etex\_marker}${},{}$\C{ end \TeX\ material (\&{etex}) }\6
\\{mp\_mpx\_break}${},{}$\C{ stop reading an \.{MPX} file (\&{mpxbreak}) }\6
\\{mp\_if\_test}${},{}$\C{ conditional text (\&{if}) }\6
\\{mp\_fi\_or\_else}${},{}$\C{ delimiters for conditionals (\&{elseif}, %
\&{else}, \&{fi}) }\6
\\{mp\_input}${},{}$\C{ input a source file (\&{input}, \&{endinput}) }\6
\\{mp\_iteration}${},{}$\C{ iterate (\&{for}, \&{forsuffixes}, \&{forever}, %
\&{endfor}) }\6
\\{mp\_repeat\_loop}${},{}$\C{ special command substituted for \&{endfor} }\6
\\{mp\_exit\_test}${},{}$\C{ premature exit from a loop (\&{exitif}) }\6
\\{mp\_relax}${},{}$\C{ do nothing (\.{\char`\\}) }\6
\\{mp\_scan\_tokens}${},{}$\C{ put a string into the input buffer }\6
\\{mp\_expand\_after}${},{}$\C{ look ahead one token }\6
\\{mp\_defined\_macro}${},{}$\C{ a macro defined by the user }\6
\\{mp\_save\_command}${},{}$\C{ save a list of tokens (\&{save}) }\6
\\{mp\_interim\_command}${},{}$\C{ save an internal quantity (\&{interim}) }\6
\\{mp\_let\_command}${},{}$\C{ redefine a symbolic token (\&{let}) }\6
\\{mp\_new\_internal}${},{}$\C{ define a new internal quantity (%
\&{newinternal}) }\6
\\{mp\_macro\_def}${},{}$\C{ define a macro (\&{def}, \&{vardef}, etc.) }\6
\\{mp\_ship\_out\_command}${},{}$\C{ output a character (\&{shipout}) }\6
\\{mp\_add\_to\_command}${},{}$\C{ add to edges (\&{addto}) }\6
\\{mp\_bounds\_command}${},{}$\C{ add bounding path to edges (\&{setbounds}, %
\&{clip}) }\6
\\{mp\_tfm\_command}${},{}$\C{ command for font metric info (\&{ligtable},
etc.) }\6
\\{mp\_protection\_command}${},{}$\C{ set protection flag (\&{outer}, %
\&{inner}) }\6
\\{mp\_show\_command}${},{}$\C{ diagnostic output (\&{show}, \&{showvariable},
etc.) }\6
\\{mp\_mode\_command}${},{}$\C{ set interaction level (\&{batchmode}, etc.) }\6
\\{mp\_random\_seed}${},{}$\C{ initialize random number generator (%
\&{randomseed}) }\6
\\{mp\_message\_command}${},{}$\C{ communicate to user (\&{message}, %
\&{errmessage}) }\6
\\{mp\_every\_job\_command}${},{}$\C{ designate a starting token (\&{everyjob})
}\6
\\{mp\_delimiters}${},{}$\C{ define a pair of delimiters (\&{delimiters}) }\6
\\{mp\_special\_command}${},{}$\C{ output special info (\&{special})
            or font map info (\&{fontmapfile}, \&{fontmapline}) }\6
\\{mp\_write\_command}${},{}$\C{ write text to a file (\&{write}) }\6
\\{mp\_type\_name}${},{}$\C{ declare a type (\&{numeric}, \&{pair}, etc.) }\6
\\{mp\_left\_delimiter}${},{}$\C{ the left delimiter of a matching pair }\6
\\{mp\_begin\_group}${},{}$\C{ beginning of a group (\&{begingroup}) }\6
\\{mp\_nullary}${},{}$\C{ an operator without arguments (e.g., %
\&{normaldeviate}) }\6
\\{mp\_unary}${},{}$\C{ an operator with one argument (e.g., \&{sqrt}) }\6
\\{mp\_str\_op}${},{}$\C{ convert a suffix to a string (\&{str}) }\6
\\{mp\_cycle}${},{}$\C{ close a cyclic path (\&{cycle}) }\6
\\{mp\_primary\_binary}${},{}$\C{ binary operation taking `\&{of}' (e.g., %
\&{point}) }\6
\\{mp\_capsule\_token}${},{}$\C{ a value that has been put into a token list }\6
\\{mp\_string\_token}${},{}$\C{ a string constant (e.g., \PB{\.{"hello"}}) }\6
\\{mp\_internal\_quantity}${},{}$\C{ internal numeric parameter (e.g., %
\&{pausing}) }\6
\\{mp\_tag\_token}${},{}$\C{ a symbolic token without a primitive meaning }\6
\\{mp\_numeric\_token}${},{}$\C{ a numeric constant (e.g., \.{3.14159}) }\6
\\{mp\_plus\_or\_minus}${},{}$\C{ either `\.+' or `\.-' }\6
\\{mp\_tertiary\_secondary\_macro}${},{}$\C{ a macro defined by %
\&{secondarydef} }\6
\\{mp\_tertiary\_binary}${},{}$\C{ an operator at the tertiary level (e.g., `%
\.{++}') }\6
\\{mp\_left\_brace}${},{}$\C{ the operator `\.{\char`\{}' }\6
\\{mp\_path\_join}${},{}$\C{ the operator `\.{..}' }\6
\\{mp\_ampersand}${},{}$\C{ the operator `\.\&' }\6
\\{mp\_expression\_tertiary\_macro}${},{}$\C{ a macro defined by %
\&{tertiarydef} }\6
\\{mp\_expression\_binary}${},{}$\C{ an operator at the expression level (e.g.,
`\.<') }\6
\\{mp\_equals}${},{}$\C{ the operator `\.=' }\6
\\{mp\_and\_command}${},{}$\C{ the operator `\&{and}' }\6
\\{mp\_secondary\_primary\_macro}${},{}$\C{ a macro defined by \&{primarydef} }%
\6
\\{mp\_slash}${},{}$\C{ the operator `\./' }\6
\\{mp\_secondary\_binary}${},{}$\C{ an operator at the binary level (e.g., %
\&{shifted}) }\6
\\{mp\_param\_type}${},{}$\C{ type of parameter (\&{primary}, \&{expr}, %
\&{suffix}, etc.) }\6
\\{mp\_controls}${},{}$\C{ specify control points explicitly (\&{controls}) }\6
\\{mp\_tension}${},{}$\C{ specify tension between knots (\&{tension}) }\6
\\{mp\_at\_least}${},{}$\C{ bounded tension value (\&{atleast}) }\6
\\{mp\_curl\_command}${},{}$\C{ specify curl at an end knot (\&{curl}) }\6
\\{mp\_macro\_special}${},{}$\C{ special macro operators (\&{quote}, \.{\#%
\AT!}, etc.) }\6
\\{mp\_right\_delimiter}${},{}$\C{ the right delimiter of a matching pair }\6
\\{mp\_left\_bracket}${},{}$\C{ the operator `\.[' }\6
\\{mp\_right\_bracket}${},{}$\C{ the operator `\.]' }\6
\\{mp\_right\_brace}${},{}$\C{ the operator `\.{\char`\}}' }\6
\\{mp\_with\_option}${},{}$\C{ option for filling (\&{withpen}, \&{withweight},
etc.) }\6
\\{mp\_thing\_to\_add}${},{}$\C{ variant of \&{addto} (\&{contour}, %
\&{doublepath}, \&{also}) }\6
\\{mp\_of\_token}${},{}$\C{ the operator `\&{of}' }\6
\\{mp\_to\_token}${},{}$\C{ the operator `\&{to}' }\6
\\{mp\_step\_token}${},{}$\C{ the operator `\&{step}' }\6
\\{mp\_until\_token}${},{}$\C{ the operator `\&{until}' }\6
\\{mp\_within\_token}${},{}$\C{ the operator `\&{within}' }\6
\\{mp\_lig\_kern\_token}${},{}$\C{ the operators `\&{kern}' and `\.{=:}' and `%
\.{=:\char'174}', etc. }\6
\\{mp\_assignment}${},{}$\C{ the operator `\.{:=}' }\6
\\{mp\_skip\_to}${},{}$\C{ the operation `\&{skipto}' }\6
\\{mp\_bchar\_label}${},{}$\C{ the operator `\.{\char'174\char'174:}' }\6
\\{mp\_double\_colon}${},{}$\C{ the operator `\.{::}' }\6
\\{mp\_colon}${},{}$\C{ the operator `\.:' }\7
\\{mp\_comma}${},{}$\C{ the operator `\.,', must be \PB{$\\{colon}+\T{1}$} }\6
\\{mp\_semicolon}${},{}$\C{ the operator `\.;', must be \PB{$\\{comma}+\T{1}$}
}\6
\\{mp\_end\_group}${},{}$\C{ end a group (\&{endgroup}), must be \PB{$%
\\{semicolon}+\T{1}$} }\6
\\{mp\_stop}${},{}$\C{ end a job (\&{end}, \&{dump}), must be \PB{$\\{end%
\_group}+\T{1}$} }\6
\\{mp\_outer\_tag}${},{}$\C{ protection code added to command code }\6
\\{mp\_undefined\_cs} $,{}$\C{ protection code added to command code }\6
$\}$ \\{mp\_command\_code};\par
\As186\ET189.
\U4.\fi

\M{186}Variables and capsules in \MP\ have a variety of ``types,''
distinguished by the code numbers defined here. These numbers are also
not completely arbitrary.  Things that get expanded must have types
\PB{$>$ \\{mp\_independent}}; a type remaining after expansion is numeric if
and only if
its code number is at least \PB{\\{numeric\_type}}; objects containing numeric
parts must have types between \PB{\\{transform\_type}} and \PB{\\{pair\_type}};
all other types must be smaller than \PB{\\{transform\_type}}; and among the
types
that are not unknown or vacuous, the smallest two must be \PB{\\{boolean%
\_type}}
and \PB{\\{string\_type}} in that order.

\Y\B\4\D$\\{unknown\_tag}$ \5
\T{1}\C{ this constant is added to certain type codes below }\par
\B\4\D$\\{unknown\_types}$ \5
\\{mp\_unknown\_boolean}:\5
\&{case} \\{mp\_unknown\_string}:\5
\&{case} \\{mp\_unknown\_pen}:\5
\&{case} \\{mp\_unknown\_picture}: \&{case} \\{mp\_unknown\_path}\par
\Y\B\4\X185:Enumeration types\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{$ $\\{mp\_undefined}\K\T{0},{}$\C{ no type has been
declared }\6
\\{mp\_vacuous}${},{}$\C{ no expression was present }\6
\\{mp\_boolean\_type}${},{}$\C{ \&{boolean} with a known value }\6
\\{mp\_unknown\_boolean}${},\39\\{mp\_string\_type},{}$\C{ \&{string} with a
known value }\6
\\{mp\_unknown\_string}${},\39\\{mp\_pen\_type},{}$\C{ \&{pen} with a known
value }\6
\\{mp\_unknown\_pen}${},\39\\{mp\_path\_type},{}$\C{ \&{path} with a known
value }\6
\\{mp\_unknown\_path}${},\39\\{mp\_picture\_type},{}$\C{ \&{picture} with a
known value }\6
\\{mp\_unknown\_picture}${},\39\\{mp\_transform\_type},{}$\C{ \&{transform}
variable or capsule }\6
\\{mp\_color\_type}${},{}$\C{ \&{color} variable or capsule }\6
\\{mp\_cmykcolor\_type}${},{}$\C{ \&{cmykcolor} variable or capsule }\6
\\{mp\_pair\_type}${},{}$\C{ \&{pair} variable or capsule }\6
\\{mp\_numeric\_type}${},{}$\C{ variable that has been declared \&{numeric} but
not used }\6
\\{mp\_known}${},{}$\C{ \&{numeric} with a known value }\6
\\{mp\_dependent}${},{}$\C{ a linear combination with \PB{\\{fraction}}
coefficients }\6
\\{mp\_proto\_dependent}${},{}$\C{ a linear combination with \PB{\\{scaled}}
coefficients }\6
\\{mp\_independent}${},{}$\C{ \&{numeric} with unknown value }\6
\\{mp\_token\_list}${},{}$\C{ variable name or suffix argument or text argument
}\6
\\{mp\_structured}${},{}$\C{ variable with subscripts and attributes }\6
\\{mp\_unsuffixed\_macro}${},{}$\C{ variable defined with \&{vardef} but no \.{%
\AT!\#} }\6
\\{mp\_suffixed\_macro}${},{}$\C{ variable defined with \&{vardef} and \.{\AT!%
\#} }\C{ here are some generic node types }\6
\\{mp\_symbol\_node}${},\39\\{mp\_token\_node\_type},\39\\{mp\_value\_node%
\_type},\39\\{mp\_attr\_node\_type},\39\\{mp\_subscr\_node\_type},\39\\{mp%
\_pair\_node\_type},\39\\{mp\_transform\_node\_type},\39\\{mp\_color\_node%
\_type},\39\\{mp\_cmykcolor\_node\_type},{}$\C{ it is important that the next 7
items remain in this order, for export }\6
\\{mp\_fill\_node\_type}${},\39\\{mp\_stroked\_node\_type},\39\\{mp\_text\_node%
\_type},\39\\{mp\_start\_clip\_node\_type},\39\\{mp\_start\_bounds\_node%
\_type},\39\\{mp\_stop\_clip\_node\_type},\39\\{mp\_stop\_bounds\_node\_type},%
\39\\{mp\_dash\_node\_type},\39\\{mp\_dep\_node\_type},\39\\{mp\_if\_node%
\_type},\39\\{mp\_edge\_header\_node\_type}$ $,$ $\}$ \\{mp\_variable\_type};%
\par
\fi

\M{187}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_type}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|t);\par
\fi

\M{188}\B\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{char} ${}{*}{}$\\{mp\_type\_string}(\&{quarterword} %
\|t)\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\|s\K\NULL;{}$\7
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_undefined}:\5
${}\|s\K\.{"undefined"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_vacuous}:\5
${}\|s\K\.{"vacuous"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_boolean\_type}:\5
${}\|s\K\.{"boolean"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_boolean}:\5
${}\|s\K\.{"unknown\ boolean"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
${}\|s\K\.{"string"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_string}:\5
${}\|s\K\.{"unknown\ string"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
${}\|s\K\.{"pen"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_pen}:\5
${}\|s\K\.{"unknown\ pen"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\|s\K\.{"path"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_path}:\5
${}\|s\K\.{"unknown\ path"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
${}\|s\K\.{"picture"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_picture}:\5
${}\|s\K\.{"unknown\ picture"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\|s\K\.{"transform"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\|s\K\.{"color"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|s\K\.{"cmykcolor"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\|s\K\.{"pair"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_known}:\5
${}\|s\K\.{"known\ numeric"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_dependent}:\5
${}\|s\K\.{"dependent"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_proto\_dependent}:\5
${}\|s\K\.{"proto-dependent"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_numeric\_type}:\5
${}\|s\K\.{"numeric"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\|s\K\.{"independent"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_token\_list}:\5
${}\|s\K\.{"token\ list"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_structured}:\5
${}\|s\K\.{"mp\_structured"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_unsuffixed\_macro}:\5
${}\|s\K\.{"unsuffixed\ macro"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_suffixed\_macro}:\5
${}\|s\K\.{"suffixed\ macro"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_symbol\_node}:\5
${}\|s\K\.{"symbol\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_token\_node\_type}:\5
${}\|s\K\.{"token\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_value\_node\_type}:\5
${}\|s\K\.{"value\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_attr\_node\_type}:\5
${}\|s\K\.{"attribute\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_subscr\_node\_type}:\5
${}\|s\K\.{"subscript\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_pair\_node\_type}:\5
${}\|s\K\.{"pair\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_node\_type}:\5
${}\|s\K\.{"transform\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_node\_type}:\5
${}\|s\K\.{"color\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_node\_type}:\5
${}\|s\K\.{"cmykcolor\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\|s\K\.{"fill\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\|s\K\.{"stroked\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_text\_node\_type}:\5
${}\|s\K\.{"text\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\|s\K\.{"start\ clip\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\|s\K\.{"start\ bounds\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
${}\|s\K\.{"stop\ clip\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
${}\|s\K\.{"stop\ bounds\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_dash\_node\_type}:\5
${}\|s\K\.{"dash\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_dep\_node\_type}:\5
${}\|s\K\.{"dependency\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_if\_node\_type}:\5
${}\|s\K\.{"if\ node"};{}$\6
\&{break};\6
\4\&{case} \\{mp\_edge\_header\_node\_type}:\5
${}\|s\K\.{"edge\ header\ node"};{}$\6
\&{break};\6
\4\&{default}:\6
${}\{{}$\1\6
\&{char} \\{ss}[\T{256}];\7
${}\\{mp\_snprintf}(\\{ss},\39\T{256},\39\.{"<unknown\ type\ \%d>"},\39\|t);{}$%
\6
${}\|s\K\\{strdup}(\\{ss});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4${}\}{}$\2\6
\&{return} \|s;\6
\4${}\}{}$\2\7
\&{void} \\{mp\_print\_type}(\&{MP} \\{mp}${},\39{}$\&{quarterword} \|t)\1\1\2%
\2\6
${}\{{}$\1\6
\&{if} ${}(\|t\G\T{0}\W\|t\Z\\{mp\_edge\_header\_node\_type}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\\{mp\_type\_string}(\|t));{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"unknown"});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{189}Values inside \MP\ are stored in non-symbolic nodes that have a \PB{%
\\{name\_type}}
as well as a \PB{\\{type}}. The possibilities for \PB{\\{name\_type}} are
defined
here; they will be explained in more detail later.

\Y\B\4\X185:Enumeration types\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{mp\_root}\K\T{0},{}$\C{ \PB{\\{name\_type}} at the top level of a
variable }\6
\\{mp\_saved\_root}${},{}$\C{ same, when the variable has been saved }\6
\\{mp\_structured\_root}${},{}$\C{ \PB{\\{name\_type}} where a \PB{\\{mp%
\_structured}} branch occurs }\6
\\{mp\_subscr}${},{}$\C{ \PB{\\{name\_type}} in a subscript node }\6
\\{mp\_attr}${},{}$\C{ \PB{\\{name\_type}} in an attribute node }\6
\\{mp\_x\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{xpart} of a
node }\6
\\{mp\_y\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{ypart} of a
node }\6
\\{mp\_xx\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{xxpart} of a
node }\6
\\{mp\_xy\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{xypart} of a
node }\6
\\{mp\_yx\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{yxpart} of a
node }\6
\\{mp\_yy\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{yypart} of a
node }\6
\\{mp\_red\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{redpart} of a
node }\6
\\{mp\_green\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{greenpart}
of a node }\6
\\{mp\_blue\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{bluepart} of
a node }\6
\\{mp\_cyan\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{redpart} of
a node }\6
\\{mp\_magenta\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the %
\&{greenpart} of a node }\6
\\{mp\_yellow\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{bluepart}
of a node }\6
\\{mp\_black\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{greenpart}
of a node }\6
\\{mp\_grey\_part\_sector}${},{}$\C{ \PB{\\{name\_type}} in the \&{bluepart} of
a node }\6
\\{mp\_capsule}${},{}$\C{ \PB{\\{name\_type}} in stashed-away subexpressions }\6
\\{mp\_token}${},{}$\C{ \PB{\\{name\_type}} in a numeric token or string token
}\C{ Symbolic nodes also have \PB{\\{name\_type}}, which is a different
enumeration }\6
\\{mp\_normal\_sym}${},\39\\{mp\_internal\_sym},{}$\C{ for values of internals
}\6
\\{mp\_macro\_sym}${},{}$\C{ for macro names }\6
\\{mp\_expr\_sym}${},{}$\C{ for macro parameters if type \PB{\\{expr}} }\6
\\{mp\_suffix\_sym}${},{}$\C{ for macro parameters if type \PB{\\{suffix}} }\6
\\{mp\_text\_sym}${},{}$\C{ for macro parameters if type \PB{\\{text}} }\6
\X190:Operation codes\X\2\6
${}\}{}$ \&{mp\_name\_type\_type};\par
\fi

\M{190}Primitive operations that produce values have a secondary identification
code in addition to their command code; it's something like genera and species.
For example, `\.*' has the command code \PB{\\{primary\_binary}}, and its
secondary identification is \PB{\\{times}}. The secondary codes start such that
they don't overlap with the type codes; some type codes (e.g., \PB{\\{mp%
\_string\_type}})
are used as operators as well as type identifications.  The relative values
are not critical, except for \PB{$\\{true\_code}\MRL{{.}{.}}\\{false\_code}$}, %
\PB{$\\{or\_op}\MRL{{.}{.}}\\{and\_op}$},
and \PB{$\\{filled\_op}\MRL{{.}{.}}\\{bounded\_op}$}.  The restrictions are
that
\PB{$\\{and\_op}-\\{false\_code}\K\\{or\_op}-\\{true\_code}$}, that the
ordering of
\PB{\\{x\_part} $\,\ldots\,{}$ \\{blue\_part}} must match that of \PB{$\\{x%
\_part\_sector}\MRL{{.}{.}}\\{mp\_blue\_part\_sector}$},
and the ordering of \PB{$\\{filled\_op}\MRL{{.}{.}}\\{bounded\_op}$} must match
that of the code
values they test for.

\Y\B\4\D$\\{mp\_min\_of}$ \5
\\{mp\_substring\_of}\par
\Y\B\4\X190:Operation codes\X${}\E{}$\6
$\\{mp\_true\_code},{}$\C{ operation code for \.{true} }\6
\\{mp\_false\_code}${},{}$\C{ operation code for \.{false} }\6
\\{mp\_null\_picture\_code}${},{}$\C{ operation code for \.{nullpicture} }\6
\\{mp\_null\_pen\_code}${},{}$\C{ operation code for \.{nullpen} }\6
\\{mp\_read\_string\_op}${},{}$\C{ operation code for \.{readstring} }\6
\\{mp\_pen\_circle}${},{}$\C{ operation code for \.{pencircle} }\6
\\{mp\_normal\_deviate}${},{}$\C{ operation code for \.{normaldeviate} }\6
\\{mp\_read\_from\_op}${},{}$\C{ operation code for \.{readfrom} }\6
\\{mp\_close\_from\_op}${},{}$\C{ operation code for \.{closefrom} }\6
\\{mp\_odd\_op}${},{}$\C{ operation code for \.{odd} }\6
\\{mp\_known\_op}${},{}$\C{ operation code for \.{known} }\6
\\{mp\_unknown\_op}${},{}$\C{ operation code for \.{unknown} }\6
\\{mp\_not\_op}${},{}$\C{ operation code for \.{not} }\6
\\{mp\_decimal}${},{}$\C{ operation code for \.{decimal} }\6
\\{mp\_reverse}${},{}$\C{ operation code for \.{reverse} }\6
\\{mp\_make\_path\_op}${},{}$\C{ operation code for \.{makepath} }\6
\\{mp\_make\_pen\_op}${},{}$\C{ operation code for \.{makepen} }\6
\\{mp\_oct\_op}${},{}$\C{ operation code for \.{oct} }\6
\\{mp\_hex\_op}${},{}$\C{ operation code for \.{hex} }\6
\\{mp\_ASCII\_op}${},{}$\C{ operation code for \.{ASCII} }\6
\\{mp\_char\_op}${},{}$\C{ operation code for \.{char} }\6
\\{mp\_length\_op}${},{}$\C{ operation code for \.{length} }\6
\\{mp\_turning\_op}${},{}$\C{ operation code for \.{turningnumber} }\6
\\{mp\_color\_model\_part}${},{}$\C{ operation code for \.{colormodel} }\6
\\{mp\_x\_part}${},{}$\C{ operation code for \.{xpart} }\6
\\{mp\_y\_part}${},{}$\C{ operation code for \.{ypart} }\6
\\{mp\_xx\_part}${},{}$\C{ operation code for \.{xxpart} }\6
\\{mp\_xy\_part}${},{}$\C{ operation code for \.{xypart} }\6
\\{mp\_yx\_part}${},{}$\C{ operation code for \.{yxpart} }\6
\\{mp\_yy\_part}${},{}$\C{ operation code for \.{yypart} }\6
\\{mp\_red\_part}${},{}$\C{ operation code for \.{redpart} }\6
\\{mp\_green\_part}${},{}$\C{ operation code for \.{greenpart} }\6
\\{mp\_blue\_part}${},{}$\C{ operation code for \.{bluepart} }\6
\\{mp\_cyan\_part}${},{}$\C{ operation code for \.{cyanpart} }\6
\\{mp\_magenta\_part}${},{}$\C{ operation code for \.{magentapart} }\6
\\{mp\_yellow\_part}${},{}$\C{ operation code for \.{yellowpart} }\6
\\{mp\_black\_part}${},{}$\C{ operation code for \.{blackpart} }\6
\\{mp\_grey\_part}${},{}$\C{ operation code for \.{greypart} }\6
\\{mp\_font\_part}${},{}$\C{ operation code for \.{fontpart} }\6
\\{mp\_text\_part}${},{}$\C{ operation code for \.{textpart} }\6
\\{mp\_path\_part}${},{}$\C{ operation code for \.{pathpart} }\6
\\{mp\_pen\_part}${},{}$\C{ operation code for \.{penpart} }\6
\\{mp\_dash\_part}${},{}$\C{ operation code for \.{dashpart} }\6
\\{mp\_prescript\_part}${},{}$\C{ operation code for \.{prescriptpart} }\6
\\{mp\_postscript\_part}${},{}$\C{ operation code for \.{postscriptpart} }\6
\\{mp\_sqrt\_op}${},{}$\C{ operation code for \.{sqrt} }\6
\\{mp\_m\_exp\_op}${},{}$\C{ operation code for \.{mexp} }\6
\\{mp\_m\_log\_op}${},{}$\C{ operation code for \.{mlog} }\6
\\{mp\_sin\_d\_op}${},{}$\C{ operation code for \.{sind} }\6
\\{mp\_cos\_d\_op}${},{}$\C{ operation code for \.{cosd} }\6
\\{mp\_floor\_op}${},{}$\C{ operation code for \.{floor} }\6
\\{mp\_uniform\_deviate}${},{}$\C{ operation code for \.{uniformdeviate} }\6
\\{mp\_char\_exists\_op}${},{}$\C{ operation code for \.{charexists} }\6
\\{mp\_font\_size}${},{}$\C{ operation code for \.{fontsize} }\6
\\{mp\_ll\_corner\_op}${},{}$\C{ operation code for \.{llcorner} }\6
\\{mp\_lr\_corner\_op}${},{}$\C{ operation code for \.{lrcorner} }\6
\\{mp\_ul\_corner\_op}${},{}$\C{ operation code for \.{ulcorner} }\6
\\{mp\_ur\_corner\_op}${},{}$\C{ operation code for \.{urcorner} }\6
\\{mp\_arc\_length}${},{}$\C{ operation code for \.{arclength} }\6
\\{mp\_angle\_op}${},{}$\C{ operation code for \.{angle} }\6
\\{mp\_cycle\_op}${},{}$\C{ operation code for \.{cycle} }\6
\\{mp\_filled\_op}${},{}$\C{ operation code for \.{filled} }\6
\\{mp\_stroked\_op}${},{}$\C{ operation code for \.{stroked} }\6
\\{mp\_textual\_op}${},{}$\C{ operation code for \.{textual} }\6
\\{mp\_clipped\_op}${},{}$\C{ operation code for \.{clipped} }\6
\\{mp\_bounded\_op}${},{}$\C{ operation code for \.{bounded} }\6
\\{mp\_plus}${},{}$\C{ operation code for \.+ }\6
\\{mp\_minus}${},{}$\C{ operation code for \.- }\6
\\{mp\_times}${},{}$\C{ operation code for \.* }\6
\\{mp\_over}${},{}$\C{ operation code for \./ }\6
\\{mp\_pythag\_add}${},{}$\C{ operation code for \.{++} }\6
\\{mp\_pythag\_sub}${},{}$\C{ operation code for \.{+-+} }\6
\\{mp\_or\_op}${},{}$\C{ operation code for \.{or} }\6
\\{mp\_and\_op}${},{}$\C{ operation code for \.{and} }\6
\\{mp\_less\_than}${},{}$\C{ operation code for \.< }\6
\\{mp\_less\_or\_equal}${},{}$\C{ operation code for \.{<=} }\6
\\{mp\_greater\_than}${},{}$\C{ operation code for \.> }\6
\\{mp\_greater\_or\_equal}${},{}$\C{ operation code for \.{>=} }\6
\\{mp\_equal\_to}${},{}$\C{ operation code for \.= }\6
\\{mp\_unequal\_to}${},{}$\C{ operation code for \.{<>} }\6
\\{mp\_concatenate}${},{}$\C{ operation code for \.\& }\6
\\{mp\_rotated\_by}${},{}$\C{ operation code for \.{rotated} }\6
\\{mp\_slanted\_by}${},{}$\C{ operation code for \.{slanted} }\6
\\{mp\_scaled\_by}${},{}$\C{ operation code for \.{scaled} }\6
\\{mp\_shifted\_by}${},{}$\C{ operation code for \.{shifted} }\6
\\{mp\_transformed\_by}${},{}$\C{ operation code for \.{transformed} }\6
\\{mp\_x\_scaled}${},{}$\C{ operation code for \.{xscaled} }\6
\\{mp\_y\_scaled}${},{}$\C{ operation code for \.{yscaled} }\6
\\{mp\_z\_scaled}${},{}$\C{ operation code for \.{zscaled} }\6
\\{mp\_in\_font}${},{}$\C{ operation code for \.{infont} }\6
\\{mp\_intersect}${},{}$\C{ operation code for \.{intersectiontimes} }\6
\\{mp\_double\_dot}${},{}$\C{ operation code for improper \.{..} }\6
\\{mp\_substring\_of}${},{}$\C{ operation code for \.{substring} }\6
\\{mp\_subpath\_of}${},{}$\C{ operation code for \.{subpath} }\6
\\{mp\_direction\_time\_of}${},{}$\C{ operation code for \.{directiontime} }\6
\\{mp\_point\_of}${},{}$\C{ operation code for \.{point} }\6
\\{mp\_precontrol\_of}${},{}$\C{ operation code for \.{precontrol} }\6
\\{mp\_postcontrol\_of}${},{}$\C{ operation code for \.{postcontrol} }\6
\\{mp\_pen\_offset\_of}${},{}$\C{ operation code for \.{penoffset} }\6
\\{mp\_arc\_time\_of}${},{}$\C{ operation code for \.{arctime} }\6
\\{mp\_version}${},{}$\C{ operation code for \.{mpversion} }\6
\\{mp\_envelope\_of}${},{}$\C{ operation code for \.{envelope} }\6
\\{mp\_glyph\_infont}${},{}$\C{ operation code for \.{glyph} }\6
\\{mp\_kern\_flag}\C{ operation code for \.{kern} }\par
\U189.\fi

\M{191}\B\&{static} \&{void} \\{mp\_print\_op}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|c\Z\\{mp\_numeric\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_type}(\\{mp},\39\|c);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_true\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"true"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_false\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"false"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_null\_picture\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"nullpicture"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_null\_pen\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"nullpen"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_read\_string\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"readstring"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_circle}:\5
${}\\{mp\_print}(\\{mp},\39\.{"pencircle"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_normal\_deviate}:\5
${}\\{mp\_print}(\\{mp},\39\.{"normaldeviate"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_read\_from\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"readfrom"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_close\_from\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"closefrom"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_odd\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"odd"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_known\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"known"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_unknown\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"unknown"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_not\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"not"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_decimal}:\5
${}\\{mp\_print}(\\{mp},\39\.{"decimal"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_reverse}:\5
${}\\{mp\_print}(\\{mp},\39\.{"reverse"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_make\_path\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"makepath"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_make\_pen\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"makepen"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_oct\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"oct"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_hex\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"hex"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_ASCII\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"ASCII"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_char\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"char"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_length\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"length"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_turning\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"turningnumber"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_x\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_y\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"ypart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xxpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xy\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xypart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yx\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yxpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yy\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yypart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_red\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"redpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_green\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"greenpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_blue\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"bluepart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"cyanpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_magenta\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"magentapart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yellow\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yellowpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_black\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"blackpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_grey\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"greypart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_model\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"colormodel"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_font\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"fontpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_text\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"textpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_prescript\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"prescriptpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_postscript\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"postscriptpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"pathpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"penpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_dash\_part}:\5
${}\\{mp\_print}(\\{mp},\39\.{"dashpart"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_sqrt\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"sqrt"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_m\_exp\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"mexp"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_m\_log\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"mlog"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_sin\_d\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"sind"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cos\_d\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"cosd"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_floor\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"floor"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_uniform\_deviate}:\5
${}\\{mp\_print}(\\{mp},\39\.{"uniformdeviate"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_char\_exists\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"charexists"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_font\_size}:\5
${}\\{mp\_print}(\\{mp},\39\.{"fontsize"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_ll\_corner\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"llcorner"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_lr\_corner\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"lrcorner"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_ul\_corner\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"ulcorner"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_ur\_corner\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"urcorner"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_arc\_length}:\5
${}\\{mp\_print}(\\{mp},\39\.{"arclength"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_angle\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"angle"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cycle\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"cycle"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_filled\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"filled"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"stroked"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_textual\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"textual"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_clipped\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"clipped"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_bounded\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"bounded"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_plus}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'+'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_minus}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'-'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_times}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'*'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_over}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'/'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_pythag\_add}:\5
${}\\{mp\_print}(\\{mp},\39\.{"++"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pythag\_sub}:\5
${}\\{mp\_print}(\\{mp},\39\.{"+-+"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_or\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"or"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_and\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"and"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_less\_than}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'<'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_less\_or\_equal}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<="});{}$\6
\&{break};\6
\4\&{case} \\{mp\_greater\_than}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'>'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_greater\_or\_equal}:\5
${}\\{mp\_print}(\\{mp},\39\.{">="});{}$\6
\&{break};\6
\4\&{case} \\{mp\_equal\_to}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_unequal\_to}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<>"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_concatenate}:\5
${}\\{mp\_print}(\\{mp},\39\.{"\&"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_rotated\_by}:\5
${}\\{mp\_print}(\\{mp},\39\.{"rotated"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_slanted\_by}:\5
${}\\{mp\_print}(\\{mp},\39\.{"slanted"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_scaled\_by}:\5
${}\\{mp\_print}(\\{mp},\39\.{"scaled"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_shifted\_by}:\5
${}\\{mp\_print}(\\{mp},\39\.{"shifted"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_transformed\_by}:\5
${}\\{mp\_print}(\\{mp},\39\.{"transformed"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_x\_scaled}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xscaled"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_y\_scaled}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yscaled"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_z\_scaled}:\5
${}\\{mp\_print}(\\{mp},\39\.{"zscaled"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_in\_font}:\5
${}\\{mp\_print}(\\{mp},\39\.{"infont"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_intersect}:\5
${}\\{mp\_print}(\\{mp},\39\.{"intersectiontimes"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_substring\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"substring"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_subpath\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"subpath"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_direction\_time\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"directiontime"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_point\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"point"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_precontrol\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"precontrol"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_postcontrol\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"postcontrol"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_offset\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"penoffset"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_arc\_time\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"arctime"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_version}:\5
${}\\{mp\_print}(\\{mp},\39\.{"mpversion"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_envelope\_of}:\5
${}\\{mp\_print}(\\{mp},\39\.{"envelope"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_glyph\_infont}:\5
${}\\{mp\_print}(\\{mp},\39\.{"glyph"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{".."});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{192}\MP\ also has a bunch of internal parameters that a user might want to
fuss with. Every such parameter has an identifying code number, defined here.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_given\_internal} ${}\{$ $\\{mp\_output\_template}\K\T{1},{}$\C{
a string set up by \&{outputtemplate} }\6
\\{mp\_output\_filename}${},{}$\C{ the output file name, accessible as %
\&{outputfilename} }\6
\\{mp\_output\_format}${},{}$\C{ the output format set up by \&{outputformat} }%
\6
\\{mp\_output\_format\_options}${},{}$\C{ the output format options set up by %
\&{outputformatoptions} }\6
\\{mp\_number\_system}${},{}$\C{ the number system as set up by %
\&{numbersystem} }\6
\\{mp\_number\_precision}${},{}$\C{ the number system precision as set up by %
\&{numberprecision} }\6
\\{mp\_job\_name}${},{}$\C{ the perceived jobname, as set up from the options
stucture,                                    the name of the input file, or by %
\&{jobname}  }\6
\\{mp\_tracing\_titles}${},{}$\C{ show titles online when they appear }\6
\\{mp\_tracing\_equations}${},{}$\C{ show each variable when it becomes known }%
\6
\\{mp\_tracing\_capsules}${},{}$\C{ show capsules too }\6
\\{mp\_tracing\_choices}${},{}$\C{ show the control points chosen for paths }\6
\\{mp\_tracing\_specs}${},{}$\C{ show path subdivision prior to filling with
polygonal a pen }\6
\\{mp\_tracing\_commands}${},{}$\C{ show commands and operations before they
are performed }\6
\\{mp\_tracing\_restores}${},{}$\C{ show when a variable or internal is
restored }\6
\\{mp\_tracing\_macros}${},{}$\C{ show macros before they are expanded }\6
\\{mp\_tracing\_output}${},{}$\C{ show digitized edges as they are output }\6
\\{mp\_tracing\_stats}${},{}$\C{ show memory usage at end of job }\6
\\{mp\_tracing\_lost\_chars}${},{}$\C{ show characters that aren't \&{infont} }%
\6
\\{mp\_tracing\_online}${},{}$\C{ show long diagnostics on terminal and in the
log file }\6
\\{mp\_year}${},{}$\C{ the current year (e.g., 1984) }\6
\\{mp\_month}${},{}$\C{ the current month (e.g., 3 $\equiv$ March) }\6
\\{mp\_day}${},{}$\C{ the current day of the month }\6
\\{mp\_time}${},{}$\C{ the number of minutes past midnight when this job
started }\6
\\{mp\_hour}${},{}$\C{ the number of hours past midnight when this job started
}\6
\\{mp\_minute}${},{}$\C{ the number of minutes in that hour when this job
started }\6
\\{mp\_char\_code}${},{}$\C{ the number of the next character to be output }\6
\\{mp\_char\_ext}${},{}$\C{ the extension code of the next character to be
output }\6
\\{mp\_char\_wd}${},{}$\C{ the width of the next character to be output }\6
\\{mp\_char\_ht}${},{}$\C{ the height of the next character to be output }\6
\\{mp\_char\_dp}${},{}$\C{ the depth of the next character to be output }\6
\\{mp\_char\_ic}${},{}$\C{ the italic correction of the next character to be
output }\6
\\{mp\_design\_size}${},{}$\C{ the unit of measure used for \PB{$\\{mp\_char%
\_wd}\MRL{{.}{.}}\\{mp\_char\_ic}$}, in points }\6
\\{mp\_pausing}${},{}$\C{ positive to display lines on the terminal before they
are read }\6
\\{mp\_showstopping}${},{}$\C{ positive to stop after each \&{show} command }\6
\\{mp\_fontmaking}${},{}$\C{ positive if font metric output is to be produced }%
\6
\\{mp\_linejoin}${},{}$\C{ as in \ps: 0 for mitered, 1 for round, 2 for beveled
}\6
\\{mp\_linecap}${},{}$\C{ as in \ps: 0 for butt, 1 for round, 2 for square }\6
\\{mp\_miterlimit}${},{}$\C{ controls miter length as in \ps }\6
\\{mp\_warning\_check}${},{}$\C{ controls error message when variable value is
large }\6
\\{mp\_boundary\_char}${},{}$\C{ the right boundary character for ligatures }\6
\\{mp\_prologues}${},{}$\C{ positive to output conforming PostScript using
built-in fonts }\6
\\{mp\_true\_corners}${},{}$\C{ positive to make \&{llcorner} etc. ignore %
\&{setbounds} }\6
\\{mp\_default\_color\_model}${},{}$\C{ the default color model for unspecified
items }\6
\\{mp\_restore\_clip\_color}${},\39\\{mp\_procset},{}$\C{ wether or not create
PostScript command shortcuts }\6
\\{mp\_hppp}${},{}$\C{ horizontal pixels per point (for png output) }\6
\\{mp\_vppp}${},{}$\C{ vertical pixels per point (for png output) }\6
\\{mp\_gtroffmode} $,{}$\C{ whether the user specified \PB{${-}\\{troff}$} on
the command line }\6
$\}$  ;\7
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{mp\_value} \|v;\6
\&{char} ${}{*}\\{intname};{}$\2\6
${}\}{}$ \&{mp\_internal};\par
\fi

\M{193}\B\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} ${}\\{internal\_value}(\|A)\\{mp}\MG\\{internal}[(\|A)].\|v.%
\\{data}.\|n{}$\6
\8\#\&{define} $\\{set\_internal\_from\_number}(\|A,\39\|B)$ \&{do} \6
${}\{{}$\1\6
${}\\{number\_clone}(\\{internal\_value}((\|A)),\39(\|B));{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0}) \6
\8\#\&{define} ${}\\{internal\_string}(\|A)(\&{mp\_string})\\{mp}\MG%
\\{internal}[(\|A)].\|v.\\{data}.\\{str}{}$\6
\8\#\&{define} ${}\\{set\_internal\_string}(\|A,\39\|B)\\{mp}\MG\\{internal}[(%
\|A)].\|v.\\{data}.\\{str}\K(\|B){}$\6
\8\#\&{define} ${}\\{internal\_name}(\|A)\\{mp}\MG\\{internal}[(\|A)].%
\\{intname}{}$\6
\8\#\&{define} ${}\\{set\_internal\_name}(\|A,\39\|B)\\{mp}\MG\\{internal}[(%
\|A)].\\{intname}\K(\|B){}$\6
\8\#\&{define} ${}\\{internal\_type}(\|A)(\\{mp\_variable\_type})\\{mp}\MG%
\\{internal}[(\|A)].\|v.\\{type}{}$\6
\8\#\&{define} ${}\\{set\_internal\_type}(\|A,\39\|B)\\{mp}\MG\\{internal}[(%
\|A)].\|v.\\{type}\K(\|B){}$\6
\8\#\&{define} \\{set\_internal\_from\_cur\_exp}(\|A) \&{do} \6
${}\{{}$\1\6
\&{if} ${}(\\{internal\_type}((\|A))\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\\{add\_str\_ref}(\\{cur\_exp\_str}(\,));\6
${}\\{set\_internal\_string}((\|A),\39\\{cur\_exp\_str}(\,));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_internal\_from\_number}((\|A),\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0}) \par
\fi

\M{194}

\Y\B\4\D$\\{max\_given\_internal}$ \5
\\{mp\_gtroffmode}\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_internal} ${}{*}\\{internal}{}$;\C{ the values of internal quantities }\6
\&{int} \\{int\_ptr};\C{ the maximum internal quantity defined so far }\6
\&{int} \\{max\_internal};\C{ current maximum number of internal quantities }%
\par
\fi

\M{195}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{int} \\{troff\_mode};\par
\fi

\M{196}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{max\_internal}\K\T{2}*\\{max\_given\_internal};{}$\6
${}\\{mp}\MG\\{internal}\K\\{xmalloc}((\\{mp}\MG\\{max\_internal}+\T{1}),\39%
\&{sizeof}(\&{mp\_internal}));{}$\6
${}\\{memset}(\\{mp}\MG\\{internal},\39\T{0},\39(\&{size\_t})(\\{mp}\MG\\{max%
\_internal}+\T{1})*\&{sizeof}(\&{mp\_internal}));{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{1};{}$ ${}\|i\Z\\{mp}\MG\\{max\_internal};{}$ ${}\|i\PP){}$%
\5
${}\{{}$\1\6
${}\\{new\_number}(\\{mp}\MG\\{internal}[\|i].\|v.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|i\K\T{1};{}$ ${}\|i\Z\\{max\_given\_internal};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_type}(\|i,\39\\{mp\_known});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{set\_internal\_type}(\\{mp\_output\_format},\39\\{mp\_string\_type});{}$\6
${}\\{set\_internal\_type}(\\{mp\_output\_filename},\39\\{mp\_string%
\_type});{}$\6
${}\\{set\_internal\_type}(\\{mp\_output\_format\_options},\39\\{mp\_string%
\_type});{}$\6
${}\\{set\_internal\_type}(\\{mp\_output\_template},\39\\{mp\_string%
\_type});{}$\6
${}\\{set\_internal\_type}(\\{mp\_number\_system},\39\\{mp\_string\_type});{}$\6
${}\\{set\_internal\_type}(\\{mp\_job\_name},\39\\{mp\_string\_type});{}$\6
${}\\{mp}\MG\\{troff\_mode}\K(\\{opt}\MG\\{troff\_mode}>\T{0}\?\\{true}:%
\\{false}){}$;\par
\fi

\M{197}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{int} \\{mp\_troff\_mode}(\&{MP} \\{mp});\par
\fi

\M{198}\B\&{int} \\{mp\_troff\_mode}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{mp}${}\MG\\{troff\_mode};{}$\6
\4${}\}{}$\2\par
\fi

\M{199}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{int\_ptr}\K\\{max\_given\_internal}{}$;\par
\fi

\M{200}The symbolic names for internal quantities are put into \MP's hash table
by using a routine called \PB{\\{primitive}}, which will be defined later. Let
us
enter them now, so that we don't have to list all those names again
anywhere else.

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"tracingtitles"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_tracing\_titles});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingequations"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_equations});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingcapsules"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_capsules});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingchoices"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_choices});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingspecs"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_specs});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingcommands"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_commands});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingrestores"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_restores});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingmacros"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_macros});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingoutput"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_output});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingstats"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_stats});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracinglostchars"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_lost\_chars});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tracingonline"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_tracing\_online});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"year"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_year});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"month"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_month});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"day"},\39\\{mp\_internal\_quantity},\39\\{mp%
\_day});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"time"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_time});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"hour"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_hour});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"minute"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_minute});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charcode"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charext"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_ext});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charwd"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_wd});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charht"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_ht});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"chardp"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_dp});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charic"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_char\_ic});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"designsize"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_design\_size});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"pausing"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_pausing});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"showstopping"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_showstopping});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontmaking"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_fontmaking});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"linejoin"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_linejoin});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"linecap"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_linecap});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"miterlimit"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_miterlimit});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"warningcheck"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_warning\_check});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"boundarychar"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_boundary\_char});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"prologues"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_prologues});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"truecorners"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_true\_corners});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"mpprocset"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_procset});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"troffmode"},\39\\{mp\_internal\_quantity},%
\39\\{mp\_gtroffmode});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"defaultcolormodel"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_default\_color\_model});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"restoreclipcolor"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_restore\_clip\_color});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"outputtemplate"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_output\_template});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"outputfilename"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_output\_filename});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"numbersystem"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_number\_system});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"numberprecision"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_number\_precision});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"outputformat"},\39\\{mp\_internal%
\_quantity},\39\\{mp\_output\_format});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"outputformatoptions}\)\.{"},\39\\{mp%
\_internal\_quantity},\39\\{mp\_output\_format\_options});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"jobname"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_job\_name});{}$\6
${}\\{mp\_primitive}(\\{mp},\39\.{"hppp"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_hppp});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"vppp"},\39\\{mp\_internal\_quantity},\39%
\\{mp\_vppp});{}$\6
;\par
\As232, 735, 745, 753, 759, 771, 809, 955, 1046, 1071, 1078, 1081, 1099, 1122,
1128, 1143, 1175\ETs1185.
\U1297.\fi

\M{201}Colors can be specified in four color models. In the special
case of \PB{\\{no\_model}}, MetaPost does not output any color operator to
the postscript output.

Note: these values are passed directly on to \PB{\\{with\_option}}. This only
works because the other possible values passed to \PB{\\{with\_option}} are
8 and 10 respectively (from \PB{\\{with\_pen}} and \PB{\\{with\_picture}}).

There is a first state, that is only used for \PB{\\{gs\_colormodel}}. It flags
the fact that there has not been any kind of color specification by
the user so far in the game.

\Y\B\4\X201:MPlib header stuff\X${}\E{}$\6
\&{enum} \&{mp\_color\_model} ${}\{{}$\1\6
${}\\{mp\_no\_model}\K\T{1},\39\\{mp\_grey\_model}\K\T{3},\39\\{mp\_rgb\_model}%
\K\T{5},\39\\{mp\_cmyk\_model}\K\T{7},\39\\{mp\_uninitialized\_model}\K\T{9}{}$%
\2\6
${}\}{}$;\par
\As299\ET457.
\U3.\fi

\M{202}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{set\_internal\_from\_number}(\\{mp\_default\_color\_model},\39\\{unity%
\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_default\_color%
\_model}),\39\\{mp\_rgb\_model});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_restore\_clip\_color}),\39%
\\{unity\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_hppp}),\39\\{unity\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_vppp}),\39\\{unity\_t});{}$\6
${}\\{set\_internal\_string}(\\{mp\_output\_template},\39\\{mp\_intern}(\\{mp},%
\39\.{"\%j.\%c"}));{}$\6
${}\\{set\_internal\_string}(\\{mp\_output\_filename},\39\\{mp\_intern}(\\{mp},%
\39\.{""}));{}$\6
${}\\{set\_internal\_string}(\\{mp\_output\_format},\39\\{mp\_intern}(\\{mp},%
\39\.{"eps"}));{}$\6
${}\\{set\_internal\_string}(\\{mp\_output\_format\_options},\39\\{mp\_intern}(%
\\{mp},\39\.{""}));{}$\6
${}\\{set\_internal\_string}(\\{mp\_number\_system},\39\\{mp\_intern}(\\{mp},%
\39\.{"scaled"}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_number\_precision},\39\\{precision%
\_default});{}$\6
\8\#\&{if} \.{DEBUG}\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_titles}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_equations}),\39%
\\{three\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_capsules}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_choices}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_specs}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_commands}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_restores}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_macros}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_output}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_stats}),\39\\{three%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_lost\_chars}),\39%
\\{three\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_tracing\_online}),\39\\{three%
\_t});{}$\6
\8\#\&{endif}\par
\fi

\M{203}Well, we do have to list the names one more time, for use in symbolic
printouts.

\Y\B\4\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{set\_internal\_name}(\\{mp\_tracing\_titles},\39\\{xstrdup}(%
\.{"tracingtitles"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_equations},\39\\{xstrdup}(%
\.{"tracingequations"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_capsules},\39\\{xstrdup}(%
\.{"tracingcapsules"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_choices},\39\\{xstrdup}(%
\.{"tracingchoices"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_specs},\39\\{xstrdup}(%
\.{"tracingspecs"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_commands},\39\\{xstrdup}(%
\.{"tracingcommands"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_restores},\39\\{xstrdup}(%
\.{"tracingrestores"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_macros},\39\\{xstrdup}(%
\.{"tracingmacros"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_output},\39\\{xstrdup}(%
\.{"tracingoutput"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_stats},\39\\{xstrdup}(%
\.{"tracingstats"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_lost\_chars},\39\\{xstrdup}(%
\.{"tracinglostchars"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_tracing\_online},\39\\{xstrdup}(%
\.{"tracingonline"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_year},\39\\{xstrdup}(\.{"year"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_month},\39\\{xstrdup}(\.{"month"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_day},\39\\{xstrdup}(\.{"day"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_time},\39\\{xstrdup}(\.{"time"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_hour},\39\\{xstrdup}(\.{"hour"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_minute},\39\\{xstrdup}(\.{"minute"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_char\_code},\39\\{xstrdup}(%
\.{"charcode"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_char\_ext},\39\\{xstrdup}(\.{"charext"}));{}$%
\6
${}\\{set\_internal\_name}(\\{mp\_char\_wd},\39\\{xstrdup}(\.{"charwd"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_char\_ht},\39\\{xstrdup}(\.{"charht"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_char\_dp},\39\\{xstrdup}(\.{"chardp"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_char\_ic},\39\\{xstrdup}(\.{"charic"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_design\_size},\39\\{xstrdup}(%
\.{"designsize"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_pausing},\39\\{xstrdup}(\.{"pausing"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_showstopping},\39\\{xstrdup}(%
\.{"showstopping"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_fontmaking},\39\\{xstrdup}(%
\.{"fontmaking"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_linejoin},\39\\{xstrdup}(\.{"linejoin"}));{}$%
\6
${}\\{set\_internal\_name}(\\{mp\_linecap},\39\\{xstrdup}(\.{"linecap"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_miterlimit},\39\\{xstrdup}(%
\.{"miterlimit"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_warning\_check},\39\\{xstrdup}(%
\.{"warningcheck"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_boundary\_char},\39\\{xstrdup}(%
\.{"boundarychar"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_prologues},\39\\{xstrdup}(%
\.{"prologues"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_true\_corners},\39\\{xstrdup}(%
\.{"truecorners"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_default\_color\_model},\39\\{xstrdup}(%
\.{"defaultcolormodel"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_procset},\39\\{xstrdup}(\.{"mpprocset"}));{}$%
\6
${}\\{set\_internal\_name}(\\{mp\_gtroffmode},\39\\{xstrdup}(%
\.{"troffmode"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_restore\_clip\_color},\39\\{xstrdup}(%
\.{"restoreclipcolor"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_output\_template},\39\\{xstrdup}(%
\.{"outputtemplate"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_output\_filename},\39\\{xstrdup}(%
\.{"outputfilename"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_output\_format},\39\\{xstrdup}(%
\.{"outputformat"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_output\_format\_options},\39\\{xstrdup}(%
\.{"outputformatoptions}\)\.{"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_job\_name},\39\\{xstrdup}(\.{"jobname"}));{}$%
\6
${}\\{set\_internal\_name}(\\{mp\_number\_system},\39\\{xstrdup}(%
\.{"numbersystem"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_number\_precision},\39\\{xstrdup}(%
\.{"numberprecision"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_hppp},\39\\{xstrdup}(\.{"hppp"}));{}$\6
${}\\{set\_internal\_name}(\\{mp\_vppp},\39\\{xstrdup}(\.{"vppp"})){}$;\par
\fi

\M{204}The following procedure, which is called just before \MP\ initializes
its
input and output, establishes the initial values of the date and time.

Note that the values are \PB{\\{scaled}} integers. Hence \MP\ can no longer
be used after the year 32767.

\Y\B\&{static} \&{void} \\{mp\_fix\_date\_and\_time}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{time\_t} \\{aclock}${}\K{}$\\{time}((\&{time\_t} ${}{*}){}$ \T{0});\6
\&{struct} \\{tm} ${}{*}\\{tmptr}\K\\{localtime}({\AND}\\{aclock});{}$\7
${}\\{set\_internal\_from\_number}(\\{mp\_time},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_time}),\39(\\{tmptr}\MG%
\\{tm\_hour}*\T{60}+\\{tmptr}\MG\\{tm\_min}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_hour},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_hour}),\39(\\{tmptr}\MG%
\\{tm\_hour}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_minute},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_minute}),\39(\\{tmptr}%
\MG\\{tm\_min}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_day},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_day}),\39(\\{tmptr}\MG%
\\{tm\_mday}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_month},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_month}),\39(\\{tmptr}%
\MG\\{tm\_mon}+\T{1}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_year},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_year}),\39(\\{tmptr}\MG%
\\{tm\_year}+\T{1900}));{}$\6
\4${}\}{}$\2\par
\fi

\M{205}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_fix\_date\_and\_time}(\&{MP} \\{mp});\par
\fi

\M{206}\MP\ is occasionally supposed to print diagnostic information that
goes only into the transcript file, unless \PB{\\{mp\_tracing\_online}} is
positive.
Now that we have defined \PB{\\{mp\_tracing\_online}} we can define
two routines that adjust the destination of print commands:

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_begin\_diagnostic}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_end\_diagnostic}(\&{MP} \\{mp}${},\39{}$\&{boolean} %
\\{blank\_line});\6
\&{static} \&{void} \\{mp\_print\_diagnostic}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s,\39{}$\&{const} \&{char} ${}{*}\|t,\39{}$\&{boolean} %
\\{nuline});\par
\fi

\M{207}\B\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_begin\_diagnostic}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ prepare to do some tracing }\1\6
${}\\{mp}\MG\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
\&{if} ${}(\\{number\_nonpositive}(\\{internal\_value}(\\{mp\_tracing%
\_online}))\W(\\{mp}\MG\\{selector}\E\\{term\_and\_log})){}$\5
${}\{{}$\1\6
${}\\{decr}(\\{mp}\MG\\{selector});{}$\6
\&{if} ${}(\\{mp}\MG\\{history}\E\\{mp\_spotless}){}$\1\5
${}\\{mp}\MG\\{history}\K\\{mp\_warning\_issued};{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{void} \\{mp\_end\_diagnostic}(\&{MP} \\{mp}${},\39{}$\&{boolean} \\{blank%
\_line})\1\1\2\2\6
${}\{{}$\C{ restore proper conditions after tracing }\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
\&{if} (\\{blank\_line})\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{old\_setting};{}$\6
\4${}\}{}$\2\par
\fi

\M{208}

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{unsigned} \&{int} \\{old\_setting};\par
\fi

\M{209}We will occasionally use \PB{\\{begin\_diagnostic}} in connection with
line-number
printing, as follows. (The parameter \PB{\|s} is typically \PB{\.{"Path"}} or
\PB{\.{"Cycle\ spec"}}, etc.)

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_diagnostic}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\|s,\39{}$\&{const} \&{char} ${}{*}\|t,\39{}$\&{boolean} \\{nuline})\1\1%
\2\2\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
\&{if} (\\{nuline})\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\|s);{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\|s);{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ at\ line\ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp\_true\_line}(\\{mp}));{}$\6
${}\\{mp\_print}(\\{mp},\39\|t);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{':'}));{}$\6
\4${}\}{}$\2\par
\fi

\M{210}The 256 \PB{\&{ASCII\_code}} characters are grouped into classes by
means of
the \PB{\\{char\_class}} table. Individual class numbers have no semantic
or syntactic significance, except in a few instances defined here.
There's also \PB{\\{max\_class}}, which can be used as a basis for additional
class numbers in nonstandard extensions of \MP.

\Y\B\4\D$\\{digit\_class}$ \5
\T{0}\C{ the class number of \.{0123456789} }\par
\B\4\D$\\{period\_class}$ \5
\T{1}\C{ the class number of `\..' }\par
\B\4\D$\\{space\_class}$ \5
\T{2}\C{ the class number of spaces and nonstandard characters }\par
\B\4\D$\\{percent\_class}$ \5
\T{3}\C{ the class number of `\.\%' }\par
\B\4\D$\\{string\_class}$ \5
\T{4}\C{ the class number of `\."' }\par
\B\4\D$\\{right\_paren\_class}$ \5
\T{8}\C{ the class number of `\.)' }\par
\B\4\D$\\{isolated\_classes}$ \5
\T{5}:\5
\&{case} \T{6}:\5
\&{case} \T{7}: \&{case} \T{8}\C{ characters that make length-one tokens only }%
\par
\B\4\D$\\{letter\_class}$ \5
\T{9}\C{ letters and the underline character }\par
\B\4\D$\\{mp\_left\_bracket\_class}$ \5
\T{17}\C{ `\.[' }\par
\B\4\D$\\{mp\_right\_bracket\_class}$ \5
\T{18}\C{ `\.]' }\par
\B\4\D$\\{invalid\_class}$ \5
\T{20}\C{ bad character in the input }\par
\B\4\D$\\{max\_class}$ \5
\T{20}\C{ the largest class number }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\8\#\&{define} \\{digit\_class} \5\T{0}\C{ the class number of \.{0123456789} }%
\6
\&{int} \\{char\_class}[\T{256}];\C{ the class numbers }\par
\fi

\M{211}If changes are made to accommodate non-ASCII character sets, they should
follow the guidelines in Appendix~C of {\sl The {\logos METAFONT\/}book}.

\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\.{'0'};{}$ ${}\|k\Z\.{'9'};{}$ ${}\|k\PP){}$\1\5
${}\\{mp}\MG\\{char\_class}[\|k]\K\\{digit\_class};{}$\2\6
${}\\{mp}\MG\\{char\_class}[\.{'.'}]\K\\{period\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\ '}]\K\\{space\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\%'}]\K\\{percent\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'"'}]\K\\{string\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{','}]\K\T{5};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{';'}]\K\T{6};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'('}]\K\T{7};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{')'}]\K\\{right\_paren\_class};{}$\6
\&{for} ${}(\|k\K\.{'A'};{}$ ${}\|k\Z\.{'Z'};{}$ ${}\|k\PP){}$\1\5
${}\\{mp}\MG\\{char\_class}[\|k]\K\\{letter\_class};{}$\2\6
\&{for} ${}(\|k\K\.{'a'};{}$ ${}\|k\Z\.{'z'};{}$ ${}\|k\PP){}$\1\5
${}\\{mp}\MG\\{char\_class}[\|k]\K\\{letter\_class};{}$\2\6
${}\\{mp}\MG\\{char\_class}[\.{'\_'}]\K\\{letter\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'<'}]\K\T{10};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'='}]\K\T{10};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'>'}]\K\T{10};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{':'}]\K\T{10};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'|'}]\K\T{10};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'`'}]\K\T{11};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\\''}]\K\T{11};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'+'}]\K\T{12};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'-'}]\K\T{12};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'/'}]\K\T{13};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'*'}]\K\T{13};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\\\\'}]\K\T{13};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'!'}]\K\T{14};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'?'}]\K\T{14};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\#'}]\K\T{15};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\&'}]\K\T{15};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'@'}]\K\T{15};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\$'}]\K\T{15};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\^'}]\K\T{16};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\~'}]\K\T{16};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'['}]\K\\{mp\_left\_bracket\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{']'}]\K\\{mp\_right\_bracket\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\{'}]\K\T{19};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\}'}]\K\T{19};{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\.{'\ '};{}$ ${}\|k\PP){}$\1\5
${}\\{mp}\MG\\{char\_class}[\|k]\K\\{invalid\_class};{}$\2\6
${}\\{mp}\MG\\{char\_class}[\.{'\\t'}]\K\\{space\_class};{}$\6
${}\\{mp}\MG\\{char\_class}[\.{'\\f'}]\K\\{space\_class};{}$\6
\&{for} ${}(\|k\K\T{127};{}$ ${}\|k\Z\T{255};{}$ ${}\|k\PP){}$\1\5
${}\\{mp}\MG\\{char\_class}[\|k]\K\\{invalid\_class}{}$;\2\par
\fi

\N{1}{212}The hash table.

Symbolic tokens are stored in and retrieved from an AVL tree. This
is not as fast as an actual hash table, but it is easily extensible.

A symbolic token contains a pointer to the \PB{\&{mp\_string}} that
contains the string representation of the symbol, a \PB{\&{halfword}}
that holds the current command value of the token, and an
\PB{\&{mp\_value}} for the associated equivalent.

\Y\B\4\D$\\{set\_text}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_text(\%p,\ \%p)\\n"},\39(\|A),\39(\|B));{}$\6
${}(\|A)\MG\\{text}\K(\|B);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_eq\_type}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_eq\_type(\%p,\ \%d)}\)\.{\\n"},\39(\|A),\39(%
\|B));{}$\6
${}(\|A)\MG\\{type}\K(\|B);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_equiv}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_equiv(\%p,\ \%d)\\n}\)\.{"},\39(\|A),\39(%
\|B));{}$\6
${}(\|A)\MG\|v.\\{data}.\\{node}\K\NULL;{}$\6
${}(\|A)\MG\|v.\\{data}.\\{indep}.\\{serial}\K(\|B);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_equiv\_node}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_equiv\_node(\%p,\ }\)\.{\%p)\\n"},\39(\|A),%
\39(\|B));{}$\6
${}(\|A)\MG\|v.\\{data}.\\{node}\K(\|B);{}$\6
${}(\|A)\MG\|v.\\{data}.\\{indep}.\\{serial}\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_equiv\_sym}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_equiv\_sym(\%p,\ \%}\)\.{p)\\n"},\39(\|A),\39(%
\|B));{}$\6
${}(\|A)\MG\|v.\\{data}.\\{node}\K(\&{mp\_node})(\|B);{}$\6
${}(\|A)\MG\|v.\\{data}.\\{indep}.\\{serial}\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\fi

\M{213}\B\6
\8\#\&{if} \.{DEBUG}\6
\8\#\&{define} \\{text}(\|A)\\{do\_get\_text} \5${}(\\{mp},\39(\|A)){}$\6
\8\#\&{define} \\{eq\_type}(\|A)\\{do\_get\_eq\_type} \5${}(\\{mp},\39(\|A)){}$%
\6
\8\#\&{define} \\{equiv}(\|A)\\{do\_get\_equiv} \5${}(\\{mp},\39(\|A)){}$\6
\8\#\&{define} \\{equiv\_node}(\|A)\\{do\_get\_equiv\_node} \5${}(\\{mp},\39(%
\|A)){}$\6
\8\#\&{define} \\{equiv\_sym}(\|A)\\{do\_get\_equiv\_sym} \5${}(\\{mp},\39(%
\|A)){}$\6
\&{static} \&{mp\_string} \\{do\_get\_text}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\|A)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%d\ =\ do\_get\_text(\%p}\)\.{)\\n"},\39\|A\MG%
\\{text},\39\|A);{}$\6
\&{return} \|A${}\MG\\{text};{}$\6
\4${}\}{}$\2\7
\&{static} \&{halfword} \\{do\_get\_eq\_type}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%d\ =\ do\_get\_eq\_type}\)\.{(\%p)\\n"},\39\|A\MG%
\\{type},\39\|A);{}$\6
\&{return} \|A${}\MG\\{type};{}$\6
\4${}\}{}$\2\7
\&{static} \&{halfword} \\{do\_get\_equiv}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\|A)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%d\ =\ do\_get\_equiv(\%}\)\.{p)\\n"},\39\|A\MG%
\|v.\\{data}.\\{indep}.\\{serial},\39\|A);{}$\6
\&{return} \|A${}\MG\|v.\\{data}.\\{indep}.\\{serial};{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_node} \\{do\_get\_equiv\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ do\_get\_equiv\_n}\)\.{ode(\%p)\\n"},\39\|A%
\MG\|v.\\{data}.\\{node},\39\|A);{}$\6
\&{return} \|A${}\MG\|v.\\{data}.\\{node};{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_sym} \\{do\_get\_equiv\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ do\_get\_equiv\_s}\)\.{ym(\%p)\\n"},\39\|A%
\MG\|v.\\{data}.\\{node},\39\|A);{}$\6
\&{return} (\&{mp\_sym}) \|A${}\MG\|v.\\{data}.\\{node};{}$\6
\4${}\}{}$\2\6
\8\#\&{else}\6
\8\#\&{define} ${}\\{text}(\|A)(\|A)\MG\\{text}{}$\6
\8\#\&{define} ${}\\{eq\_type}(\|A)(\|A)\MG\\{type}{}$\6
\8\#\&{define} ${}\\{equiv}(\|A)(\|A)\MG\|v.\\{data}.\\{indep}.\\{serial}{}$\6
\8\#\&{define} ${}\\{equiv\_node}(\|A)(\|A)\MG\|v.\\{data}.\\{node}{}$\6
\8\#\&{define} ${}\\{equiv\_sym}(\|A)(\&{mp\_sym})(\|A)\MG\|v.\\{data}.%
\\{node}{}$\6
\8\#\&{endif}\par
\fi

\M{214}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\8\#\&{if} \.{DEBUG}\6
\&{static} \&{mp\_string} \\{do\_get\_text}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\|A);\6
\&{static} \&{halfword} \\{do\_get\_eq\_type}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A);\6
\&{static} \&{halfword} \\{do\_get\_equiv}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\|A);\6
\&{static} \&{mp\_node} \\{do\_get\_equiv\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A);\6
\&{static} \&{mp\_sym} \\{do\_get\_equiv\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|A);\6
\8\#\&{endif}\par
\fi

\M{215}\B\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_symbol\_entry} ${}\{{}$\1\6
\&{halfword} \\{type};\6
\&{mp\_value} \|v;\6
\&{mp\_string} \\{text};\6
\&{void} ${}{*}\\{parent};{}$\2\6
${}\}{}$ \&{mp\_symbol\_entry};\par
\fi

\M{216}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{st\_count};\C{ total number of known identifiers }\7
\\{avl\_tree}\\{symbols};\C{ avl tree of symbolic tokens }\6
\\{avl\_tree}\\{frozen\_symbols};\C{ avl tree of frozen symbolic tokens }\7
\&{mp\_sym} \\{frozen\_bad\_vardef};\6
\&{mp\_sym} \\{frozen\_colon};\6
\&{mp\_sym} \\{frozen\_end\_def};\6
\&{mp\_sym} \\{frozen\_end\_for};\6
\&{mp\_sym} \\{frozen\_end\_group};\6
\&{mp\_sym} \\{frozen\_etex};\6
\&{mp\_sym} \\{frozen\_fi};\6
\&{mp\_sym} \\{frozen\_inaccessible};\6
\&{mp\_sym} \\{frozen\_left\_bracket};\6
\&{mp\_sym} \\{frozen\_mpx\_break};\6
\&{mp\_sym} \\{frozen\_repeat\_loop};\6
\&{mp\_sym} \\{frozen\_right\_delimiter};\6
\&{mp\_sym} \\{frozen\_semicolon};\6
\&{mp\_sym} \\{frozen\_slash};\6
\&{mp\_sym} \\{frozen\_undefined};\6
\&{mp\_sym} \\{frozen\_dump};\par
\fi

\M{217}Here are the functions needed for the avl construction.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{int} \\{comp\_symbols\_entry}(\&{void} ${}{*}\|p,\39{}$\&{const} %
\&{void} ${}{*}\\{pa},\39{}$\&{const} \&{void} ${}{*}\\{pb});{}$\6
\&{static} \&{void} ${}{*}{}$\\{copy\_symbols\_entry}(\&{const} \&{void} ${}{*}%
\|p);{}$\6
\&{static} \&{void} ${}{*}{}$\\{delete\_symbols\_entry}(\&{void} ${}{*}\|p){}$;%
\par
\fi

\M{218}The avl comparison function is a straightword version of \PB{%
\\{strcmp}},
except that checks for the string lengths first.

\Y\B\&{static} \&{int} \\{comp\_symbols\_entry}(\&{void} ${}{*}\|p,\39{}$%
\&{const} \&{void} ${}{*}\\{pa},\39{}$\&{const} \&{void} ${}{*}\\{pb}){}$\1\1\2%
\2\6
${}\{{}$\1\6
\&{const} \&{mp\_symbol\_entry} ${}{*}\|a\K{}$(\&{const} \&{mp\_symbol\_entry}
${}{*}){}$ \\{pa};\6
\&{const} \&{mp\_symbol\_entry} ${}{*}\|b\K{}$(\&{const} \&{mp\_symbol\_entry}
${}{*}){}$ \\{pb};\7
(\&{void}) \|p;\6
\&{if} ${}(\|a\MG\\{text}\MG\\{len}\I\|b\MG\\{text}\MG\\{len}){}$\5
${}\{{}$\1\6
\&{return} ${}(\|a\MG\\{text}\MG\\{len}>\|b\MG\\{text}\MG\\{len}\?\T{1}:{-}%
\T{1});{}$\6
\4${}\}{}$\2\6
\&{return} \\{strncmp}((\&{const} \&{char} ${}{*}){}$ \|a${}\MG\\{text}\MG%
\\{str},\39{}$(\&{const} \&{char} ${}{*}){}$ \|b${}\MG\\{text}\MG\\{str},\39\|a%
\MG\\{text}\MG\\{len});{}$\6
\4${}\}{}$\2\par
\fi

\M{219}Copying a symbol happens when an item is inserted into an AVL tree.
The \PB{\\{text}} and \PB{\&{mp\_number}} needs to be deep copied, every thing
else
can be reassigned.

\Y\B\&{static} \&{void} ${}{*}{}$\\{copy\_symbols\_entry}(\&{const} \&{void}
${}{*}\|p){}$\1\1\2\2\6
${}\{{}$\1\6
\&{MP} \\{mp};\6
\&{mp\_sym} \\{ff};\6
\&{const} \&{mp\_symbol\_entry} ${}{*}\\{fp};{}$\7
${}\\{fp}\K{}$(\&{const} \&{mp\_symbol\_entry} ${}{*}){}$ \|p;\6
${}\\{mp}\K{}$(\&{MP}) \\{fp}${}\MG\\{parent};{}$\6
${}\\{ff}\K\\{malloc}(\&{sizeof}(\&{mp\_symbol\_entry}));{}$\6
\&{if} ${}(\\{ff}\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{ff}\MG\\{text}\K\\{copy\_strings\_entry}(\\{fp}\MG\\{text});{}$\6
\&{if} ${}(\\{ff}\MG\\{text}\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{ff}\MG\|v\K\\{fp}\MG\|v;{}$\6
${}\\{ff}\MG\\{type}\K\\{fp}\MG\\{type};{}$\6
${}\\{ff}\MG\\{parent}\K\\{mp};{}$\6
${}\\{new\_number}(\\{ff}\MG\|v.\\{data}.\|n);{}$\6
${}\\{number\_clone}(\\{ff}\MG\|v.\\{data}.\|n,\39\\{fp}\MG\|v.\\{data}.%
\|n);{}$\6
\&{return} \\{ff};\6
\4${}\}{}$\2\par
\fi

\M{220}In the current implementation, symbols are not freed until the
end of the run.

\Y\B\&{static} \&{void} ${}{*}{}$\\{delete\_symbols\_entry}(\&{void} ${}{*}%
\|p){}$\1\1\2\2\6
${}\{{}$\1\6
\&{MP} \\{mp};\6
\&{mp\_sym} \\{ff}${}\K{}$(\&{mp\_sym}) \|p;\7
${}\\{mp}\K{}$(\&{MP}) \\{ff}${}\MG\\{parent};{}$\6
${}\\{free\_number}(\\{ff}\MG\|v.\\{data}.\|n);{}$\6
${}\\{mp\_xfree}(\\{ff}\MG\\{text}\MG\\{str});{}$\6
${}\\{mp\_xfree}(\\{ff}\MG\\{text});{}$\6
\\{mp\_xfree}(\\{ff});\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{221}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{symbols}\K\\{avl\_create}(\\{comp\_symbols\_entry},\39\\{copy%
\_symbols\_entry},\39\\{delete\_symbols\_entry},\39\\{malloc},\39\\{free},\39%
\NULL);{}$\6
${}\\{mp}\MG\\{frozen\_symbols}\K\\{avl\_create}(\\{comp\_symbols\_entry},\39%
\\{copy\_symbols\_entry},\39\\{delete\_symbols\_entry},\39\\{malloc},\39%
\\{free},\39\NULL){}$;\par
\fi

\M{222}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{if} ${}(\\{mp}\MG\\{symbols}\I\NULL){}$\1\5
${}\\{avl\_destroy}(\\{mp}\MG\\{symbols});{}$\2\6
\&{if} ${}(\\{mp}\MG\\{frozen\_symbols}\I\NULL){}$\1\5
${}\\{avl\_destroy}(\\{mp}\MG\\{frozen\_symbols}){}$;\2\par
\fi

\M{223}Actually creating symbols is done by \PB{\\{id\_lookup}}, but in order
to
do so it needs a way to create a new, empty symbol structure.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_sym} \\{new\_symbols\_entry}(\&{MP} \\{mp}${},\39{}$%
\&{unsigned} \&{char} ${}{*}\\{nam},\39{}$\&{size\_t} \\{len});\par
\fi

\M{224}\B\&{static} \&{mp\_sym} \\{new\_symbols\_entry}(\&{MP} \\{mp}${},\39{}$%
\&{unsigned} \&{char} ${}{*}\\{nam},\39{}$\&{size\_t} \\{len})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \\{ff};\7
${}\\{ff}\K\\{mp\_xmalloc}(\\{mp},\39\T{1},\39\&{sizeof}(\&{mp\_symbol%
\_entry}));{}$\6
${}\\{memset}(\\{ff},\39\T{0},\39\&{sizeof}(\&{mp\_symbol\_entry}));{}$\6
${}\\{ff}\MG\\{parent}\K\\{mp};{}$\6
${}\\{ff}\MG\\{text}\K\\{mp\_xmalloc}(\\{mp},\39\T{1},\39\&{sizeof}(\&{mp%
\_lstring}));{}$\6
${}\\{ff}\MG\\{text}\MG\\{str}\K\\{nam};{}$\6
${}\\{ff}\MG\\{text}\MG\\{len}\K\\{len};{}$\6
${}\\{ff}\MG\\{type}\K\\{mp\_tag\_token};{}$\6
${}\\{ff}\MG\|v.\\{type}\K\\{mp\_known};{}$\6
${}\\{new\_number}(\\{ff}\MG\|v.\\{data}.\|n);{}$\6
${}\.{FUNCTION\_TRACE4}(\.{"\%p\ =\ new\_symbols\_en}\)\.{try(\\"\%s\\",\%d)%
\\n"},\39\\{ff},\39\\{nam},\39{}$(\&{int}) \\{len});\6
\&{return} \\{ff};\6
\4${}\}{}$\2\par
\fi

\M{225}There is one global variable so that \PB{\\{id\_lookup}} does not always
have to
create a new entry just for testing. This is not freed because it creates
a double-free thanks to the \PB{$\NULL$} init.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_sym} \\{id\_lookup\_test};\par
\fi

\M{226}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{id\_lookup\_test}\K\\{new\_symbols\_entry}(\\{mp},\39\NULL,\39%
\T{0}){}$;\par
\fi

\M{227}Certain symbols are ``frozen'' and not redefinable, since they are
used
in error recovery.

\Y\B\4\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{st\_count}\K\T{0};{}$\6
${}\\{mp}\MG\\{frozen\_bad\_vardef}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"a\
bad\ variable"},\39\\{mp\_tag\_token},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_right\_delimiter}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{")"},\39\\{mp\_right\_delimiter},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_inaccessible}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"\
INACCESSIBLE"},\39\\{mp\_tag\_token},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_undefined}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"\
UNDEFINED"},\39\\{mp\_tag\_token},\39\T{0}){}$;\par
\fi

\M{228}Here is the subroutine that searches the avl tree for an identifier
that matches a given string of length~\PB{\|l} appearing in \PB{$\\{buffer}[\|j%
\MRL{{.}{.}}(\|j+\|l-\T{1})]$}. If the identifier is not found, it is inserted
if
\PB{\\{insert\_new}} is \PB{\\{true}}, and the corresponding symbol will be
returned.

There are two variations on the lookup function: one for the normal
symbol table, and one for the table of error recovery symbols.

\Y\B\4\D$\\{mp\_id\_lookup}(\|A,\|B,\|C,\|D)$ \5
$\\{mp\_do\_id\_lookup}((\|A),\39\\{mp}\MG\\{symbols},\39(\|B),\39(\|C),\39(%
\|D){}$)\par
\Y\B\&{static} \&{mp\_sym} \\{mp\_do\_id\_lookup}(\&{MP} \\{mp}${},\39\\{avl%
\_tree}\\{symbols},\39{}$\&{char} ${}{*}\|j,\39{}$\&{size\_t} \|l${},\39{}$%
\&{boolean} \\{insert\_new})\1\1\2\2\6
${}\{{}$\C{ search an avl tree }\1\6
\&{mp\_sym} \\{str};\7
${}\\{mp}\MG\\{id\_lookup\_test}\MG\\{text}\MG\\{str}\K{}$(\&{unsigned} %
\&{char} ${}{*}){}$ \|j;\6
${}\\{mp}\MG\\{id\_lookup\_test}\MG\\{text}\MG\\{len}\K\|l;{}$\6
${}\\{str}\K{}$(\&{mp\_sym}) \\{avl\_find}${}(\\{mp}\MG\\{id\_lookup\_test},\39%
\\{symbols});{}$\6
\&{if} ${}(\\{str}\E\NULL\W\\{insert\_new}){}$\5
${}\{{}$\1\6
\&{unsigned} \&{char} ${}{*}\\{nam}\K{}$(\&{unsigned} \&{char} ${}{*}){}$ \\{mp%
\_xstrldup}${}(\\{mp},\39\|j,\39\|l);{}$\6
\&{mp\_sym} \|s${}\K\\{new\_symbols\_entry}(\\{mp},\39\\{nam},\39\|l);{}$\7
${}\\{mp}\MG\\{st\_count}\PP;{}$\6
${}\\{assert}(\\{avl\_ins}(\|s,\39\\{symbols},\39\\{avl\_false})>\T{0});{}$\6
${}\\{str}\K{}$(\&{mp\_sym}) \\{avl\_find}${}(\|s,\39\\{symbols});{}$\6
\\{delete\_symbols\_entry}(\|s);\6
\4${}\}{}$\2\6
\&{return} \\{str};\6
\4${}\}{}$\2\7
\&{static} \&{mp\_sym} \\{mp\_frozen\_id\_lookup}(\&{MP} \\{mp}${},\39{}$%
\&{char} ${}{*}\|j,\39{}$\&{size\_t} \|l${},\39{}$\&{boolean} \\{insert\_new})%
\1\1\2\2\6
${}\{{}$\C{ search the error recovery symbol table }\1\6
\&{return} \\{mp\_do\_id\_lookup}${}(\\{mp},\39\\{mp}\MG\\{frozen\_symbols},\39%
\|j,\39\|l,\39\\{insert\_new});{}$\6
\4${}\}{}$\2\par
\fi

\M{229}We need to put \MP's ``primitive'' symbolic tokens into the hash
table, together with their command code (which will be the \PB{\\{eq\_type}})
and an operand (which will be the \PB{\\{equiv}}). The \PB{\\{primitive}}
procedure
does this, in a way that no \MP\ user can. The global value \PB{\\{cur\_sym}}
contains the new \PB{\\{eqtb}} pointer after \PB{\\{primitive}} has acted.

\Y\B\&{static} \&{void} \\{mp\_primitive}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\\{ss},\39{}$\&{halfword} \|c${},\39{}$\&{halfword} \|o)\1\1\2\2%
\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{mp\_xstrdup}(\\{mp},\39\\{ss});{}$\7
${}\\{set\_cur\_sym}(\\{mp\_id\_lookup}(\\{mp},\39\|s,\39\\{strlen}(\|s),\39%
\\{true}));{}$\6
\\{mp\_xfree}(\|s);\6
${}\\{set\_eq\_type}(\\{cur\_sym}(\,),\39\|c);{}$\6
${}\\{set\_equiv}(\\{cur\_sym}(\,),\39\|o);{}$\6
\4${}\}{}$\2\par
\fi

\M{230}Some other symbolic tokens only exist for error recovery.

\Y\B\&{static} \&{mp\_sym} \\{mp\_frozen\_primitive}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{ss},\39{}$\&{halfword} \|c${},\39{}$\&{halfword} %
\|o)\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{mp\_xstrdup}(\\{mp},\39\\{ss});{}$\6
\&{mp\_sym} \\{str}${}\K\\{mp\_frozen\_id\_lookup}(\\{mp},\39\|s,\39\\{strlen}(%
\\{ss}),\39\\{true});{}$\7
\\{mp\_xfree}(\|s);\6
${}\\{str}\MG\\{type}\K\|c;{}$\6
${}\\{str}\MG\|v.\\{data}.\\{indep}.\\{serial}\K\|o;{}$\6
\&{return} \\{str};\6
\4${}\}{}$\2\par
\fi

\M{231}This routine returns \PB{\\{true}} if the argument is an un-redefinable
symbol
because it is one of the error recovery tokens (as explained elsewhere,
\PB{\\{frozen\_inaccessible}} actuall is redefinable).

\Y\B\&{static} \&{boolean} \\{mp\_is\_frozen}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \\{sym})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \\{temp}${}\K\\{mp\_frozen\_id\_lookup}(\\{mp},\39{}$(\&{char}
${}{*}){}$ \\{sym}${}\MG\\{text}\MG\\{str},\39\\{sym}\MG\\{text}\MG\\{len},\39%
\\{false});{}$\7
\&{if} ${}(\\{temp}\E\\{mp}\MG\\{frozen\_inaccessible}){}$\1\5
\&{return} \\{false};\2\6
\&{return} ${}(\\{temp}\E\\{sym});{}$\6
\4${}\}{}$\2\par
\fi

\M{232}Many of \MP's primitives need no \PB{\\{equiv}}, since they are
identifiable
by their \PB{\\{eq\_type}} alone. These primitives are loaded into the hash
table
as follows:

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{".."},\39\\{mp\_path\_join},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"["},\39\\{mp\_left\_bracket},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_left\_bracket}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{"["},\39\\{mp\_left\_bracket},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"]"},\39\\{mp\_right\_bracket},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"\}"},\39\\{mp\_right\_brace},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"\{"},\39\\{mp\_left\_brace},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{":"},\39\\{mp\_colon},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_colon}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{":"},\39%
\\{mp\_colon},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"::"},\39\\{mp\_double\_colon},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"||:"},\39\\{mp\_bchar\_label},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{":="},\39\\{mp\_assignment},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{","},\39\\{mp\_comma},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{";"},\39\\{mp\_semicolon},\39\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_semicolon}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{";"},%
\39\\{mp\_semicolon},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"\\\\"},\39\\{mp\_relax},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"addto"},\39\\{mp\_add\_to\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"atleast"},\39\\{mp\_at\_least},\39\T{0});{}$%
\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"begingroup"},\39\\{mp\_begin\_group},\39%
\T{0});{}$\6
${}\\{mp}\MG\\{bg\_loc}\K\\{cur\_sym}(\,);{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"controls"},\39\\{mp\_controls},\39\T{0});{}$%
\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"curl"},\39\\{mp\_curl\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"delimiters"},\39\\{mp\_delimiters},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"endgroup"},\39\\{mp\_end\_group},\39%
\T{0});{}$\6
${}\\{mp}\MG\\{eg\_loc}\K\\{cur\_sym}(\,);{}$\6
${}\\{mp}\MG\\{frozen\_end\_group}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{"endgroup"},\39\\{mp\_end\_group},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"everyjob"},\39\\{mp\_every\_job\_command},%
\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"exitif"},\39\\{mp\_exit\_test},\39\T{0});{}$%
\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"expandafter"},\39\\{mp\_expand\_after},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"interim"},\39\\{mp\_interim\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"let"},\39\\{mp\_let\_command},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"newinternal"},\39\\{mp\_new\_internal},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"of"},\39\\{mp\_of\_token},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"randomseed"},\39\\{mp\_random\_seed},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"save"},\39\\{mp\_save\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"scantokens"},\39\\{mp\_scan\_tokens},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"shipout"},\39\\{mp\_ship\_out\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"skipto"},\39\\{mp\_skip\_to},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"special"},\39\\{mp\_special\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontmapfile"},\39\\{mp\_special\_command},%
\39\T{1});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontmapline"},\39\\{mp\_special\_command},%
\39\T{2});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"step"},\39\\{mp\_step\_token},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"str"},\39\\{mp\_str\_op},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tension"},\39\\{mp\_tension},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"to"},\39\\{mp\_to\_token},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"until"},\39\\{mp\_until\_token},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"within"},\39\\{mp\_within\_token},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"write"},\39\\{mp\_write\_command},\39%
\T{0}){}$;\par
\fi

\M{233}Each primitive has a corresponding inverse, so that it is possible to
display the cryptic numeric contents of \PB{\\{eqtb}} in symbolic form.
Every call of \PB{\\{primitive}} in this program is therefore accompanied by
some
straightforward code that forms part of the \PB{\\{print\_cmd\_mod}} routine
explained below.

\Y\B\4\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\E{}$\6
\4\&{case} \\{mp\_add\_to\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"addto"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_assignment}:\5
${}\\{mp\_print}(\\{mp},\39\.{":="});{}$\6
\&{break};\6
\4\&{case} \\{mp\_at\_least}:\5
${}\\{mp\_print}(\\{mp},\39\.{"atleast"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_bchar\_label}:\5
${}\\{mp\_print}(\\{mp},\39\.{"||:"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_begin\_group}:\5
${}\\{mp\_print}(\\{mp},\39\.{"begingroup"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_colon}:\5
${}\\{mp\_print}(\\{mp},\39\.{":"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_comma}:\5
${}\\{mp\_print}(\\{mp},\39\.{","});{}$\6
\&{break};\6
\4\&{case} \\{mp\_controls}:\5
${}\\{mp\_print}(\\{mp},\39\.{"controls"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_curl\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"curl"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_delimiters}:\5
${}\\{mp\_print}(\\{mp},\39\.{"delimiters"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_double\_colon}:\5
${}\\{mp\_print}(\\{mp},\39\.{"::"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_end\_group}:\5
${}\\{mp\_print}(\\{mp},\39\.{"endgroup"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_every\_job\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"everyjob"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_exit\_test}:\5
${}\\{mp\_print}(\\{mp},\39\.{"exitif"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_expand\_after}:\5
${}\\{mp\_print}(\\{mp},\39\.{"expandafter"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_interim\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"interim"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_left\_brace}:\5
${}\\{mp\_print}(\\{mp},\39\.{"\{"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_left\_bracket}:\5
${}\\{mp\_print}(\\{mp},\39\.{"["});{}$\6
\&{break};\6
\4\&{case} \\{mp\_let\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"let"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_new\_internal}:\5
${}\\{mp\_print}(\\{mp},\39\.{"newinternal"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_of\_token}:\5
${}\\{mp\_print}(\\{mp},\39\.{"of"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_join}:\5
${}\\{mp\_print}(\\{mp},\39\.{".."});{}$\6
\&{break};\6
\4\&{case} \\{mp\_random\_seed}:\5
${}\\{mp\_print}(\\{mp},\39\.{"randomseed"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_relax}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\\\\'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_right\_brace}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_right\_bracket}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{']'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_save\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"save"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_scan\_tokens}:\5
${}\\{mp\_print}(\\{mp},\39\.{"scantokens"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_semicolon}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{';'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_ship\_out\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"shipout"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_skip\_to}:\5
${}\\{mp\_print}(\\{mp},\39\.{"skipto"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_special\_command}:\6
\&{if} ${}(\|m\E\T{2}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"fontmapline"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\T{1}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"fontmapfile"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"special"});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_step\_token}:\5
${}\\{mp\_print}(\\{mp},\39\.{"step"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_str\_op}:\5
${}\\{mp\_print}(\\{mp},\39\.{"str"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_tension}:\5
${}\\{mp\_print}(\\{mp},\39\.{"tension"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_to\_token}:\5
${}\\{mp\_print}(\\{mp},\39\.{"to"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_until\_token}:\5
${}\\{mp\_print}(\\{mp},\39\.{"until"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_within\_token}:\5
${}\\{mp\_print}(\\{mp},\39\.{"within"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_write\_command}:\5
${}\\{mp\_print}(\\{mp},\39\.{"write"});{}$\6
\&{break};\par
\As736, 746, 754, 760, 772, 810, 956, 1047, 1072, 1079, 1082, 1100, 1106, 1123,
1129, 1144, 1176\ETs1186.
\U671.\fi

\M{234}We will deal with the other primitives later, at some point in the
program
where their \PB{\\{eq\_type}} and \PB{\\{equiv}} values are more meaningful.
For example,
the primitives for macro definitions will be loaded when we consider the
routines that define macros. It is easy to find where each particular
primitive was treated by looking in the index at the end; for example, the
section where \PB{\.{"def"}} entered \PB{\\{eqtb}} is listed under `\&{def}
primitive'.

\fi

\N{1}{235}Token lists.

A \MP\ token is either symbolic or numeric or a string, or it denotes a macro
parameter or capsule or an internal; so there are six corresponding ways to
encode it internally:

(1)~A symbolic token for symbol \PB{\|p} is represented by the pointer \PB{%
\|p},
in the \PB{\\{sym\_sym}} field of a symbolic node in~\PB{\\{mem}}. The \PB{%
\\{type}} field is \PB{\\{symbol\_node}};
and it has a \PB{\\{name\_type}} to differentiate various subtypes of symbolic
tokens,
which is usually \PB{\\{normal\_sym}}, but \PB{\\{macro\_sym}} for macro names.

(2)~A numeric token whose \PB{\\{scaled}} value is~\PB{\|v} is
represented in a non-symbolic node of~\PB{\\{mem}}; the \PB{\\{type}} field is %
\PB{\\{known}},
the \PB{\\{name\_type}} field is \PB{\\{token}}, and the \PB{\\{value}} field
holds~\PB{\|v}.

(3)~A string token is also represented in a non-symbolic node; the \PB{%
\\{type}}
field is \PB{\\{mp\_string\_type}}, the \PB{\\{name\_type}} field is \PB{%
\\{token}}, and the
\PB{\\{value}} field holds the corresponding \PB{\&{mp\_string}}.

(4)~Capsules have \PB{$\\{name\_type}\K\\{capsule}$}, and their \PB{\\{type}}
and \PB{\\{value}} fields
represent arbitrary values, with \PB{\\{type}} different from \PB{\\{symbol%
\_node}}
(in ways to be explained later).

(5)~Macro parameters appear in \PB{\\{sym\_info}} fields of symbolic nodes.
The \PB{\\{type}}
field is \PB{\\{symbol\_node}}; the $k$th parameter is represented by \PB{\|k}
in \PB{\\{sym\_info}};
and \PB{\\{expr\_sym}} in \PB{\\{name\_type}}, if it is of type \&{expr}, or %
\PB{\\{suffix\_sym}} if it
is of type \&{suffix}, or by \PB{\\{text\_sym}} if it is of type \&{text}.

(6)~The $k$th internal is also represented by \PB{\|k} in \PB{\\{sym\_info}};
the \PB{\\{type}} field is
\PB{\\{symbol\_node}} as for the other symbolic tokens; and \PB{\\{internal%
\_sym}} is its \PB{\\{name\_type}};

Actual values of the parameters and internals are kept in a separate
stack, as we will see later.

Note that the `\\{type}' field of a node has nothing to do with ``type'' in a
printer's sense. It's curious that the same word is used in such different
ways.

\Y\B\4\D$\\{token\_node\_size}$ \5
\&{sizeof}(\&{mp\_node\_data})\C{ the number of words in a large token node }%
\par
\B\4\D$\\{set\_value\_sym}(\|A,\|B)$ \5
$\\{do\_set\_value\_sym}(\\{mp},\39(\\{mp\_token\_node})(\|A),\39(\|B){}$)\par
\B\4\D$\\{set\_value\_number}(\|A,\|B)$ \5
$\\{do\_set\_value\_number}(\\{mp},\39(\\{mp\_token\_node})(\|A),\39(\|B){}$)%
\par
\B\4\D$\\{set\_value\_node}(\|A,\|B)$ \5
$\\{do\_set\_value\_node}(\\{mp},\39(\\{mp\_token\_node})(\|A),\39(\|B){}$)\par
\B\4\D$\\{set\_value\_str}(\|A,\|B)$ \5
$\\{do\_set\_value\_str}(\\{mp},\39(\\{mp\_token\_node})(\|A),\39(\|B){}$)\par
\B\4\D$\\{set\_value\_knot}(\|A,\|B)$ \5
$\\{do\_set\_value\_knot}(\\{mp},\39(\\{mp\_token\_node})\|A,\39(\|B){}$)\par
\B\4\D$\\{value\_sym\_NEW}(\|A)$ \5
(\&{mp\_sym}) \\{mp\_link}(\|A)\par
\B\4\D$\\{set\_value\_sym\_NEW}(\|A,\|B)$ \5
$\\{set\_mp\_link}(\|A,\39{}$(\&{mp\_node}) \|B)\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_node\_data} ${}{*}\&{mp\_token\_node}{}$;\par
\fi

\M{236}\B\6
\8\#\&{if} \.{DEBUG}\6
\8\#\&{define} \\{value\_sym}(\|A)\\{do\_get\_value\_sym} \5${}(\\{mp},\39(%
\&{mp\_token\_node})(\|A)){}$\SHC{\#define value\_number(A)
do\_get\_value\_number(mp,(mp\_token\_node)(A)) }\6
\8\#\&{define} ${}\\{value\_number}(\|A)((\&{mp\_token\_node})(\|A))\MG%
\\{data}.\|n{}$\6
\8\#\&{define} \\{value\_node}(\|A)\\{do\_get\_value\_node} \5${}(\\{mp},\39(%
\&{mp\_token\_node})(\|A)){}$\6
\8\#\&{define} \\{value\_str}(\|A)\\{do\_get\_value\_str} \5${}(\\{mp},\39(%
\&{mp\_token\_node})(\|A)){}$\6
\8\#\&{define} \\{value\_knot}(\|A)\\{do\_get\_value\_knot} \5${}(\\{mp},\39(%
\&{mp\_token\_node})(\|A)){}$\6
\8\#\&{else}\6
\8\#\&{define} ${}\\{value\_sym}(\|A)((\&{mp\_token\_node})(\|A))\MG\\{data}.%
\\{sym}{}$\6
\8\#\&{define} ${}\\{value\_number}(\|A)((\&{mp\_token\_node})(\|A))\MG%
\\{data}.\|n{}$\6
\8\#\&{define} ${}\\{value\_node}(\|A)((\&{mp\_token\_node})(\|A))\MG\\{data}.%
\\{node}{}$\6
\8\#\&{define} ${}\\{value\_str}(\|A)((\&{mp\_token\_node})(\|A))\MG\\{data}.%
\\{str}{}$\6
\8\#\&{define} ${}\\{value\_knot}(\|A)((\&{mp\_token\_node})(\|A))\MG\\{data}.%
\|p{}$\6
\8\#\&{endif}\6
\&{static} \&{void} \\{do\_set\_value\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp\_token%
\_node} \|A${},\39{}$\&{mp\_sym} \|B)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_value\_sym(\%p,\%p}\)\.{)\\n"},\39(\|A),\39(%
\|B));{}$\6
${}\|A\MG\\{data}.\\{sym}\K(\|B);{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_value\_number}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39{}$\&{mp\_number} \|B)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_value(\%p,\%s)\\n"},\39(\|A),\39\\{number%
\_tostring}(\|B));{}$\6
${}\|A\MG\\{data}.\|p\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{str}\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{node}\K\NULL;{}$\6
${}\\{number\_clone}(\|A\MG\\{data}.\|n,\39\|B);{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_value\_str}(\&{MP} \\{mp}${},\39{}$\&{mp\_token%
\_node} \|A${},\39{}$\&{mp\_string} \|B)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_value\_str(\%p,\%p}\)\.{)\\n"},\39(\|A),\39(%
\|B));{}$\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\|A\MG\\{data}.\|p\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{str}\K(\|B);{}$\6
\\{add\_str\_ref}((\|B));\6
${}\|A\MG\\{data}.\\{node}\K\NULL;{}$\6
${}\\{number\_clone}(\|A\MG\\{data}.\|n,\39\\{zero\_t});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39{}$\&{mp\_node} \|B)\1\1\2\2\6
${}\{{}$\C{ store the value in a large token node }\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_value\_node(\%p,\%}\)\.{p)\\n"},\39\|A,\39%
\|B);{}$\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\|A\MG\\{data}.\|p\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{str}\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{node}\K\|B;{}$\6
${}\\{number\_clone}(\|A\MG\\{data}.\|n,\39\\{zero\_t});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_value\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39\\{mp\_knot}\|B){}$\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_value\_knot(\%p,\%}\)\.{p)\\n"},\39(\|A),\39(%
\|B));{}$\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\|A\MG\\{data}.\|p\K(\|B);{}$\6
${}\|A\MG\\{data}.\\{str}\K\NULL;{}$\6
${}\|A\MG\\{data}.\\{node}\K\NULL;{}$\6
${}\\{number\_clone}(\|A\MG\\{data}.\|n,\39\\{zero\_t});{}$\6
\4${}\}{}$\2\par
\fi

\M{237}\B\6
\8\#\&{if} \.{DEBUG}\6
\&{static} \&{mp\_sym} \\{do\_get\_value\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A)\1\1\2\2\6
${}\{{}$\C{ \PB{$\|A\MG\\{type}$} can be structured in this case }\1\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_value\_sym(}\)\.{\%p)\\n"},\39\|A\MG%
\\{data}.\\{sym},\39\|A);{}$\6
\&{return} \|A${}\MG\\{data}.\\{sym};{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_node} \\{do\_get\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_value\_node}\)\.{(\%p)\\n"},\39\|A\MG%
\\{data}.\\{node},\39\|A);{}$\6
\&{return} \|A${}\MG\\{data}.\\{node};{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_string} \\{do\_get\_value\_str}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_value\_str(}\)\.{\%p)\\n"},\39\|A\MG%
\\{data}.\\{str},\39\|A);{}$\6
\&{return} \|A${}\MG\\{data}.\\{str};{}$\6
\4${}\}{}$\2\7
\&{static} \\{mp\_knot}\\{do\_get\_value\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_value\_knot}\)\.{(\%p)\\n"},\39\|A\MG%
\\{data}.\|p,\39\|A);{}$\6
\&{return} \|A${}\MG\\{data}.\|p;{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_number} \\{do\_get\_value\_number}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_token\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\I\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%d\ =\ get\_value\_numb}\)\.{er(\%p)\\n"},\39\|A%
\MG\\{data}.\|n.\\{type},\39\|A);{}$\6
\&{return} \|A${}\MG\\{data}.\|n;{}$\6
\4${}\}{}$\2\6
\8\#\&{endif}\par
\fi

\M{238}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\8\#\&{if} \.{DEBUG}\6
\&{static} \&{mp\_number} \\{do\_get\_value\_number}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_token\_node} \|A);\6
\&{static} \&{mp\_sym} \\{do\_get\_value\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A);\6
\&{static} \&{mp\_node} \\{do\_get\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A);\6
\&{static} \&{mp\_string} \\{do\_get\_value\_str}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A);\6
\&{static} \\{mp\_knot}\\{do\_get\_value\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A);\6
\8\#\&{endif}\6
\&{static} \&{void} \\{do\_set\_value\_sym}(\&{MP} \\{mp}${},\39{}$\&{mp\_token%
\_node} \|A${},\39{}$\&{mp\_sym} \|B);\6
\&{static} \&{void} \\{do\_set\_value\_number}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39{}$\&{mp\_number} \|B);\6
\&{static} \&{void} \\{do\_set\_value\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39{}$\&{mp\_node} \|B);\6
\&{static} \&{void} \\{do\_set\_value\_str}(\&{MP} \\{mp}${},\39{}$\&{mp\_token%
\_node} \|A${},\39{}$\&{mp\_string} \|B);\6
\&{static} \&{void} \\{do\_set\_value\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_token\_node} \|A${},\39\\{mp\_knot}\|B){}$;\par
\fi

\M{239}
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_token\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\7
\&{if} ${}(\\{mp}\MG\\{token\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp}\MG\\{token\_nodes};{}$\6
${}\\{mp}\MG\\{token\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp}\MG\\{num\_token\_nodes}\MM;{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{malloc\_node}(\\{token\_node\_size});{}$\6
${}\\{new\_number}(\|p\MG\\{data}.\|n);{}$\6
${}\|p\MG\\{has\_number}\K\T{1};{}$\6
\4${}\}{}$\2\6
${}\|p\MG\\{type}\K\\{mp\_token\_node\_type};{}$\6
${}\.{FUNCTION\_TRACE2}(\.{"\%p\ =\ mp\_get\_token\_n}\)\.{ode()\\n"},\39%
\|p);{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{240}\B\&{static} \&{void} \\{mp\_free\_token\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE2}(\.{"mp\_free\_token\_node(}\)\.{\%p)\\n"},\39\|p);{}$\6
\&{if} ${}(\R\|p){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp}\MG\\{num\_token\_nodes}<\\{max\_num\_token\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{token\_nodes};{}$\6
${}\\{mp}\MG\\{token\_nodes}\K\|p;{}$\6
${}\\{mp}\MG\\{num\_token\_nodes}\PP;{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{var\_used}\MRL{-{\K}}\\{token\_node\_size};{}$\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
\\{free\_number}(((\&{mp\_value\_node}) \|p)${}\MG\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\\{xfree}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{241}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_free\_token\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{242}A numeric token is created by the following trivial routine.

\Y\B\&{static} \&{mp\_node} \\{mp\_new\_num\_tok}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|v)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ the new node }\7
${}\|p\K\\{mp\_get\_token\_node}(\\{mp});{}$\6
${}\\{set\_value\_number}(\|p,\39\|v);{}$\6
${}\|p\MG\\{type}\K\\{mp\_known};{}$\6
${}\|p\MG\\{name\_type}\K\\{mp\_token};{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ mp\_new\_num\_tok}\)\.{(\%p)\\n"},\39\|p,%
\39\|v);{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{243}A token list is a singly linked list of nodes in \PB{\\{mem}}, where
each node contains a token and a link.  Here's a subroutine that gets rid
of a token list when it is no longer needed.

\Y\B\&{static} \&{void} \\{mp\_flush\_token\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the node being recycled }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_flush\_token\_list}\)\.{(\%p)\\n"},\39\|p);{}$\6
\&{while} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_symbol\_node}){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\|q))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_known}:\5
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
\\{delete\_str\_ref}(\\{value\_str}(\|q));\6
\&{break};\6
\4\&{case} \\{unknown\_types}:\5
\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_picture\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\5
${}\\{mp\_recycle\_value}(\\{mp},\39\|q);{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_confusion}(\\{mp},\39\.{"token"});{}$\6
;\6
\4${}\}{}$\2\6
${}\\{mp\_free\_token\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{244}The procedure \PB{\\{show\_token\_list}}, which prints a symbolic form
of
the token list that starts at a given node \PB{\|p}, illustrates these
conventions. The token list being displayed should not begin with a reference
count.

An additional parameter \PB{\|q} is also given; this parameter is either NULL
or it points to a node in the token list where a certain magic computation
takes place that will be explained later. (Basically, \PB{\|q} is non-NULL when
we are printing the two-line context information at the time of an error
message; \PB{\|q} marks the place corresponding to where the second line
should begin.)

The generation will stop, and `\.{\char`\ ETC.}' will be printed, if the length
of printing exceeds a given limit~\PB{\|l}; the length of printing upon entry
is
assumed to be a given amount called \PB{\\{null\_tally}}. (Note that
\PB{\\{show\_token\_list}} sometimes uses itself recursively to print
variable names within a capsule.)

Unusual entries are printed in the form of all-caps tokens
preceded by a space, e.g., `\.{\char`\ BAD}'.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_show\_token\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{mp\_node} \|q${},\39{}$\&{integer} \|l${},\39{}$%
\&{integer} \\{null\_tally});\par
\fi

\M{245}\B\&{void} \\{mp\_show\_token\_list}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p${},\39{}$\&{mp\_node} \|q${},\39{}$\&{integer} \|l${},\39{}$\&{integer} %
\\{null\_tally})\1\1\2\2\6
${}\{{}$\1\6
\&{quarterword} \\{cclass}${},{}$ \|c;\C{ the \PB{\\{char\_class}} of previous
and new tokens }\7
${}\\{cclass}\K\\{percent\_class};{}$\6
${}\\{mp}\MG\\{tally}\K\\{null\_tally};{}$\6
\&{while} ${}((\|p\I\NULL)\W(\\{mp}\MG\\{tally}<\|l)){}$\5
${}\{{}$\1\6
\&{if} ${}(\|p\E\|q){}$\5
${}\{{}$\1\6
\\{set\_trick\_count}(\,);\6
\4${}\}{}$\C{ Display token \PB{\|p} and set \PB{\|c} to its class; but \PB{%
\&{return}} if there are problems }\2\6
${}\|c\K\\{letter\_class}{}$;\C{ the default }\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_symbol\_node}){}$\5
${}\{{}$\C{ Display non-symbolic token }\1\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_token}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\C{ Display a numeric token }\1\6
\&{if} ${}(\\{cclass}\E\\{digit\_class}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
\&{if} (\\{number\_negative}(\\{value\_number}(\|p)))\5
${}\{{}$\1\6
\&{if} ${}(\\{cclass}\E\\{mp\_left\_bracket\_class}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'['}));{}$\6
\\{print\_number}(\\{value\_number}(\|p));\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{']'}));{}$\6
${}\|c\K\\{mp\_right\_bracket\_class};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{print\_number}(\\{value\_number}(\|p));\6
${}\|c\K\\{digit\_class};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ BAD"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{value\_str}(\|p));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
${}\|c\K\\{string\_class};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp\_name\_type}(\|p)\I\\{mp\_capsule})\V(\\{mp\_type}(%
\|p)<\\{mp\_vacuous})\V(\\{mp\_type}(\|p)>\\{mp\_independent})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ BAD"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_capsule}(\\{mp},\39\|p);{}$\6
${}\|c\K\\{right\_paren\_class};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_expr\_sym}\V\\{mp\_name\_type}(\|p)%
\E\\{mp\_suffix\_sym}\V\\{mp\_name\_type}(\|p)\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
\&{integer} \|r;\C{ temporary register }\7
${}\|r\K\\{mp\_sym\_info}(\|p);{}$\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_expr\_sym}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"(EXPR"});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_suffix\_sym}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"(SUFFIX"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"(TEXT"});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_int}(\\{mp},\39\|r);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
${}\|c\K\\{right\_paren\_class};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_sym} \\{sr}${}\K\\{mp\_sym\_sym}(\|p);{}$\7
\&{if} ${}(\\{sr}\E\\{collective\_subscript}){}$\5
${}\{{}$\C{ Display a collective subscript }\1\6
\&{if} ${}(\\{cclass}\E\\{mp\_left\_bracket\_class}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"[]"});{}$\6
${}\|c\K\\{mp\_right\_bracket\_class};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_string} \\{rr}${}\K\\{text}(\\{sr});{}$\7
\&{if} ${}(\\{rr}\E\NULL\V\\{rr}\MG\\{str}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ NONEXISTENT"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Print string \PB{\|r} as a symbolic token and set \PB{\|c} to its
class }\1\6
${}\|c\K{}$(\&{quarterword}) \\{mp}${}\MG\\{char\_class}[(\\{rr}\MG\\{str}[%
\T{0}])];{}$\6
\&{if} ${}(\|c\E\\{cclass}){}$\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{letter\_class}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'.'}));{}$\6
\&{break};\6
\4\&{case} \\{isolated\_classes}:\5
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_print\_str}(\\{mp},\39\\{rr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{cclass}\K\|c;{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\I\NULL){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\ ETC."});{}$\2\6
\&{return};\6
\4${}\}{}$\2\par
\fi

\M{246}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_capsule}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p);\par
\fi

\M{247}\B\X247:Declare miscellaneous procedures that were declared \PB{%
\\{forward}}\X${}\E{}$\6
\&{void} \\{mp\_print\_capsule}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1\1\2%
\2\6
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\|p,\39\T{0});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\U1285.\fi

\M{248}Macro definitions are kept in \MP's memory in the form of token lists
that have a few extra symbolic nodes at the beginning.

The first node contains a reference count that is used to tell when the
list is no longer needed. To emphasize the fact that a reference count is
present, we shall refer to the \PB{\\{sym\_info}} field of this special node as
the
\PB{\\{ref\_count}} field.

The next node or nodes after the reference count serve to describe the
formal parameters. They consist of zero or more parameter tokens followed
by a code for the type of macro.

/* reference count preceding a macro definition or picture header */
\Y\B\4\D$\\{ref\_count}(\|A)$ \5
\\{indep\_value}(\|A)\par
\B\4\D$\\{set\_ref\_count}(\|A,\|B)$ \5
$\\{set\_indep\_value}(\|A,\39\|B{}$)\par
\B\4\D$\\{add\_mac\_ref}(\|A)$ \5
$\\{set\_ref\_count}((\|A),\39\\{ref\_count}((\|A))+\T{1}{}$)\C{ make a new
reference to a macro list }\par
\B\4\D$\\{decr\_mac\_ref}(\|A)$ \5
$\\{set\_ref\_count}((\|A),\39\\{ref\_count}((\|A))-\T{1}{}$)\C{ remove a
reference to a macro list }\par
\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{mp\_general\_macro},{}$\C{ preface to a macro defined with a parameter
list }\6
\\{mp\_primary\_macro}${},{}$\C{ preface to a macro with a \&{primary}
parameter }\6
\\{mp\_secondary\_macro}${},{}$\C{ preface to a macro with a \&{secondary}
parameter }\6
\\{mp\_tertiary\_macro}${},{}$\C{ preface to a macro with a \&{tertiary}
parameter }\6
\\{mp\_expr\_macro}${},{}$\C{ preface to a macro with an undelimited \&{expr}
parameter }\6
\\{mp\_of\_macro}${},{}$\C{ preface to a macro with undelimited `\&{expr} \PB{%
\|x} \&{of}~\PB{\|y}' parameters }\6
\\{mp\_suffix\_macro}${},{}$\C{ preface to a macro with an undelimited %
\&{suffix} parameter }\6
\\{mp\_text\_macro}${},{}$\C{ preface to a macro with an undelimited \&{text}
parameter }\6
\\{mp\_expr\_param}${},{}$\C{ used by \.{expr} primitive }\6
\\{mp\_suffix\_param}${},{}$\C{ used by \.{suffix} primitive }\6
\\{mp\_text\_param}\C{ used by \.{text} primitive }\2\6
${}\}{}$ \&{mp\_macro\_info};\par
\fi

\M{249}\B\&{static} \&{void} \\{mp\_delete\_mac\_ref}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\C{ \PB{\|p} points to the reference count of a macro list that is
losing one reference }\1\6
\&{if} ${}(\\{ref\_count}(\|p)\E\T{0}){}$\1\5
${}\\{mp\_flush\_token\_list}(\\{mp},\39\|p);{}$\2\6
\&{else}\1\5
\\{decr\_mac\_ref}(\|p);\2\6
\4${}\}{}$\2\par
\fi

\M{250}The following subroutine displays a macro, given a pointer to its
reference count.

\Y\B\&{static} \&{void} \\{mp\_show\_macro}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p${},\39{}$\&{mp\_node} \|q${},\39{}$\&{integer} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|r;\C{ temporary storage }\7
${}\|p\K\\{mp\_link}(\|p){}$;\C{ bypass the reference count }\6
\&{while} ${}(\\{mp\_name\_type}(\|p)\I\\{mp\_macro\_sym}){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp\_link}(\|p);{}$\6
${}\\{mp\_link}(\|p)\K\NULL;{}$\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\|p,\39\NULL,\39\|l,\39\T{0});{}$\6
${}\\{mp\_link}(\|p)\K\|r;{}$\6
${}\|p\K\|r;{}$\6
\&{if} ${}(\|l>\T{0}){}$\1\5
${}\|l\K\|l-\\{mp}\MG\\{tally};{}$\2\6
\&{else}\1\5
\&{return};\2\6
\4${}\}{}$\C{ control printing of `\.{ETC.}' }\2\6
;\6
${}\\{mp}\MG\\{tally}\K\T{0};{}$\6
\&{switch} (\\{mp\_sym\_info}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_general\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"->"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_primary\_macro}:\5
\&{case} \\{mp\_secondary\_macro}:\5
\&{case} \\{mp\_tertiary\_macro}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'<'}));{}$\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{mp\_param\_type},\39\\{mp\_sym\_info}(%
\|p));{}$\6
${}\\{mp\_print}(\\{mp},\39\.{">->"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_expr\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<expr>->"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_of\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<expr>of<primary>->}\)\.{"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_suffix\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<suffix>->"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_text\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"<text>->"});{}$\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{mp\_link}(\|p),\39\|q,\39\|l-\\{mp}%
\MG\\{tally},\39\T{0});{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{251}Data structures for variables.
The variables of \MP\ programs can be simple, like `\.x', or they can
combine the structural properties of arrays and records, like `\.{x20a.b}'.
A \MP\ user assigns a type to a variable like \.{x20a.b} by saying, for
example, `\.{boolean} \.{x[]a.b}'. It's time for us to study how such
things are represented inside of the computer.

Each variable value occupies two consecutive words, either in a non-symbolic
node called a value node, or as a non-symbolic subfield of a larger node.  One
of those two words is called the \PB{\\{value}} field; it is an integer,
containing either a \PB{\\{scaled}} numeric value or the representation of some
other type of quantity. (It might also be subdivided into halfwords, in
which case it is referred to by other names instead of \PB{\\{value}}.) The
other
word is broken into subfields called \PB{\\{type}}, \PB{\\{name\_type}}, and %
\PB{\\{link}}.  The
\PB{\\{type}} field is a quarterword that specifies the variable's type, and
\PB{\\{name\_type}} is a quarterword from which \MP\ can reconstruct the
variable's name (sometimes by using the \PB{\\{link}} field as well).  Thus,
only
1.25 words are actually devoted to the value itself; the other
three-quarters of a word are overhead, but they aren't wasted because they
allow \MP\ to deal with sparse arrays and to provide meaningful diagnostics.

In this section we shall be concerned only with the structural aspects of
variables, not their values. Later parts of the program will change the
\PB{\\{type}} and \PB{\\{value}} fields, but we shall treat those fields as
black boxes
whose contents should not be touched.

However, if the \PB{\\{type}} field is \PB{\\{mp\_structured}}, there is no %
\PB{\\{value}} field,
and the second word is broken into two pointer fields called \PB{\\{attr%
\_head}}
and \PB{\\{subscr\_head}}. Those fields point to additional nodes that
contain structural information, as we shall see.

TH Note: DEK and JDH had a nice theoretical split between \PB{\\{value}},
\PB{\\{attr}} and \PB{\\{subscr}} nodes, as documented above and further
below. However, all three types had a bad habit of transmuting into
each other in practice while pointers to them still lived on
elsewhere, so using three different C structures is simply not
workable. All three are now represented as a single C structure called
\PB{\&{mp\_value\_node}}.

There is a potential union in this structure in the interest of space
saving: \PB{\\{subscript\_}} and \PB{\\{hashloc\_}} are mutually exclusive.

Actually, so are \PB{\\{attr\_head\_}} + \PB{\\{subscr\_head\_}} on one side
and and
\PB{\\{value\_}} on the other, but because of all the access macros that are
used in the code base to get at values, those cannot be folded into a
union (yet); this would have required creating a similar union in
\PB{\&{mp\_token\_node}} where it would only serve to confuse things.

Finally, \PB{\\{parent\_}} only applies in \PB{\\{attr}} nodes (the ones that
have
\PB{\\{hashloc\_}}), but creating an extra substructure inside the union just
for that does not save space and the extra complication in the
structure is not worth the minimal extra code clarification.

\Y\B\4\D$\\{attr\_head}(\|A)$ \5
$\\{do\_get\_attr\_head}(\\{mp},\39(\&{mp\_value\_node})(\|A){}$)\par
\B\4\D$\\{set\_attr\_head}(\|A,\|B)$ \5
$\\{do\_set\_attr\_head}(\\{mp},\39(\&{mp\_value\_node})(\|A),\39(\&{mp%
\_node})(\|B){}$)\par
\B\4\D$\\{subscr\_head}(\|A)$ \5
$\\{do\_get\_subscr\_head}(\\{mp},\39(\&{mp\_value\_node})(\|A){}$)\par
\B\4\D$\\{set\_subscr\_head}(\|A,\|B)$ \5
$\\{do\_set\_subscr\_head}(\\{mp},\39(\&{mp\_value\_node})(\|A),\39(\&{mp%
\_node})(\|B){}$)\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_value\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_value\_data} \\{data};\6
\&{mp\_number} \\{subscript\_};\6
\&{mp\_sym} \\{hashloc\_};\6
\&{mp\_node} \\{parent\_};\6
\&{mp\_node} \\{attr\_head\_};\6
\&{mp\_node} \\{subscr\_head\_};\2\6
${}\}{}$ \&{mp\_value\_node\_data};\par
\fi

\M{252}\B\&{static} \&{mp\_node} \\{do\_get\_attr\_head}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_value\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\E\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_attr\_head(}\)\.{\%p)\\n"},\39\|A\MG%
\\{attr\_head\_},\39\|A);{}$\6
\&{return} \|A${}\MG\\{attr\_head\_};{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_node} \\{do\_get\_subscr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}(\|A\MG\\{type}\E\\{mp\_structured});{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ get\_subscr\_hea}\)\.{d(\%p)\\n"},\39\|A\MG%
\\{subscr\_head\_},\39\|A);{}$\6
\&{return} \|A${}\MG\\{subscr\_head\_};{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_attr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A${},\39{}$\&{mp\_node} \|d)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE4}(\.{"set\_attr\_head(\%p,\%p}\)\.{)\ on\ line\ \%d\\n"},%
\39(\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}\\{assert}(\|A\MG\\{type}\E\\{mp\_structured});{}$\6
${}\|A\MG\\{attr\_head\_}\K\|d;{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_subscr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A${},\39{}$\&{mp\_node} \|d)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE4}(\.{"set\_subscr\_head(\%p,}\)\.{\%p)\ on\ line\ \%d%
\\n"},\39(\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}\\{assert}(\|A\MG\\{type}\E\\{mp\_structured});{}$\6
${}\|A\MG\\{subscr\_head\_}\K\|d;{}$\6
\4${}\}{}$\2\par
\fi

\M{253}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{do\_get\_subscr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A);\6
\&{static} \&{mp\_node} \\{do\_get\_attr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A);\6
\&{static} \&{void} \\{do\_set\_attr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A${},\39{}$\&{mp\_node} \|d);\6
\&{static} \&{void} \\{do\_set\_subscr\_head}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A${},\39{}$\&{mp\_node} \|d);\par
\fi

\M{254}It would have been nicer to make \PB{\\{mp\_get\_value\_node}} return
\PB{\&{mp\_value\_node}} variables, but with \PB{\\{eqtb}} as it stands that
became messy: lots of typecasts. So, it returns a simple
\PB{\&{mp\_node}} for now.

\Y\B\4\D$\\{value\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_value\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_value\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p;\7
\&{if} ${}(\\{mp}\MG\\{value\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{value\_nodes};{}$\6
${}\\{mp}\MG\\{value\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp}\MG\\{num\_value\_nodes}\MM;{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{malloc\_node}(\\{value\_node\_size});{}$\6
${}\\{new\_number}(\|p\MG\\{data}.\|n);{}$\6
${}\\{new\_number}(\|p\MG\\{subscript\_});{}$\6
${}\|p\MG\\{has\_number}\K\T{2};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_value\_node\_type};{}$\6
${}\.{FUNCTION\_TRACE2}(\.{"\%p\ =\ mp\_get\_value\_n}\)\.{ode()\\n"},\39%
\|p);{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\6
\8\#\&{if} ${}\.{DEBUG}>\T{1}{}$\7
\&{static} \&{void} \\{debug\_dump\_value\_node}(\&{mp\_node} \|x)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \\{qq}${}\K{}$(\&{mp\_value\_node}) \|x;\7
${}\\{fprintf}(\\{stdout},\39\.{"\\nnode\ \%p:\\n"},\39\\{qq});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ type=\%s\\n"},\39\\{mp\_type\_string}(%
\\{qq}\MG\\{type}));{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ name\_type=\%d\\n"},\39\\{qq}\MG\\{name%
\_type});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ link=\%p\\n"},\39\\{qq}\MG\\{link});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.n=\%d\\n"},\39\\{qq}\MG\\{data}.\|n.%
\\{type});{}$\6
\&{if} ${}(\\{is\_number}(\\{qq}\MG\\{data}.\|n)){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ data.n.data.val}\)\.{=\%d\\n"},\39%
\\{qq}\MG\\{data}.\|n.\\{data}.\\{val});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ data.n.data.dva}\)\.{l=\%f\\n"},\39%
\\{qq}\MG\\{data}.\|n.\\{data}.\\{dval});{}$\6
\4${}\}{}$\2\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.str=\%p\\n"},\39\\{qq}\MG\\{data}.%
\\{str});{}$\6
\&{if} ${}(\\{qq}\MG\\{data}.\\{str}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ data.str->len=\%}\)\.{d\\n"},\39{}$(%
\&{int}) \\{qq}${}\MG\\{data}.\\{str}\MG\\{len});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ data.str->str=\%}\)\.{s\\n"},\39\\{qq}%
\MG\\{data}.\\{str}\MG\\{str});{}$\6
\4${}\}{}$\2\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.indep.serial}\)\.{=\%d\\n\ \
data.indep.sc}\)\.{ale=\%d\\n"},\39\\{qq}\MG\\{data}.\\{indep}.\\{serial},\39%
\\{qq}\MG\\{data}.\\{indep}.\\{scale});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.sym=\%p\\n"},\39\\{qq}\MG\\{data}.%
\\{sym});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.p=\%p\\n"},\39\\{qq}\MG\\{data}.%
\|p);{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ data.node=\%p\\n"},\39\\{qq}\MG\\{data}.%
\\{node});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ subscript=\%d\\n"},\39\\{qq}\MG%
\\{subscript\_}.\\{type});{}$\6
\&{if} ${}(\\{is\_number}(\\{qq}\MG\\{subscript\_})){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ subscript\_.data}\)\.{.val=\%d\\n"},%
\39\\{qq}\MG\\{subscript\_}.\\{data}.\\{val});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ \ \ subscript\_.data}\)\.{.dval=\%f\\n"},%
\39\\{qq}\MG\\{subscript\_}.\\{data}.\\{dval});{}$\6
\4${}\}{}$\2\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ hashloc=\%p\\n"},\39\\{qq}\MG\\{hashloc%
\_});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ parent=\%p\\n"},\39\\{qq}\MG\\{parent%
\_});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ attr\_head=\%p\\n"},\39\\{qq}\MG\\{attr%
\_head\_});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"\ \ subscr\_head=\%p\\n\\}\)\.{n"},\39\\{qq}%
\MG\\{subscr\_head\_});{}$\6
\4${}\}{}$\2\6
\8\#\&{endif}\par
\fi

\M{255}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{mp\_get\_value\_node}(\&{MP} \\{mp});\6
\8\#\&{if} ${}\.{DEBUG}>\T{1}{}$\6
\&{static} \&{void} \\{debug\_dump\_value\_node}(\&{mp\_node} \|x);\6
\8\#\&{endif}\par
\fi

\M{256}An attribute node is three words long. Two of these words contain \PB{%
\\{type}}
and \PB{\\{value}} fields as described above, and the third word contains
additional information:  There is an \PB{\\{hashloc}} field, which contains the
hash address of the token that names this attribute; and there's also a
\PB{\\{parent}} field, which points to the value node of \PB{\\{mp%
\_structured}} type at the
next higher level (i.e., at the level to which this attribute is
subsidiary).  The \PB{\\{name\_type}} in an attribute node is `\PB{\\{attr}}'.
The
\PB{\\{link}} field points to the next attribute with the same parent; these
are
arranged in increasing order, so that \PB{$\\{hashloc}(\\{mp\_link}(\|p))>%
\\{hashloc}(\|p)$}. The
final attribute node links to the constant \PB{\\{end\_attr}}, whose \PB{%
\\{hashloc}}
field is greater than any legal hash address. The \PB{\\{attr\_head}} in the
parent points to a node whose \PB{\\{name\_type}} is \PB{\\{mp\_structured%
\_root}}; this
node represents the NULL attribute, i.e., the variable that is relevant
when no attributes are attached to the parent. The \PB{\\{attr\_head}} node
has the fields of either
a value node, a subscript node, or an attribute node, depending on what
the parent would be if it were not structured; but the subscript and
attribute fields are ignored, so it effectively contains only the data of
a value node. The \PB{\\{link}} field in this special node points to an
attribute
node whose \PB{\\{hashloc}} field is zero; the latter node represents a
collective
subscript `\.{[]}' attached to the parent, and its \PB{\\{link}} field points
to
the first non-special attribute node (or to \PB{\\{end\_attr}} if there are
none).

A subscript node likewise occupies three words, with \PB{\\{type}} and \PB{%
\\{value}} fields
plus extra information; its \PB{\\{name\_type}} is \PB{\\{subscr}}. In this
case the
third word is called the \PB{\\{subscript}} field, which is a \PB{\\{scaled}}
integer.
The \PB{\\{link}} field points to the subscript node with the next larger
subscript, if any; otherwise the \PB{\\{link}} points to the attribute node
for collective subscripts at this level. We have seen that the latter node
contains an upward pointer, so that the parent can be deduced.

The \PB{\\{name\_type}} in a parent-less value node is \PB{\\{root}}, and the %
\PB{\\{link}}
is the hash address of the token that names this value.

In other words, variables have a hierarchical structure that includes
enough threads running around so that the program is able to move easily
between siblings, parents, and children. An example should be helpful:
(The reader is advised to draw a picture while reading the following
description, since that will help to firm up the ideas.)
Suppose that `\.x' and `\.{x.a}' and `\.{x[]b}' and `\.{x5}'
and `\.{x20b}' have been mentioned in a user's program, where
\.{x[]b} has been declared to be of \&{boolean} type. Let \PB{\|h(\|x)}, \PB{%
\|h(\|a)},
and \PB{\|h(\|b)} be the hash addresses of \.x, \.a, and~\.b. Then
\PB{$\\{eq\_type}(\|h(\|x))\K\\{name}$} and \PB{$\\{equiv}(\|h(\|x))\K\|p$},
where \PB{\|p}~is a non-symbolic value
node with \PB{$\\{mp\_name\_type}(\|p)\K\\{root}$} and \PB{$\\{mp\_link}(\|p)\K%
\|h(\|x)$}. We have \PB{$\\{type}(\|p)\K\\{mp\_structured}$},
\PB{$\\{attr\_head}(\|p)\K\|q$}, and \PB{$\\{subscr\_head}(\|p)\K\|r$}, where %
\PB{\|q} points to a value
node and \PB{\|r} to a subscript node. (Are you still following this? Use
a pencil to draw a diagram.) The lone variable `\.x' is represented by
\PB{\\{type}(\|q)} and \PB{\\{value}(\|q)}; furthermore
\PB{$\\{mp\_name\_type}(\|q)\K\\{mp\_structured\_root}$} and \PB{$\\{mp\_link}(%
\|q)\K\\{q1}$}, where \PB{\\{q1}} points
to an attribute node representing `\.{x[]}'. Thus \PB{$\\{mp\_name\_type}(%
\\{q1})\K\\{attr}$},
\PB{$\\{hashloc}(\\{q1})\K\\{collective\_subscript}\K\T{0}$}, \PB{$\\{parent}(%
\\{q1})\K\|p$},
\PB{$\\{type}(\\{q1})\K\\{mp\_structured}$}, \PB{$\\{attr\_head}(\\{q1})\K%
\\{qq}$}, and \PB{$\\{subscr\_head}(\\{q1})\K\\{qq1}$};
\PB{\\{qq}} is a  three-word ``attribute-as-value'' node with \PB{$\\{type}(%
\\{qq})\K\\{numeric\_type}$}
(assuming that \.{x5} is numeric, because \PB{\\{qq}} represents `\.{x[]}'
with no further attributes), \PB{$\\{mp\_name\_type}(\\{qq})\K\\{structured%
\_root}$},
\PB{$\\{hashloc}(\\{qq})\K\T{0}$}, \PB{$\\{parent}(\\{qq})\K\|p$}, and
\PB{$\\{mp\_link}(\\{qq})\K\\{qq1}$}. (Now pay attention to the next part.)
Node \PB{\\{qq1}} is
an attribute node representing `\.{x[][]}', which has never yet
occurred; its \PB{\\{type}} field is \PB{\\{undefined}}, and its \PB{\\{value}}
field is
undefined. We have \PB{$\\{mp\_name\_type}(\\{qq1})\K\\{attr}$}, \PB{$%
\\{hashloc}(\\{qq1})\K\\{collective\_subscript}$},
\PB{$\\{parent}(\\{qq1})\K\\{q1}$}, and \PB{$\\{mp\_link}(\\{qq1})\K\\{qq2}$}.
Since \PB{\\{qq2}} represents
`\.{x[]b}', \PB{$\\{type}(\\{qq2})\K\\{mp\_unknown\_boolean}$}; also \PB{$%
\\{hashloc}(\\{qq2})\K\|h(\|b)$},
\PB{$\\{parent}(\\{qq2})\K\\{q1}$}, \PB{$\\{mp\_name\_type}(\\{qq2})\K%
\\{attr}$}, \PB{$\\{mp\_link}(\\{qq2})\K\\{end\_attr}$}.
(Maybe colored lines will help untangle your picture.)
Node \PB{\|r} is a subscript node with \PB{\\{type}} and \PB{\\{value}}
representing `\.{x5}'; \PB{$\\{mp\_name\_type}(\|r)\K\\{subscr}$}, \PB{$%
\\{subscript}(\|r)\K\T{5.0}$},
and \PB{$\\{mp\_link}(\|r)\K\\{r1}$} is another subscript node. To complete the
picture,
see if you can guess what \PB{\\{mp\_link}(\\{r1})} is; give up? It's~\PB{%
\\{q1}}.
Furthermore \PB{$\\{subscript}(\\{r1})\K\T{20.0}$}, \PB{$\\{mp\_name\_type}(%
\\{r1})\K\\{subscr}$},
\PB{$\\{type}(\\{r1})\K\\{mp\_structured}$}, \PB{$\\{attr\_head}(\\{r1})\K%
\\{qqq}$}, \PB{$\\{subscr\_head}(\\{r1})\K\\{qqq1}$},
and we finish things off with three more nodes
\PB{\\{qqq}}, \PB{\\{qqq1}}, and \PB{\\{qqq2}} hung onto~\PB{\\{r1}}. (Perhaps
you should start again
with a larger sheet of paper.) The value of variable \.{x20b}
appears in node~\PB{\\{qqq2}}, as you can well imagine.

If the example in the previous paragraph doesn't make things crystal
clear, a glance at some of the simpler subroutines below will reveal how
things work out in practice.

The only really unusual thing about these conventions is the use of
collective subscript attributes. The idea is to avoid repeating a lot of
type information when many elements of an array are identical macros
(for which distinct values need not be stored) or when they don't have
all of the possible attributes. Branches of the structure below collective
subscript attributes do not carry actual values except for macro identifiers;
branches of the structure below subscript nodes do not carry significant
information in their collective subscript attributes.


\Y\B\8\#\&{if} \.{DEBUG}\6
\8\#\&{define} \\{hashloc}(\|A)\\{do\_get\_hashloc} \5${}(\\{mp},\39(\&{mp%
\_value\_node})(\|A)){}$\6
\8\#\&{define} ${}\\{set\_hashloc}(\|A,\39\|B)\\{do\_set\_hashloc} \5(\\{mp},%
\39{}$(\&{mp\_value\_node}) \|A${},\39\|B){}$\6
\8\#\&{define} \\{parent}(\|A)\\{do\_get\_parent} \5${}(\\{mp},\39\|A){}$\6
\8\#\&{define} ${}\\{set\_parent}(\|A,\39\|B)\\{do\_set\_parent} \5(\\{mp},%
\39{}$(\&{mp\_value\_node}) \|A${},\39\|B){}$\6
\&{static} \&{mp\_sym} \\{do\_get\_hashloc}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}((\|A)\MG\\{type}\E\\{mp\_attr\_node\_type}\V(\|A)\MG\\{name%
\_type}\E\\{mp\_attr});{}$\6
\&{return} (\|A)${}\MG\\{hashloc\_};{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_hashloc}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A${},\39{}$\&{mp\_sym} \|B)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE4}(\.{"set\_hashloc(\%p,\%p)\ }\)\.{on\ line\ \%d\\n"},%
\39(\|A),\39(\|B),\39\.{\_\_LINE\_\_});{}$\6
${}\\{assert}((\|A)\MG\\{type}\E\\{mp\_attr\_node\_type}\V(\|A)\MG\\{name%
\_type}\E\\{mp\_attr});{}$\6
${}\|A\MG\\{hashloc\_}\K\|B;{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_node} \\{do\_get\_parent}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}((\|A)\MG\\{type}\E\\{mp\_attr\_node\_type}\V(\|A)\MG\\{name%
\_type}\E\\{mp\_attr});{}$\6
\&{return} (\|A)${}\MG\\{parent\_}{}$;\C{ pointer to \PB{\\{mp\_structured}}
variable }\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_parent}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|A${},\39{}$\&{mp\_node} \|d)\1\1\2\2\6
${}\{{}$\1\6
${}\\{assert}((\|A)\MG\\{type}\E\\{mp\_attr\_node\_type}\V(\|A)\MG\\{name%
\_type}\E\\{mp\_attr});{}$\6
${}\.{FUNCTION\_TRACE4}(\.{"set\_parent(\%p,\%p)\ o}\)\.{n\ line\ \%d\\n"},\39(%
\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}\|A\MG\\{parent\_}\K\|d;{}$\6
\4${}\}{}$\2\6
\8\#\&{else}\6
\8\#\&{define} ${}\\{hashloc}(\|A)((\&{mp\_value\_node})(\|A))\MG\\{hashloc%
\_}{}$\6
\8\#\&{define} ${}\\{set\_hashloc}(\|A,\39\|B)((\&{mp\_value\_node})(\|A))\MG%
\\{hashloc\_}\K\|B{}$\6
\8\#\&{define} ${}\\{parent}(\|A)((\&{mp\_value\_node})(\|A))\MG\\{parent\_}{}$%
\6
\8\#\&{define} ${}\\{set\_parent}(\|A,\39\|B)((\&{mp\_value\_node})(\|A))\MG%
\\{parent\_}\K\|B{}$\6
\8\#\&{endif}\par
\fi

\M{257}
\Y\B\4\D$\\{mp\_free\_attr\_node}(\|a,\|b)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{assert}((\|b)\MG\\{type}\E\\{mp\_attr\_node\_type}\V(\|b)\MG\\{name%
\_type}\E\\{mp\_attr});{}$\6
${}\\{mp\_free\_value\_node}(\|a,\39\|b);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{mp\_value\_node} \\{mp\_get\_attr\_node}(\&{MP} \\{mp})\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p${}\K{}$(\&{mp\_value\_node}) \\{mp\_get\_value\_node}(%
\\{mp});\7
${}\\{mp\_type}(\|p)\K\\{mp\_attr\_node\_type};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{258}Setting the \PB{\\{hashloc}} field of \PB{\\{end\_attr}} to a value
greater than
any legal hash address is done by assigning $-1$ typecasted to
\PB{\&{mp\_sym}}, hopefully resulting in all bits being set. On systems that
support negative pointer values or where typecasting $-1$ does not
result in all bits in a pointer being set, something else needs to be done.

\Y\B\4\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{end\_attr}\K{}$(\&{mp\_node}) \\{mp\_get\_attr\_node}(\\{mp});\6
${}\\{set\_hashloc}(\\{mp}\MG\\{end\_attr},\39{}$(\&{mp\_sym}) ${}{-}\T{1});{}$%
\6
\\{set\_parent}((\&{mp\_value\_node}) \\{mp}${}\MG\\{end\_attr},\39\NULL){}$;%
\par
\fi

\M{259}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_attr\_node}(\\{mp},\39\\{mp}\MG\\{end\_attr}){}$;\par
\fi

\M{260}
\Y\B\4\D$\\{collective\_subscript}$ \5
(\&{void} ${}{*}){}$ \T{0}\C{ code for the attribute `\.{[]}' }\par
\B\4\D$\\{subscript}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG{}$\\{subscript\_}\par
\B\4\D$\\{set\_subscript}(\|A,\|B)$ \5
$\\{do\_set\_subscript}(\\{mp},\39(\&{mp\_value\_node})(\|A),\39\|B{}$)\par
\Y\B\&{static} \&{void} \\{do\_set\_subscript}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|A${},\39{}$\&{mp\_number} \|B)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_subscript(\%p,\%p}\)\.{)\\n"},\39(\|A),\39(%
\|B));{}$\6
${}\\{assert}((\|A)\MG\\{type}\E\\{mp\_subscr\_node\_type}\V(\|A)\MG\\{name%
\_type}\E\\{mp\_subscr});{}$\6
${}\\{number\_clone}(\|A\MG\\{subscript\_},\39\|B){}$;\C{ subscript of this
variable }\6
\4${}\}{}$\2\par
\fi

\M{261}
\Y\B\&{static} \&{mp\_value\_node} \\{mp\_get\_subscr\_node}(\&{MP} \\{mp})\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p${}\K{}$(\&{mp\_value\_node}) \\{mp\_get\_value\_node}(%
\\{mp});\7
${}\\{mp\_type}(\|p)\K\\{mp\_subscr\_node\_type};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{262}Variables of type \&{pair} will have values that point to four-word
nodes containing two numeric values. The first of these values has
\PB{$\\{name\_type}\K\\{mp\_x\_part\_sector}$} and the second has \PB{$\\{name%
\_type}\K\\{mp\_y\_part\_sector}$};
the \PB{\\{link}} in the first points back to the node whose \PB{\\{value}}
points
to this four-word node.

\Y\B\4\D$\\{x\_part}(\|A)$ \5
$((\\{mp\_pair\_node})(\|A))\MG{}$\\{x\_part\_}\C{ where the \&{xpart} is found
in a pair node }\par
\B\4\D$\\{y\_part}(\|A)$ \5
$((\\{mp\_pair\_node})(\|A))\MG{}$\\{y\_part\_}\C{ where the \&{ypart} is found
in a pair node }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_pair\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_node} \\{x\_part\_};\6
\&{mp\_node} \\{y\_part\_};\2\6
${}\}{}$ \&{mp\_pair\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_pair\_node\_data} ${}{*}\&{mp\_pair\_node}{}$;\par
\fi

\M{263}
\Y\B\4\D$\\{pair\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_pair\_node\_data})\C{ the number of words in a
subscript node }\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_pair\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\7
\&{if} ${}(\\{mp}\MG\\{pair\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp}\MG\\{pair\_nodes};{}$\6
${}\\{mp}\MG\\{pair\_nodes}\K\|p\MG\\{link};{}$\6
${}\\{mp}\MG\\{num\_pair\_nodes}\MM;{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{malloc\_node}(\\{pair\_node\_size});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_pair\_node\_type};{}$\6
${}\.{FUNCTION\_TRACE2}(\.{"get\_pair\_node():\ \%p}\)\.{\\n"},\39\|p);{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{264}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_free\_pair\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);\par
\fi

\M{265}\B\&{void} \\{mp\_free\_pair\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
${}\.{FUNCTION\_TRACE2}(\.{"mp\_free\_pair\_node(\%}\)\.{p)\\n"},\39\|p);{}$\6
\&{if} ${}(\R\|p){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp}\MG\\{num\_pair\_nodes}<\\{max\_num\_pair\_nodes}){}$\5
${}\{{}$\1\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{pair\_nodes};{}$\6
${}\\{mp}\MG\\{pair\_nodes}\K\|p;{}$\6
${}\\{mp}\MG\\{num\_pair\_nodes}\PP;{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{var\_used}\MRL{-{\K}}\\{pair\_node\_size};{}$\6
\\{xfree}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{266}If \PB{$\\{type}(\|p)\K\\{mp\_pair\_type}$} or if \PB{$\\{value}(\|p)\K%
\NULL$}, the procedure call \PB{\\{init\_pair\_node}(\|p)} will
allocate a pair node for~\PB{\|p}.  The individual parts of such nodes are
initially of type
\PB{\\{mp\_independent}}.

\Y\B\&{static} \&{void} \\{mp\_init\_pair\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the new node }\7
${}\\{mp\_type}(\|p)\K\\{mp\_pair\_type};{}$\6
${}\|q\K\\{mp\_get\_pair\_node}(\\{mp});{}$\6
${}\\{y\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{y\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{y\_part}(\|q))\K(\&{quarterword})(\\{mp\_y\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{y\_part}(\|q))\K\|p;{}$\6
${}\\{x\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{x\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{x\_part}(\|q))\K(\&{quarterword})(\\{mp\_x\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{x\_part}(\|q))\K\|p;{}$\6
${}\\{set\_value\_node}(\|p,\39\|q);{}$\6
\4${}\}{}$\2\par
\fi

\M{267}
Variables of type \&{transform} are similar, but in this case their
\PB{\\{value}} points to a 12-word node containing six values, identified by
\PB{\\{x\_part\_sector}}, \PB{\\{y\_part\_sector}}, \PB{\\{mp\_xx\_part%
\_sector}}, \PB{\\{mp\_xy\_part\_sector}},
\PB{\\{mp\_yx\_part\_sector}}, and \PB{\\{mp\_yy\_part\_sector}}.

\Y\B\4\D$\\{tx\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{tx\_part\_}\C{ where the \&{xpart} is
found in a transform node }\par
\B\4\D$\\{ty\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{ty\_part\_}\C{ where the \&{ypart} is
found in a transform node }\par
\B\4\D$\\{xx\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{xx\_part\_}\C{ where the \&{xxpart}
is found in a transform node }\par
\B\4\D$\\{xy\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{xy\_part\_}\C{ where the \&{xypart}
is found in a transform node }\par
\B\4\D$\\{yx\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{yx\_part\_}\C{ where the \&{yxpart}
is found in a transform node }\par
\B\4\D$\\{yy\_part}(\|A)$ \5
$((\\{mp\_transform\_node})(\|A))\MG{}$\\{yy\_part\_}\C{ where the \&{yypart}
is found in a transform node }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_transform\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_node} \\{tx\_part\_};\6
\&{mp\_node} \\{ty\_part\_};\6
\&{mp\_node} \\{xx\_part\_};\6
\&{mp\_node} \\{yx\_part\_};\6
\&{mp\_node} \\{xy\_part\_};\6
\&{mp\_node} \\{yy\_part\_};\2\6
${}\}{}$ \&{mp\_transform\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_transform\_node\_data} ${}{*}\&{mp\_transform%
\_node}{}$;\par
\fi

\M{268}
\Y\B\4\D$\\{transform\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_transform\_node\_data})\C{ the number of words in
a subscript node }\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_transform\_node}(\&{MP} \\{mp})\1\1\2\2%
\6
${}\{{}$\1\6
\&{mp\_transform\_node} \|p${}\K{}$(\&{mp\_transform\_node}) \\{malloc\_node}(%
\\{transform\_node\_size});\7
${}\\{mp\_type}(\|p)\K\\{mp\_transform\_node\_type};{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{269}\B\&{static} \&{void} \\{mp\_init\_transform\_node}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the new node }\7
${}\\{mp\_type}(\|p)\K\\{mp\_transform\_type};{}$\6
${}\|q\K\\{mp\_get\_transform\_node}(\\{mp}){}$;\C{ big node }\6
${}\\{yy\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{yy\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{yy\_part}(\|q))\K(\&{quarterword})(\\{mp\_yy\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{yy\_part}(\|q))\K\|p;{}$\6
${}\\{yx\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{yx\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{yx\_part}(\|q))\K(\&{quarterword})(\\{mp\_yx\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{yx\_part}(\|q))\K\|p;{}$\6
${}\\{xy\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{xy\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{xy\_part}(\|q))\K(\&{quarterword})(\\{mp\_xy\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{xy\_part}(\|q))\K\|p;{}$\6
${}\\{xx\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{xx\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{xx\_part}(\|q))\K(\&{quarterword})(\\{mp\_xx\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{xx\_part}(\|q))\K\|p;{}$\6
${}\\{ty\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{ty\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{ty\_part}(\|q))\K(\&{quarterword})(\\{mp\_y\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{ty\_part}(\|q))\K\|p;{}$\6
${}\\{tx\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{tx\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{tx\_part}(\|q))\K(\&{quarterword})(\\{mp\_x\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{tx\_part}(\|q))\K\|p;{}$\6
${}\\{set\_value\_node}(\|p,\39\|q);{}$\6
\4${}\}{}$\2\par
\fi

\M{270}
Variables of type \&{color} have 3~values in 6~words identified by \PB{\\{mp%
\_red\_part\_sector}},
\PB{\\{mp\_green\_part\_sector}}, and \PB{\\{mp\_blue\_part\_sector}}.

\Y\B\4\D$\\{red\_part}(\|A)$ \5
$((\\{mp\_color\_node})(\|A))\MG{}$\\{red\_part\_}\C{ where the \&{redpart} is
found in a color node }\par
\B\4\D$\\{green\_part}(\|A)$ \5
$((\\{mp\_color\_node})(\|A))\MG{}$\\{green\_part\_}\C{ where the \&{greenpart}
is found in a color node }\par
\B\4\D$\\{blue\_part}(\|A)$ \5
$((\\{mp\_color\_node})(\|A))\MG{}$\\{blue\_part\_}\C{ where the \&{bluepart}
is found in a color node }\par
\B\4\D$\\{grey\_part}(\|A)$ \5
\\{red\_part}(\|A)\C{ where the \&{greypart} is found in a color node }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_color\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_node} \\{red\_part\_};\6
\&{mp\_node} \\{green\_part\_};\6
\&{mp\_node} \\{blue\_part\_};\2\6
${}\}{}$ \&{mp\_color\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_color\_node\_data} ${}{*}\&{mp\_color\_node}{}$;%
\par
\fi

\M{271}
\Y\B\4\D$\\{color\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_color\_node\_data})\C{ the number of words in a
subscript node }\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_color\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_color\_node} \|p${}\K{}$(\&{mp\_color\_node}) \\{malloc\_node}(\\{color%
\_node\_size});\7
${}\\{mp\_type}(\|p)\K\\{mp\_color\_node\_type};{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{272}
\Y\B\&{static} \&{void} \\{mp\_init\_color\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the new node }\7
${}\\{mp\_type}(\|p)\K\\{mp\_color\_type};{}$\6
${}\|q\K\\{mp\_get\_color\_node}(\\{mp}){}$;\C{ big node }\6
${}\\{blue\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{blue\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{blue\_part}(\|q))\K(\&{quarterword})(\\{mp\_blue\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{blue\_part}(\|q))\K\|p;{}$\6
${}\\{green\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{green\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{y\_part}(\|q))\K(\&{quarterword})(\\{mp\_green\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{green\_part}(\|q))\K\|p;{}$\6
${}\\{red\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{red\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{red\_part}(\|q))\K(\&{quarterword})(\\{mp\_red\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{red\_part}(\|q))\K\|p;{}$\6
${}\\{set\_value\_node}(\|p,\39\|q);{}$\6
\4${}\}{}$\2\par
\fi

\M{273}Finally, variables of type \PB{\\{cmykcolor}}.

\Y\B\4\D$\\{cyan\_part}(\|A)$ \5
$((\\{mp\_cmykcolor\_node})(\|A))\MG{}$\\{cyan\_part\_}\C{ where the %
\&{cyanpart} is found in a color node }\par
\B\4\D$\\{magenta\_part}(\|A)$ \5
$((\\{mp\_cmykcolor\_node})(\|A))\MG{}$\\{magenta\_part\_}\C{ where the %
\&{magentapart} is found in a color node }\par
\B\4\D$\\{yellow\_part}(\|A)$ \5
$((\\{mp\_cmykcolor\_node})(\|A))\MG{}$\\{yellow\_part\_}\C{ where the %
\&{yellowpart} is found in a color node }\par
\B\4\D$\\{black\_part}(\|A)$ \5
$((\\{mp\_cmykcolor\_node})(\|A))\MG{}$\\{black\_part\_}\C{ where the %
\&{blackpart} is found in a color node }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_cmykcolor\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_node} \\{cyan\_part\_};\6
\&{mp\_node} \\{magenta\_part\_};\6
\&{mp\_node} \\{yellow\_part\_};\6
\&{mp\_node} \\{black\_part\_};\2\6
${}\}{}$ \&{mp\_cmykcolor\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_cmykcolor\_node\_data} ${}{*}\&{mp\_cmykcolor%
\_node}{}$;\par
\fi

\M{274}
\Y\B\4\D$\\{cmykcolor\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_cmykcolor\_node\_data})\C{ the number of words in
a subscript node }\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_cmykcolor\_node}(\&{MP} \\{mp})\1\1\2\2%
\6
${}\{{}$\1\6
\&{mp\_cmykcolor\_node} \|p${}\K{}$(\&{mp\_cmykcolor\_node}) \\{malloc\_node}(%
\\{cmykcolor\_node\_size});\7
${}\\{mp\_type}(\|p)\K\\{mp\_cmykcolor\_node\_type};{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{275}
\Y\B\&{static} \&{void} \\{mp\_init\_cmykcolor\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the new node }\7
${}\\{mp\_type}(\|p)\K\\{mp\_cmykcolor\_type};{}$\6
${}\|q\K\\{mp\_get\_cmykcolor\_node}(\\{mp}){}$;\C{ big node }\6
${}\\{black\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{black\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{black\_part}(\|q))\K(\&{quarterword})(\\{mp\_black%
\_part\_sector});{}$\6
${}\\{mp\_link}(\\{black\_part}(\|q))\K\|p;{}$\6
${}\\{yellow\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{yellow\_part}(\|q)){}$;\C{ sets \PB{%
\\{type}(\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{yellow\_part}(\|q))\K(\&{quarterword})(\\{mp\_yellow%
\_part\_sector});{}$\6
${}\\{mp\_link}(\\{yellow\_part}(\|q))\K\|p;{}$\6
${}\\{magenta\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{magenta\_part}(\|q)){}$;\C{ sets \PB{%
\\{type}(\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{magenta\_part}(\|q))\K(\&{quarterword})(\\{mp\_magenta%
\_part\_sector});{}$\6
${}\\{mp\_link}(\\{magenta\_part}(\|q))\K\|p;{}$\6
${}\\{cyan\_part}(\|q)\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{cyan\_part}(\|q)){}$;\C{ sets \PB{\\{type}(%
\|q)} and \PB{\\{value}(\|q)} }\6
${}\\{mp\_name\_type}(\\{cyan\_part}(\|q))\K(\&{quarterword})(\\{mp\_cyan\_part%
\_sector});{}$\6
${}\\{mp\_link}(\\{cyan\_part}(\|q))\K\|p;{}$\6
${}\\{set\_value\_node}(\|p,\39\|q);{}$\6
\4${}\}{}$\2\par
\fi

\M{276}When an entire structured variable is saved, the \PB{\\{root}}
indication
is temporarily replaced by \PB{\\{saved\_root}}.

Some variables have no name; they just are used for temporary storage
while expressions are being evaluated. We call them {\sl capsules}.

\fi

\M{277}The \PB{\\{id\_transform}} function creates a capsule for the
identity transformation.

\Y\B\&{static} \&{mp\_node} \\{mp\_id\_transform}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ list manipulation registers }\7
${}\|p\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_capsule};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{zero\_t}){}$;\C{ todo: this was \PB{%
\\{null}} }\6
${}\\{mp\_init\_transform\_node}(\\{mp},\39\|p);{}$\6
${}\|q\K\\{value\_node}(\|p);{}$\6
${}\\{mp\_type}(\\{tx\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{tx\_part}(\|q),\39\\{zero\_t});{}$\6
${}\\{mp\_type}(\\{ty\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{ty\_part}(\|q),\39\\{zero\_t});{}$\6
${}\\{mp\_type}(\\{xy\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{xy\_part}(\|q),\39\\{zero\_t});{}$\6
${}\\{mp\_type}(\\{yx\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{yx\_part}(\|q),\39\\{zero\_t});{}$\6
${}\\{mp\_type}(\\{xx\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{xx\_part}(\|q),\39\\{unity\_t});{}$\6
${}\\{mp\_type}(\\{yy\_part}(\|q))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{yy\_part}(\|q),\39\\{unity\_t});{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{278}Tokens are of type \PB{\\{tag\_token}} when they first appear, but they
point
to \PB{$\NULL$} until they are first used as the root of a variable.
The following subroutine establishes the root node on such grand occasions.

\Y\B\&{static} \&{void} \\{mp\_new\_root}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\|x)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ the new node }\7
${}\|p\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_undefined};{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_root};{}$\6
${}\\{set\_value\_sym}(\|p,\39\|x);{}$\6
${}\\{set\_equiv\_node}(\|x,\39\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{279}These conventions for variable representation are illustrated by the
\PB{\\{print\_variable\_name}} routine, which displays the full name of a
variable given only a pointer to its value.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_variable\_name}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{280}\B\&{void} \\{mp\_print\_variable\_name}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ a token list that will name the variable's suffix }\6
\&{mp\_node} \|r;\C{ temporary for token list creation }\7
\&{while} ${}(\\{mp\_name\_type}(\|p)\G\\{mp\_x\_part\_sector}){}$\5
${}\{{}$\1\6
\&{switch} (\\{mp\_name\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_x\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_y\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"ypart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xxpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xy\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"xypart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yx\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yxpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yy\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yypart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_red\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"redpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_green\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"greenpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_blue\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"bluepart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"cyanpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_magenta\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"magentapart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yellow\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"yellowpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_black\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"blackpart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_grey\_part\_sector}:\5
${}\\{mp\_print}(\\{mp},\39\.{"greypart\ "});{}$\6
\&{break};\6
\4\&{case} \\{mp\_capsule}:\5
${}\\{mp\_printf}(\\{mp},\39\.{"\%\%CAPSULE\%p"},\39\|p);{}$\6
\&{return};\6
\&{break};\C{ this is to please the compiler: the remaining cases are operation
codes }\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
${}\|q\K\NULL;{}$\6
\&{while} ${}(\\{mp\_name\_type}(\|p)>\\{mp\_saved\_root}){}$\5
${}\{{}$\C{ Ascend one level, pushing a token onto list \PB{\|q}        and
replacing \PB{\|p} by its parent }\1\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_subscr}){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp\_new\_num\_tok}(\\{mp},\39\\{subscript}(\|p));{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp\_name\_type}(\|p)\I\\{mp\_attr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_structured\_root}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\I\\{mp\_attr}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"var"});{}$\2\6
${}\|r\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|r,\39\\{hashloc}(\|p)){}$;\C{ the hash address }\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39\|q);{}$\6
${}\|q\K\|r;{}$\6
\4\.{FOUND}:\5
${}\|p\K\\{parent}{}$((\&{mp\_value\_node}) \|p);\6
\4${}\}{}$\C{ now \PB{\\{link}(\|p)} is the hash address of \PB{\|p}, and      %
\PB{\\{name\_type}(\|p)} is either \PB{\\{root}} or \PB{\\{saved\_root}}.
Have to prepend a token to \PB{\|q} for \PB{\\{show\_token\_list}}. }\2\6
${}\|r\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|r,\39\\{value\_sym}(\|p));{}$\6
${}\\{mp\_link}(\|r)\K\|q;{}$\6
\&{if} ${}(\\{mp\_name\_type}(\|p)\E\\{mp\_saved\_root}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"(SAVED)"});{}$\2\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\|r,\39\NULL,\39\\{max\_integer},\39%
\\{mp}\MG\\{tally});{}$\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\par
\fi

\M{281}The \PB{\\{interesting}} function returns \PB{\\{true}} if a given
variable is not
in a capsule, or if the user wants to trace capsules.

\Y\B\&{static} \&{boolean} \\{mp\_interesting}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_name\_type\_type} \|t;\C{ a \PB{\\{name\_type}} }\7
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_capsules})))\5
${}\{{}$\1\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|t\K\\{mp\_name\_type}(\|p);{}$\6
\&{if} ${}(\|t\G\\{mp\_x\_part\_sector}\W\|t\I\\{mp\_capsule}){}$\5
${}\{{}$\1\6
\&{mp\_node} \\{tt}${}\K\\{value\_node}(\\{mp\_link}(\|p));{}$\7
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_x\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{x\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_y\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{y\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{xx\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_xy\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{xy\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yx\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{yx\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yy\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{yy\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_red\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{red\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_green\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{green\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_blue\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{blue\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{cyan\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_magenta\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{magenta\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yellow\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{yellow\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_black\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{black\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_grey\_part\_sector}:\5
${}\|t\K\\{mp\_name\_type}(\\{grey\_part}(\\{tt}));{}$\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{return} ${}(\|t\I\\{mp\_capsule});{}$\6
\4${}\}{}$\2\par
\fi

\M{282}Now here is a subroutine that converts an unstructured type into an
equivalent structured type, by inserting a \PB{\\{mp\_structured}} node that is
capable of growing. This operation is done only when \PB{$\\{mp\_name\_type}(%
\|p)\K\\{root}$},
\PB{\\{subscr}}, or \PB{\\{attr}}.

The procedure returns a pointer to the new node that has taken node~\PB{\|p}'s
place in the structure. Node~\PB{\|p} itself does not move, nor are its
\PB{\\{value}} or \PB{\\{type}} fields changed in any way.

\Y\B\&{static} \&{mp\_node} \\{mp\_new\_structure}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r${}\K\NULL{}$;\C{ list manipulation registers }\6
\&{mp\_sym} \\{qq}${}\K\NULL;{}$\7
\&{switch} (\\{mp\_name\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_root}:\6
${}\{{}$\1\6
${}\\{qq}\K\\{value\_sym}(\|p);{}$\6
${}\|r\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{set\_equiv\_node}(\\{qq},\39\|r);{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_subscr}:\C{ Link a new subscript node \PB{\|r} in place of
node \PB{\|p} }\6
${}\{{}$\1\6
\&{mp\_node} \\{q\_new};\7
${}\|q\K\|p;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp\_name\_type}(\|q)\I\\{mp\_attr});{}$\6
${}\|q\K\\{parent}{}$((\&{mp\_value\_node}) \|q);\6
${}\|r\K\\{mp}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\|r,\39\\{subscr\_head}(\|q));{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{q\_new}\K\|r;{}$\6
${}\|r\K\\{mp\_link}(\|r);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|r\I\|p);{}$\6
${}\|r\K{}$(\&{mp\_node}) \\{mp\_get\_subscr\_node}(\\{mp});\6
\&{if} ${}(\\{q\_new}\E\\{mp}\MG\\{temp\_head}){}$\5
${}\{{}$\1\6
${}\\{set\_subscr\_head}(\|q,\39\|r);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\\{q\_new},\39\|r);{}$\6
\4${}\}{}$\2\6
${}\\{set\_subscript}(\|r,\39\\{subscript}(\|p));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_attr}:\C{ Link a new attribute node \PB{\|r} in place of node
\PB{\|p} }\C{ If the attribute is \PB{\\{collective\_subscript}}, there are two
pointers to        node~\PB{\|p}, so we must change both of them. }\6
${}\{{}$\1\6
\&{mp\_value\_node} \\{rr};\7
${}\|q\K\\{parent}{}$((\&{mp\_value\_node}) \|p);\6
${}\|r\K\\{attr\_head}(\|q);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\|r;{}$\6
${}\|r\K\\{mp\_link}(\|r);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|r\I\|p);{}$\6
${}\\{rr}\K\\{mp\_get\_attr\_node}(\\{mp});{}$\6
${}\|r\K{}$(\&{mp\_node}) \\{rr};\6
${}\\{set\_mp\_link}(\|q,\39{}$(\&{mp\_node}) \\{rr});\6
${}\\{set\_hashloc}(\\{rr},\39\\{hashloc}(\|p));{}$\6
${}\\{set\_parent}(\\{rr},\39{}$\\{parent}((\&{mp\_value\_node}) \|p));\6
\&{if} ${}(\\{hashloc}(\|p)\E\\{collective\_subscript}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\|q,\39{}$\\{subscr\_head}(\\{parent}((\&{mp\_value%
\_node}) \|p)));\6
\&{while} ${}(\\{mp\_link}(\|q)\I\|p){}$\1\5
${}\|q\K\\{mp\_link}(\|q);{}$\2\6
\&{if} ${}(\|q\E\\{mp}\MG\\{temp\_head}){}$\1\5
\\{set\_subscr\_head}(\\{parent}((\&{mp\_value\_node}) \|p)${},\39{}$(\&{mp%
\_node}) \\{rr});\2\6
\&{else}\1\5
${}\\{set\_mp\_link}(\|q,\39{}$(\&{mp\_node}) \\{rr});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_confusion}(\\{mp},\39\.{"struct"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39\\{mp\_link}(\|p));{}$\6
${}\\{set\_value\_sym}(\|r,\39\\{value\_sym}(\|p));{}$\6
${}\\{mp\_type}(\|r)\K\\{mp\_structured};{}$\6
${}\\{mp\_name\_type}(\|r)\K\\{mp\_name\_type}(\|p);{}$\6
${}\\{set\_attr\_head}(\|r,\39\|p);{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_structured\_root};{}$\6
${}\{{}$\1\6
\&{mp\_value\_node} \\{qqr}${}\K\\{mp\_get\_attr\_node}(\\{mp});{}$\7
${}\\{set\_mp\_link}(\|p,\39{}$(\&{mp\_node}) \\{qqr});\6
${}\\{set\_subscr\_head}(\|r,\39{}$(\&{mp\_node}) \\{qqr});\6
${}\\{set\_parent}(\\{qqr},\39\|r);{}$\6
${}\\{mp\_type}(\\{qqr})\K\\{mp\_undefined};{}$\6
${}\\{mp\_name\_type}(\\{qqr})\K\\{mp\_attr};{}$\6
${}\\{set\_mp\_link}(\\{qqr},\39\\{mp}\MG\\{end\_attr});{}$\6
${}\\{set\_hashloc}(\\{qqr},\39\\{collective\_subscript});{}$\6
\4${}\}{}$\2\6
\&{return} \|r;\6
\4${}\}{}$\2\par
\fi

\M{283}The \PB{\\{find\_variable}} routine is given a pointer~\PB{\|t} to a
nonempty token
list of suffixes; it returns a pointer to the corresponding non-symbolic
value. For example, if \PB{\|t} points to token \.x followed by a numeric
token containing the value~7, \PB{\\{find\_variable}} finds where the value of
\.{x7} is stored in memory. This may seem a simple task, and it
usually is, except when \.{x7} has never been referenced before.
Indeed, \.x may never have even been subscripted before; complexities
arise with respect to updating the collective subscript information.

If a macro type is detected anywhere along path~\PB{\|t}, or if the first
item on \PB{\|t} isn't a \PB{\\{tag\_token}}, the value \PB{$\NULL$} is
returned.
Otherwise \PB{\|p} will be a non-NULL pointer to a node such that
\PB{$\\{undefined}<\\{type}(\|p)<\\{mp\_structured}$}.

\Y\B\&{static} \&{mp\_node} \\{mp\_find\_variable}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r${},{}$ \|s;\C{ nodes in the ``value''
line }\6
\&{mp\_sym} \\{p\_sym};\6
\&{mp\_node} \\{pp}${},{}$ \\{qq}${},{}$ \\{rr}${},{}$ \\{ss};\C{ nodes in the
``collective'' line }\7
;\6
${}\\{p\_sym}\K\\{mp\_sym\_sym}(\|t);{}$\6
${}\|t\K\\{mp\_link}(\|t);{}$\6
\&{if} ${}((\\{eq\_type}(\\{p\_sym})\MOD\\{mp\_outer\_tag})\I\\{mp\_tag%
\_token}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
\&{if} ${}(\\{equiv\_node}(\\{p\_sym})\E\NULL){}$\1\5
${}\\{mp\_new\_root}(\\{mp},\39\\{p\_sym});{}$\2\6
${}\|p\K\\{equiv\_node}(\\{p\_sym});{}$\6
${}\\{pp}\K\|p;{}$\6
\&{while} ${}(\|t\I\NULL){}$\5
${}\{{}$\C{ Make sure that both nodes \PB{\|p} and \PB{\\{pp}} are of \PB{\\{mp%
\_structured}} type }\C{ Although \PB{\\{pp}} and \PB{\|p} begin together, they
diverge when a subscript occurs;        \PB{\\{pp}}~stays in the collective
line while \PB{\|p}~goes through actual subscript        values. }\1\6
\&{if} ${}(\\{mp\_type}(\\{pp})\I\\{mp\_structured}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{pp})>\\{mp\_structured}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{ss}\K\\{mp\_new\_structure}(\\{mp},\39\\{pp});{}$\6
\&{if} ${}(\|p\E\\{pp}){}$\1\5
${}\|p\K\\{ss};{}$\2\6
${}\\{pp}\K\\{ss};{}$\6
\4${}\}{}$\C{ now \PB{$\\{type}(\\{pp})\K\\{mp\_structured}$} }\2\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_structured}){}$\5
${}\{{}$\C{ it cannot be \PB{$>$ \\{mp\_structured}} }\1\6
${}\|p\K\\{mp\_new\_structure}(\\{mp},\39\|p){}$;\C{ now \PB{$\\{type}(\|p)\K%
\\{mp\_structured}$} }\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\|t)\I\\{mp\_symbol\_node}){}$\5
${}\{{}$\C{ Descend one level for the subscript \PB{\\{value}(\|t)} }\C{ We
want this part of the program to be reasonably fast, in case there are
lots of subscripts at the same level of the data structure. Therefore
we store an ``infinite'' value in the word that appears at the end of the
  subscript list, even though that word isn't part of a subscript node. }\1\6
\&{mp\_number} \\{nn}${},{}$ \\{save\_subscript};\C{ temporary storage }\7
\\{new\_number}(\\{nn});\6
\\{new\_number}(\\{save\_subscript});\6
${}\\{number\_clone}(\\{nn},\39\\{value\_number}(\|t));{}$\6
${}\\{pp}\K\\{mp\_link}(\\{attr\_head}(\\{pp})){}$;\C{ now \PB{$\\{hashloc}(%
\\{pp})\K\\{collective\_subscript}$} }\6
${}\|q\K\\{mp\_link}(\\{attr\_head}(\|p));{}$\6
${}\\{number\_clone}(\\{save\_subscript},\39\\{subscript}(\|q));{}$\6
\\{set\_number\_to\_inf}(\\{subscript}(\|q));\6
${}\|s\K\\{mp}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\|s,\39\\{subscr\_head}(\|p));{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\|s;{}$\6
${}\|s\K\\{mp\_link}(\|s);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{number\_greater}(\\{nn},\39\\{subscript}(\|s)));{}$\6
\&{if} ${}(\\{number\_equal}(\\{nn},\39\\{subscript}(\|s))){}$\5
${}\{{}$\1\6
${}\|p\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_value\_node} \\{p1}${}\K\\{mp\_get\_subscr\_node}(\\{mp});{}$\7
\&{if} ${}(\|r\E\\{mp}\MG\\{temp\_head}){}$\1\5
${}\\{set\_subscr\_head}(\|p,\39{}$(\&{mp\_node}) \\{p1});\2\6
\&{else}\1\5
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \\{p1});\2\6
${}\\{set\_mp\_link}(\\{p1},\39\|s);{}$\6
${}\\{number\_clone}(\\{subscript}(\\{p1}),\39\\{nn});{}$\6
${}\\{mp\_name\_type}(\\{p1})\K\\{mp\_subscr};{}$\6
${}\\{mp\_type}(\\{p1})\K\\{mp\_undefined};{}$\6
${}\|p\K{}$(\&{mp\_node}) \\{p1};\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{subscript}(\|q),\39\\{save\_subscript});{}$\6
\\{free\_number}(\\{save\_subscript});\6
\\{free\_number}(\\{nn});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Descend one level for the attribute \PB{\\{mp\_sym\_info}(\|t)} }\1%
\6
\&{mp\_sym} \\{nn1}${}\K\\{mp\_sym\_sym}(\|t);{}$\7
${}\\{ss}\K\\{attr\_head}(\\{pp});{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{rr}\K\\{ss};{}$\6
${}\\{ss}\K\\{mp\_link}(\\{ss});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{nn1}>\\{hashloc}(\\{ss}));{}$\6
\&{if} ${}(\\{nn1}<\\{hashloc}(\\{ss})){}$\5
${}\{{}$\1\6
${}\\{qq}\K{}$(\&{mp\_node}) \\{mp\_get\_attr\_node}(\\{mp});\6
${}\\{set\_mp\_link}(\\{rr},\39\\{qq});{}$\6
${}\\{set\_mp\_link}(\\{qq},\39\\{ss});{}$\6
${}\\{set\_hashloc}(\\{qq},\39\\{nn1});{}$\6
${}\\{mp\_name\_type}(\\{qq})\K\\{mp\_attr};{}$\6
${}\\{mp\_type}(\\{qq})\K\\{mp\_undefined};{}$\6
\\{set\_parent}((\&{mp\_value\_node}) \\{qq}${},\39\\{pp});{}$\6
${}\\{ss}\K\\{qq};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\E\\{pp}){}$\5
${}\{{}$\1\6
${}\|p\K\\{ss};{}$\6
${}\\{pp}\K\\{ss};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{pp}\K\\{ss};{}$\6
${}\|s\K\\{attr\_head}(\|p);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\|s;{}$\6
${}\|s\K\\{mp\_link}(\|s);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{nn1}>\\{hashloc}(\|s));{}$\6
\&{if} ${}(\\{nn1}\E\\{hashloc}(\|s)){}$\5
${}\{{}$\1\6
${}\|p\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_node}) \\{mp\_get\_attr\_node}(\\{mp});\6
${}\\{set\_mp\_link}(\|r,\39\|q);{}$\6
${}\\{set\_mp\_link}(\|q,\39\|s);{}$\6
${}\\{set\_hashloc}(\|q,\39\\{nn1});{}$\6
${}\\{mp\_name\_type}(\|q)\K\\{mp\_attr};{}$\6
${}\\{mp\_type}(\|q)\K\\{mp\_undefined};{}$\6
\\{set\_parent}((\&{mp\_value\_node}) \|q${},\39\|p);{}$\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_link}(\|t);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\\{pp})\G\\{mp\_structured}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{pp})\E\\{mp\_structured}){}$\1\5
${}\\{pp}\K\\{attr\_head}(\\{pp});{}$\2\6
\&{else}\1\5
\&{return} ${}\NULL;{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_structured}){}$\1\5
${}\|p\K\\{attr\_head}(\|p);{}$\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_undefined}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{pp})\E\\{mp\_undefined}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\\{pp})\K\\{mp\_numeric\_type};{}$\6
${}\\{set\_value\_number}(\\{pp},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_type}(\\{pp});{}$\6
${}\\{set\_value\_number}(\|p,\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{284}Variables lose their former values when they appear in a type
declaration,
or when they are defined to be macros or \&{let} equal to something else.
A subroutine will be defined later that recycles the storage associated
with any particular \PB{\\{type}} or \PB{\\{value}}; our goal now is to study a
higher
level process called \PB{\\{flush\_variable}}, which selectively frees parts of
a
variable structure.

This routine has some complexity because of examples such as
`\hbox{\tt numeric x[]a[]b}'
which recycles all variables of the form \.{x[i]a[j]b} (and no others), while
`\hbox{\tt vardef x[]a[]=...}'
discards all variables of the form \.{x[i]a[j]} followed by an arbitrary
suffix, except for the collective node \.{x[]a[]} itself. The obvious way
to handle such examples is to use recursion; so that's what we~do.

Parameter \PB{\|p} points to the root information of the variable;
parameter \PB{\|t} points to a list of symbolic nodes that represent
suffixes, with \PB{$\\{info}\K\\{collective\_subscript}$} for subscripts.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_flush\_cur\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp\_value} \|v);\par
\fi

\M{285}\B\&{static} \&{void} \\{mp\_flush\_variable}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p${},\39{}$\&{mp\_node} \|t${},\39{}$\&{boolean} \\{discard%
\_suffixes})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r${}\K\NULL{}$;\C{ list manipulation }\6
\&{mp\_sym} \|n;\C{ attribute to match }\7
\&{while} ${}(\|t\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_structured}){}$\5
${}\{{}$\1\6
\&{return};\6
\4${}\}{}$\2\6
${}\|n\K\\{mp\_sym\_sym}(\|t);{}$\6
${}\|t\K\\{mp\_link}(\|t);{}$\6
\&{if} ${}(\|n\E\\{collective\_subscript}){}$\5
${}\{{}$\1\6
${}\|q\K\\{subscr\_head}(\|p);{}$\6
\&{while} ${}(\\{mp\_name\_type}(\|q)\E\\{mp\_subscr}){}$\5
${}\{{}$\1\6
${}\\{mp\_flush\_variable}(\\{mp},\39\|q,\39\|t,\39\\{discard\_suffixes});{}$\6
\&{if} ${}(\|t\E\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_structured}){}$\5
${}\{{}$\1\6
${}\|r\K\|q;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|r\E\NULL){}$\1\5
${}\\{set\_subscr\_head}(\|p,\39\\{mp\_link}(\|q));{}$\2\6
\&{else}\1\5
${}\\{set\_mp\_link}(\|r,\39\\{mp\_link}(\|q));{}$\2\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|r\K\|q;{}$\6
\4${}\}{}$\2\6
${}\|q\K(\|r\E\NULL\?\\{subscr\_head}(\|p):\\{mp\_link}(\|r));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|p\K\\{attr\_head}(\|p);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{hashloc}(\|p)<\|n);{}$\6
\&{if} ${}(\\{hashloc}(\|p)\I\|n){}$\5
${}\{{}$\1\6
\&{return};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{discard\_suffixes})\5
${}\{{}$\1\6
${}\\{mp\_flush\_below\_variable}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_structured}){}$\5
${}\{{}$\1\6
${}\|p\K\\{attr\_head}(\|p);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{286}The next procedure is simpler; it wipes out everything but \PB{\|p}
itself,
which becomes undefined.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_flush\_below\_variable}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{287}\B\&{void} \\{mp\_flush\_below\_variable}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r;\C{ list manipulation registers }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_flush\_below\_vari}\)\.{able(\%p)\\n"},\39%
\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_structured}){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p){}$;\C{ this sets \PB{$\\{type}(\|p)\K%
\\{undefined}$} }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{subscr\_head}(\|p);{}$\6
\&{while} ${}(\\{mp\_name\_type}(\|q)\E\\{mp\_subscr}){}$\5
${}\{{}$\1\6
${}\\{mp\_flush\_below\_variable}(\\{mp},\39\|q);{}$\6
${}\|r\K\|q;{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\6
${}\|r\K\\{attr\_head}(\|p);{}$\6
${}\|q\K\\{mp\_link}(\|r);{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|r);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|r);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_flush\_below\_variable}(\\{mp},\39\|q);{}$\6
${}\|r\K\|q;{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\\{mp}\MG\\{end\_attr});{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_undefined};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{288}Just before assigning a new value to a variable, we will recycle the
old value and make the old value undefined. The \PB{\\{und\_type}} routine
determines what type of undefined value should be given, based on
the current type before recycling.

\Y\B\&{static} \&{quarterword} \\{mp\_und\_type}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
\&{return} \\{mp\_undefined};\6
\4\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_unknown\_boolean}:\5
\&{return} \\{mp\_unknown\_boolean};\6
\4\&{case} \\{mp\_string\_type}:\5
\&{case} \\{mp\_unknown\_string}:\5
\&{return} \\{mp\_unknown\_string};\6
\4\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_unknown\_pen}:\5
\&{return} \\{mp\_unknown\_pen};\6
\4\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_unknown\_path}:\5
\&{return} \\{mp\_unknown\_path};\6
\4\&{case} \\{mp\_picture\_type}:\5
\&{case} \\{mp\_unknown\_picture}:\5
\&{return} \\{mp\_unknown\_picture};\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_numeric\_type}:\5
\&{return} \\{mp\_type}(\|p);\6
\4\&{case} \\{mp\_known}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\5
\&{return} \\{mp\_numeric\_type};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{return} \T{0};\6
\4${}\}{}$\2\6
\&{return} \T{0};\6
\4${}\}{}$\2\par
\fi

\M{289}The \PB{\\{clear\_symbol}} routine is used when we want to redefine the
equivalent
of a symbolic token. It must remove any variable structure or macro
definition that is currently attached to that symbol. If the \PB{\\{saving}}
parameter is true, a subsidiary structure is saved instead of destroyed.

\Y\B\&{static} \&{void} \\{mp\_clear\_symbol}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|p${},\39{}$\&{boolean} \\{saving})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ \PB{\\{equiv}(\|p)} }\7
${}\.{FUNCTION\_TRACE3}(\.{"mp\_clear\_symbol(\%p,}\)\.{\%d)\\n"},\39\|p,\39%
\\{saving});{}$\6
${}\|q\K\\{equiv\_node}(\|p);{}$\6
\&{switch} ${}(\\{eq\_type}(\|p)\MOD\\{mp\_outer\_tag}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_defined\_macro}:\5
\&{case} \\{mp\_secondary\_primary\_macro}:\5
\&{case} \\{mp\_tertiary\_secondary\_macro}:\5
\&{case} \\{mp\_expression\_tertiary\_macro}:\6
\&{if} ${}(\R\\{saving}){}$\1\5
${}\\{mp\_delete\_mac\_ref}(\\{mp},\39\|q);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_tag\_token}:\6
\&{if} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{saving})\5
${}\{{}$\1\6
${}\\{mp\_name\_type}(\|q)\K\\{mp\_saved\_root};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_flush\_below\_variable}(\\{mp},\39\|q);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
${}\\{set\_equiv}(\|p,\39\\{mp}\MG\\{frozen\_undefined}\MG\|v.\\{data}.%
\\{indep}.\\{serial});{}$\6
${}\\{set\_eq\_type}(\|p,\39\\{mp}\MG\\{frozen\_undefined}\MG\\{type});{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{290}Saving and restoring equivalents.
The nested structure given by \&{begingroup} and \&{endgroup}
allows \PB{\\{eqtb}} entries to be saved and restored, so that temporary
changes
can be made without difficulty.  When the user requests a current value to
be saved, \MP\ puts that value into its ``save stack.'' An appearance of
\&{endgroup} ultimately causes the old values to be removed from the save
stack and put back in their former places.

The save stack is a linked list containing three kinds of entries,
distinguished by their \PB{\\{type}} fields. If \PB{\|p} points to a saved
item,
then

\smallskip\hang
\PB{$\|p\MG\\{type}\K\T{0}$} stands for a group boundary; each \&{begingroup}
contributes
such an item to the save stack and each \&{endgroup} cuts back the stack
until the most recent such entry has been removed.

\smallskip\hang
\PB{$\|p\MG\\{type}\K\\{mp\_normal\_sym}$} means that \PB{$\|p\MG\\{value}$}
holds the former
contents of \PB{\\{eqtb}[\|q]} (saved in the \PB{\\{knot}} field of the value,
which
is otherwise unused for variables). Such save stack entries are generated by %
\&{save}
commands.

\smallskip\hang
\PB{$\|p\MG\\{type}\K\\{mp\_internal\_sym}$} means that \PB{$\|p\MG\\{value}$}
is a \PB{\&{mp\_internal}}
to be restored to internal parameter number~\PB{\|q} (saved in the \PB{%
\\{serial}} field of the value, which
is otherwise unused for internals). Such entries are generated by \&{interim}
commands.

\smallskip\noindent
The global variable \PB{\\{save\_ptr}} points to the top item on the save
stack.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_save\_data} ${}\{{}$\1\6
\&{quarterword} \\{type};\6
\&{mp\_internal} \\{value};\6
\&{struct} \&{mp\_save\_data} ${}{*}\\{link};{}$\2\6
${}\}{}$ \&{mp\_save\_data};\par
\fi

\M{291}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_save\_data} ${}{*}\\{save\_ptr}{}$;\C{ the most recently saved item }\par
\fi

\M{292}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{save\_ptr}\K\NULL{}$;\par
\fi

\M{293}Saving a boundary item
\Y\B\&{static} \&{void} \\{mp\_save\_boundary}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_save\_data} ${}{*}\|p{}$;\C{ temporary register }\7
\.{FUNCTION\_TRACE1}(\.{"mp\_save\_boundary\ ()}\)\.{\\n"});\6
${}\|p\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_save\_data}));{}$\6
${}\|p\MG\\{type}\K\T{0};{}$\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{save\_ptr};{}$\6
${}\\{mp}\MG\\{save\_ptr}\K\|p;{}$\6
\4${}\}{}$\2\par
\fi

\M{294}The \PB{\\{save\_variable}} routine is given a hash address \PB{\|q}; it
salts this
address in the save stack, together with its current equivalent,
then makes token~\PB{\|q} behave as though it were brand new.

Nothing is stacked when \PB{$\\{save\_ptr}\K\NULL$}, however; there's no way to
remove
things from the stack when the program is not inside a group, so there's
no point in wasting the space.

\Y\B\&{static} \&{void} \\{mp\_save\_variable}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_sym} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_save\_data} ${}{*}\|p{}$;\C{ temporary register }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_save\_variable\ (\%}\)\.{p)\\n"},\39\|q);{}$\6
\&{if} ${}(\\{mp}\MG\\{save\_ptr}\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_save\_data}));{}$\6
${}\|p\MG\\{type}\K\\{mp\_normal\_sym};{}$\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{save\_ptr};{}$\6
${}\|p\MG\\{value}.\|v.\\{data}.\\{indep}.\\{scale}\K\\{eq\_type}(\|q);{}$\6
${}\|p\MG\\{value}.\|v.\\{data}.\\{indep}.\\{serial}\K\\{equiv}(\|q);{}$\6
${}\|p\MG\\{value}.\|v.\\{data}.\\{node}\K\\{equiv\_node}(\|q);{}$\6
${}\|p\MG\\{value}.\|v.\\{data}.\|p\K(\\{mp\_knot})\|q;{}$\6
${}\\{mp}\MG\\{save\_ptr}\K\|p;{}$\6
\4${}\}{}$\2\6
${}\\{mp\_clear\_symbol}(\\{mp},\39\|q,\39(\\{mp}\MG\\{save\_ptr}\I\NULL));{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_unsave\_variable}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \|q${}\K{}$(\&{mp\_sym}) \\{mp}${}\MG\\{save\_ptr}\MG\\{value}.\|v.%
\\{data}.\|p;{}$\7
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_restores})))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{restoring\ "});{}$\6
\\{mp\_print\_text}(\|q);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_clear\_symbol}(\\{mp},\39\|q,\39\\{false});{}$\6
${}\\{set\_eq\_type}(\|q,\39\\{mp}\MG\\{save\_ptr}\MG\\{value}.\|v.\\{data}.%
\\{indep}.\\{scale});{}$\6
${}\\{set\_equiv}(\|q,\39\\{mp}\MG\\{save\_ptr}\MG\\{value}.\|v.\\{data}.%
\\{indep}.\\{serial});{}$\6
${}\|q\MG\|v.\\{data}.\\{node}\K\\{mp}\MG\\{save\_ptr}\MG\\{value}.\|v.%
\\{data}.\\{node};{}$\6
\&{if} ${}(\\{eq\_type}(\|q)\MOD\\{mp\_outer\_tag}\E\\{mp\_tag\_token}){}$\5
${}\{{}$\1\6
\&{mp\_node} \\{pp}${}\K\|q\MG\|v.\\{data}.\\{node};{}$\7
\&{if} ${}(\\{pp}\I\NULL){}$\1\5
${}\\{mp\_name\_type}(\\{pp})\K\\{mp\_root};{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{295}Similarly, \PB{\\{save\_internal}} is given the location \PB{\|q} of an
internal
quantity like \PB{\\{mp\_tracing\_pens}}. It creates a save stack entry of the
third kind.

\Y\B\&{static} \&{void} \\{mp\_save\_internal}(\&{MP} \\{mp}${},\39{}$%
\&{halfword} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_save\_data} ${}{*}\|p{}$;\C{ new item for the save stack }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_save\_internal\ (\%}\)\.{d)\\n"},\39\|q);{}$\6
\&{if} ${}(\\{mp}\MG\\{save\_ptr}\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_save\_data}));{}$\6
${}\|p\MG\\{type}\K\\{mp\_internal\_sym};{}$\6
${}\|p\MG\\{link}\K\\{mp}\MG\\{save\_ptr};{}$\6
${}\|p\MG\\{value}\K\\{mp}\MG\\{internal}[\|q];{}$\6
${}\|p\MG\\{value}.\|v.\\{data}.\\{indep}.\\{serial}\K\|q;{}$\6
${}\\{new\_number}(\|p\MG\\{value}.\|v.\\{data}.\|n);{}$\6
${}\\{number\_clone}(\|p\MG\\{value}.\|v.\\{data}.\|n,\39\\{mp}\MG\\{internal}[%
\|q].\|v.\\{data}.\|n);{}$\6
${}\\{mp}\MG\\{save\_ptr}\K\|p;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_unsave\_internal}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{halfword} \|q${}\K\\{mp}\MG\\{save\_ptr}\MG\\{value}.\|v.\\{data}.\\{indep}.%
\\{serial};{}$\6
\&{mp\_internal} \\{saved}${}\K\\{mp}\MG\\{save\_ptr}\MG\\{value};{}$\7
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_restores})))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{restoring\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{internal\_name}(\|q));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
\&{if} ${}(\\{internal\_type}(\|q)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{print\_number}(\\{saved}.\|v.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{internal\_type}(\|q)\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{mp\_str}(\\{mp},\39\\{saved}.\|v.\\{data}.\\{str});{}$\7
${}\\{mp\_print}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_confusion}(\\{mp},\39\.{"internal\_restore"});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
${}\\{free\_number}(\\{mp}\MG\\{internal}[\|q].\|v.\\{data}.\|n);{}$\6
${}\\{mp}\MG\\{internal}[\|q]\K\\{saved};{}$\6
\4${}\}{}$\2\par
\fi

\M{296}At the end of a group, the \PB{\\{unsave}} routine restores all of the
saved
equivalents in reverse order. This routine will be called only when there
is at least one boundary item on the save stack.

\Y\B\&{static} \&{void} \\{mp\_unsave}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_save\_data} ${}{*}\|p{}$;\C{ saved item }\7
\.{FUNCTION\_TRACE1}(\.{"mp\_unsave\ ()\\n"});\6
\&{while} ${}(\\{mp}\MG\\{save\_ptr}\MG\\{type}\I\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{save\_ptr}\MG\\{type}\E\\{mp\_internal\_sym}){}$\5
${}\{{}$\1\6
\\{mp\_unsave\_internal}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_unsave\_variable}(\\{mp});\6
\4${}\}{}$\2\6
${}\|p\K\\{mp}\MG\\{save\_ptr}\MG\\{link};{}$\6
${}\\{xfree}(\\{mp}\MG\\{save\_ptr});{}$\6
${}\\{mp}\MG\\{save\_ptr}\K\|p;{}$\6
\4${}\}{}$\2\6
${}\|p\K\\{mp}\MG\\{save\_ptr}\MG\\{link};{}$\6
${}\\{xfree}(\\{mp}\MG\\{save\_ptr});{}$\6
${}\\{mp}\MG\\{save\_ptr}\K\|p;{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{297}Data structures for paths.
When a \MP\ user specifies a path, \MP\ will create a list of knots
and control points for the associated cubic spline curves. If the
knots are $z_0$, $z_1$, \dots, $z_n$, there are control points
$z_k^+$ and $z_{k+1}^-$ such that the cubic splines between knots
$z_k$ and $z_{k+1}$ are defined by B\'ezier's formula
$$\eqalign{z(t)&=B(z_k,z_k^+,z_{k+1}^-,z_{k+1};t)\cr
&=(1-t)^3z_k+3(1-t)^2tz_k^++3(1-t)t^2z_{k+1}^-+t^3z_{k+1}\cr}$$
for \PB{$\T{0}\Z\|t\Z\T{1}$}.

There is a 8-word node for each knot $z_k$, containing one word of
control information and six words for the \PB{\|x} and \PB{\|y} coordinates of
$z_k^-$ and $z_k$ and~$z_k^+$. The control information appears in the
\PB{\\{mp\_left\_type}} and \PB{\\{mp\_right\_type}} fields, which each occupy
a quarter of
the first word in the node; they specify properties of the curve as it
enters and leaves the knot. There's also a halfword \PB{\\{link}} field,
which points to the following knot, and a final supplementary word (of
which only a quarter is used).

If the path is a closed contour, knots 0 and \PB{\|n} are identical;
i.e., the \PB{\\{link}} in knot \PB{$\|n-\T{1}$} points to knot~0. But if the
path
is not closed, the \PB{\\{mp\_left\_type}} of knot~0 and the \PB{\\{mp\_right%
\_type}} of knot~\PB{\|n}
are equal to \PB{\\{endpoint}}. In the latter case the \PB{\\{link}} in knot~%
\PB{\|n} points
to knot~0, and the control points $z_0^-$ and $z_n^+$ are not used.

\Y\B\4\D$\\{mp\_next\_knot}(\|A)$ \5
$(\|A)\MG{}$\\{next}\C{ the next knot in this list }\par
\B\4\D$\\{mp\_left\_type}(\|A)$ \5
$(\|A)\MG\\{data}.\\{types}.{}$\\{left\_type}\C{ characterizes the path
entering this knot }\par
\B\4\D$\\{mp\_right\_type}(\|A)$ \5
$(\|A)\MG\\{data}.\\{types}.{}$\\{right\_type}\C{ characterizes the path
leaving this knot }\par
\B\4\D$\\{mp\_prev\_knot}(\|A)$ \5
$(\|A)\MG\\{data}.{}$\\{prev}\C{ the previous knot in this list (only for pens)
}\par
\B\4\D$\\{mp\_knot\_info}(\|A)$ \5
$(\|A)\MG\\{data}.{}$\\{info}\C{ temporary info, used during splitting }\par
\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \\{mp\_knot\_data} ${}{*}\&{mp\_knot};{}$\6
\&{typedef} \&{struct} \&{mp\_knot\_data} ${}\{{}$\1\6
\&{mp\_number} \\{x\_coord};\C{ the \PB{\|x} coordinate of this knot }\6
\&{mp\_number} \\{y\_coord};\C{ the \PB{\|y} coordinate of this knot }\6
\&{mp\_number} \\{left\_x};\C{ the \PB{\|x} coordinate of previous control
point }\6
\&{mp\_number} \\{left\_y};\C{ the \PB{\|y} coordinate of previous control
point }\6
\&{mp\_number} \\{right\_x};\C{ the \PB{\|x} coordinate of next control point }%
\6
\&{mp\_number} \\{right\_y};\C{ the \PB{\|y} coordinate of next control point }%
\6
\&{mp\_knot} \\{next};\6
\&{union} ${}\{{}$\1\6
\&{struct} ${}\{{}$\1\6
\&{unsigned} \&{short} \\{left\_type};\6
\&{unsigned} \&{short} \\{right\_type};\2\6
${}\}{}$ \\{types};\6
\&{mp\_knot} \\{prev};\6
\&{signed} \&{int} \\{info};\2\6
${}\}{}$ \\{data};\6
\&{unsigned} \&{char} \\{originator};\2\6
${}\}{}$ \&{mp\_knot\_data};\par
\fi

\M{298}
\Y\B\4\D$\\{mp\_gr\_next\_knot}(\|A)$ \5
$(\|A)\MG{}$\\{next}\C{ the next knot in this list }\par
\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \\{mp\_gr\_knot\_data} ${}{*}\&{mp\_gr\_knot};{}$\6
\&{typedef} \&{struct} \&{mp\_gr\_knot\_data} ${}\{{}$\1\6
\&{double} \\{x\_coord};\6
\&{double} \\{y\_coord};\6
\&{double} \\{left\_x};\6
\&{double} \\{left\_y};\6
\&{double} \\{right\_x};\6
\&{double} \\{right\_y};\6
\&{mp\_gr\_knot} \\{next};\6
\&{union} ${}\{{}$\1\6
\&{struct} ${}\{{}$\1\6
\&{unsigned} \&{short} \\{left\_type};\6
\&{unsigned} \&{short} \\{right\_type};\2\6
${}\}{}$ \\{types};\6
\&{mp\_gr\_knot} \\{prev};\6
\&{signed} \&{int} \\{info};\2\6
${}\}{}$ \\{data};\6
\&{unsigned} \&{char} \\{originator};\2\6
${}\}{}$ \&{mp\_gr\_knot\_data};\par
\fi

\M{299}\B\X201:MPlib header stuff\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_knot\_type} ${}\{{}$\1\6
${}\\{mp\_endpoint}\K\T{0},{}$\C{ \PB{\\{mp\_left\_type}} at path beginning and
\PB{\\{mp\_right\_type}} at path end }\6
\\{mp\_explicit}${},{}$\C{ \PB{\\{mp\_left\_type}} or \PB{\\{mp\_right\_type}}
when control points are known }\6
\\{mp\_given}${},{}$\C{ \PB{\\{mp\_left\_type}} or \PB{\\{mp\_right\_type}}
when a direction is given }\6
\\{mp\_curl}${},{}$\C{ \PB{\\{mp\_left\_type}} or \PB{\\{mp\_right\_type}} when
a curl is desired }\6
\\{mp\_open}${},{}$\C{ \PB{\\{mp\_left\_type}} or \PB{\\{mp\_right\_type}} when
\MP\ should choose the direction }\6
\\{mp\_end\_cycle}\2\6
${}\}{}$;\par
\fi

\M{300}Before the B\'ezier control points have been calculated, the memory
space they will ultimately occupy is taken up by information that can be
used to compute them. There are four cases:

\yskip
\textindent{$\bullet$} If \PB{$\\{mp\_right\_type}\K\\{mp\_open}$}, the curve
should leave
the knot in the same direction it entered; \MP\ will figure out a
suitable direction.

\yskip
\textindent{$\bullet$} If \PB{$\\{mp\_right\_type}\K\\{mp\_curl}$}, the curve
should leave the
knot in a direction depending on the angle at which it enters the next
knot and on the curl parameter stored in \PB{\\{right\_curl}}.

\yskip
\textindent{$\bullet$} If \PB{$\\{mp\_right\_type}\K\\{mp\_given}$}, the curve
should leave the
knot in a nonzero direction stored as an \PB{\\{angle}} in \PB{\\{right%
\_given}}.

\yskip
\textindent{$\bullet$} If \PB{$\\{mp\_right\_type}\K\\{mp\_explicit}$}, the B%
\'ezier control
point for leaving this knot has already been computed; it is in the
\PB{\\{mp\_right\_x}} and \PB{\\{mp\_right\_y}} fields.

\yskip\noindent
The rules for \PB{\\{mp\_left\_type}} are similar, but they refer to the curve
entering
the knot, and to \\{left} fields instead of \\{right} fields.

Non-\PB{\&{explicit}} control points will be chosen based on ``tension''
parameters
in the \PB{\\{left\_tension}} and \PB{\\{right\_tension}} fields. The
`\&{atleast}' option is represented by negative tension values.

For example, the \MP\ path specification
$$\.{z0..z1..tension atleast 1..\{curl 2\}z2..z3\{-1,-2\}..tension
3 and 4..p},$$
where \.p is the path `\.{z4..controls z45 and z54..z5}', will be represented
by the six knots
\def\lodash{\hbox to 1.1em{\thinspace\hrulefill\thinspace}}
$$\vbox{\halign{#\hfil&&\qquad#\hfil\cr
\PB{\\{mp\_left\_type}}&\\{left} info&\PB{$\\{x\_coord},\\{y\_coord}$}&\PB{%
\\{mp\_right\_type}}&\\{right} info\cr
\noalign{\yskip}
\PB{\\{endpoint}}&\lodash$,\,$\lodash&$x_0,y_0$&\PB{\\{curl}}&$1.0,1.0$\cr
\PB{\\{open}}&\lodash$,1.0$&$x_1,y_1$&\PB{\\{open}}&\lodash$,-1.0$\cr
\PB{\\{curl}}&$2.0,-1.0$&$x_2,y_2$&\PB{\\{curl}}&$2.0,1.0$\cr
\PB{\\{given}}&$d,1.0$&$x_3,y_3$&\PB{\\{given}}&$d,3.0$\cr
\PB{\\{open}}&\lodash$,4.0$&$x_4,y_4$&\PB{\&{explicit}}&$x_{45},y_{45}$\cr
\PB{\&{explicit}}&$x_{54},y_{54}$&$x_5,y_5$&\PB{\\{endpoint}}&\lodash$,\,$%
\lodash\cr}}$$
Here \PB{\|d} is the \PB{\\{angle}} obtained by calling \PB{$\\{n\_arg}({-}%
\\{unity},{-}\\{two})$}.
Of course, this example is more complicated than anything a normal user
would ever write.

These types must satisfy certain restrictions because of the form of \MP's
path syntax:
(i)~\PB{\\{open}} type never appears in the same node together with \PB{%
\\{endpoint}},
\PB{\\{given}}, or \PB{\\{curl}}.
(ii)~The \PB{\\{mp\_right\_type}} of a node is \PB{\&{explicit}} if and only if
the
\PB{\\{mp\_left\_type}} of the following node is \PB{\&{explicit}}.
(iii)~\PB{\\{endpoint}} types occur only at the ends, as mentioned above.

\Y\B\4\D$\\{left\_curl}$ \5
\\{left\_x}\C{ curl information when entering this knot }\par
\B\4\D$\\{left\_given}$ \5
\\{left\_x}\C{ given direction when entering this knot }\par
\B\4\D$\\{left\_tension}$ \5
\\{left\_y}\C{ tension information when entering this knot }\par
\B\4\D$\\{right\_curl}$ \5
\\{right\_x}\C{ curl information when leaving this knot }\par
\B\4\D$\\{right\_given}$ \5
\\{right\_x}\C{ given direction when leaving this knot }\par
\B\4\D$\\{right\_tension}$ \5
\\{right\_y}\C{ tension information when leaving this knot }\par
\fi

\M{301}Knots can be user-supplied, or they can be created by program code,
like the \PB{\\{split\_cubic}} function, or \PB{\\{copy\_path}}. The
distinction is
needed for the cleanup routine that runs after \PB{\\{split\_cubic}}, because
it should only delete knots it has previously inserted, and never
anything that was user-supplied. In order to be able to differentiate
one knot from another, we will set \PB{\\{originator}(\|p): $\K$ \\{mp%
\_metapost\_user}} when
it appeared in the actual metapost program, and
\PB{\\{originator}(\|p): $\K$ \\{mp\_program\_code}} in all other cases.

\Y\B\4\D$\\{mp\_originator}(\|A)$ \5
$(\|A)\MG{}$\\{originator}\C{ the creator of this knot }\par
\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_knot\_originator} ${}\{{}$\1\6
${}\\{mp\_program\_code}\K\T{0},{}$\C{ not created by a user }\6
\\{mp\_metapost\_user}\C{ created by a user }\2\6
${}\}{}$;\par
\fi

\M{302}Here is a routine that prints a given knot list
in symbolic form. It illustrates the conventions discussed above,
and checks for anomalies that might arise while \MP\ is being debugged.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_pr\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|h);%
\par
\fi

\M{303}\B\&{void} \\{mp\_pr\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|h)\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ for list traversal }\7
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}((\|p\E\NULL)\V(\|q\E\NULL)){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"???"});{}$\6
\&{return};\C{ this won't happen }\6
\4${}\}{}$\2\6
\X304:Print information for adjacent knots \PB{\|p} and \PB{\|q}\X;\6
\4\.{DONE1}:\5
${}\|p\K\|q;{}$\6
\&{if} ${}(\|p\W((\|p\I\|h)\V(\\{mp\_left\_type}(\|h)\I\\{mp\_endpoint}))){}$\5
${}\{{}$\1\6
\X305:Print two dots, followed by \PB{\\{given}} or \PB{\\{curl}} if present\X;%
\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|h)\I\\{mp\_endpoint}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"cycle"});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{304}\B\X304:Print information for adjacent knots \PB{\|p} and \PB{\|q}\X${}%
\E{}$\6
$\\{mp\_print\_two}(\\{mp},\39\|p\MG\\{x\_coord},\39\|p\MG\\{y\_coord});{}$\6
\&{switch} (\\{mp\_right\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_endpoint}:\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_open}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\{open?\}"}){}$;\C{ can't happen }\2\6
;\6
\&{if} ${}((\\{mp\_left\_type}(\|q)\I\\{mp\_endpoint})\V(\|q\I\|h)){}$\1\5
${}\|q\K\NULL{}$;\C{ force an error }\2\6
\&{goto} \.{DONE1};\6
\&{break};\6
\4\&{case} \\{mp\_explicit}:\5
\X307:Print control points between \PB{\|p} and \PB{\|q}, then \PB{\&{goto} %
\\{done1}}\X;\6
\&{break};\6
\4\&{case} \\{mp\_open}:\5
\X308:Print information for a curve that begins \PB{\\{open}}\X;\6
\&{break};\6
\4\&{case} \\{mp\_curl}:\5
\&{case} \\{mp\_given}:\5
\X309:Print information for a curve that begins \PB{\\{curl}} or \PB{\\{given}}%
\X;\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"???"}){}$;\C{ can't happen }\6
;\6
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\Z\\{mp\_explicit}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"..control?"}){}$;\C{ can't happen }\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\R\\{number\_equal}(\|p\MG\\{right\_tension},\39\\{unity%
\_t}))\V(\R\\{number\_equal}(\|q\MG\\{left\_tension},\39\\{unity\_t}))){}$\5
${}\{{}$\1\6
\X306:Print tension between \PB{\|p} and \PB{\|q}\X;\6
\4${}\}{}$\2\par
\U303.\fi

\M{305}Since \PB{\\{n\_sin\_cos}} produces \PB{\\{fraction}} results, which we
will print as if they
were \PB{\\{scaled}}, the magnitude of a \PB{\\{given}} direction vector will
be~4096.

\Y\B\4\X305:Print two dots, followed by \PB{\\{given}} or \PB{\\{curl}} if
present\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{n\_sin}${},{}$ \\{n\_cos};\7
\\{new\_fraction}(\\{n\_sin});\6
\\{new\_fraction}(\\{n\_cos});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\ .."});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_given}){}$\5
${}\{{}$\1\6
${}\\{n\_sin\_cos}(\|p\MG\\{left\_given},\39\\{n\_cos},\39\\{n\_sin});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\{'}));{}$\6
\\{print\_number}(\\{n\_cos});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
\\{print\_number}(\\{n\_sin});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_curl}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\{curl\ "});{}$\6
${}\\{print\_number}(\|p\MG\\{left\_curl});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{n\_sin});\6
\\{free\_number}(\\{n\_cos});\6
\4${}\}{}$\2\par
\U303.\fi

\M{306}\B\X306:Print tension between \PB{\|p} and \PB{\|q}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{v1};\7
\\{new\_number}(\\{v1});\6
${}\\{mp\_print}(\\{mp},\39\.{"..tension\ "});{}$\6
\&{if} ${}(\\{number\_negative}(\|p\MG\\{right\_tension})){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"atleast"});{}$\2\6
${}\\{number\_clone}(\\{v1},\39\|p\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{v1});\6
\\{print\_number}(\\{v1});\6
\&{if} ${}(\R\\{number\_equal}(\|p\MG\\{right\_tension},\39\|q\MG\\{left%
\_tension})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ and\ "});{}$\6
\&{if} ${}(\\{number\_negative}(\|q\MG\\{left\_tension})){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"atleast"});{}$\2\6
${}\\{number\_clone}(\\{v1},\39\|p\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{v1});\6
\\{print\_number}(\\{v1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{v1});\6
\4${}\}{}$\2\par
\U304.\fi

\M{307}\B\X307:Print control points between \PB{\|p} and \PB{\|q}, then \PB{%
\&{goto} \\{done1}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"..controls\ "});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|p\MG\\{right\_x},\39\|p\MG\\{right\_y});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ and\ "});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\I\\{mp\_explicit}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"??"}){}$;\C{ can't happen }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_two}(\\{mp},\39\|q\MG\\{left\_x},\39\|q\MG\\{left\_y});{}$\6
\4${}\}{}$\2\6
\&{goto} \.{DONE1};\6
\4${}\}{}$\2\par
\U304.\fi

\M{308}\B\X308:Print information for a curve that begins \PB{\\{open}}\X${}%
\E{}$\6
\&{if} ${}((\\{mp\_left\_type}(\|p)\I\\{mp\_explicit})\W(\\{mp\_left\_type}(%
\|p)\I\\{mp\_open})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\{open?\}"}){}$;\C{ can't happen }\6
\4${}\}{}$\2\par
\U304.\fi

\M{309}A curl of 1 is shown explicitly, so that the user sees clearly that
\MP's default curl is present.

\Y\B\4\X309:Print information for a curve that begins \PB{\\{curl}} or \PB{%
\\{given}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_open}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"??"}){}$;\C{ can't happen }\2\6
;\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_curl}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\{curl\ "});{}$\6
${}\\{print\_number}(\|p\MG\\{right\_curl});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{n\_sin}${},{}$ \\{n\_cos};\7
\\{new\_fraction}(\\{n\_sin});\6
\\{new\_fraction}(\\{n\_cos});\6
${}\\{n\_sin\_cos}(\|p\MG\\{right\_given},\39\\{n\_cos},\39\\{n\_sin});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\{'}));{}$\6
\\{print\_number}(\\{n\_cos});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
\\{print\_number}(\\{n\_sin});\6
\\{free\_number}(\\{n\_sin});\6
\\{free\_number}(\\{n\_cos});\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
\4${}\}{}$\2\par
\U304.\fi

\M{310}It is convenient to have another version of \PB{\\{pr\_path}} that
prints the path
as a diagnostic message.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline});\par
\fi

\M{311}\B\&{void} \\{mp\_print\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline})\1\1\2\2%
\6
${}\{{}$\1\6
${}\\{mp\_print\_diagnostic}(\\{mp},\39\.{"Path"},\39\|s,\39\\{nuline});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
;\6
${}\\{mp\_pr\_path}(\\{mp},\39\|h);{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\fi

\M{312}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_knot} \\{mp\_new\_knot}(\&{MP} \\{mp});\par
\fi

\M{313}\B\&{static} \&{mp\_knot} \\{mp\_new\_knot}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\7
\&{if} ${}(\\{mp}\MG\\{knot\_nodes}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{knot\_nodes};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\|q\MG\\{next};{}$\6
${}\\{mp}\MG\\{num\_knot\_nodes}\MM;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_xmalloc}(\\{mp},\39\T{1},\39{}$\&{sizeof}(\&{struct} \&{mp\_knot%
\_data}));\6
\4${}\}{}$\2\6
${}\\{memset}(\|q,\39\T{0},\39{}$\&{sizeof}(\&{struct} \&{mp\_knot\_data}));\6
${}\\{new\_number}(\|q\MG\\{x\_coord});{}$\6
${}\\{new\_number}(\|q\MG\\{y\_coord});{}$\6
${}\\{new\_number}(\|q\MG\\{left\_x});{}$\6
${}\\{new\_number}(\|q\MG\\{left\_y});{}$\6
${}\\{new\_number}(\|q\MG\\{right\_x});{}$\6
${}\\{new\_number}(\|q\MG\\{right\_y});{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{314}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_gr\_knot} \\{mp\_gr\_new\_knot}(\&{MP} \\{mp});\par
\fi

\M{315}\B\&{static} \&{mp\_gr\_knot} \\{mp\_gr\_new\_knot}(\&{MP} \\{mp})\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_gr\_knot} \|q${}\K\\{mp\_xmalloc}(\\{mp},\39\T{1},\39{}$\&{sizeof}(%
\&{struct} \&{mp\_gr\_knot\_data}));\7
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{316}If we want to duplicate a knot node, we can say \PB{\\{copy\_knot}}:

\Y\B\&{static} \&{mp\_knot} \\{mp\_copy\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\7
\&{if} ${}(\\{mp}\MG\\{knot\_nodes}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{knot\_nodes};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\|q\MG\\{next};{}$\6
${}\\{mp}\MG\\{num\_knot\_nodes}\MM;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_xmalloc}(\\{mp},\39\T{1},\39{}$\&{sizeof}(\&{struct} \&{mp\_knot%
\_data}));\6
\4${}\}{}$\2\6
${}\\{memcpy}(\|q,\39\|p,\39{}$\&{sizeof}(\&{struct} \&{mp\_knot\_data}));\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\|q\MG\\{x\_coord});{}$\6
${}\\{new\_number}(\|q\MG\\{y\_coord});{}$\6
${}\\{new\_number}(\|q\MG\\{left\_x});{}$\6
${}\\{new\_number}(\|q\MG\\{left\_y});{}$\6
${}\\{new\_number}(\|q\MG\\{right\_x});{}$\6
${}\\{new\_number}(\|q\MG\\{right\_y});{}$\6
${}\\{number\_clone}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{y\_coord},\39\|p\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_x},\39\|p\MG\\{left\_x});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_y},\39\|p\MG\\{left\_y});{}$\6
${}\\{number\_clone}(\|q\MG\\{right\_x},\39\|p\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|q\MG\\{right\_y},\39\|p\MG\\{right\_y});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_next\_knot}(\|q)\K\NULL;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{317}If we want to export a knot node, we can say \PB{\\{export\_knot}}:

\Y\B\&{static} \&{mp\_gr\_knot} \\{mp\_export\_knot}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_gr\_knot} \|q;\C{ the copy }\7
${}\|q\K\\{mp\_gr\_new\_knot}(\\{mp});{}$\6
${}\|q\MG\\{x\_coord}\K\\{number\_to\_double}(\|p\MG\\{x\_coord});{}$\6
${}\|q\MG\\{y\_coord}\K\\{number\_to\_double}(\|p\MG\\{y\_coord});{}$\6
${}\|q\MG\\{left\_x}\K\\{number\_to\_double}(\|p\MG\\{left\_x});{}$\6
${}\|q\MG\\{left\_y}\K\\{number\_to\_double}(\|p\MG\\{left\_y});{}$\6
${}\|q\MG\\{right\_x}\K\\{number\_to\_double}(\|p\MG\\{right\_x});{}$\6
${}\|q\MG\\{right\_y}\K\\{number\_to\_double}(\|p\MG\\{right\_y});{}$\6
${}\|q\MG\\{data}.\\{types}.\\{left\_type}\K\\{mp\_left\_type}(\|p);{}$\6
${}\|q\MG\\{data}.\\{types}.\\{right\_type}\K\\{mp\_left\_type}(\|p);{}$\6
${}\|q\MG\\{data}.\\{info}\K\\{mp\_knot\_info}(\|p);{}$\6
${}\\{mp\_gr\_next\_knot}(\|q)\K\NULL;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{318}The \PB{\\{copy\_path}} routine makes a clone of a given path.

\Y\B\&{static} \&{mp\_knot} \\{mp\_copy\_path}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q${},{}$ \\{pp}${},{}$ \\{qq};\C{ for list manipulation }\7
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|q\K\\{mp\_copy\_knot}(\\{mp},\39\|p);{}$\6
${}\\{qq}\K\|q;{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\|p);{}$\6
\&{while} ${}(\\{pp}\I\|p){}$\5
${}\{{}$\1\6
${}\\{mp\_next\_knot}(\\{qq})\K\\{mp\_copy\_knot}(\\{mp},\39\\{pp});{}$\6
${}\\{qq}\K\\{mp\_next\_knot}(\\{qq});{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\\{pp});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_next\_knot}(\\{qq})\K\|q;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{319}The \PB{\\{export\_path}} routine makes a clone of a given path
and converts the \PB{\\{value}}s therein to \PB{\&{double}}s.

\Y\B\&{static} \&{mp\_gr\_knot} \\{mp\_export\_path}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \\{pp};\C{ for list manipulation }\6
\&{mp\_gr\_knot} \|q${},{}$ \\{qq};\7
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|q\K\\{mp\_export\_knot}(\\{mp},\39\|p);{}$\6
${}\\{qq}\K\|q;{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\|p);{}$\6
\&{while} ${}(\\{pp}\I\|p){}$\5
${}\{{}$\1\6
${}\\{mp\_gr\_next\_knot}(\\{qq})\K\\{mp\_export\_knot}(\\{mp},\39\\{pp});{}$\6
${}\\{qq}\K\\{mp\_gr\_next\_knot}(\\{qq});{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\\{pp});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_gr\_next\_knot}(\\{qq})\K\|q;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{320}If we want to import a knot node, we can say \PB{\\{import\_knot}}:

\Y\B\&{static} \&{mp\_knot} \\{mp\_import\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_gr\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ the copy }\7
${}\|q\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{y\_coord},\39\|p\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_x},\39\|p\MG\\{left\_x});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_y},\39\|p\MG\\{left\_y});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_x},\39\|p\MG\\{right\_x});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_y},\39\|p\MG\\{right\_y});{}$\6
${}\\{mp\_left\_type}(\|q)\K\|p\MG\\{data}.\\{types}.\\{left\_type};{}$\6
${}\\{mp\_left\_type}(\|q)\K\|p\MG\\{data}.\\{types}.\\{right\_type};{}$\6
${}\\{mp\_knot\_info}(\|q)\K\|p\MG\\{data}.\\{info};{}$\6
${}\\{mp\_next\_knot}(\|q)\K\NULL;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{321}The \PB{\\{import\_path}} routine makes a clone of a given path
and converts the \PB{\\{value}}s therein to \PB{\\{scaled}}s.

\Y\B\&{static} \&{mp\_knot} \\{mp\_import\_path}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_gr\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_gr\_knot} \\{pp};\C{ for list manipulation }\6
\&{mp\_knot} \|q${},{}$ \\{qq};\7
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|q\K\\{mp\_import\_knot}(\\{mp},\39\|p);{}$\6
${}\\{qq}\K\|q;{}$\6
${}\\{pp}\K\\{mp\_gr\_next\_knot}(\|p);{}$\6
\&{while} ${}(\\{pp}\I\|p){}$\5
${}\{{}$\1\6
${}\\{mp\_next\_knot}(\\{qq})\K\\{mp\_import\_knot}(\\{mp},\39\\{pp});{}$\6
${}\\{qq}\K\\{mp\_next\_knot}(\\{qq});{}$\6
${}\\{pp}\K\\{mp\_gr\_next\_knot}(\\{pp});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_next\_knot}(\\{qq})\K\|q;{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{322}Just before \PB{\\{ship\_out}}, knot lists are exported for printing.

\fi

\M{323}The \PB{\\{export\_knot\_list}} routine therefore also makes a clone
of a given path.

\Y\B\&{static} \&{mp\_gr\_knot} \\{mp\_export\_knot\_list}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_gr\_knot} \|q;\C{ the exported copy }\7
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|q\K\\{mp\_export\_path}(\\{mp},\39\|p);{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\7
\&{static} \&{mp\_knot} \\{mp\_import\_knot\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_gr\_knot} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p;\C{ the imported copy }\7
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|p\K\\{mp\_import\_path}(\\{mp},\39\|q);{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{324}Similarly, there's a way to copy the {\sl reverse\/} of a path. This
procedure
returns a pointer to the first node of the copy, if the path is a cycle,
but to the final node of a non-cyclic copy. The global
variable \PB{\\{path\_tail}} will point to the final node of the original path;
this trick makes it easier to implement `\&{doublepath}'.

All node types are assumed to be \PB{\\{endpoint}} or \PB{\&{explicit}} only.

\Y\B\&{static} \&{mp\_knot} \\{mp\_htap\_ypoc}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q${},{}$ \\{pp}${},{}$ \\{qq}${},{}$ \\{rr};\C{ for list
manipulation }\7
${}\|q\K\\{mp\_new\_knot}(\\{mp}){}$;\C{ this will correspond to \PB{\|p} }\6
${}\\{qq}\K\|q;{}$\6
${}\\{pp}\K\|p;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{qq})\K\\{mp\_left\_type}(\\{pp});{}$\6
${}\\{mp\_left\_type}(\\{qq})\K\\{mp\_right\_type}(\\{pp});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{x\_coord},\39\\{pp}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{y\_coord},\39\\{pp}\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{right\_x},\39\\{pp}\MG\\{left\_x});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{right\_y},\39\\{pp}\MG\\{left\_y});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{left\_x},\39\\{pp}\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\\{qq}\MG\\{left\_y},\39\\{pp}\MG\\{right\_y});{}$\6
${}\\{mp\_originator}(\\{qq})\K\\{mp\_originator}(\\{pp});{}$\6
\&{if} ${}(\\{mp\_next\_knot}(\\{pp})\E\|p){}$\5
${}\{{}$\1\6
${}\\{mp\_next\_knot}(\|q)\K\\{qq};{}$\6
${}\\{mp}\MG\\{path\_tail}\K\\{pp};{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\6
${}\\{rr}\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_next\_knot}(\\{rr})\K\\{qq};{}$\6
${}\\{qq}\K\\{rr};{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\\{pp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{325}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_knot} \\{path\_tail};\C{ the node that links to the beginning of a path
}\par
\fi

\M{326}When a cyclic list of knot nodes is no longer needed, it can be recycled
by
calling the following subroutine.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_toss\_knot\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p);\6
\&{static} \&{void} \\{mp\_toss\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p);\6
\&{static} \&{void} \\{mp\_free\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p);\par
\fi

\M{327}\B\&{void} \\{mp\_free\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q)\1%
\1\2\2\6
${}\{{}$\1\6
${}\\{free\_number}(\|q\MG\\{x\_coord});{}$\6
${}\\{free\_number}(\|q\MG\\{y\_coord});{}$\6
${}\\{free\_number}(\|q\MG\\{left\_x});{}$\6
${}\\{free\_number}(\|q\MG\\{left\_y});{}$\6
${}\\{free\_number}(\|q\MG\\{right\_x});{}$\6
${}\\{free\_number}(\|q\MG\\{right\_y});{}$\6
\\{mp\_xfree}(\|q);\6
\4${}\}{}$\2\7
\&{void} \\{mp\_toss\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{num\_knot\_nodes}<\\{max\_num\_knot\_nodes}){}$\5
${}\{{}$\1\6
${}\|q\MG\\{next}\K\\{mp}\MG\\{knot\_nodes};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\|q;{}$\6
${}\\{mp}\MG\\{num\_knot\_nodes}\PP;{}$\6
\&{return};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_knot}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_xfree}(\|q);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{void} \\{mp\_toss\_knot\_list}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ the node being freed }\6
\&{mp\_knot} \|r;\C{ the next node }\7
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return};\2\6
${}\|q\K\|p;{}$\6
\&{if} ${}(\\{mp}\MG\\{math\_mode}>\\{mp\_math\_double\_mode}){}$\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{mp\_toss\_knot}(\\{mp},\39\|q);{}$\6
${}\|q\K\|r;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\\{mp\_next\_knot}(\|q);{}$\6
\&{if} ${}(\\{mp}\MG\\{num\_knot\_nodes}<\\{max\_num\_knot\_nodes}){}$\5
${}\{{}$\1\6
${}\|q\MG\\{next}\K\\{mp}\MG\\{knot\_nodes};{}$\6
${}\\{mp}\MG\\{knot\_nodes}\K\|q;{}$\6
${}\\{mp}\MG\\{num\_knot\_nodes}\PP;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_xfree}(\|q);\6
\4${}\}{}$\2\6
${}\|q\K\|r;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{328}Choosing control points.
Now we must actually delve into one of \MP's more difficult routines,
the \PB{\\{make\_choices}} procedure that chooses angles and control points for
the splines of a curve when the user has not specified them explicitly.
The parameter to \PB{\\{make\_choices}} points to a list of knots and
path information, as described above.

A path decomposes into independent segments at ``breakpoint'' knots,
which are knots whose left and right angles are both prespecified in
some way (i.e., their \PB{\\{mp\_left\_type}} and \PB{\\{mp\_right\_type}}
aren't both open).

\Y\B\&{void} \\{mp\_make\_choices}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\\{knots})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|h;\C{ the first breakpoint }\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ consecutive breakpoints being processed }\7
\X342:Other local variables for \PB{\\{make\_choices}}\X;\6
\.{FUNCTION\_TRACE1}(\.{"make\_choices()\\n"});\6
\\{check\_arith}(\,);\C{ make sure that \PB{$\\{arith\_error}\K\\{false}$} }\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_choices})))\1\5
${}\\{mp\_print\_path}(\\{mp},\39\\{knots},\39\.{",\ before\ choices"},\39%
\\{true});{}$\2\6
\X331:If consecutive knots are equal, join them explicitly\X;\6
\X332:Find the first breakpoint, \PB{\|h}, on the path; insert an artificial
breakpoint if the path is an unbroken cycle\X;\6
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
\X333:Fill in the control points between \PB{\|p} and the next breakpoint, then
advance \PB{\|p} to that breakpoint\X;\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_choices})))\1\5
${}\\{mp\_print\_path}(\\{mp},\39\\{knots},\39\.{",\ after\ choices"},\39%
\\{true});{}$\2\6
\&{if} ${}(\\{mp}\MG\\{arith\_error}){}$\5
${}\{{}$\1\6
\X330:Report an unexpected problem during the choice-making\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{329}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_make\_choices}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \\{knots});%
\par
\fi

\M{330}\B\X330:Report an unexpected problem during the choice-making\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ path\ that\ I\ jus}\)\.{t\
computed\ is\ out\ of}\)\.{\ range."},\39\.{"So\ it\ will\ probably}\)\.{\ look%
\ funny.\ Proceed}\)\.{,\ for\ a\ laugh."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Some\ number\ got\ too}\)\.{\ big"},\39%
\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{arith\_error}\K\\{false};{}$\6
\4${}\}{}$\2\par
\U328.\fi

\M{331}Two knots in a row with the same coordinates will always be joined
by an explicit ``curve'' whose control points are identical with the
knots.

\Y\B\4\X331:If consecutive knots are equal, join them explicitly\X${}\E{}$\6
$\|p\K\\{knots};$ \&{do} \6
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}(\\{number\_equal}(\|p\MG\\{x\_coord},\39\|q\MG\\{x\_coord})\W%
\\{number\_equal}(\|p\MG\\{y\_coord},\39\|q\MG\\{y\_coord})\W\\{mp\_right%
\_type}(\|p)>\\{mp\_explicit}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|p)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\|p\MG\\{left\_curl});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_explicit};{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\|q\MG\\{right\_curl});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_x},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_y},\39\|p\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\|p\I\\{knots}{}$)\par
\U328.\fi

\M{332}If there are no breakpoints, it is necessary to compute the direction
angles around an entire cycle. In this case the \PB{\\{mp\_left\_type}} of the
first
node is temporarily changed to \PB{\\{end\_cycle}}.

\Y\B\4\X332:Find the first breakpoint, \PB{\|h}, on the path; insert an
artificial breakpoint if the path is an unbroken cycle\X${}\E{}$\6
$\|h\K\\{knots};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|h)\I\\{mp\_open}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_right\_type}(\|h)\I\\{mp\_open}){}$\1\5
\&{break};\2\6
${}\|h\K\\{mp\_next\_knot}(\|h);{}$\6
\&{if} ${}(\|h\E\\{knots}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|h)\K\\{mp\_end\_cycle};{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U328.\fi

\M{333}If \PB{$\\{mp\_right\_type}(\|p)<\\{given}$} and \PB{$\|q\K\\{mp\_link}(%
\|p)$}, we must have
\PB{$\\{mp\_right\_type}(\|p)\K\\{mp\_left\_type}(\|q)\K\\{mp\_explicit}$} or %
\PB{\\{endpoint}}.

\Y\B\4\X333:Fill in the control points between \PB{\|p} and the next
breakpoint, then advance \PB{\|p} to that breakpoint\X${}\E{}$\6
$\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\G\\{mp\_given}){}$\5
${}\{{}$\1\6
\&{while} ${}((\\{mp\_left\_type}(\|q)\E\\{mp\_open})\W(\\{mp\_right\_type}(%
\|q)\E\\{mp\_open})){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
\4${}\}{}$\2\6
\X339:Fill in the control information between consecutive breakpoints \PB{\|p}
and \PB{\|q}\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\X334:Give reasonable values for the unused control points between \PB{\|p}
and~\PB{\|q}\X;\6
\4${}\}{}$\2\6
$\|p\K{}$\|q\par
\U328.\fi

\M{334}This step makes it possible to transform an explicitly computed path
without
checking the \PB{\\{mp\_left\_type}} and \PB{\\{mp\_right\_type}} fields.

\Y\B\4\X334:Give reasonable values for the unused control points between \PB{%
\|p} and~\PB{\|q}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{number\_clone}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_x},\39\|q\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{left\_y},\39\|q\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U333.\fi

\M{335}Before we can go further into the way choices are made, we need to
consider the underlying theory. The basic ideas implemented in \PB{\\{make%
\_choices}}
are due to John Hobby, who introduced the notion of ``mock curvature''
at a knot. Angles are chosen so that they preserve mock curvature when
a knot is passed, and this has been found to produce excellent results.

It is convenient to introduce some notations that simplify the necessary
formulas. Let $d_{k,k+1}=\vert z\k-z_k\vert$ be the (nonzero) distance
between knots \PB{\|k} and \PB{$\|k+\T{1}$}; and let
$${z\k-z_k\over z_k-z_{k-1}}={d_{k,k+1}\over d_{k-1,k}}e^{i\psi_k}$$
so that a polygonal line from $z_{k-1}$ to $z_k$ to $z\k$ turns left
through an angle of~$\psi_k$. We assume that $\vert\psi_k\vert\L180^\circ$.
The control points for the spline from $z_k$ to $z\k$ will be denoted by
$$\eqalign{z_k^+&=z_k+
\textstyle{1\over3}\rho_k e^{i\theta_k}(z\k-z_k),\cr
z\k^-&=z\k-
\textstyle{1\over3}\sigma\k e^{-i\phi\k}(z\k-z_k),\cr}$$
where $\rho_k$ and $\sigma\k$ are nonnegative ``velocity ratios'' at the
beginning and end of the curve, while $\theta_k$ and $\phi\k$ are the
corresponding ``offset angles.'' These angles satisfy the condition
$$\theta_k+\phi_k+\psi_k=0,\eqno(*)$$
whenever the curve leaves an intermediate knot~\PB{\|k} in the direction that
it enters.

\fi

\M{336}Let $\alpha_k$ and $\beta\k$ be the reciprocals of the ``tension'' of
the curve at its beginning and ending points. This means that
$\rho_k=\alpha_k f(\theta_k,\phi\k)$ and $\sigma\k=\beta\k f(\phi\k,\theta_k)$,
where $f(\theta,\phi)$ is \MP's standard velocity function defined in
the \PB{\\{velocity}} subroutine. The cubic spline $B(z_k^{\phantom+},z_k^+,
z\k^-,z\k^{\phantom+};t)$
has curvature
$${2\sigma\k\sin(\theta_k+\phi\k)-6\sin\theta_k\over\rho_k^2d_{k,k+1}}
\qquad{\rm and}\qquad
{2\rho_k\sin(\theta_k+\phi\k)-6\sin\phi\k\over\sigma\k^2d_{k,k+1}}$$
at \PB{$\|t\K\T{0}$} and \PB{$\|t\K\T{1}$}, respectively. The mock curvature is
the linear
approximation to this true curvature that arises in the limit for
small $\theta_k$ and~$\phi\k$, if second-order terms are discarded.
The standard velocity function satisfies
$$f(\theta,\phi)=1+O(\theta^2+\theta\phi+\phi^2);$$
hence the mock curvatures are respectively
$${2\beta\k(\theta_k+\phi\k)-6\theta_k\over\alpha_k^2d_{k,k+1}}
\qquad{\rm and}\qquad
{2\alpha_k(\theta_k+\phi\k)-6\phi\k\over\beta\k^2d_{k,k+1}}.\eqno(**)$$

\fi

\M{337}The turning angles $\psi_k$ are given, and equation $(*)$ above
determines $\phi_k$ when $\theta_k$ is known, so the task of
angle selection is essentially to choose appropriate values for each
$\theta_k$. When equation~$(*)$ is used to eliminate $\phi$~variables
from $(**)$, we obtain a system of linear equations of the form
$$A_k\theta_{k-1}+(B_k+C_k)\theta_k+D_k\theta\k=-B_k\psi_k-D_k\psi\k,$$
where
$$A_k={\alpha_{k-1}\over\beta_k^2d_{k-1,k}},
\qquad B_k={3-\alpha_{k-1}\over\beta_k^2d_{k-1,k}},
\qquad C_k={3-\beta\k\over\alpha_k^2d_{k,k+1}},
\qquad D_k={\beta\k\over\alpha_k^2d_{k,k+1}}.$$
The tensions are always $3\over4$ or more, hence each $\alpha$ and~$\beta$
will be at most $4\over3$. It follows that $B_k\G{5\over4}A_k$ and
$C_k\G{5\over4}D_k$; hence the equations are diagonally dominant;
hence they have a unique solution. Moreover, in most cases the tensions
are equal to~1, so that $B_k=2A_k$ and $C_k=2D_k$. This makes the
solution numerically stable, and there is an exponential damping
effect: The data at knot $k\pm j$ affects the angle at knot~$k$ by
a factor of~$O(2^{-j})$.

\fi

\M{338}However, we still must consider the angles at the starting and ending
knots of a non-cyclic path. These angles might be given explicitly, or
they might be specified implicitly in terms of an amount of ``curl.''

Let's assume that angles need to be determined for a non-cyclic path
starting at $z_0$ and ending at~$z_n$. Then equations of the form
$$A_k\theta_{k-1}+(B_k+C_k)\theta_k+D_k\theta_{k+1}=R_k$$
have been given for $0<k<n$, and it will be convenient to introduce
equations of the same form for $k=0$ and $k=n$, where
$$A_0=B_0=C_n=D_n=0.$$
If $\theta_0$ is supposed to have a given value $E_0$, we simply
define $C_0=1$, $D_0=0$, and $R_0=E_0$. Otherwise a curl
parameter, $\gamma_0$, has been specified at~$z_0$; this means
that the mock curvature at $z_0$ should be $\gamma_0$ times the
mock curvature at $z_1$; i.e.,
$${2\beta_1(\theta_0+\phi_1)-6\theta_0\over\alpha_0^2d_{01}}
=\gamma_0{2\alpha_0(\theta_0+\phi_1)-6\phi_1\over\beta_1^2d_{01}}.$$
This equation simplifies to
$$(\alpha_0\chi_0+3-\beta_1)\theta_0+
\bigl((3-\alpha_0)\chi_0+\beta_1\bigr)\theta_1=
-\bigl((3-\alpha_0)\chi_0+\beta_1\bigr)\psi_1,$$
where $\chi_0=\alpha_0^2\gamma_0/\beta_1^2$; so we can set $C_0=
\chi_0\alpha_0+3-\beta_1$, $D_0=(3-\alpha_0)\chi_0+\beta_1$, $R_0=-D_0\psi_1$.
It can be shown that $C_0>0$ and $C_0B_1-A_1D_0>0$ when $\gamma_0\G0$,
hence the linear equations remain nonsingular.

Similar considerations apply at the right end, when the final angle $\phi_n$
may or may not need to be determined. It is convenient to let $\psi_n=0$,
hence $\theta_n=-\phi_n$. We either have an explicit equation $\theta_n=E_n$,
or we have
$$\bigl((3-\beta_n)\chi_n+\alpha_{n-1}\bigr)\theta_{n-1}+
(\beta_n\chi_n+3-\alpha_{n-1})\theta_n=0,\qquad
\chi_n={\beta_n^2\gamma_n\over\alpha_{n-1}^2}.$$

When \PB{\\{make\_choices}} chooses angles, it must compute the coefficients of
these linear equations, then solve the equations. To compute the coefficients,
it is necessary to compute arctangents of the given turning angles~$\psi_k$.
When the equations are solved, the chosen directions $\theta_k$ are put
back into the form of control points by essentially computing sines and
cosines.

\fi

\M{339}OK, we are ready to make the hard choices of \PB{\\{make\_choices}}.
Most of the work is relegated to an auxiliary procedure
called \PB{\\{solve\_choices}}, which has been introduced to keep
\PB{\\{make\_choices}} from being extremely long.

\Y\B\4\X339:Fill in the control information between consecutive breakpoints %
\PB{\|p} and \PB{\|q}\X${}\E{}$\6
\X343:Calculate the turning angles $\psi_k$ and the distances $d_{k,k+1}$; set
$n$ to the length of the path\X;\6
\X344:Remove \PB{\\{open}} types at the breakpoints\X;\6
$\\{mp\_solve\_choices}(\\{mp},\39\|p,\39\|q,\39\|n{}$)\par
\U333.\fi

\M{340}It's convenient to precompute quantities that will be needed several
times later. The values of \PB{\\{delta\_x}[\|k]} and \PB{\\{delta\_y}[\|k]}
will be the
coordinates of $z\k-z_k$, and the magnitude of this vector will be
\PB{\\{delta}[\|k] $\K\hbox{$d_{k,k+1}$}$}. The path angle $\psi_k$ between
$z_k-z_{k-1}$
and $z\k-z_k$ will be stored in \PB{\\{psi}[\|k]}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{path\_size};\C{ maximum number of knots between breakpoints of a
path }\6
\&{mp\_number} ${}{*}\\{delta\_x};{}$\6
\&{mp\_number} ${}{*}\\{delta\_y};{}$\6
\&{mp\_number} ${}{*}\\{delta}{}$;\C{ knot differences }\6
\&{mp\_number} ${}{*}\\{psi}{}$;\C{ turning angles }\par
\fi

\M{341}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|k;\7
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{mp}\MG\\{path\_size};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{delta\_x}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{delta\_y}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{delta}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{psi}[\|k]);{}$\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{delta\_x});{}$\6
${}\\{xfree}(\\{mp}\MG\\{delta\_y});{}$\6
${}\\{xfree}(\\{mp}\MG\\{delta});{}$\6
${}\\{xfree}(\\{mp}\MG\\{psi});{}$\6
\4${}\}{}$\2\par
\fi

\M{342}\B\X342:Other local variables for \PB{\\{make\_choices}}\X${}\E{}$\6
\&{int} \|k${},{}$ \|n;\C{ current and final knot numbers }\6
\&{mp\_knot} \|s${},{}$ \|t;\C{ registers for list traversal }\par
\U328.\fi

\M{343}\B\X343:Calculate the turning angles $\psi_k$ and the distances
$d_{k,k+1}$; set $n$ to the length of the path\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{sine}${},{}$ \\{cosine};\C{ trig functions of various angles
}\7
\\{new\_fraction}(\\{sine});\6
\\{new\_fraction}(\\{cosine});\6
\4\.{RESTART}:\5
${}\|k\K\T{0};{}$\6
${}\|s\K\|p;{}$\6
${}\|n\K\\{mp}\MG\\{path\_size};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|t\K\\{mp\_next\_knot}(\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{delta\_x}[\|k],\39\|t\MG\\{x%
\_coord},\39\|s\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{delta\_y}[\|k],\39\|t\MG\\{y%
\_coord},\39\|s\MG\\{y\_coord});{}$\6
${}\\{pyth\_add}(\\{mp}\MG\\{delta}[\|k],\39\\{mp}\MG\\{delta\_x}[\|k],\39%
\\{mp}\MG\\{delta\_y}[\|k]);{}$\6
\&{if} ${}(\|k>\T{0}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{r1}${},{}$ \\{r2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{make\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\|k-\T{1}],\39\\{mp}\MG%
\\{delta}[\|k-\T{1}]);{}$\6
${}\\{number\_clone}(\\{sine},\39\\{r1});{}$\6
${}\\{make\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_x}[\|k-\T{1}],\39\\{mp}\MG%
\\{delta}[\|k-\T{1}]);{}$\6
${}\\{number\_clone}(\\{cosine},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{cosine});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{sine});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{cosine});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{sine});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{r1},\39\\{r2});{}$\6
${}\\{n\_arg}(\\{mp}\MG\\{psi}[\|k],\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\\{incr}(\|k);\6
${}\|s\K\|t;{}$\6
\&{if} ${}(\|k\E\\{mp}\MG\\{path\_size}){}$\5
${}\{{}$\1\6
${}\\{mp\_reallocate\_paths}(\\{mp},\39\\{mp}\MG\\{path\_size}+(\\{mp}\MG%
\\{path\_size}/\T{4}));{}$\6
\&{goto} \.{RESTART};\C{ retry, loop size has changed }\6
\4${}\}{}$\2\6
\&{if} ${}(\|s\E\|q){}$\1\5
${}\|n\K\|k;{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\R((\|k\G\|n)\W(\\{mp\_left\_type}(\|s)\I\\{mp\_end%
\_cycle})));{}$\6
\&{if} ${}(\|k\E\|n){}$\1\5
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{psi}[\|k]);{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{mp}\MG\\{psi}[\|k],\39\\{mp}\MG\\{psi}[\T{1}]);{}$\2\6
\\{free\_number}(\\{sine});\6
\\{free\_number}(\\{cosine});\6
\4${}\}{}$\2\par
\U339.\fi

\M{344}When we get to this point of the code, \PB{\\{mp\_right\_type}(\|p)} is
either
\PB{\\{given}} or \PB{\\{curl}} or \PB{\\{open}}. If it is \PB{\\{open}}, we
must have
\PB{$\\{mp\_left\_type}(\|p)\K\\{mp\_end\_cycle}$} or \PB{$\\{mp\_left\_type}(%
\|p)\K\\{mp\_explicit}$}. In the latter
case, the \PB{\\{open}} type is converted to \PB{\\{given}}; however, if the
velocity coming into this knot is zero, the \PB{\\{open}} type is
converted to a \PB{\\{curl}}, since we don't know the incoming direction.

Similarly, \PB{\\{mp\_left\_type}(\|q)} is either \PB{\\{given}} or \PB{%
\\{curl}} or \PB{\\{open}} or
\PB{\\{mp\_end\_cycle}}. The \PB{\\{open}} possibility is reduced either to %
\PB{\\{given}} or to \PB{\\{curl}}.

\Y\B\4\X344:Remove \PB{\\{open}} types at the breakpoints\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{delx}${},{}$ \\{dely};\C{ directions where \PB{\\{open}}
meets \PB{\&{explicit}} }\7
\\{new\_number}(\\{delx});\6
\\{new\_number}(\\{dely});\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{delx},\39\|q\MG\\{right\_x},\39\|q\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dely},\39\|q\MG\\{right\_y},\39\|q\MG%
\\{y\_coord});{}$\6
\&{if} ${}(\\{number\_zero}(\\{delx})\W\\{number\_zero}(\\{dely})){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\|q\MG\\{left\_curl});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_given};{}$\6
${}\\{n\_arg}(\|q\MG\\{left\_given},\39\\{delx},\39\\{dely});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}((\\{mp\_right\_type}(\|p)\E\\{mp\_open})\W(\\{mp\_left\_type}(\|p)\E%
\\{mp\_explicit})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{delx},\39\|p\MG\\{x\_coord},\39\|p\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dely},\39\|p\MG\\{y\_coord},\39\|p\MG%
\\{left\_y});{}$\6
\&{if} ${}(\\{number\_zero}(\\{delx})\W\\{number\_zero}(\\{dely})){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\|p\MG\\{right\_curl});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_given};{}$\6
${}\\{n\_arg}(\|p\MG\\{right\_given},\39\\{delx},\39\\{dely});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{delx});\6
\\{free\_number}(\\{dely});\6
\4${}\}{}$\2\par
\U339.\fi

\M{345}Linear equations need to be solved whenever \PB{$\|n>\T{1}$}; and also
when \PB{$\|n\K\T{1}$}
and exactly one of the breakpoints involves a curl. The simplest case occurs
when \PB{$\|n\K\T{1}$} and there is a curl at both breakpoints; then we simply
draw
a straight line.

But before coding up the simple cases, we might as well face the general case,
since we must deal with it sooner or later, and since the general case
is likely to give some insight into the way simple cases can be handled best.

When there is no cycle, the linear equations to be solved form a tridiagonal
system, and we can apply the standard technique of Gaussian elimination
to convert that system to a sequence of equations of the form
$$\theta_0+u_0\theta_1=v_0,\quad
\theta_1+u_1\theta_2=v_1,\quad\ldots,\quad
\theta_{n-1}+u_{n-1}\theta_n=v_{n-1},\quad
\theta_n=v_n.$$
It is possible to do this diagonalization while generating the equations.
Once $\theta_n$ is known, it is easy to determine $\theta_{n-1}$, \dots,
$\theta_1$, $\theta_0$; thus, the equations will be solved.

The procedure is slightly more complex when there is a cycle, but the
basic idea will be nearly the same. In the cyclic case the right-hand
sides will be $v_k+w_k\theta_0$ instead of simply $v_k$, and we will start
the process off with $u_0=v_0=0$, $w_0=1$. The final equation will be not
$\theta_n=v_n$ but $\theta_n+u_n\theta_1=v_n+w_n\theta_0$; an appropriate
ending routine will take account of the fact that $\theta_n=\theta_0$ and
eliminate the $w$'s from the system, after which the solution can be
obtained as before.

When $u_k$, $v_k$, and $w_k$ are being computed, the three pointer
variables \PB{\|r}, \PB{\|s},~\PB{\|t} will point respectively to knots \PB{$%
\|k-\T{1}$}, \PB{\|k},
and~\PB{$\|k+\T{1}$}. The $u$'s and $w$'s are scaled by $2^{28}$, i.e., they
are
of type \PB{\\{fraction}}; the $\theta$'s and $v$'s are of type \PB{\\{angle}}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} ${}{*}\\{theta}{}$;\C{ values of $\theta_k$ }\6
\&{mp\_number} ${}{*}\\{uu}{}$;\C{ values of $u_k$ }\6
\&{mp\_number} ${}{*}\\{vv}{}$;\C{ values of $v_k$ }\6
\&{mp\_number} ${}{*}\\{ww}{}$;\C{ values of $w_k$ }\par
\fi

\M{346}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|k;\7
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{mp}\MG\\{path\_size};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{theta}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{uu}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{vv}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{ww}[\|k]);{}$\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{theta});{}$\6
${}\\{xfree}(\\{mp}\MG\\{uu});{}$\6
${}\\{xfree}(\\{mp}\MG\\{vv});{}$\6
${}\\{xfree}(\\{mp}\MG\\{ww});{}$\6
\4${}\}{}$\2\par
\fi

\M{347}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_reallocate\_paths}(\&{MP} \\{mp}${},\39{}$\&{int} %
\|l);\par
\fi

\M{348}\B\&{void} \\{mp\_reallocate\_paths}(\&{MP} \\{mp}${},\39{}$\&{int} \|l)%
\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\7
${}\.{XREALLOC}(\\{mp}\MG\\{delta\_x},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{delta\_y},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{delta},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{psi},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{theta},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{uu},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{vv},\39\|l,\39\&{mp\_number});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{ww},\39\|l,\39\&{mp\_number});{}$\6
\&{for} ${}(\|k\K\\{mp}\MG\\{path\_size};{}$ ${}\|k<\|l;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{mp}\MG\\{delta\_x}[\|k]);{}$\6
${}\\{new\_number}(\\{mp}\MG\\{delta\_y}[\|k]);{}$\6
${}\\{new\_number}(\\{mp}\MG\\{delta}[\|k]);{}$\6
${}\\{new\_angle}(\\{mp}\MG\\{psi}[\|k]);{}$\6
${}\\{new\_angle}(\\{mp}\MG\\{theta}[\|k]);{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{uu}[\|k]);{}$\6
${}\\{new\_angle}(\\{mp}\MG\\{vv}[\|k]);{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{ww}[\|k]);{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{path\_size}\K\|l;{}$\6
\4${}\}{}$\2\par
\fi

\M{349}Our immediate problem is to get the ball rolling by setting up the
first equation or by realizing that no equations are needed, and to fit
this initialization into a framework suitable for the overall computation.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_solve\_choices}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{halfword} \|n);\par
\fi

\M{350}\B\&{void} \\{mp\_solve\_choices}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{halfword} \|n)\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\C{ current knot number }\6
\&{mp\_knot} \|r${},{}$ \|s${},{}$ \|t;\C{ registers for list traversal }\6
\&{mp\_number} \\{ff};\7
\\{new\_fraction}(\\{ff});\6
${}\.{FUNCTION\_TRACE2}(\.{"solve\_choices(\%d)\\n}\)\.{"},\39\|n);{}$\6
${}\|k\K\T{0};{}$\6
${}\|s\K\|p;{}$\6
${}\|r\K\T{0};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|t\K\\{mp\_next\_knot}(\|s);{}$\6
\&{if} ${}(\|k\E\T{0}){}$\5
${}\{\X351:Get the linear equations started; or \PB{\&{return}} with the
control points in place, if linear equations needn't be solved\X\}{}$\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\\{mp\_left\_type}(\|s))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_end\_cycle}:\5
\&{case} \\{mp\_open}:\5
\X353:Set up equation to match mock curvatures at $z_k$; then \PB{\&{goto} %
\\{found}} with $\theta_n$ adjusted to equal $\theta_0$, if a cycle has ended%
\X;\6
\&{break};\6
\4\&{case} \\{mp\_curl}:\5
\X363:Set up equation for a curl at $\theta_n$ and \PB{\&{goto} \\{found}}\X;\6
\&{break};\6
\4\&{case} \\{mp\_given}:\5
\X360:Calculate the given value of $\theta_n$ and \PB{\&{goto} \\{found}}\X;\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\4${}\}{}$\2\6
${}\|r\K\|s;{}$\6
${}\|s\K\|t;{}$\6
\\{incr}(\|k);\6
\4${}\}{}$\2\6
\4\.{FOUND}:\5
\X366:Finish choosing angles and assigning control points\X;\6
\\{free\_number}(\\{ff});\6
\4${}\}{}$\2\par
\fi

\M{351}On the first time through the loop, we have \PB{$\|k\K\T{0}$} and \PB{%
\|r} is not yet
defined. The first linear equation, if any, will have $A_0=B_0=0$.

\Y\B\4\X351:Get the linear equations started; or \PB{\&{return}} with the
control points in place, if linear equations needn't be solved\X${}\E{}$\6
\&{switch} (\\{mp\_right\_type}(\|s))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_given}:\6
\&{if} ${}(\\{mp\_left\_type}(\|t)\E\\{mp\_given}){}$\5
${}\{\X373:Reduce to simple case of two givens and \PB{\&{return}}\X\}{}$\6
\&{else}\5
${}\{{}$\1\6
\X361:Set up the equation for a given value of $\theta_0$\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_curl}:\6
\&{if} ${}(\\{mp\_left\_type}(\|t)\E\\{mp\_curl}){}$\5
${}\{\X374:Reduce to simple case of straight line and \PB{\&{return}}\X\}{}$\6
\&{else}\5
${}\{{}$\1\6
\X362:Set up the equation for a curl at $\theta_0$\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_open}:\5
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{uu}[\T{0}]);{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{vv}[\T{0}]);{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{ww}[\T{0}],\39\\{fraction\_one\_t}){}$;\C{
this begins a cycle }\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\par
\U350.\fi

\M{352}The general equation that specifies equality of mock curvature at $z_k$
is
$$A_k\theta_{k-1}+(B_k+C_k)\theta_k+D_k\theta\k=-B_k\psi_k-D_k\psi\k,$$
as derived above. We want to combine this with the already-derived equation
$\theta_{k-1}+u_{k-1}\theta_k=v_{k-1}+w_{k-1}\theta_0$ in order to obtain
a new equation
$\theta_k+u_k\theta\k=v_k+w_k\theta_0$. This can be done by dividing the
equation
$$(B_k-u_{k-1}A_k+C_k)\theta_k+D_k\theta\k=-B_k\psi_k-D_k\psi\k-A_kv_{k-1}
-A_kw_{k-1}\theta_0$$
by $B_k-u_{k-1}A_k+C_k$. The trick is to do this carefully with
fixed-point arithmetic, avoiding the chance of overflow while retaining
suitable precision.

The calculations will be performed in several registers that
provide temporary storage for intermediate quantities.

\fi

\M{353}\B\X353:Set up equation to match mock curvatures at $z_k$; then \PB{%
\&{goto} \\{found}} with $\theta_n$ adjusted to equal $\theta_0$, if a cycle
has ended\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{aa}${},{}$ \\{bb}${},{}$ \\{cc}${},{}$ \\{acc};\C{ temporary
registers }\6
\&{mp\_number} \\{dd}${},{}$ \\{ee};\C{ likewise, but \PB{\\{scaled}} }\7
\\{new\_fraction}(\\{aa});\6
\\{new\_fraction}(\\{bb});\6
\\{new\_fraction}(\\{cc});\6
\\{new\_fraction}(\\{acc});\6
\\{new\_number}(\\{dd});\6
\\{new\_number}(\\{ee});\6
\X354:Calculate the values $\\{aa}=A_k/B_k$, $\\{bb}=D_k/C_k$, $\\{dd}=(3-%
\alpha_{k-1})d_{k,k+1}$, $\\{ee}=(3-\beta\k)d_{k-1,k}$, and $%
\\{cc}=(B_k-u_{k-1}A_k)/B_k$\X;\6
\X355:Calculate the ratio $\\{ff}=C_k/(C_k+B_k-u_{k-1}A_k)$\X;\6
${}\\{take\_fraction}(\\{mp}\MG\\{uu}[\|k],\39\\{ff},\39\\{bb});{}$\6
\X356:Calculate the values of $v_k$ and $w_k$\X;\6
\&{if} ${}(\\{mp\_left\_type}(\|s)\E\\{mp\_end\_cycle}){}$\5
${}\{{}$\1\6
\X357:Adjust $\theta_n$ to equal $\theta_0$ and \PB{\&{goto} \\{found}}\X;\6
\4${}\}{}$\2\6
\\{free\_number}(\\{aa});\6
\\{free\_number}(\\{bb});\6
\\{free\_number}(\\{cc});\6
\\{free\_number}(\\{acc});\6
\\{free\_number}(\\{dd});\6
\\{free\_number}(\\{ee});\6
\4${}\}{}$\2\par
\U350.\fi

\M{354}Since tension values are never less than 3/4, the values \PB{\\{aa}} and
\PB{\\{bb}} computed here are never more than 4/5.

\Y\B\4\X354:Calculate the values $\\{aa}=A_k/B_k$, $\\{bb}=D_k/C_k$, $%
\\{dd}=(3-\alpha_{k-1})d_{k,k+1}$, $\\{ee}=(3-\beta\k)d_{k-1,k}$, and $%
\\{cc}=(B_k-u_{k-1}A_k)/B_k$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{absval};\7
\\{new\_number}(\\{absval});\6
${}\\{number\_clone}(\\{absval},\39\|r\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_equal}(\\{absval},\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{aa},\39\\{fraction\_half\_t});{}$\6
${}\\{number\_clone}(\\{dd},\39\\{mp}\MG\\{delta}[\|k]);{}$\6
\\{number\_double}(\\{dd});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{ret};\7
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg2},\39\|r\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{arg2});\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{3});{}$\6
${}\\{number\_substract}(\\{arg2},\39\\{unity\_t});{}$\6
${}\\{make\_fraction}(\\{aa},\39\\{unity\_t},\39\\{arg2});{}$\6
${}\\{number\_clone}(\\{arg2},\39\|r\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{arg2});\6
\\{new\_fraction}(\\{ret});\6
${}\\{make\_fraction}(\\{ret},\39\\{unity\_t},\39\\{arg2});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{fraction\_three\_t},\39%
\\{ret});{}$\6
${}\\{take\_fraction}(\\{arg2},\39\\{mp}\MG\\{delta}[\|k],\39\\{arg1});{}$\6
${}\\{number\_clone}(\\{dd},\39\\{arg2});{}$\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\|t\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_equal}(\\{absval},\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{bb},\39\\{fraction\_half\_t});{}$\6
${}\\{number\_clone}(\\{ee},\39\\{mp}\MG\\{delta}[\|k-\T{1}]);{}$\6
\\{number\_double}(\\{ee});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{ret};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg2},\39\|t\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{arg2});\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{3});{}$\6
${}\\{number\_substract}(\\{arg2},\39\\{unity\_t});{}$\6
${}\\{make\_fraction}(\\{bb},\39\\{unity\_t},\39\\{arg2});{}$\6
${}\\{number\_clone}(\\{arg2},\39\|t\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{arg2});\6
\\{new\_fraction}(\\{ret});\6
${}\\{make\_fraction}(\\{ret},\39\\{unity\_t},\39\\{arg2});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{fraction\_three\_t},\39%
\\{ret});{}$\6
${}\\{take\_fraction}(\\{ee},\39\\{mp}\MG\\{delta}[\|k-\T{1}],\39\\{arg1});{}$\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absval});\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{uu}[\|k-\T{1}],\39\\{aa});{}$\6
${}\\{set\_number\_from\_substraction}(\\{cc},\39\\{fraction\_one\_t},\39%
\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\par
\U353.\fi

\M{355}The ratio to be calculated in this step can be written in the form
$$\beta_k^2\cdot\\{ee}\over\beta_k^2\cdot\\{ee}+\alpha_k^2\cdot
\\{cc}\cdot\\{dd},$$
because of the quantities just calculated. The values of \PB{\\{dd}} and \PB{%
\\{ee}}
will not be needed after this step has been performed.

\Y\B\4\X355:Calculate the ratio $\\{ff}=C_k/(C_k+B_k-u_{k-1}A_k)$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{rt}${},{}$ \\{lt};\6
\&{mp\_number} \\{arg2};\7
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg2},\39\\{dd});{}$\6
${}\\{take\_fraction}(\\{dd},\39\\{arg2},\39\\{cc});{}$\6
\\{new\_number}(\\{lt});\6
\\{new\_number}(\\{rt});\6
${}\\{number\_clone}(\\{lt},\39\|s\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{lt});\6
${}\\{number\_clone}(\\{rt},\39\|s\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{rt});\6
\&{if} ${}(\R\\{number\_equal}(\\{lt},\39\\{rt})){}$\5
${}\{{}$\C{ $\beta_k^{-1}\ne\alpha_k^{-1}$ }\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
\&{if} ${}(\\{number\_less}(\\{lt},\39\\{rt})){}$\5
${}\{{}$\1\6
${}\\{make\_fraction}(\\{r1},\39\\{lt},\39\\{rt}){}$;\C{ $\alpha_k^2/\beta_k^2$
}\6
${}\\{take\_fraction}(\\{ff},\39\\{r1},\39\\{r1});{}$\6
${}\\{number\_clone}(\\{r1},\39\\{dd});{}$\6
${}\\{take\_fraction}(\\{dd},\39\\{r1},\39\\{ff});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{make\_fraction}(\\{r1},\39\\{rt},\39\\{lt}){}$;\C{ $\beta_k^2/\alpha_k^2$
}\6
${}\\{take\_fraction}(\\{ff},\39\\{r1},\39\\{r1});{}$\6
${}\\{number\_clone}(\\{r1},\39\\{ee});{}$\6
${}\\{take\_fraction}(\\{ee},\39\\{r1},\39\\{ff});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{rt});\6
\\{free\_number}(\\{lt});\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{dd},\39\\{ee});{}$\6
${}\\{make\_fraction}(\\{ff},\39\\{ee},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\U353.\fi

\M{356}The value of $u_{k-1}$ will be \PB{$\Z$ \T{1}} except when $k=1$ and the
previous
equation was specified by a curl. In that case we must use a special
method of computation to prevent overflow.

Fortunately, the calculations turn out to be even simpler in this ``hard''
case. The curl equation makes $w_0=0$ and $v_0=-u_0\psi_1$, hence
$-B_1\psi_1-A_1v_0=-(B_1-u_0A_1)\psi_1=-\\{cc}\cdot B_1\psi_1$.

\Y\B\4\X356:Calculate the values of $v_k$ and $w_k$\X${}\E{}$\6
$\\{take\_fraction}(\\{acc},\39\\{mp}\MG\\{psi}[\|k+\T{1}],\39\\{mp}\MG\\{uu}[%
\|k]);{}$\6
\\{number\_negate}(\\{acc});\6
\&{if} ${}(\\{mp\_right\_type}(\|r)\E\\{mp\_curl}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{arg2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{fraction\_one\_t},\39%
\\{ff});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{psi}[\T{1}],\39\\{arg2});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ww}[\|k]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{vv}[\|k],\39\\{acc},\39%
\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{r1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg1});\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{fraction\_one\_t},\39%
\\{ff});{}$\6
${}\\{make\_fraction}(\\{ff},\39\\{arg1},\39\\{cc}){}$;\C{ this is
$B_k/(C_k+B_k-u_{k-1}A_k)<5$ }\6
\\{free\_number}(\\{arg1});\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{psi}[\|k],\39\\{ff});{}$\6
${}\\{number\_substract}(\\{acc},\39\\{r1});{}$\6
${}\\{number\_clone}(\\{r1},\39\\{ff});{}$\6
${}\\{take\_fraction}(\\{ff},\39\\{r1},\39\\{aa}){}$;\C{ this is
$A_k/(C_k+B_k-u_{k-1}A_k)$ }\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{vv}[\|k-\T{1}],\39\\{ff});{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{vv}[\|k],\39\\{acc},\39%
\\{r1});{}$\6
\&{if} ${}(\\{number\_zero}(\\{mp}\MG\\{ww}[\|k-\T{1}])){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ww}[\|k]);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{mp}\MG\\{ww}[\|k],\39\\{mp}\MG\\{ww}[\|k-\T{1}],\39%
\\{ff});{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{ww}[\|k]);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\par
\U353.\fi

\M{357}When a complete cycle has been traversed, we have $\theta_k+u_k\theta\k=
v_k+w_k\theta_0$, for \PB{$\T{1}\Z\|k\Z\|n$}. We would like to determine the
value of
$\theta_n$ and reduce the system to the form $\theta_k+u_k\theta\k=v_k$
for \PB{$\T{0}\Z\|k<\|n$}, so that the cyclic case can be finished up just as
if there
were no cycle.

The idea in the following code is to observe that
$$\eqalign{\theta_n&=v_n+w_n\theta_0-u_n\theta_1=\cdots\cr
&=v_n+w_n\theta_0-u_n\bigl(v_1+w_1\theta_0-u_1(v_2+\cdots
-u_{n-2}(v_{n-1}+w_{n-1}\theta_0-u_{n-1}\theta_0))\bigr),\cr}$$
so we can solve for $\theta_n=\theta_0$.

\Y\B\4\X357:Adjust $\theta_n$ to equal $\theta_0$ and \PB{\&{goto} \\{found}}%
\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg2}${},{}$ \\{r1};\7
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{r1});\6
\\{set\_number\_to\_zero}(\\{aa});\6
${}\\{number\_clone}(\\{bb},\39\\{fraction\_one\_t}){}$;\C{ we have \PB{$\|k\K%
\|n$} }\6
\&{do}\5
${}\{{}$\1\6
\\{decr}(\|k);\6
\&{if} ${}(\|k\E\T{0}){}$\1\5
${}\|k\K\|n;{}$\2\6
${}\\{take\_fraction}(\\{r1},\39\\{aa},\39\\{mp}\MG\\{uu}[\|k]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{aa},\39\\{mp}\MG\\{vv}[\|k],\39%
\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{bb},\39\\{mp}\MG\\{uu}[\|k]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{bb},\39\\{mp}\MG\\{ww}[\|k],\39%
\\{r1});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|k\I\|n){}$;\C{ now $\theta_n=\\{aa}+\\{bb}\cdot\theta_n$ }\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{fraction\_one\_t},\39%
\\{bb});{}$\6
${}\\{make\_fraction}(\\{r1},\39\\{aa},\39\\{arg2});{}$\6
${}\\{number\_clone}(\\{aa},\39\\{r1});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{theta}[\|n],\39\\{aa});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{vv}[\T{0}],\39\\{aa});{}$\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\|k<\|n;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\\{aa},\39\\{mp}\MG\\{ww}[\|k]);{}$\6
${}\\{number\_add}(\\{mp}\MG\\{vv}[\|k],\39\\{r1});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{aa});\6
\\{free\_number}(\\{bb});\6
\\{free\_number}(\\{cc});\6
\\{free\_number}(\\{acc});\6
\\{free\_number}(\\{dd});\6
\\{free\_number}(\\{ee});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\par
\U353.\fi

\M{358}\B\&{void} \\{mp\_reduce\_angle}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|a){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{abs\_a};\7
${}\.{FUNCTION\_TRACE2}(\.{"reduce\_angle(\%f)\\n"},\39\\{number\_to%
\_double}({*}\|a));{}$\6
\\{new\_number}(\\{abs\_a});\6
${}\\{number\_clone}(\\{abs\_a},\39{*}\|a);{}$\6
\\{number\_abs}(\\{abs\_a});\6
\&{if} ${}(\\{number\_greater}(\\{abs\_a},\39\\{one\_eighty\_deg\_t})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_positive}({*}\|a)){}$\5
${}\{{}$\1\6
${}\\{number\_substract}({*}\|a,\39\\{three\_sixty\_deg\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_add}({*}\|a,\39\\{three\_sixty\_deg\_t});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abs\_a});\6
\4${}\}{}$\2\par
\fi

\M{359}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_reduce\_angle}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} ${}{*}%
\|a){}$;\par
\fi

\M{360}\B\X360:Calculate the given value of $\theta_n$ and \PB{\&{goto} %
\\{found}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{narg};\7
\\{new\_angle}(\\{narg});\6
${}\\{n\_arg}(\\{narg},\39\\{mp}\MG\\{delta\_x}[\|n-\T{1}],\39\\{mp}\MG\\{delta%
\_y}[\|n-\T{1}]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{theta}[\|n],\39\|s\MG\\{left%
\_given},\39\\{narg});{}$\6
\\{free\_number}(\\{narg});\6
${}\\{mp\_reduce\_angle}(\\{mp},\39{\AND}\\{mp}\MG\\{theta}[\|n]);{}$\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\par
\U350.\fi

\M{361}\B\X361:Set up the equation for a given value of $\theta_0$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{narg};\7
\\{new\_angle}(\\{narg});\6
${}\\{n\_arg}(\\{narg},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39\\{mp}\MG\\{delta%
\_y}[\T{0}]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{vv}[\T{0}],\39\|s\MG\\{right%
\_given},\39\\{narg});{}$\6
\\{free\_number}(\\{narg});\6
${}\\{mp\_reduce\_angle}(\\{mp},\39{\AND}\\{mp}\MG\\{vv}[\T{0}]);{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{uu}[\T{0}]);{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ww}[\T{0}]);{}$\6
\4${}\}{}$\2\par
\U351.\fi

\M{362}\B\X362:Set up the equation for a curl at $\theta_0$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{lt}${},{}$ \\{rt}${},{}$ \\{cc};\C{ tension values }\7
\\{new\_number}(\\{lt});\6
\\{new\_number}(\\{rt});\6
\\{new\_number}(\\{cc});\6
${}\\{number\_clone}(\\{cc},\39\|s\MG\\{right\_curl});{}$\6
${}\\{number\_clone}(\\{lt},\39\|t\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{lt});\6
${}\\{number\_clone}(\\{rt},\39\|s\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{rt});\6
\&{if} ${}(\\{number\_unity}(\\{rt})\W\\{number\_unity}(\\{lt})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg1},\39\\{cc});{}$\6
\\{number\_double}(\\{arg1});\6
${}\\{number\_add}(\\{arg1},\39\\{unity\_t});{}$\6
${}\\{number\_clone}(\\{arg2},\39\\{cc});{}$\6
${}\\{number\_add}(\\{arg2},\39\\{two\_t});{}$\6
${}\\{make\_fraction}(\\{mp}\MG\\{uu}[\T{0}],\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_curl\_ratio}(\\{mp},\39{\AND}\\{mp}\MG\\{uu}[\T{0}],\39\\{cc},\39%
\\{rt},\39\\{lt});{}$\6
\4${}\}{}$\2\6
${}\\{take\_fraction}(\\{mp}\MG\\{vv}[\T{0}],\39\\{mp}\MG\\{psi}[\T{1}],\39%
\\{mp}\MG\\{uu}[\T{0}]);{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{vv}[\T{0}]);{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ww}[\T{0}]);{}$\6
\\{free\_number}(\\{rt});\6
\\{free\_number}(\\{lt});\6
\\{free\_number}(\\{cc});\6
\4${}\}{}$\2\par
\U351.\fi

\M{363}\B\X363:Set up equation for a curl at $\theta_n$ and \PB{\&{goto} %
\\{found}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{lt}${},{}$ \\{rt}${},{}$ \\{cc};\C{ tension values }\7
\\{new\_number}(\\{lt});\6
\\{new\_number}(\\{rt});\6
\\{new\_number}(\\{cc});\6
${}\\{number\_clone}(\\{cc},\39\|s\MG\\{left\_curl});{}$\6
${}\\{number\_clone}(\\{lt},\39\|s\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{lt});\6
${}\\{number\_clone}(\\{rt},\39\|r\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{rt});\6
\&{if} ${}(\\{number\_unity}(\\{rt})\W\\{number\_unity}(\\{lt})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg1},\39\\{cc});{}$\6
\\{number\_double}(\\{arg1});\6
${}\\{number\_add}(\\{arg1},\39\\{unity\_t});{}$\6
${}\\{number\_clone}(\\{arg2},\39\\{cc});{}$\6
${}\\{number\_add}(\\{arg2},\39\\{two\_t});{}$\6
${}\\{make\_fraction}(\\{ff},\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_curl\_ratio}(\\{mp},\39{\AND}\\{ff},\39\\{cc},\39\\{lt},\39%
\\{rt});{}$\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{r1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{take\_fraction}(\\{arg1},\39\\{mp}\MG\\{vv}[\|n-\T{1}],\39\\{ff});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{ff},\39\\{mp}\MG\\{uu}[\|n-\T{1}]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{fraction\_one\_t},\39%
\\{r1});{}$\6
${}\\{make\_fraction}(\\{mp}\MG\\{theta}[\|n],\39\\{arg1},\39\\{arg2});{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{theta}[\|n]);{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{rt});\6
\\{free\_number}(\\{lt});\6
\\{free\_number}(\\{cc});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\par
\U350.\fi

\M{364}The \PB{\\{curl\_ratio}} subroutine has three arguments, which our
previous notation
encourages us to call $\gamma$, $\alpha^{-1}$, and $\beta^{-1}$. It is
a somewhat tedious program to calculate
$${(3-\alpha)\alpha^2\gamma+\beta^3\over
\alpha^3\gamma+(3-\beta)\beta^2},$$
with the result reduced to 4 if it exceeds 4. (This reduction of curl
is necessary only if the curl and tension are both large.)
The values of $\alpha$ and $\beta$ will be at most~4/3.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_curl\_ratio}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \\{gamma}${},\39{}$\&{mp\_number} \\{a%
\_tension}${},\39{}$\&{mp\_number} \\{b\_tension});\par
\fi

\M{365}\B\&{void} \\{mp\_curl\_ratio}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \\{gamma\_orig}${},\39{}$\&{mp\_number} \\{a%
\_tension}${},\39{}$\&{mp\_number} \\{b\_tension})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{alpha}${},{}$ \\{beta}${},{}$ \\{gamma}${},{}$ \\{num}${},{}$
\\{denom}${},{}$ \\{ff};\C{ registers }\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
\\{new\_fraction}(\\{alpha});\6
\\{new\_fraction}(\\{beta});\6
\\{new\_fraction}(\\{gamma});\6
\\{new\_fraction}(\\{ff});\6
\\{new\_fraction}(\\{denom});\6
\\{new\_fraction}(\\{num});\6
${}\\{make\_fraction}(\\{alpha},\39\\{unity\_t},\39\\{a\_tension});{}$\6
${}\\{make\_fraction}(\\{beta},\39\\{unity\_t},\39\\{b\_tension});{}$\6
${}\\{number\_clone}(\\{gamma},\39\\{gamma\_orig});{}$\6
\&{if} ${}(\\{number\_lessequal}(\\{alpha},\39\\{beta})){}$\5
${}\{{}$\1\6
${}\\{make\_fraction}(\\{ff},\39\\{alpha},\39\\{beta});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{ff});{}$\6
${}\\{take\_fraction}(\\{ff},\39\\{arg1},\39\\{arg1});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{gamma});{}$\6
${}\\{take\_fraction}(\\{gamma},\39\\{arg1},\39\\{ff});{}$\6
\\{convert\_fraction\_to\_scaled}(\\{beta});\6
${}\\{take\_fraction}(\\{denom},\39\\{gamma},\39\\{alpha});{}$\6
${}\\{number\_add}(\\{denom},\39\\{three\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{make\_fraction}(\\{ff},\39\\{beta},\39\\{alpha});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{ff});{}$\6
${}\\{take\_fraction}(\\{ff},\39\\{arg1},\39\\{arg1});{}$\6
${}\\{take\_fraction}(\\{arg1},\39\\{beta},\39\\{ff});{}$\6
\\{convert\_fraction\_to\_scaled}(\\{arg1});\6
${}\\{number\_clone}(\\{beta},\39\\{arg1});{}$\6
${}\\{take\_fraction}(\\{denom},\39\\{gamma},\39\\{alpha});{}$\6
${}\\{set\_number\_from\_div}(\\{arg1},\39\\{ff},\39\\{twelvebits\_3});{}$\6
${}\\{number\_add}(\\{denom},\39\\{arg1});{}$\6
\4${}\}{}$\2\6
${}\\{number\_substract}(\\{denom},\39\\{beta});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{fraction\_three\_t},\39%
\\{alpha});{}$\6
${}\\{take\_fraction}(\\{num},\39\\{gamma},\39\\{arg1});{}$\6
${}\\{number\_add}(\\{num},\39\\{beta});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{denom});{}$\6
\\{number\_double}(\\{arg1});\6
\\{number\_double}(\\{arg1});\C{ arg1 = 4*denom }\6
\&{if} ${}(\\{number\_greaterequal}(\\{num},\39\\{arg1})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\\{ret},\39\\{fraction\_four\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{make\_fraction}({*}\\{ret},\39\\{num},\39\\{denom});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{alpha});\6
\\{free\_number}(\\{beta});\6
\\{free\_number}(\\{gamma});\6
\\{free\_number}(\\{num});\6
\\{free\_number}(\\{denom});\6
\\{free\_number}(\\{ff});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\par
\fi

\M{366}We're in the home stretch now.

\Y\B\4\X366:Finish choosing angles and assigning control points\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
\&{for} ${}(\|k\K\|n-\T{1};{}$ ${}\|k\G\T{0};{}$ ${}\|k\MM){}$\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{theta}[\|k+\T{1}],\39\\{mp}\MG%
\\{uu}[\|k]);{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{theta}[\|k],\39\\{mp}\MG%
\\{vv}[\|k],\39\\{r1});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
${}\|s\K\|p;{}$\6
${}\|k\K\T{0};{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg};\7
\\{new\_number}(\\{arg});\6
\&{do}\5
${}\{{}$\1\6
${}\|t\K\\{mp\_next\_knot}(\|s);{}$\6
${}\\{n\_sin\_cos}(\\{mp}\MG\\{theta}[\|k],\39\\{mp}\MG\\{ct},\39\\{mp}\MG%
\\{st});{}$\6
${}\\{number\_clone}(\\{arg},\39\\{mp}\MG\\{psi}[\|k+\T{1}]);{}$\6
\\{number\_negate}(\\{arg});\6
${}\\{number\_substract}(\\{arg},\39\\{mp}\MG\\{theta}[\|k+\T{1}]);{}$\6
${}\\{n\_sin\_cos}(\\{arg},\39\\{mp}\MG\\{cf},\39\\{mp}\MG\\{sf});{}$\6
${}\\{mp\_set\_controls}(\\{mp},\39\|s,\39\|t,\39\|k);{}$\6
\\{incr}(\|k);\6
${}\|s\K\|t;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|k\I\|n);{}$\6
\\{free\_number}(\\{arg});\6
\4${}\}{}$\2\par
\U350.\fi

\M{367}The \PB{\\{set\_controls}} routine actually puts the control points into
a pair of consecutive nodes \PB{\|p} and~\PB{\|q}. Global variables are used to
record the values of $\sin\theta$, $\cos\theta$, $\sin\phi$, and
$\cos\phi$ needed in this calculation.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{st};\6
\&{mp\_number} \\{ct};\6
\&{mp\_number} \\{sf};\6
\&{mp\_number} \\{cf};\C{ sines and cosines }\par
\fi

\M{368}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_fraction}(\\{mp}\MG\\{st});{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{ct});{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{sf});{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{cf}){}$;\par
\fi

\M{369}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{st});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{ct});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{sf});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{cf}){}$;\par
\fi

\M{370}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_controls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{integer} \|k);\par
\fi

\M{371}\B\&{void} \\{mp\_set\_controls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{integer} \|k)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{rr}${},{}$ \\{ss};\C{ velocities, divided by thrice the
tension }\6
\&{mp\_number} \\{lt}${},{}$ \\{rt};\C{ tensions }\6
\&{mp\_number} \\{sine};\C{ $\sin(\theta+\phi)$ }\6
\&{mp\_number} \\{tmp};\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{lt});\6
\\{new\_number}(\\{rt});\6
\\{new\_number}(\\{r1});\6
\\{new\_number}(\\{r2});\6
${}\\{number\_clone}(\\{lt},\39\|q\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{lt});\6
${}\\{number\_clone}(\\{rt},\39\|p\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{rt});\6
\\{new\_fraction}(\\{sine});\6
\\{new\_fraction}(\\{rr});\6
\\{new\_fraction}(\\{ss});\6
${}\\{velocity}(\\{rr},\39\\{mp}\MG\\{st},\39\\{mp}\MG\\{ct},\39\\{mp}\MG%
\\{sf},\39\\{mp}\MG\\{cf},\39\\{rt});{}$\6
${}\\{velocity}(\\{ss},\39\\{mp}\MG\\{sf},\39\\{mp}\MG\\{cf},\39\\{mp}\MG%
\\{st},\39\\{mp}\MG\\{ct},\39\\{lt});{}$\6
\&{if} ${}(\\{number\_negative}(\|p\MG\\{right\_tension})\V\\{number%
\_negative}(\|q\MG\\{left\_tension})){}$\5
${}\{{}$\1\6
\X372:Decrease the velocities, if necessary, to stay inside the bounding
triangle\X;\6
\4${}\}{}$\2\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{mp}\MG%
\\{ct});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{mp}\MG%
\\{st});{}$\6
${}\\{number\_substract}(\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{tmp},\39\\{r1},\39\\{rr});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord},\39%
\\{tmp});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{mp}\MG%
\\{ct});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{mp}\MG%
\\{st});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{tmp},\39\\{r1},\39\\{rr});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord},\39%
\\{tmp});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{mp}\MG%
\\{cf});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{mp}\MG%
\\{sf});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{tmp},\39\\{r1},\39\\{ss});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_x},\39\|q\MG\\{x\_coord},%
\39\\{tmp});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\|k],\39\\{mp}\MG%
\\{cf});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{delta\_x}[\|k],\39\\{mp}\MG%
\\{sf});{}$\6
${}\\{number\_substract}(\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{tmp},\39\\{r1},\39\\{ss});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_y},\39\|q\MG\\{y\_coord},%
\39\\{tmp});{}$\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_explicit};{}$\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{lt});\6
\\{free\_number}(\\{rt});\6
\\{free\_number}(\\{rr});\6
\\{free\_number}(\\{ss});\6
\\{free\_number}(\\{sine});\6
\4${}\}{}$\2\par
\fi

\M{372}The boundedness conditions $\\{rr}\L\sin\phi\,/\sin(\theta+\phi)$ and
$\\{ss}\L\sin\theta\,/\sin(\theta+\phi)$ are to be enforced if $\sin\theta$,
$\sin\phi$, and $\sin(\theta+\phi)$ all have the same sign. Otherwise
there is no ``bounding triangle.''

\Y\B\4\X372:Decrease the velocities, if necessary, to stay inside the bounding
triangle\X${}\E{}$\6
\&{if} ${}((\\{number\_nonnegative}(\\{mp}\MG\\{st})\W\\{number\_nonnegative}(%
\\{mp}\MG\\{sf}))\V(\\{number\_nonpositive}(\\{mp}\MG\\{st})\W\\{number%
\_nonpositive}(\\{mp}\MG\\{sf}))){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2}${},{}$ \\{arg1};\6
\&{mp\_number} \\{ab\_vs\_cd};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{st});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{mp}\MG\\{cf});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{sf});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{take\_fraction}(\\{r2},\39\\{arg1},\39\\{mp}\MG\\{ct});{}$\6
${}\\{set\_number\_from\_addition}(\\{sine},\39\\{r1},\39\\{r2});{}$\6
\&{if} (\\{number\_positive}(\\{sine}))\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{fraction\_one\_t},\39\\{unity%
\_t}){}$;\C{ safety factor }\6
${}\\{number\_clone}(\\{r1},\39\\{sine});{}$\6
${}\\{take\_fraction}(\\{sine},\39\\{r1},\39\\{arg1});{}$\6
\&{if} ${}(\\{number\_negative}(\|p\MG\\{right\_tension})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{sf});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{fraction\_one\_t},\39\\{rr},%
\39\\{sine});{}$\6
\&{if} (\\{number\_negative}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{sf});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{make\_fraction}(\\{rr},\39\\{arg1},\39\\{sine});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_negative}(\|q\MG\\{left\_tension})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{st});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{fraction\_one\_t},\39\\{ss},%
\39\\{sine});{}$\6
\&{if} (\\{number\_negative}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{st});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{make\_fraction}(\\{ss},\39\\{arg1},\39\\{sine});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\4${}\}{}$\2\par
\U371.\fi

\M{373}Only the simple cases remain to be handled.

\Y\B\4\X373:Reduce to simple case of two givens and \PB{\&{return}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\6
\&{mp\_number} \\{narg};\7
\\{new\_angle}(\\{narg});\6
${}\\{n\_arg}(\\{narg},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39\\{mp}\MG\\{delta%
\_y}[\T{0}]);{}$\6
\\{new\_number}(\\{arg1});\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{right\_given},\39%
\\{narg});{}$\6
${}\\{n\_sin\_cos}(\\{arg1},\39\\{mp}\MG\\{ct},\39\\{mp}\MG\\{st});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|q\MG\\{left\_given},\39%
\\{narg});{}$\6
${}\\{n\_sin\_cos}(\\{arg1},\39\\{mp}\MG\\{cf},\39\\{mp}\MG\\{sf});{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{sf});{}$\6
${}\\{mp\_set\_controls}(\\{mp},\39\|p,\39\|q,\39\T{0});{}$\6
\\{free\_number}(\\{narg});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{ff});\6
\&{return};\6
\4${}\}{}$\2\par
\U351.\fi

\M{374}\B\X374:Reduce to simple case of straight line and \PB{\&{return}}\X${}%
\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{lt}${},{}$ \\{rt};\C{ tension values }\7
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_explicit};{}$\6
\\{new\_number}(\\{lt});\6
\\{new\_number}(\\{rt});\6
${}\\{number\_clone}(\\{lt},\39\|q\MG\\{left\_tension});{}$\6
\\{number\_abs}(\\{lt});\6
${}\\{number\_clone}(\\{rt},\39\|p\MG\\{right\_tension});{}$\6
\\{number\_abs}(\\{rt});\6
\&{if} (\\{number\_unity}(\\{rt}))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg2};\7
\\{new\_number}(\\{arg2});\6
\&{if} ${}(\\{number\_nonnegative}(\\{mp}\MG\\{delta\_x}[\T{0}])){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39%
\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{mp}\MG\\{delta\_x}[%
\T{0}],\39\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
${}\\{number\_int\_div}(\\{arg2},\39\T{3});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord},\39%
\\{arg2});{}$\6
\&{if} ${}(\\{number\_nonnegative}(\\{mp}\MG\\{delta\_y}[\T{0}])){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{mp}\MG\\{delta\_y}[\T{0}],\39%
\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{mp}\MG\\{delta\_y}[%
\T{0}],\39\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
${}\\{number\_int\_div}(\\{arg2},\39\T{3});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord},\39%
\\{arg2});{}$\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg2}${},{}$ \\{r1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg2},\39\\{rt});{}$\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{3});{}$\6
${}\\{make\_fraction}(\\{ff},\39\\{unity\_t},\39\\{arg2}){}$;\C{ $\alpha/3$ }\6
\\{free\_number}(\\{arg2});\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39\\{ff});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord},\39%
\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\T{0}],\39\\{ff});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord},\39%
\\{r1});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_unity}(\\{lt}))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg2};\7
\\{new\_number}(\\{arg2});\6
\&{if} ${}(\\{number\_nonnegative}(\\{mp}\MG\\{delta\_x}[\T{0}])){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39%
\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{mp}\MG\\{delta\_x}[%
\T{0}],\39\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
${}\\{number\_int\_div}(\\{arg2},\39\T{3});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_x},\39\|q\MG\\{x\_coord},%
\39\\{arg2});{}$\6
\&{if} ${}(\\{number\_nonnegative}(\\{mp}\MG\\{delta\_y}[\T{0}])){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{mp}\MG\\{delta\_y}[\T{0}],\39%
\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{mp}\MG\\{delta\_y}[%
\T{0}],\39\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
${}\\{number\_int\_div}(\\{arg2},\39\T{3});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_y},\39\|q\MG\\{y\_coord},%
\39\\{arg2});{}$\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg2}${},{}$ \\{r1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg2},\39\\{lt});{}$\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{3});{}$\6
${}\\{make\_fraction}(\\{ff},\39\\{unity\_t},\39\\{arg2}){}$;\C{ $\beta/3$ }\6
\\{free\_number}(\\{arg2});\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_x}[\T{0}],\39\\{ff});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_x},\39\|q\MG\\{x\_coord},%
\39\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{delta\_y}[\T{0}],\39\\{ff});{}$\6
${}\\{set\_number\_from\_substraction}(\|q\MG\\{left\_y},\39\|q\MG\\{y\_coord},%
\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ff});\6
\\{free\_number}(\\{lt});\6
\\{free\_number}(\\{rt});\6
\&{return};\6
\4${}\}{}$\2\par
\U351.\fi

\M{375}Various subroutines that are useful for the new (1.770) exported
api for solving path choices

\Y\B\8\#\&{define} \.{TOO\_LARGE}(\|a) \5${}(\\{fabs}((\|a))>\T{4096.0}){}$\6
\8\#\&{define} \.{PI} \5\T{3.1415926535897932384626433832795028841971}\6
\&{static} \&{int} \\{out\_of\_range}(\&{MP} \\{mp}${},\39{}$\&{double} \|a)\1%
\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|t;\7
\\{new\_number}(\|t);\6
${}\\{set\_number\_from\_double}(\|t,\39\\{fabs}(\|a));{}$\6
\&{if} ${}(\\{number\_greaterequal}(\|t,\39\\{inf\_t})){}$\5
${}\{{}$\1\6
\\{free\_number}(\|t);\6
\&{return} \T{1};\6
\4${}\}{}$\2\6
\\{free\_number}(\|t);\6
\&{return} \T{0};\6
\4${}\}{}$\2\7
\&{static} \&{int} \\{mp\_link\_knotpair}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q);\7
\&{static} \&{int} \\{mp\_link\_knotpair}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL\V\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
${}\|p\MG\\{next}\K\|q;{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_tension},\39\T{1.0});{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_open};{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_tension},\39\T{1.0});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_open};{}$\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_close\_path\_cycle}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},%
\39{}$\&{mp\_knot} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{mp\_link\_knotpair}${}(\\{mp},\39\|p,\39\|q);{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_close\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q${},\39{}$%
\&{mp\_knot} \\{first})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|q\E\NULL\V\\{first}\E\NULL){}$\1\5
\&{return} \T{0};\2\6
${}\|q\MG\\{next}\K\\{first};{}$\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_endpoint};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_tension},\39\T{1.0});{}$\6
${}\\{mp\_left\_type}(\\{first})\K\\{mp\_endpoint};{}$\6
${}\\{set\_number\_from\_double}(\\{first}\MG\\{left\_tension},\39\T{1.0});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{mp\_knot} \\{mp\_create\_knot}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q${}\K\\{mp\_new\_knot}(\\{mp});{}$\7
${}\\{mp\_left\_type}(\|q)\K\\{mp\_endpoint};{}$\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_endpoint};{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},\39{}$%
\&{double} \|x${},\39{}$\&{double} \|y)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\|x)){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\|y)){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \T{0};\2\6
${}\\{set\_number\_from\_double}(\|p\MG\\{x\_coord},\39\|x);{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{y\_coord},\39\|y);{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{mp\_knot} \\{mp\_append\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},%
\39{}$\&{double} \|x${},\39{}$\&{double} \|y)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q${}\K\\{mp\_create\_knot}(\\{mp});{}$\7
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
\&{if} ${}(\R\\{mp\_set\_knot}(\\{mp},\39\|q,\39\|x,\39\|y)){}$\5
${}\{{}$\1\6
\\{free}(\|q);\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \|q;\2\6
\&{if} ${}(\R\\{mp\_link\_knotpair}(\\{mp},\39\|p,\39\|q)){}$\5
${}\{{}$\1\6
\\{free}(\|q);\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\6
\&{return} \|q;\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q${},%
\39{}$\&{double} \\{value})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{value}))\1\5
\&{return} \T{0};\2\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_curl},\39\\{value});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_curl},\39\\{value});{}$\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_left\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \\{value})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{value}))\1\5
\&{return} \T{0};\2\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_curl},\39\\{value});{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_curl},\39\\{value});{}$\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_right\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \\{value})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{value}))\1\5
\&{return} \T{0};\2\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_curl},\39\\{value});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_curl};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_curl},\39\\{value});{}$\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knotpair\_curls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} %
\\{t2})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL\V\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{mp\_set\_knot\_curl}(\\{mp},\39\|p,\39\\{t1})){}$\1\5
\&{return} \\{mp\_set\_knot\_curl}${}(\\{mp},\39\|q,\39\\{t2});{}$\2\6
\&{return} \T{0};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knotpair\_tensions}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} %
\\{t2})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL\V\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{t1}))\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{t2}))\1\5
\&{return} \T{0};\2\6
\&{if} ${}((\\{fabs}(\\{t1})<\T{0.75})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}((\\{fabs}(\\{t2})<\T{0.75})){}$\1\5
\&{return} \T{0};\2\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_tension},\39\\{t1});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_tension},\39\\{t2});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_left\_tension}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{t1}))\1\5
\&{return} \T{0};\2\6
\&{if} ${}((\\{fabs}(\\{t1})<\T{0.75})){}$\1\5
\&{return} \T{0};\2\6
${}\\{set\_number\_from\_double}(\|p\MG\\{left\_tension},\39\\{t1});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_right\_tension}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\\{t1}))\1\5
\&{return} \T{0};\2\6
\&{if} ${}((\\{fabs}(\\{t1})<\T{0.75})){}$\1\5
\&{return} \T{0};\2\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_tension},\39\\{t1});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knotpair\_controls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} %
\\{y1}${},\39{}$\&{double} \\{x2}${},\39{}$\&{double} \\{y2})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL\V\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{x1})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{y1})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{x2})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{y2})){}$\1\5
\&{return} \T{0};\2\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_x},\39\\{x1});{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_y},\39\\{y1});{}$\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_explicit};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_x},\39\\{x2});{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_y},\39\\{y2});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_left\_control}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} \\{y1})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{x1})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{y1})){}$\1\5
\&{return} \T{0};\2\6
${}\\{mp\_left\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{left\_x},\39\\{x1});{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{left\_y},\39\\{y1});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_right\_control}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} \\{y1})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{x1})){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{out\_of\_range}(\\{mp},\39\\{y1})){}$\1\5
\&{return} \T{0};\2\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_x},\39\\{x1});{}$\6
${}\\{set\_number\_from\_double}(\|p\MG\\{right\_y},\39\\{y1});{}$\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knot\_direction}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \|x${},\39{}$\&{double} \|y)\1\1\2\2\6
${}\{{}$\1\6
\&{double} \\{value}${}\K\T{0};{}$\7
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\|x))\1\5
\&{return} \T{0};\2\6
\&{if} (\.{TOO\_LARGE}(\|y))\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\R(\|x\E\T{0}\W\|y\E\T{0})){}$\1\5
${}\\{value}\K\\{atan2}(\|y,\39\|x)*(\T{180.0}/\.{PI})*\T{16.0};{}$\2\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_given};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{right\_curl},\39\\{value});{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_given};{}$\6
${}\\{set\_number\_from\_double}(\|q\MG\\{left\_curl},\39\\{value});{}$\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_set\_knotpair\_directions}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} %
\\{y1}${},\39{}$\&{double} \\{x2}${},\39{}$\&{double} \\{y2})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL\V\|q\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} ${}(\\{mp\_set\_knot\_direction}(\\{mp},\39\|p,\39\\{x1},\39\\{y1})){}$%
\1\5
\&{return} \\{mp\_set\_knot\_direction}${}(\\{mp},\39\|q,\39\\{x2},\39%
\\{y2});{}$\2\6
\&{return} \T{0};\6
\4${}\}{}$\2\par
\fi

\M{376}
\Y\B\&{static} \&{int} \\{path\_needs\_fixing}(\&{mp\_knot} \\{source});\7
\&{static} \&{int} \\{path\_needs\_fixing}(\&{mp\_knot} \\{source})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \\{sourcehead}${}\K\\{source};{}$\7
\&{do}\5
${}\{{}$\1\6
${}\\{source}\K\\{source}\MG\\{next};{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{source}\W\\{source}\I\\{sourcehead});{}$\6
\&{if} ${}(\R\\{source}){}$\5
${}\{{}$\1\6
\&{return} \T{1};\6
\4${}\}{}$\2\6
\&{return} \T{0};\6
\4${}\}{}$\2\7
\&{int} \\{mp\_solve\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \\{first})\1\1%
\2\2\6
${}\{{}$\1\6
\&{int} \\{saved\_arith\_error}${}\K\\{mp}\MG\\{arith\_error};{}$\6
\&{jmp\_buf} ${}{*}\\{saved\_jump\_buf}\K\\{mp}\MG\\{jump\_buf};{}$\6
\&{int} \\{retval}${}\K\T{1};{}$\7
\&{if} ${}(\\{first}\E\NULL){}$\1\5
\&{return} \T{0};\2\6
\&{if} (\\{path\_needs\_fixing}(\\{first}))\1\5
\&{return} \T{0};\2\6
${}\\{mp}\MG\\{jump\_buf}\K\\{malloc}(\&{sizeof}(\&{jmp\_buf}));{}$\6
\&{if} ${}(\\{mp}\MG\\{jump\_buf}\E\NULL\V\\{setjmp}({*}(\\{mp}\MG\\{jump%
\_buf}))\I\T{0}){}$\5
${}\{{}$\1\6
\&{return} \T{0};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{arith\_error}\K\T{0};{}$\6
${}\\{mp\_make\_choices}(\\{mp},\39\\{first});{}$\6
\&{if} ${}(\\{mp}\MG\\{arith\_error}){}$\1\5
${}\\{retval}\K\T{0};{}$\2\6
${}\\{mp}\MG\\{arith\_error}\K\\{saved\_arith\_error};{}$\6
${}\\{free}(\\{mp}\MG\\{jump\_buf});{}$\6
${}\\{mp}\MG\\{jump\_buf}\K\\{saved\_jump\_buf};{}$\6
\&{return} \\{retval};\6
\4${}\}{}$\2\7
\&{void} \\{mp\_free\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{377}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{int} \\{mp\_close\_path\_cycle}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},%
\39{}$\&{mp\_knot} \|q);\6
\&{int} \\{mp\_close\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q${},\39{}$%
\&{mp\_knot} \\{first});\6
\&{mp\_knot} \\{mp\_create\_knot}(\&{MP} \\{mp});\6
\&{int} \\{mp\_set\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},\39{}$%
\&{double} \|x${},\39{}$\&{double} \|y);\6
\&{mp\_knot} \\{mp\_append\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p${},%
\39{}$\&{double} \|x${},\39{}$\&{double} \|y);\6
\&{int} \\{mp\_set\_knot\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|q${},%
\39{}$\&{double} \\{value});\6
\&{int} \\{mp\_set\_knot\_left\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \\{value});\6
\&{int} \\{mp\_set\_knot\_right\_curl}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \\{value});\6
\&{int} \\{mp\_set\_knotpair\_curls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} %
\\{t2});\6
\&{int} \\{mp\_set\_knotpair\_tensions}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} %
\\{t2});\6
\&{int} \\{mp\_set\_knot\_left\_tension}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1});\6
\&{int} \\{mp\_set\_knot\_right\_tension}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1});\6
\&{int} \\{mp\_set\_knot\_left\_control}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} \\{t2});\6
\&{int} \\{mp\_set\_knot\_right\_control}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{double} \\{t1}${},\39{}$\&{double} \\{t2});\6
\&{int} \\{mp\_set\_knotpair\_controls}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} %
\\{y1}${},\39{}$\&{double} \\{x2}${},\39{}$\&{double} \\{y2});\6
\&{int} \\{mp\_set\_knot\_direction}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{double} \|x${},\39{}$\&{double} \|y);\6
\&{int} \\{mp\_set\_knotpair\_directions}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{double} \\{x1}${},\39{}$\&{double} %
\\{y1}${},\39{}$\&{double} \\{x2}${},\39{}$\&{double} \\{y2});\6
\&{int} \\{mp\_solve\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \\{first});\6
\&{void} \\{mp\_free\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\par
\fi

\M{378}Simple accessors for \PB{\&{mp\_knot}}.

\Y\B\&{mp\_number} \\{mp\_knot\_x\_coord}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{x\_coord};{}$\6
\4${}\}{}$\2\7
\&{mp\_number} \\{mp\_knot\_y\_coord}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{y\_coord};{}$\6
\4${}\}{}$\2\7
\&{mp\_number} \\{mp\_knot\_left\_x}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1%
\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{left\_x};{}$\6
\4${}\}{}$\2\7
\&{mp\_number} \\{mp\_knot\_left\_y}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1%
\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{left\_y};{}$\6
\4${}\}{}$\2\7
\&{mp\_number} \\{mp\_knot\_right\_x}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{right\_x};{}$\6
\4${}\}{}$\2\7
\&{mp\_number} \\{mp\_knot\_right\_y}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{right\_y};{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_knot\_right\_type}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1\1%
\2\2\6
${}\{{}$\1\6
\&{return} \\{mp\_right\_type}(\|p);\6
\4${}\}{}$\2\7
\&{int} \\{mp\_knot\_left\_type}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1\1\2%
\2\6
${}\{{}$\1\6
\&{return} \\{mp\_left\_type}(\|p);\6
\4${}\}{}$\2\7
\&{mp\_knot} \\{mp\_knot\_next}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p)\1\1\2%
\2\6
${}\{{}$\1\6
\&{return} \|p${}\MG\\{next};{}$\6
\4${}\}{}$\2\7
\&{double} \\{mp\_number\_as\_double}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} %
\|n)\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{number\_to\_double}(\|n);\6
\4${}\}{}$\2\par
\fi

\M{379}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\8\#\&{define} \\{mp\_knot\_left\_curl} \5\\{mp\_knot\_left\_x}\6
\8\#\&{define} \\{mp\_knot\_left\_given} \5\\{mp\_knot\_left\_x}\6
\8\#\&{define} \\{mp\_knot\_left\_tension} \5\\{mp\_knot\_left\_y}\6
\8\#\&{define} \\{mp\_knot\_right\_curl} \5\\{mp\_knot\_right\_x}\6
\8\#\&{define} \\{mp\_knot\_right\_given} \5\\{mp\_knot\_right\_x}\6
\8\#\&{define} \\{mp\_knot\_right\_tension} \5\\{mp\_knot\_right\_y}\6
\&{mp\_number} \\{mp\_knot\_x\_coord}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);%
\6
\&{mp\_number} \\{mp\_knot\_y\_coord}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);%
\6
\&{mp\_number} \\{mp\_knot\_left\_x}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\6
\&{mp\_number} \\{mp\_knot\_left\_y}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\6
\&{mp\_number} \\{mp\_knot\_right\_x}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);%
\6
\&{mp\_number} \\{mp\_knot\_right\_y}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);%
\6
\&{int} \\{mp\_knot\_right\_type}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\6
\&{int} \\{mp\_knot\_left\_type}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\6
\&{mp\_knot} \\{mp\_knot\_next}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|p);\6
\&{double} \\{mp\_number\_as\_double}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} %
\|n);\par
\fi

\N{1}{380}Measuring paths.
\MP's \&{llcorner}, \&{lrcorner}, \&{ulcorner}, and \&{urcorner} operators
allow the user to measure the bounding box of anything that can go into a
picture.  It's easy to get rough bounds on the $x$ and $y$ extent of a path
by just finding the bounding box of the knots and the control points. We
need a more accurate version of the bounding box, but we can still use the
easy estimate to save time by focusing on the interesting parts of the path.

\fi

\M{381}Computing an accurate bounding box involves a theme that will come up
again
and again. Given a Bernshte{\u\i}n polynomial
$$B(z_0,z_1,\ldots,z_n;t)=\sum_k{n\choose k}t^k(1-t)^{n-k}z_k,$$
we can conveniently bisect its range as follows:

\smallskip
\textindent{1)} Let $z_k^{(0)}=z_k$, for \PB{$\T{0}\Z\|k\Z\|n$}.

\smallskip
\textindent{2)} Let $z_k^{(j+1)}={1\over2}(z_k^{(j)}+z\k^{(j)})$, for
\PB{$\T{0}\Z\|k<\|n-\|j$}, for \PB{$\T{0}\Z\|j<\|n$}.

\smallskip\noindent
Then
$$B(z_0,z_1,\ldots,z_n;t)=B(z_0^{(0)},z_0^{(1)},\ldots,z_0^{(n)};2t)
=B(z_0^{(n)},z_1^{(n-1)},\ldots,z_n^{(0)};2t-1).$$
This formula gives us the coefficients of polynomials to use over the ranges
$0\L t\L{1\over2}$ and ${1\over2}\L t\L1$.

\fi

\M{382}Here is a routine that computes the $x$ or $y$ coordinate of the point
on
a cubic corresponding to the \PB{\\{fraction}} value~\PB{\|t}.

\Y\B\&{static} \&{void} \\{mp\_eval\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\|r,\39{}$\&{mp\_knot} \|p${},\39{}$\&{mp\_knot} \|q${},\39{}$%
\&{quarterword} \|c${},\39{}$\&{mp\_number} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{x1}${},{}$ \\{x2}${},{}$ \\{x3};\C{ intermediate values }\7
\\{new\_number}(\\{x1});\6
\\{new\_number}(\\{x2});\6
\\{new\_number}(\\{x3});\6
\&{if} ${}(\|c\E\\{mp\_x\_code}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\|p\MG\\{x\_coord},\39%
\|p\MG\\{right\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\|p\MG\\{right\_x},\39%
\|q\MG\\{left\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x3},\39\|t,\39\|q\MG\\{left\_x},\39%
\|q\MG\\{x\_coord});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\|p\MG\\{y\_coord},\39%
\|p\MG\\{right\_y});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\|p\MG\\{right\_y},\39%
\|q\MG\\{left\_y});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x3},\39\|t,\39\|q\MG\\{left\_y},\39%
\|q\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\\{x2},\39\\{x3});{}$\6
${}\\{set\_number\_from\_of\_the\_way}({*}\|r,\39\|t,\39\\{x1},\39\\{x2});{}$\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{x3});\6
\4${}\}{}$\2\par
\fi

\M{383}The actual bounding box information is stored in global variables.
Since it is convenient to address the $x$ and $y$ information
separately, we define arrays indexed by \PB{$\\{x\_code}\MRL{{.}{.}}\\{y%
\_code}$} and use
macros to give them more convenient names.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_bb\_code} ${}\{{}$\1\6
${}\\{mp\_x\_code}\K\T{0},{}$\C{ index for \PB{\\{minx}} and \PB{\\{maxx}} }\6
\\{mp\_y\_code}\C{ index for \PB{\\{miny}} and \PB{\\{maxy}} }\2\6
${}\}{}$;\par
\fi

\M{384}
\Y\B\4\D$\\{mp\_minx}$ \5
$\\{mp}\MG\\{bbmin}{}$[\\{mp\_x\_code}]\par
\B\4\D$\\{mp\_maxx}$ \5
$\\{mp}\MG\\{bbmax}{}$[\\{mp\_x\_code}]\par
\B\4\D$\\{mp\_miny}$ \5
$\\{mp}\MG\\{bbmin}{}$[\\{mp\_y\_code}]\par
\B\4\D$\\{mp\_maxy}$ \5
$\\{mp}\MG\\{bbmax}{}$[\\{mp\_y\_code}]\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} ${}\\{bbmin}[\\{mp\_y\_code}+\T{1}];{}$\6
\&{mp\_number} ${}\\{bbmax}[\\{mp\_y\_code}+\T{1}]{}$;\C{ the result of
procedures that compute bounding box information }\par
\fi

\M{385}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i\Z\\{mp\_y\_code};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{mp}\MG\\{bbmin}[\|i]);{}$\6
${}\\{new\_number}(\\{mp}\MG\\{bbmax}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{386}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i\Z\\{mp\_y\_code};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{bbmin}[\|i]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{bbmax}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{387}Now we're ready for the key part of the bounding box computation.
The \PB{\\{bound\_cubic}} procedure updates \PB{\\{bbmin}[\|c]} and \PB{%
\\{bbmax}[\|c]} based on
$$B(\hbox{\PB{\\{knot\_coord}(\|p)}}, \hbox{\PB{\\{right\_coord}(\|p)}},
\hbox{\PB{\\{left\_coord}(\|q)}}, \hbox{\PB{\\{knot\_coord}(\|q)}};t)
$$
for $0<t\le1$.  In other words, the procedure adjusts the bounds to
accommodate \PB{\\{knot\_coord}(\|q)} and any extremes over the range $0<t<1$.
The \PB{\|c} parameter is \PB{\\{x\_code}} or \PB{\\{y\_code}}.

\Y\B\&{static} \&{void} \\{mp\_bound\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p${},\39{}$\&{mp\_knot} \|q${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{boolean} \\{wavy};\C{ whether we need to look for extremes }\6
\&{mp\_number} \\{del1}${},{}$ \\{del2}${},{}$ \\{del3}${},{}$ \\{del}${},{}$ %
\\{dmax};\C{ proportional to the control                          points of a
quadratic derived from a cubic }\6
\&{mp\_number} \|t${},{}$ \\{tt};\C{ where a quadratic crosses zero }\6
\&{mp\_number} \|x;\C{ a value that \PB{\\{bbmin}[\|c]} and \PB{\\{bbmax}[\|c]}
must accommodate }\7
\\{new\_number}(\|x);\6
\\{new\_fraction}(\|t);\6
\\{new\_fraction}(\\{tt});\6
\&{if} ${}(\|c\E\\{mp\_x\_code}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\|q\MG\\{x\_coord});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\|q\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\\{new\_number}(\\{del1});\6
\\{new\_number}(\\{del2});\6
\\{new\_number}(\\{del3});\6
\\{new\_number}(\\{del});\6
\\{new\_number}(\\{dmax});\6
\X388:Adjust \PB{\\{bbmin}[\|c]} and \PB{\\{bbmax}[\|c]} to accommodate \PB{%
\|x}\X;\6
\X389:Check the control points against the bounding box and set \PB{\\{wavy}: $%
\K$ \\{true}} if any of them lie outside\X;\6
\&{if} (\\{wavy})\5
${}\{{}$\1\6
\&{if} ${}(\|c\E\\{mp\_x\_code}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{del1},\39\|p\MG\\{right\_x},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{del2},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{del3},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{del1},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{del2},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{del3},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
\4${}\}{}$\2\6
\X390:Scale up \PB{\\{del1}}, \PB{\\{del2}}, and \PB{\\{del3}} for greater
accuracy; also set \PB{\\{del}} to the first nonzero element of \PB{$(\\{del1},%
\\{del2},\\{del3})$}\X;\6
\&{if} (\\{number\_negative}(\\{del}))\5
${}\{{}$\1\6
\\{number\_negate}(\\{del1});\6
\\{number\_negate}(\\{del2});\6
\\{number\_negate}(\\{del3});\6
\4${}\}{}$\2\6
${}\\{crossing\_point}(\|t,\39\\{del1},\39\\{del2},\39\\{del3});{}$\6
\&{if} ${}(\\{number\_less}(\|t,\39\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
\X391:Test the extremes of the cubic against the bounding box\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{del3});\6
\\{free\_number}(\\{del2});\6
\\{free\_number}(\\{del1});\6
\\{free\_number}(\\{del});\6
\\{free\_number}(\\{dmax});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{tt});\6
\4${}\}{}$\2\par
\fi

\M{388}\B\X388:Adjust \PB{\\{bbmin}[\|c]} and \PB{\\{bbmax}[\|c]} to
accommodate \PB{\|x}\X${}\E{}$\6
\&{if} ${}(\\{number\_less}(\|x,\39\\{mp}\MG\\{bbmin}[\|c])){}$\1\5
${}\\{number\_clone}(\\{mp}\MG\\{bbmin}[\|c],\39\|x);{}$\2\6
\&{if} ${}(\\{number\_greater}(\|x,\39\\{mp}\MG\\{bbmax}[\|c]))$ $\\{number%
\_clone}(\\{mp}\MG\\{bbmax}[\|c],\39\|x{}$)\par
\Us387, 391\ETs392.\fi

\M{389}\B\X389:Check the control points against the bounding box and set \PB{%
\\{wavy}: $\K$ \\{true}} if any of them lie outside\X${}\E{}$\6
$\\{wavy}\K\\{true};{}$\6
\&{if} ${}(\|c\E\\{mp\_x\_code}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_lessequal}(\\{mp}\MG\\{bbmin}[\|c],\39\|p\MG\\{right%
\_x})){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\|p\MG\\{right\_x},\39\\{mp}\MG\\{bbmax}[%
\|c])){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\\{mp}\MG\\{bbmin}[\|c],\39\|q\MG\\{left%
\_x})){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\|q\MG\\{left\_x},\39\\{mp}\MG\\{bbmax}[%
\|c])){}$\1\5
${}\\{wavy}\K\\{false};{}$\2\2\2\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_lessequal}(\\{mp}\MG\\{bbmin}[\|c],\39\|p\MG\\{right%
\_y})){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\|p\MG\\{right\_y},\39\\{mp}\MG\\{bbmax}[%
\|c])){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\\{mp}\MG\\{bbmin}[\|c],\39\|q\MG\\{left%
\_y})){}$\1\6
\&{if} ${}(\\{number\_lessequal}(\|q\MG\\{left\_y},\39\\{mp}\MG\\{bbmax}[%
\|c])){}$\1\5
${}\\{wavy}\K\\{false};{}$\2\2\2\2\6
\4${}\}{}$\2\par
\U387.\fi

\M{390}If \PB{$\\{del1}\K\\{del2}\K\\{del3}\K\T{0}$}, it's impossible to obey
the title of this
section. We just set \PB{$\\{del}\K\T{0}$} in that case.

\Y\B\4\X390:Scale up \PB{\\{del1}}, \PB{\\{del2}}, and \PB{\\{del3}} for
greater accuracy; also set \PB{\\{del}} to the first nonzero element of \PB{$(%
\\{del1},\\{del2},\\{del3})$}\X${}\E{}$\6
\&{if} (\\{number\_nonzero}(\\{del1}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{del},\39\\{del1});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_nonzero}(\\{del2}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{del},\39\\{del2});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{del},\39\\{del3});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_nonzero}(\\{del}))\5
${}\{{}$\1\6
\&{mp\_number} \\{absval1};\7
\\{new\_number}(\\{absval1});\6
${}\\{number\_clone}(\\{dmax},\39\\{del1});{}$\6
\\{number\_abs}(\\{dmax});\6
${}\\{number\_clone}(\\{absval1},\39\\{del2});{}$\6
\\{number\_abs}(\\{absval1});\6
\&{if} ${}(\\{number\_greater}(\\{absval1},\39\\{dmax})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dmax},\39\\{absval1});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval1},\39\\{del3});{}$\6
\\{number\_abs}(\\{absval1});\6
\&{if} ${}(\\{number\_greater}(\\{absval1},\39\\{dmax})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dmax},\39\\{absval1});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{number\_less}(\\{dmax},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\\{number\_double}(\\{dmax});\6
\\{number\_double}(\\{del1});\6
\\{number\_double}(\\{del2});\6
\\{number\_double}(\\{del3});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absval1});\6
\4${}\}{}$\2\par
\U387.\fi

\M{391}Since \PB{\\{crossing\_point}} has tried to choose \PB{\|t} so that
$B(\PB{\\{del1}},\PB{\\{del2}},\PB{\\{del3}};\tau)$ crosses zero at $\tau=\PB{%
\|t}$ with negative
slope, the value of \PB{\\{del2}} computed below should not be positive.
But rounding error could make it slightly positive in which case we
must cut it to zero to avoid confusion.

\Y\B\4\X391:Test the extremes of the cubic against the bounding box\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_eval\_cubic}(\\{mp},\39{\AND}\|x,\39\|p,\39\|q,\39\|c,\39\|t);{}$\6
\X388:Adjust \PB{\\{bbmin}[\|c]} and \PB{\\{bbmax}[\|c]} to accommodate \PB{%
\|x}\X;\6
${}\\{set\_number\_from\_of\_the\_way}(\\{del2},\39\|t,\39\\{del2},\39%
\\{del3}){}$;\C{ now \PB{$\T{0},\\{del2},\\{del3}$} represent the derivative on
the remaining interval }\6
\&{if} (\\{number\_positive}(\\{del2}))\1\5
\\{set\_number\_to\_zero}(\\{del2});\2\6
${}\{{}$\1\6
\&{mp\_number} \\{arg2}${},{}$ \\{arg3};\7
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
${}\\{number\_clone}(\\{arg2},\39\\{del2});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{number\_clone}(\\{arg3},\39\\{del3});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\\{tt},\39\\{zero\_t},\39\\{arg2},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_less}(\\{tt},\39\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
\X392:Test the second extreme against the bounding box\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U387.\fi

\M{392}\B\X392:Test the second extreme against the bounding box\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg};\7
\\{new\_number}(\\{arg});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{arg},\39\|t,\39\\{tt},\39\\{fraction%
\_one\_t});{}$\6
${}\\{mp\_eval\_cubic}(\\{mp},\39{\AND}\|x,\39\|p,\39\|q,\39\|c,\39\\{arg});{}$%
\6
\\{free\_number}(\\{arg});\6
\X388:Adjust \PB{\\{bbmin}[\|c]} and \PB{\\{bbmax}[\|c]} to accommodate \PB{%
\|x}\X;\6
\4${}\}{}$\2\par
\U391.\fi

\M{393}Finding the bounding box of a path is basically a matter of applying
\PB{\\{bound\_cubic}} twice for each pair of adjacent knots.

\Y\B\&{static} \&{void} \\{mp\_path\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ a pair of adjacent knots }\7
${}\\{number\_clone}(\\{mp\_minx},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\|h\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{mp\_minx});{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{mp\_miny});{}$\6
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\1\5
\&{return};\2\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_bound\_cubic}(\\{mp},\39\|p,\39\|q,\39\\{mp\_x\_code});{}$\6
${}\\{mp\_bound\_cubic}(\\{mp},\39\|p,\39\|q,\39\\{mp\_y\_code});{}$\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
\4${}\}{}$\2\par
\fi

\M{394}Another important way to measure a path is to find its arc length.  This
is best done by using the general bisection algorithm to subdivide the path
until obtaining ``well behaved'' subpaths whose arc lengths can be approximated
by simple means.

Since the arc length is the integral with respect to time of the magnitude of
the velocity, it is natural to use Simpson's rule for the approximation.
If $\dot B(t)$ is the spline velocity, Simpson's rule gives
$$ \vb\dot B(0)\vb + 4\vb\dot B({1\over2})\vb + \vb\dot B(1)\vb \over 6 $$
for the arc length of a path of length~1.  For a cubic spline
$B(z_0,z_1,z_2,z_3;t)$, the time derivative $\dot B(t)$ is
$3B(dz_0,dz_1,dz_2;t)$, where $dz_i=z_{i+1}-z_i$.  Hence the arc length
approximation is
$$ {\vb dz_0\vb \over 2} + 2\vb dz_{02}\vb + {\vb dz_2\vb \over 2}, $$
where
$$ dz_{02}={1\over2}\left({dz_0+dz_1\over 2}+{dz_1+dz_2\over 2}\right)$$
is the result of the bisection algorithm.

\fi

\M{395}The remaining problem is how to decide when a subpath is ``well
behaved.''
This could be done via the theoretical error bound for Simpson's rule,
but this is impractical because it requires an estimate of the fourth
derivative of the quantity being integrated.  It is much easier to just perform
a bisection step and see how much the arc length estimate changes.  Since the
error for Simpson's rule is proportional to the fourth power of the sample
spacing, the remaining error is typically about $1\over16$ of the amount of
the change.  We say ``typically'' because the error has a pseudo-random
behavior
that could cause the two estimates to agree when each contain large errors.

To protect against disasters such as undetected cusps, the bisection process
should always continue until all the $dz_i$ vectors belong to a single
$90^\circ$ sector.  This ensures that no point on the spline can have velocity
less than 70\% of the minimum of $\vb dz_0\vb$, $\vb dz_1\vb$ and $\vb dz_2%
\vb$.
If such a spline happens to produce an erroneous arc length estimate that
is little changed by bisection, the amount of the error is likely to be fairly
small.  We will try to arrange things so that freak accidents of this type do
not destroy the inverse relationship between the \&{arclength} and
\&{arctime} operations.

\fi

\M{396}The \&{arclength} and \&{arctime} operations are both based on a
recursive
function that finds the arc length of a cubic spline given $dz_0$, $dz_1$,
$dz_2$. This \PB{\\{arc\_test}} routine also takes an arc length goal \PB{\\{a%
\_goal}} and
returns the time when the arc length reaches \PB{\\{a\_goal}} if there is such
a time.
Thus the return value is either an arc length less than \PB{\\{a\_goal}} or, if
the
arc length would be at least \PB{\\{a\_goal}}, it returns a time value
decreased by
\PB{\\{two}}.  This allows the caller to use the sign of the result to
distinguish
between arc lengths and time values.  On certain types of overflow, it is
possible for \PB{\\{a\_goal}} and the result of \PB{\\{arc\_test}} both to be %
\PB{\.{EL\_GORDO}}.
Otherwise, the result is always less than \PB{\\{a\_goal}}.

Rather than halving the control point coordinates on each recursive call to
\PB{\\{arc\_test}}, it is better to keep them proportional to velocity on the
original
curve and halve the results instead.  This means that recursive calls can
potentially use larger error tolerances in their arc length estimates.  How
much larger depends on to what extent the errors behave as though they are
independent of each other.  To save computing time, we use optimistic
assumptions
and increase the tolerance by a factor of about $\sqrt2$ for each recursive
call.

In addition to the tolerance parameter, \PB{\\{arc\_test}} should also have
parameters
for ${1\over3}\vb\dot B(0)\vb$, ${2\over3}\vb\dot B({1\over2})\vb$, and
${1\over3}\vb\dot B(1)\vb$.  These quantities are relatively expensive to
compute
and they are needed in different instances of \PB{\\{arc\_test}}.

\Y\B\&{static} \&{void} \\{mp\_arc\_test}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \\{dx0}${},\39{}$\&{mp\_number} \\{dy0}${},%
\39{}$\&{mp\_number} \\{dx1}${},\39{}$\&{mp\_number} \\{dy1}${},\39{}$\&{mp%
\_number} \\{dx2}${},\39{}$\&{mp\_number} \\{dy2}${},\39{}$\&{mp\_number} %
\\{v0}${},\39{}$\&{mp\_number} \\{v02}${},\39{}$\&{mp\_number} \\{v2}${},\39{}$%
\&{mp\_number} \\{a\_goal}${},\39{}$\&{mp\_number} \\{tol\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{boolean} \\{simple};\C{ are the control points confined to a $90^\circ$
sector? }\6
\&{mp\_number} \\{dx01}${},{}$ \\{dy01}${},{}$ \\{dx12}${},{}$ \\{dy12}${},{}$ %
\\{dx02}${},{}$ \\{dy02};\C{ bisection results }\6
\&{mp\_number} \\{v002}${},{}$ \\{v022};\C{ twice the velocity magnitudes at
$t={1\over4}$ and $t={3\over4}$ }\6
\&{mp\_number} \\{arc};\C{ best arc length estimate before recursion }\6
\&{mp\_number} \\{arc1};\C{ arc length estimate for the first half }\6
\&{mp\_number} \\{simply};\6
\&{mp\_number} \\{tol};\7
\\{new\_number}(\\{arc});\6
\\{new\_number}(\\{arc1});\6
\\{new\_number}(\\{dx01});\6
\\{new\_number}(\\{dy01});\6
\\{new\_number}(\\{dx12});\6
\\{new\_number}(\\{dy12});\6
\\{new\_number}(\\{dx02});\6
\\{new\_number}(\\{dy02});\6
\\{new\_number}(\\{v002});\6
\\{new\_number}(\\{v022});\6
\\{new\_number}(\\{simply});\6
\\{new\_number}(\\{tol});\6
${}\\{number\_clone}(\\{tol},\39\\{tol\_orig});{}$\6
\X400:Bisect the B\'ezier quadratic given by \PB{\\{dx0}}, \PB{\\{dy0}}, \PB{%
\\{dx1}}, \PB{\\{dy1}}, \PB{\\{dx2}}, \PB{\\{dy2}}\X;\6
\X401:Initialize \PB{\\{v002}}, \PB{\\{v022}}, and the arc length estimate \PB{%
\\{arc}}; if it overflows set \PB{\\{arc\_test}} and \PB{\&{return}}\X;\6
\X402:Test if the control points are confined to one quadrant or rotating them
$45^\circ$ would put them in one quadrant. Then set \PB{\\{simple}}
appropriately\X;\6
${}\\{set\_number\_from\_addition}(\\{simply},\39\\{v0},\39\\{v2});{}$\6
\\{number\_halfp}(\\{simply});\6
\\{number\_negate}(\\{simply});\6
${}\\{number\_add}(\\{simply},\39\\{arc});{}$\6
${}\\{number\_substract}(\\{simply},\39\\{v02});{}$\6
\\{number\_abs}(\\{simply});\6
\&{if} ${}(\\{simple}\W\\{number\_lessequal}(\\{simply},\39\\{tol})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\\{arc},\39\\{a\_goal})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\\{ret},\39\\{arc});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X403:Estimate when the arc length reaches \PB{\\{a\_goal}} and set \PB{\\{arc%
\_test}} to that time minus \PB{\\{two}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X397:Use one or two recursive calls to compute the \PB{\\{arc\_test}} function%
\X;\6
\4${}\}{}$\2\6
\4\.{DONE}:\5
\\{free\_number}(\\{arc});\6
\\{free\_number}(\\{arc1});\6
\\{free\_number}(\\{dx01});\6
\\{free\_number}(\\{dy01});\6
\\{free\_number}(\\{dx12});\6
\\{free\_number}(\\{dy12});\6
\\{free\_number}(\\{dx02});\6
\\{free\_number}(\\{dy02});\6
\\{free\_number}(\\{v002});\6
\\{free\_number}(\\{v022});\6
\\{free\_number}(\\{simply});\6
\\{free\_number}(\\{tol});\6
\4${}\}{}$\2\par
\fi

\M{397}The \PB{\\{tol}} value should by multiplied by $\sqrt 2$ before making
recursive
calls, but $1.5$ is an adequate approximation.  It is best to avoid using
\PB{\\{make\_fraction}} in this inner loop.

\Y\B\4\X397:Use one or two recursive calls to compute the \PB{\\{arc\_test}}
function\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{a\_new}${},{}$ \\{a\_aux};\C{ the sum of these gives the \PB{%
\\{a\_goal}} }\6
\&{mp\_number} \|a${},{}$ \|b;\C{ results of recursive calls }\6
\&{mp\_number} \\{half\_v02};\C{ \PB{\\{halfp}(\\{v02})}, a recursion argument
}\7
\\{new\_number}(\\{a\_new});\6
\\{new\_number}(\\{a\_aux});\6
\\{new\_number}(\\{half\_v02});\6
\X398:Set \PB{\\{a\_new}} and \PB{\\{a\_aux}} so their sum is \PB{$\T{2}*\\{a%
\_goal}$} and \PB{\\{a\_new}} is as large as possible\X;\6
${}\{{}$\1\6
\&{mp\_number} \\{halfp\_tol};\7
\\{new\_number}(\\{halfp\_tol});\6
${}\\{number\_clone}(\\{halfp\_tol},\39\\{tol});{}$\6
\\{number\_halfp}(\\{halfp\_tol});\6
${}\\{number\_add}(\\{tol},\39\\{halfp\_tol});{}$\6
\\{free\_number}(\\{halfp\_tol});\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{half\_v02},\39\\{v02});{}$\6
\\{number\_halfp}(\\{half\_v02});\6
\\{new\_number}(\|a);\6
${}\\{mp\_arc\_test}(\\{mp},\39{\AND}\|a,\39\\{dx0},\39\\{dy0},\39\\{dx01},\39%
\\{dy01},\39\\{dx02},\39\\{dy02},\39\\{v0},\39\\{v002},\39\\{half\_v02},\39\\{a%
\_new},\39\\{tol});{}$\6
\&{if} (\\{number\_negative}(\|a))\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
${}\\{number\_double}({*}\\{ret}){}$;\C{ two }\6
${}\\{number\_substract}({*}\\{ret},\39\|a){}$;\C{ two - a }\6
${}\\{number\_halfp}({*}\\{ret});{}$\6
${}\\{number\_negate}({*}\\{ret}){}$;\C{ -halfp(two - a) }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X399:Update \PB{\\{a\_new}} to reduce \PB{$\\{a\_new}+\\{a\_aux}$} by \PB{\|a}%
\X;\6
\\{new\_number}(\|b);\6
${}\\{mp\_arc\_test}(\\{mp},\39{\AND}\|b,\39\\{dx02},\39\\{dy02},\39\\{dx12},%
\39\\{dy12},\39\\{dx2},\39\\{dy2},\39\\{half\_v02},\39\\{v022},\39\\{v2},\39%
\\{a\_new},\39\\{tol});{}$\6
\&{if} (\\{number\_negative}(\|b))\5
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\7
\\{new\_number}(\\{tmp});\6
${}\\{number\_clone}(\\{tmp},\39\|b);{}$\6
\\{number\_negate}(\\{tmp});\6
\\{number\_halfp}(\\{tmp});\6
\\{number\_negate}(\\{tmp});\6
${}\\{number\_clone}({*}\\{ret},\39\\{tmp});{}$\6
\\{set\_number\_to\_unity}(\\{tmp});\6
\\{number\_halfp}(\\{tmp});\6
${}\\{number\_substract}({*}\\{ret},\39\\{tmp}){}$;\C{ (-(halfp(-b)) - 1/2) }\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}({*}\\{ret},\39\|b,\39\|a);{}$\6
${}\\{number\_half}({*}\\{ret});{}$\6
${}\\{set\_number\_from\_addition}({*}\\{ret},\39\|a,\39{*}\\{ret}){}$;\C{ (a +
half(b - a)) }\6
\4${}\}{}$\2\6
\\{free\_number}(\|b);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{half\_v02});\6
\\{free\_number}(\\{a\_aux});\6
\\{free\_number}(\\{a\_new});\6
\\{free\_number}(\|a);\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U396.\fi

\M{398}\B\X398:Set \PB{\\{a\_new}} and \PB{\\{a\_aux}} so their sum is \PB{$%
\T{2}*\\{a\_goal}$} and \PB{\\{a\_new}} is as large as possible\X${}\E{}$\6
\\{set\_number\_to\_inf}(\\{a\_aux});\6
${}\\{number\_substract}(\\{a\_aux},\39\\{a\_goal});{}$\6
\&{if} ${}(\\{number\_greater}(\\{a\_goal},\39\\{a\_aux})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{a\_aux},\39\\{a\_goal},\39\\{a%
\_aux});{}$\6
\\{set\_number\_to\_inf}(\\{a\_new});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{a\_new},\39\\{a\_goal},\39\\{a%
\_goal});{}$\6
\\{set\_number\_to\_zero}(\\{a\_aux});\6
\4${}\}{}$\2\par
\U397.\fi

\M{399}There is no need to maintain \PB{\\{a\_aux}} at this point so we use it
as a temporary
to force the additions and subtractions to be done in an order that avoids
overflow.

\Y\B\4\X399:Update \PB{\\{a\_new}} to reduce \PB{$\\{a\_new}+\\{a\_aux}$} by %
\PB{\|a}\X${}\E{}$\6
\&{if} ${}(\\{number\_greater}(\|a,\39\\{a\_aux})){}$\5
${}\{{}$\1\6
${}\\{number\_substract}(\\{a\_aux},\39\|a);{}$\6
${}\\{number\_add}(\\{a\_new},\39\\{a\_aux});{}$\6
\4${}\}{}$\2\par
\U397.\fi

\M{400}This code assumes all {\it dx} and {\it dy} variables have magnitude
less than
\PB{\\{fraction\_four}}.  To simplify the rest of the \PB{\\{arc\_test}}
routine, we strengthen
this assumption by requiring the norm of each $({\it dx},{\it dy})$ pair to
obey
this bound.  Note that recursive calls will maintain this invariant.

\Y\B\4\X400:Bisect the B\'ezier quadratic given by \PB{\\{dx0}}, \PB{\\{dy0}}, %
\PB{\\{dx1}}, \PB{\\{dy1}}, \PB{\\{dx2}}, \PB{\\{dy2}}\X${}\E{}$\6
$\\{set\_number\_from\_addition}(\\{dx01},\39\\{dx0},\39\\{dx1});{}$\6
\\{number\_half}(\\{dx01});\6
${}\\{set\_number\_from\_addition}(\\{dx12},\39\\{dx1},\39\\{dx2});{}$\6
\\{number\_half}(\\{dx12});\6
${}\\{set\_number\_from\_addition}(\\{dx02},\39\\{dx01},\39\\{dx12});{}$\6
\\{number\_half}(\\{dx02});\6
${}\\{set\_number\_from\_addition}(\\{dy01},\39\\{dy0},\39\\{dy1});{}$\6
\\{number\_half}(\\{dy01});\6
${}\\{set\_number\_from\_addition}(\\{dy12},\39\\{dy1},\39\\{dy2});{}$\6
\\{number\_half}(\\{dy12});\6
${}\\{set\_number\_from\_addition}(\\{dy02},\39\\{dy01},\39\\{dy12});{}$\6
\\{number\_half}(\\{dy02});\par
\U396.\fi

\M{401}We should be careful to keep \PB{$\\{arc}<\.{EL\_GORDO}$} so that
calling \PB{\\{arc\_test}} with
\PB{$\\{a\_goal}\K\.{EL\_GORDO}$} is guaranteed to yield the arc length.

\Y\B\4\X401:Initialize \PB{\\{v002}}, \PB{\\{v022}}, and the arc length
estimate \PB{\\{arc}}; if it overflows set \PB{\\{arc\_test}} and \PB{%
\&{return}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{tmp}${},{}$ \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{dx0},\39\\{dx02});{}$\6
\\{number\_half}(\\{arg1});\6
${}\\{number\_add}(\\{arg1},\39\\{dx01});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{dy0},\39\\{dy02});{}$\6
\\{number\_half}(\\{arg2});\6
${}\\{number\_add}(\\{arg2},\39\\{dy01});{}$\6
${}\\{pyth\_add}(\\{v002},\39\\{arg1},\39\\{arg2});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{dx02},\39\\{dx2});{}$\6
\\{number\_half}(\\{arg1});\6
${}\\{number\_add}(\\{arg1},\39\\{dx12});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{dy02},\39\\{dy2});{}$\6
\\{number\_half}(\\{arg2});\6
${}\\{number\_add}(\\{arg2},\39\\{dy12});{}$\6
${}\\{pyth\_add}(\\{v022},\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{tmp},\39\\{v02});{}$\6
${}\\{number\_add\_scaled}(\\{tmp},\39\T{2});{}$\6
\\{number\_halfp}(\\{tmp});\6
${}\\{set\_number\_from\_addition}(\\{arc1},\39\\{v0},\39\\{tmp});{}$\6
\\{number\_halfp}(\\{arc1});\6
${}\\{number\_substract}(\\{arc1},\39\\{v002});{}$\6
\\{number\_half}(\\{arc1});\6
${}\\{set\_number\_from\_addition}(\\{arc1},\39\\{v002},\39\\{arc1});{}$\6
${}\\{set\_number\_from\_addition}(\\{arc},\39\\{v2},\39\\{tmp});{}$\6
\\{number\_halfp}(\\{arc});\6
${}\\{number\_substract}(\\{arc},\39\\{v022});{}$\6
\\{number\_half}(\\{arc});\6
${}\\{set\_number\_from\_addition}(\\{arc},\39\\{v022},\39\\{arc}){}$;\C{ reuse
\PB{\\{tmp}} for the next \PB{\&{if}} test: }\6
\\{set\_number\_to\_inf}(\\{tmp});\6
${}\\{number\_substract}(\\{tmp},\39\\{arc1});{}$\6
\&{if} ${}(\\{number\_less}(\\{arc},\39\\{tmp})){}$\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
${}\\{number\_add}(\\{arc},\39\\{arc1});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
${}\\{mp}\MG\\{arith\_error}\K\\{true};{}$\6
\&{if} (\\{number\_infinite}(\\{a\_goal}))\5
${}\{{}$\1\6
${}\\{set\_number\_to\_inf}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
${}\\{number\_double}({*}\\{ret});{}$\6
${}\\{number\_negate}({*}\\{ret}){}$;\C{ -two }\6
\4${}\}{}$\2\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U396.\fi

\M{402}\B\X402:Test if the control points are confined to one quadrant or
rotating them $45^\circ$ would put them in one quadrant. Then set \PB{%
\\{simple}} appropriately\X${}\E{}$\6
$\\{simple}\K((\\{number\_nonnegative}(\\{dx0})\W\\{number\_nonnegative}(%
\\{dx1})\W\\{number\_nonnegative}(\\{dx2}))\V(\\{number\_nonpositive}(\\{dx0})%
\W\\{number\_nonpositive}(\\{dx1})\W\\{number\_nonpositive}(\\{dx2})));{}$\6
\&{if} (\\{simple})\5
${}\{{}$\1\6
${}\\{simple}\K(\\{number\_nonnegative}(\\{dy0})\W\\{number\_nonnegative}(%
\\{dy1})\W\\{number\_nonnegative}(\\{dy2}))\V(\\{number\_nonpositive}(\\{dy0})%
\W\\{number\_nonpositive}(\\{dy1})\W\\{number\_nonpositive}(\\{dy2}));{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{simple}){}$\5
${}\{{}$\1\6
${}\\{simple}\K(\\{number\_greaterequal}(\\{dx0},\39\\{dy0})\W\\{number%
\_greaterequal}(\\{dx1},\39\\{dy1})\W\\{number\_greaterequal}(\\{dx2},\39%
\\{dy2}))\V(\\{number\_lessequal}(\\{dx0},\39\\{dy0})\W\\{number\_lessequal}(%
\\{dx1},\39\\{dy1})\W\\{number\_lessequal}(\\{dx2},\39\\{dy2}));{}$\6
\&{if} (\\{simple})\5
${}\{{}$\1\6
\&{mp\_number} \\{neg\_dx0}${},{}$ \\{neg\_dx1}${},{}$ \\{neg\_dx2};\7
\\{new\_number}(\\{neg\_dx0});\6
\\{new\_number}(\\{neg\_dx1});\6
\\{new\_number}(\\{neg\_dx2});\6
${}\\{number\_clone}(\\{neg\_dx0},\39\\{dx0});{}$\6
${}\\{number\_clone}(\\{neg\_dx1},\39\\{dx1});{}$\6
${}\\{number\_clone}(\\{neg\_dx2},\39\\{dx2});{}$\6
\\{number\_negate}(\\{neg\_dx0});\6
\\{number\_negate}(\\{neg\_dx1});\6
\\{number\_negate}(\\{neg\_dx2});\6
${}\\{simple}\K(\\{number\_greaterequal}(\\{neg\_dx0},\39\\{dy0})\W\\{number%
\_greaterequal}(\\{neg\_dx1},\39\\{dy1})\W\\{number\_greaterequal}(\\{neg%
\_dx2},\39\\{dy2}))\V(\\{number\_lessequal}(\\{neg\_dx0},\39\\{dy0})\W\\{number%
\_lessequal}(\\{neg\_dx1},\39\\{dy1})\W\\{number\_lessequal}(\\{neg\_dx2},\39%
\\{dy2}));{}$\6
\\{free\_number}(\\{neg\_dx0});\6
\\{free\_number}(\\{neg\_dx1});\6
\\{free\_number}(\\{neg\_dx2});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U396.\fi

\M{403}Since Simpson's rule is based on approximating the integrand by a
parabola,
it is appropriate to use the same approximation to decide when the integral
reaches the intermediate value \PB{\\{a\_goal}}.  At this point
$$\eqalign{
{\vb\dot B(0)\vb\over 3} &= \hbox{\PB{\\{v0}}}, \qquad
{\vb\dot B({1\over4})\vb\over 3} = {\hbox{\PB{\\{v002}}}\over 2}, \qquad
{\vb\dot B({1\over2})\vb\over 3} = {\hbox{\PB{\\{v02}}}\over 2}, \cr
{\vb\dot B({3\over4})\vb\over 3} &= {\hbox{\PB{\\{v022}}}\over 2}, \qquad
{\vb\dot B(1)\vb\over 3} = \hbox{\PB{\\{v2}}} \cr
}
$$
and
$$ {\vb\dot B(t)\vb\over 3} \approx
\cases{B\left(\hbox{\PB{\\{v0}}},
\hbox{\PB{\\{v002}}}-{1\over 2}\hbox{\PB{\\{v0}}}-{1\over 4}\hbox{\PB{%
\\{v02}}},
{1\over 2}\hbox{\PB{\\{v02}}}; 2t \right)&
if $t\le{1\over 2}$\cr
B\left({1\over 2}\hbox{\PB{\\{v02}}},
\hbox{\PB{\\{v022}}}-{1\over 4}\hbox{\PB{\\{v02}}}-{1\over 2}\hbox{\PB{%
\\{v2}}},
\hbox{\PB{\\{v2}}}; 2t-1 \right)&
if $t\ge{1\over 2}$.\cr}
\eqno (*)
$$
We can integrate $\vb\dot B(t)\vb$ by using
$$\int 3B(a,b,c;\tau)\,dt =
{B(0,a,a+b,a+b+c;\tau) + {\rm constant} \over {d\tau\over dt}}.
$$

This construction allows us to find the time when the arc length reaches
\PB{\\{a\_goal}} by solving a cubic equation of the form
$$ B(0,a,a+b,a+b+c;\tau) = x, $$
where $\tau$ is $2t$ or $2t+1$, $x$ is \PB{\\{a\_goal}} or \PB{$\\{a\_goal}-%
\\{arc1}$}, and $a$, $b$,
and $c$ are the Bernshte{\u\i}n coefficients from $(*)$ divided by
$d\tau\over dt$.  We shall define a function \PB{\\{solve\_rising\_cubic}} that
finds
$\tau$ given $a$, $b$, $c$, and $x$.

\Y\B\4\X403:Estimate when the arc length reaches \PB{\\{a\_goal}} and set \PB{%
\\{arc\_test}} to that time minus \PB{\\{two}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\6
\&{mp\_number} \\{tmp2};\6
\&{mp\_number} \\{tmp3};\6
\&{mp\_number} \\{tmp4};\6
\&{mp\_number} \\{tmp5};\7
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{tmp2});\6
\\{new\_number}(\\{tmp3});\6
\\{new\_number}(\\{tmp4});\6
\\{new\_number}(\\{tmp5});\6
${}\\{number\_clone}(\\{tmp},\39\\{v02});{}$\6
${}\\{number\_add\_scaled}(\\{tmp},\39\T{2});{}$\6
\\{number\_half}(\\{tmp});\6
\\{number\_half}(\\{tmp});\C{ (v02+2) / 4 }\6
\&{if} ${}(\\{number\_lessequal}(\\{a\_goal},\39\\{arc1})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{tmp2},\39\\{v0});{}$\6
\\{number\_halfp}(\\{tmp2});\6
${}\\{set\_number\_from\_substraction}(\\{tmp3},\39\\{arc1},\39\\{tmp2});{}$\6
${}\\{number\_substract}(\\{tmp3},\39\\{tmp});{}$\6
${}\\{mp\_solve\_rising\_cubic}(\\{mp},\39{\AND}\\{tmp5},\39\\{tmp2},\39%
\\{tmp3},\39\\{tmp},\39\\{a\_goal});{}$\6
\\{number\_halfp}(\\{tmp5});\6
\\{set\_number\_to\_unity}(\\{tmp3});\6
${}\\{number\_substract}(\\{tmp5},\39\\{tmp3});{}$\6
${}\\{number\_substract}(\\{tmp5},\39\\{tmp3});{}$\6
${}\\{number\_clone}({*}\\{ret},\39\\{tmp5});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{tmp2},\39\\{v2});{}$\6
\\{number\_halfp}(\\{tmp2});\6
${}\\{set\_number\_from\_substraction}(\\{tmp3},\39\\{arc},\39\\{arc1});{}$\6
${}\\{number\_substract}(\\{tmp3},\39\\{tmp});{}$\6
${}\\{number\_substract}(\\{tmp3},\39\\{tmp2});{}$\6
${}\\{set\_number\_from\_substraction}(\\{tmp4},\39\\{a\_goal},\39\\{arc1});{}$%
\6
${}\\{mp\_solve\_rising\_cubic}(\\{mp},\39{\AND}\\{tmp5},\39\\{tmp},\39%
\\{tmp3},\39\\{tmp2},\39\\{tmp4});{}$\6
\\{number\_halfp}(\\{tmp5});\6
\\{set\_number\_to\_unity}(\\{tmp2});\6
\\{set\_number\_to\_unity}(\\{tmp3});\6
\\{number\_half}(\\{tmp2});\6
${}\\{number\_substract}(\\{tmp2},\39\\{tmp3});{}$\6
${}\\{number\_substract}(\\{tmp2},\39\\{tmp3});{}$\6
${}\\{set\_number\_from\_addition}({*}\\{ret},\39\\{tmp2},\39\\{tmp5});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{tmp2});\6
\\{free\_number}(\\{tmp3});\6
\\{free\_number}(\\{tmp4});\6
\\{free\_number}(\\{tmp5});\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U396.\fi

\M{404}Here is the \PB{\\{solve\_rising\_cubic}} routine that finds the
time~$t$ when
$$ B(0, a, a+b, a+b+c; t) = x. $$
This routine is based on \PB{\\{crossing\_point}} but is simplified by the
assumptions that $B(a,b,c;t)\ge0$ for $0\le t\le1$ and that \PB{$\T{0}\Z\|x\Z%
\|a+\|b+\|c$}.
If rounding error causes this condition to be violated slightly, we just ignore
it and proceed with binary search.  This finds a time when the function value
reaches \PB{\|x} and the slope is positive.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_solve\_rising\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} %
\|b${},\39{}$\&{mp\_number} \|c${},\39{}$\&{mp\_number} \|x);\par
\fi

\M{405}\B\&{void} \\{mp\_solve\_rising\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \\{a\_orig}${},\39{}$\&{mp%
\_number} \\{b\_orig}${},\39{}$\&{mp\_number} \\{c\_orig}${},\39{}$\&{mp%
\_number} \\{x\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{abc};\6
\&{mp\_number} \|a${},{}$ \|b${},{}$ \|c${},{}$ \|x;\C{ local versions of
arguments }\6
\&{mp\_number} \\{ab}${},{}$ \\{bc}${},{}$ \\{ac};\C{ bisection results }\6
\&{mp\_number} \|t;\C{ $2^k+q$ where unscaled answer is in
$[q2^{-k},(q+1)2^{-k})$ }\6
\&{mp\_number} \\{xx};\C{ temporary for updating \PB{\|x} }\6
\&{mp\_number} \\{neg\_x};\C{ temporary for an \PB{\&{if}} }\7
\&{if} ${}(\\{number\_negative}(\\{a\_orig})\V\\{number\_negative}(\\{c%
\_orig})){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"rising?"});{}$\2\6
;\6
\\{new\_number}(\|t);\6
\\{new\_number}(\\{abc});\6
\\{new\_number}(\|a);\6
\\{new\_number}(\|b);\6
\\{new\_number}(\|c);\6
\\{new\_number}(\|x);\6
${}\\{number\_clone}(\|a,\39\\{a\_orig});{}$\6
${}\\{number\_clone}(\|b,\39\\{b\_orig});{}$\6
${}\\{number\_clone}(\|c,\39\\{c\_orig});{}$\6
${}\\{number\_clone}(\|x,\39\\{x\_orig});{}$\6
\\{new\_number}(\\{ab});\6
\\{new\_number}(\\{bc});\6
\\{new\_number}(\\{ac});\6
\\{new\_number}(\\{xx});\6
\\{new\_number}(\\{neg\_x});\6
${}\\{set\_number\_from\_addition}(\\{abc},\39\|a,\39\|b);{}$\6
${}\\{number\_add}(\\{abc},\39\|c);{}$\6
\&{if} (\\{number\_nonpositive}(\|x))\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_greaterequal}(\|x,\39\\{abc})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t,\39\\{epsilon\_t});{}$\6
\X407:Rescale if necessary to make sure \PB{\|a}, \PB{\|b}, and \PB{\|c} are
all less than \PB{\.{EL\_GORDO}\\{div}\T{3}}\X;\6
\&{do}\5
${}\{{}$\1\6
${}\\{number\_add}(\|t,\39\|t);{}$\6
\X406:Subdivide the B\'ezier quadratic defined by \PB{\|a}, \PB{\|b}, \PB{\|c}%
\X;\6
${}\\{number\_clone}(\\{xx},\39\|x);{}$\6
${}\\{number\_substract}(\\{xx},\39\|a);{}$\6
${}\\{number\_substract}(\\{xx},\39\\{ab});{}$\6
${}\\{number\_substract}(\\{xx},\39\\{ac});{}$\6
${}\\{number\_clone}(\\{neg\_x},\39\|x);{}$\6
\\{number\_negate}(\\{neg\_x});\6
\&{if} ${}(\\{number\_less}(\\{xx},\39\\{neg\_x})){}$\5
${}\{{}$\1\6
\\{number\_double}(\|x);\6
${}\\{number\_clone}(\|b,\39\\{ab});{}$\6
${}\\{number\_clone}(\|c,\39\\{ac});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_add}(\|x,\39\\{xx});{}$\6
${}\\{number\_clone}(\|a,\39\\{ac});{}$\6
${}\\{number\_clone}(\|b,\39\\{bc});{}$\6
${}\\{number\_add}(\|t,\39\\{epsilon\_t});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\\{number\_less}(\|t,\39\\{unity\_t}));{}$\6
${}\\{set\_number\_from\_substraction}({*}\\{ret},\39\|t,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abc});\6
\\{free\_number}(\|t);\6
\\{free\_number}(\|a);\6
\\{free\_number}(\|b);\6
\\{free\_number}(\|c);\6
\\{free\_number}(\\{ab});\6
\\{free\_number}(\\{bc});\6
\\{free\_number}(\\{ac});\6
\\{free\_number}(\\{xx});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\\{neg\_x});\6
\4${}\}{}$\2\par
\fi

\M{406}\B\X406:Subdivide the B\'ezier quadratic defined by \PB{\|a}, \PB{\|b}, %
\PB{\|c}\X${}\E{}$\6
$\\{set\_number\_from\_addition}(\\{ab},\39\|a,\39\|b);{}$\6
\\{number\_half}(\\{ab});\6
${}\\{set\_number\_from\_addition}(\\{bc},\39\|b,\39\|c);{}$\6
\\{number\_half}(\\{bc});\6
${}\\{set\_number\_from\_addition}(\\{ac},\39\\{ab},\39\\{bc});{}$\6
\\{number\_half}(\\{ac});\par
\U405.\fi

\M{407}The upper bound on \PB{\|a}, \PB{\|b}, and \PB{\|c}:

\Y\B\4\D$\\{one\_third\_inf\_t}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{one\_third\_inf\_t}%
\par
\Y\B\4\X407:Rescale if necessary to make sure \PB{\|a}, \PB{\|b}, and \PB{\|c}
are all less than \PB{\.{EL\_GORDO}\\{div}\T{3}}\X${}\E{}$\6
\&{while} ${}(\\{number\_greater}(\|a,\39\\{one\_third\_inf\_t})\V\\{number%
\_greater}(\|b,\39\\{one\_third\_inf\_t})\V\\{number\_greater}(\|c,\39\\{one%
\_third\_inf\_t})){}$\5
${}\{{}$\1\6
\\{number\_halfp}(\|a);\6
\\{number\_half}(\|b);\6
\\{number\_halfp}(\|c);\6
\\{number\_halfp}(\|x);\6
\4${}\}{}$\2\par
\U405.\fi

\M{408}It is convenient to have a simpler interface to \PB{\\{arc\_test}} that
requires no
unnecessary arguments and ensures that each $({\it dx},{\it dy})$ pair has
length less than \PB{\\{fraction\_four}}.

\Y\B\&{static} \&{void} \\{mp\_do\_arc\_test}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \\{dx0}${},\39{}$\&{mp\_number} %
\\{dy0}${},\39{}$\&{mp\_number} \\{dx1}${},\39{}$\&{mp\_number} \\{dy1}${},%
\39{}$\&{mp\_number} \\{dx2}${},\39{}$\&{mp\_number} \\{dy2}${},\39{}$\&{mp%
\_number} \\{a\_goal})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{v0}${},{}$ \\{v1}${},{}$ \\{v2};\C{ length of each $({\it
dx},{\it dy})$ pair }\6
\&{mp\_number} \\{v02};\C{ twice the norm of the quadratic at $t={1\over2}$ }\7
\\{new\_number}(\\{v0});\6
\\{new\_number}(\\{v1});\6
\\{new\_number}(\\{v2});\6
${}\\{pyth\_add}(\\{v0},\39\\{dx0},\39\\{dy0});{}$\6
${}\\{pyth\_add}(\\{v1},\39\\{dx1},\39\\{dy1});{}$\6
${}\\{pyth\_add}(\\{v2},\39\\{dx2},\39\\{dy2});{}$\6
\&{if} ${}((\\{number\_greaterequal}(\\{v0},\39\\{fraction\_four\_t}))\V(%
\\{number\_greaterequal}(\\{v1},\39\\{fraction\_four\_t}))\V(\\{number%
\_greaterequal}(\\{v2},\39\\{fraction\_four\_t}))){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{arith\_error}\K\\{true};{}$\6
\&{if} (\\{number\_infinite}(\\{a\_goal}))\5
${}\{{}$\1\6
${}\\{set\_number\_to\_inf}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
${}\\{number\_double}({*}\\{ret});{}$\6
${}\\{number\_negate}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{v02});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{dx0},\39\\{dx2});{}$\6
\\{number\_half}(\\{arg1});\6
${}\\{number\_add}(\\{arg1},\39\\{dx1});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg2},\39\\{dy0},\39\\{dy2});{}$\6
\\{number\_half}(\\{arg2});\6
${}\\{number\_add}(\\{arg2},\39\\{dy1});{}$\6
${}\\{pyth\_add}(\\{v02},\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
${}\\{mp\_arc\_test}(\\{mp},\39\\{ret},\39\\{dx0},\39\\{dy0},\39\\{dx1},\39%
\\{dy1},\39\\{dx2},\39\\{dy2},\39\\{v0},\39\\{v02},\39\\{v2},\39\\{a\_goal},\39%
\\{arc\_tol\_k});{}$\6
\\{free\_number}(\\{v02});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{v0});\6
\\{free\_number}(\\{v1});\6
\\{free\_number}(\\{v2});\6
\4${}\}{}$\2\par
\fi

\M{409}Now it is easy to find the arc length of an entire path.

\Y\B\&{static} \&{void} \\{mp\_get\_arc\_length}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_knot} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ for traversing the path }\6
\&{mp\_number} \|a;\C{ current arc length }\6
\&{mp\_number} \\{a\_tot};\C{ total arc length }\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3}${},{}$ \\{arg4}${},{}$ %
\\{arg5}${},{}$ \\{arg6};\6
\&{mp\_number} \\{arcgoal};\7
${}\|p\K\|h;{}$\6
\\{new\_number}(\\{a\_tot});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
\\{new\_number}(\\{arg4});\6
\\{new\_number}(\\{arg5});\6
\\{new\_number}(\\{arg6});\6
\\{new\_number}(\|a);\6
\\{new\_number}(\\{arcgoal});\6
\\{set\_number\_to\_inf}(\\{arcgoal});\6
\&{while} ${}(\\{mp\_right\_type}(\|p)\I\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{right\_x},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg3},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg4},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg5},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg6},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
${}\\{mp\_do\_arc\_test}(\\{mp},\39{\AND}\|a,\39\\{arg1},\39\\{arg2},\39%
\\{arg3},\39\\{arg4},\39\\{arg5},\39\\{arg6},\39\\{arcgoal});{}$\6
${}\\{slow\_add}(\\{a\_tot},\39\|a,\39\\{a\_tot});{}$\6
\&{if} ${}(\|q\E\|h){}$\1\5
\&{break};\2\6
\&{else}\1\5
${}\|p\K\|q;{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arcgoal});\6
\\{free\_number}(\|a);\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\\{free\_number}(\\{arg4});\6
\\{free\_number}(\\{arg5});\6
\\{free\_number}(\\{arg6});\6
\\{check\_arith}(\,);\6
${}\\{number\_clone}({*}\\{ret},\39\\{a\_tot});{}$\6
\\{free\_number}(\\{a\_tot});\6
\4${}\}{}$\2\par
\fi

\M{410}The inverse operation of finding the time on a path~\PB{\|h} when the
arc length
reaches some value \PB{\\{arc0}} can also be accomplished via \PB{\\{do\_arc%
\_test}}.  Some care
is required to handle very large times or negative times on cyclic paths.  For
non-cyclic paths, \PB{\\{arc0}} values that are negative or too large cause
\PB{\\{get\_arc\_time}} to return 0 or the length of path~\PB{\|h}.

If \PB{\\{arc0}} is greater than the arc length of a cyclic path~\PB{\|h}, the
result is a
time value greater than the length of the path.  Since it could be much
greater,
we must be prepared to compute the arc length of path~\PB{\|h} and divide this
into
\PB{\\{arc0}} to find how many multiples of the length of path~\PB{\|h} to add.

\Y\B\&{static} \&{void} \\{mp\_get\_arc\_time}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_knot} \|h${},\39{}$\&{mp\_number} \\{arc0%
\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ for traversing the path }\6
\&{mp\_number} \\{t\_tot};\C{ accumulator for the result }\6
\&{mp\_number} \|t;\C{ the result of \PB{\\{do\_arc\_test}} }\6
\&{mp\_number} \\{arc}${},{}$ \\{arc0};\C{ portion of \PB{\\{arc0}} not used up
so far }\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3}${},{}$ \\{arg4}${},{}$ %
\\{arg5}${},{}$ \\{arg6};\C{ \PB{\\{do\_arc\_test}} arguments }\7
\&{if} (\\{number\_negative}(\\{arc0\_orig}))\5
${}\{{}$\1\6
\X412:Deal with a negative \PB{\\{arc0\_orig}} value and \PB{\&{return}}\X;\6
\4${}\}{}$\2\6
\\{new\_number}(\\{t\_tot});\6
\\{new\_number}(\\{arc0});\6
${}\\{number\_clone}(\\{arc0},\39\\{arc0\_orig});{}$\6
\&{if} (\\{number\_infinite}(\\{arc0}))\5
${}\{{}$\1\6
${}\\{number\_add\_scaled}(\\{arc0},\39{-}\T{1});{}$\6
\4${}\}{}$\2\6
\\{new\_number}(\\{arc});\6
${}\\{number\_clone}(\\{arc},\39\\{arc0});{}$\6
${}\|p\K\|h;{}$\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
\\{new\_number}(\\{arg4});\6
\\{new\_number}(\\{arg5});\6
\\{new\_number}(\\{arg6});\6
\\{new\_number}(\|t);\6
\&{while} ${}((\\{mp\_right\_type}(\|p)\I\\{mp\_endpoint})\W\\{number%
\_positive}(\\{arc})){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{right\_x},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg3},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg4},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg5},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg6},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
${}\\{mp\_do\_arc\_test}(\\{mp},\39{\AND}\|t,\39\\{arg1},\39\\{arg2},\39%
\\{arg3},\39\\{arg4},\39\\{arg5},\39\\{arg6},\39\\{arc});{}$\6
\X411:Update \PB{\\{arc}} and \PB{\\{t\_tot}} after \PB{\\{do\_arc\_test}} has
just returned \PB{\|t}\X;\6
\&{if} ${}(\|q\E\|h){}$\5
${}\{{}$\1\6
\X413:Update \PB{\\{t\_tot}} and \PB{\\{arc}} to avoid going around the cyclic
path too many times but set \PB{\\{arith\_error}: $\K$ \\{true}} and \PB{%
\&{goto} \\{done}} on overflow\X;\6
\4${}\}{}$\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\\{check\_arith}(\,);\6
${}\\{number\_clone}({*}\\{ret},\39\\{t\_tot});{}$\6
\4\.{RETURN}:\5
\\{free\_number}(\\{t\_tot});\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{arc});\6
\\{free\_number}(\\{arc0});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\\{free\_number}(\\{arg4});\6
\\{free\_number}(\\{arg5});\6
\\{free\_number}(\\{arg6});\6
\4${}\}{}$\2\par
\fi

\M{411}\B\X411:Update \PB{\\{arc}} and \PB{\\{t\_tot}} after \PB{\\{do\_arc%
\_test}} has just returned \PB{\|t}\X${}\E{}$\6
\&{if} (\\{number\_negative}(\|t))\5
${}\{{}$\1\6
${}\\{number\_add}(\\{t\_tot},\39\|t);{}$\6
${}\\{number\_add}(\\{t\_tot},\39\\{two\_t});{}$\6
\\{set\_number\_to\_zero}(\\{arc});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_add}(\\{t\_tot},\39\\{unity\_t});{}$\6
${}\\{number\_substract}(\\{arc},\39\|t);{}$\6
\4${}\}{}$\2\par
\U410.\fi

\M{412}\B\X412:Deal with a negative \PB{\\{arc0\_orig}} value and \PB{%
\&{return}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|h)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{neg\_arc0};\7
${}\|p\K\\{mp\_htap\_ypoc}(\\{mp},\39\|h);{}$\6
\\{new\_number}(\\{neg\_arc0});\6
${}\\{number\_clone}(\\{neg\_arc0},\39\\{arc0\_orig});{}$\6
\\{number\_negate}(\\{neg\_arc0});\6
${}\\{mp\_get\_arc\_time}(\\{mp},\39\\{ret},\39\|p,\39\\{neg\_arc0});{}$\6
${}\\{number\_negate}({*}\\{ret});{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\|p);{}$\6
\\{free\_number}(\\{neg\_arc0});\6
\4${}\}{}$\2\6
\\{check\_arith}(\,);\6
\&{return};\6
\4${}\}{}$\2\par
\U410.\fi

\M{413}\B\X413:Update \PB{\\{t\_tot}} and \PB{\\{arc}} to avoid going around
the cyclic path too many times but set \PB{\\{arith\_error}: $\K$ \\{true}} and
\PB{\&{goto} \\{done}} on overflow\X${}\E{}$\6
\&{if} (\\{number\_positive}(\\{arc}))\5
${}\{{}$\1\6
\&{mp\_number} \|n${},{}$ \\{n1}${},{}$ \\{d1}${},{}$ \\{v1};\7
\\{new\_number}(\|n);\6
\\{new\_number}(\\{n1});\6
\\{new\_number}(\\{d1});\6
\\{new\_number}(\\{v1});\6
${}\\{set\_number\_from\_substraction}(\\{d1},\39\\{arc0},\39\\{arc}){}$;\C{ d1
= arc0 - arc }\6
${}\\{set\_number\_from\_div}(\\{n1},\39\\{arc},\39\\{d1}){}$;\C{ n1 = (arc /
d1) }\6
${}\\{number\_clone}(\|n,\39\\{n1});{}$\6
${}\\{set\_number\_from\_mul}(\\{n1},\39\\{n1},\39\\{d1}){}$;\C{ n1 = (n1 * d1)
}\6
${}\\{number\_substract}(\\{arc},\39\\{n1}){}$;\C{ arc = arc - n1 }\6
${}\\{number\_clone}(\\{d1},\39\\{inf\_t}){}$;\C{ reuse d1 }\6
${}\\{number\_clone}(\\{v1},\39\|n){}$;\C{ v1 = n }\6
${}\\{number\_add}(\\{v1},\39\\{epsilon\_t}){}$;\C{ v1 = n1+1 }\6
${}\\{set\_number\_from\_div}(\\{d1},\39\\{d1},\39\\{v1}){}$;\C{ d1 = EL\_GORDO
/ v1  }\6
\&{if} ${}(\\{number\_greater}(\\{t\_tot},\39\\{d1})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{arith\_error}\K\\{true};{}$\6
\\{check\_arith}(\,);\6
${}\\{set\_number\_to\_inf}({*}\\{ret});{}$\6
\\{free\_number}(\|n);\6
\\{free\_number}(\\{n1});\6
\\{free\_number}(\\{d1});\6
\\{free\_number}(\\{v1});\6
\&{goto} \.{RETURN};\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_mul}(\\{t\_tot},\39\\{t\_tot},\39\\{v1});{}$\6
\\{free\_number}(\|n);\6
\\{free\_number}(\\{n1});\6
\\{free\_number}(\\{d1});\6
\\{free\_number}(\\{v1});\6
\4${}\}{}$\2\par
\U410.\fi

\N{1}{414}Data structures for pens.
A Pen in \MP\ can be either elliptical or polygonal.  Elliptical pens result
in \ps\ \&{stroke} commands, while anything drawn with a polygonal pen is
converted into an area fill as described in the next part of this program.
The mathematics behind this process is based on simple aspects of the theory
of tracings developed by Leo Guibas, Lyle Ramshaw, and Jorge Stolfi
[``A kinematic framework for computational geometry,'' Proc.\ IEEE Symp.\
Foundations of Computer Science {\bf 24} (1983), 100--111].

Polygonal pens are created from paths via \MP's \&{makepen} primitive.
This path representation is almost sufficient for our purposes except that
a pen path should always be a convex polygon with the vertices in
counter-clockwise order.
Since we will need to scan pen polygons both forward and backward, a pen
should be represented as a doubly linked ring of knot nodes.  There is
room for the extra back pointer because we do not need the
\PB{\\{mp\_left\_type}} or \PB{\\{mp\_right\_type}} fields.  In fact, we don't
need the \PB{\\{left\_x}},
\PB{\\{left\_y}}, \PB{\\{right\_x}}, or \PB{\\{right\_y}} fields either but we
leave these alone
so that certain procedures can operate on both pens and paths.  In particular,
pens can be copied using \PB{\\{copy\_path}} and recycled using \PB{\\{toss%
\_knot\_list}}.

\fi

\M{415}The \PB{\\{make\_pen}} procedure turns a path into a pen by initializing
the \PB{\\{prev\_knot}} pointers and making sure the knots form a convex
polygon.
Thus each cubic in the given path becomes a straight line and the control
points are ignored.  If the path is not cyclic, the ends are connected by a
straight line.

\Y\B\4\D$\\{copy\_pen}(\|A)$ \5
$\\{mp\_make\_pen}(\\{mp},\39\\{mp\_copy\_path}(\\{mp},\39(\|A)),\39%
\\{false}{}$)\par
\Y\B\&{static} \&{mp\_knot} \\{mp\_make\_pen}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|h${},\39{}$\&{boolean} \\{need\_hull})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ two consecutive knots }\7
${}\|q\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{mp\_prev\_knot}(\|q)\K\|p;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|h);{}$\6
\&{if} (\\{need\_hull})\5
${}\{{}$\1\6
${}\|h\K\\{mp\_convex\_hull}(\\{mp},\39\|h);{}$\6
\X417:Make sure \PB{\|h} isn't confused with an elliptical pen\X;\6
\4${}\}{}$\2\6
\&{return} \|h;\6
\4${}\}{}$\2\par
\fi

\M{416}The only information required about an elliptical pen is the overall
transformation that has been applied to the original \&{pencircle}.
Since it suffices to keep track of how the three points $(0,0)$, $(1,0)$,
and $(0,1)$ are transformed, an elliptical pen can be stored in a single
knot node and transformed as if it were a path.

\Y\B\4\D$\\{pen\_is\_elliptical}(\|A)$ \5
$((\|A)\E\\{mp\_next\_knot}((\|A)){}$)\par
\Y\B\&{static} \&{mp\_knot} \\{mp\_get\_pen\_circle}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} \\{diam})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|h;\C{ the knot node to return }\7
${}\|h\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_next\_knot}(\|h)\K\|h;{}$\6
${}\\{mp\_prev\_knot}(\|h)\K\|h;{}$\6
${}\\{mp\_originator}(\|h)\K\\{mp\_program\_code};{}$\6
${}\\{set\_number\_to\_zero}(\|h\MG\\{x\_coord});{}$\6
${}\\{set\_number\_to\_zero}(\|h\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{left\_x},\39\\{diam});{}$\6
${}\\{set\_number\_to\_zero}(\|h\MG\\{left\_y});{}$\6
${}\\{set\_number\_to\_zero}(\|h\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|h\MG\\{right\_y},\39\\{diam});{}$\6
\&{return} \|h;\6
\4${}\}{}$\2\par
\fi

\M{417}If the polygon being returned by \PB{\\{make\_pen}} has only one vertex,
it will
be interpreted as an elliptical pen.  This is no problem since a degenerate
polygon can equally well be thought of as a degenerate ellipse.  We need only
initialize the \PB{\\{left\_x}}, \PB{\\{left\_y}}, \PB{\\{right\_x}}, and \PB{%
\\{right\_y}} fields.

\Y\B\4\X417:Make sure \PB{\|h} isn't confused with an elliptical pen\X${}\E{}$\6
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
${}\\{number\_clone}(\|h\MG\\{left\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{left\_y},\39\|h\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{right\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{right\_y},\39\|h\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U415.\fi

\M{418}Printing a polygonal pen is very much like printing a path

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_pr\_pen}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|h);%
\par
\fi

\M{419}\B\&{void} \\{mp\_pr\_pen}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} \|h)\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ for list traversal }\7
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
\X421:Print the elliptical pen \PB{\|h}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_print\_two}(\\{mp},\39\|p\MG\\{x\_coord},\39\|p\MG\\{y\_coord});{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\ ..\ "});{}$\6
\X420:Advance \PB{\|p} making sure the links are OK and \PB{\&{return}} if
there is a problem\X;\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"cycle"});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{420}\B\X420:Advance \PB{\|p} making sure the links are OK and \PB{%
\&{return}} if there is a problem\X${}\E{}$\6
$\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}((\|q\E\NULL)\V(\\{mp\_prev\_knot}(\|q)\I\|p)){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"???"});{}$\6
\&{return};\C{ this won't happen }\6
\4${}\}{}$\2\6
$\|p\K{}$\|q\par
\U419.\fi

\M{421}\B\X421:Print the elliptical pen \PB{\|h}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{v1};\7
\\{new\_number}(\\{v1});\6
${}\\{mp\_print}(\\{mp},\39\.{"pencircle\ transform}\)\.{ed\ ("});{}$\6
${}\\{print\_number}(\|h\MG\\{x\_coord});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\|h\MG\\{y\_coord});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{v1},\39\|h\MG\\{left\_x},\39\|h\MG%
\\{x\_coord});{}$\6
\\{print\_number}(\\{v1});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{v1},\39\|h\MG\\{right\_x},\39\|h\MG%
\\{x\_coord});{}$\6
\\{print\_number}(\\{v1});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{v1},\39\|h\MG\\{left\_y},\39\|h\MG%
\\{y\_coord});{}$\6
\\{print\_number}(\\{v1});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{v1},\39\|h\MG\\{right\_y},\39\|h\MG%
\\{y\_coord});{}$\6
\\{print\_number}(\\{v1});\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\\{free\_number}(\\{v1});\6
\4${}\}{}$\2\par
\U419.\fi

\M{422}Here us another version of \PB{\\{pr\_pen}} that prints the pen as a
diagnostic
message.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_pen}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline});\par
\fi

\M{423}\B\&{void} \\{mp\_print\_pen}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline})\1\1\2\2%
\6
${}\{{}$\1\6
${}\\{mp\_print\_diagnostic}(\\{mp},\39\.{"Pen"},\39\|s,\39\\{nuline});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
;\6
${}\\{mp\_pr\_pen}(\\{mp},\39\|h);{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\fi

\M{424}Making a polygonal pen into a path involves restoring the \PB{\\{mp%
\_left\_type}} and
\PB{\\{mp\_right\_type}} fields and setting the control points so as to make a
polygonal
path.

\Y\B\&{static} \&{void} \\{mp\_make\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p;\C{ for traversing the knot list }\6
\&{quarterword} \|k;\C{ a loop counter }\7
\X428:Other local variables in \PB{\\{make\_path}}\X;\6
\.{FUNCTION\_TRACE1}(\.{"make\_path()\\n"});\6
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
\.{FUNCTION\_TRACE1}(\.{"make\_path(elliptica}\)\.{l)\\n"});\6
\X426:Make the elliptical pen \PB{\|h} into a path\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};{}$\6
\X425:copy the coordinates of knot \PB{\|p} into its control points\X;\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{425}\B\X425:copy the coordinates of knot \PB{\|p} into its control points%
\X${}\E{}$\6
$\\{number\_clone}(\|p\MG\\{left\_x},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|p\MG\\{left\_y},\39\|p\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord});$ $\\{number%
\_clone}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord}{}$)\par
\U424.\fi

\M{426}We need an eight knot path to get a good approximation to an ellipse.

\Y\B\4\X426:Make the elliptical pen \PB{\|h} into a path\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{center\_x}${},{}$ \\{center\_y};\C{ translation parameters
for an elliptical pen }\6
\&{mp\_number} \\{width\_x}${},{}$ \\{width\_y};\C{ the effect of a unit change
in $x$ }\6
\&{mp\_number} \\{height\_x}${},{}$ \\{height\_y};\C{ the effect of a unit
change in $y$ }\6
\&{mp\_number} \\{dx}${},{}$ \\{dy};\C{ the vector from knot \PB{\|p} to its
right control point }\7
\\{new\_number}(\\{center\_x});\6
\\{new\_number}(\\{center\_y});\6
\\{new\_number}(\\{width\_x});\6
\\{new\_number}(\\{width\_y});\6
\\{new\_number}(\\{height\_x});\6
\\{new\_number}(\\{height\_y});\6
\\{new\_number}(\\{dx});\6
\\{new\_number}(\\{dy});\6
\X427:Extract the transformation parameters from the elliptical pen~\PB{\|h}\X;%
\6
${}\|p\K\|h;{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{7};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\X429:Initialize \PB{\|p} as the \PB{\|k}th knot of a circle of unit diameter,
transforming it appropriately\X;\6
\&{if} ${}(\|k\E\T{7}){}$\1\5
${}\\{mp\_next\_knot}(\|p)\K\|h;{}$\2\6
\&{else}\1\5
${}\\{mp\_next\_knot}(\|p)\K\\{mp\_new\_knot}(\\{mp});{}$\2\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{dx});\6
\\{free\_number}(\\{dy});\6
\\{free\_number}(\\{center\_x});\6
\\{free\_number}(\\{center\_y});\6
\\{free\_number}(\\{width\_x});\6
\\{free\_number}(\\{width\_y});\6
\\{free\_number}(\\{height\_x});\6
\\{free\_number}(\\{height\_y});\6
\4${}\}{}$\2\par
\U424.\fi

\M{427}\B\X427:Extract the transformation parameters from the elliptical pen~%
\PB{\|h}\X${}\E{}$\6
$\\{number\_clone}(\\{center\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{center\_y},\39\|h\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{width\_x},\39\|h\MG\\{left\_x},\39%
\\{center\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{width\_y},\39\|h\MG\\{left\_y},\39%
\\{center\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{height\_x},\39\|h\MG\\{right\_x},\39%
\\{center\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{height\_y},\39\|h\MG\\{right\_y},\39%
\\{center\_y}){}$;\par
\U426.\fi

\M{428}\B\X428:Other local variables in \PB{\\{make\_path}}\X${}\E{}$\6
\&{integer} \\{kk};\C{ \PB{\|k} advanced $270^\circ$ around the ring (cf. $\sin%
\theta=\cos(\theta+270)$) }\par
\U424.\fi

\M{429}The only tricky thing here are the tables \PB{\\{half\_cos}} and \PB{%
\\{d\_cos}} used to
find the point $k/8$ of the way around the circle and the direction vector
to use there.

\Y\B\4\X429:Initialize \PB{\|p} as the \PB{\|k}th knot of a circle of unit
diameter, transforming it appropriately\X${}\E{}$\6
$\\{kk}\K(\|k+\T{6})\MOD\T{8};{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{half\_cos}[\|k],\39\\{width%
\_x});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{half\_cos}[\\{kk}],\39\\{height%
\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{x\_coord},\39\\{center\_x},\39%
\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{half\_cos}[\|k],\39\\{width%
\_y});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{half\_cos}[\\{kk}],\39\\{height%
\_y});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{y\_coord},\39\\{center\_y},\39%
\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{d\_cos}[\\{kk}],\39\\{width%
\_x});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{d\_cos}[\|k],\39\\{height\_x});{}$\6
${}\\{number\_clone}(\\{dx},\39\\{r1});{}$\6
\\{number\_negate}(\\{dx});\6
${}\\{number\_add}(\\{dx},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{mp}\MG\\{d\_cos}[\\{kk}],\39\\{width%
\_y});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{mp}\MG\\{d\_cos}[\|k],\39\\{height\_y});{}$\6
${}\\{number\_clone}(\\{dy},\39\\{r1});{}$\6
\\{number\_negate}(\\{dy});\6
${}\\{number\_add}(\\{dy},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_x},\39\|p\MG\\{x\_coord},\39%
\\{dx});{}$\6
${}\\{set\_number\_from\_addition}(\|p\MG\\{right\_y},\39\|p\MG\\{y\_coord},\39%
\\{dy});{}$\6
${}\\{set\_number\_from\_substraction}(\|p\MG\\{left\_x},\39\|p\MG\\{x\_coord},%
\39\\{dx});{}$\6
${}\\{set\_number\_from\_substraction}(\|p\MG\\{left\_y},\39\|p\MG\\{y\_coord},%
\39\\{dy});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
${}\\{mp\_left\_type}(\|p)\K\\{mp\_explicit};{}$\6
${}\\{mp\_right\_type}(\|p)\K\\{mp\_explicit};$ $\\{mp\_originator}(\|p)\K{}$%
\\{mp\_program\_code}\par
\U426.\fi

\M{430}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{half\_cos}[\T{8}];\C{ ${1\over2}\cos(45k)$ }\6
\&{mp\_number} \\{d\_cos}[\T{8}];\C{ a magic constant times $\cos(45k)$ }\par
\fi

\M{431}The magic constant for \PB{\\{d\_cos}} is the distance between $({1%
\over2},0)$ and
$({1\over4}\sqrt2,{1\over4}\sqrt2)$ times the result of the \PB{\\{velocity}}
function for $\theta=\phi=22.5^\circ$.  This comes out to be
$$ d = {\sqrt{2-\sqrt2}\over 3+3\cos22.5^\circ}
\approx 0.132608244919772.
$$

\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{7};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{new\_fraction}(\\{mp}\MG\\{half\_cos}[\|k]);{}$\6
${}\\{new\_fraction}(\\{mp}\MG\\{d\_cos}[\|k]);{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{half\_cos}[\T{0}],\39\\{fraction\_half%
\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{half\_cos}[\T{1}],\39\\{twentysixbits\_sqrt2%
\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{half\_cos}[\T{2}],\39\\{zero\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{d\_cos}[\T{0}],\39\\{twentyeightbits\_d%
\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{d\_cos}[\T{1}],\39\\{twentysevenbits\_sqrt2\_d%
\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{d\_cos}[\T{2}],\39\\{zero\_t});{}$\6
\&{for} ${}(\|k\K\T{3};{}$ ${}\|k\Z\T{4};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{half\_cos}[\|k],\39\\{mp}\MG\\{half\_cos}[%
\T{4}-\|k]);{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{half\_cos}[\|k]);{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{d\_cos}[\|k],\39\\{mp}\MG\\{d\_cos}[\T{4}-%
\|k]);{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{d\_cos}[\|k]);{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{5};{}$ ${}\|k\Z\T{7};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{half\_cos}[\|k],\39\\{mp}\MG\\{half\_cos}[%
\T{8}-\|k]);{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{d\_cos}[\|k],\39\\{mp}\MG\\{d\_cos}[\T{8}-%
\|k]);{}$\6
\4${}\}{}$\2\par
\fi

\M{432}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{7};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{half\_cos}[\|k]);{}$\6
${}\\{free\_number}(\\{mp}\MG\\{d\_cos}[\|k]);{}$\6
\4${}\}{}$\2\par
\fi

\M{433}The \PB{\\{convex\_hull}} function forces a pen polygon to be convex
when it is
returned by \PB{\\{make\_pen}} and after any subsequent transformation where
rounding
error might allow the convexity to be lost.
The convex hull algorithm used here is described by F.~P. Preparata and
M.~I. Shamos [{\sl Computational Geometry}, Springer-Verlag, 1985].

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_knot} \\{mp\_convex\_hull}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|h);\par
\fi

\M{434}\B\&{mp\_knot} \\{mp\_convex\_hull}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h)\1\1\2\2\6
${}\{{}$\C{ Make a polygonal pen convex }\1\6
\&{mp\_knot} \|l${},{}$ \|r;\C{ the leftmost and rightmost knots }\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ knots being scanned }\6
\&{mp\_knot} \|s;\C{ the starting point for an upcoming scan }\6
\&{mp\_number} \\{dx}${},{}$ \\{dy};\C{ a temporary pointer }\6
\&{mp\_knot} \\{ret};\7
\\{new\_number}(\\{dx});\6
\\{new\_number}(\\{dy});\6
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
${}\\{ret}\K\|h;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X435:Set \PB{\|l} to the leftmost knot in polygon~\PB{\|h}\X;\6
\X436:Set \PB{\|r} to the rightmost knot in polygon~\PB{\|h}\X;\6
\&{if} ${}(\|l\I\|r){}$\5
${}\{{}$\1\6
${}\|s\K\\{mp\_next\_knot}(\|r);{}$\6
\X437:Find any knots on the path from \PB{\|l} to \PB{\|r} above the \PB{\|l}-%
\PB{\|r} line and move them past~\PB{\|r}\X;\6
\X441:Find any knots on the path from \PB{\|s} to \PB{\|l} below the \PB{\|l}-%
\PB{\|r} line and move them past~\PB{\|l}\X;\6
\X442:Sort the path from \PB{\|l} to \PB{\|r} by increasing $x$\X;\6
\X443:Sort the path from \PB{\|r} to \PB{\|l} by decreasing $x$\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\|l\I\\{mp\_next\_knot}(\|l)){}$\5
${}\{{}$\1\6
\X444:Do a Gramm scan and remove vertices where there is no left turn\X;\6
\4${}\}{}$\2\6
${}\\{ret}\K\|l;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{dx});\6
\\{free\_number}(\\{dy});\6
\&{return} \\{ret};\6
\4${}\}{}$\2\par
\fi

\M{435}All comparisons are done primarily on $x$ and secondarily on $y$.

\Y\B\4\X435:Set \PB{\|l} to the leftmost knot in polygon~\PB{\|h}\X${}\E{}$\6
$\|l\K\|h;{}$\6
${}\|p\K\\{mp\_next\_knot}(\|h);{}$\6
\&{while} ${}(\|p\I\|h){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_lessequal}(\|p\MG\\{x\_coord},\39\|l\MG\\{x\_coord})){}$%
\1\6
\&{if} ${}((\\{number\_less}(\|p\MG\\{x\_coord},\39\|l\MG\\{x\_coord}))\V(%
\\{number\_less}(\|p\MG\\{y\_coord},\39\|l\MG\\{y\_coord}))){}$\1\5
${}\|l\K\|p;{}$\2\2\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\par
\U434.\fi

\M{436}\B\X436:Set \PB{\|r} to the rightmost knot in polygon~\PB{\|h}\X${}\E{}$%
\6
$\|r\K\|h;{}$\6
${}\|p\K\\{mp\_next\_knot}(\|h);{}$\6
\&{while} ${}(\|p\I\|h){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greaterequal}(\|p\MG\\{x\_coord},\39\|r\MG\\{x%
\_coord})){}$\1\6
\&{if} ${}(\\{number\_greater}(\|p\MG\\{x\_coord},\39\|r\MG\\{x\_coord})\V%
\\{number\_greater}(\|p\MG\\{y\_coord},\39\|r\MG\\{y\_coord})){}$\1\5
${}\|r\K\|p;{}$\2\2\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\par
\U434.\fi

\M{437}\B\X437:Find any knots on the path from \PB{\|l} to \PB{\|r} above the %
\PB{\|l}-\PB{\|r} line and move them past~\PB{\|r}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|r\MG\\{x\_coord},\39\|l\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|r\MG\\{y\_coord},\39\|l\MG%
\\{y\_coord});{}$\6
${}\|p\K\\{mp\_next\_knot}(\|l);{}$\6
\&{while} ${}(\|p\I\|r){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{y\_coord},\39\|l\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|p\MG\\{x\_coord},\39\|l\MG%
\\{x\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dx},\39\\{arg1},\39\\{dy},\39%
\\{arg2});{}$\6
\&{if} (\\{number\_positive}(\\{ab\_vs\_cd}))\1\5
${}\\{mp\_move\_knot}(\\{mp},\39\|p,\39\|r);{}$\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\U434.\fi

\M{438}The \PB{\\{move\_knot}} procedure removes \PB{\|p} from a doubly linked
list and inserts
it after \PB{\|q}.

\fi

\M{439}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_move\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q);\par
\fi

\M{440}\B\&{void} \\{mp\_move\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \|q)\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
${}\\{mp\_next\_knot}(\\{mp\_prev\_knot}(\|p))\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_prev\_knot}(\\{mp\_next\_knot}(\|p))\K\\{mp\_prev\_knot}(\|p);{}$\6
${}\\{mp\_prev\_knot}(\|p)\K\|q;{}$\6
${}\\{mp\_next\_knot}(\|p)\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{mp\_next\_knot}(\|q)\K\|p;{}$\6
${}\\{mp\_prev\_knot}(\\{mp\_next\_knot}(\|p))\K\|p;{}$\6
\4${}\}{}$\2\par
\fi

\M{441}\B\X441:Find any knots on the path from \PB{\|s} to \PB{\|l} below the %
\PB{\|l}-\PB{\|r} line and move them past~\PB{\|l}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\|p\K\|s;{}$\6
\&{while} ${}(\|p\I\|l){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{y\_coord},\39\|l\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|p\MG\\{x\_coord},\39\|l\MG%
\\{x\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dx},\39\\{arg1},\39\\{dy},\39%
\\{arg2});{}$\6
\&{if} (\\{number\_negative}(\\{ab\_vs\_cd}))\1\5
${}\\{mp\_move\_knot}(\\{mp},\39\|p,\39\|l);{}$\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\U434.\fi

\M{442}The list is likely to be in order already so we just do linear
insertions.
Secondary comparisons on $y$ ensure that the sort is consistent with the
choice of \PB{\|l} and \PB{\|r}.

\Y\B\4\X442:Sort the path from \PB{\|l} to \PB{\|r} by increasing $x$\X${}\E{}$%
\6
$\|p\K\\{mp\_next\_knot}(\|l);{}$\6
\&{while} ${}(\|p\I\|r){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_prev\_knot}(\|p);{}$\6
\&{while} ${}(\\{number\_greater}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord})){}$%
\1\5
${}\|q\K\\{mp\_prev\_knot}(\|q);{}$\2\6
\&{while} ${}(\\{number\_equal}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greater}(\|q\MG\\{y\_coord},\39\|p\MG\\{y\_coord})){}$\1\5
${}\|q\K\\{mp\_prev\_knot}(\|q);{}$\2\6
\&{else}\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\E\\{mp\_prev\_knot}(\|p)){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_move\_knot}(\\{mp},\39\\{mp\_prev\_knot}(\|p),\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U434.\fi

\M{443}\B\X443:Sort the path from \PB{\|r} to \PB{\|l} by decreasing $x$\X${}%
\E{}$\6
$\|p\K\\{mp\_next\_knot}(\|r);{}$\6
\&{while} ${}(\|p\I\|l){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_prev\_knot}(\|p);{}$\6
\&{while} ${}(\\{number\_less}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord})){}$\1\5
${}\|q\K\\{mp\_prev\_knot}(\|q);{}$\2\6
\&{while} ${}(\\{number\_equal}(\|q\MG\\{x\_coord},\39\|p\MG\\{x\_coord})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\|q\MG\\{y\_coord},\39\|p\MG\\{y\_coord})){}$\1\5
${}\|q\K\\{mp\_prev\_knot}(\|q);{}$\2\6
\&{else}\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\E\\{mp\_prev\_knot}(\|p)){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_move\_knot}(\\{mp},\39\\{mp\_prev\_knot}(\|p),\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U434.\fi

\M{444}The condition involving \PB{\\{ab\_vs\_cd}} tests if there is not a left
turn
at knot \PB{\|q}.  There usually will be a left turn so we streamline the case
where the \PB{\\{then}} clause is not executed.

\Y\B\4\X444:Do a Gramm scan and remove vertices where there is no left turn%
\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\|p\K\|l;{}$\6
${}\|q\K\\{mp\_next\_knot}(\|l);{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
\&{if} ${}(\|p\E\|l){}$\1\5
\&{break};\2\6
\&{if} ${}(\|p\I\|r){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dx},\39\\{arg1},\39\\{dy},\39%
\\{arg2});{}$\6
\&{if} (\\{number\_nonpositive}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
\X445:Remove knot \PB{\|p} and back up \PB{\|p} and \PB{\|q} but don't go past %
\PB{\|l}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\U434.\fi

\M{445}\B\X445:Remove knot \PB{\|p} and back up \PB{\|p} and \PB{\|q} but don't
go past \PB{\|l}\X${}\E{}$\6
${}\{{}$\1\6
${}\|s\K\\{mp\_prev\_knot}(\|p);{}$\6
\\{mp\_xfree}(\|p);\6
${}\\{mp\_next\_knot}(\|s)\K\|q;{}$\6
${}\\{mp\_prev\_knot}(\|q)\K\|s;{}$\6
\&{if} ${}(\|s\E\|l){}$\5
${}\{{}$\1\6
${}\|p\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_prev\_knot}(\|s);{}$\6
${}\|q\K\|s;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U444.\fi

\M{446}The \PB{\\{find\_offset}} procedure sets global variables \PB{$(\\{cur%
\_x},\\{cur\_y})$} to the
offset associated with the given direction \PB{$(\|x,\|y)$}.  If two different
offsets
apply, it chooses one of them.

\Y\B\&{static} \&{void} \\{mp\_find\_offset}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \\{x\_orig}${},\39{}$\&{mp\_number} \\{y\_orig}${},\39{}$\&{mp\_knot}
\|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ consecutive knots }\7
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
${}\\{mp\_fraction}\\{xx},\39\\{yy}{}$;\C{ untransformed offset for an
elliptical pen }\7
\&{mp\_number} \\{wx}${},{}$ \\{wy}${},{}$ \\{hx}${},{}$ \\{hy};\C{ the
transformation matrix for an elliptical pen }\7
\\{mp\_fraction}\|d;\C{ a temporary register }\6
\\{new\_fraction}(\\{xx});\6
\\{new\_fraction}(\\{yy});\6
\\{new\_number}(\\{wx});\6
\\{new\_number}(\\{wy});\6
\\{new\_number}(\\{hx});\6
\\{new\_number}(\\{hy});\6
\\{new\_fraction}(\|d);\6
\X450:Find the offset for \PB{$(\|x,\|y)$} on the elliptical pen~\PB{\|h}\X%
\\{free\_number}(\\{xx});\6
\\{free\_number}(\\{yy});\6
\\{free\_number}(\\{wx});\6
\\{free\_number}(\\{wy});\6
\\{free\_number}(\\{hx});\6
\\{free\_number}(\\{hy});\6
\\{free\_number}(\|d);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\|q\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{y\_orig},\39\\{arg2},\39\\{x%
\_orig});{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_negative}(\\{ab\_vs\_cd}));\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{y\_orig},\39\\{arg2},\39\\{x%
\_orig});{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_positive}(\\{ab\_vs\_cd}));\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_x},\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_y},\39\|p\MG\\{y\_coord});{}$\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{447}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{cur\_x};\6
\&{mp\_number} \\{cur\_y};\C{ all-purpose return value registers }\par
\fi

\M{448}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{cur\_x});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{cur\_y}){}$;\par
\fi

\M{449}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{cur\_x});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{cur\_y}){}$;\par
\fi

\M{450}\B\X450:Find the offset for \PB{$(\|x,\|y)$} on the elliptical pen~\PB{%
\|h}\X${}\E{}$\6
\&{if} ${}(\\{number\_zero}(\\{x\_orig})\W\\{number\_zero}(\\{y\_orig})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_y},\39\|h\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \|x${},{}$ \|y${},{}$ \\{abs\_x}${},{}$ \\{abs\_y};\7
\\{new\_number}(\|x);\6
\\{new\_number}(\|y);\6
\\{new\_number}(\\{abs\_x});\6
\\{new\_number}(\\{abs\_y});\6
${}\\{number\_clone}(\|x,\39\\{x\_orig});{}$\6
${}\\{number\_clone}(\|y,\39\\{y\_orig});{}$\6
\X451:Find the non-constant part of the transformation for \PB{\|h}\X;\6
${}\\{number\_clone}(\\{abs\_x},\39\|x);{}$\6
${}\\{number\_clone}(\\{abs\_y},\39\|y);{}$\6
\\{number\_abs}(\\{abs\_x});\6
\\{number\_abs}(\\{abs\_y});\6
\&{while} ${}(\\{number\_less}(\\{abs\_x},\39\\{fraction\_half\_t})\W\\{number%
\_less}(\\{abs\_y},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\\{number\_double}(\|x);\6
\\{number\_double}(\|y);\6
${}\\{number\_clone}(\\{abs\_x},\39\|x);{}$\6
${}\\{number\_clone}(\\{abs\_y},\39\|y);{}$\6
\\{number\_abs}(\\{abs\_x});\6
\\{number\_abs}(\\{abs\_y});\6
\4${}\}{}$\2\6
\X452:Make \PB{$(\\{xx},\\{yy})$} the offset on the untransformed \&{pencircle}
for the untransformed version of \PB{$(\|x,\|y)$}\X;\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{xx},\39\\{wx});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{yy},\39\\{hx});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{cur\_x},\39\|h\MG\\{x\_coord},%
\39\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{xx},\39\\{wy});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{yy},\39\\{hy});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{cur\_y},\39\|h\MG\\{y\_coord},%
\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abs\_x});\6
\\{free\_number}(\\{abs\_y});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\|y);\6
\4${}\}{}$\2\par
\U446.\fi

\M{451}\B\X451:Find the non-constant part of the transformation for \PB{\|h}%
\X${}\E{}$\6
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{wx},\39\|h\MG\\{left\_x},\39\|h\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{wy},\39\|h\MG\\{left\_y},\39\|h\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{hx},\39\|h\MG\\{right\_x},\39\|h\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{hy},\39\|h\MG\\{right\_y},\39\|h\MG%
\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U450.\fi

\M{452}\B\X452:Make \PB{$(\\{xx},\\{yy})$} the offset on the untransformed %
\&{pencircle} for the untransformed version of \PB{$(\|x,\|y)$}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2}${},{}$ \\{arg1};\7
\\{new\_number}(\\{arg1});\6
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\|x,\39\\{hy});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{hx});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{take\_fraction}(\\{r2},\39\|y,\39\\{arg1});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
\\{number\_negate}(\\{r1});\6
${}\\{number\_clone}(\\{yy},\39\\{r1});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{wy});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{take\_fraction}(\\{r1},\39\|x,\39\\{arg1});{}$\6
${}\\{take\_fraction}(\\{r2},\39\|y,\39\\{wx});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{number\_clone}(\\{xx},\39\\{r1});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
${}\\{pyth\_add}(\|d,\39\\{xx},\39\\{yy});{}$\6
\&{if} (\\{number\_positive}(\|d))\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_fraction}(\\{ret});\6
${}\\{make\_fraction}(\\{ret},\39\\{xx},\39\|d);{}$\6
\\{number\_half}(\\{ret});\6
${}\\{number\_clone}(\\{xx},\39\\{ret});{}$\6
${}\\{make\_fraction}(\\{ret},\39\\{yy},\39\|d);{}$\6
\\{number\_half}(\\{ret});\6
${}\\{number\_clone}(\\{yy},\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\par
\U450.\fi

\M{453}Finding the bounding box of a pen is easy except if the pen is
elliptical.
But we can handle that case by just calling \PB{\\{find\_offset}} twice.  The
answer
is stored in the global variables \PB{\\{minx}}, \PB{\\{maxx}}, \PB{\\{miny}},
and \PB{\\{maxy}}.

\Y\B\&{static} \&{void} \\{mp\_pen\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p;\C{ for scanning the knot list }\7
\&{if} (\\{pen\_is\_elliptical}(\|h))\5
${}\{{}$\1\6
\X454:Find the bounding box of an elliptical pen\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp\_minx},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{mp\_minx});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\|h\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{mp\_miny});{}$\6
${}\|p\K\\{mp\_next\_knot}(\|h);{}$\6
\&{while} ${}(\|p\I\|h){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\|p\MG\\{x\_coord},\39\\{mp\_minx})){}$\1\5
${}\\{number\_clone}(\\{mp\_minx},\39\|p\MG\\{x\_coord});{}$\2\6
\&{if} ${}(\\{number\_less}(\|p\MG\\{y\_coord},\39\\{mp\_miny})){}$\1\5
${}\\{number\_clone}(\\{mp\_miny},\39\|p\MG\\{y\_coord});{}$\2\6
\&{if} ${}(\\{number\_greater}(\|p\MG\\{x\_coord},\39\\{mp\_maxx})){}$\1\5
${}\\{number\_clone}(\\{mp\_maxx},\39\|p\MG\\{x\_coord});{}$\2\6
\&{if} ${}(\\{number\_greater}(\|p\MG\\{y\_coord},\39\\{mp\_maxy})){}$\1\5
${}\\{number\_clone}(\\{mp\_maxy},\39\|p\MG\\{y\_coord});{}$\2\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{454}\B\X454:Find the bounding box of an elliptical pen\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_fraction}(\\{arg2});\6
${}\\{number\_clone}(\\{arg2},\39\\{fraction\_one\_t});{}$\6
${}\\{mp\_find\_offset}(\\{mp},\39\\{arg1},\39\\{arg2},\39\|h);{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{mp}\MG\\{cur\_x});{}$\6
${}\\{number\_clone}(\\{mp\_minx},\39\|h\MG\\{x\_coord});{}$\6
\\{number\_double}(\\{mp\_minx});\6
${}\\{number\_substract}(\\{mp\_minx},\39\\{mp}\MG\\{cur\_x});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{mp\_find\_offset}(\\{mp},\39\\{arg2},\39\\{arg1},\39\|h);{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{mp}\MG\\{cur\_y});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\|h\MG\\{y\_coord});{}$\6
\\{number\_double}(\\{mp\_miny});\6
${}\\{number\_substract}(\\{mp\_miny},\39\\{mp}\MG\\{cur\_y});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\U453.\fi

\N{1}{455}Numerical values.

This first set goes into the header

\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\8\#\&{define} \\{mp\_fraction}\1\1 \&{mp\_number} \6
\8\#\&{define} \\{mp\_angle}\1\1 \&{mp\_number} \6
\8\#\&{define} \\{new\_number}(\|A)(((\&{math\_data} ${}{*})(\\{mp}\MG%
\\{math}))\MG\\{allocate}) \5(\\{mp},\39{\AND}(\|A),\39\\{mp\_scaled\_type}){}$%
\6
\8\#\&{define} \\{new\_fraction}(\|A)(((\&{math\_data} ${}{*})(\\{mp}\MG%
\\{math}))\MG\\{allocate}) \5(\\{mp},\39{\AND}(\|A),\39\\{mp\_fraction%
\_type}){}$\6
\8\#\&{define} \\{new\_angle}(\|A)(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))%
\MG\\{allocate}) \5(\\{mp},\39{\AND}(\|A),\39\\{mp\_angle\_type}){}$\6
\8\#\&{define} \\{free\_number}(\|A)(((\&{math\_data} ${}{*})(\\{mp}\MG%
\\{math}))\MG\\{free}) \5(\\{mp},\39{\AND}(\|A)){}$\par
\fi

\M{456}
\Y\B\4\D$\\{set\_precision}()$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{set\_precision}){}$(\\{mp})%
\par
\B\4\D$\\{free\_math}()$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{free\_math}){}$(\\{mp})\par
\B\4\D$\\{scan\_numeric\_token}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{scan\_numeric})(\\{mp},\39%
\|A{}$)\par
\B\4\D$\\{scan\_fractional\_token}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{scan\_fractional})(\\{mp},%
\39\|A{}$)\par
\B\4\D$\\{set\_number\_from\_of\_the\_way}(\|A,\|t,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_oftheway})(\\{mp},\39{%
\AND}(\|A),\39\|t,\39\|B,\39\|C{}$)\par
\B\4\D$\\{set\_number\_from\_int}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_int})({\AND}(\|A),\39%
\|B{}$)\par
\B\4\D$\\{set\_number\_from\_scaled}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_scaled})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{set\_number\_from\_boolean}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_boolean})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{set\_number\_from\_double}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_double})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{set\_number\_from\_addition}(\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_addition})({\AND}(%
\|A),\39\|B,\39\|C{}$)\par
\B\4\D$\\{set\_number\_from\_substraction}(\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_substraction})({\AND}(%
\|A),\39\|B,\39\|C{}$)\par
\B\4\D$\\{set\_number\_from\_div}(\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_div})({\AND}(\|A),\39%
\|B,\39\|C{}$)\par
\B\4\D$\\{set\_number\_from\_mul}(\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_mul})({\AND}(\|A),\39%
\|B,\39\|C{}$)\par
\B\4\D$\\{number\_int\_div}(\|A,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_int\_div})({\AND}(%
\|A),\39\|A,\39\|C{}$)\par
\B\4\D$\\{set\_number\_from\_int\_mul}(\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{from\_int\_mul})({\AND}(%
\|A),\39\|B,\39\|C{}$)\Y\par
\B\4\D$\\{set\_number\_to\_unity}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{clone})({\AND}(\|A),\39%
\\{unity\_t}{}$)\par
\B\4\D$\\{set\_number\_to\_zero}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{clone})({\AND}(\|A),\39%
\\{zero\_t}{}$)\par
\B\4\D$\\{set\_number\_to\_inf}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{clone})({\AND}(\|A),\39%
\\{inf\_t}{}$)\par
\B\4\D$\\{set\_number\_to\_neg\_inf}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\\{set\_number\_to\_inf}(\|A);\6
\\{number\_negate}(\|A);\6
\4${}\}{}$\2\6
\&{while} (\T{0})\Y\par
\B\4\D$\\{init\_randoms}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{init\_randoms})(\\{mp},\39%
\|A{}$)\par
\B\4\D$\\{print\_number}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{print})(\\{mp},\39\|A{}$)\par
\B\4\D$\\{number\_tostring}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{tostring})(\\{mp},\39\|A{}$)%
\par
\B\4\D$\\{make\_scaled}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{make\_scaled})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{take\_scaled}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{take\_scaled})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{make\_fraction}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{make\_fraction})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{take\_fraction}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{take\_fraction})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{pyth\_add}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{pyth\_add})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{pyth\_sub}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{pyth\_sub})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{n\_arg}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{n\_arg})(\\{mp},\39{\AND}(%
\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{m\_log}(\|R,\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{m\_log})(\\{mp},\39{\AND}(%
\|R),\39\|A{}$)\par
\B\4\D$\\{m\_exp}(\|R,\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{m\_exp})(\\{mp},\39{\AND}(%
\|R),\39\|A{}$)\par
\B\4\D$\\{velocity}(\|R,\|A,\|B,\|C,\|D,\|E)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{velocity})(\\{mp},\39{\AND}(%
\|R),\39\|A,\39\|B,\39\|C,\39\|D,\39\|E{}$)\par
\B\4\D$\\{ab\_vs\_cd}(\|R,\|A,\|B,\|C,\|D)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{ab\_vs\_cd})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B,\39\|C,\39\|D{}$)\par
\B\4\D$\\{crossing\_point}(\|R,\|A,\|B,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{crossing\_point})(\\{mp},%
\39{\AND}(\|R),\39\|A,\39\|B,\39\|C{}$)\par
\B\4\D$\\{n\_sin\_cos}(\|A,\|S,\|C)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{sin\_cos})(\\{mp},\39\|A,%
\39{\AND}(\|S),\39{\AND}(\|C){}$)\par
\B\4\D$\\{square\_rt}(\|A,\|S)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{sqrt})(\\{mp},\39{\AND}(%
\|A),\39\|S{}$)\par
\B\4\D$\\{slow\_add}(\|R,\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{slow\_add})(\\{mp},\39{%
\AND}(\|R),\39\|A,\39\|B{}$)\par
\B\4\D$\\{round\_unscaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{round\_unscaled}){}$(\|A)\par
\B\4\D$\\{floor\_scaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{floor\_scaled})({\AND}(%
\|A){}$)\par
\B\4\D$\\{fraction\_to\_round\_scaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{fraction\_to\_round%
\_scaled})({\AND}(\|A){}$)\par
\B\4\D$\\{number\_to\_int}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{to\_int}){}$(\|A)\par
\B\4\D$\\{number\_to\_boolean}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{to\_boolean}){}$(\|A)\par
\B\4\D$\\{number\_to\_scaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{to\_scaled}){}$(\|A)\par
\B\4\D$\\{number\_to\_double}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{to\_double}){}$(\|A)\par
\B\4\D$\\{number\_negate}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{negate})({\AND}(\|A){}$)\par
\B\4\D$\\{number\_add}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{add})({\AND}(\|A),\39\|B{}$)%
\par
\B\4\D$\\{number\_substract}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{substract})({\AND}(\|A),\39%
\|B{}$)\par
\B\4\D$\\{number\_half}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{half})({\AND}(\|A){}$)\par
\B\4\D$\\{number\_halfp}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{halfp})({\AND}(\|A){}$)\par
\B\4\D$\\{number\_double}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{do\_double})({\AND}(\|A){}$)%
\par
\B\4\D$\\{number\_add\_scaled}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{add\_scaled})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{number\_multiply\_int}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{multiply\_int})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{number\_divide\_int}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{divide\_int})({\AND}(\|A),%
\39\|B{}$)\par
\B\4\D$\\{number\_abs}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{abs})({\AND}(\|A){}$)\par
\B\4\D$\\{number\_modulo}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{modulo})({\AND}(\|A),\39%
\|B{}$)\par
\B\4\D$\\{number\_nonequalabs}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{nonequalabs})(\|A,\39\|B{}$)%
\par
\B\4\D$\\{number\_odd}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{odd}){}$(\|A)\par
\B\4\D$\\{number\_equal}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{equal})(\|A,\39\|B{}$)\par
\B\4\D$\\{number\_greater}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{greater})(\|A,\39\|B{}$)\par
\B\4\D$\\{number\_less}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{less})(\|A,\39\|B{}$)\par
\B\4\D$\\{number\_clone}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{clone})({\AND}(\|A),\39%
\|B{}$)\par
\B\4\D$\\{number\_swap}(\|A,\|B)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{swap})({\AND}(\|A),\39{%
\AND}(\|B)){}$;\par
\B\4\D$\\{convert\_scaled\_to\_angle}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{scaled\_to\_angle})({\AND}(%
\|A)){}$;\par
\B\4\D$\\{convert\_angle\_to\_scaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{angle\_to\_scaled})({\AND}(%
\|A)){}$;\par
\B\4\D$\\{convert\_fraction\_to\_scaled}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{fraction\_to\_scaled})({%
\AND}(\|A)){}$;\par
\B\4\D$\\{convert\_scaled\_to\_fraction}(\|A)$ \5
(((\&{math\_data} ${}{*})(\\{mp}\MG\\{math}))\MG\\{scaled\_to\_fraction})({%
\AND}(\|A)){}$;\Y\par
\B\4\D$\\{number\_zero}(\|A)$ \5
$\\{number\_equal}(\|A,\39\\{zero\_t}{}$)\par
\B\4\D$\\{number\_infinite}(\|A)$ \5
$\\{number\_equal}(\|A,\39\\{inf\_t}{}$)\par
\B\4\D$\\{number\_unity}(\|A)$ \5
$\\{number\_equal}(\|A,\39\\{unity\_t}{}$)\par
\B\4\D$\\{number\_negative}(\|A)$ \5
$\\{number\_less}(\|A,\39\\{zero\_t}{}$)\par
\B\4\D$\\{number\_nonnegative}(\|A)$ \5
$(\R\\{number\_negative}(\|A){}$)\par
\B\4\D$\\{number\_positive}(\|A)$ \5
$\\{number\_greater}(\|A,\39\\{zero\_t}{}$)\par
\B\4\D$\\{number\_nonpositive}(\|A)$ \5
$(\R\\{number\_positive}(\|A){}$)\par
\B\4\D$\\{number\_nonzero}(\|A)$ \5
$(\R\\{number\_zero}(\|A){}$)\par
\B\4\D$\\{number\_greaterequal}(\|A,\|B)$ \5
$(\R\\{number\_less}(\|A,\39\|B){}$)\par
\B\4\D$\\{number\_lessequal}(\|A,\|B)$ \5
$(\R\\{number\_greater}(\|A,\39\|B){}$)\par
\fi

\N{1}{457}Edge structures.
Now we come to \MP's internal scheme for representing pictures.
The representation is very different from \MF's edge structures
because \MP\ pictures contain \ps\ graphics objects instead of pixel
images.  However, the basic idea is somewhat similar in that shapes
are represented via their boundaries.

The main purpose of edge structures is to keep track of graphical objects
until it is time to translate them into \ps.  Since \MP\ does not need to
know anything about an edge structure other than how to translate it into
\ps\ and how to find its bounding box, edge structures can be just linked
lists of graphical objects.  \MP\ has no easy way to determine whether
two such objects overlap, but it suffices to draw the first one first and
let the second one overwrite it if necessary.

\Y\B\4\X201:MPlib header stuff\X${}\mathrel+\E{}$\6
\&{enum} \&{mp\_graphical\_object\_code} ${}\{{}$\1\6
\X459:Graphical object codes\X\\{mp\_final\_graphic}\2\6
${}\}{}$;\par
\fi

\M{458}Let's consider the types of graphical objects one at a time.
First of all, a filled contour is represented by a eight-word node.  The first
word contains \PB{\\{type}} and \PB{\\{link}} fields, and the next six words
contain a
pointer to a cyclic path and the value to use for \ps' \&{currentrgbcolor}
parameter.  If a pen is used for filling \PB{\\{pen\_p}}, \PB{\\{ljoin}} and %
\PB{\\{miterlim}}
give the relevant information.

\Y\B\4\D$\\{mp\_path\_p}(\|A)$ \5
$(\|A)\MG{}$\\{path\_p\_}\C{ a pointer to the path that needs filling }\par
\B\4\D$\\{mp\_pen\_p}(\|A)$ \5
$(\|A)\MG{}$\\{pen\_p\_}\C{ a pointer to the pen to fill or stroke with }\par
\B\4\D$\&{mp\_color\_model}(\|A)$ \5
$((\\{mp\_fill\_node})(\|A))\MG{}$\\{color\_model\_}\C{  the color model  }\par
\B\4\D$\\{cyan}$ \5
\\{red}\par
\B\4\D$\\{grey}$ \5
\\{red}\par
\B\4\D$\\{magenta}$ \5
\\{green}\par
\B\4\D$\\{yellow}$ \5
\\{blue}\par
\B\4\D$\\{mp\_pre\_script}(\|A)$ \5
$((\\{mp\_fill\_node})(\|A))\MG{}$\\{pre\_script\_}\par
\B\4\D$\\{mp\_post\_script}(\|A)$ \5
$((\\{mp\_fill\_node})(\|A))\MG{}$\\{post\_script\_}\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_fill\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{halfword} \\{color\_model\_};\6
\&{mp\_number} \\{red};\6
\&{mp\_number} \\{green};\6
\&{mp\_number} \\{blue};\6
\&{mp\_number} \\{black};\6
\&{mp\_string} \\{pre\_script\_};\6
\&{mp\_string} \\{post\_script\_};\6
\&{mp\_knot} \\{path\_p\_};\6
\&{mp\_knot} \\{pen\_p\_};\6
\&{unsigned} \&{char} \\{ljoin};\6
\&{mp\_number} \\{miterlim};\2\6
${}\}{}$ \&{mp\_fill\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_fill\_node\_data} ${}{*}\&{mp\_fill\_node}{}$;\par
\fi

\M{459}\B\X459:Graphical object codes\X${}\E{}$\6
$\\{mp\_fill\_code}\K\T{1}$ $,{}$\par
\As463, 470, 474\ETs1267.
\U457.\fi

\M{460}Make a fill node for cyclic path \PB{\|p} and color black.

\Y\B\4\D$\\{fill\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_fill\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_new\_fill\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_fill\_node} \|t${}\K\\{malloc\_node}(\\{fill\_node\_size});{}$\7
${}\\{mp\_type}(\|t)\K\\{mp\_fill\_node\_type};{}$\6
${}\\{mp\_path\_p}(\|t)\K\|p;{}$\6
${}\\{mp\_pen\_p}(\|t)\K\NULL{}$;\C{ \PB{$\NULL$} means don't use a pen }\6
${}\\{new\_number}(\|t\MG\\{red});{}$\6
${}\\{new\_number}(\|t\MG\\{green});{}$\6
${}\\{new\_number}(\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\|t\MG\\{black});{}$\6
${}\\{new\_number}(\|t\MG\\{miterlim});{}$\6
\\{clear\_color}(\|t);\6
${}\&{mp\_color\_model}(\|t)\K\\{mp\_uninitialized\_model};{}$\6
${}\\{mp\_pre\_script}(\|t)\K\NULL;{}$\6
${}\\{mp\_post\_script}(\|t)\K\NULL{}$;\C{ Set the \PB{\\{ljoin}} and \PB{%
\\{miterlim}} fields in object \PB{\|t} }\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_linejoin}),\39%
\\{unity\_t})){}$\1\5
${}\|t\MG\\{ljoin}\K\T{2};{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_linejoin})))\1%
\5
${}\|t\MG\\{ljoin}\K\T{1};{}$\2\6
\&{else}\1\5
${}\|t\MG\\{ljoin}\K\T{0};{}$\2\6
\&{if} ${}(\\{number\_less}(\\{internal\_value}(\\{mp\_miterlimit}),\39\\{unity%
\_t})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}(\|t\MG\\{miterlim});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t\MG\\{miterlim},\39\\{internal\_value}(\\{mp%
\_miterlimit}));{}$\6
\4${}\}{}$\2\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\par
\fi

\M{461}\B\&{static} \&{void} \\{mp\_free\_fill\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_fill\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_path\_p}(\|p));{}$\6
\&{if} ${}(\\{mp\_pen\_p}(\|p)\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_pen\_p}(\|p));{}$\2\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
${}\\{free\_number}(\|p\MG\\{red});{}$\6
${}\\{free\_number}(\|p\MG\\{green});{}$\6
${}\\{free\_number}(\|p\MG\\{blue});{}$\6
${}\\{free\_number}(\|p\MG\\{black});{}$\6
${}\\{free\_number}(\|p\MG\\{miterlim});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{fill\_node%
\_size});{}$\6
\4${}\}{}$\2\par
\fi

\M{462}A stroked path is represented by an eight-word node that is like a
filled
contour node except that it contains the current \&{linecap} value, a scale
factor for the dash pattern, and a pointer that is non-NULL if the stroke
is to be dashed.  The purpose of the scale factor is to allow a picture to
be transformed without touching the picture that \PB{\\{dash\_p}} points to.

\Y\B\4\D$\\{mp\_dash\_p}(\|A)$ \5
$((\\{mp\_stroked\_node})(\|A))\MG{}$\\{dash\_p\_}\C{ a pointer to the edge
structure that gives the dash pattern }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_stroked\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{halfword} \\{color\_model\_};\6
\&{mp\_number} \\{red};\6
\&{mp\_number} \\{green};\6
\&{mp\_number} \\{blue};\6
\&{mp\_number} \\{black};\6
\&{mp\_string} \\{pre\_script\_};\6
\&{mp\_string} \\{post\_script\_};\6
\&{mp\_knot} \\{path\_p\_};\6
\&{mp\_knot} \\{pen\_p\_};\6
\&{unsigned} \&{char} \\{ljoin};\6
\&{mp\_number} \\{miterlim};\6
\&{unsigned} \&{char} \\{lcap};\6
\&{mp\_node} \\{dash\_p\_};\6
\&{mp\_number} \\{dash\_scale};\2\6
${}\}{}$ \&{mp\_stroked\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_stroked\_node\_data} ${}{*}\&{mp\_stroked%
\_node}{}$;\par
\fi

\M{463}\B\X459:Graphical object codes\X${}\mathrel+\E{}$\6
$\\{mp\_stroked\_code}\K\T{2}$ $,{}$\par
\fi

\M{464} Make a stroked node for path \PB{\|p} with \PB{\\{mp\_pen\_p}(\|p)}
temporarily \PB{$\NULL$}.

\Y\B\4\D$\\{stroked\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_stroked\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_new\_stroked\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_stroked\_node} \|t${}\K\\{malloc\_node}(\\{stroked\_node\_size});{}$\7
${}\\{mp\_type}(\|t)\K\\{mp\_stroked\_node\_type};{}$\6
${}\\{mp\_path\_p}(\|t)\K\|p;{}$\6
${}\\{mp\_pen\_p}(\|t)\K\NULL;{}$\6
${}\\{mp\_dash\_p}(\|t)\K\NULL;{}$\6
${}\\{new\_number}(\|t\MG\\{dash\_scale});{}$\6
${}\\{set\_number\_to\_unity}(\|t\MG\\{dash\_scale});{}$\6
${}\\{new\_number}(\|t\MG\\{red});{}$\6
${}\\{new\_number}(\|t\MG\\{green});{}$\6
${}\\{new\_number}(\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\|t\MG\\{black});{}$\6
${}\\{new\_number}(\|t\MG\\{miterlim});{}$\6
\\{clear\_color}(\|t);\6
${}\\{mp\_pre\_script}(\|t)\K\NULL;{}$\6
${}\\{mp\_post\_script}(\|t)\K\NULL{}$;\C{ Set the \PB{\\{ljoin}} and \PB{%
\\{miterlim}} fields in object \PB{\|t} }\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_linejoin}),\39%
\\{unity\_t})){}$\1\5
${}\|t\MG\\{ljoin}\K\T{2};{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_linejoin})))\1%
\5
${}\|t\MG\\{ljoin}\K\T{1};{}$\2\6
\&{else}\1\5
${}\|t\MG\\{ljoin}\K\T{0};{}$\2\6
\&{if} ${}(\\{number\_less}(\\{internal\_value}(\\{mp\_miterlimit}),\39\\{unity%
\_t})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}(\|t\MG\\{miterlim});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t\MG\\{miterlim},\39\\{internal\_value}(\\{mp%
\_miterlimit}));{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_linecap}),\39\\{unity%
\_t})){}$\1\5
${}\|t\MG\\{lcap}\K\T{2};{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_linecap})))\1\5
${}\|t\MG\\{lcap}\K\T{1};{}$\2\6
\&{else}\1\5
${}\|t\MG\\{lcap}\K\T{0};{}$\2\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\par
\fi

\M{465}\B\&{static} \\{mp\_edge\_header\_node}\\{mp\_free\_stroked\_node}(%
\&{MP} \\{mp}${},\39{}$\&{mp\_stroked\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_edge\_header\_node}\|e\K\NULL;{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_path\_p}(\|p));{}$\6
\&{if} ${}(\\{mp\_pen\_p}(\|p)\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_pen\_p}(\|p));{}$\2\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
${}\|e\K(\\{mp\_edge\_header\_node})\\{mp\_dash\_p}(\|p);{}$\6
${}\\{free\_number}(\|p\MG\\{dash\_scale});{}$\6
${}\\{free\_number}(\|p\MG\\{red});{}$\6
${}\\{free\_number}(\|p\MG\\{green});{}$\6
${}\\{free\_number}(\|p\MG\\{blue});{}$\6
${}\\{free\_number}(\|p\MG\\{black});{}$\6
${}\\{free\_number}(\|p\MG\\{miterlim});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{stroked\_node%
\_size});{}$\6
\&{return} \|e;\6
\4${}\}{}$\2\par
\fi

\M{466}When a dashed line is computed in a transformed coordinate system, the
dash
lengths get scaled like the pen shape and we need to compensate for this.
Since
there is no unique scale factor for an arbitrary transformation, we use the
the square root of the determinant.  The properties of the determinant make it
easier to maintain the \PB{\\{dash\_scale}}.  The computation is fairly
straight-forward
except for the initialization of the scale factor \PB{\|s}.  The factor of 64
is
needed because \PB{\\{square\_rt}} scales its result by $2^8$ while we need
$2^{14}$
to counteract the effect of \PB{\\{take\_fraction}}.

\fi

\M{467}\B\&{void} \\{mp\_sqrt\_det}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \\{a\_orig}${},\39{}$\&{mp\_number} \\{b%
\_orig}${},\39{}$\&{mp\_number} \\{c\_orig}${},\39{}$\&{mp\_number} \\{d%
\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|a${},{}$ \|b${},{}$ \|c${},{}$ \|d;\6
\&{mp\_number} \\{maxabs};\C{ $max(\PB{\|a},\PB{\|b},\PB{\|c},\PB{\|d})$ }\6
\&{unsigned} \|s;\C{ amount by which the result of \PB{\\{square\_rt}} needs to
be scaled }\7
\\{new\_number}(\|a);\6
\\{new\_number}(\|b);\6
\\{new\_number}(\|c);\6
\\{new\_number}(\|d);\6
\\{new\_number}(\\{maxabs});\6
${}\\{number\_clone}(\|a,\39\\{a\_orig});{}$\6
${}\\{number\_clone}(\|b,\39\\{b\_orig});{}$\6
${}\\{number\_clone}(\|c,\39\\{c\_orig});{}$\6
${}\\{number\_clone}(\|d,\39\\{d\_orig}){}$;\C{ Initialize \PB{\\{maxabs}} }\6
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\7
\\{new\_number}(\\{tmp});\6
${}\\{number\_clone}(\\{maxabs},\39\|a);{}$\6
\\{number\_abs}(\\{maxabs});\6
${}\\{number\_clone}(\\{tmp},\39\|b);{}$\6
\\{number\_abs}(\\{tmp});\6
\&{if} ${}(\\{number\_greater}(\\{tmp},\39\\{maxabs})){}$\1\5
${}\\{number\_clone}(\\{maxabs},\39\\{tmp});{}$\2\6
${}\\{number\_clone}(\\{tmp},\39\|c);{}$\6
\\{number\_abs}(\\{tmp});\6
\&{if} ${}(\\{number\_greater}(\\{tmp},\39\\{maxabs})){}$\1\5
${}\\{number\_clone}(\\{maxabs},\39\\{tmp});{}$\2\6
${}\\{number\_clone}(\\{tmp},\39\|d);{}$\6
\\{number\_abs}(\\{tmp});\6
\&{if} ${}(\\{number\_greater}(\\{tmp},\39\\{maxabs})){}$\1\5
${}\\{number\_clone}(\\{maxabs},\39\\{tmp});{}$\2\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
${}\|s\K\T{64};{}$\6
\&{while} ${}((\\{number\_less}(\\{maxabs},\39\\{fraction\_one\_t}))\W(\|s>%
\T{1})){}$\5
${}\{{}$\1\6
\\{number\_double}(\|a);\6
\\{number\_double}(\|b);\6
\\{number\_double}(\|c);\6
\\{number\_double}(\|d);\6
\\{number\_double}(\\{maxabs});\6
${}\|s\K\|s/\T{2};{}$\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\|a,\39\|d);{}$\6
${}\\{take\_fraction}(\\{r2},\39\|b,\39\|c);{}$\6
${}\\{number\_substract}(\\{r1},\39\\{r2});{}$\6
\\{number\_abs}(\\{r1});\6
${}\\{square\_rt}({*}\\{ret},\39\\{r1});{}$\6
${}\\{number\_multiply\_int}({*}\\{ret},\39\|s);{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
\\{free\_number}(\|a);\6
\\{free\_number}(\|b);\6
\\{free\_number}(\|c);\6
\\{free\_number}(\|d);\6
\\{free\_number}(\\{maxabs});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_get\_pen\_scale}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_knot} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \|a${},{}$ \|b${},{}$ \|c${},{}$ \|d;\7
\\{new\_number}(\|a);\6
\\{new\_number}(\|b);\6
\\{new\_number}(\|c);\6
\\{new\_number}(\|d);\6
${}\\{set\_number\_from\_substraction}(\|a,\39\|p\MG\\{left\_x},\39\|p\MG\\{x%
\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\|b,\39\|p\MG\\{right\_x},\39\|p\MG\\{x%
\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\|c,\39\|p\MG\\{left\_y},\39\|p\MG\\{y%
\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\|d,\39\|p\MG\\{right\_y},\39\|p\MG\\{y%
\_coord});{}$\6
${}\\{mp\_sqrt\_det}(\\{mp},\39\\{ret},\39\|a,\39\|b,\39\|c,\39\|d);{}$\6
\\{free\_number}(\|a);\6
\\{free\_number}(\|b);\6
\\{free\_number}(\|c);\6
\\{free\_number}(\|d);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{468}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_sqrt\_det}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \|a${},\39{}$\&{mp\_number} \|b${},\39{}$%
\&{mp\_number} \|c${},\39{}$\&{mp\_number} \|d);\par
\fi

\M{469}When a picture contains text, this is represented by a fourteen-word
node
where the color information and \PB{\\{type}} and \PB{\\{link}} fields are
augmented by
additional fields that describe the text and  how it is transformed.
The \PB{\\{path\_p}} and \PB{\\{mp\_pen\_p}} pointers are replaced by a number
that identifies
the font and a string number that gives the text to be displayed.
The \PB{\\{width}}, \PB{\\{height}}, and \PB{\\{depth}} fields
give the dimensions of the text at its design size, and the remaining six
words give a transformation to be applied to the text.  The \PB{\\{new\_text%
\_node}}
function initializes everything to default values so that the text comes out
black with its reference point at the origin.

\Y\B\4\D$\\{mp\_text\_p}(\|A)$ \5
$((\\{mp\_text\_node})(\|A))\MG{}$\\{text\_p\_}\C{ a string pointer for the
text to display }\par
\B\4\D$\\{mp\_font\_n}(\|A)$ \5
$((\\{mp\_text\_node})(\|A))\MG{}$\\{font\_n\_}\C{ the font number }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_text\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{halfword} \\{color\_model\_};\6
\&{mp\_number} \\{red};\6
\&{mp\_number} \\{green};\6
\&{mp\_number} \\{blue};\6
\&{mp\_number} \\{black};\6
\&{mp\_string} \\{pre\_script\_};\6
\&{mp\_string} \\{post\_script\_};\6
\&{mp\_string} \\{text\_p\_};\6
\&{halfword} \\{font\_n\_};\6
\&{mp\_number} \\{width};\6
\&{mp\_number} \\{height};\6
\&{mp\_number} \\{depth};\6
\&{mp\_number} \\{tx};\6
\&{mp\_number} \\{ty};\6
\&{mp\_number} \\{txx};\6
\&{mp\_number} \\{txy};\6
\&{mp\_number} \\{tyx};\6
\&{mp\_number} \\{tyy};\2\6
${}\}{}$ \&{mp\_text\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_text\_node\_data} ${}{*}\&{mp\_text\_node}{}$;\par
\fi

\M{470}\B\X459:Graphical object codes\X${}\mathrel+\E{}$\6
$\\{mp\_text\_code}\K\T{3}$ $,{}$\par
\fi

\M{471} Make a text node for font \PB{\|f} and text string \PB{\|s}.

\Y\B\4\D$\\{text\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_text\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_new\_text\_node}(\&{MP} \\{mp}${},\39{}$%
\&{char} ${}{*}\|f,\39{}$\&{mp\_string} \|s)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_text\_node} \|t${}\K\\{malloc\_node}(\\{text\_node\_size});{}$\7
${}\\{mp\_type}(\|t)\K\\{mp\_text\_node\_type};{}$\6
${}\\{mp\_text\_p}(\|t)\K\|s;{}$\6
\\{add\_str\_ref}(\|s);\6
${}\\{mp\_font\_n}(\|t)\K{}$(\&{halfword}) \\{mp\_find\_font}${}(\\{mp},\39%
\|f){}$;\C{ this identifies the font }\6
${}\\{new\_number}(\|t\MG\\{red});{}$\6
${}\\{new\_number}(\|t\MG\\{green});{}$\6
${}\\{new\_number}(\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\|t\MG\\{black});{}$\6
${}\\{new\_number}(\|t\MG\\{width});{}$\6
${}\\{new\_number}(\|t\MG\\{height});{}$\6
${}\\{new\_number}(\|t\MG\\{depth});{}$\6
\\{clear\_color}(\|t);\6
${}\\{mp\_pre\_script}(\|t)\K\NULL;{}$\6
${}\\{mp\_post\_script}(\|t)\K\NULL;{}$\6
${}\\{new\_number}(\|t\MG\\{tx});{}$\6
${}\\{new\_number}(\|t\MG\\{ty});{}$\6
${}\\{new\_number}(\|t\MG\\{txx});{}$\6
${}\\{new\_number}(\|t\MG\\{txy});{}$\6
${}\\{new\_number}(\|t\MG\\{tyx});{}$\6
${}\\{new\_number}(\|t\MG\\{tyy}){}$;\C{ \PB{$\\{tx\_val}(\|t)\K\T{0};{}$ ${}%
\\{ty\_val}(\|t)\K\T{0};$} }\C{ \PB{$\\{txy\_val}(\|t)\K\T{0};{}$ ${}\\{tyx%
\_val}(\|t)\K\T{0};$} }\6
${}\\{set\_number\_to\_unity}(\|t\MG\\{txx});{}$\6
${}\\{set\_number\_to\_unity}(\|t\MG\\{tyy});{}$\6
${}\\{mp\_set\_text\_box}(\\{mp},\39\|t){}$;\C{ this finds the bounding box }\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\par
\fi

\M{472}\B\&{static} \&{void} \\{mp\_free\_text\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_text\_node} \|p)\1\1\2\2\6
${}\{{}$\C{ \PB{\\{delete\_str\_ref}(\\{mp\_text\_p}(\|p));} }\C{ gives errors
}\1\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{delete\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
${}\\{free\_number}(\|p\MG\\{red});{}$\6
${}\\{free\_number}(\|p\MG\\{green});{}$\6
${}\\{free\_number}(\|p\MG\\{blue});{}$\6
${}\\{free\_number}(\|p\MG\\{black});{}$\6
${}\\{free\_number}(\|p\MG\\{width});{}$\6
${}\\{free\_number}(\|p\MG\\{height});{}$\6
${}\\{free\_number}(\|p\MG\\{depth});{}$\6
${}\\{free\_number}(\|p\MG\\{tx});{}$\6
${}\\{free\_number}(\|p\MG\\{ty});{}$\6
${}\\{free\_number}(\|p\MG\\{txx});{}$\6
${}\\{free\_number}(\|p\MG\\{txy});{}$\6
${}\\{free\_number}(\|p\MG\\{tyx});{}$\6
${}\\{free\_number}(\|p\MG\\{tyy});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{text\_node%
\_size});{}$\6
\4${}\}{}$\2\par
\fi

\M{473}The last two types of graphical objects that can occur in an edge
structure
are clipping paths and \&{setbounds} paths.  These are slightly more difficult
to implement because we must keep track of exactly what is being clipped or
bounded when pictures get merged together.  For this reason, each clipping or
\&{setbounds} operation is represented by a pair of nodes:  first comes a
node whose \PB{\\{path\_p}} gives the relevant path, then there is the list
of objects to clip or bound followed by a closing node.

\Y\B\4\D$\\{has\_color}(\|A)$ \5
$(\\{mp\_type}((\|A))<\\{mp\_start\_clip\_node\_type}{}$)\C{ does a graphical
object have color fields? }\par
\B\4\D$\\{has\_pen}(\|A)$ \5
$(\\{mp\_type}((\|A))<\\{mp\_text\_node\_type}{}$)\C{ does a graphical object
have a \PB{\\{mp\_pen\_p}} field? }\par
\B\4\D$\\{is\_start\_or\_stop}(\|A)$ \5
$(\\{mp\_type}((\|A))\G\\{mp\_start\_clip\_node\_type}{}$)\par
\B\4\D$\\{is\_stop}(\|A)$ \5
$(\\{mp\_type}((\|A))\G\\{mp\_stop\_clip\_node\_type}{}$)\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_start\_clip\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_knot} \\{path\_p\_};\2\6
${}\}{}$ \&{mp\_start\_clip\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_start\_clip\_node\_data} ${}{*}\&{mp\_start\_clip%
\_node};{}$\6
\&{typedef} \&{struct} \&{mp\_start\_bounds\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_knot} \\{path\_p\_};\2\6
${}\}{}$ \&{mp\_start\_bounds\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_start\_bounds\_node\_data} ${}{*}\&{mp\_start%
\_bounds\_node};{}$\6
\&{typedef} \&{struct} \&{mp\_stop\_clip\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\2\6
${}\}{}$ \&{mp\_stop\_clip\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_stop\_clip\_node\_data} ${}{*}\&{mp\_stop\_clip%
\_node};{}$\6
\&{typedef} \&{struct} \&{mp\_stop\_bounds\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\2\6
${}\}{}$ \&{mp\_stop\_bounds\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_stop\_bounds\_node\_data} ${}{*}\&{mp\_stop%
\_bounds\_node}{}$;\par
\fi

\M{474}\B\X459:Graphical object codes\X${}\mathrel+\E{}$\6
$\\{mp\_start\_clip\_code}\K\T{4},{}$\C{ \PB{\\{type}} of a node that starts
clipping }\6
\\{mp\_start\_bounds\_code}${}\K\T{5},{}$\C{ \PB{\\{type}} of a node that gives
a \&{setbounds} path }\6
\\{mp\_stop\_clip\_code}${}\K\T{6},{}$\C{ \PB{\\{type}} of a node that stops
clipping }\6
\\{mp\_stop\_bounds\_code}${}\K\T{7}$ $,{}$\C{ \PB{\\{type}} of a node that
stops \&{setbounds} }\par
\fi

\M{475}

\Y\B\4\D$\\{start\_clip\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_start\_clip\_node\_data})\par
\B\4\D$\\{stop\_clip\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_stop\_clip\_node\_data})\par
\B\4\D$\\{start\_bounds\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_start\_bounds\_node\_data})\par
\B\4\D$\\{stop\_bounds\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_stop\_bounds\_node\_data})\par
\Y\B\&{static} \&{mp\_node} \\{mp\_new\_bounds\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\C{ make a node of type \PB{\|c} where \PB{\|p} is the clipping or %
\&{setbounds} path }\1\6
\&{if} ${}(\|c\E\\{mp\_start\_clip\_node\_type}){}$\5
${}\{{}$\1\6
\&{mp\_start\_clip\_node} \|t;\C{ the new node }\7
${}\|t\K{}$(\&{mp\_start\_clip\_node}) \\{malloc\_node}(\\{start\_clip\_size});%
\6
${}\|t\MG\\{path\_p\_}\K\|p;{}$\6
${}\\{mp\_type}(\|t)\K\|c;{}$\6
${}\|t\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\\{mp\_start\_bounds\_node\_type}){}$\5
${}\{{}$\1\6
\&{mp\_start\_bounds\_node} \|t;\C{ the new node }\7
${}\|t\K{}$(\&{mp\_start\_bounds\_node}) \\{malloc\_node}(\\{start\_bounds%
\_size});\6
${}\|t\MG\\{path\_p\_}\K\|p;{}$\6
${}\\{mp\_type}(\|t)\K\|c;{}$\6
${}\|t\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\\{mp\_stop\_clip\_node\_type}){}$\5
${}\{{}$\1\6
\&{mp\_stop\_clip\_node} \|t;\C{ the new node }\7
${}\|t\K{}$(\&{mp\_stop\_clip\_node}) \\{malloc\_node}(\\{stop\_clip\_size});\6
${}\\{mp\_type}(\|t)\K\|c;{}$\6
${}\|t\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\\{mp\_stop\_bounds\_node\_type}){}$\5
${}\{{}$\1\6
\&{mp\_stop\_bounds\_node} \|t;\C{ the new node }\7
${}\|t\K{}$(\&{mp\_stop\_bounds\_node}) \\{malloc\_node}(\\{stop\_bounds%
\_size});\6
${}\\{mp\_type}(\|t)\K\|c;{}$\6
${}\|t\MG\\{link}\K\NULL;{}$\6
\&{return} (\&{mp\_node}) \|t;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{assert}(\T{0});\6
\4${}\}{}$\2\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{476}\B\&{static} \&{void} \\{mp\_free\_start\_clip\_node}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_start\_clip\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_path\_p}(\|p));{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{start\_clip%
\_size});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_free\_start\_bounds\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_start\_bounds\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{mp\_path\_p}(\|p));{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{start\_bounds%
\_size});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_free\_stop\_clip\_node}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_stop\_clip\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{stop\_clip%
\_size});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_free\_stop\_bounds\_node}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_stop\_bounds\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{stop\_bounds%
\_size});{}$\6
\4${}\}{}$\2\par
\fi

\M{477}All the essential information in an edge structure is encoded as a
linked list
of graphical objects as we have just seen, but it is helpful to add some
redundant information.  A single edge structure might be used as a dash pattern
many times, and it would be nice to avoid scanning the same structure
repeatedly.  Thus, an edge structure known to be a suitable dash pattern
has a header that gives a list of dashes in a sorted order designed for rapid
translation into \ps.

Each dash is represented by a three-word node containing the initial and final
$x$~coordinates as well as the usual \PB{\\{link}} field.  The \PB{\\{link}}
fields points to
the dash node with the next higher $x$-coordinates and the final link points
to a special location called \PB{\\{null\_dash}}.  (There should be no overlap
between
dashes).  Since the $y$~coordinate of the dash pattern is needed to determine
the period of repetition, this needs to be stored in the edge header along
with a pointer to the list of dash nodes.

The \PB{\\{dash\_info}} is explained below.

\Y\B\4\D$\\{dash\_list}(\|A)$ \5
$(\\{mp\_dash\_node})(((\\{mp\_dash\_node})(\|A))\MG\\{link}{}$)\C{ in an edge
header this points to the first dash node }\par
\B\4\D$\\{set\_dash\_list}(\|A,\|B)$ \5
$((\\{mp\_dash\_node})(\|A))\MG\\{link}\K{}$(\&{mp\_node})((\|B))\C{ in an edge
header this points to the first dash node }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_dash\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_number} \\{start\_x};\C{ the starting $x$~coordinate in a dash node }\6
\&{mp\_number} \\{stop\_x};\C{ the ending $x$~coordinate in a dash node }\6
\&{mp\_number} \\{dash\_y};\C{ $y$ value for the dash list in an edge header }\6
\&{mp\_node} \\{dash\_info\_};\2\6
${}\}{}$ \&{mp\_dash\_node\_data};\par
\fi

\M{478}\B\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_dash\_node\_data} ${}{*}\&{mp\_dash\_node}{}$;\par
\fi

\M{479}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{null\_dash}\K\\{mp\_get\_dash\_node}(\\{mp}){}$;\par
\fi

\M{480}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \\{mp}${}\MG\\{null\_dash},\39%
\\{dash\_node\_size}){}$;\par
\fi

\M{481}
\Y\B\4\D$\\{dash\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_dash\_node\_data})\par
\Y\B\&{static} \&{mp\_dash\_node} \\{mp\_get\_dash\_node}(\&{MP} \\{mp})\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_dash\_node} \|p${}\K{}$(\&{mp\_dash\_node}) \\{malloc\_node}(\\{dash%
\_node\_size});\7
${}\|p\MG\\{has\_number}\K\T{0};{}$\6
${}\\{new\_number}(\|p\MG\\{start\_x});{}$\6
${}\\{new\_number}(\|p\MG\\{stop\_x});{}$\6
${}\\{new\_number}(\|p\MG\\{dash\_y});{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_dash\_node\_type};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{482}It is also convenient for an edge header to contain the bounding
box information needed by the \&{llcorner} and \&{urcorner} operators
so that this does not have to be recomputed unnecessarily.  This is done by
adding fields for the $x$~and $y$ extremes as well as a pointer that indicates
how far the bounding box computation has gotten.  Thus if the user asks for
the bounding box and then adds some more text to the picture before asking
for more bounding box information, the second computation need only look at
the additional text.

When the bounding box has not been computed, the \PB{\\{bblast}} pointer points
to a dummy link at the head of the graphical object list while the \PB{\\{minx%
\_val}}
and \PB{\\{miny\_val}} fields contain \PB{\.{EL\_GORDO}} and the \PB{\\{maxx%
\_val}} and \PB{\\{maxy\_val}}
fields contain \PB{${-}\.{EL\_GORDO}$}.

Since the bounding box of pictures containing objects of type
\PB{\&{mp\_start\_bounds\_node}} depends on the value of \&{truecorners}, the
bounding box
data might not be valid for all values of this parameter.  Hence, the \PB{%
\\{bbtype}}
field is needed to keep track of this.

\Y\B\4\D$\\{bblast}(\|A)$ \5
$((\\{mp\_edge\_header\_node})(\|A))\MG{}$\\{bblast\_}\C{ last item considered
in bounding box computation }\par
\B\4\D$\\{edge\_list}(\|A)$ \5
$((\\{mp\_edge\_header\_node})(\|A))\MG{}$\\{list\_}\C{ where the object list
begins in an edge header }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_edge\_header\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{mp\_number} \\{start\_x};\6
\&{mp\_number} \\{stop\_x};\6
\&{mp\_number} \\{dash\_y};\6
\&{mp\_node} \\{dash\_info\_};\6
\&{mp\_number} \\{minx};\6
\&{mp\_number} \\{miny};\6
\&{mp\_number} \\{maxx};\6
\&{mp\_number} \\{maxy};\6
\&{mp\_node} \\{bblast\_};\6
\&{int} \\{bbtype};\C{ tells how bounding box data depends on \&{truecorners} }%
\6
\&{mp\_node} \\{list\_};\6
\&{mp\_node} \\{obj\_tail\_};\C{ explained below }\6
\&{halfword} \\{ref\_count\_};\C{ explained below }\2\6
${}\}{}$ \&{mp\_edge\_header\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_edge\_header\_node\_data} ${}{*}\&{mp\_edge%
\_header\_node}{}$;\par
\fi

\M{483}
\Y\B\4\D$\\{no\_bounds}$ \5
\T{0}\C{ \PB{\\{bbtype}} value when bounding box data is valid for all %
\&{truecorners} values }\par
\B\4\D$\\{bounds\_set}$ \5
\T{1}\C{ \PB{\\{bbtype}} value when bounding box data is for \&{truecorners}${}%
\le 0$ }\par
\B\4\D$\\{bounds\_unset}$ \5
\T{2}\C{ \PB{\\{bbtype}} value when bounding box data is for %
\&{truecorners}${}>0$ }\par
\Y\B\&{static} \&{void} \\{mp\_init\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\C{ Initialize the bounding box information in edge structure \PB{\|h}
}\1\6
(\&{void}) \\{mp};\6
${}\\{bblast}(\|h)\K\\{edge\_list}(\|h);{}$\6
${}\|h\MG\\{bbtype}\K\\{no\_bounds};{}$\6
${}\\{set\_number\_to\_inf}(\|h\MG\\{minx});{}$\6
${}\\{set\_number\_to\_inf}(\|h\MG\\{miny});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|h\MG\\{maxx});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|h\MG\\{maxy});{}$\6
\4${}\}{}$\2\par
\fi

\M{484}The only other entries in an edge header are a reference count in the
first
word and a pointer to the tail of the object list in the last word.

\Y\B\4\D$\\{obj\_tail}(\|A)$ \5
$((\&{mp\_edge\_header\_node})(\|A))\MG{}$\\{obj\_tail\_}\C{ points to the last
entry in the object list }\par
\B\4\D$\\{edge\_ref\_count}(\|A)$ \5
$((\&{mp\_edge\_header\_node})(\|A))\MG{}$\\{ref\_count\_}\par
\B\4\D$\\{edge\_header\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_edge\_header\_node\_data})\par
\Y\B\&{static} \&{mp\_edge\_header\_node} \\{mp\_get\_edge\_header\_node}(%
\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_edge\_header\_node} \|p${}\K{}$(\&{mp\_edge\_header\_node}) \\{malloc%
\_node}(\\{edge\_header\_size});\7
${}\\{mp\_type}(\|p)\K\\{mp\_edge\_header\_node\_type};{}$\6
${}\\{new\_number}(\|p\MG\\{start\_x});{}$\6
${}\\{new\_number}(\|p\MG\\{stop\_x});{}$\6
${}\\{new\_number}(\|p\MG\\{dash\_y});{}$\6
${}\\{new\_number}(\|p\MG\\{minx});{}$\6
${}\\{new\_number}(\|p\MG\\{miny});{}$\6
${}\\{new\_number}(\|p\MG\\{maxx});{}$\6
${}\\{new\_number}(\|p\MG\\{maxy});{}$\6
${}\|p\MG\\{list\_}\K\\{mp\_get\_token\_node}(\\{mp}){}$;\C{ or whatever, just
a need a link handle }\6
\&{return} \|p;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_init\_edges}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\C{ initialize an edge header to NULL values }\1\6
${}\\{set\_dash\_list}(\|h,\39\\{mp}\MG\\{null\_dash});{}$\6
${}\\{obj\_tail}(\|h)\K\\{edge\_list}(\|h);{}$\6
${}\\{mp\_link}(\\{edge\_list}(\|h))\K\NULL;{}$\6
${}\\{edge\_ref\_count}(\|h)\K\T{0};{}$\6
${}\\{mp\_init\_bbox}(\\{mp},\39\|h);{}$\6
\4${}\}{}$\2\par
\fi

\M{485}Here is how edge structures are deleted.  The process can be recursive
because
of the need to dereference edge structures that are used as dash patterns.

\Y\B\4\D$\\{add\_edge\_ref}(\|A)$ \5
\\{incr}(\\{edge\_ref\_count}((\|A)))\par
\B\4\D$\\{delete\_edge\_ref}(\|A)$ \6
${}\{{}$\1\6
\&{if} ${}(\\{edge\_ref\_count}((\|A))\E\T{0}){}$\1\5
${}\\{mp\_toss\_edges}(\\{mp},\39(\&{mp\_edge\_header\_node})(\|A));{}$\2\6
\&{else}\1\5
\\{decr}(\\{edge\_ref\_count}((\|A)));\2\6
\4${}\}{}$\2\par
\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_flush\_dash\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_edge\_header\_node} \|h);\6
\&{static} \&{mp\_edge\_header\_node} \\{mp\_toss\_gr\_object}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_node} \|p);\6
\&{static} \&{void} \\{mp\_toss\_edges}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h);\par
\fi

\M{486}\B\&{void} \\{mp\_toss\_edges}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ pointers that scan the list being recycled }\6
\&{mp\_edge\_header\_node} \|r;\C{ an edge structure that object \PB{\|p}
refers to }\7
${}\\{mp\_flush\_dash\_list}(\\{mp},\39\|h);{}$\6
${}\|q\K\\{mp\_link}(\\{edge\_list}(\|h));{}$\6
\&{while} ${}((\|q\I\NULL)){}$\5
${}\{{}$\1\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\|r\K\\{mp\_toss\_gr\_object}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\|r\I\NULL){}$\1\5
\\{delete\_edge\_ref}(\|r);\2\6
\4${}\}{}$\2\6
${}\\{free\_number}(\|h\MG\\{start\_x});{}$\6
${}\\{free\_number}(\|h\MG\\{stop\_x});{}$\6
${}\\{free\_number}(\|h\MG\\{dash\_y});{}$\6
${}\\{free\_number}(\|h\MG\\{minx});{}$\6
${}\\{free\_number}(\|h\MG\\{miny});{}$\6
${}\\{free\_number}(\|h\MG\\{maxx});{}$\6
${}\\{free\_number}(\|h\MG\\{maxy});{}$\6
${}\\{mp\_free\_token\_node}(\\{mp},\39\|h\MG\\{list\_});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|h${},\39\\{edge\_header%
\_size});{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_flush\_dash\_list}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge\_header%
\_node} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_dash\_node} \|p${},{}$ \|q;\C{ pointers that scan the list being
recycled }\7
${}\|q\K\\{dash\_list}(\|h);{}$\6
\&{while} ${}(\|q\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\C{ todo: NULL check should not be needed }\1\6
${}\|p\K\|q;{}$\6
${}\|q\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|q);\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p${},\39\\{dash\_node%
\_size});{}$\6
\4${}\}{}$\2\6
${}\\{set\_dash\_list}(\|h,\39\\{mp}\MG\\{null\_dash});{}$\6
\4${}\}{}$\2\7
\&{mp\_edge\_header\_node} \\{mp\_toss\_gr\_object}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\C{ returns an edge structure that needs to be dereferenced }\1\6
\&{mp\_edge\_header\_node} \|e${}\K\NULL{}$;\C{ the edge structure to return }\7
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\\{mp\_free\_fill\_node}(\\{mp},\39{}$(\&{mp\_fill\_node}) \|p);\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\|e\K\\{mp\_free\_stroked\_node}(\\{mp},\39{}$(\&{mp\_stroked\_node}) \|p);\6
\&{break};\6
\4\&{case} \\{mp\_text\_node\_type}:\5
${}\\{mp\_free\_text\_node}(\\{mp},\39{}$(\&{mp\_text\_node}) \|p);\6
\&{break};\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\\{mp\_free\_start\_clip\_node}(\\{mp},\39{}$(\&{mp\_start\_clip\_node}) %
\|p);\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\\{mp\_free\_start\_bounds\_node}(\\{mp},\39{}$(\&{mp\_start\_bounds\_node})
\|p);\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
${}\\{mp\_free\_stop\_clip\_node}(\\{mp},\39{}$(\&{mp\_stop\_clip\_node}) \|p);%
\6
\&{break};\6
\4\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
${}\\{mp\_free\_stop\_bounds\_node}(\\{mp},\39{}$(\&{mp\_stop\_bounds\_node}) %
\|p);\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\&{return} \|e;\6
\4${}\}{}$\2\par
\fi

\M{487}If we use \PB{\\{add\_edge\_ref}} to ``copy'' edge structures, the real
copying needs
to be done before making a significant change to an edge structure.  Much of
the work is done in a separate routine \PB{\\{copy\_objects}} that copies a
list of
graphical objects into a new edge header.

\Y\B\&{static} \&{mp\_edge\_header\_node} \\{mp\_private\_edges}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_edge\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\C{ make a private copy of the edge structure headed by \PB{\|h} }\1\6
\&{mp\_edge\_header\_node} \\{hh};\C{ the edge header for the new copy }\6
\&{mp\_dash\_node} \|p${},{}$ \\{pp};\C{ pointers for copying the dash list }\7
${}\\{assert}(\\{mp\_type}(\|h)\E\\{mp\_edge\_header\_node\_type});{}$\6
\&{if} ${}(\\{edge\_ref\_count}(\|h)\E\T{0}){}$\5
${}\{{}$\1\6
\&{return} \|h;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{decr}(\\{edge\_ref\_count}(\|h));\6
${}\\{hh}\K{}$(\&{mp\_edge\_header\_node}) \\{mp\_copy\_objects}${}(\\{mp},\39%
\\{mp\_link}(\\{edge\_list}(\|h)),\39\NULL);{}$\6
\X488:Copy the dash list from \PB{\|h} to \PB{\\{hh}}\X;\6
\X490:Copy the bounding box information from \PB{\|h} to \PB{\\{hh}} and make %
\PB{\\{bblast}(\\{hh})} point into the new object list\X;\6
\&{return} \\{hh};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{488}Here we use the fact that \PB{$\\{dash\_list}(\\{hh})\K\\{mp\_link}(%
\\{hh})$}.

\Y\B\4\X488:Copy the dash list from \PB{\|h} to \PB{\\{hh}}\X${}\E{}$\6
$\\{pp}\K{}$(\&{mp\_dash\_node}) \\{hh};\6
${}\|p\K\\{dash\_list}(\|h);{}$\6
\&{while} ${}((\|p\I\\{mp}\MG\\{null\_dash})){}$\5
${}\{{}$\1\6
${}\\{mp\_link}(\\{pp})\K{}$(\&{mp\_node}) \\{mp\_get\_dash\_node}(\\{mp});\6
${}\\{pp}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{pp});\6
${}\\{number\_clone}(\\{pp}\MG\\{start\_x},\39\|p\MG\\{start\_x});{}$\6
${}\\{number\_clone}(\\{pp}\MG\\{stop\_x},\39\|p\MG\\{stop\_x});{}$\6
${}\|p\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\\{pp})\K{}$(\&{mp\_node}) \\{mp}${}\MG\\{null\_dash};$ $%
\\{number\_clone}(\\{hh}\MG\\{dash\_y},\39\|h\MG\\{dash\_y}{}$)\par
\U487.\fi

\M{489}\PB{\|h} is an edge structure

\Y\B\&{static} \\{mp\_dash\_object}${}{*}{}$\\{mp\_export\_dashes}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_stroked\_node} \|q${},\39{}$\&{mp\_number} \|w)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_dash\_object}*\|d;{}$\7
\&{mp\_dash\_node} \|p${},{}$ \|h;\6
\&{mp\_number} \\{scf};\C{ scale factor }\6
\&{mp\_number} \\{dashoff};\6
\&{double} ${}{*}\\{dashes}\K\NULL;{}$\6
\&{int} \\{num\_dashes}${}\K\T{1};{}$\7
${}\|h\K{}$(\&{mp\_dash\_node}) \\{mp\_dash\_p}(\|q);\6
\&{if} ${}(\|h\E\NULL\V\\{dash\_list}(\|h)\E\\{mp}\MG\\{null\_dash}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
\\{new\_number}(\\{scf});\6
${}\|p\K\\{dash\_list}(\|h);{}$\6
${}\\{mp\_get\_pen\_scale}(\\{mp},\39{\AND}\\{scf},\39\\{mp\_pen\_p}(\|q));{}$\6
\&{if} (\\{number\_zero}(\\{scf}))\5
${}\{{}$\1\6
\&{if} (\\{number\_zero}(\|w))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{scf},\39\|q\MG\\{dash\_scale});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{free\_number}(\\{scf});\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\|w,\39\\{scf});{}$\6
${}\\{take\_scaled}(\\{scf},\39\\{ret},\39\|q\MG\\{dash\_scale});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\|w,\39\\{scf});{}$\6
${}\|d\K\\{xmalloc}(\T{1},\39{}$\&{sizeof} (\\{mp\_dash\_object}));\6
\\{add\_var\_used}(\&{sizeof} (\\{mp\_dash\_object}));\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{null\_dash}\MG\\{start\_x},\39%
\|p\MG\\{start\_x},\39\|h\MG\\{dash\_y});{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ret}${},{}$ \\{arg1};\7
\\{new\_number}(\\{ret});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{dashoff});\6
\&{while} ${}(\|p\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
${}\\{dashes}\K\\{xrealloc}(\\{dashes},\39(\\{num\_dashes}+\T{2}),\39%
\&{sizeof}(\&{double}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|p\MG\\{stop\_x},\39\|p\MG%
\\{start\_x});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{arg1},\39\\{scf});{}$\6
${}\\{dashes}[(\\{num\_dashes}-\T{1})]\K\\{number\_to\_double}(\\{ret});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39{}$((\&{mp\_dash\_node}) %
\\{mp\_link}(\|p))${}\MG\\{start\_x},\39\|p\MG\\{stop\_x});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{arg1},\39\\{scf});{}$\6
${}\\{dashes}[(\\{num\_dashes})]\K\\{number\_to\_double}(\\{ret});{}$\6
${}\\{dashes}[(\\{num\_dashes}+\T{1})]\K{-}\T{1.0}{}$;\C{ terminus }\6
${}\\{num\_dashes}\MRL{+{\K}}\T{2};{}$\6
${}\|p\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
${}\|d\MG\\{array}\K\\{dashes};{}$\6
${}\\{mp\_dash\_offset}(\\{mp},\39{\AND}\\{dashoff},\39\|h);{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{dashoff},\39\\{scf});{}$\6
${}\|d\MG\\{offset}\K\\{number\_to\_double}(\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{dashoff});\6
\\{free\_number}(\\{scf});\6
\&{return} \|d;\6
\4${}\}{}$\2\par
\fi

\M{490}\B\X490:Copy the bounding box information from \PB{\|h} to \PB{\\{hh}}
and make \PB{\\{bblast}(\\{hh})} point into the new object list\X${}\E{}$\6
$\\{number\_clone}(\\{hh}\MG\\{minx},\39\|h\MG\\{minx});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{miny},\39\|h\MG\\{miny});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{maxx},\39\|h\MG\\{maxx});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{maxy},\39\|h\MG\\{maxy});{}$\6
${}\\{hh}\MG\\{bbtype}\K\|h\MG\\{bbtype};{}$\6
${}\|p\K{}$(\&{mp\_dash\_node}) \\{edge\_list}(\|h);\6
${}\\{pp}\K{}$(\&{mp\_dash\_node}) \\{edge\_list}(\\{hh});\6
\&{while} ${}((\|p\I{}$(\&{mp\_dash\_node}) \\{bblast}(\|h)))\5
${}\{{}$\1\6
\&{if} ${}(\|p\E\NULL){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"bblast"});{}$\2\6
;\6
${}\|p\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|p);\6
${}\\{pp}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{pp});\6
\4${}\}{}$\2\6
$\\{bblast}(\\{hh})\K{}$(\&{mp\_node}) \\{pp}\par
\U487.\fi

\M{491}Here is the promised routine for copying graphical objects into a new
edge
structure.  It starts copying at object~\PB{\|p} and stops just before object~%
\PB{\|q}.
If \PB{\|q} is NULL, it copies the entire sublist headed at \PB{\|p}.  The
resulting edge
structure requires further initialization by \PB{\\{init\_bbox}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_edge\_header\_node} \\{mp\_copy\_objects}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \|p${},\39{}$\&{mp\_node} \|q);\par
\fi

\M{492}\B\&{mp\_edge\_header\_node} \\{mp\_copy\_objects}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \|p${},\39{}$\&{mp\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_edge\_header\_node} \\{hh};\C{ the new edge header }\6
\&{mp\_node} \\{pp};\C{ the last newly copied object }\6
\&{quarterword} \|k${}\K\T{0}{}$;\C{ temporary register }\7
${}\\{hh}\K\\{mp\_get\_edge\_header\_node}(\\{mp});{}$\6
${}\\{set\_dash\_list}(\\{hh},\39\\{mp}\MG\\{null\_dash});{}$\6
${}\\{edge\_ref\_count}(\\{hh})\K\T{0};{}$\6
${}\\{pp}\K\\{edge\_list}(\\{hh});{}$\6
\&{while} ${}(\|p\I\|q){}$\5
${}\{{}$\1\6
\X493:Make \PB{\\{mp\_link}(\\{pp})} point to a copy of object \PB{\|p}, and
update \PB{\|p} and \PB{\\{pp}}\X;\6
\4${}\}{}$\2\6
${}\\{obj\_tail}(\\{hh})\K\\{pp};{}$\6
${}\\{mp\_link}(\\{pp})\K\NULL;{}$\6
\&{return} \\{hh};\6
\4${}\}{}$\2\par
\fi

\M{493}\B\X493:Make \PB{\\{mp\_link}(\\{pp})} point to a copy of object \PB{%
\|p}, and update \PB{\|p} and \PB{\\{pp}}\X${}\E{}$\6
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\|k\K\\{start\_clip\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\|k\K\\{start\_bounds\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\|k\K\\{fill\_node\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\|k\K\\{stroked\_node\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_text\_node\_type}:\5
${}\|k\K\\{text\_node\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
${}\|k\K\\{stop\_clip\_size};{}$\6
\&{break};\6
\4\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
${}\|k\K\\{stop\_bounds\_size};{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\\{pp})\K\\{malloc\_node}{}$((\&{size\_t}) \|k);\C{ \PB{\\{gr%
\_object}} }\6
${}\\{pp}\K\\{mp\_link}(\\{pp});{}$\6
${}\\{memcpy}(\\{pp},\39\|p,\39{}$(\&{size\_t}) \|k);\6
${}\\{pp}\MG\\{link}\K\NULL;{}$\6
\X494:Fix anything in graphical object \PB{\\{pp}} that should differ from the
corresponding field in \PB{\|p}\X;\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\par
\U492.\fi

\M{494}\B\X494:Fix anything in graphical object \PB{\\{pp}} that should differ
from the corresponding field in \PB{\|p}\X${}\E{}$\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_start\_clip\_node} \\{tt}${}\K{}$(\&{mp\_start\_clip\_node}) \\{pp};\6
\&{mp\_start\_clip\_node} \|t${}\K{}$(\&{mp\_start\_clip\_node}) \|p;\7
${}\\{mp\_path\_p}(\\{tt})\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(%
\|t));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_start\_bounds\_node} \\{tt}${}\K{}$(\&{mp\_start\_bounds\_node}) \\{pp};%
\6
\&{mp\_start\_bounds\_node} \|t${}\K{}$(\&{mp\_start\_bounds\_node}) \|p;\7
${}\\{mp\_path\_p}(\\{tt})\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(%
\|t));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_fill\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_fill\_node} \\{tt}${}\K{}$(\&{mp\_fill\_node}) \\{pp};\6
\&{mp\_fill\_node} \|t${}\K{}$(\&{mp\_fill\_node}) \|p;\7
${}\\{new\_number}(\\{tt}\MG\\{red});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{red},\39\|t\MG\\{red});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{green});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{green},\39\|t\MG\\{green});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{blue});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{blue},\39\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{black});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{black},\39\|t\MG\\{black});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{miterlim});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{miterlim},\39\|t\MG\\{miterlim});{}$\6
${}\\{mp\_path\_p}(\\{tt})\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(%
\|t));{}$\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_pen\_p}(\|t)\I\NULL){}$\1\5
${}\\{mp\_pen\_p}(\\{tt})\K\\{copy\_pen}(\\{mp\_pen\_p}(\|t));{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_stroked\_node} \\{tt}${}\K{}$(\&{mp\_stroked\_node}) \\{pp};\6
\&{mp\_stroked\_node} \|t${}\K{}$(\&{mp\_stroked\_node}) \|p;\7
${}\\{new\_number}(\\{tt}\MG\\{red});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{red},\39\|t\MG\\{red});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{green});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{green},\39\|t\MG\\{green});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{blue});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{blue},\39\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{black});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{black},\39\|t\MG\\{black});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{miterlim});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{miterlim},\39\|t\MG\\{miterlim});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{dash\_scale});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{dash\_scale},\39\|t\MG\\{dash\_scale});{}$\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
${}\\{mp\_path\_p}(\\{tt})\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(%
\|t));{}$\6
${}\\{mp\_pen\_p}(\\{tt})\K\\{copy\_pen}(\\{mp\_pen\_p}(\|t));{}$\6
\&{if} ${}(\\{mp\_dash\_p}(\|p)\I\NULL){}$\1\5
\\{add\_edge\_ref}(\\{mp\_dash\_p}(\\{pp}));\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_text\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_text\_node} \\{tt}${}\K{}$(\&{mp\_text\_node}) \\{pp};\6
\&{mp\_text\_node} \|t${}\K{}$(\&{mp\_text\_node}) \|p;\7
${}\\{new\_number}(\\{tt}\MG\\{red});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{red},\39\|t\MG\\{red});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{green});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{green},\39\|t\MG\\{green});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{blue});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{blue},\39\|t\MG\\{blue});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{black});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{black},\39\|t\MG\\{black});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{width});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{width},\39\|t\MG\\{width});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{height});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{height},\39\|t\MG\\{height});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{depth});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{depth},\39\|t\MG\\{depth});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{tx});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{tx},\39\|t\MG\\{tx});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{ty});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{ty},\39\|t\MG\\{ty});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{txx});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{txx},\39\|t\MG\\{txx});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{tyx});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{tyx},\39\|t\MG\\{tyx});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{txy});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{txy},\39\|t\MG\\{txy});{}$\6
${}\\{new\_number}(\\{tt}\MG\\{tyy});{}$\6
${}\\{number\_clone}(\\{tt}\MG\\{tyy},\39\|t\MG\\{tyy});{}$\6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_pre\_script}(\|p));\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
\\{add\_str\_ref}(\\{mp\_post\_script}(\|p));\2\6
\\{add\_str\_ref}(\\{mp\_text\_p}(\\{pp}));\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\par
\U493.\fi

\M{495}Here is one way to find an acceptable value for the second argument to
\PB{\\{copy\_objects}}.  Given a non-NULL graphical object list, \PB{\\{skip%
\_1component}}
skips past one picture component, where a ``picture component'' is a single
graphical object, or a start bounds or start clip object and everything up
through the matching stop bounds or stop clip object.

\Y\B\&{static} \&{mp\_node} \\{mp\_skip\_1component}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \\{lev};\C{ current nesting level }\7
${}\\{lev}\K\T{0};{}$\6
(\&{void}) \\{mp};\6
\&{do}\5
${}\{{}$\1\6
\&{if} (\\{is\_start\_or\_stop}(\|p))\5
${}\{{}$\1\6
\&{if} (\\{is\_stop}(\|p))\1\5
\\{decr}(\\{lev});\2\6
\&{else}\1\5
\\{incr}(\\{lev});\2\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{lev}\I\T{0});{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{496}Here is a diagnostic routine for printing an edge structure in symbolic
form.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_edges}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline});\par
\fi

\M{497}\B\&{void} \\{mp\_print\_edges}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|h${},\39{}$\&{const} \&{char} ${}{*}\|s,\39{}$\&{boolean} \\{nuline})\1\1\2\2%
\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ a graphical object to be printed }\6
\&{mp\_number} \\{scf};\C{ a scale factor for the dash pattern }\6
\&{boolean} \\{ok\_to\_dash};\C{ \PB{\\{false}} for polygonal pen strokes }\7
\\{new\_number}(\\{scf});\6
${}\\{mp\_print\_diagnostic}(\\{mp},\39\.{"Edge\ structure"},\39\|s,\39%
\\{nuline});{}$\6
${}\|p\K\\{edge\_list}(\|h);{}$\6
\&{while} ${}(\\{mp\_link}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\\{mp\_print\_ln}(\\{mp});\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\X498:Cases for printing graphical object node \PB{\|p}\X;\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"[unknown\ object\ typ}\)\.{e!]"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"End\ edges"});{}$\6
\&{if} ${}(\|p\I\\{obj\_tail}(\|h)){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"?"});{}$\2\6
;\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{true});{}$\6
\\{free\_number}(\\{scf});\6
\4${}\}{}$\2\par
\fi

\M{498}\B\X498:Cases for printing graphical object node \PB{\|p}\X${}\E{}$\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"Filled\ contour\ "});{}$\6
${}\\{mp\_print\_obj\_color}(\\{mp},\39\|p);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{':'}));{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_pr\_path}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_fill\_node}) \|p));\6
\\{mp\_print\_ln}(\\{mp});\6
\&{if} ((\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|p)${}\I\NULL)){}$\5
${}\{{}$\1\6
\X499:Print join type for graphical object \PB{\|p}\X;\6
${}\\{mp\_print}(\\{mp},\39\.{"\ with\ pen"});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_pr\_pen}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|p));\6
\4${}\}{}$\2\6
\&{break};\par
\As503, 507, 508\ETs509.
\U497.\fi

\M{499}\B\X499:Print join type for graphical object \PB{\|p}\X${}\E{}$\6
\&{switch} (((\&{mp\_stroked\_node}) \|p)${}\MG\\{ljoin}){}$\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
${}\\{mp\_print}(\\{mp},\39\.{"mitered\ joins\ limit}\)\.{ed\ "});{}$\6
\\{print\_number}(((\&{mp\_stroked\_node}) \|p)${}\MG\\{miterlim});{}$\6
\&{break};\6
\4\&{case} \T{1}:\5
${}\\{mp\_print}(\\{mp},\39\.{"round\ joins"});{}$\6
\&{break};\6
\4\&{case} \T{2}:\5
${}\\{mp\_print}(\\{mp},\39\.{"beveled\ joins"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"??\ joins"});{}$\6
;\6
\&{break};\6
\4${}\}{}$\2\par
\Us498\ET500.\fi

\M{500}For stroked nodes, we need to print \PB{\\{lcap\_val}(\|p)} as well.

\Y\B\4\X500:Print join and cap types for stroked node \PB{\|p}\X${}\E{}$\6
\&{switch} (((\&{mp\_stroked\_node}) \|p)${}\MG\\{lcap}){}$\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
${}\\{mp\_print}(\\{mp},\39\.{"butt"});{}$\6
\&{break};\6
\4\&{case} \T{1}:\5
${}\\{mp\_print}(\\{mp},\39\.{"round"});{}$\6
\&{break};\6
\4\&{case} \T{2}:\5
${}\\{mp\_print}(\\{mp},\39\.{"square"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"??"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ ends,\ "});$ \X499:Print join type for
graphical object \PB{\|p}\X\par
\U503.\fi

\M{501}Here is a routine that prints the color of a graphical object if it
isn't
black (the default color).

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_obj\_color}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{502}\B\&{void} \\{mp\_print\_obj\_color}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_stroked\_node} \\{p0}${}\K{}$(\&{mp\_stroked\_node}) \|p;\7
\&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_grey\_model}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_positive}(\\{p0}\MG\\{grey})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"greyed\ "});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{grey});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_cmyk\_model}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_positive}(\\{p0}\MG\\{cyan})\V\\{number\_positive}(\\{p0}%
\MG\\{magenta})\V\\{number\_positive}(\\{p0}\MG\\{yellow})\V\\{number%
\_positive}(\\{p0}\MG\\{black})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"processcolored\ "});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{cyan});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{magenta});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{yellow});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{black});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_rgb\_model}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_positive}(\\{p0}\MG\\{red})\V\\{number\_positive}(\\{p0}%
\MG\\{green})\V\\{number\_positive}(\\{p0}\MG\\{blue})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"colored\ "});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{red});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{green});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{blue});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{503}\B\X498:Cases for printing graphical object node \PB{\|p}\X${}\mathrel+%
\E{}$\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"Filled\ pen\ stroke\ "});{}$\6
${}\\{mp\_print\_obj\_color}(\\{mp},\39\|p);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{':'}));{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_pr\_path}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_stroked\_node}) \|p));%
\6
\&{if} ${}(\\{mp\_dash\_p}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"dashed\ ("});{}$\6
\X504:Finish printing the dash pattern that \PB{\|p} refers to\X;\6
\4${}\}{}$\2\6
\\{mp\_print\_ln}(\\{mp});\6
\X500:Print join and cap types for stroked node \PB{\|p}\X;\6
${}\\{mp\_print}(\\{mp},\39\.{"\ with\ pen"});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p)${}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"???"}){}$;\C{ shouldn't happen }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_pr\_pen}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p));\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{504}Normally, the  \PB{\\{dash\_list}} field in an edge header is set to %
\PB{\\{null\_dash}}
when it is not known to define a suitable dash pattern.  This is disallowed
here because the \PB{\\{mp\_dash\_p}} field should never point to such an edge
header.
Note that memory is allocated for \PB{\\{start\_x}(\\{null\_dash})} and we are
free to
give it any convenient value.

\Y\B\4\X504:Finish printing the dash pattern that \PB{\|p} refers to\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_dash\_node} \\{ppd}${},{}$ \\{hhd};\7
${}\\{ok\_to\_dash}\K\\{pen\_is\_elliptical}{}$(\\{mp\_pen\_p}((\&{mp\_stroked%
\_node}) \|p));\6
\&{if} ${}(\R\\{ok\_to\_dash}){}$\1\5
\\{set\_number\_to\_unity}(\\{scf});\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{scf},\39{}$((\&{mp\_stroked\_node}) \|p)${}\MG\\{dash%
\_scale});{}$\2\6
${}\\{hhd}\K{}$(\&{mp\_dash\_node}) \\{mp\_dash\_p}(\|p);\6
${}\\{ppd}\K\\{dash\_list}(\\{hhd});{}$\6
\&{if} ${}((\\{ppd}\E\\{mp}\MG\\{null\_dash})\V\\{number\_negative}(\\{hhd}\MG%
\\{dash\_y})){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ ??"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{dashoff};\6
\&{mp\_number} \\{ret}${},{}$ \\{arg1};\7
\\{new\_number}(\\{ret});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{dashoff});\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{null\_dash}\MG\\{start\_x},\39%
\\{ppd}\MG\\{start\_x},\39\\{hhd}\MG\\{dash\_y});{}$\6
\&{while} ${}(\\{ppd}\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"on\ "});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{ppd}\MG\\{stop\_x},\39%
\\{ppd}\MG\\{start\_x});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{arg1},\39\\{scf});{}$\6
\\{print\_number}(\\{ret});\6
${}\\{mp\_print}(\\{mp},\39\.{"\ off\ "});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39{}$((\&{mp\_dash\_node}) %
\\{mp\_link}(\\{ppd}))${}\MG\\{start\_x},\39\\{ppd}\MG\\{stop\_x});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{arg1},\39\\{scf});{}$\6
\\{print\_number}(\\{ret});\6
${}\\{ppd}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{ppd});\6
\&{if} ${}(\\{ppd}\I\\{mp}\MG\\{null\_dash}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{")\ shifted\ "});{}$\6
${}\\{mp\_dash\_offset}(\\{mp},\39{\AND}\\{dashoff},\39\\{hhd});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{dashoff},\39\\{scf});{}$\6
\\{number\_negate}(\\{ret});\6
\\{print\_number}(\\{ret});\6
\\{free\_number}(\\{dashoff});\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{arg1});\6
\&{if} ${}(\R\\{ok\_to\_dash}\V\\{number\_zero}(\\{hhd}\MG\\{dash\_y})){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\ (this\ will\ be\ igno}\)\.{red)"});{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U503.\fi

\M{505}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_dash\_offset}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|x,\39{}$\&{mp\_dash\_node} \|h);\par
\fi

\M{506}\B\&{void} \\{mp\_dash\_offset}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|x,\39{}$\&{mp\_dash\_node} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{dash\_list}(\|h)\E\\{mp}\MG\\{null\_dash}\V\\{number\_negative}(%
\|h\MG\\{dash\_y})){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"dash0"});{}$\2\6
;\6
\&{if} ${}(\\{number\_zero}(\|h\MG\\{dash\_y})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\|x);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\|x,\39(\\{dash\_list}(\|h))\MG\\{start\_x});{}$\6
${}\\{number\_modulo}({*}\|x,\39\|h\MG\\{dash\_y});{}$\6
${}\\{number\_negate}({*}\|x);{}$\6
\&{if} ${}(\\{number\_negative}({*}\|x)){}$\1\5
${}\\{number\_add}({*}\|x,\39\|h\MG\\{dash\_y});{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{507}\B\X498:Cases for printing graphical object node \PB{\|p}\X${}\mathrel+%
\E{}$\6
\4\&{case} \\{mp\_text\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_text\_node} \\{p0}${}\K{}$(\&{mp\_text\_node}) \|p;\7
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{mp\_text\_p}(\|p));{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\\"\ infont\ \\""});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{font\_name}[\\{mp\_font\_n}(\|p)]);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_print\_obj\_color}(\\{mp},\39\|p);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"transformed\ "});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{tx});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{ty});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{txx});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{txy});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{tyx});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\\{print\_number}(\\{p0}\MG\\{tyy});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{508}\B\X498:Cases for printing graphical object node \PB{\|p}\X${}\mathrel+%
\E{}$\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"clipping\ path:"});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_pr\_path}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_clip\_node}) %
\|p));\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"stop\ clipping"});{}$\6
\&{break};\par
\fi

\M{509}\B\X498:Cases for printing graphical object node \PB{\|p}\X${}\mathrel+%
\E{}$\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"setbounds\ path:"});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_pr\_path}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_bounds\_node}) %
\|p));\6
\&{break};\6
\4\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
${}\\{mp\_print}(\\{mp},\39\.{"end\ of\ setbounds"});{}$\6
\&{break};\par
\fi

\M{510}To initialize the \PB{\\{dash\_list}} field in an edge header~\PB{\|h},
we need a
subroutine that scans an edge structure and tries to interpret it as a dash
pattern.  This can only be done when there are no filled regions or clipping
paths and all the pen strokes have the same color.  The first step is to let
$y_0$ be the initial $y$~coordinate of the first pen stroke.  Then we
implicitly
project all the pen stroke paths onto the line $y=y_0$ and require that there
be no retracing.  If the resulting paths cover a range of $x$~coordinates of
length $\Delta x$, we set \PB{\\{dash\_y}(\|h)} to the length of the dash
pattern by
finding the maximum of $\Delta x$ and the absolute value of~$y_0$.

\Y\B\&{static} \&{mp\_edge\_header\_node} \\{mp\_make\_dashes}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_edge\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\C{ returns \PB{\|h} or \PB{$\NULL$} }\1\6
\&{mp\_node} \|p;\C{ this scans the stroked nodes in the object list }\6
\&{mp\_node} \\{p0};\C{ if not \PB{$\NULL$} this points to the first stroked
node }\6
\&{mp\_knot} \\{pp}${},{}$ \\{qq}${},{}$ \\{rr};\C{ pointers into \PB{\\{mp%
\_path\_p}(\|p)} }\6
\&{mp\_dash\_node} \|d${},{}$ \\{dd};\C{ pointers used to create the dash list
}\6
\&{mp\_number} \\{y0};\7
\X521:Other local variables in \PB{\\{make\_dashes}}\X;\6
\&{if} ${}(\\{dash\_list}(\|h)\I\\{mp}\MG\\{null\_dash}){}$\1\5
\&{return} \|h;\2\6
\\{new\_number}(\\{y0});\C{ the initial $y$ coordinate }\6
${}\\{p0}\K\NULL;{}$\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\|h));{}$\6
\&{while} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_stroked\_node\_type}){}$\5
${}\{{}$\1\6
\X511:Compain that the edge structure contains a node of the wrong type and %
\PB{\&{goto} \\{not\_found}}\X;\6
\4${}\}{}$\2\6
${}\\{pp}\K\\{mp\_path\_p}{}$((\&{mp\_stroked\_node}) \|p);\6
\&{if} ${}(\\{p0}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{p0}\K\|p;{}$\6
${}\\{number\_clone}(\\{y0},\39\\{pp}\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\X514:Make \PB{\|d} point to a new dash node created from stroke \PB{\|p} and
path \PB{\\{pp}} or \PB{\&{goto} \\{not\_found}} if there is an error\X;\6
\X517:Insert \PB{\|d} into the dash list and \PB{\&{goto} \\{not\_found}} if
there is an error\X;\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{dash\_list}(\|h)\E\\{mp}\MG\\{null\_dash}){}$\1\5
\&{goto} \.{NOT\_FOUND};\C{ No error message }\2\6
\X520:Scan \PB{\\{dash\_list}(\|h)} and deal with any dashes that are
themselves dashed\X;\6
\X518:Set \PB{\\{dash\_y}(\|h)} and merge the first and last dashes if
necessary\X;\6
\\{free\_number}(\\{y0});\6
\&{return} \|h;\6
\4\.{NOT\_FOUND}:\5
\\{free\_number}(\\{y0});\6
\X519:Flush the dash list, recycle \PB{\|h} and return \PB{$\NULL$}\X;\6
\4${}\}{}$\2\par
\fi

\M{511}\B\X511:Compain that the edge structure contains a node of the wrong
type and \PB{\&{goto} \\{not\_found}}\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ say\ `dashe}\)\.{d\ p',\
picture\ p\ shou}\)\.{ld\ not\ contain\ any"},\39\.{"text,\ filled\ region}\)%
\.{s,\ or\ clipping\ paths}\)\.{.\ \ This\ time\ it\ did"},\39\.{"so\ I'll\
just\ make\ i}\)\.{t\ a\ solid\ line\ inste}\)\.{ad."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Picture\ is\ too\ comp}\)\.{licated\ to\
use\ as\ a\ }\)\.{dash\ pattern"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\par
\U510.\fi

\M{512}A similar error occurs when monotonicity fails.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_x\_retrace\_error}(\&{MP} \\{mp});\par
\fi

\M{513}\B\&{void} \\{mp\_x\_retrace\_error}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ say\ `dashe}\)\.{d\ p',\
every\ path\ in\ }\)\.{p\ should\ be\ monotone}\)\.{"},\39\.{"in\ x\ and\ there%
\ must}\)\.{\ be\ no\ overlapping.\ }\)\.{\ This\ failed"},\39\.{"so\ I'll\
just\ make\ i}\)\.{t\ a\ solid\ line\ inste}\)\.{ad."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Picture\ is\ too\ comp}\)\.{licated\ to\
use\ as\ a\ }\)\.{dash\ pattern"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{514}We stash \PB{\|p} in \PB{\\{dash\_info}(\|d)} if \PB{$\\{mp\_dash\_p}(%
\|p)\MRL{{<}{>}}\T{0}$} so that subsequent processing can
handle the case where the pen stroke \PB{\|p} is itself dashed.

\Y\B\4\D$\\{dash\_info}(\|A)$ \5
$((\&{mp\_dash\_node})(\|A))\MG{}$\\{dash\_info\_}\C{ in an edge header this
points to the first dash node }\par
\Y\B\4\X514:Make \PB{\|d} point to a new dash node created from stroke \PB{\|p}
and path \PB{\\{pp}} or \PB{\&{goto} \\{not\_found}} if there is an error\X${}%
\E{}$\6
\X516:Make sure \PB{\|p} and \PB{\\{p0}} are the same color and \PB{\&{goto} %
\\{not\_found}} if there is an error\X;\6
${}\\{rr}\K\\{pp};{}$\6
\&{if} ${}(\\{mp\_next\_knot}(\\{pp})\I\\{pp}){}$\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
${}\\{qq}\K\\{rr};{}$\6
${}\\{rr}\K\\{mp\_next\_knot}(\\{rr});{}$\6
\X515:Check for retracing between knots \PB{\\{qq}} and \PB{\\{rr}} and \PB{%
\&{goto} \\{not\_found}} if there is a problem\X;\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp\_right\_type}(\\{rr})\I\\{mp\_endpoint});{}$\6
\4${}\}{}$\2\6
${}\|d\K{}$(\&{mp\_dash\_node}) \\{mp\_get\_dash\_node}(\\{mp});\6
\&{if} ${}(\\{mp\_dash\_p}(\|p)\E\NULL){}$\1\5
${}\\{dash\_info}(\|d)\K\NULL;{}$\2\6
\&{else}\1\5
${}\\{dash\_info}(\|d)\K\|p;{}$\2\6
\&{if} ${}(\\{number\_less}(\\{pp}\MG\\{x\_coord},\39\\{rr}\MG\\{x\_coord})){}$%
\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d\MG\\{start\_x},\39\\{pp}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|d\MG\\{stop\_x},\39\\{rr}\MG\\{x\_coord});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d\MG\\{start\_x},\39\\{rr}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|d\MG\\{stop\_x},\39\\{pp}\MG\\{x\_coord});{}$\6
\4${}\}{}$\2\par
\U510.\fi

\M{515}We also need to check for the case where the segment from \PB{\\{qq}} to
\PB{\\{rr}} is
monotone in $x$ but is reversed relative to the path from \PB{\\{pp}} to \PB{%
\\{qq}}.

\Y\B\4\X515:Check for retracing between knots \PB{\\{qq}} and \PB{\\{rr}} and %
\PB{\&{goto} \\{not\_found}} if there is a problem\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{x0}${},{}$ \\{x1}${},{}$ \\{x2}${},{}$ \\{x3};\C{ $x$
coordinates of the segment from \PB{\\{qq}} to \PB{\\{rr}} }\7
\\{new\_number}(\\{x0});\6
\\{new\_number}(\\{x1});\6
\\{new\_number}(\\{x2});\6
\\{new\_number}(\\{x3});\6
${}\\{number\_clone}(\\{x0},\39\\{qq}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{x1},\39\\{qq}\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\\{x2},\39\\{rr}\MG\\{left\_x});{}$\6
${}\\{number\_clone}(\\{x3},\39\\{rr}\MG\\{x\_coord});{}$\6
\&{if} ${}(\\{number\_greater}(\\{x0},\39\\{x1})\V\\{number\_greater}(\\{x1},%
\39\\{x2})\V\\{number\_greater}(\\{x2},\39\\{x3})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\\{x0},\39\\{x1})\V\\{number\_less}(\\{x1},\39%
\\{x2})\V\\{number\_less}(\\{x2},\39\\{x3})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{a1}${},{}$ \\{a2}${},{}$ \\{a3}${},{}$ \\{a4};\6
\&{mp\_number} \\{test};\7
\\{new\_number}(\\{test});\6
\\{new\_number}(\\{a1});\6
\\{new\_number}(\\{a2});\6
\\{new\_number}(\\{a3});\6
\\{new\_number}(\\{a4});\6
${}\\{set\_number\_from\_substraction}(\\{a1},\39\\{x2},\39\\{x1});{}$\6
${}\\{set\_number\_from\_substraction}(\\{a2},\39\\{x2},\39\\{x1});{}$\6
${}\\{set\_number\_from\_substraction}(\\{a3},\39\\{x1},\39\\{x0});{}$\6
${}\\{set\_number\_from\_substraction}(\\{a4},\39\\{x3},\39\\{x2});{}$\6
${}\\{ab\_vs\_cd}(\\{test},\39\\{a1},\39\\{a2},\39\\{a3},\39\\{a4});{}$\6
\\{free\_number}(\\{a1});\6
\\{free\_number}(\\{a2});\6
\\{free\_number}(\\{a3});\6
\\{free\_number}(\\{a4});\6
\&{if} (\\{number\_positive}(\\{test}))\5
${}\{{}$\1\6
\\{mp\_x\_retrace\_error}(\\{mp});\6
\\{free\_number}(\\{x0});\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{x3});\6
\\{free\_number}(\\{test});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{test});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{pp}\MG\\{x\_coord},\39\\{x0})\V\\{number%
\_greater}(\\{x0},\39\\{x3})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\\{pp}\MG\\{x\_coord},\39\\{x0})\V\\{number\_less}(%
\\{x0},\39\\{x3})){}$\5
${}\{{}$\1\6
\\{mp\_x\_retrace\_error}(\\{mp});\6
\\{free\_number}(\\{x0});\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{x3});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{x0});\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{x3});\6
\4${}\}{}$\2\par
\U514.\fi

\M{516}\B\X516:Make sure \PB{\|p} and \PB{\\{p0}} are the same color and \PB{%
\&{goto} \\{not\_found}} if there is an error\X${}\E{}$\6
\&{if} ${}(\R\\{number\_equal}{}$(((\&{mp\_stroked\_node}) \|p)${}\MG\\{red},%
\39{}$((\&{mp\_stroked\_node}) \\{p0})${}\MG\\{red})\V\R\\{number\_equal}{}$(((%
\&{mp\_stroked\_node}) \|p)${}\MG\\{black},\39{}$((\&{mp\_stroked\_node}) %
\\{p0})${}\MG\\{black})\V\R\\{number\_equal}{}$(((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{green},\39{}$((\&{mp\_stroked\_node}) \\{p0})${}\MG\\{green})\V\R%
\\{number\_equal}{}$(((\&{mp\_stroked\_node}) \|p)${}\MG\\{blue},\39{}$((\&{mp%
\_stroked\_node}) \\{p0})${}\MG\\{blue})){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ say\ `dashe}\)\.{d\ p',\
everything\ in\ }\)\.{picture\ p\ should"},\39\.{"be\ the\ same\ color.\ }\)\.{%
\ I\ can\\'t\ handle\ you}\)\.{r\ color\ changes"},\39\.{"so\ I'll\ just\ make\
i}\)\.{t\ a\ solid\ line\ inste}\)\.{ad."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Picture\ is\ too\ comp}\)\.{licated\ to\
use\ as\ a\ }\)\.{dash\ pattern"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\par
\U514.\fi

\M{517}\B\X517:Insert \PB{\|d} into the dash list and \PB{\&{goto} \\{not%
\_found}} if there is an error\X${}\E{}$\6
$\\{number\_clone}(\\{mp}\MG\\{null\_dash}\MG\\{start\_x},\39\|d\MG\\{stop%
\_x});{}$\6
${}\\{dd}\K{}$(\&{mp\_dash\_node}) \|h;\C{ this makes \PB{$\\{mp\_link}(\\{dd})%
\K\\{dash\_list}(\|h)$} }\6
\&{while} (\\{number\_less}(((\&{mp\_dash\_node}) \\{mp\_link}(\\{dd}))${}\MG%
\\{start\_x},\39\|d\MG\\{stop\_x})){}$\1\5
${}\\{dd}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{dd});\2\6
\&{if} ${}(\\{dd}\I{}$(\&{mp\_dash\_node}) \|h)\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greater}(\\{dd}\MG\\{stop\_x},\39\|d\MG\\{start\_x})){}$\5
${}\{{}$\1\6
\\{mp\_x\_retrace\_error}(\\{mp});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|d)\K\\{mp\_link}(\\{dd});$ $\\{mp\_link}(\\{dd})\K{}$(\&{mp%
\_node}) \|d\par
\U510.\fi

\M{518}\B\X518:Set \PB{\\{dash\_y}(\|h)} and merge the first and last dashes if
necessary\X${}\E{}$\6
$\|d\K\\{dash\_list}(\|h);{}$\6
\&{while} ${}((\\{mp\_link}(\|d)\I{}$(\&{mp\_node}) \\{mp}${}\MG\\{null%
\_dash})){}$\1\5
${}\|d\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|d);\2\6
${}\\{dd}\K\\{dash\_list}(\|h);{}$\6
${}\\{set\_number\_from\_substraction}(\|h\MG\\{dash\_y},\39\|d\MG\\{stop\_x},%
\39\\{dd}\MG\\{start\_x});{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{absval};\7
\\{new\_number}(\\{absval});\6
${}\\{number\_clone}(\\{absval},\39\\{y0});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\|h\MG\\{dash\_y})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|h\MG\\{dash\_y},\39\\{absval});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|d\I\\{dd}){}$\5
${}\{{}$\1\6
${}\\{set\_dash\_list}(\|h,\39\\{mp\_link}(\\{dd}));{}$\6
${}\\{set\_number\_from\_addition}(\|d\MG\\{stop\_x},\39\\{dd}\MG\\{stop\_x},%
\39\|h\MG\\{dash\_y});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \\{dd}${},\39\\{dash\_node%
\_size});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absval});\6
\4${}\}{}$\2\par
\U510.\fi

\M{519}We get here when the argument is a NULL picture or when there is an
error.
Recovering from an error involves making \PB{\\{dash\_list}(\|h)} empty to
indicate
that \PB{\|h} is not known to be a valid dash pattern.  We also dereference %
\PB{\|h}
since it is not being used for the return value.

\Y\B\4\X519:Flush the dash list, recycle \PB{\|h} and return \PB{$\NULL$}\X${}%
\E{}$\6
$\\{mp\_flush\_dash\_list}(\\{mp},\39\|h);{}$\6
\\{delete\_edge\_ref}(\|h); \&{return} ${}\NULL{}$\par
\U510.\fi

\M{520}Having carefully saved the dashed stroked nodes in the
corresponding dash nodes, we must be prepared to break up these dashes into
smaller dashes.

\Y\B\4\X520:Scan \PB{\\{dash\_list}(\|h)} and deal with any dashes that are
themselves dashed\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{hsf};\C{ the dash pattern from \PB{\\{hh}} gets scaled by
this }\7
\\{new\_number}(\\{hsf});\6
${}\|d\K{}$(\&{mp\_dash\_node}) \|h;\C{ now \PB{$\\{mp\_link}(\|d)\K\\{dash%
\_list}(\|h)$} }\6
\&{while} ${}(\\{mp\_link}(\|d)\I{}$(\&{mp\_node}) \\{mp}${}\MG\\{null%
\_dash}){}$\5
${}\{{}$\1\6
${}\\{ds}\K\\{dash\_info}(\\{mp\_link}(\|d));{}$\6
\&{if} ${}(\\{ds}\E\NULL){}$\5
${}\{{}$\1\6
${}\|d\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|d);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{hh}\K{}$(\&{mp\_edge\_header\_node}) \\{mp\_dash\_p}(\\{ds});\6
${}\\{number\_clone}(\\{hsf},\39{}$((\&{mp\_stroked\_node}) \\{ds})${}\MG%
\\{dash\_scale});{}$\6
\&{if} ${}(\\{hh}\E\NULL){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"dash1"});{}$\2\6
;\C{ clang: dereference null pointer 'hh' }\6
\\{assert}(\\{hh});\6
\&{if} (\\{number\_zero}(((\&{mp\_dash\_node}) \\{hh})${}\MG\\{dash\_y})){}$\5
${}\{{}$\1\6
${}\|d\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|d);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{dash\_list}(\\{hh})\E\NULL){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"dash1"});{}$\2\6
;\6
\X522:Replace \PB{\\{mp\_link}(\|d)} by a dashed version as determined by edge
header \PB{\\{hh}} and scale factor \PB{\\{ds}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{hsf});\6
\4${}\}{}$\2\par
\U510.\fi

\M{521}\B\X521:Other local variables in \PB{\\{make\_dashes}}\X${}\E{}$\6
\&{mp\_dash\_node} \\{dln};\C{ \PB{\\{mp\_link}(\|d)} }\6
\&{mp\_edge\_header\_node} \\{hh};\C{ an edge header that tells how to break up
\PB{\\{dln}} }\6
\&{mp\_node} \\{ds};\C{ the stroked node from which \PB{\\{hh}} and \PB{%
\\{hsf}} are derived }\par
\U510.\fi

\M{522}\B\X522:Replace \PB{\\{mp\_link}(\|d)} by a dashed version as determined
by edge header \PB{\\{hh}} and scale factor \PB{\\{ds}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{xoff};\C{ added to $x$ values in \PB{\\{dash\_list}(\\{hh})}
to match \PB{\\{dln}} }\6
\&{mp\_number} \\{dashoff};\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_number}(\\{r1});\6
\\{new\_number}(\\{r2});\6
${}\\{dln}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|d);\6
${}\\{dd}\K\\{dash\_list}(\\{hh}){}$;\C{ clang: dereference null pointer 'dd' }%
\6
\\{assert}(\\{dd});\6
\\{new\_number}(\\{xoff});\6
\\{new\_number}(\\{dashoff});\6
${}\\{mp\_dash\_offset}(\\{mp},\39{\AND}\\{dashoff},\39{}$(\&{mp\_dash\_node}) %
\\{hh});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{start\_x});{}$\6
${}\\{take\_scaled}(\\{r2},\39\\{hsf},\39\\{dashoff});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_substraction}(\\{xoff},\39\\{dln}\MG\\{start\_x},\39%
\\{r1});{}$\6
\\{free\_number}(\\{dashoff});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{start\_x});{}$\6
${}\\{take\_scaled}(\\{r2},\39\\{hsf},\39\\{hh}\MG\\{dash\_y});{}$\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{null\_dash}\MG\\{start\_x},\39%
\\{r1},\39\\{r2});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{null\_dash}\MG\\{stop\_x},\39\\{mp}\MG\\{null%
\_dash}\MG\\{start\_x});{}$\6
\X523:Advance \PB{\\{dd}} until finding the first dash that overlaps \PB{%
\\{dln}} when offset by \PB{\\{xoff}}\X;\6
\&{while} ${}(\\{number\_lessequal}(\\{dln}\MG\\{start\_x},\39\\{dln}\MG\\{stop%
\_x})){}$\5
${}\{{}$\1\6
\X524:If \PB{\\{dd}} has `fallen off the end', back up to the beginning and fix
\PB{\\{xoff}}\X;\6
\X525:Insert a dash between \PB{\|d} and \PB{\\{dln}} for the overlap with the
offset version of \PB{\\{dd}}\X;\6
${}\\{dd}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{dd});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{start\_x});{}$\6
${}\\{set\_number\_from\_addition}(\\{dln}\MG\\{start\_x},\39\\{xoff},\39%
\\{r1});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{xoff});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
${}\\{mp\_link}(\|d)\K\\{mp\_link}(\\{dln});{}$\6
${}\\{mp\_free\_node}(\\{mp},\39{}$(\&{mp\_node}) \\{dln}${},\39\\{dash\_node%
\_size});{}$\6
\4${}\}{}$\2\par
\U520.\fi

\M{523}The name of this module is a bit of a lie because we just find the
first \PB{\\{dd}} where \PB{$\\{take\_scaled}(\\{hsf},\\{stop\_x}(\\{dd}))$} is
large enough to make an
overlap possible.  It could be that the unoffset version of dash \PB{\\{dln}}
falls
in the gap between \PB{\\{dd}} and its predecessor.

\Y\B\4\X523:Advance \PB{\\{dd}} until finding the first dash that overlaps \PB{%
\\{dln}} when offset by \PB{\\{xoff}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{stop\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{xoff});{}$\6
\&{while} ${}(\\{number\_less}(\\{r1},\39\\{dln}\MG\\{start\_x})){}$\5
${}\{{}$\1\6
${}\\{dd}\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\\{dd});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{stop\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{xoff});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\par
\U522.\fi

\M{524}\B\X524:If \PB{\\{dd}} has `fallen off the end', back up to the
beginning and fix \PB{\\{xoff}}\X${}\E{}$\6
\&{if} ${}(\\{dd}\E\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{dd}\K\\{dash\_list}(\\{hh});{}$\6
${}\\{take\_scaled}(\\{ret},\39\\{hsf},\39\\{hh}\MG\\{dash\_y});{}$\6
${}\\{number\_add}(\\{xoff},\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\par
\U522.\fi

\M{525}At this point we already know that \PB{$\\{start\_x}(\\{dln})\Z\\{xoff}+%
\\{take\_scaled}(\\{hsf},\\{stop\_x}(\\{dd}))$}.

\Y\B\4\X525:Insert a dash between \PB{\|d} and \PB{\\{dln}} for the overlap
with the offset version of \PB{\\{dd}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{start\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{xoff});{}$\6
\&{if} ${}(\\{number\_lessequal}(\\{r1},\39\\{dln}\MG\\{stop\_x})){}$\5
${}\{{}$\1\6
${}\\{mp\_link}(\|d)\K{}$(\&{mp\_node}) \\{mp\_get\_dash\_node}(\\{mp});\6
${}\|d\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|d);\6
${}\\{mp\_link}(\|d)\K{}$(\&{mp\_node}) \\{dln};\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{start\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{xoff});{}$\6
\&{if} ${}(\\{number\_greater}(\\{dln}\MG\\{start\_x},\39\\{r1})){}$\1\5
${}\\{number\_clone}(\|d\MG\\{start\_x},\39\\{dln}\MG\\{start\_x});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d\MG\\{start\_x},\39\\{r1});{}$\6
\4${}\}{}$\2\6
${}\\{take\_scaled}(\\{r1},\39\\{hsf},\39\\{dd}\MG\\{stop\_x});{}$\6
${}\\{number\_add}(\\{r1},\39\\{xoff});{}$\6
\&{if} ${}(\\{number\_less}(\\{dln}\MG\\{stop\_x},\39\\{r1})){}$\1\5
${}\\{number\_clone}(\|d\MG\\{stop\_x},\39\\{dln}\MG\\{stop\_x});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d\MG\\{stop\_x},\39\\{r1});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\par
\U522.\fi

\M{526}The next major task is to update the bounding box information in an edge
header~\PB{\|h}. This is done via a procedure \PB{\\{adjust\_bbox}} that
enlarges an edge
header's bounding box to accommodate the box computed by \PB{\\{path\_bbox}} or
\PB{\\{pen\_bbox}}. (This is stored in global variables \PB{\\{minx}}, \PB{%
\\{miny}}, \PB{\\{maxx}}, and
\PB{\\{maxy}}.)

\Y\B\&{static} \&{void} \\{mp\_adjust\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{number\_less}(\\{mp\_minx},\39\|h\MG\\{minx})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{minx},\39\\{mp\_minx});{}$\2\6
\&{if} ${}(\\{number\_less}(\\{mp\_miny},\39\|h\MG\\{miny})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{miny},\39\\{mp\_miny});{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{mp\_maxx},\39\|h\MG\\{maxx})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxx},\39\\{mp\_maxx});{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{mp\_maxy},\39\|h\MG\\{maxy})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxy},\39\\{mp\_maxy});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{527}Here is a special routine for updating the bounding box information in
edge header~\PB{\|h} to account for the squared-off ends of a non-cyclic path~%
\PB{\|p}
that is to be stroked with the pen~\PB{\\{pp}}.

\Y\B\&{static} \&{void} \\{mp\_box\_ends}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_knot} \\{pp}${},\39{}$\&{mp\_edge\_header\_node} \|h)\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ a knot node adjacent to knot \PB{\|p} }\7
${}\\{mp\_fraction}\\{dx},\39\\{dy}{}$;\C{ a unit vector in the direction out
of the path at~\PB{\|p} }\7
\&{mp\_number} \|d;\C{ a factor for adjusting the length of \PB{$(\\{dx},%
\\{dy})$} }\6
\&{mp\_number} \|z;\C{ a coordinate being tested against the bounding box }\6
\&{mp\_number} \\{xx}${},{}$ \\{yy};\C{ the extreme pen vertex in the \PB{$(%
\\{dx},\\{dy})$} direction }\6
\&{integer} \|i;\C{ a loop counter }\7
\\{new\_fraction}(\\{dx});\6
\\{new\_fraction}(\\{dy});\6
\\{new\_number}(\\{xx});\6
\\{new\_number}(\\{yy});\6
\\{new\_number}(\|z);\6
\\{new\_number}(\|d);\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\I\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\X528:Make \PB{$(\\{dx},\\{dy})$} the final direction for the path segment from
\PB{\|q} to~\PB{\|p}; set~\PB{\|d}\X;\6
${}\\{pyth\_add}(\|d,\39\\{dx},\39\\{dy});{}$\6
\&{if} (\\{number\_positive}(\|d))\5
${}\{{}$\1\6
\X529:Normalize the direction \PB{$(\\{dx},\\{dy})$} and find the pen offset %
\PB{$(\\{xx},\\{yy})$}\X;\6
\&{for} ${}(\|i\K\T{1};{}$ ${}\|i\Z\T{2};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
\X530:Use \PB{$(\\{dx},\\{dy})$} to generate a vertex of the square end cap and
update the bounding box to accommodate it\X;\6
\\{number\_negate}(\\{dx});\6
\\{number\_negate}(\\{dy});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X531:Advance \PB{\|p} to the end of the path and make \PB{\|q} the previous
knot\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4\.{DONE}:\5
\\{free\_number}(\\{dx});\6
\\{free\_number}(\\{dy});\6
\\{free\_number}(\\{xx});\6
\\{free\_number}(\\{yy});\6
\\{free\_number}(\|z);\6
\\{free\_number}(\|d);\6
\4${}\}{}$\2\par
\fi

\M{528}\B\X528:Make \PB{$(\\{dx},\\{dy})$} the final direction for the path
segment from \PB{\|q} to~\PB{\|p}; set~\PB{\|d}\X${}\E{}$\6
\&{if} ${}(\|q\E\\{mp\_next\_knot}(\|p)){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|p\MG\\{x\_coord},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|p\MG\\{y\_coord},\39\|p\MG%
\\{right\_y});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dx})\W\\{number\_zero}(\\{dy})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|p\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|p\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|p\MG\\{x\_coord},\39\|p\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|p\MG\\{y\_coord},\39\|p\MG%
\\{left\_y});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dx})\W\\{number\_zero}(\\{dy})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|p\MG\\{x\_coord},\39\|q\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|p\MG\\{y\_coord},\39\|q\MG%
\\{right\_y});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_substraction}(\\{dx},\39\|p\MG\\{x\_coord},\39\|q\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dy},\39\|p\MG\\{y\_coord},\39\|q\MG%
\\{y\_coord}){}$;\par
\U527.\fi

\M{529}\B\X529:Normalize the direction \PB{$(\\{dx},\\{dy})$} and find the pen
offset \PB{$(\\{xx},\\{yy})$}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \|r;\7
\\{new\_fraction}(\|r);\6
\\{new\_number}(\\{arg1});\6
${}\\{make\_fraction}(\|r,\39\\{dx},\39\|d);{}$\6
${}\\{number\_clone}(\\{dx},\39\|r);{}$\6
${}\\{make\_fraction}(\|r,\39\\{dy},\39\|d);{}$\6
${}\\{number\_clone}(\\{dy},\39\|r);{}$\6
\\{free\_number}(\|r);\6
${}\\{number\_clone}(\\{arg1},\39\\{dy});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{mp\_find\_offset}(\\{mp},\39\\{arg1},\39\\{dx},\39\\{pp});{}$\6
\\{free\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{xx},\39\\{mp}\MG\\{cur\_x});{}$\6
${}\\{number\_clone}(\\{yy},\39\\{mp}\MG\\{cur\_y});{}$\6
\4${}\}{}$\2\par
\U527.\fi

\M{530}\B\X530:Use \PB{$(\\{dx},\\{dy})$} to generate a vertex of the square
end cap and update the bounding box to accommodate it\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2}${},{}$ \\{arg1};\7
\\{new\_number}(\\{arg1});\6
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{mp\_find\_offset}(\\{mp},\39\\{dx},\39\\{dy},\39\\{pp});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{xx},\39\\{mp}\MG\\{cur%
\_x});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{dx});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{yy},\39\\{mp}\MG\\{cur%
\_y});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{arg1},\39\\{dy});{}$\6
${}\\{set\_number\_from\_addition}(\|d,\39\\{r1},\39\\{r2});{}$\6
\&{if} ${}((\\{number\_negative}(\|d)\W(\|i\E\T{1}))\V(\\{number\_positive}(%
\|d)\W(\|i\E\T{2}))){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"box\_ends"});{}$\2\6
;\6
${}\\{take\_fraction}(\\{r1},\39\|d,\39\\{dx});{}$\6
${}\\{set\_number\_from\_addition}(\|z,\39\|p\MG\\{x\_coord},\39\\{mp}\MG\\{cur%
\_x});{}$\6
${}\\{number\_add}(\|z,\39\\{r1});{}$\6
\&{if} ${}(\\{number\_less}(\|z,\39\|h\MG\\{minx})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{minx},\39\|z);{}$\2\6
\&{if} ${}(\\{number\_greater}(\|z,\39\|h\MG\\{maxx})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxx},\39\|z);{}$\2\6
${}\\{take\_fraction}(\\{r1},\39\|d,\39\\{dy});{}$\6
${}\\{set\_number\_from\_addition}(\|z,\39\|p\MG\\{y\_coord},\39\\{mp}\MG\\{cur%
\_y});{}$\6
${}\\{number\_add}(\|z,\39\\{r1});{}$\6
\&{if} ${}(\\{number\_less}(\|z,\39\|h\MG\\{miny})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{miny},\39\|z);{}$\2\6
\&{if} ${}(\\{number\_greater}(\|z,\39\|h\MG\\{maxy})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxy},\39\|z);{}$\2\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\par
\U527.\fi

\M{531}\B\X531:Advance \PB{\|p} to the end of the path and make \PB{\|q} the
previous knot\X${}\E{}$\6
\&{do} \6
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp\_right\_type}(\|p)\I\\{mp\_endpoint}{}$)\par
\U527.\fi

\M{532}The major difficulty in finding the bounding box of an edge structure is
the
effect of clipping paths.  We treat them conservatively by only clipping to the
clipping path's bounding box, but this still
requires recursive calls to \PB{\\{set\_bbox}} in order to find the bounding
box of
the objects to be clipped.  Such calls are distinguished by the fact that the
boolean parameter \PB{\\{top\_level}} is false.

\Y\B\&{void} \\{mp\_set\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge\_header%
\_node} \|h${},\39{}$\&{boolean} \\{top\_level})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ a graphical object being considered }\6
\&{integer} \\{lev};\C{ nesting level for \PB{\&{mp\_start\_bounds\_node}}
nodes }\C{ Wipe out any existing bounding box information if \PB{\\{bbtype}(%
\|h)} is      incompatible with \PB{\\{internal}[\\{mp\_true\_corners}]} }\7
\&{switch} ${}(\|h\MG\\{bbtype}){}$\5
${}\{{}$\1\6
\4\&{case} \\{no\_bounds}:\5
\&{break};\6
\4\&{case} \\{bounds\_set}:\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_true\_corners})))\1\5
${}\\{mp\_init\_bbox}(\\{mp},\39\|h);{}$\2\6
\&{break};\6
\4\&{case} \\{bounds\_unset}:\6
\&{if} (\\{number\_nonpositive}(\\{internal\_value}(\\{mp\_true\_corners})))\1\5
${}\\{mp\_init\_bbox}(\\{mp},\39\|h);{}$\2\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\&{while} ${}(\\{mp\_link}(\\{bblast}(\|h))\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\\{bblast}(\|h));{}$\6
${}\\{bblast}(\|h)\K\|p;{}$\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\6
\&{if} (\\{top\_level})\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"bbox"});{}$\2\6
\&{else}\1\5
\&{return};\2\6
;\6
\&{break};\6
\X534:Other cases for updating the bounding box based on the type of object %
\PB{\|p}\X;\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{top\_level}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"bbox"});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{533}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_bbox}(\&{MP} \\{mp}${},\39{}$\&{mp\_edge%
\_header\_node} \|h${},\39{}$\&{boolean} \\{top\_level});\par
\fi

\M{534}\B\X534:Other cases for updating the bounding box based on the type of
object \PB{\|p}\X${}\E{}$\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\\{mp\_path\_bbox}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_fill\_node}) \|p));\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|p)${}\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{x0a}${},{}$ \\{y0a}${},{}$ \\{x1a}${},{}$ \\{y1a};\7
\\{new\_number}(\\{x0a});\6
\\{new\_number}(\\{y0a});\6
\\{new\_number}(\\{x1a});\6
\\{new\_number}(\\{y1a});\6
${}\\{number\_clone}(\\{x0a},\39\\{mp\_minx});{}$\6
${}\\{number\_clone}(\\{y0a},\39\\{mp\_miny});{}$\6
${}\\{number\_clone}(\\{x1a},\39\\{mp\_maxx});{}$\6
${}\\{number\_clone}(\\{y1a},\39\\{mp\_maxy});{}$\6
${}\\{mp\_pen\_bbox}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|p));\6
${}\\{number\_add}(\\{mp\_minx},\39\\{x0a});{}$\6
${}\\{number\_add}(\\{mp\_miny},\39\\{y0a});{}$\6
${}\\{number\_add}(\\{mp\_maxx},\39\\{x1a});{}$\6
${}\\{number\_add}(\\{mp\_maxy},\39\\{y1a});{}$\6
\\{free\_number}(\\{x0a});\6
\\{free\_number}(\\{y0a});\6
\\{free\_number}(\\{x1a});\6
\\{free\_number}(\\{y1a});\6
\4${}\}{}$\2\6
${}\\{mp\_adjust\_bbox}(\\{mp},\39\|h);{}$\6
\&{break};\par
\As535, 537, 538\ETs539.
\U532.\fi

\M{535}\B\X534:Other cases for updating the bounding box based on the type of
object \PB{\|p}\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_true\_corners})))\5
${}\{{}$\1\6
${}\|h\MG\\{bbtype}\K\\{bounds\_unset};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|h\MG\\{bbtype}\K\\{bounds\_set};{}$\6
${}\\{mp\_path\_bbox}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_bounds%
\_node}) \|p));\6
${}\\{mp\_adjust\_bbox}(\\{mp},\39\|h);{}$\6
\X536:Scan to the matching \PB{\&{mp\_stop\_bounds\_node}} node and update \PB{%
\|p} and \PB{\\{bblast}(\|h)}\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_stop\_bounds\_node\_type}:\6
\&{if} (\\{number\_nonpositive}(\\{internal\_value}(\\{mp\_true\_corners})))\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"bbox2"});{}$\2\6
;\6
\&{break};\par
\fi

\M{536}\B\X536:Scan to the matching \PB{\&{mp\_stop\_bounds\_node}} node and
update \PB{\|p} and \PB{\\{bblast}(\|h)}\X${}\E{}$\6
$\\{lev}\K\T{1};{}$\6
\&{while} ${}(\\{lev}\I\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_link}(\|p)\E\NULL){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"bbox2"});{}$\2\6
;\C{ clang: dereference null pointer }\6
\\{assert}(\\{mp\_link}(\|p));\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_start\_bounds\_node\_type}){}$\1\5
\\{incr}(\\{lev});\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_stop\_bounds\_node\_type}){}$\1\5
\\{decr}(\\{lev});\2\6
\4${}\}{}$\2\6
$\\{bblast}(\|h)\K{}$\|p\par
\U535.\fi

\M{537}It saves a lot of grief here to be slightly conservative and not account
for
omitted parts of dashed lines.  We also don't worry about the material omitted
when using butt end caps.  The basic computation is for round end caps and
\PB{\\{box\_ends}} augments it for square end caps.

\Y\B\4\X534:Other cases for updating the bounding box based on the type of
object \PB{\|p}\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\\{mp\_path\_bbox}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_stroked\_node}) %
\|p));\6
${}\{{}$\1\6
\&{mp\_number} \\{x0a}${},{}$ \\{y0a}${},{}$ \\{x1a}${},{}$ \\{y1a};\7
\\{new\_number}(\\{x0a});\6
\\{new\_number}(\\{y0a});\6
\\{new\_number}(\\{x1a});\6
\\{new\_number}(\\{y1a});\6
${}\\{number\_clone}(\\{x0a},\39\\{mp\_minx});{}$\6
${}\\{number\_clone}(\\{y0a},\39\\{mp\_miny});{}$\6
${}\\{number\_clone}(\\{x1a},\39\\{mp\_maxx});{}$\6
${}\\{number\_clone}(\\{y1a},\39\\{mp\_maxy});{}$\6
${}\\{mp\_pen\_bbox}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p));%
\6
${}\\{number\_add}(\\{mp\_minx},\39\\{x0a});{}$\6
${}\\{number\_add}(\\{mp\_miny},\39\\{y0a});{}$\6
${}\\{number\_add}(\\{mp\_maxx},\39\\{x1a});{}$\6
${}\\{number\_add}(\\{mp\_maxy},\39\\{y1a});{}$\6
\\{free\_number}(\\{x0a});\6
\\{free\_number}(\\{y0a});\6
\\{free\_number}(\\{x1a});\6
\\{free\_number}(\\{y1a});\6
\4${}\}{}$\2\6
${}\\{mp\_adjust\_bbox}(\\{mp},\39\|h);{}$\6
\&{if} ((\\{mp\_left\_type}(\\{mp\_path\_p}((\&{mp\_stroked\_node}) \|p))${}\E%
\\{mp\_endpoint})\W{}$(((\&{mp\_stroked\_node}) \|p)${}\MG\\{lcap}\E\T{2})){}$%
\1\5
${}\\{mp\_box\_ends}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_stroked\_node}) %
\|p)${},\39{}$\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p)${},\39\|h);{}$\2\6
\&{break};\par
\fi

\M{538}The height width and depth information stored in a text node determines
a
rectangle that needs to be transformed according to the transformation
parameters stored in the text node.

\Y\B\4\X534:Other cases for updating the bounding box based on the type of
object \PB{\|p}\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_text\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_number} \\{x0a}${},{}$ \\{y0a}${},{}$ \\{x1a}${},{}$ \\{y1a}${},{}$ %
\\{arg1};\6
\&{mp\_text\_node} \\{p0}${}\K{}$(\&{mp\_text\_node}) \|p;\7
\\{new\_number}(\\{x0a});\6
\\{new\_number}(\\{x1a});\6
\\{new\_number}(\\{y0a});\6
\\{new\_number}(\\{y1a});\6
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{p0}\MG\\{depth});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{take\_scaled}(\\{x1a},\39\\{p0}\MG\\{txx},\39\\{p0}\MG\\{width});{}$\6
${}\\{take\_scaled}(\\{y0a},\39\\{p0}\MG\\{txy},\39\\{arg1});{}$\6
${}\\{take\_scaled}(\\{y1a},\39\\{p0}\MG\\{txy},\39\\{p0}\MG\\{height});{}$\6
${}\\{number\_clone}(\\{mp\_minx},\39\\{p0}\MG\\{tx});{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{mp\_minx});{}$\6
\&{if} ${}(\\{number\_less}(\\{y0a},\39\\{y1a})){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{mp\_minx},\39\\{y0a});{}$\6
${}\\{number\_add}(\\{mp\_maxx},\39\\{y1a});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_add}(\\{mp\_minx},\39\\{y1a});{}$\6
${}\\{number\_add}(\\{mp\_maxx},\39\\{y0a});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_negative}(\\{x1a}))\1\5
${}\\{number\_add}(\\{mp\_minx},\39\\{x1a});{}$\2\6
\&{else}\1\5
${}\\{number\_add}(\\{mp\_maxx},\39\\{x1a});{}$\2\6
${}\\{take\_scaled}(\\{x1a},\39\\{p0}\MG\\{tyx},\39\\{p0}\MG\\{width});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{p0}\MG\\{depth});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{take\_scaled}(\\{y0a},\39\\{p0}\MG\\{tyy},\39\\{arg1});{}$\6
${}\\{take\_scaled}(\\{y1a},\39\\{p0}\MG\\{tyy},\39\\{p0}\MG\\{height});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\\{p0}\MG\\{ty});{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{mp\_miny});{}$\6
\&{if} ${}(\\{number\_less}(\\{y0a},\39\\{y1a})){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{mp\_miny},\39\\{y0a});{}$\6
${}\\{number\_add}(\\{mp\_maxy},\39\\{y1a});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_add}(\\{mp\_miny},\39\\{y1a});{}$\6
${}\\{number\_add}(\\{mp\_maxy},\39\\{y0a});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_negative}(\\{x1a}))\1\5
${}\\{number\_add}(\\{mp\_miny},\39\\{x1a});{}$\2\6
\&{else}\1\5
${}\\{number\_add}(\\{mp\_maxy},\39\\{x1a});{}$\2\6
${}\\{mp\_adjust\_bbox}(\\{mp},\39\|h);{}$\6
\\{free\_number}(\\{x0a});\6
\\{free\_number}(\\{y0a});\6
\\{free\_number}(\\{x1a});\6
\\{free\_number}(\\{y1a});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{539}This case involves a recursive call that advances \PB{\\{bblast}(\|h)}
to the node of
type \PB{\&{mp\_stop\_clip\_node}} that matches \PB{\|p}.

\Y\B\4\X534:Other cases for updating the bounding box based on the type of
object \PB{\|p}\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_number} \\{sminx}${},{}$ \\{sminy}${},{}$ \\{smaxx}${},{}$ \\{smaxy};\C{
for saving the bounding box during recursive calls }\6
\&{mp\_number} \\{x0a}${},{}$ \\{y0a}${},{}$ \\{x1a}${},{}$ \\{y1a};\7
\\{new\_number}(\\{x0a});\6
\\{new\_number}(\\{y0a});\6
\\{new\_number}(\\{x1a});\6
\\{new\_number}(\\{y1a});\6
\\{new\_number}(\\{sminx});\6
\\{new\_number}(\\{sminy});\6
\\{new\_number}(\\{smaxx});\6
\\{new\_number}(\\{smaxy});\6
${}\\{mp\_path\_bbox}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_clip\_node}) %
\|p));\6
${}\\{number\_clone}(\\{x0a},\39\\{mp\_minx});{}$\6
${}\\{number\_clone}(\\{y0a},\39\\{mp\_miny});{}$\6
${}\\{number\_clone}(\\{x1a},\39\\{mp\_maxx});{}$\6
${}\\{number\_clone}(\\{y1a},\39\\{mp\_maxy});{}$\6
${}\\{number\_clone}(\\{sminx},\39\|h\MG\\{minx});{}$\6
${}\\{number\_clone}(\\{sminy},\39\|h\MG\\{miny});{}$\6
${}\\{number\_clone}(\\{smaxx},\39\|h\MG\\{maxx});{}$\6
${}\\{number\_clone}(\\{smaxy},\39\|h\MG\\{maxy});{}$\6
\X540:Reinitialize the bounding box in header \PB{\|h} and call \PB{\\{set%
\_bbox}} recursively starting at \PB{\\{mp\_link}(\|p)}\X;\6
\X541:Clip the bounding box in \PB{\|h} to the rectangle given by \PB{\\{x0a}},
\PB{\\{x1a}}, \PB{\\{y0a}}, \PB{\\{y1a}}\X;\6
${}\\{number\_clone}(\\{mp\_minx},\39\\{sminx});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\\{sminy});{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{smaxx});{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{smaxy});{}$\6
${}\\{mp\_adjust\_bbox}(\\{mp},\39\|h);{}$\6
\\{free\_number}(\\{sminx});\6
\\{free\_number}(\\{sminy});\6
\\{free\_number}(\\{smaxx});\6
\\{free\_number}(\\{smaxy});\6
\\{free\_number}(\\{x0a});\6
\\{free\_number}(\\{y0a});\6
\\{free\_number}(\\{x1a});\6
\\{free\_number}(\\{y1a});\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{540}\B\X540:Reinitialize the bounding box in header \PB{\|h} and call \PB{%
\\{set\_bbox}} recursively starting at \PB{\\{mp\_link}(\|p)}\X${}\E{}$\6
$\\{set\_number\_to\_inf}(\|h\MG\\{minx});{}$\6
${}\\{set\_number\_to\_inf}(\|h\MG\\{miny});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|h\MG\\{maxx});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|h\MG\\{maxy});$ $\\{mp\_set\_bbox}(\\{mp},%
\39\|h,\39\\{false}{}$)\par
\U539.\fi

\M{541}\B\X541:Clip the bounding box in \PB{\|h} to the rectangle given by \PB{%
\\{x0a}}, \PB{\\{x1a}}, \PB{\\{y0a}}, \PB{\\{y1a}}\X${}\E{}$\6
\&{if} ${}(\\{number\_less}(\|h\MG\\{minx},\39\\{x0a})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{minx},\39\\{x0a});{}$\2\6
\&{if} ${}(\\{number\_less}(\|h\MG\\{miny},\39\\{y0a})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{miny},\39\\{y0a});{}$\2\6
\&{if} ${}(\\{number\_greater}(\|h\MG\\{maxx},\39\\{x1a})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxx},\39\\{x1a});{}$\2\6
\&{if} ${}(\\{number\_greater}(\|h\MG\\{maxy},\39\\{y1a})){}$\1\5
${}\\{number\_clone}(\|h\MG\\{maxy},\39\\{y1a}){}$;\2\par
\U539.\fi

\N{1}{542}Finding an envelope.
When \MP\ has a path and a polygonal pen, it needs to express the desired
shape in terms of things \ps\ can understand.  The present task is to compute
a new path that describes the region to be filled.  It is convenient to
define this as a two step process where the first step is determining what
offset to use for each segment of the path.

\fi

\M{543}Given a pointer \PB{\|c} to a cyclic path,
and a pointer~\PB{\|h} to the first knot of a pen polygon,
the \PB{\\{offset\_prep}} routine changes the path into cubics that are
associated with particular pen offsets. Thus if the cubic between \PB{\|p}
and~\PB{\|q} is associated with the \PB{\|k}th offset and the cubic between %
\PB{\|q} and~\PB{\|r}
has offset \PB{\|l} then \PB{$\\{mp\_info}(\|q)\K\\{zero\_off}+\|l-\|k$}. (The
constant \PB{\\{zero\_off}} is added
to because \PB{$\|l-\|k$} could be negative.)

After overwriting the type information with offset differences, we no longer
have a true path so we refer to the knot list returned by \PB{\\{offset\_prep}}
as an
``envelope spec.''
Since an envelope spec only determines relative changes in pen offsets,
\PB{\\{offset\_prep}} sets a global variable \PB{\\{spec\_offset}} to the
relative change from
\PB{\|h} to the first offset.

\Y\B\4\D$\\{zero\_off}$ \5
\T{16384}\C{ added to offset changes to make them positive }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{spec\_offset};\C{ number of pen edges between \PB{\|h} and the
initial offset }\par
\fi

\M{544}\B\&{static} \&{mp\_knot} \\{mp\_offset\_prep}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|c${},\39{}$\&{mp\_knot} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|n;\C{ the number of vertices in the pen polygon }\6
\&{mp\_knot} \\{c0}${},{}$ \|p${},{}$ \|q${},{}$ \\{q0}${},{}$ \|r${},{}$ %
\|w${},{}$ \\{ww};\C{ for list manipulation }\6
\&{int} \\{k\_needed};\C{ amount to be added to \PB{\\{mp\_info}(\|p)} when it
is computed }\6
\&{mp\_knot} \\{w0};\C{ a pointer to pen offset to use just before \PB{\|p} }\6
\&{mp\_number} \\{dxin}${},{}$ \\{dyin};\C{ the direction into knot \PB{\|p} }\6
\&{int} \\{turn\_amt};\C{ change in pen offsets for the current cubic }\6
\&{mp\_number} \\{max\_coef};\C{ used while scaling }\6
\&{mp\_number} \\{ss};\7
\X558:Other local variables for \PB{\\{offset\_prep}}\X;\6
\\{new\_number}(\\{max\_coef});\6
\\{new\_number}(\\{dxin});\6
\\{new\_number}(\\{dyin});\6
\\{new\_number}(\\{dx0});\6
\\{new\_number}(\\{dy0});\6
\\{new\_number}(\\{x0});\6
\\{new\_number}(\\{y0});\6
\\{new\_number}(\\{x1});\6
\\{new\_number}(\\{y1});\6
\\{new\_number}(\\{x2});\6
\\{new\_number}(\\{y2});\6
\\{new\_number}(\\{du});\6
\\{new\_number}(\\{dv});\6
\\{new\_number}(\\{dx});\6
\\{new\_number}(\\{dy});\6
\\{new\_number}(\\{x0a});\6
\\{new\_number}(\\{y0a});\6
\\{new\_number}(\\{x1a});\6
\\{new\_number}(\\{y1a});\6
\\{new\_number}(\\{x2a});\6
\\{new\_number}(\\{y2a});\6
\\{new\_number}(\\{t0});\6
\\{new\_number}(\\{t1});\6
\\{new\_number}(\\{t2});\6
\\{new\_number}(\\{u0});\6
\\{new\_number}(\\{u1});\6
\\{new\_number}(\\{v0});\6
\\{new\_number}(\\{v1});\6
\\{new\_fraction}(\\{ss});\6
\\{new\_fraction}(\|s);\6
\\{new\_fraction}(\|t);\6
\X547:Initialize the pen size~\PB{\|n}\X;\6
\X548:Initialize the incoming direction and pen offset at \PB{\|c}\X;\6
${}\|p\K\|c;{}$\6
${}\\{c0}\K\|c;{}$\6
${}\\{k\_needed}\K\T{0};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\X555:Split the cubic between \PB{\|p} and \PB{\|q}, if necessary, into cubics
associated with single offsets, after which \PB{\|q} should point to the end of
the final such cubic\X;\6
\4\.{NOT\_FOUND}:\5
\X549:Advance \PB{\|p} to node \PB{\|q}, removing any ``dead'' cubics that
might have been introduced by the splitting process\X;\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|c);{}$\6
\X569:Fix the offset change in \PB{\\{mp\_knot\_info}(\|c)} and set \PB{\|c} to
the return value of \PB{\\{offset\_prep}}\X;\6
\\{free\_number}(\\{ss});\6
\\{free\_number}(\|s);\6
\\{free\_number}(\\{dxin});\6
\\{free\_number}(\\{dyin});\6
\\{free\_number}(\\{dx0});\6
\\{free\_number}(\\{dy0});\6
\\{free\_number}(\\{x0});\6
\\{free\_number}(\\{y0});\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{y1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{y2});\6
\\{free\_number}(\\{max\_coef});\6
\\{free\_number}(\\{du});\6
\\{free\_number}(\\{dv});\6
\\{free\_number}(\\{dx});\6
\\{free\_number}(\\{dy});\6
\\{free\_number}(\\{x0a});\6
\\{free\_number}(\\{y0a});\6
\\{free\_number}(\\{x1a});\6
\\{free\_number}(\\{y1a});\6
\\{free\_number}(\\{x2a});\6
\\{free\_number}(\\{y2a});\6
\\{free\_number}(\\{t0});\6
\\{free\_number}(\\{t1});\6
\\{free\_number}(\\{t2});\6
\\{free\_number}(\\{u0});\6
\\{free\_number}(\\{u1});\6
\\{free\_number}(\\{v0});\6
\\{free\_number}(\\{v1});\6
\\{free\_number}(\|t);\6
\&{return} \|c;\6
\4${}\}{}$\2\par
\fi

\M{545}We shall want to keep track of where certain knots on the cyclic path
wind up in the envelope spec.  It doesn't suffice just to keep pointers to
knot nodes because some nodes are deleted while removing dead cubics.  Thus
\PB{\\{offset\_prep}} updates the following pointers

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_knot} \\{spec\_p1};\6
\&{mp\_knot} \\{spec\_p2};\C{ pointers to distinguished knots }\par
\fi

\M{546}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{spec\_p1}\K\NULL;{}$\6
${}\\{mp}\MG\\{spec\_p2}\K\NULL{}$;\par
\fi

\M{547}\B\X547:Initialize the pen size~\PB{\|n}\X${}\E{}$\6
$\|n\K\T{0};{}$\6
${}\|p\K\|h;$ \&{do} \6
${}\{{}$\1\6
\\{incr}(\|n);\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\|p\I\|h{}$)\par
\U544.\fi

\M{548}Since the true incoming direction isn't known yet, we just pick a
direction
consistent with the pen offset~\PB{\|h}.  If this is wrong, it can be corrected
later.

\Y\B\4\X548:Initialize the incoming direction and pen offset at \PB{\|c}\X${}%
\E{}$\6
${}\{{}$\1\6
\&{mp\_knot} \\{hn}${}\K\\{mp\_next\_knot}(\|h);{}$\6
\&{mp\_knot} \\{hp}${}\K\\{mp\_prev\_knot}(\|h);{}$\7
${}\\{set\_number\_from\_substraction}(\\{dxin},\39\\{hn}\MG\\{x\_coord},\39%
\\{hp}\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyin},\39\\{hn}\MG\\{y\_coord},\39%
\\{hp}\MG\\{y\_coord});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxin})\W\\{number\_zero}(\\{dyin})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxin},\39\\{hp}\MG\\{y\_coord},\39\|h%
\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyin},\39\|h\MG\\{x\_coord},\39\\{hp}%
\MG\\{x\_coord});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
$\\{w0}\K{}$\|h\par
\U544.\fi

\M{549}We must be careful not to remove the only cubic in a cycle.

But we must also be careful for another reason. If the user-supplied
path starts with a set of degenerate cubics, the target node \PB{\|q} can
be collapsed to the initial node \PB{\|p} which might be the same as the
initial node \PB{\|c} of the curve. This would cause the \PB{\\{offset\_prep}}
routine
to bail out too early, causing distress later on. (See for example
the testcase reported by Bogus\l{}aw Jackowski in tracker id 267, case 52c
on Sarovar.)

\Y\B\4\X549:Advance \PB{\|p} to node \PB{\|q}, removing any ``dead'' cubics
that might have been introduced by the splitting process\X${}\E{}$\6
$\\{q0}\K\|q;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}(\\{number\_equal}(\|p\MG\\{x\_coord},\39\|p\MG\\{right\_x})\W%
\\{number\_equal}(\|p\MG\\{y\_coord},\39\|p\MG\\{right\_y})\W\\{number\_equal}(%
\|p\MG\\{x\_coord},\39\|r\MG\\{left\_x})\W\\{number\_equal}(\|p\MG\\{y\_coord},%
\39\|r\MG\\{left\_y})\W\\{number\_equal}(\|p\MG\\{x\_coord},\39\|r\MG\\{x%
\_coord})\W\\{number\_equal}(\|p\MG\\{y\_coord},\39\|r\MG\\{y\_coord})\W\|r\I%
\|p\W\|r\I\|q){}$\5
${}\{{}$\1\6
\X550:Remove the cubic following \PB{\|p} and update the data structures to
merge \PB{\|r} into \PB{\|p}\X;\6
\4${}\}{}$\2\6
${}\|p\K\|r;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|q){}$;\C{ Check if we removed too much }\6
\&{if} ${}((\|q\I\\{q0})\W(\|q\I\|c\V\|c\E\\{c0}))$ $\|q\K\\{mp\_next%
\_knot}{}$(\|q)\par
\U544.\fi

\M{550}\B\X550:Remove the cubic following \PB{\|p} and update the data
structures to merge \PB{\|r} into \PB{\|p}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{k\_needed}\K\\{mp\_knot\_info}(\|p)-\\{zero\_off};{}$\6
\&{if} ${}(\|r\E\|q){}$\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_knot\_info}(\|p)\K\\{k\_needed}+\\{mp\_knot\_info}(\|r);{}$\6
${}\\{k\_needed}\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|r\E\|c){}$\5
${}\{{}$\1\6
${}\\{mp\_knot\_info}(\|p)\K\\{mp\_knot\_info}(\|c);{}$\6
${}\|c\K\|p;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|r\E\\{mp}\MG\\{spec\_p1}){}$\1\5
${}\\{mp}\MG\\{spec\_p1}\K\|p;{}$\2\6
\&{if} ${}(\|r\E\\{mp}\MG\\{spec\_p2}){}$\1\5
${}\\{mp}\MG\\{spec\_p2}\K\|p;{}$\2\6
${}\|r\K\|p;{}$\6
${}\\{mp\_remove\_cubic}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\par
\U549.\fi

\M{551}Not setting the \PB{\\{info}} field of the newly created knot allows the
splitting
routine to work for paths.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_split\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_number} \|t);\par
\fi

\M{552}\B\&{void} \\{mp\_split\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p${},\39{}$\&{mp\_number} \|t)\1\1\2\2\6
${}\{{}$\C{ splits the cubic after \PB{\|p} }\1\6
\&{mp\_number} \|v;\C{ an intermediate value }\6
\&{mp\_knot} \|q${},{}$ \|r;\C{ for list manipulation }\7
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\|r\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_next\_knot}(\|p)\K\|r;{}$\6
${}\\{mp\_next\_knot}(\|r)\K\|q;{}$\6
${}\\{mp\_originator}(\|r)\K\\{mp\_program\_code};{}$\6
${}\\{mp\_left\_type}(\|r)\K\\{mp\_explicit};{}$\6
${}\\{mp\_right\_type}(\|r)\K\\{mp\_explicit};{}$\6
\\{new\_number}(\|v);\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\|p\MG\\{right\_x},\39\|q%
\MG\\{left\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|p\MG\\{right\_x},\39\|t,\39\|p\MG\\{x%
\_coord},\39\|p\MG\\{right\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|q\MG\\{left\_x},\39\|t,\39\|q\MG%
\\{left\_x},\39\|q\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{left\_x},\39\|t,\39\|p\MG%
\\{right\_x},\39\|v);{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{right\_x},\39\|t,\39\|v,\39\|q%
\MG\\{left\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{x\_coord},\39\|t,\39\|r\MG%
\\{left\_x},\39\|r\MG\\{right\_x});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\|p\MG\\{right\_y},\39\|q%
\MG\\{left\_y});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|p\MG\\{right\_y},\39\|t,\39\|p\MG\\{y%
\_coord},\39\|p\MG\\{right\_y});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|q\MG\\{left\_y},\39\|t,\39\|q\MG%
\\{left\_y},\39\|q\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{left\_y},\39\|t,\39\|p\MG%
\\{right\_y},\39\|v);{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{right\_y},\39\|t,\39\|v,\39\|q%
\MG\\{left\_y});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|r\MG\\{y\_coord},\39\|t,\39\|r\MG%
\\{left\_y},\39\|r\MG\\{right\_y});{}$\6
\\{free\_number}(\|v);\6
\4${}\}{}$\2\par
\fi

\M{553}This does not set \PB{\\{mp\_knot\_info}(\|p)} or \PB{\\{mp\_right%
\_type}(\|p)}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_remove\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p);\par
\fi

\M{554}\B\&{void} \\{mp\_remove\_cubic}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p)\1\1\2\2\6
${}\{{}$\C{ removes the dead cubic following~\PB{\|p} }\1\6
\&{mp\_knot} \|q;\C{ the node that disappears }\7
(\&{void}) \\{mp};\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_next\_knot}(\|p)\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{number\_clone}(\|p\MG\\{right\_x},\39\|q\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|p\MG\\{right\_y},\39\|q\MG\\{right\_y});{}$\6
\\{mp\_xfree}(\|q);\6
\4${}\}{}$\2\par
\fi

\M{555}Let $d\prec d'$ mean that the counter-clockwise angle from $d$ to~$d'$
is
strictly between zero and $180^\circ$.  Then we can define $d\preceq d'$ to
mean that the angle could be zero or $180^\circ$. If $w_k=(u_k,v_k)$ is the
$k$th pen offset, the $k$th pen edge direction is defined by the formula
$$d_k=(u\k-u_k,\,v\k-v_k).$$
When listed by increasing $k$, these directions occur in counter-clockwise
order so that $d_k\preceq d\k$ for all~$k$.
The goal of \PB{\\{offset\_prep}} is to find an offset index~\PB{\|k} to
associate with
each cubic, such that the direction $d(t)$ of the cubic satisfies
$$d_{k-1}\preceq d(t)\preceq d_k\qquad\hbox{for $0\le t\le 1$.}\eqno(*)$$
We may have to split a cubic into many pieces before each
piece corresponds to a unique offset.

\Y\B\4\X555:Split the cubic between \PB{\|p} and \PB{\|q}, if necessary, into
cubics associated with single offsets, after which \PB{\|q} should point to the
end of the final such cubic\X${}\E{}$\6
$\\{mp\_knot\_info}(\|p)\K\\{zero\_off}+\\{k\_needed};{}$\6
${}\\{k\_needed}\K\T{0};{}$\6
\X559:Prepare for derivative computations; \PB{\&{goto} \\{not\_found}} if the
current cubic is dead\X;\6
\X564:Find the initial direction \PB{$(\\{dx},\\{dy})$}\X;\6
\X566:Update \PB{\\{mp\_knot\_info}(\|p)} and find the offset $w_k$ such that
$d_{k-1}\preceq(\\{dx},\\{dy})\prec d_k$; also advance \PB{\\{w0}} for the
direction change at \PB{\|p}\X;\6
\X565:Find the final direction \PB{$(\\{dxin},\\{dyin})$}\X;\6
\X574:Decide on the net change in pen offsets and set \PB{\\{turn\_amt}}\X;\6
\X570:Complete the offset splitting process\X;\6
$\\{w0}\K\\{mp\_pen\_walk}(\\{mp},\39\\{w0},\39\\{turn\_amt}{}$)\par
\U544.\fi

\M{556}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_knot} \\{mp\_pen\_walk}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|w${},\39{}$\&{integer} \|k);\par
\fi

\M{557}\B\&{mp\_knot} \\{mp\_pen\_walk}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|w${},\39{}$\&{integer} \|k)\1\1\2\2\6
${}\{{}$\C{ walk \PB{\|k} steps around a pen from \PB{\|w} }\1\6
(\&{void}) \\{mp};\6
\&{while} ${}(\|k>\T{0}){}$\5
${}\{{}$\1\6
${}\|w\K\\{mp\_next\_knot}(\|w);{}$\6
\\{decr}(\|k);\6
\4${}\}{}$\2\6
\&{while} ${}(\|k<\T{0}){}$\5
${}\{{}$\1\6
${}\|w\K\\{mp\_prev\_knot}(\|w);{}$\6
\\{incr}(\|k);\6
\4${}\}{}$\2\6
\&{return} \|w;\6
\4${}\}{}$\2\par
\fi

\M{558}The direction of a cubic $B(z_0,z_1,z_2,z_3;t)=\bigl(x(t),y(t)\bigr)$
can be
calculated from the quadratic polynomials
${1\over3}x'(t)=B(x_1-x_0,x_2-x_1,x_3-x_2;t)$ and
${1\over3}y'(t)=B(y_1-y_0,y_2-y_1,y_3-y_2;t)$.
Since we may be calculating directions from several cubics
split from the current one, it is desirable to do these calculations
without losing too much precision. ``Scaled up'' values of the
derivatives, which will be less tainted by accumulated errors than
derivatives found from the cubics themselves, are maintained in
local variables \PB{\\{x0}}, \PB{\\{x1}}, and \PB{\\{x2}}, representing
$X_0=2^l(x_1-x_0)$,
$X_1=2^l(x_2-x_1)$, and $X_2=2^l(x_3-x_2)$; similarly \PB{\\{y0}}, \PB{\\{y1}},
and~\PB{\\{y2}}
represent $Y_0=2^l(y_1-y_0)$, $Y_1=2^l(y_2-y_1)$, and $Y_2=2^l(y_3-y_2)$.

\Y\B\4\X558:Other local variables for \PB{\\{offset\_prep}}\X${}\E{}$\6
\&{mp\_number} \\{x0}${},{}$ \\{x1}${},{}$ \\{x2}${},{}$ \\{y0}${},{}$ %
\\{y1}${},{}$ \\{y2};\C{ representatives of derivatives }\6
\&{mp\_number} \\{t0}${},{}$ \\{t1}${},{}$ \\{t2};\C{ coefficients of
polynomial for slope testing }\6
\&{mp\_number} \\{du}${},{}$ \\{dv}${},{}$ \\{dx}${},{}$ \\{dy};\C{ for
directions of the pen and the curve }\6
\&{mp\_number} \\{dx0}${},{}$ \\{dy0};\C{ initial direction for the first cubic
in the curve }\6
\&{mp\_number} \\{x0a}${},{}$ \\{x1a}${},{}$ \\{x2a}${},{}$ \\{y0a}${},{}$ %
\\{y1a}${},{}$ \\{y2a};\C{ intermediate values }\6
\&{mp\_number} \|t;\C{ where the derivative passes through zero }\6
\&{mp\_number} \|s;\C{ a temporary value }\par
\A573.
\U544.\fi

\M{559}\B\X559:Prepare for derivative computations; \PB{\&{goto} \\{not%
\_found}} if the current cubic is dead\X${}\E{}$\6
$\\{set\_number\_from\_substraction}(\\{x0},\39\|p\MG\\{right\_x},\39\|p\MG\\{x%
\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x2},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x1},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y0},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y2},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y1},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{absval};\7
\\{new\_number}(\\{absval});\6
${}\\{number\_clone}(\\{absval},\39\\{x1});{}$\6
\\{number\_abs}(\\{absval});\6
${}\\{number\_clone}(\\{max\_coef},\39\\{x0});{}$\6
\\{number\_abs}(\\{max\_coef});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max\_coef})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max\_coef},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{x2});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max\_coef})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max\_coef},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y0});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max\_coef})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max\_coef},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y1});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max\_coef})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max\_coef},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y2});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max\_coef})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max\_coef},\39\\{absval});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_zero}(\\{max\_coef}))\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absval});\6
\4${}\}{}$\2\6
\&{while} ${}(\\{number\_less}(\\{max\_coef},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\\{number\_double}(\\{max\_coef});\6
\\{number\_double}(\\{x0});\6
\\{number\_double}(\\{x1});\6
\\{number\_double}(\\{x2});\6
\\{number\_double}(\\{y0});\6
\\{number\_double}(\\{y1});\6
\\{number\_double}(\\{y2});\6
\4${}\}{}$\2\par
\U555.\fi

\M{560}Let us first solve a special case of the problem: Suppose we
know an index~$k$ such that either (i)~$d(t)\succeq d_{k-1}$ for all~$t$
and $d(0)\prec d_k$, or (ii)~$d(t)\preceq d_k$ for all~$t$ and
$d(0)\succ d_{k-1}$.
Then, in a sense, we're halfway done, since one of the two relations
in $(*)$ is satisfied, and the other couldn't be satisfied for
any other value of~\PB{\|k}.

Actually, the conditions can be relaxed somewhat since a relation such as
$d(t)\succeq d_{k-1}$ restricts $d(t)$ to a half plane when all that really
matters is whether $d(t)$ crosses the ray in the $d_{k-1}$ direction from
the origin.  The condition for case~(i) becomes $d_{k-1}\preceq d(0)\prec d_k$
and $d(t)$ never crosses the $d_{k-1}$ ray in the clockwise direction.
Case~(ii) is similar except $d(t)$ cannot cross the $d_k$ ray in the
counterclockwise direction.

The \PB{\\{fin\_offset\_prep}} subroutine solves the stated subproblem.
It has a parameter called \PB{\\{rise}} that is \PB{\T{1}} in
case~(i), \PB{${-}\T{1}$} in case~(ii). Parameters \PB{\\{x0}} through \PB{%
\\{y2}} represent
the derivative of the cubic following \PB{\|p}.
The \PB{\|w} parameter should point to offset~$w_k$ and \PB{\\{mp\_info}(\|p)}
should already
be set properly.  The \PB{\\{turn\_amt}} parameter gives the absolute value of
the
overall net change in pen offsets.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_fin\_offset\_prep}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|p${},\39{}$\&{mp\_knot} \|w${},\39{}$\&{mp\_number} \\{x0}${},\39{}$%
\&{mp\_number} \\{x1}${},\39{}$\&{mp\_number} \\{x2}${},\39{}$\&{mp\_number} %
\\{y0}${},\39{}$\&{mp\_number} \\{y1}${},\39{}$\&{mp\_number} \\{y2}${},\39{}$%
\&{integer} \\{rise}${},\39{}$\&{integer} \\{turn\_amt});\par
\fi

\M{561}\B\&{void} \\{mp\_fin\_offset\_prep}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot}
\|p${},\39{}$\&{mp\_knot} \|w${},\39{}$\&{mp\_number} \\{x0}${},\39{}$\&{mp%
\_number} \\{x1}${},\39{}$\&{mp\_number} \\{x2}${},\39{}$\&{mp\_number} %
\\{y0}${},\39{}$\&{mp\_number} \\{y1}${},\39{}$\&{mp\_number} \\{y2}${},\39{}$%
\&{integer} \\{rise}${},\39{}$\&{integer} \\{turn\_amt})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \\{ww};\C{ for list manipulation }\6
\&{mp\_number} \\{du}${},{}$ \\{dv};\C{ for slope calculation }\6
\&{mp\_number} \\{t0}${},{}$ \\{t1}${},{}$ \\{t2};\C{ test coefficients }\6
\&{mp\_number} \|t;\C{ place where the derivative passes a critical slope }\6
\&{mp\_number} \|s;\C{ slope or reciprocal slope }\6
\&{mp\_number} \|v;\C{ intermediate value for updating \PB{$\\{x0}\MRL{{.}{.}}%
\\{y2}$} }\6
\&{mp\_knot} \|q;\C{ original \PB{\\{mp\_next\_knot}(\|p)} }\7
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\\{new\_number}(\\{du});\6
\\{new\_number}(\\{dv});\6
\\{new\_number}(\|v);\6
\\{new\_number}(\\{t0});\6
\\{new\_number}(\\{t1});\6
\\{new\_number}(\\{t2});\6
\\{new\_fraction}(\|s);\6
\\{new\_fraction}(\|t);\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{rise}>\T{0}){}$\1\5
${}\\{ww}\K\\{mp\_next\_knot}(\|w){}$;\C{ a pointer to $w\k$ }\2\6
\&{else}\1\5
${}\\{ww}\K\\{mp\_prev\_knot}(\|w){}$;\C{ a pointer to $w_{k-1}$ }\2\6
\X562:Compute test coefficients \PB{$(\\{t0},\\{t1},\\{t2})$} for $d(t)$ versus
$d_k$ or $d_{k-1}$\X;\6
${}\\{crossing\_point}(\|t,\39\\{t0},\39\\{t1},\39\\{t2});{}$\6
\&{if} ${}(\\{number\_greaterequal}(\|t,\39\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{turn\_amt}>\T{0}){}$\1\5
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\2\6
\&{else}\1\5
\&{goto} \.{RETURN};\2\6
\4${}\}{}$\2\6
\X563:Split the cubic at $t$, and split off another cubic if the derivative
crosses back\X;\6
${}\|w\K\\{ww};{}$\6
\4${}\}{}$\2\6
\4\.{RETURN}:\5
\\{free\_number}(\|s);\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{du});\6
\\{free\_number}(\\{dv});\6
\\{free\_number}(\|v);\6
\\{free\_number}(\\{t0});\6
\\{free\_number}(\\{t1});\6
\\{free\_number}(\\{t2});\6
\4${}\}{}$\2\par
\fi

\M{562}We want $B(\\{t0},\\{t1},\\{t2};t)$ to be the dot product of $d(t)$ with
a
$-90^\circ$ rotation of the vector from \PB{\|w} to \PB{\\{ww}}.  This makes
the resulting
function cross from positive to negative when $d_{k-1}\preceq d(t)\preceq d_k$
begins to fail.

\Y\B\4\X562:Compute test coefficients \PB{$(\\{t0},\\{t1},\\{t2})$} for $d(t)$
versus $d_k$ or $d_{k-1}$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{abs\_du}${},{}$ \\{abs\_dv};\7
\\{new\_number}(\\{abs\_du});\6
\\{new\_number}(\\{abs\_dv});\6
${}\\{set\_number\_from\_substraction}(\\{du},\39\\{ww}\MG\\{x\_coord},\39\|w%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dv},\39\\{ww}\MG\\{y\_coord},\39\|w%
\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\\{abs\_du},\39\\{du});{}$\6
\\{number\_abs}(\\{abs\_du});\6
${}\\{number\_clone}(\\{abs\_dv},\39\\{dv});{}$\6
\\{number\_abs}(\\{abs\_dv});\6
\&{if} ${}(\\{number\_greaterequal}(\\{abs\_du},\39\\{abs\_dv})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\|s,\39\\{dv},\39\\{du});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x0},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t0},\39\\{r1},\39\\{y0});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x1},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t1},\39\\{r1},\39\\{y1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x2},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t2},\39\\{r1},\39\\{y2});{}$\6
\&{if} (\\{number\_negative}(\\{du}))\5
${}\{{}$\1\6
\\{number\_negate}(\\{t0});\6
\\{number\_negate}(\\{t1});\6
\\{number\_negate}(\\{t2});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\|s,\39\\{du},\39\\{dv});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y0},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t0},\39\\{x0},\39\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y1},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t1},\39\\{x1},\39\\{r1});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y2},\39\|s);{}$\6
${}\\{set\_number\_from\_substraction}(\\{t2},\39\\{x2},\39\\{r1});{}$\6
\&{if} (\\{number\_negative}(\\{dv}))\5
${}\{{}$\1\6
\\{number\_negate}(\\{t0});\6
\\{number\_negate}(\\{t1});\6
\\{number\_negate}(\\{t2});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abs\_du});\6
\\{free\_number}(\\{abs\_dv});\6
\&{if} (\\{number\_negative}(\\{t0}))\1\5
\\{set\_number\_to\_zero}(\\{t0});\C{ should be positive without rounding error
}\2\6
\4${}\}{}$\2\par
\Us561\ET570.\fi

\M{563}The curve has crossed $d_k$ or $d_{k-1}$; its initial segment satisfies
$(*)$, and it might cross again and return towards $s_{k-1}$ or $s_k$,
respectively, yielding another solution of $(*)$.

\Y\B\4\X563:Split the cubic at $t$, and split off another cubic if the
derivative crosses back\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_split\_cubic}(\\{mp},\39\|p,\39\|t);{}$\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{mp\_knot\_info}(\|p)\K\\{zero\_off}+\\{rise};{}$\6
\\{decr}(\\{turn\_amt});\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x0},\39\|t,\39\|v,\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1},\39\|t,\39\\{y1},\39\\{y2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y0},\39\|t,\39\|v,\39\\{y1});{}$\6
\&{if} ${}(\\{turn\_amt}<\T{0}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{t1},\39\|t,\39\\{t1},\39\\{t2});{}$\6
\&{if} (\\{number\_positive}(\\{t1}))\1\5
\\{set\_number\_to\_zero}(\\{t1});\C{ without rounding error, \PB{\\{t1}} would
be \PB{$\Z$ \T{0}} }\2\6
${}\\{number\_clone}(\\{arg2},\39\\{t1});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{number\_clone}(\\{arg3},\39\\{t2});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\|t,\39\\{arg1},\39\\{arg2},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\1\5
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\2\6
\\{incr}(\\{turn\_amt});\6
\&{if} ${}(\\{number\_equal}(\|t,\39\\{fraction\_one\_t})\W(\\{mp\_next\_knot}(%
\|p)\I\|q)){}$\5
${}\{{}$\1\6
${}\\{mp\_knot\_info}(\\{mp\_next\_knot}(\|p))\K\\{mp\_knot\_info}(\\{mp\_next%
\_knot}(\|p))-\\{rise};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_split\_cubic}(\\{mp},\39\|p,\39\|t);{}$\6
${}\\{mp\_knot\_info}(\\{mp\_next\_knot}(\|p))\K\\{zero\_off}-\\{rise};{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\\{x1},\39\|v);{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\|v,\39\|t,\39\\{y1},\39\\{y2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1},\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y2},\39\|t,\39\\{y1},\39\|v);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U561.\fi

\M{564}Now we must consider the general problem of \PB{\\{offset\_prep}}, when
nothing is known about a given cubic. We start by finding its
direction in the vicinity of \PB{$\|t\K\T{0}$}.

If $z'(t)=0$, the given cubic is numerically unstable but \PB{\\{offset\_prep}}
has not yet introduced any more numerical errors.  Thus we can compute
the true initial direction for the given cubic, even if it is almost
degenerate.

\Y\B\4\X564:Find the initial direction \PB{$(\\{dx},\\{dy})$}\X${}\E{}$\6
$\\{number\_clone}(\\{dx},\39\\{x0});{}$\6
${}\\{number\_clone}(\\{dy},\39\\{y0});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dx})\W\\{number\_zero}(\\{dy})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dx},\39\\{x1});{}$\6
${}\\{number\_clone}(\\{dy},\39\\{y1});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dx})\W\\{number\_zero}(\\{dy})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dx},\39\\{x2});{}$\6
${}\\{number\_clone}(\\{dy},\39\\{y2});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\E\|c){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dx0},\39\\{dx});{}$\6
${}\\{number\_clone}(\\{dy0},\39\\{dy});{}$\6
\4${}\}{}$\2\par
\U555.\fi

\M{565}\B\X565:Find the final direction \PB{$(\\{dxin},\\{dyin})$}\X${}\E{}$\6
$\\{number\_clone}(\\{dxin},\39\\{x2});{}$\6
${}\\{number\_clone}(\\{dyin},\39\\{y2});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxin})\W\\{number\_zero}(\\{dyin})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dxin},\39\\{x1});{}$\6
${}\\{number\_clone}(\\{dyin},\39\\{y1});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxin})\W\\{number\_zero}(\\{dyin})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{dxin},\39\\{x0});{}$\6
${}\\{number\_clone}(\\{dyin},\39\\{y0});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U555.\fi

\M{566}The next step is to bracket the initial direction between consecutive
edges of the pen polygon.  We must be careful to turn clockwise only if
this makes the turn less than $180^\circ$. (A $180^\circ$ turn must be
counter-clockwise in order to make \&{doublepath} envelopes come out
right.) This code depends on \PB{\\{w0}} being the offset for \PB{$(\\{dxin},%
\\{dyin})$}.

\Y\B\4\X566:Update \PB{\\{mp\_knot\_info}(\|p)} and find the offset $w_k$ such
that $d_{k-1}\preceq(\\{dx},\\{dy})\prec d_k$; also advance \PB{\\{w0}} for the
direction change at \PB{\|p}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dy},\39\\{dxin},\39\\{dx},\39%
\\{dyin});{}$\6
${}\\{turn\_amt}\K\\{mp\_get\_turn\_amt}(\\{mp},\39\\{w0},\39\\{dx},\39\\{dy},%
\39\\{number\_nonnegative}(\\{ab\_vs\_cd}));{}$\6
\\{free\_number}(\\{ab\_vs\_cd});\6
${}\|w\K\\{mp\_pen\_walk}(\\{mp},\39\\{w0},\39\\{turn\_amt});{}$\6
${}\\{w0}\K\|w;{}$\6
${}\\{mp\_knot\_info}(\|p)\K\\{mp\_knot\_info}(\|p)+\\{turn\_amt};{}$\6
\4${}\}{}$\2\par
\U555.\fi

\M{567}Decide how many pen offsets to go away from \PB{\|w} in order to find
the offset
for \PB{$(\\{dx},\\{dy})$}, going counterclockwise if \PB{\\{ccw}} is \PB{%
\\{true}}.  This assumes that
\PB{\|w} is the offset for some direction $(x',y')$ from which the angle to %
\PB{$(\\{dx},\\{dy})$}
in the sense determined by \PB{\\{ccw}} is less than or equal to $180^\circ$.

If the pen polygon has only two edges, they could both be parallel
to \PB{$(\\{dx},\\{dy})$}.  In this case, we must be careful to stop after
crossing the first
such edge in order to avoid an infinite loop.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{integer} \\{mp\_get\_turn\_amt}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|w${},\39{}$\&{mp\_number} \\{dx}${},\39{}$\&{mp\_number} \\{dy}${},%
\39{}$\&{boolean} \\{ccw});\par
\fi

\M{568}\B\&{integer} \\{mp\_get\_turn\_amt}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot}
\|w${},\39{}$\&{mp\_number} \\{dx}${},\39{}$\&{mp\_number} \\{dy}${},\39{}$%
\&{boolean} \\{ccw})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \\{ww};\C{ a neighbor of knot~\PB{\|w} }\6
\&{integer} \|s;\C{ turn amount so far }\6
\&{mp\_number} \|t;\C{ \PB{\\{ab\_vs\_cd}} result }\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
${}\|s\K\T{0};{}$\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\|t);\6
\&{if} (\\{ccw})\5
${}\{{}$\1\6
${}\\{ww}\K\\{mp\_next\_knot}(\|w);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{ww}\MG\\{x\_coord},\39\|w%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{ww}\MG\\{y\_coord},\39\|w%
\MG\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\|t,\39\\{dy},\39\\{arg1},\39\\{dx},\39\\{arg2});{}$\6
\&{if} (\\{number\_negative}(\|t))\1\5
\&{break};\2\6
\\{incr}(\|s);\6
${}\|w\K\\{ww};{}$\6
${}\\{ww}\K\\{mp\_next\_knot}(\\{ww});{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_positive}(\|t));\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{ww}\K\\{mp\_prev\_knot}(\|w);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|w\MG\\{x\_coord},\39\\{ww}%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|w\MG\\{y\_coord},\39\\{ww}%
\MG\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\|t,\39\\{dy},\39\\{arg1},\39\\{dx},\39\\{arg2});{}$\6
\&{while} (\\{number\_negative}(\|t))\5
${}\{{}$\1\6
\\{decr}(\|s);\6
${}\|w\K\\{ww};{}$\6
${}\\{ww}\K\\{mp\_prev\_knot}(\\{ww});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|w\MG\\{x\_coord},\39\\{ww}%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|w\MG\\{y\_coord},\39\\{ww}%
\MG\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\|t,\39\\{dy},\39\\{arg1},\39\\{dx},\39\\{arg2});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\&{return} \|s;\6
\4${}\}{}$\2\par
\fi

\M{569}When we're all done, the final offset is \PB{\\{w0}} and the final curve
direction
is \PB{$(\\{dxin},\\{dyin})$}.  With this knowledge of the incoming direction
at \PB{\|c}, we
can correct \PB{\\{mp\_info}(\|c)} which was erroneously based on an incoming
offset
of~\PB{\|h}.

\Y\B\4\D$\\{fix\_by}(\|A)$ \5
$\\{mp\_knot\_info}(\|c)\K\\{mp\_knot\_info}(\|c)+{}$(\|A)\par
\Y\B\4\X569:Fix the offset change in \PB{\\{mp\_knot\_info}(\|c)} and set \PB{%
\|c} to the return value of \PB{\\{offset\_prep}}\X${}\E{}$\6
$\\{mp}\MG\\{spec\_offset}\K\\{mp\_knot\_info}(\|c)-\\{zero\_off};{}$\6
\&{if} ${}(\\{mp\_next\_knot}(\|c)\E\|c){}$\5
${}\{{}$\1\6
${}\\{mp\_knot\_info}(\|c)\K\\{zero\_off}+\|n;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{fix\_by}(\\{k\_needed});\6
\&{while} ${}(\\{w0}\I\|h){}$\5
${}\{{}$\1\6
\\{fix\_by}(\T{1});\6
${}\\{w0}\K\\{mp\_next\_knot}(\\{w0});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp\_knot\_info}(\|c)\Z\\{zero\_off}-\|n){}$\1\5
\\{fix\_by}(\|n);\2\6
\&{while} ${}(\\{mp\_knot\_info}(\|c)>\\{zero\_off}){}$\1\5
${}\\{fix\_by}({-}\|n);{}$\2\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dy0},\39\\{dxin},\39\\{dx0},\39%
\\{dyin});{}$\6
\&{if} ${}((\\{mp\_knot\_info}(\|c)\I\\{zero\_off})\W\\{number\_nonnegative}(%
\\{ab\_vs\_cd})){}$\1\5
\\{fix\_by}(\|n);\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\4${}\}{}$\2\par
\U544.\fi

\M{570}Finally we want to reduce the general problem to situations that
\PB{\\{fin\_offset\_prep}} can handle. We split the cubic into at most three
parts
with respect to $d_{k-1}$, and apply \PB{\\{fin\_offset\_prep}} to each part.

\Y\B\4\X570:Complete the offset splitting process\X${}\E{}$\6
$\\{ww}\K\\{mp\_prev\_knot}(\|w);{}$\6
\X562:Compute test coefficients \PB{$(\\{t0},\\{t1},\\{t2})$} for $d(t)$ versus
$d_k$ or $d_{k-1}$\X;\6
\X572:Find the first \PB{\|t} where $d(t)$ crosses $d_{k-1}$ or set \PB{\|t: $%
\K$ $\\{fraction\_one}+\T{1}$}\X;\6
\&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
${}\\{mp\_fin\_offset\_prep}(\\{mp},\39\|p,\39\|w,\39\\{x0},\39\\{x1},\39%
\\{x2},\39\\{y0},\39\\{y1},\39\\{y2},\39\T{1},\39\\{turn\_amt});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_split\_cubic}(\\{mp},\39\|p,\39\|t);{}$\6
${}\|r\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1a},\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2a},\39\|t,\39\\{x1a},\39\\{x1});{}$%
\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1a},\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1},\39\|t,\39\\{y1},\39\\{y2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y2a},\39\|t,\39\\{y1a},\39\\{y1});{}$%
\6
${}\\{mp\_fin\_offset\_prep}(\\{mp},\39\|p,\39\|w,\39\\{x0},\39\\{x1a},\39%
\\{x2a},\39\\{y0},\39\\{y1a},\39\\{y2a},\39\T{1},\39\T{0});{}$\6
${}\\{number\_clone}(\\{x0},\39\\{x2a});{}$\6
${}\\{number\_clone}(\\{y0},\39\\{y2a});{}$\6
${}\\{mp\_knot\_info}(\|r)\K\\{zero\_off}-\T{1};{}$\6
\&{if} ${}(\\{turn\_amt}\G\T{0}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{t1},\39\|t,\39\\{t1},\39\\{t2});{}$\6
\&{if} (\\{number\_positive}(\\{t1}))\1\5
\\{set\_number\_to\_zero}(\\{t1});\2\6
${}\\{number\_clone}(\\{arg2},\39\\{t1});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{number\_clone}(\\{arg3},\39\\{t2});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\|t,\39\\{arg1},\39\\{arg2},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\1\5
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\2\6
\X571:Split off another rising cubic for \PB{\\{fin\_offset\_prep}}\X;\6
${}\\{mp\_fin\_offset\_prep}(\\{mp},\39\|r,\39\\{ww},\39\\{x0},\39\\{x1},\39%
\\{x2},\39\\{y0},\39\\{y1},\39\\{y2},\39{-}\T{1},\39\T{0});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_fin\_offset\_prep}(\\{mp},\39\|r,\39\\{ww},\39\\{x0},\39\\{x1},\39%
\\{x2},\39\\{y0},\39\\{y1},\39\\{y2},\39{-}\T{1},\39({-}\T{1}-\\{turn%
\_amt}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U555.\fi

\M{571}\B\X571:Split off another rising cubic for \PB{\\{fin\_offset\_prep}}%
\X${}\E{}$\6
$\\{mp\_split\_cubic}(\\{mp},\39\|r,\39\|t);{}$\6
${}\\{mp\_knot\_info}(\\{mp\_next\_knot}(\|r))\K\\{zero\_off}+\T{1};{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1a},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x0a},\39\|t,\39\\{x1},\39\\{x1a});{}$%
\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1a},\39\|t,\39\\{y1},\39\\{y2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y1},\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y0a},\39\|t,\39\\{y1},\39\\{y1a});{}$%
\6
${}\\{mp\_fin\_offset\_prep}(\\{mp},\39\\{mp\_next\_knot}(\|r),\39\|w,\39%
\\{x0a},\39\\{x1a},\39\\{x2},\39\\{y0a},\39\\{y1a},\39\\{y2},\39\T{1},\39%
\\{turn\_amt});{}$\6
${}\\{number\_clone}(\\{x2},\39\\{x0a});$ $\\{number\_clone}(\\{y2},\39%
\\{y0a}{}$)\par
\U570.\fi

\M{572}At this point, the direction of the incoming pen edge is \PB{$({-}%
\\{du},{-}\\{dv})$}.
When the component of $d(t)$ perpendicular to \PB{$({-}\\{du},{-}\\{dv})$}
crosses zero, we
need to decide whether the directions are parallel or antiparallel.  We
can test this by finding the dot product of $d(t)$ and \PB{$({-}\\{du},{-}%
\\{dv})$}, but this
should be avoided when the value of \PB{\\{turn\_amt}} already determines the
answer.  If \PB{$\\{t2}<\T{0}$}, there is one crossing and it is antiparallel
only if
\PB{$\\{turn\_amt}\G\T{0}$}.  If \PB{$\\{turn\_amt}<\T{0}$}, there should
always be at least one
crossing and the first crossing cannot be antiparallel.

\Y\B\4\X572:Find the first \PB{\|t} where $d(t)$ crosses $d_{k-1}$ or set \PB{%
\|t: $\K$ $\\{fraction\_one}+\T{1}$}\X${}\E{}$\6
$\\{crossing\_point}(\|t,\39\\{t0},\39\\{t1},\39\\{t2});{}$\6
\&{if} ${}(\\{turn\_amt}\G\T{0}){}$\5
${}\{{}$\1\6
\&{if} (\\{number\_negative}(\\{t2}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\6
${}\\{number\_add\_scaled}(\|t,\39\T{1});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{tmp}${},{}$ \\{arg1}${},{}$ \\{r1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{arg1});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u0},\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp},\39\|t,\39\\{u0},\39\\{u1});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{du});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{take\_fraction}(\\{ss},\39\\{arg1},\39\\{tmp});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v0},\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v1},\39\|t,\39\\{y1},\39\\{y2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp},\39\|t,\39\\{v0},\39\\{v1});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{dv});{}$\6
\\{number\_abs}(\\{arg1});\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{tmp});{}$\6
${}\\{number\_add}(\\{ss},\39\\{r1});{}$\6
\\{free\_number}(\\{tmp});\6
\&{if} (\\{number\_negative}(\\{ss}))\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\6
${}\\{number\_add\_scaled}(\|t,\39\T{1});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|t,\39\\{fraction\_one\_t});{}$\6
\4${}\}{}$\2\par
\U570.\fi

\M{573}\B\X558:Other local variables for \PB{\\{offset\_prep}}\X${}\mathrel+%
\E{}$\6
\&{mp\_number} \\{u0}${},{}$ \\{u1}${},{}$ \\{v0}${},{}$ \\{v1};\C{
intermediate values for $d(t)$ calculation }\6
\&{int} \\{d\_sign};\C{ sign of overall change in direction for this cubic }\par
\fi

\M{574}If the cubic almost has a cusp, it is a numerically ill-conditioned
problem to decide which way it loops around but that's OK as long we're
consistent.  To make \&{doublepath} envelopes work properly, reversing
the path should always change the sign of \PB{\\{turn\_amt}}.

\Y\B\4\X574:Decide on the net change in pen offsets and set \PB{\\{turn\_amt}}%
\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{dx},\39\\{dyin},\39\\{dxin},\39%
\\{dy});{}$\6
\&{if} (\\{number\_negative}(\\{ab\_vs\_cd}))\1\5
${}\\{d\_sign}\K{-}\T{1};{}$\2\6
\&{else} \&{if} (\\{number\_zero}(\\{ab\_vs\_cd}))\1\5
${}\\{d\_sign}\K\T{0};{}$\2\6
\&{else}\1\5
${}\\{d\_sign}\K\T{1};{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{d\_sign}\E\T{0}){}$\5
${}\{\X575:Check rotation direction based on node position\X\}{}$\6
\&{if} ${}(\\{d\_sign}\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} (\\{number\_zero}(\\{dx}))\5
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{dy}))\1\5
${}\\{d\_sign}\K\T{1};{}$\2\6
\&{else}\1\5
${}\\{d\_sign}\K{-}\T{1};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{dx}))\1\5
${}\\{d\_sign}\K\T{1};{}$\2\6
\&{else}\1\5
${}\\{d\_sign}\K{-}\T{1};{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\X576:Make \PB{\\{ss}} negative if and only if the total change in direction is
more than $180^\circ$\X;\6
${}\\{turn\_amt}\K\\{mp\_get\_turn\_amt}(\\{mp},\39\|w,\39\\{dxin},\39\\{dyin},%
\39(\\{d\_sign}>\T{0}));$ \&{if} (\\{number\_negative}(\\{ss})) $\\{turn\_amt}%
\K\\{turn\_amt}-\\{d\_sign}*{}$\|n\par
\U555.\fi

\M{575}We check rotation direction by looking at the vector connecting the
current
node with the next. If its angle with incoming and outgoing tangents has the
same sign, we pick this as \PB{\\{d\_sign}}, since it means we have a flex, not
a cusp.
Otherwise we proceed to the cusp code.

\Y\B\4\X575:Check rotation direction based on node position\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd1}${},{}$ \\{ab\_vs\_cd2}${},{}$ \|t;\7
\\{new\_number}(\\{ab\_vs\_cd1});\6
\\{new\_number}(\\{ab\_vs\_cd2});\6
\\{new\_number}(\|t);\6
${}\\{set\_number\_from\_substraction}(\\{u0},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{u1},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd1},\39\\{dx},\39\\{u1},\39\\{u0},\39\\{dy});{}$\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd2},\39\\{u0},\39\\{dyin},\39\\{dxin},\39%
\\{u1});{}$\6
${}\\{set\_number\_from\_addition}(\|t,\39\\{ab\_vs\_cd1},\39\\{ab\_vs%
\_cd2});{}$\6
\\{number\_half}(\|t);\6
\&{if} (\\{number\_negative}(\|t))\1\5
${}\\{d\_sign}\K{-}\T{1};{}$\2\6
\&{else} \&{if} (\\{number\_zero}(\|t))\1\5
${}\\{d\_sign}\K\T{0};{}$\2\6
\&{else}\1\5
${}\\{d\_sign}\K\T{1};{}$\2\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{ab\_vs\_cd1});\6
\\{free\_number}(\\{ab\_vs\_cd2});\6
\4${}\}{}$\2\par
\U574.\fi

\M{576}In order to be invariant under path reversal, the result of this
computation
should not change when \PB{\\{x0}}, \PB{\\{y0}}, $\ldots$ are all negated and %
\PB{$(\\{x0},\\{y0})$} is
then swapped with \PB{$(\\{x2},\\{y2})$}.  We make use of the identities
\PB{$\\{take\_fraction}({-}\|a,{-}\|b)\K\\{take\_fraction}(\|a,\|b)$} and
\PB{$\\{t\_of\_the\_way}({-}\|a,{-}\|b)\K{-}(\\{t\_of\_the\_way}(\|a,\|b))$}.

\Y\B\4\X576:Make \PB{\\{ss}} negative if and only if the total change in
direction is more than $180^\circ$\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2}${},{}$ \\{arg1};\7
\\{new\_number}(\\{arg1});\6
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{x0},\39\\{y2});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{x2},\39\\{y0});{}$\6
\\{number\_half}(\\{r1});\6
\\{number\_half}(\\{r2});\6
${}\\{set\_number\_from\_substraction}(\\{t0},\39\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{y0},\39\\{y2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x1},\39\\{arg1});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{x0},\39\\{x2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y1},\39\\{arg1});{}$\6
\\{number\_half}(\\{r1});\6
\\{number\_half}(\\{r2});\6
${}\\{set\_number\_from\_substraction}(\\{t1},\39\\{r1},\39\\{r2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
\&{if} (\\{number\_zero}(\\{t0}))\1\5
${}\\{set\_number\_from\_scaled}(\\{t0},\39\\{d\_sign}){}$;\C{ path reversal
always negates \PB{\\{d\_sign}} }\2\6
\&{if} (\\{number\_positive}(\\{t0}))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg3};\7
\\{new\_number}(\\{arg3});\6
${}\\{number\_clone}(\\{arg3},\39\\{t0});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\|t,\39\\{t0},\39\\{t1},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg3});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u0},\39\|t,\39\\{x0},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v0},\39\|t,\39\\{y0},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v1},\39\|t,\39\\{y1},\39\\{y2});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{t0});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{crossing\_point}(\|t,\39\\{arg1},\39\\{t1},\39\\{t0});{}$\6
\\{free\_number}(\\{arg1});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u0},\39\|t,\39\\{x2},\39\\{x1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{u1},\39\|t,\39\\{x1},\39\\{x0});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v0},\39\|t,\39\\{y2},\39\\{y1});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{v1},\39\|t,\39\\{y1},\39\\{y0});{}$\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{tmp1}${},{}$ \\{tmp2}${},{}$ \\{r1}${},{}$ \\{r2}${},{}$ %
\\{arg1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{tmp1});\6
\\{new\_number}(\\{tmp2});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp1},\39\|t,\39\\{u0},\39\\{u1});{}$%
\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp2},\39\|t,\39\\{v0},\39\\{v1});{}$%
\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{x0},\39\\{x2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{tmp1});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\\{y0},\39\\{y2});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{arg1},\39\\{tmp2});{}$\6
${}\\{set\_number\_from\_addition}(\\{ss},\39\\{r1},\39\\{r2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{tmp1});\6
\\{free\_number}(\\{tmp2});\6
\4${}\}{}$\2\par
\U574.\fi

\M{577}Here's a routine that prints an envelope spec in symbolic form.  It
assumes
that the \PB{\\{cur\_pen}} has not been walked around to the first offset.

\Y\B\&{static} \&{void} \\{mp\_print\_spec}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot}
\\{cur\_spec}${},\39{}$\&{mp\_knot} \\{cur\_pen}${},\39{}$\&{const} \&{char}
${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ list traversal }\6
\&{mp\_knot} \|w;\C{ the current pen offset }\7
${}\\{mp\_print\_diagnostic}(\\{mp},\39\.{"Envelope\ spec"},\39\|s,\39%
\\{true});{}$\6
${}\|p\K\\{cur\_spec};{}$\6
${}\|w\K\\{mp\_pen\_walk}(\\{mp},\39\\{cur\_pen},\39\\{mp}\MG\\{spec%
\_offset});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_print\_two}(\\{mp},\39\\{cur\_spec}\MG\\{x\_coord},\39\\{cur\_spec}%
\MG\\{y\_coord});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ \%\ beginning\ with\ o}\)\.{ffset\ "});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|w\MG\\{x\_coord},\39\|w\MG\\{y\_coord});{}$\6
\&{do}\5
${}\{{}$\1\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\X579:Print the cubic between \PB{\|p} and \PB{\|q}\X;\6
${}\|p\K\|q;{}$\6
\&{if} ${}((\|p\E\\{cur\_spec})\V(\\{mp\_knot\_info}(\|p)\I\\{zero\_off})){}$\1%
\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_knot\_info}(\|p)\I\\{zero\_off}){}$\5
${}\{{}$\1\6
\X578:Update \PB{\|w} as indicated by \PB{\\{mp\_knot\_info}(\|p)} and print an
explanation\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\\{cur\_spec});{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\ \&\ cycle"});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\fi

\M{578}\B\X578:Update \PB{\|w} as indicated by \PB{\\{mp\_knot\_info}(\|p)} and
print an explanation\X${}\E{}$\6
${}\{{}$\1\6
${}\|w\K\\{mp\_pen\_walk}(\\{mp},\39\|w,\39(\\{mp\_knot\_info}(\|p)-\\{zero%
\_off}));{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ \%\ "});{}$\6
\&{if} ${}(\\{mp\_knot\_info}(\|p)>\\{zero\_off}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"counter"});{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"clockwise\ to\ offset}\)\.{\ "});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|w\MG\\{x\_coord},\39\|w\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U577.\fi

\M{579}\B\X579:Print the cubic between \PB{\|p} and \PB{\|q}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\ \ \ ..controls\ "});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|p\MG\\{right\_x},\39\|p\MG\\{right\_y});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ and\ "});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|q\MG\\{left\_x},\39\|q\MG\\{left\_y});{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\ .."});{}$\6
${}\\{mp\_print\_two}(\\{mp},\39\|q\MG\\{x\_coord},\39\|q\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U577.\fi

\M{580}Once we have an envelope spec, the remaining task to construct the
actual
envelope by offsetting each cubic as determined by the \PB{\\{info}} fields in
the knots.  First we use \PB{\\{offset\_prep}} to convert the \PB{\|c} into an
envelope
spec. Then we add the offsets so that \PB{\|c} becomes a cyclic path that
represents
the envelope.

The \PB{\\{ljoin}} and \PB{\\{miterlim}} parameters control the treatment of
points where the
pen offset changes, and \PB{\\{lcap}} controls the endpoints of a %
\&{doublepath}.
The endpoints are easily located because \PB{\|c} is given in undoubled form
and then doubled in this procedure.  We use \PB{\\{spec\_p1}} and \PB{\\{spec%
\_p2}} to keep
track of the endpoints and treat them like very sharp corners.
Butt end caps are treated like beveled joins; round end caps are treated like
round joins; and square end caps are achieved by setting \PB{\\{join\_type}: $%
\K$ \T{3}}.

None of these parameters apply to inside joins where the convolution tracing
has retrograde lines.  In such cases we use a simple connect-the-endpoints
approach that is achieved by setting \PB{\\{join\_type}: $\K$ \T{2}}.

\Y\B\&{static} \&{mp\_knot} \\{mp\_make\_envelope}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|c${},\39{}$\&{mp\_knot} \|h${},\39{}$\&{quarterword} \\{ljoin}${},%
\39{}$\&{quarterword} \\{lcap}${},\39{}$\&{mp\_number} \\{miterlim})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \|q${},{}$ \|r${},{}$ \\{q0};\C{ for manipulating the
path }\6
\&{mp\_knot} \|w${},{}$ \\{w0};\C{ the pen knot for the current offset }\6
\&{halfword} \|k${},{}$ \\{k0};\C{ controls pen edge insertion }\6
\&{mp\_number} \\{qx}${},{}$ \\{qy};\C{ unshifted coordinates of \PB{\|q} }\7
${}\\{mp\_fraction}\\{dxin},\39\\{dyin},\39\\{dxout},\39\\{dyout}{}$;\C{
directions at \PB{\|q} when square or mitered }\7
\&{int} \\{join\_type}${}\K\T{0}{}$;\C{ codes \PB{\T{0..3}} for mitered, round,
beveled, or square }\7
\X584:Other local variables for \PB{\\{make\_envelope}}\X;\6
\\{new\_number}(\\{max\_ht});\6
\\{new\_number}(\\{tmp});\6
\\{new\_fraction}(\\{dxin});\6
\\{new\_fraction}(\\{dyin});\6
\\{new\_fraction}(\\{dxout});\6
\\{new\_fraction}(\\{dyout});\6
${}\\{mp}\MG\\{spec\_p1}\K\NULL;{}$\6
${}\\{mp}\MG\\{spec\_p2}\K\NULL;{}$\6
\\{new\_number}(\\{qx});\6
\\{new\_number}(\\{qy});\6
\X595:If endpoint, double the path \PB{\|c}, and set \PB{\\{spec\_p1}} and \PB{%
\\{spec\_p2}}\X;\6
\X581:Use \PB{\\{offset\_prep}} to compute the envelope spec then walk \PB{\|h}
around to the initial offset\X;\6
${}\|w\K\|h;{}$\6
${}\|p\K\|c;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{q0}\K\|q;{}$\6
${}\\{number\_clone}(\\{qx},\39\|q\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{qy},\39\|q\MG\\{y\_coord});{}$\6
${}\|k\K\\{mp\_knot\_info}(\|q);{}$\6
${}\\{k0}\K\|k;{}$\6
${}\\{w0}\K\|w;{}$\6
\&{if} ${}(\|k\I\\{zero\_off}){}$\5
${}\{{}$\1\6
\X582:Set \PB{\\{join\_type}} to indicate how to handle offset changes at~\PB{%
\|q}\X;\6
\4${}\}{}$\2\6
\X585:Add offset \PB{\|w} to the cubic from \PB{\|p} to \PB{\|q}\X;\6
\&{while} ${}(\|k\I\\{zero\_off}){}$\5
${}\{{}$\1\6
\X586:Step \PB{\|w} and move \PB{\|k} one step closer to \PB{\\{zero\_off}}\X;\6
\&{if} ${}((\\{join\_type}\E\T{1})\V(\|k\E\\{zero\_off})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{xtot}${},{}$ \\{ytot};\7
\\{new\_number}(\\{xtot});\6
\\{new\_number}(\\{ytot});\6
${}\\{set\_number\_from\_addition}(\\{xtot},\39\\{qx},\39\|w\MG\\{x%
\_coord});{}$\6
${}\\{set\_number\_from\_addition}(\\{ytot},\39\\{qy},\39\|w\MG\\{y%
\_coord});{}$\6
${}\|q\K\\{mp\_insert\_knot}(\\{mp},\39\|q,\39\\{xtot},\39\\{ytot});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\I\\{mp\_next\_knot}(\|p)){}$\5
${}\{{}$\1\6
\X589:Set \PB{$\|p\K\\{mp\_link}(\|p)$} and add knots between \PB{\|p} and \PB{%
\|q} as required by \PB{\\{join\_type}}\X;\6
\4${}\}{}$\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{q0}\I\|c);{}$\6
\\{free\_number}(\\{max\_ht});\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{qx});\6
\\{free\_number}(\\{qy});\6
\\{free\_number}(\\{dxin});\6
\\{free\_number}(\\{dyin});\6
\\{free\_number}(\\{dxout});\6
\\{free\_number}(\\{dyout});\6
\&{return} \|c;\6
\4${}\}{}$\2\par
\fi

\M{581}\B\X581:Use \PB{\\{offset\_prep}} to compute the envelope spec then walk
\PB{\|h} around to the initial offset\X${}\E{}$\6
$\|c\K\\{mp\_offset\_prep}(\\{mp},\39\|c,\39\|h);{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_specs})))\1\5
${}\\{mp\_print\_spec}(\\{mp},\39\|c,\39\|h,\39\.{""});{}$\2\6
$\|h\K\\{mp\_pen\_walk}(\\{mp},\39\|h,\39\\{mp}\MG\\{spec\_offset}{}$)\par
\U580.\fi

\M{582}Mitered and squared-off joins depend on path directions that are
difficult to
compute for degenerate cubics.  The envelope spec computed by \PB{\\{offset%
\_prep}} can
have degenerate cubics only if the entire cycle collapses to a single
degenerate cubic.  Setting \PB{\\{join\_type}: $\K$ \T{2}} in this case makes
the computed
envelope degenerate as well.

\Y\B\4\X582:Set \PB{\\{join\_type}} to indicate how to handle offset changes
at~\PB{\|q}\X${}\E{}$\6
\&{if} ${}(\|k<\\{zero\_off}){}$\5
${}\{{}$\1\6
${}\\{join\_type}\K\T{2};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}((\|q\I\\{mp}\MG\\{spec\_p1})\W(\|q\I\\{mp}\MG\\{spec\_p2})){}$\1\5
${}\\{join\_type}\K\\{ljoin};{}$\2\6
\&{else} \&{if} ${}(\\{lcap}\E\T{2}){}$\1\5
${}\\{join\_type}\K\T{3};{}$\2\6
\&{else}\1\5
${}\\{join\_type}\K\T{2}-\\{lcap};{}$\2\6
\&{if} ${}((\\{join\_type}\E\T{0})\V(\\{join\_type}\E\T{3})){}$\5
${}\{{}$\1\6
\X597:Set the incoming and outgoing directions at \PB{\|q}; in case of
degeneracy set \PB{\\{join\_type}: $\K$ \T{2}}\X;\6
\&{if} ${}(\\{join\_type}\E\T{0}){}$\5
${}\{{}$\1\6
\X583:If \PB{\\{miterlim}} is less than the secant of half the angle at \PB{%
\|q} then set \PB{\\{join\_type}: $\K$ \T{2}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U580.\fi

\M{583}\B\X583:If \PB{\\{miterlim}} is less than the secant of half the angle
at \PB{\|q} then set \PB{\\{join\_type}: $\K$ \T{2}}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{dxin},\39\\{dxout});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{dyin},\39\\{dyout});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
\\{number\_half}(\\{r1});\6
${}\\{number\_add}(\\{r1},\39\\{fraction\_half\_t});{}$\6
${}\\{take\_fraction}(\\{tmp},\39\\{miterlim},\39\\{r1});{}$\6
\&{if} ${}(\\{number\_less}(\\{tmp},\39\\{unity\_t})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39\\{miterlim},\39\\{tmp});{}$\6
\&{if} ${}(\\{number\_less}(\\{ret},\39\\{unity\_t})){}$\1\5
${}\\{join\_type}\K\T{2};{}$\2\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\par
\U582.\fi

\M{584}\B\X584:Other local variables for \PB{\\{make\_envelope}}\X${}\E{}$\6
\&{mp\_number} \\{tmp};\C{ a temporary value }\par
\A592.
\U580.\fi

\M{585}The coordinates of \PB{\|p} have already been shifted unless \PB{\|p} is
the first
knot in which case they get shifted at the very end.

\Y\B\4\X585:Add offset \PB{\|w} to the cubic from \PB{\|p} to \PB{\|q}\X${}%
\E{}$\6
$\\{number\_add}(\|p\MG\\{right\_x},\39\|w\MG\\{x\_coord});{}$\6
${}\\{number\_add}(\|p\MG\\{right\_y},\39\|w\MG\\{y\_coord});{}$\6
${}\\{number\_add}(\|q\MG\\{left\_x},\39\|w\MG\\{x\_coord});{}$\6
${}\\{number\_add}(\|q\MG\\{left\_y},\39\|w\MG\\{y\_coord});{}$\6
${}\\{number\_add}(\|q\MG\\{x\_coord},\39\|w\MG\\{x\_coord});{}$\6
${}\\{number\_add}(\|q\MG\\{y\_coord},\39\|w\MG\\{y\_coord});{}$\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_explicit};$ $\\{mp\_right\_type}(\|q)\K{}$%
\\{mp\_explicit}\par
\U580.\fi

\M{586}\B\X586:Step \PB{\|w} and move \PB{\|k} one step closer to \PB{\\{zero%
\_off}}\X${}\E{}$\6
\&{if} ${}(\|k>\\{zero\_off}){}$\5
${}\{{}$\1\6
${}\|w\K\\{mp\_next\_knot}(\|w);{}$\6
\\{decr}(\|k);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|w\K\\{mp\_prev\_knot}(\|w);{}$\6
\\{incr}(\|k);\6
\4${}\}{}$\2\par
\U580.\fi

\M{587}The cubic from \PB{\|q} to the new knot at \PB{$(\|x,\|y)$} becomes a
line segment and
the \PB{\\{mp\_right\_x}} and \PB{\\{mp\_right\_y}} fields of \PB{\|r} are set
from \PB{\|q}.  This is done in
case the cubic containing these control points is ``yet to be examined.''

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_knot} \\{mp\_insert\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|q${},\39{}$\&{mp\_number} \|x${},\39{}$\&{mp\_number} \|y);\par
\fi

\M{588}\B\&{mp\_knot} \\{mp\_insert\_knot}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|q${},\39{}$\&{mp\_number} \|x${},\39{}$\&{mp\_number} \|y)\1\1\2\2\6
${}\{{}$\C{ returns the inserted knot }\1\6
\&{mp\_knot} \|r;\C{ the new knot }\7
${}\|r\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_next\_knot}(\|r)\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{mp\_next\_knot}(\|q)\K\|r;{}$\6
${}\\{number\_clone}(\|r\MG\\{right\_x},\39\|q\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|r\MG\\{right\_y},\39\|q\MG\\{right\_y});{}$\6
${}\\{number\_clone}(\|r\MG\\{x\_coord},\39\|x);{}$\6
${}\\{number\_clone}(\|r\MG\\{y\_coord},\39\|y);{}$\6
${}\\{number\_clone}(\|q\MG\\{right\_x},\39\|q\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|q\MG\\{right\_y},\39\|q\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|r\MG\\{left\_x},\39\|r\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|r\MG\\{left\_y},\39\|r\MG\\{y\_coord});{}$\6
${}\\{mp\_left\_type}(\|r)\K\\{mp\_explicit};{}$\6
${}\\{mp\_right\_type}(\|r)\K\\{mp\_explicit};{}$\6
${}\\{mp\_originator}(\|r)\K\\{mp\_program\_code};{}$\6
\&{return} \|r;\6
\4${}\}{}$\2\par
\fi

\M{589}After setting \PB{\|p: $\K$ \\{mp\_link}(\|p)}, either \PB{$\\{join%
\_type}\K\T{1}$} or \PB{$\|q\K\\{mp\_link}(\|p)$}.

\Y\B\4\X589:Set \PB{$\|p\K\\{mp\_link}(\|p)$} and add knots between \PB{\|p}
and \PB{\|q} as required by \PB{\\{join\_type}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\&{if} ${}((\\{join\_type}\E\T{0})\V(\\{join\_type}\E\T{3})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{join\_type}\E\T{0}){}$\5
${}\{\X590:Insert a new knot \PB{\|r} between \PB{\|p} and \PB{\|q} as required
for a mitered join\X\}{}$\6
\&{else}\5
${}\{{}$\1\6
\X591:Make \PB{\|r} the last of two knots inserted between \PB{\|p} and \PB{%
\|q} to form a squared join\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\|r\I\NULL){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|r\MG\\{right\_x},\39\|r\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|r\MG\\{right\_y},\39\|r\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U580.\fi

\M{590}For very small angles, adding a knot is unnecessary and would cause
numerical
problems, so we just set \PB{\|r: $\K$ $\NULL$} in that case.

\Y\B\4\D$\\{near\_zero\_angle\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{near\_zero\_angle\_t}%
\par
\Y\B\4\X590:Insert a new knot \PB{\|r} between \PB{\|p} and \PB{\|q} as
required for a mitered join\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{det};\C{ a determinant used for mitered join calculations }\6
\&{mp\_number} \\{absdet};\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
\\{new\_fraction}(\\{det});\6
\\{new\_fraction}(\\{absdet});\6
${}\\{take\_fraction}(\\{r1},\39\\{dyout},\39\\{dxin});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{dxout},\39\\{dyin});{}$\6
${}\\{set\_number\_from\_substraction}(\\{det},\39\\{r1},\39\\{r2});{}$\6
${}\\{number\_clone}(\\{absdet},\39\\{det});{}$\6
\\{number\_abs}(\\{absdet});\6
\&{if} ${}(\\{number\_less}(\\{absdet},\39\\{near\_zero\_angle\_k})){}$\5
${}\{{}$\1\6
${}\|r\K\NULL{}$;\C{ sine $<10^{-4}$ }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{xtot}${},{}$ \\{ytot}${},{}$ \\{xsub}${},{}$ \\{ysub};\7
\\{new\_fraction}(\\{xsub});\6
\\{new\_fraction}(\\{ysub});\6
\\{new\_number}(\\{xtot});\6
\\{new\_number}(\\{ytot});\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{tmp},\39\\{dyout});{}$\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{tmp},\39\\{dxout});{}$\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\\{r1},\39\\{r2});{}$\6
${}\\{make\_fraction}(\\{r1},\39\\{tmp},\39\\{det});{}$\6
${}\\{number\_clone}(\\{tmp},\39\\{r1});{}$\6
${}\\{take\_fraction}(\\{xsub},\39\\{tmp},\39\\{dxin});{}$\6
${}\\{take\_fraction}(\\{ysub},\39\\{tmp},\39\\{dyin});{}$\6
${}\\{set\_number\_from\_addition}(\\{xtot},\39\|p\MG\\{x\_coord},\39%
\\{xsub});{}$\6
${}\\{set\_number\_from\_addition}(\\{ytot},\39\|p\MG\\{y\_coord},\39%
\\{ysub});{}$\6
${}\|r\K\\{mp\_insert\_knot}(\\{mp},\39\|p,\39\\{xtot},\39\\{ytot});{}$\6
\\{free\_number}(\\{xtot});\6
\\{free\_number}(\\{ytot});\6
\\{free\_number}(\\{xsub});\6
\\{free\_number}(\\{ysub});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\\{det});\6
\\{free\_number}(\\{absdet});\6
\4${}\}{}$\2\par
\U589.\fi

\M{591}\B\X591:Make \PB{\|r} the last of two knots inserted between \PB{\|p}
and \PB{\|q} to form a squared join\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{ht\_x}${},{}$ \\{ht\_y};\C{ perpendicular to the segment from
\PB{\|p} to \PB{\|q} }\6
\&{mp\_number} \\{ht\_x\_abs}${},{}$ \\{ht\_y\_abs};\C{ absolutes }\6
\&{mp\_number} \\{xtot}${},{}$ \\{ytot}${},{}$ \\{xsub}${},{}$ \\{ysub};\7
\\{new\_fraction}(\\{xsub});\6
\\{new\_fraction}(\\{ysub});\6
\\{new\_number}(\\{xtot});\6
\\{new\_number}(\\{ytot});\6
\\{new\_fraction}(\\{ht\_x});\6
\\{new\_fraction}(\\{ht\_y});\6
\\{new\_fraction}(\\{ht\_x\_abs});\6
\\{new\_fraction}(\\{ht\_y\_abs});\6
${}\\{set\_number\_from\_substraction}(\\{ht\_x},\39\|w\MG\\{y\_coord},\39%
\\{w0}\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{ht\_y},\39\\{w0}\MG\\{x\_coord},\39%
\|w\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{ht\_x\_abs},\39\\{ht\_x});{}$\6
${}\\{number\_clone}(\\{ht\_y\_abs},\39\\{ht\_y});{}$\6
\\{number\_abs}(\\{ht\_x\_abs});\6
\\{number\_abs}(\\{ht\_y\_abs});\6
\&{while} ${}(\\{number\_less}(\\{ht\_x\_abs},\39\\{fraction\_half\_t})\W%
\\{number\_less}(\\{ht\_y\_abs},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\\{number\_double}(\\{ht\_x});\6
\\{number\_double}(\\{ht\_y});\6
${}\\{number\_clone}(\\{ht\_x\_abs},\39\\{ht\_x});{}$\6
${}\\{number\_clone}(\\{ht\_y\_abs},\39\\{ht\_y});{}$\6
\\{number\_abs}(\\{ht\_x\_abs});\6
\\{number\_abs}(\\{ht\_y\_abs});\6
\4${}\}{}$\2\6
\X593:Scan the pen polygon between \PB{\\{w0}} and \PB{\|w} and make \PB{\\{max%
\_ht}} the range dot product with \PB{$(\\{ht\_x},\\{ht\_y})$}\X;\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{dxin},\39\\{ht\_x});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{dyin},\39\\{ht\_y});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{make\_fraction}(\\{tmp},\39\\{max\_ht},\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
${}\\{take\_fraction}(\\{xsub},\39\\{tmp},\39\\{dxin});{}$\6
${}\\{take\_fraction}(\\{ysub},\39\\{tmp},\39\\{dyin});{}$\6
${}\\{set\_number\_from\_addition}(\\{xtot},\39\|p\MG\\{x\_coord},\39%
\\{xsub});{}$\6
${}\\{set\_number\_from\_addition}(\\{ytot},\39\|p\MG\\{y\_coord},\39%
\\{ysub});{}$\6
${}\|r\K\\{mp\_insert\_knot}(\\{mp},\39\|p,\39\\{xtot},\39\\{ytot}){}$;\C{
clang: value never read }\6
\\{assert}(\|r);\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{dxout},\39\\{ht\_x});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{dyout},\39\\{ht\_y});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{make\_fraction}(\\{tmp},\39\\{max\_ht},\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
${}\\{take\_fraction}(\\{xsub},\39\\{tmp},\39\\{dxout});{}$\6
${}\\{take\_fraction}(\\{ysub},\39\\{tmp},\39\\{dyout});{}$\6
${}\\{set\_number\_from\_addition}(\\{xtot},\39\|q\MG\\{x\_coord},\39%
\\{xsub});{}$\6
${}\\{set\_number\_from\_addition}(\\{ytot},\39\|q\MG\\{y\_coord},\39%
\\{ysub});{}$\6
${}\|r\K\\{mp\_insert\_knot}(\\{mp},\39\|p,\39\\{xtot},\39\\{ytot});{}$\6
\\{free\_number}(\\{xsub});\6
\\{free\_number}(\\{ysub});\6
\\{free\_number}(\\{xtot});\6
\\{free\_number}(\\{ytot});\6
\\{free\_number}(\\{ht\_x});\6
\\{free\_number}(\\{ht\_y});\6
\\{free\_number}(\\{ht\_x\_abs});\6
\\{free\_number}(\\{ht\_y\_abs});\6
\4${}\}{}$\2\par
\U589.\fi

\M{592}\B\X584:Other local variables for \PB{\\{make\_envelope}}\X${}\mathrel+%
\E{}$\6
\&{mp\_number} \\{max\_ht};\C{ maximum height of the pen polygon above the \PB{%
\\{w0}}-\PB{\|w} line }\6
\&{halfword} \\{kk};\C{ keeps track of the pen vertices being scanned }\6
\&{mp\_knot} \\{ww};\C{ the pen vertex being tested }\par
\fi

\M{593}The dot product of the vector from \PB{\\{w0}} to \PB{\\{ww}} with %
\PB{$(\\{ht\_x},\\{ht\_y})$} ranges
from zero to \PB{\\{max\_ht}}.

\Y\B\4\X593:Scan the pen polygon between \PB{\\{w0}} and \PB{\|w} and make \PB{%
\\{max\_ht}} the range dot product with \PB{$(\\{ht\_x},\\{ht\_y})$}\X${}\E{}$\6
\\{set\_number\_to\_zero}(\\{max\_ht});\6
${}\\{kk}\K\\{zero\_off};{}$\6
${}\\{ww}\K\|w;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\X594:Step \PB{\\{ww}} and move \PB{\\{kk}} one step closer to \PB{\\{k0}}\X;\6
\&{if} ${}(\\{kk}\E\\{k0}){}$\1\5
\&{break};\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\\{ww}\MG\\{x\_coord},\39%
\\{w0}\MG\\{x\_coord});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{tmp},\39\\{ht\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\\{ww}\MG\\{y\_coord},\39%
\\{w0}\MG\\{y\_coord});{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{tmp},\39\\{ht\_y});{}$\6
${}\\{set\_number\_from\_addition}(\\{tmp},\39\\{r1},\39\\{r2});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{tmp},\39\\{max\_ht})){}$\1\5
${}\\{number\_clone}(\\{max\_ht},\39\\{tmp});{}$\2\6
\4${}\}{}$\2\par
\U591.\fi

\M{594}\B\X594:Step \PB{\\{ww}} and move \PB{\\{kk}} one step closer to \PB{%
\\{k0}}\X${}\E{}$\6
\&{if} ${}(\\{kk}>\\{k0}){}$\5
${}\{{}$\1\6
${}\\{ww}\K\\{mp\_next\_knot}(\\{ww});{}$\6
\\{decr}(\\{kk});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{ww}\K\\{mp\_prev\_knot}(\\{ww});{}$\6
\\{incr}(\\{kk});\6
\4${}\}{}$\2\par
\U593.\fi

\M{595}\B\X595:If endpoint, double the path \PB{\|c}, and set \PB{\\{spec\_p1}}
and \PB{\\{spec\_p2}}\X${}\E{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|c)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{spec\_p1}\K\\{mp\_htap\_ypoc}(\\{mp},\39\|c);{}$\6
${}\\{mp}\MG\\{spec\_p2}\K\\{mp}\MG\\{path\_tail};{}$\6
${}\\{mp\_originator}(\\{mp}\MG\\{spec\_p1})\K\\{mp\_program\_code};{}$\6
${}\\{mp\_next\_knot}(\\{mp}\MG\\{spec\_p2})\K\\{mp\_next\_knot}(\\{mp}\MG%
\\{spec\_p1});{}$\6
${}\\{mp\_next\_knot}(\\{mp}\MG\\{spec\_p1})\K\|c;{}$\6
${}\\{mp\_remove\_cubic}(\\{mp},\39\\{mp}\MG\\{spec\_p1});{}$\6
${}\|c\K\\{mp}\MG\\{spec\_p1};{}$\6
\&{if} ${}(\|c\I\\{mp\_next\_knot}(\|c)){}$\5
${}\{{}$\1\6
${}\\{mp\_originator}(\\{mp}\MG\\{spec\_p2})\K\\{mp\_program\_code};{}$\6
${}\\{mp\_remove\_cubic}(\\{mp},\39\\{mp}\MG\\{spec\_p2});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X596:Make \PB{\|c} look like a cycle of length one\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U580.\fi

\M{596}\B\X596:Make \PB{\|c} look like a cycle of length one\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_left\_type}(\|c)\K\\{mp\_explicit};{}$\6
${}\\{mp\_right\_type}(\|c)\K\\{mp\_explicit};{}$\6
${}\\{number\_clone}(\|c\MG\\{left\_x},\39\|c\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|c\MG\\{left\_y},\39\|c\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|c\MG\\{right\_x},\39\|c\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|c\MG\\{right\_y},\39\|c\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\par
\U595.\fi

\M{597}In degenerate situations we might have to look at the knot preceding~%
\PB{\|q}.
That knot is \PB{\|p} but if \PB{$\|p\MRL{{<}{>}}\|c$}, its coordinates have
already been offset by \PB{\|w}.

\Y\B\4\X597:Set the incoming and outgoing directions at \PB{\|q}; in case of
degeneracy set \PB{\\{join\_type}: $\K$ \T{2}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxin},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyin},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxin})\W\\{number\_zero}(\\{dyin})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxin},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyin},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{right\_y});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxin})\W\\{number\_zero}(\\{dyin})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxin},\39\|q\MG\\{x\_coord},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyin},\39\|q\MG\\{y\_coord},\39\|p\MG%
\\{y\_coord});{}$\6
\&{if} ${}(\|p\I\|c){}$\5
${}\{{}$\C{ the coordinates of \PB{\|p} have been offset by \PB{\|w} }\1\6
${}\\{number\_add}(\\{dxin},\39\|w\MG\\{x\_coord});{}$\6
${}\\{number\_add}(\\{dyin},\39\|w\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{pyth\_add}(\\{tmp},\39\\{dxin},\39\\{dyin});{}$\6
\&{if} (\\{number\_zero}(\\{tmp}))\5
${}\{{}$\1\6
${}\\{join\_type}\K\T{2};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\\{r1},\39\\{dxin},\39\\{tmp});{}$\6
${}\\{number\_clone}(\\{dxin},\39\\{r1});{}$\6
${}\\{make\_fraction}(\\{r1},\39\\{dyin},\39\\{tmp});{}$\6
${}\\{number\_clone}(\\{dyin},\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\X598:Set the outgoing direction at \PB{\|q}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U582.\fi

\M{598}If \PB{$\|q\K\|c$} then the coordinates of \PB{\|r} and the control
points between \PB{\|q}
and~\PB{\|r} have already been offset by \PB{\|h}.

\Y\B\4\X598:Set the outgoing direction at \PB{\|q}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxout},\39\|q\MG\\{right\_x},\39\|q%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyout},\39\|q\MG\\{right\_y},\39\|q%
\MG\\{y\_coord});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxout})\W\\{number\_zero}(\\{dyout})){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{set\_number\_from\_substraction}(\\{dxout},\39\|r\MG\\{left\_x},\39\|q\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyout},\39\|r\MG\\{left\_y},\39\|q\MG%
\\{y\_coord});{}$\6
\&{if} ${}(\\{number\_zero}(\\{dxout})\W\\{number\_zero}(\\{dyout})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{dxout},\39\|r\MG\\{x\_coord},\39\|q%
\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{dyout},\39\|r\MG\\{y\_coord},\39\|q%
\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\E\|c){}$\5
${}\{{}$\1\6
${}\\{number\_substract}(\\{dxout},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_substract}(\\{dyout},\39\|h\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
${}\\{pyth\_add}(\\{tmp},\39\\{dxout},\39\\{dyout});{}$\6
\&{if} (\\{number\_zero}(\\{tmp}))\5
${}\{{}$\C{ \PB{$\\{mp\_confusion}(\\{mp},\.{"degenerate\ spec"});$} }\1\6
;\C{ But apparently, it actually can happen. The test case is this:    path p;
 linejoin := mitered;   p:= (10,0)..(0,10)..(-10,0)..(0,-10)..cycle;   addto
currentpicture contour p withpen pensquare;    The reason for failure here is
the addition of \PB{$\|r\I\|q$} in revision 1757   in ``Advance \PB{\|p} to
node \PB{\|q}, removing any ``dead'' cubics'', which itself   was needed to fix
a bug with disappearing knots in a path that was rotated   exactly 45 degrees
(luatex.org bug 530).      }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\\{r1},\39\\{dxout},\39\\{tmp});{}$\6
${}\\{number\_clone}(\\{dxout},\39\\{r1});{}$\6
${}\\{make\_fraction}(\\{r1},\39\\{dyout},\39\\{tmp});{}$\6
${}\\{number\_clone}(\\{dyout},\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U597.\fi

\N{1}{599}Direction and intersection times.
A path of length $n$ is defined parametrically by functions $x(t)$ and
$y(t)$, for \PB{$\T{0}\Z\|t\Z\|n$}; we can regard $t$ as the ``time'' at which
the path
reaches the point $\bigl(x(t),y(t)\bigr)$.  In this section of the program
we shall consider operations that determine special times associated with
given paths: the first time that a path travels in a given direction, and
a pair of times at which two paths cross each other.

\fi

\M{600}Let's start with the easier task. The function \PB{\\{find\_direction%
\_time}} is
given a direction \PB{$(\|x,\|y)$} and a path starting at~\PB{\|h}. If the path
never
travels in direction \PB{$(\|x,\|y)$}, the direction time will be~\PB{${-}%
\T{1}$}; otherwise
it will be nonnegative.

Certain anomalous cases can arise: If \PB{$(\|x,\|y)\K(\T{0},\T{0})$}, so that
the given
direction is undefined, the direction time will be~0. If $\bigl(x'(t),
y'(t)\bigr)=(0,0)$, so that the path direction is undefined, it will be
assumed to match any given direction at time~\PB{\|t}.

The routine solves this problem in nondegenerate cases by rotating the path
and the given direction so that \PB{$(\|x,\|y)\K(\T{1},\T{0})$}; i.e., the main
task will be
to find when a given path first travels ``due east.''

\Y\B\&{static} \&{void} \\{mp\_find\_direction\_time}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \\{x\_orig}${},\39{}$\&{mp%
\_number} \\{y\_orig}${},\39{}$\&{mp\_knot} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{max};\C{ $\max\bigl(\vert x\vert,\vert y\vert\bigr)$ }\6
\&{mp\_knot} \|p${},{}$ \|q;\C{ for list traversal }\6
\&{mp\_number} \|n;\C{ the direction time at knot \PB{\|p} }\6
\&{mp\_number} \\{tt};\C{ the direction time within a cubic }\6
\&{mp\_number} \|x${},{}$ \|y;\6
\&{mp\_number} \\{abs\_x}${},{}$ \\{abs\_y};\C{ Other local variables for \PB{%
\\{find\_direction\_time}} }\6
\&{mp\_number} \\{x1}${},{}$ \\{x2}${},{}$ \\{x3}${},{}$ \\{y1}${},{}$ %
\\{y2}${},{}$ \\{y3};\C{ multiples of rotated derivatives }\6
\&{mp\_number} \\{phi};\C{ angles of exit and entry at a knot }\6
\&{mp\_number} \|t;\C{ temp storage }\6
\&{mp\_number} \\{ab\_vs\_cd};\7
\\{new\_number}(\\{max});\6
\\{new\_number}(\\{x1});\6
\\{new\_number}(\\{x2});\6
\\{new\_number}(\\{x3});\6
\\{new\_number}(\\{y1});\6
\\{new\_number}(\\{y2});\6
\\{new\_number}(\\{y3});\6
\\{new\_fraction}(\|t);\6
\\{new\_angle}(\\{phi});\6
\\{new\_number}(\\{ab\_vs\_cd});\6
${}\\{set\_number\_to\_zero}({*}\\{ret}){}$;\C{ just in case }\6
\\{new\_number}(\|x);\6
\\{new\_number}(\|y);\6
\\{new\_number}(\\{abs\_x});\6
\\{new\_number}(\\{abs\_y});\6
\\{new\_number}(\|n);\6
\\{new\_fraction}(\\{tt});\6
${}\\{number\_clone}(\|x,\39\\{x\_orig});{}$\6
${}\\{number\_clone}(\|y,\39\\{y\_orig});{}$\6
${}\\{number\_clone}(\\{abs\_x},\39\\{x\_orig});{}$\6
${}\\{number\_clone}(\\{abs\_y},\39\\{y\_orig});{}$\6
\\{number\_abs}(\\{abs\_x});\6
\\{number\_abs}(\\{abs\_y});\C{ Normalize the given direction for better
accuracy;      but \PB{\&{return}} with zero result if it's zero }\6
\&{if} ${}(\\{number\_less}(\\{abs\_x},\39\\{abs\_y})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\\{r1},\39\|x,\39\\{abs\_y});{}$\6
${}\\{number\_clone}(\|x,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\&{if} (\\{number\_positive}(\|y))\5
${}\{{}$\1\6
${}\\{number\_clone}(\|y,\39\\{fraction\_one\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|y,\39\\{fraction\_one\_t});{}$\6
\\{number\_negate}(\|y);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_zero}(\|x))\5
${}\{{}$\1\6
\&{goto} \.{FREE};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_fraction}(\\{r1});\6
${}\\{make\_fraction}(\\{r1},\39\|y,\39\\{abs\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\&{if} (\\{number\_positive}(\|x))\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{fraction\_one\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{fraction\_one\_t});{}$\6
\\{number\_negate}(\|x);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|p\K\|h;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\1\5
\&{break};\2\6
${}\|q\K\\{mp\_next\_knot}(\|p);{}$\6
\X601:Rotate the cubic between \PB{\|p} and \PB{\|q}; then \PB{\&{goto} %
\\{found}} if the rotated cubic travels due east at some time \PB{\\{tt}}; but %
\PB{\&{break}} if an entire cyclic path has been traversed\X;\6
${}\|p\K\|q;{}$\6
${}\\{number\_add}(\|n,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
${}\\{number\_negate}({*}\\{ret});{}$\6
\&{goto} \.{FREE};\6
\4\.{FOUND}:\5
${}\\{set\_number\_from\_addition}({*}\\{ret},\39\|n,\39\\{tt});{}$\6
\&{goto} \.{FREE};\6
\4\.{FREE}:\5
\\{free\_number}(\|x);\6
\\{free\_number}(\|y);\6
\\{free\_number}(\\{abs\_x});\6
\\{free\_number}(\\{abs\_y});\C{ Free local variables for \PB{\\{find%
\_direction\_time}} }\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{x2});\6
\\{free\_number}(\\{x3});\6
\\{free\_number}(\\{y1});\6
\\{free\_number}(\\{y2});\6
\\{free\_number}(\\{y3});\6
\\{free\_number}(\|t);\6
\\{free\_number}(\\{phi});\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\\{free\_number}(\|n);\6
\\{free\_number}(\\{max});\6
\\{free\_number}(\\{tt});\6
\4${}\}{}$\2\par
\fi

\M{601}Since we're interested in the tangent directions, we work with the
derivative $${1\over3}B'(x_0,x_1,x_2,x_3;t)=
B(x_1-x_0,x_2-x_1,x_3-x_2;t)$$ instead of
$B(x_0,x_1,x_2,x_3;t)$ itself. The derived coefficients are also scale-d up
in order to achieve better accuracy.

The given path may turn abruptly at a knot, and it might pass the critical
tangent direction at such a time. Therefore we remember the direction \PB{%
\\{phi}}
in which the previous rotated cubic was traveling. (The value of \PB{\\{phi}}
will be
undefined on the first cubic, i.e., when \PB{$\|n\K\T{0}$}.)

\Y\B\4\D$\\{we\_found\_it}$ \6
${}\{{}$\1\6
${}\\{number\_clone}(\\{tt},\39\|t);{}$\6
\\{fraction\_to\_round\_scaled}(\\{tt});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\par
\Y\B\4\X601:Rotate the cubic between \PB{\|p} and \PB{\|q}; then \PB{\&{goto} %
\\{found}} if the rotated cubic travels due east at some time \PB{\\{tt}}; but %
\PB{\&{break}} if an entire cyclic path has been traversed\X${}\E{}$\6
\\{set\_number\_to\_zero}(\\{tt});\C{ Set local variables \PB{$\\{x1},\\{x2},%
\\{x3}$} and \PB{$\\{y1},\\{y2},\\{y3}$} to multiples of the control    points
of the rotated derivatives }\6
${}\{{}$\1\6
\&{mp\_number} \\{absval};\7
\\{new\_number}(\\{absval});\6
${}\\{set\_number\_from\_substraction}(\\{x1},\39\|p\MG\\{right\_x},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x2},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x3},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y1},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y2},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y3},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
${}\\{number\_clone}(\\{absval},\39\\{x2});{}$\6
\\{number\_abs}(\\{absval});\6
${}\\{number\_clone}(\\{max},\39\\{x1});{}$\6
\\{number\_abs}(\\{max});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{x3});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y1});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y2});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max},\39\\{absval});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absval},\39\\{y3});{}$\6
\\{number\_abs}(\\{absval});\6
\&{if} ${}(\\{number\_greater}(\\{absval},\39\\{max})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{max},\39\\{absval});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absval});\6
\&{if} (\\{number\_zero}(\\{max}))\1\5
\&{goto} \.{FOUND};\2\6
\&{while} ${}(\\{number\_less}(\\{max},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\\{number\_double}(\\{max});\6
\\{number\_double}(\\{x1});\6
\\{number\_double}(\\{x2});\6
\\{number\_double}(\\{x3});\6
\\{number\_double}(\\{y1});\6
\\{number\_double}(\\{y2});\6
\\{number\_double}(\\{y3});\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\|t,\39\\{x1});{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_fraction}(\\{r2});\6
${}\\{take\_fraction}(\\{r1},\39\\{x1},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{y1},\39\|y);{}$\6
${}\\{set\_number\_from\_addition}(\\{x1},\39\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y1},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\|t,\39\|y);{}$\6
${}\\{set\_number\_from\_substraction}(\\{y1},\39\\{r1},\39\\{r2});{}$\6
${}\\{number\_clone}(\|t,\39\\{x2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x2},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{y2},\39\|y);{}$\6
${}\\{set\_number\_from\_addition}(\\{x2},\39\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y2},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\|t,\39\|y);{}$\6
${}\\{set\_number\_from\_substraction}(\\{y2},\39\\{r1},\39\\{r2});{}$\6
${}\\{number\_clone}(\|t,\39\\{x3});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{x3},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\\{y3},\39\|y);{}$\6
${}\\{set\_number\_from\_addition}(\\{x3},\39\\{r1},\39\\{r2});{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{y3},\39\|x);{}$\6
${}\\{take\_fraction}(\\{r2},\39\|t,\39\|y);{}$\6
${}\\{set\_number\_from\_substraction}(\\{y3},\39\\{r1},\39\\{r2});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{number\_zero}(\\{y1}))\1\6
\&{if} ${}(\\{number\_zero}(\\{x1})\V\\{number\_positive}(\\{x1})){}$\1\5
\&{goto} \.{FOUND};\2\2\6
\&{if} (\\{number\_positive}(\|n))\5
${}\{{}$\C{ Exit to \PB{\\{found}} if an eastward direction occurs at knot \PB{%
\|p} }\1\6
\&{mp\_number} \\{theta};\6
\&{mp\_number} \\{tmp};\7
\\{new\_angle}(\\{theta});\6
${}\\{n\_arg}(\\{theta},\39\\{x1},\39\\{y1});{}$\6
\\{new\_angle}(\\{tmp});\6
${}\\{set\_number\_from\_substraction}(\\{tmp},\39\\{theta},\39\\{one\_eighty%
\_deg\_t});{}$\6
\&{if} ${}(\\{number\_nonnegative}(\\{theta})\W\\{number\_nonpositive}(\\{phi})%
\W\\{number\_greaterequal}(\\{phi},\39\\{tmp})){}$\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{theta});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_addition}(\\{tmp},\39\\{theta},\39\\{one\_eighty\_deg%
\_t});{}$\6
\&{if} ${}(\\{number\_nonpositive}(\\{theta})\W\\{number\_nonnegative}(\\{phi})%
\W\\{number\_lessequal}(\\{phi},\39\\{tmp})){}$\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{theta});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{theta});\6
\&{if} ${}(\|p\E\|h){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_nonzero}(\\{x3})\V\\{number\_nonzero}(\\{y3})){}$\5
${}\{{}$\1\6
${}\\{n\_arg}(\\{phi},\39\\{x3},\39\\{y3});{}$\6
\4${}\}{}$\C{ Exit to \PB{\\{found}} if the curve whose derivatives are
specified by    \PB{$\\{x1},\\{x2},\\{x3},\\{y1},\\{y2},\\{y3}$} travels
eastward at some time~\PB{\\{tt}} }\C{ In this step we want to use the \PB{%
\\{crossing\_point}} routine to find the roots of the quadratic equation
$B(y_1,y_2,y_3;t)=0$. Several complications arise: If the quadratic equation
has a double root, the curve never crosses zero, and \PB{\\{crossing\_point}}
will find nothing; this case occurs iff $y_1y_3=y_2^2$ and $y_1y_2<0$. If the
quadratic equation has simple roots, or only one root, we may have to negate it
so that $B(y_1,y_2,y_3;t)$ crosses from positive to negative at its first root.
And finally, we need to do special things if $B(y_1,y_2,y_3;t)$ is identically
zero. }\2\6
\&{if} (\\{number\_negative}(\\{x1}))\1\6
\&{if} (\\{number\_negative}(\\{x2}))\1\6
\&{if} (\\{number\_negative}(\\{x3}))\1\5
\&{goto} \.{DONE};\2\2\2\6
${}\{{}$\1\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{y1},\39\\{y3},\39\\{y2},\39\\{y2});{}$\6
\&{if} (\\{number\_zero}(\\{ab\_vs\_cd}))\5
${}\{{}$\C{ Handle the test for eastward directions when $y_1y_3=y_2^2$;
either \PB{\&{goto} \\{found}} or \PB{\&{goto} \\{done}} }\1\6
${}\{{}$\1\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{y1},\39\\{y2},\39\\{zero\_t},\39\\{zero%
\_t});{}$\6
\&{if} (\\{number\_negative}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
\&{mp\_number} \\{tmp}${},{}$ \\{arg2};\7
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{y1},\39\\{y2});{}$\6
${}\\{make\_fraction}(\|t,\39\\{y1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg2});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\\{x2},\39\\{x3});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp},\39\|t,\39\\{x1},\39\\{x2});{}$\6
\&{if} ${}(\\{number\_zero}(\\{tmp})\V\\{number\_positive}(\\{tmp})){}$\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
\\{we\_found\_it};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_zero}(\\{y3}))\5
${}\{{}$\1\6
\&{if} (\\{number\_zero}(\\{y1}))\5
${}\{{}$\C{ Exit to \PB{\\{found}} if the derivative $B(x_1,x_2,x_3;t)$ becomes
\PB{$\G$ \T{0}} }\C{ At this point we know that the derivative of \PB{\|y(\|t)}
is identically zero, and that \PB{$\\{x1}<\T{0}$}; but either \PB{$\\{x2}\G%
\T{0}$} or \PB{$\\{x3}\G\T{0}$}, so there's some hope of traveling east. }\1\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
${}\\{number\_clone}(\\{arg1},\39\\{x1});{}$\6
\\{number\_negate}(\\{arg1});\6
${}\\{number\_clone}(\\{arg2},\39\\{x2});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{number\_clone}(\\{arg3},\39\\{x3});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\|t,\39\\{arg1},\39\\{arg2},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\&{if} ${}(\\{number\_lessequal}(\|t,\39\\{fraction\_one\_t})){}$\1\5
\\{we\_found\_it};\2\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{x1},\39\\{x3},\39\\{x2},\39\\{x2});{}$\6
\&{if} (\\{number\_nonpositive}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg2};\7
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{x1},\39\\{x2});{}$\6
${}\\{make\_fraction}(\|t,\39\\{x1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg2});\6
\\{we\_found\_it};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_zero}(\\{x3})\V\\{number\_positive}(\\{x3})){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_unity}(\\{tt});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_zero}(\\{y1})\V\\{number\_negative}(\\{y1})){}$\5
${}\{{}$\1\6
\&{if} (\\{number\_negative}(\\{y1}))\5
${}\{{}$\1\6
\\{number\_negate}(\\{y1});\6
\\{number\_negate}(\\{y2});\6
\\{number\_negate}(\\{y3});\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{y2}))\5
${}\{{}$\1\6
\\{number\_negate}(\\{y2});\6
\\{number\_negate}(\\{y3});\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ Check the places where $B(y_1,y_2,y_3;t)=0$ to see if
$B(x_1,x_2,x_3;t)\ge0$ }\C{ The quadratic polynomial $B(y_1,y_2,y_3;t)$ begins %
\PB{$\G$ \T{0}} and has at most two roots, because we know that it isn't
identically zero.  It must be admitted that the \PB{\\{crossing\_point}}
routine is not perfectly accurate; rounding errors might cause it to find a
root when $y_1y_3>y_2^2$, or to miss the roots when $y_1y_3<y_2^2$. The
rotation process is itself subject to rounding errors. Yet this code
optimistically tries to do the right thing.  }\2\6
${}\\{crossing\_point}(\|t,\39\\{y1},\39\\{y2},\39\\{y3});{}$\6
\&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\1\5
\&{goto} \.{DONE};\2\6
${}\\{set\_number\_from\_of\_the\_way}(\\{y2},\39\|t,\39\\{y2},\39\\{y3});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\\{x2},\39\\{x3});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
\&{if} ${}(\\{number\_zero}(\\{x1})\V\\{number\_positive}(\\{x1})){}$\1\5
\\{we\_found\_it};\2\6
\&{if} (\\{number\_positive}(\\{y2}))\1\5
\\{set\_number\_to\_zero}(\\{y2});\2\6
${}\\{number\_clone}(\\{tt},\39\|t);{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2}${},{}$ \\{arg3};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{arg3});\6
${}\\{number\_clone}(\\{arg2},\39\\{y2});{}$\6
\\{number\_negate}(\\{arg2});\6
${}\\{number\_clone}(\\{arg3},\39\\{y3});{}$\6
\\{number\_negate}(\\{arg3});\6
${}\\{crossing\_point}(\|t,\39\\{arg1},\39\\{arg2},\39\\{arg3});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{arg3});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\|t,\39\\{fraction\_one\_t})){}$\1\5
\&{goto} \.{DONE};\2\6
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\7
\\{new\_number}(\\{tmp});\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x1},\39\|t,\39\\{x1},\39\\{x2});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{x2},\39\|t,\39\\{x2},\39\\{x3});{}$\6
${}\\{set\_number\_from\_of\_the\_way}(\\{tmp},\39\|t,\39\\{x1},\39\\{x2});{}$\6
\&{if} (\\{number\_nonnegative}(\\{tmp}))\5
${}\{{}$\1\6
\\{free\_number}(\\{tmp});\6
${}\\{set\_number\_from\_of\_the\_way}(\|t,\39\|t,\39\\{tt},\39\\{fraction\_one%
\_t});{}$\6
\\{we\_found\_it};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
\.{DONE}:\par
\U600.\fi

\M{602}The intersection of two cubics can be found by an interesting variant
of the general bisection scheme described in the introduction to
\PB{\\{crossing\_point}}.\
Given $w(t)=B(w_0,w_1,w_2,w_3;t)$ and $z(t)=B(z_0,z_1,z_2,z_3;t)$,
we wish to find a pair of times $(t_1,t_2)$ such that $w(t_1)=z(t_2)$,
if an intersection exists. First we find the smallest rectangle that
encloses the points $\{w_0,w_1,w_2,w_3\}$ and check that it overlaps
the smallest rectangle that encloses
$\{z_0,z_1,z_2,z_3\}$; if not, the cubics certainly don't intersect.
But if the rectangles do overlap, we bisect the intervals, getting
new cubics $w'$ and~$w''$, $z'$~and~$z''$; the intersection routine first
tries for an intersection between $w'$ and~$z'$, then (if unsuccessful)
between $w'$ and~$z''$, then (if still unsuccessful) between $w''$ and~$z'$,
finally (if thrice unsuccessful) between $w''$ and~$z''$. After $l$~successful
levels of bisection we will have determined the intersection times $t_1$
and~$t_2$ to $l$~bits of accuracy.

\def\submin{_{\rm min}} \def\submax{_{\rm max}}
As before, it is better to work with the numbers $W_k=2^l(w_k-w_{k-1})$
and $Z_k=2^l(z_k-z_{k-1})$ rather than the coefficients $w_k$ and $z_k$
themselves. We also need one other quantity, $\Delta=2^l(w_0-z_0)$,
to determine when the enclosing rectangles overlap. Here's why:
The $x$~coordinates of~$w(t)$ are between $u\submin$ and $u\submax$,
and the $x$~coordinates of~$z(t)$ are between $x\submin$ and $x\submax$,
if we write $w_k=(u_k,v_k)$ and $z_k=(x_k,y_k)$ and $u\submin=
\min(u_0,u_1,u_2,u_3)$, etc. These intervals of $x$~coordinates
overlap if and only if $u\submin\L x\submax$ and
$x\submin\L u\submax$. Letting
$$U\submin=\min(0,U_1,U_1+U_2,U_1+U_2+U_3),\;
U\submax=\max(0,U_1,U_1+U_2,U_1+U_2+U_3),$$
we have $2^lu\submin=2^lu_0+U\submin$, etc.; the condition for overlap
reduces to
$$X\submin-U\submax\L 2^l(u_0-x_0)\L X\submax-U\submin.$$
Thus we want to maintain the quantity $2^l(u_0-x_0)$; similarly,
the quantity $2^l(v_0-y_0)$ accounts for the $y$~coordinates. The
coordinates of $\Delta=2^l(w_0-z_0)$ must stay bounded as $l$ increases,
because of the overlap condition; i.e., we know that $X\submin$,
$X\submax$, and their relatives are bounded, hence $X\submax-
U\submin$ and $X\submin-U\submax$ are bounded.

\fi

\M{603}Incidentally, if the given cubics intersect more than once, the process
just sketched will not necessarily find the lexicographically smallest pair
$(t_1,t_2)$. The solution actually obtained will be smallest in ``shuffled
order''; i.e., if $t_1=(.a_1a_2\ldots a_{16})_2$ and
$t_2=(.b_1b_2\ldots b_{16})_2$, then we will minimize
$a_1b_1a_2b_2\ldots a_{16}b_{16}$, not
$a_1a_2\ldots a_{16}b_1b_2\ldots b_{16}$.
Shuffled order agrees with lexicographic order if all pairs of solutions
$(t_1,t_2)$ and $(t_1',t_2')$ have the property that $t_1<t_1'$ iff
$t_2<t_2'$; but in general, lexicographic order can be quite different,
and the bisection algorithm would be substantially less efficient if it were
constrained by lexicographic order.

For example, suppose that an overlap has been found for $l=3$ and
$(t_1,t_2)= (.101,.011)$ in binary, but that no overlap is produced by
either of the alternatives $(.1010,.0110)$, $(.1010,.0111)$ at level~4.
Then there is probably an intersection in one of the subintervals
$(.1011,.011x)$; but lexicographic order would require us to explore
$(.1010,.1xxx)$ and $(.1011,.00xx)$ and $(.1011,.010x)$ first. We wouldn't
want to store all of the subdivision data for the second path, so the
subdivisions would have to be regenerated many times. Such inefficiencies
would be associated with every `1' in the binary representation of~$t_1$.

\fi

\M{604}The subdivision process introduces rounding errors, hence we need to
make a more liberal test for overlap. It is not hard to show that the
computed values of $U_i$ differ from the truth by at most~$l$, on
level~$l$, hence $U\submin$ and $U\submax$ will be at most $3l$ in error.
If $\beta$ is an upper bound on the absolute error in the computed
components of $\Delta=(\PB{\\{delx}},\PB{\\{dely}})$ on level~$l$, we will
replace
the test `$X\submin-U\submax\L\PB{\\{delx}}$' by the more liberal test
`$X\submin-U\submax\L\PB{\\{delx}}+\PB{\\{tol}}$', where $\PB{\\{tol}}=6l+%
\beta$.

More accuracy is obtained if we try the algorithm first with \PB{$\\{tol}\K%
\T{0}$};
the more liberal tolerance is used only if an exact approach fails.
It is convenient to do this double-take by letting `3' in the preceding
paragraph be a parameter, which is first 0, then 3.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{unsigned} \&{int} \\{tol\_step};\C{ either 0 or 3, usually }\par
\fi

\M{605}We shall use an explicit stack to implement the recursive bisection
method described above. The \PB{\\{bisect\_stack}} array will contain numerous
5-word
packets like $(U_1,U_2,U_3,U\submin,U\submax)$, as well as 20-word packets
comprising the 5-word packets for $U$, $V$, $X$, and~$Y$.

The following macros define the allocation of stack positions to
the quantities needed for bisection-intersection.

\Y\B\4\D$\\{stack\_1}(\|A)$ \5
$\\{mp}\MG\\{bisect\_stack}{}$[(\|A)]\C{ $U_1$, $V_1$, $X_1$, or $Y_1$ }\par
\B\4\D$\\{stack\_2}(\|A)$ \5
$\\{mp}\MG\\{bisect\_stack}[(\|A)+\T{1}{}$]\C{ $U_2$, $V_2$, $X_2$, or $Y_2$ }%
\par
\B\4\D$\\{stack\_3}(\|A)$ \5
$\\{mp}\MG\\{bisect\_stack}[(\|A)+\T{2}{}$]\C{ $U_3$, $V_3$, $X_3$, or $Y_3$ }%
\par
\B\4\D$\\{stack\_min}(\|A)$ \5
$\\{mp}\MG\\{bisect\_stack}[(\|A)+\T{3}{}$]\C{ $U\submin$, $V\submin$, $X%
\submin$, or $Y\submin$ }\par
\B\4\D$\\{stack\_max}(\|A)$ \5
$\\{mp}\MG\\{bisect\_stack}[(\|A)+\T{4}{}$]\C{ $U\submax$, $V\submax$, $X%
\submax$, or $Y\submax$ }\par
\B\4\D$\\{int\_packets}$ \5
\T{20}\C{ number of words to represent $U_k$, $V_k$, $X_k$, and $Y_k$ }\Y\par
\B\4\D$\\{u\_packet}(\|A)$ \5
$((\|A)-\T{5}{}$)\par
\B\4\D$\\{v\_packet}(\|A)$ \5
$((\|A)-\T{10}{}$)\par
\B\4\D$\\{x\_packet}(\|A)$ \5
$((\|A)-\T{15}{}$)\par
\B\4\D$\\{y\_packet}(\|A)$ \5
$((\|A)-\T{20}{}$)\par
\B\4\D$\\{l\_packets}$ \5
$(\\{mp}\MG\\{bisect\_ptr}-\\{int\_packets}{}$)\par
\B\4\D$\\{r\_packets}$ \5
$\\{mp}\MG{}$\\{bisect\_ptr}\par
\B\4\D$\\{ul\_packet}$ \5
\\{u\_packet}(\\{l\_packets})\C{ base of $U'_k$ variables }\par
\B\4\D$\\{vl\_packet}$ \5
\\{v\_packet}(\\{l\_packets})\C{ base of $V'_k$ variables }\par
\B\4\D$\\{xl\_packet}$ \5
\\{x\_packet}(\\{l\_packets})\C{ base of $X'_k$ variables }\par
\B\4\D$\\{yl\_packet}$ \5
\\{y\_packet}(\\{l\_packets})\C{ base of $Y'_k$ variables }\par
\B\4\D$\\{ur\_packet}$ \5
\\{u\_packet}(\\{r\_packets})\C{ base of $U''_k$ variables }\par
\B\4\D$\\{vr\_packet}$ \5
\\{v\_packet}(\\{r\_packets})\C{ base of $V''_k$ variables }\par
\B\4\D$\\{xr\_packet}$ \5
\\{x\_packet}(\\{r\_packets})\C{ base of $X''_k$ variables }\par
\B\4\D$\\{yr\_packet}$ \5
\\{y\_packet}(\\{r\_packets})\C{ base of $Y''_k$ variables }\Y\par
\B\4\D$\\{u1l}$ \5
\\{stack\_1}(\\{ul\_packet})\C{ $U'_1$ }\par
\B\4\D$\\{u2l}$ \5
\\{stack\_2}(\\{ul\_packet})\C{ $U'_2$ }\par
\B\4\D$\\{u3l}$ \5
\\{stack\_3}(\\{ul\_packet})\C{ $U'_3$ }\par
\B\4\D$\\{v1l}$ \5
\\{stack\_1}(\\{vl\_packet})\C{ $V'_1$ }\par
\B\4\D$\\{v2l}$ \5
\\{stack\_2}(\\{vl\_packet})\C{ $V'_2$ }\par
\B\4\D$\\{v3l}$ \5
\\{stack\_3}(\\{vl\_packet})\C{ $V'_3$ }\par
\B\4\D$\\{x1l}$ \5
\\{stack\_1}(\\{xl\_packet})\C{ $X'_1$ }\par
\B\4\D$\\{x2l}$ \5
\\{stack\_2}(\\{xl\_packet})\C{ $X'_2$ }\par
\B\4\D$\\{x3l}$ \5
\\{stack\_3}(\\{xl\_packet})\C{ $X'_3$ }\par
\B\4\D$\\{y1l}$ \5
\\{stack\_1}(\\{yl\_packet})\C{ $Y'_1$ }\par
\B\4\D$\\{y2l}$ \5
\\{stack\_2}(\\{yl\_packet})\C{ $Y'_2$ }\par
\B\4\D$\\{y3l}$ \5
\\{stack\_3}(\\{yl\_packet})\C{ $Y'_3$ }\par
\B\4\D$\\{u1r}$ \5
\\{stack\_1}(\\{ur\_packet})\C{ $U''_1$ }\par
\B\4\D$\\{u2r}$ \5
\\{stack\_2}(\\{ur\_packet})\C{ $U''_2$ }\par
\B\4\D$\\{u3r}$ \5
\\{stack\_3}(\\{ur\_packet})\C{ $U''_3$ }\par
\B\4\D$\\{v1r}$ \5
\\{stack\_1}(\\{vr\_packet})\C{ $V''_1$ }\par
\B\4\D$\\{v2r}$ \5
\\{stack\_2}(\\{vr\_packet})\C{ $V''_2$ }\par
\B\4\D$\\{v3r}$ \5
\\{stack\_3}(\\{vr\_packet})\C{ $V''_3$ }\par
\B\4\D$\\{x1r}$ \5
\\{stack\_1}(\\{xr\_packet})\C{ $X''_1$ }\par
\B\4\D$\\{x2r}$ \5
\\{stack\_2}(\\{xr\_packet})\C{ $X''_2$ }\par
\B\4\D$\\{x3r}$ \5
\\{stack\_3}(\\{xr\_packet})\C{ $X''_3$ }\par
\B\4\D$\\{y1r}$ \5
\\{stack\_1}(\\{yr\_packet})\C{ $Y''_1$ }\par
\B\4\D$\\{y2r}$ \5
\\{stack\_2}(\\{yr\_packet})\C{ $Y''_2$ }\par
\B\4\D$\\{y3r}$ \5
\\{stack\_3}(\\{yr\_packet})\C{ $Y''_3$ }\Y\par
\B\4\D$\\{stack\_dx}$ \5
$\\{mp}\MG\\{bisect\_stack}[\\{mp}\MG\\{bisect\_ptr}{}$]\C{ stacked value of %
\PB{\\{delx}} }\par
\B\4\D$\\{stack\_dy}$ \5
$\\{mp}\MG\\{bisect\_stack}[\\{mp}\MG\\{bisect\_ptr}+\T{1}{}$]\C{ stacked value
of \PB{\\{dely}} }\par
\B\4\D$\\{stack\_tol}$ \5
$\\{mp}\MG\\{bisect\_stack}[\\{mp}\MG\\{bisect\_ptr}+\T{2}{}$]\C{ stacked value
of \PB{\\{tol}} }\par
\B\4\D$\\{stack\_uv}$ \5
$\\{mp}\MG\\{bisect\_stack}[\\{mp}\MG\\{bisect\_ptr}+\T{3}{}$]\C{ stacked value
of \PB{\\{uv}} }\par
\B\4\D$\\{stack\_xy}$ \5
$\\{mp}\MG\\{bisect\_stack}[\\{mp}\MG\\{bisect\_ptr}+\T{4}{}$]\C{ stacked value
of \PB{\\{xy}} }\par
\B\4\D$\\{int\_increment}$ \5
$(\\{int\_packets}+\\{int\_packets}+\T{5}{}$)\C{ number of stack words per
level }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} ${}{*}\\{bisect\_stack};{}$\6
\&{integer} \\{bisect\_ptr};\par
\fi

\M{606}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{bisect\_stack}\K\\{xmalloc}((\\{bistack\_size}+\T{1}),\39%
\&{sizeof}(\&{mp\_number}));{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{bistack\_size}+\T{1};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{mp}\MG\\{bisect\_stack}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{607}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{bistack\_size}+\T{1};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{bisect\_stack}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{bisect\_stack}){}$;\par
\fi

\M{608}\B\X30:Check the ``constant'' values for consistency\X${}\mathrel+\E{}$\6
\&{if} ${}(\\{int\_packets}+\T{17}*\\{int\_increment}>\\{bistack\_size}){}$\1\5
${}\\{mp}\MG\\{bad}\K\T{19}{}$;\2\par
\fi

\M{609}Computation of the min and max is a tedious but fairly fast sequence of
instructions; exactly four comparisons are made in each branch.

\Y\B\4\D$\\{set\_min\_max}(\|A)$ \5
\\{debug\_number}(\\{stack\_1}(\|A));\6
\\{debug\_number}(\\{stack\_3}(\|A));\6
\\{debug\_number}(\\{stack\_2}(\|A));\6
\\{debug\_number}(\\{stack\_min}(\|A));\6
\\{debug\_number}(\\{stack\_max}(\|A));\6
\&{if} (\\{number\_negative}(\\{stack\_1}((\|A))))\5
${}\{{}$\1\6
\&{if} (\\{number\_nonnegative}(\\{stack\_3}((\|A))))\5
${}\{{}$\1\6
\&{if} (\\{number\_negative}(\\{stack\_2}((\|A))))\1\5
${}\\{set\_number\_from\_addition}(\\{stack\_min}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{stack\_min}((\|A)),\39\\{stack\_1}((\|A)));{}$\2\6
${}\\{set\_number\_from\_addition}(\\{stack\_max}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
${}\\{number\_add}(\\{stack\_max}((\|A)),\39\\{stack\_3}((\|A)));{}$\6
\&{if} (\\{number\_negative}(\\{stack\_max}((\|A))))\1\5
\\{set\_number\_to\_zero}(\\{stack\_max}((\|A)));\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{stack\_min}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
${}\\{number\_add}(\\{stack\_min}((\|A)),\39\\{stack\_3}((\|A)));{}$\6
\&{if} ${}(\\{number\_greater}(\\{stack\_min}((\|A)),\39\\{stack\_1}((%
\|A)))){}$\1\5
${}\\{number\_clone}(\\{stack\_min}((\|A)),\39\\{stack\_1}((\|A)));{}$\2\6
${}\\{set\_number\_from\_addition}(\\{stack\_max}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
\&{if} (\\{number\_negative}(\\{stack\_max}((\|A))))\1\5
\\{set\_number\_to\_zero}(\\{stack\_max}((\|A)));\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_nonpositive}(\\{stack\_3}((\|A))))\5
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{stack\_2}((\|A))))\1\5
${}\\{set\_number\_from\_addition}(\\{stack\_max}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{stack\_max}((\|A)),\39\\{stack\_1}((\|A)));{}$\2\6
${}\\{set\_number\_from\_addition}(\\{stack\_min}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
${}\\{number\_add}(\\{stack\_min}((\|A)),\39\\{stack\_3}((\|A)));{}$\6
\&{if} (\\{number\_positive}(\\{stack\_min}((\|A))))\1\5
\\{set\_number\_to\_zero}(\\{stack\_min}((\|A)));\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_addition}(\\{stack\_max}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
${}\\{number\_add}(\\{stack\_max}((\|A)),\39\\{stack\_3}((\|A)));{}$\6
\&{if} ${}(\\{number\_less}(\\{stack\_max}((\|A)),\39\\{stack\_1}((\|A)))){}$\1%
\5
${}\\{number\_clone}(\\{stack\_max}((\|A)),\39\\{stack\_1}((\|A)));{}$\2\6
${}\\{set\_number\_from\_addition}(\\{stack\_min}((\|A)),\39\\{stack\_1}((%
\|A)),\39\\{stack\_2}((\|A)));{}$\6
\&{if} (\\{number\_positive}(\\{stack\_min}((\|A))))\1\5
\\{set\_number\_to\_zero}(\\{stack\_min}((\|A)));\2\6
\4${}\}{}$\2\par
\fi

\M{610}It's convenient to keep the current values of $l$, $t_1$, and $t_2$ in
the integer form $2^l+2^lt_1$ and $2^l+2^lt_2$. The \PB{\\{cubic%
\_intersection}}
routine uses global variables \PB{\\{cur\_t}} and \PB{\\{cur\_tt}} for this
purpose;
after successful completion, \PB{\\{cur\_t}} and \PB{\\{cur\_tt}} will contain %
\PB{\\{unity}}
plus the \PB{\\{scaled}} values of $t_1$ and~$t_2$.

The values of \PB{\\{cur\_t}} and \PB{\\{cur\_tt}} will be set to zero if \PB{%
\\{cubic\_intersection}}
finds no intersection. The routine gives up and gives an approximate answer
if it has backtracked
more than 5000 times (otherwise there are cases where several minutes
of fruitless computation would be possible).

\Y\B\4\D$\\{max\_patience}$ \5
\T{5000}\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{cur\_t};\6
\&{mp\_number} \\{cur\_tt};\C{ controls and results of \PB{\\{cubic%
\_intersection}} }\6
\&{integer} \\{time\_to\_go};\C{ this many backtracks before giving up }\6
\&{mp\_number} \\{max\_t};\C{ maximum of $2^{l+1}$ so far achieved }\par
\fi

\M{611}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{cur\_t});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{cur\_tt});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{max\_t}){}$;\par
\fi

\M{612}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{cur\_t});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{cur\_tt});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{max\_t}){}$;\par
\fi

\M{613}The given cubics $B(w_0,w_1,w_2,w_3;t)$ and
$B(z_0,z_1,z_2,z_3;t)$ are specified in adjacent knot nodes \PB{$(\|p,\\{mp%
\_link}(\|p))$}
and \PB{$(\\{pp},\\{mp\_link}(\\{pp}))$}, respectively.

\Y\B\4\D$\\{half}(\|A)$ \5
$((\|A)/\T{2}{}$)\par
\Y\B\&{static} \&{void} \\{mp\_cubic\_intersection}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_knot} \|p${},\39{}$\&{mp\_knot} \\{pp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q${},{}$ \\{qq};\C{ \PB{\\{mp\_link}(\|p)}, \PB{\\{mp\_link}(%
\\{pp})} }\7
${}\\{mp}\MG\\{time\_to\_go}\K\\{max\_patience};{}$\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{max\_t},\39\T{2});{}$\6
\X617:Initialize for intersections at level zero\X;\6
\4\.{CONTINUE}:\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{delx})-\\{mp}\MG\\{tol}\Z%
\\{number\_to\_scaled}(\\{stack\_max}(\\{x\_packet}(\\{mp}\MG\\{xy})))-%
\\{number\_to\_scaled}(\\{stack\_min}(\\{u\_packet}(\\{mp}\MG\\{uv})))){}$\1\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{delx})+\\{mp}\MG\\{tol}\G%
\\{number\_to\_scaled}(\\{stack\_min}(\\{x\_packet}(\\{mp}\MG\\{xy})))-%
\\{number\_to\_scaled}(\\{stack\_max}(\\{u\_packet}(\\{mp}\MG\\{uv})))){}$\1\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{dely})-\\{mp}\MG\\{tol}\Z%
\\{number\_to\_scaled}(\\{stack\_max}(\\{y\_packet}(\\{mp}\MG\\{xy})))-%
\\{number\_to\_scaled}(\\{stack\_min}(\\{v\_packet}(\\{mp}\MG\\{uv})))){}$\1\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{dely})+\\{mp}\MG\\{tol}\G%
\\{number\_to\_scaled}(\\{stack\_min}(\\{y\_packet}(\\{mp}\MG\\{xy})))-%
\\{number\_to\_scaled}(\\{stack\_max}(\\{v\_packet}(\\{mp}\MG\\{uv})))){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{cur\_t})\G\\{number\_to\_scaled}(%
\\{mp}\MG\\{max\_t})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_equal}(\\{mp}\MG\\{max\_t},\39\\{two\_t})){}$\5
${}\{{}$\C{ we've done 17 bisections }\1\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_t},\39((\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_t})+\T{1})/\T{2}));{}$\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_tt},\39((\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_tt})+\T{1})/\T{2}));{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{number\_double}(\\{mp}\MG\\{max\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{appr\_t},\39\\{mp}\MG\\{cur\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{appr\_tt},\39\\{mp}\MG\\{cur\_tt});{}$\6
\4${}\}{}$\2\6
\X618:Subdivide for a new level of intersection\X;\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\2\2\2\6
\&{if} ${}(\\{mp}\MG\\{time\_to\_go}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{decr}(\\{mp}\MG\\{time\_to\_go});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{while} ${}(\\{number\_less}(\\{mp}\MG\\{appr\_t},\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_double}(\\{mp}\MG\\{appr\_t});{}$\6
${}\\{number\_double}(\\{mp}\MG\\{appr\_tt});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_t},\39\\{mp}\MG\\{appr\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_tt},\39\\{mp}\MG\\{appr\_tt});{}$\6
\&{return};\6
\4${}\}{}$\2\6
\4\.{NOT\_FOUND}:\C{ Advance to the next pair \PB{$(\\{cur\_t},\\{cur\_tt})$} }%
\6
\&{if} ${}(\\{odd}(\\{number\_to\_scaled}(\\{mp}\MG\\{cur\_tt}))){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{odd}(\\{number\_to\_scaled}(\\{mp}\MG\\{cur\_t}))){}$\5
${}\{{}$\C{ Descend to the previous level and \PB{\&{goto} \\{not\_found}} }\1\6
${}\{{}$\1\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_t},\39\\{half}(\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_t})));{}$\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_tt},\39\\{half}(\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_tt})));{}$\6
\&{if} ${}(\\{number\_to\_scaled}(\\{mp}\MG\\{cur\_t})\E\T{0}){}$\1\5
\&{return};\2\6
${}\\{mp}\MG\\{bisect\_ptr}\MRL{-{\K}}\\{int\_increment};{}$\6
${}\\{mp}\MG\\{three\_l}\MRL{-{\K}}{}$(\&{integer}) \\{mp}${}\MG\\{tol%
\_step};{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{delx},\39\\{stack\_dx});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{dely},\39\\{stack\_dy});{}$\6
${}\\{mp}\MG\\{tol}\K\\{number\_to\_scaled}(\\{stack\_tol});{}$\6
${}\\{mp}\MG\\{uv}\K\\{number\_to\_scaled}(\\{stack\_uv});{}$\6
${}\\{mp}\MG\\{xy}\K\\{number\_to\_scaled}(\\{stack\_xy});{}$\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_t},\39\\{number\_to\_scaled}(%
\\{mp}\MG\\{cur\_t})+\T{1});{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_1}(\\{u\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_2}(\\{u\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_3}(\\{u\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_1}(\\{v\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_2}(\\{v\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_3}(\\{v\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{mp}\MG\\{uv}\K\\{mp}\MG\\{uv}+\\{int\_packets}{}$;\C{ switch from \PB{%
\\{l\_packets}} to \PB{\\{r\_packets}} }\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_tt},\39\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_tt})-\T{1});{}$\6
${}\\{mp}\MG\\{xy}\K\\{mp}\MG\\{xy}-\\{int\_packets};{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_1}(\\{x\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_2}(\\{x\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{delx},\39\\{stack\_3}(\\{x\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_1}(\\{y\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_2}(\\{y\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_add}(\\{mp}\MG\\{dely},\39\\{stack\_3}(\\{y\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_tt},\39\\{number\_to%
\_scaled}(\\{mp}\MG\\{cur\_tt})+\T{1});{}$\6
${}\\{mp}\MG\\{tol}\K\\{mp}\MG\\{tol}+\\{mp}\MG\\{three\_l};{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{delx},\39\\{stack\_1}(\\{x\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{delx},\39\\{stack\_2}(\\{x\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{delx},\39\\{stack\_3}(\\{x\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{dely},\39\\{stack\_1}(\\{y\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{dely},\39\\{stack\_2}(\\{y\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{dely},\39\\{stack\_3}(\\{y\_packet}(\\{mp}%
\MG\\{xy})));{}$\6
${}\\{mp}\MG\\{xy}\K\\{mp}\MG\\{xy}+\\{int\_packets}{}$;\C{ switch from \PB{%
\\{l\_packets}} to \PB{\\{r\_packets}} }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{614}The following variables are global, although they are used only by
\PB{\\{cubic\_intersection}}, because it is necessary on some machines to
split \PB{\\{cubic\_intersection}} up into two procedures.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{delx};\6
\&{mp\_number} \\{dely};\C{ the components of $\Delta=2^l(w_0-z_0)$ }\6
\&{integer} \\{tol};\C{ bound on the uncertainty in the overlap test }\6
\&{integer} \\{uv};\6
\&{integer} \\{xy};\C{ pointers to the current packets of interest }\6
\&{integer} \\{three\_l};\C{ \PB{\\{tol\_step}} times the bisection level }\6
\&{mp\_number} \\{appr\_t};\6
\&{mp\_number} \\{appr\_tt};\C{ best approximations known to the answers }\par
\fi

\M{615}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{delx});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{dely});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{appr\_t});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{appr\_tt}){}$;\par
\fi

\M{616}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{delx});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{dely});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{appr\_t});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{appr\_tt}){}$;\par
\fi

\M{617}We shall assume that the coordinates are sufficiently non-extreme that
integer overflow will not occur.

\Y\B\4\X617:Initialize for intersections at level zero\X${}\E{}$\6
$\|q\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{qq}\K\\{mp\_next\_knot}(\\{pp});{}$\6
${}\\{mp}\MG\\{bisect\_ptr}\K\\{int\_packets};{}$\6
${}\\{set\_number\_from\_substraction}(\\{u1r},\39\|p\MG\\{right\_x},\39\|p\MG%
\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{u2r},\39\|q\MG\\{left\_x},\39\|p\MG%
\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{u3r},\39\|q\MG\\{x\_coord},\39\|q\MG%
\\{left\_x});{}$\6
\\{set\_min\_max}(\\{ur\_packet});\6
${}\\{set\_number\_from\_substraction}(\\{v1r},\39\|p\MG\\{right\_y},\39\|p\MG%
\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{v2r},\39\|q\MG\\{left\_y},\39\|p\MG%
\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{v3r},\39\|q\MG\\{y\_coord},\39\|q\MG%
\\{left\_y});{}$\6
\\{set\_min\_max}(\\{vr\_packet});\6
${}\\{set\_number\_from\_substraction}(\\{x1r},\39\\{pp}\MG\\{right\_x},\39%
\\{pp}\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x2r},\39\\{qq}\MG\\{left\_x},\39%
\\{pp}\MG\\{right\_x});{}$\6
${}\\{set\_number\_from\_substraction}(\\{x3r},\39\\{qq}\MG\\{x\_coord},\39%
\\{qq}\MG\\{left\_x});{}$\6
\\{set\_min\_max}(\\{xr\_packet});\6
${}\\{set\_number\_from\_substraction}(\\{y1r},\39\\{pp}\MG\\{right\_y},\39%
\\{pp}\MG\\{y\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y2r},\39\\{qq}\MG\\{left\_y},\39%
\\{pp}\MG\\{right\_y});{}$\6
${}\\{set\_number\_from\_substraction}(\\{y3r},\39\\{qq}\MG\\{y\_coord},\39%
\\{qq}\MG\\{left\_y});{}$\6
\\{set\_min\_max}(\\{yr\_packet});\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{delx},\39\|p\MG\\{x\_coord},%
\39\\{pp}\MG\\{x\_coord});{}$\6
${}\\{set\_number\_from\_substraction}(\\{mp}\MG\\{dely},\39\|p\MG\\{y\_coord},%
\39\\{pp}\MG\\{y\_coord});{}$\6
${}\\{mp}\MG\\{tol}\K\T{0};{}$\6
${}\\{mp}\MG\\{uv}\K\\{r\_packets};{}$\6
${}\\{mp}\MG\\{xy}\K\\{r\_packets};{}$\6
${}\\{mp}\MG\\{three\_l}\K\T{0};{}$\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_t},\39\T{1});$ $\\{set%
\_number\_from\_scaled}(\\{mp}\MG\\{cur\_tt},\39\T{1}{}$)\par
\U613.\fi

\M{618}

\Y\B\4\X618:Subdivide for a new level of intersection\X${}\E{}$\6
$\\{number\_clone}(\\{stack\_dx},\39\\{mp}\MG\\{delx});{}$\6
${}\\{number\_clone}(\\{stack\_dy},\39\\{mp}\MG\\{dely});{}$\6
${}\\{set\_number\_from\_scaled}(\\{stack\_tol},\39\\{mp}\MG\\{tol});{}$\6
${}\\{set\_number\_from\_scaled}(\\{stack\_uv},\39\\{mp}\MG\\{uv});{}$\6
${}\\{set\_number\_from\_scaled}(\\{stack\_xy},\39\\{mp}\MG\\{xy});{}$\6
${}\\{mp}\MG\\{bisect\_ptr}\K\\{mp}\MG\\{bisect\_ptr}+\\{int\_increment};{}$\6
${}\\{number\_double}(\\{mp}\MG\\{cur\_t});{}$\6
${}\\{number\_double}(\\{mp}\MG\\{cur\_tt});{}$\6
${}\\{number\_clone}(\\{u1l},\39\\{stack\_1}(\\{u\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_clone}(\\{u3r},\39\\{stack\_3}(\\{u\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{set\_number\_from\_addition}(\\{u2l},\39\\{u1l},\39\\{stack\_2}(\\{u%
\_packet}(\\{mp}\MG\\{uv})));{}$\6
\\{number\_half}(\\{u2l});\6
${}\\{set\_number\_from\_addition}(\\{u2r},\39\\{u3r},\39\\{stack\_2}(\\{u%
\_packet}(\\{mp}\MG\\{uv})));{}$\6
\\{number\_half}(\\{u2r});\6
${}\\{set\_number\_from\_addition}(\\{u3l},\39\\{u2l},\39\\{u2r});{}$\6
\\{number\_half}(\\{u3l});\6
${}\\{number\_clone}(\\{u1r},\39\\{u3l});{}$\6
\\{set\_min\_max}(\\{ul\_packet});\6
\\{set\_min\_max}(\\{ur\_packet});\6
${}\\{number\_clone}(\\{v1l},\39\\{stack\_1}(\\{v\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{number\_clone}(\\{v3r},\39\\{stack\_3}(\\{v\_packet}(\\{mp}\MG%
\\{uv})));{}$\6
${}\\{set\_number\_from\_addition}(\\{v2l},\39\\{v1l},\39\\{stack\_2}(\\{v%
\_packet}(\\{mp}\MG\\{uv})));{}$\6
\\{number\_half}(\\{v2l});\6
${}\\{set\_number\_from\_addition}(\\{v2r},\39\\{v3r},\39\\{stack\_2}(\\{v%
\_packet}(\\{mp}\MG\\{uv})));{}$\6
\\{number\_half}(\\{v2r});\6
${}\\{set\_number\_from\_addition}(\\{v3l},\39\\{v2l},\39\\{v2r});{}$\6
\\{number\_half}(\\{v3l});\6
${}\\{number\_clone}(\\{v1r},\39\\{v3l});{}$\6
\\{set\_min\_max}(\\{vl\_packet});\6
\\{set\_min\_max}(\\{vr\_packet});\6
${}\\{number\_clone}(\\{x1l},\39\\{stack\_1}(\\{x\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_clone}(\\{x3r},\39\\{stack\_3}(\\{x\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{set\_number\_from\_addition}(\\{x2l},\39\\{x1l},\39\\{stack\_2}(\\{x%
\_packet}(\\{mp}\MG\\{xy})));{}$\6
\\{number\_half}(\\{x2l});\6
${}\\{set\_number\_from\_addition}(\\{x2r},\39\\{x3r},\39\\{stack\_2}(\\{x%
\_packet}(\\{mp}\MG\\{xy})));{}$\6
\\{number\_half}(\\{x2r});\6
${}\\{set\_number\_from\_addition}(\\{x3l},\39\\{x2l},\39\\{x2r});{}$\6
\\{number\_half}(\\{x3l});\6
${}\\{number\_clone}(\\{x1r},\39\\{x3l});{}$\6
\\{set\_min\_max}(\\{xl\_packet});\6
\\{set\_min\_max}(\\{xr\_packet});\6
${}\\{number\_clone}(\\{y1l},\39\\{stack\_1}(\\{y\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{number\_clone}(\\{y3r},\39\\{stack\_3}(\\{y\_packet}(\\{mp}\MG%
\\{xy})));{}$\6
${}\\{set\_number\_from\_addition}(\\{y2l},\39\\{y1l},\39\\{stack\_2}(\\{y%
\_packet}(\\{mp}\MG\\{xy})));{}$\6
\\{number\_half}(\\{y2l});\6
${}\\{set\_number\_from\_addition}(\\{y2r},\39\\{y3r},\39\\{stack\_2}(\\{y%
\_packet}(\\{mp}\MG\\{xy})));{}$\6
\\{number\_half}(\\{y2r});\6
${}\\{set\_number\_from\_addition}(\\{y3l},\39\\{y2l},\39\\{y2r});{}$\6
\\{number\_half}(\\{y3l});\6
${}\\{number\_clone}(\\{y1r},\39\\{y3l});{}$\6
\\{set\_min\_max}(\\{yl\_packet});\6
\\{set\_min\_max}(\\{yr\_packet});\6
${}\\{mp}\MG\\{uv}\K\\{l\_packets};{}$\6
${}\\{mp}\MG\\{xy}\K\\{l\_packets};{}$\6
${}\\{number\_double}(\\{mp}\MG\\{delx});{}$\6
${}\\{number\_double}(\\{mp}\MG\\{dely});{}$\6
${}\\{mp}\MG\\{tol}\K\\{mp}\MG\\{tol}-\\{mp}\MG\\{three\_l}+{}$(\&{integer}) %
\\{mp}${}\MG\\{tol\_step};{}$\6
${}\\{mp}\MG\\{tol}\MRL{+{\K}}\\{mp}\MG\\{tol};$ $\\{mp}\MG\\{three\_l}\K\\{mp}%
\MG\\{three\_l}+{}$(\&{integer}) \\{mp}${}\MG{}$\\{tol\_step}\par
\U613.\fi

\M{619}The \PB{\\{path\_intersection}} procedure is much simpler.
It invokes \PB{\\{cubic\_intersection}} in lexicographic order until finding a
pair of cubics that intersect. The final intersection times are placed in
\PB{\\{cur\_t}} and~\PB{\\{cur\_tt}}.

\Y\B\&{static} \&{void} \\{mp\_path\_intersection}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_knot} \|h${},\39{}$\&{mp\_knot} \\{hh})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p${},{}$ \\{pp};\C{ link registers that traverse the given paths
}\6
\&{mp\_number} \|n${},{}$ \\{nn};\C{ integer parts of intersection times, minus
\PB{\\{unity}} }\7
\X620:Change one-point paths into dead cycles\X;\6
\\{new\_number}(\|n);\6
\\{new\_number}(\\{nn});\6
${}\\{mp}\MG\\{tol\_step}\K\T{0};{}$\6
\&{do}\5
${}\{{}$\1\6
\\{set\_number\_to\_unity}(\|n);\6
\\{number\_negate}(\|n);\6
${}\|p\K\|h;{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\I\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_unity}(\\{nn});\6
\\{number\_negate}(\\{nn});\6
${}\\{pp}\K\\{hh};{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_right\_type}(\\{pp})\I\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{mp\_cubic\_intersection}(\\{mp},\39\|p,\39\\{pp});{}$\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{cur\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{mp}\MG\\{cur\_t},\39\|n);{}$\6
${}\\{number\_add}(\\{mp}\MG\\{cur\_tt},\39\\{nn});{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{number\_add}(\\{nn},\39\\{unity\_t});{}$\6
${}\\{pp}\K\\{mp\_next\_knot}(\\{pp});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{pp}\I\\{hh});{}$\6
\4${}\}{}$\2\6
${}\\{number\_add}(\|n,\39\\{unity\_t});{}$\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|h);{}$\6
${}\\{mp}\MG\\{tol\_step}\K\\{mp}\MG\\{tol\_step}+\T{3};{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp}\MG\\{tol\_step}\Z\T{3});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_t},\39\\{unity\_t});{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{cur\_t});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_tt},\39\\{unity\_t});{}$\6
${}\\{number\_negate}(\\{mp}\MG\\{cur\_tt});{}$\6
\4\.{DONE}:\5
\\{free\_number}(\|n);\6
\\{free\_number}(\\{nn});\6
\4${}\}{}$\2\par
\fi

\M{620}\B\X620:Change one-point paths into dead cycles\X${}\E{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|h)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|h\MG\\{right\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{left\_x},\39\|h\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{right\_y},\39\|h\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\|h\MG\\{left\_y},\39\|h\MG\\{y\_coord});{}$\6
${}\\{mp\_right\_type}(\|h)\K\\{mp\_explicit};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_right\_type}(\\{hh})\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{hh}\MG\\{right\_x},\39\\{hh}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{left\_x},\39\\{hh}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{right\_y},\39\\{hh}\MG\\{y\_coord});{}$\6
${}\\{number\_clone}(\\{hh}\MG\\{left\_y},\39\\{hh}\MG\\{y\_coord});{}$\6
${}\\{mp\_right\_type}(\\{hh})\K\\{mp\_explicit};{}$\6
\4${}\}{}$\2\par
\U619.\fi

\N{1}{621}Dynamic linear equations.
\MP\ users define variables implicitly by stating equations that should be
satisfied; the computer is supposed to be smart enough to solve those
equations.
And indeed, the computer tries valiantly to do so, by distinguishing five
different types of numeric values:

\smallskip\hang
\PB{$\\{type}(\|p)\K\\{mp\_known}$} is the nice case, when \PB{\\{value}(\|p)}
is the \PB{\\{scaled}} value
of the variable whose address is~\PB{\|p}.

\smallskip\hang
\PB{$\\{type}(\|p)\K\\{mp\_dependent}$} means that \PB{\\{value}(\|p)} is not
present, but \PB{\\{dep\_list}(\|p)}
points to a {\sl dependency list\/} that expresses the value of variable~\PB{%
\|p}
as a \PB{\\{scaled}} number plus a sum of independent variables with \PB{%
\\{fraction}}
coefficients.

\smallskip\hang
\PB{$\\{type}(\|p)\K\\{mp\_independent}$} means that \PB{$\\{indep\_value}(\|p)%
\K\|s$}, where \PB{$\|s>\T{0}$} is a ``serial
number'' reflecting the time this variable was first used in an equation;
and there is an extra field \PB{$\\{indep\_scale}(\|p)\K\|m$}, with \PB{$\T{0}%
\Z\|m<\T{64}$}, each dependent
variable that refers to this one is actually referring to the future value of
this variable times~$2^m$. (Usually \PB{$\|m\K\T{0}$}, but higher degrees of
scaling are sometimes needed to keep the coefficients in dependency lists
from getting too large. The value of~\PB{\|m} will always be even.)

\smallskip\hang
\PB{$\\{type}(\|p)\K\\{mp\_numeric\_type}$} means that variable \PB{\|p} hasn't
appeared in an
equation before, but it has been explicitly declared to be numeric.

\smallskip\hang
\PB{$\\{type}(\|p)\K\\{undefined}$} means that variable \PB{\|p} hasn't
appeared before.

\smallskip\noindent
We have actually discussed these five types in the reverse order of their
history during a computation: Once \PB{\\{known}}, a variable never again
becomes \PB{\\{dependent}}; once \PB{\\{dependent}}, it almost never again
becomes
\PB{\\{mp\_independent}}; once \PB{\\{mp\_independent}}, it never again becomes
\PB{\\{mp\_numeric\_type}};
and once \PB{\\{mp\_numeric\_type}}, it never again becomes \PB{\\{undefined}}
(except
of course when the user specifically decides to scrap the old value
and start again). A backward step may, however, take place: Sometimes
a \PB{\\{dependent}} variable becomes \PB{\\{mp\_independent}} again, when one
of the
independent variables it depends on is reverting to \PB{\\{undefined}}.

\Y\B\4\D$\\{indep\_scale}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG\\{data}.\\{indep}.{}$\\{scale}\par
\B\4\D$\\{set\_indep\_scale}(\|A,\|B)$ \5
$((\&{mp\_value\_node})(\|A))\MG\\{data}.\\{indep}.\\{scale}\K{}$(\|B)\par
\B\4\D$\\{indep\_value}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG\\{data}.\\{indep}.{}$\\{serial}\par
\B\4\D$\\{set\_indep\_value}(\|A,\|B)$ \5
$((\&{mp\_value\_node})(\|A))\MG\\{data}.\\{indep}.\\{serial}\K{}$(\|B)\par
\Y\B\&{void} \\{mp\_new\_indep}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1\1\2%
\2\6
${}\{{}$\C{ create a new independent variable }\1\6
\&{if} ${}(\\{mp}\MG\\{serial\_no}\G\\{max\_integer}){}$\5
${}\{{}$\1\6
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"variable\ instance\ i}\)\.{dentifiers\
exhausted}\)\.{"});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_independent};{}$\6
${}\\{mp}\MG\\{serial\_no}\K\\{mp}\MG\\{serial\_no}+\T{1};{}$\6
${}\\{set\_indep\_scale}(\|p,\39\T{0});{}$\6
${}\\{set\_indep\_value}(\|p,\39\\{mp}\MG\\{serial\_no});{}$\6
\4${}\}{}$\2\par
\fi

\M{622}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_new\_indep}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);\par
\fi

\M{623}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{serial\_no};\C{ the most recent serial number }\par
\fi

\M{624}But how are dependency lists represented? It's simple: The linear
combination
$\alpha_1v_1+\cdots+\alpha_kv_k+\beta$ appears in \PB{$\|k+\T{1}$} value nodes.
If
\PB{$\|q\K\\{dep\_list}(\|p)$} points to this list, and if \PB{$\|k>\T{0}$},
then \PB{\\{dep\_value}(\|q) $\K\hbox{$\alpha_1$}$} (which is a \PB{%
\\{fraction}}); \PB{\\{dep\_info}(\|q)} points to the location
of $\alpha_1$; and \PB{\\{mp\_link}(\|p)} points to the dependency list
$\alpha_2v_2+\cdots+\alpha_kv_k+\beta$. On the other hand if \PB{$\|k\K\T{0}$},
then \PB{\\{dep\_value}(\|q) $\K\hbox{$\beta$}$} (which is \PB{\\{scaled}}) and
\PB{$\\{dep\_info}(\|q)\K\NULL$}.
The independent variables $v_1$, \dots,~$v_k$ have been sorted so that
they appear in decreasing order of their \PB{\\{value}} fields (i.e., of
their serial numbers). \ (It is convenient to use decreasing order,
since \PB{$\\{value}(\NULL)\K\T{0}$}. If the independent variables were not
sorted by
serial number but by some other criterion, such as their location in \PB{%
\\{mem}},
the equation-solving mechanism would be too system-dependent, because
the ordering can affect the computed results.)

The \PB{\\{link}} field in the node that contains the constant term $\beta$ is
called the {\sl final link\/} of the dependency list. \MP\ maintains
a doubly-linked master list of all dependency lists, in terms of a permanently
allocated node
in \PB{\\{mem}} called \PB{\\{dep\_head}}. If there are no dependencies, we
have
\PB{$\\{mp\_link}(\\{dep\_head})\K\\{dep\_head}$} and \PB{$\\{prev\_dep}(\\{dep%
\_head})\K\\{dep\_head}$};
otherwise \PB{\\{mp\_link}(\\{dep\_head})} points to the first dependent
variable, say~\PB{\|p},
and \PB{$\\{prev\_dep}(\|p)\K\\{dep\_head}$}. We have \PB{$\\{type}(\|p)\K\\{mp%
\_dependent}$}, and \PB{\\{dep\_list}(\|p)}
points to its dependency list. If the final link of that dependency list
occurs in location~\PB{\|q}, then \PB{\\{mp\_link}(\|q)} points to the next
dependent
variable (say~\PB{\|r}); and we have \PB{$\\{prev\_dep}(\|r)\K\|q$}, etc.

Dependency nodes sometimes mutate into value nodes and vice versa, so their
structures have to match.

\Y\B\4\D$\\{dep\_value}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG\\{data}.{}$\|n\par
\B\4\D$\\{set\_dep\_value}(\|A,\|B)$ \5
$\\{do\_set\_dep\_value}(\\{mp},\39(\|A),\39(\|B){}$)\par
\B\4\D$\\{dep\_info}(\|A)$ \5
$\\{get\_dep\_info}(\\{mp},\39(\|A){}$)\par
\B\4\D$\\{set\_dep\_info}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
\&{mp\_value\_node} \|d${}\K(\&{mp\_value\_node})(\|B);{}$\7
${}\.{FUNCTION\_TRACE4}(\.{"set\_dep\_info(\%p,\%p)}\)\.{\ on\ \%d\\n"},\39(%
\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}((\&{mp\_value\_node})(\|A))\MG\\{parent\_}\K{}$(\&{mp\_node}) \|d;\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{dep\_list}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG{}$\\{attr\_head\_}\C{ half of the \PB{%
\\{value}} field in a \PB{\\{dependent}} variable }\par
\B\4\D$\\{set\_dep\_list}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
\&{mp\_value\_node} \|d${}\K(\&{mp\_value\_node})(\|B);{}$\7
${}\.{FUNCTION\_TRACE4}(\.{"set\_dep\_list(\%p,\%p)}\)\.{\ on\ \%d\\n"},\39(%
\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}\\{dep\_list}((\|A))\K{}$(\&{mp\_node}) \|d;\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{prev\_dep}(\|A)$ \5
$((\&{mp\_value\_node})(\|A))\MG{}$\\{subscr\_head\_}\C{ the other half; makes
a doubly linked list }\par
\B\4\D$\\{set\_prev\_dep}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
\&{mp\_value\_node} \|d${}\K(\&{mp\_value\_node})(\|B);{}$\7
${}\.{FUNCTION\_TRACE4}(\.{"set\_prev\_dep(\%p,\%p)}\)\.{\ on\ \%d\\n"},\39(%
\|A),\39\|d,\39\.{\_\_LINE\_\_});{}$\6
${}\\{prev\_dep}((\|A))\K{}$(\&{mp\_node}) \|d;\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{mp\_node} \\{get\_dep\_info}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|d;\7
${}\|d\K\|p\MG\\{parent\_}{}$;\C{ half of the \PB{\\{value}} field in a \PB{%
\\{dependent}} variable }\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ dep\_info(\%p)\\n}\)\.{"},\39\|d,\39%
\|p);{}$\6
\&{return} \|d;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{do\_set\_dep\_value}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_number} \|q)\1\1\2\2\6
${}\{{}$\1\6
${}\\{number\_clone}(\|p\MG\\{data}.\|n,\39\|q){}$;\C{ half of the \PB{%
\\{value}} field in a \PB{\\{dependent}} variable }\6
${}\.{FUNCTION\_TRACE3}(\.{"set\_dep\_value(\%p,\%d}\)\.{)\\n"},\39\|p,\39%
\|q);{}$\6
${}\|p\MG\\{attr\_head\_}\K\NULL;{}$\6
${}\|p\MG\\{subscr\_head\_}\K\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{625}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{get\_dep\_info}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p);\par
\fi

\M{626}

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_get\_dep\_node}(\&{MP} \\{mp})\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p${}\K{}$(\&{mp\_value\_node}) \\{mp\_get\_value\_node}(%
\\{mp});\7
${}\\{mp\_type}(\|p)\K\\{mp\_dep\_node\_type};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_free\_dep\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_free\_value\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p);\6
\4${}\}{}$\2\par
\fi

\M{627}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_free\_dep\_node}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p);\par
\fi

\M{628}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{serial\_no}\K\T{0};{}$\6
${}\\{mp}\MG\\{dep\_head}\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{dep\_head},\39{}$(\&{mp\_node}) \\{mp}${}\MG%
\\{dep\_head});{}$\6
${}\\{set\_prev\_dep}(\\{mp}\MG\\{dep\_head},\39{}$(\&{mp\_node}) \\{mp}${}\MG%
\\{dep\_head});{}$\6
${}\\{set\_dep\_info}(\\{mp}\MG\\{dep\_head},\39\NULL);{}$\6
${}\\{set\_dep\_list}(\\{mp}\MG\\{dep\_head},\39\NULL){}$;\par
\fi

\M{629}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_dep\_node}(\\{mp},\39\\{mp}\MG\\{dep\_head}){}$;\par
\fi

\M{630}Actually the description above contains a little white lie. There's
another kind of variable called \PB{\\{mp\_proto\_dependent}}, which is
just like a \PB{\\{dependent}} one except that the $\alpha$ coefficients
in its dependency list are \PB{\\{scaled}} instead of being fractions.
Proto-dependency lists are mixed with dependency lists in the
nodes reachable from \PB{\\{dep\_head}}.

\fi

\M{631}Here is a procedure that prints a dependency list in symbolic form.
The second parameter should be either \PB{\\{dependent}} or \PB{\\{mp\_proto%
\_dependent}},
to indicate the scaling of the coefficients.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_dependency}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p${},\39{}$\&{quarterword} \|t);\par
\fi

\M{632}\B\&{void} \\{mp\_print\_dependency}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|v;\C{ a coefficient }\6
\&{mp\_value\_node} \\{pp};\C{ for list manipulation }\6
\&{mp\_node} \|q;\7
${}\\{pp}\K\|p;{}$\6
\\{new\_number}(\|v);\6
\&{while} (\\{true})\5
${}\{{}$\1\6
${}\\{number\_clone}(\|v,\39\\{dep\_value}(\|p));{}$\6
\\{number\_abs}(\|v);\6
${}\|q\K\\{dep\_info}(\|p);{}$\6
\&{if} ${}(\|q\E\NULL){}$\5
${}\{{}$\C{ the constant term }\1\6
\&{if} ${}(\\{number\_nonzero}(\|v)\V(\|p\E\\{pp})){}$\5
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{dep\_value}(\|p)))\1\6
\&{if} ${}(\|p\I\\{pp}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'+'}));{}$\2\2\6
\\{print\_number}(\\{dep\_value}(\|p));\6
\4${}\}{}$\2\6
\&{return};\6
\4${}\}{}$\C{ Print the coefficient, unless it's $\pm1.0$ }\2\6
\&{if} (\\{number\_negative}(\\{dep\_value}(\|p)))\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'-'}));{}$\2\6
\&{else} \&{if} ${}(\|p\I\\{pp}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'+'}));{}$\2\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
\\{fraction\_to\_round\_scaled}(\|v);\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{number\_equal}(\|v,\39\\{unity\_t})){}$\1\5
\\{print\_number}(\|v);\2\6
\&{if} ${}(\\{mp\_type}(\|q)\I\\{mp\_independent}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"dep"});{}$\2\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|q);{}$\6
${}\\{set\_number\_from\_scaled}(\|v,\39\\{indep\_scale}(\|q));{}$\6
\&{while} (\\{number\_positive}(\|v))\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"*4"});{}$\6
${}\\{number\_add\_scaled}(\|v,\39{-}\T{2});{}$\6
\4${}\}{}$\2\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{633}The maximum absolute value of a coefficient in a given dependency list
is returned by the following simple function.

\Y\B\&{static} \&{void} \\{mp\_max\_coef}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|x,\39{}$\&{mp\_value\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number}(\\{absv});\6
\\{new\_number}(\\{absv});\6
${}\\{set\_number\_to\_zero}({*}\|x);{}$\6
\&{while} ${}(\\{dep\_info}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{absv},\39\\{dep\_value}(\|p));{}$\6
\\{number\_abs}(\\{absv});\6
\&{if} ${}(\\{number\_greater}(\\{absv},\39{*}\|x)){}$\5
${}\{{}$\1\6
${}\\{number\_clone}({*}\|x,\39\\{absv});{}$\6
\4${}\}{}$\2\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absv});\6
\4${}\}{}$\2\par
\fi

\M{634}One of the main operations needed on dependency lists is to add a
multiple
of one list to the other; we call this \PB{\\{p\_plus\_fq}}, where \PB{\|p}
and~\PB{\|q} point
to dependency lists and \PB{\|f} is a fraction.

If the coefficient of any independent variable becomes \PB{\\{coef\_bound}} or
more, in absolute value, this procedure changes the type of that variable
to `\PB{\\{independent\_needing\_fix}}', and sets the global variable \PB{%
\\{fix\_needed}}
to~\PB{\\{true}}. The value of $\PB{\\{coef\_bound}}=\mu$ is chosen so that
$\mu^2+\mu<8$; this means that the numbers we deal with won't
get too large. (Instead of the ``optimum'' $\mu=(\sqrt{33}-1)/2\approx
2.3723$, the safer value 7/3 is taken as the threshold.)

The changes mentioned in the preceding paragraph are actually done only if
the global variable \PB{\\{watch\_coefs}} is \PB{\\{true}}. But it usually is;
in fact,
it is \PB{\\{false}} only when \MP\ is making a dependency list that will soon
be equated to zero.

Several procedures that act on dependency lists, including \PB{\\{p\_plus%
\_fq}},
set the global variable \PB{\\{dep\_final}} to the final (constant term) node
of
the dependency list that they produce.

\Y\B\4\D$\\{independent\_needing\_fix}$ \5
\T{0}\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{fix\_needed};\C{ does at least one \PB{\\{independent}} variable
need scaling? }\6
\&{boolean} \\{watch\_coefs};\C{ should we scale coefficients that exceed \PB{%
\\{coef\_bound}}? }\6
\&{mp\_value\_node} \\{dep\_final};\C{ location of the constant term and final
link }\par
\fi

\M{635}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{fix\_needed}\K\\{false};{}$\6
${}\\{mp}\MG\\{watch\_coefs}\K\\{true}{}$;\par
\fi

\M{636}The \PB{\\{p\_plus\_fq}} procedure has a fourth parameter, \PB{\|t},
that should be
set to \PB{\\{mp\_proto\_dependent}} if \PB{\|p} is a proto-dependency list. In
this
case \PB{\|f} will be \PB{\\{scaled}}, not a \PB{\\{fraction}}. Similarly, the
fifth parameter~\PB{\\{tt}}
should be \PB{\\{mp\_proto\_dependent}} if \PB{\|q} is a proto-dependency list.

List \PB{\|q} is unchanged by the operation; but list \PB{\|p} is totally
destroyed.

The final link of the dependency list or proto-dependency list returned
by \PB{\\{p\_plus\_fq}} is the same as the original final link of~\PB{\|p}.
Indeed, the
constant term of the result will be located in the same \PB{\\{mem}} location
as the original constant term of~\PB{\|p}.

Coefficients of the result are assumed to be zero if they are less than
a certain threshold. This compensates for inevitable rounding errors,
and tends to make more variables `\PB{\\{known}}'. The threshold is
approximately
$10^{-5}$ in the case of normal dependency lists, $10^{-4}$ for
proto-dependencies.

\Y\B\4\D$\\{fraction\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{fraction\_threshold%
\_t}\par
\B\4\D$\\{half\_fraction\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{half\_fraction%
\_threshold\_t}\par
\B\4\D$\\{scaled\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{scaled\_threshold\_t}%
\par
\B\4\D$\\{half\_scaled\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{half\_scaled%
\_threshold\_t}\par
\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_value\_node} \\{mp\_p\_plus\_fq}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p${},\39{}$\&{mp\_number} \|f${},\39{}$\&{mp\_value\_node} %
\|q${},\39\\{mp\_variable\_type}\|t,\39\\{mp\_variable\_type}\\{tt}){}$;\par
\fi

\M{637}\B\&{static} \&{mp\_value\_node} \\{mp\_p\_plus\_fq}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_number} \|f${},\39{}$\&{mp\_value%
\_node} \|q${},\39\\{mp\_variable\_type}\|t,\39\\{mp\_variable\_type}\\{tt}){}$%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{pp}${},{}$ \\{qq};\C{ \PB{\\{dep\_info}(\|p)} and \PB{\\{dep%
\_info}(\|q)}, respectively }\6
\&{mp\_value\_node} \|r${},{}$ \|s;\C{ for list manipulation }\6
\&{mp\_number} \\{threshold}${},{}$ \\{half\_threshold};\C{ defines a
neighborhood of zero }\6
\&{mp\_number} \|v${},{}$ \\{vv};\C{ temporary registers }\7
\\{new\_number}(\|v);\6
\\{new\_number}(\\{vv});\6
\\{new\_number}(\\{threshold});\6
\\{new\_number}(\\{half\_threshold});\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{threshold},\39\\{fraction\_threshold\_k});{}$\6
${}\\{number\_clone}(\\{half\_threshold},\39\\{half\_fraction\_threshold%
\_k});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{threshold},\39\\{scaled\_threshold\_k});{}$\6
${}\\{number\_clone}(\\{half\_threshold},\39\\{half\_scaled\_threshold\_k});{}$%
\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\\{qq}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\NULL){}$\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Contribute a term from \PB{\|p}, plus \PB{\|f} times the
corresponding term from \PB{\|q} }\1\6
\&{mp\_number} \\{r1};\6
\&{mp\_number} \\{absv};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{absv});\6
\&{if} ${}(\\{tt}\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\|f,\39\\{dep\_value}(\|q));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{r1},\39\|f,\39\\{dep\_value}(\|q));{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_addition}(\|v,\39\\{dep\_value}(\|p),\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
${}\\{set\_dep\_value}(\|p,\39\|v);{}$\6
${}\|s\K\|p;{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{number\_clone}(\\{absv},\39\|v);{}$\6
\\{number\_abs}(\\{absv});\6
\&{if} ${}(\\{number\_less}(\\{absv},\39\\{threshold})){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greaterequal}(\\{absv},\39\\{coef\_bound\_k})\W\\{mp}\MG%
\\{watch\_coefs}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\\{qq})\K\\{independent\_needing\_fix};{}$\6
${}\\{mp}\MG\\{fix\_needed}\K\\{true};{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|s);\6
${}\|r\K\|s;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absv});\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\NULL){}$\1\5
\\{set\_number\_to\_neg\_inf}(\|v);\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\\{pp})\E\\{mp\_independent}){}$\1\5
${}\\{set\_number\_from\_scaled}(\|v,\39\\{indep\_value}(\\{pp}));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\|v,\39\\{value\_number}(\\{pp}));{}$\2\6
\&{if} ${}(\\{qq}\E\NULL){}$\1\5
\\{set\_number\_to\_neg\_inf}(\\{vv});\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\\{qq})\E\\{mp\_independent}){}$\1\5
${}\\{set\_number\_from\_scaled}(\\{vv},\39\\{indep\_value}(\\{qq}));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\\{qq}));{}$\2\6
\&{if} ${}(\\{number\_less}(\|v,\39\\{vv})){}$\5
${}\{{}$\C{ Contribute a term from \PB{\|q}, multiplied by~\PB{\|f} }\1\6
\&{mp\_number} \\{absv};\7
\\{new\_number}(\\{absv});\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg1},\39\|f);{}$\6
${}\\{number\_clone}(\\{arg2},\39\\{dep\_value}(\|q));{}$\6
\&{if} ${}(\\{tt}\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{arg2});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{r1},\39\\{arg1},\39\\{arg2});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\|v,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absv},\39\|v);{}$\6
\\{number\_abs}(\\{absv});\6
\&{if} ${}(\\{number\_greater}(\\{absv},\39\\{half\_threshold})){}$\5
${}\{{}$\1\6
${}\|s\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_dep\_info}(\|s,\39\\{qq});{}$\6
${}\\{set\_dep\_value}(\|s,\39\|v);{}$\6
\&{if} ${}(\\{number\_greaterequal}(\\{absv},\39\\{coef\_bound\_k})\W\\{mp}\MG%
\\{watch\_coefs}){}$\5
${}\{{}$\C{ clang:  dereference of a null pointer ('qq') }\1\6
\\{assert}(\\{qq});\6
${}\\{mp\_type}(\\{qq})\K\\{independent\_needing\_fix};{}$\6
${}\\{mp}\MG\\{fix\_needed}\K\\{true};{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|s);\6
${}\|r\K\|s;{}$\6
\4${}\}{}$\2\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
\\{free\_number}(\\{absv});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{number\_clone}(\\{arg1},\39\\{dep\_value}(\|q));{}$\6
${}\\{number\_clone}(\\{arg2},\39\|f);{}$\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\\{arg2});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{r1},\39\\{arg1},\39\\{arg2});{}$\6
\4${}\}{}$\2\6
${}\\{slow\_add}(\\{arg1},\39\\{dep\_value}(\|p),\39\\{r1});{}$\6
${}\\{set\_dep\_value}(\|p,\39\\{arg1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\\{mp}\MG\\{dep\_final}\K\|p;{}$\6
\\{free\_number}(\\{threshold});\6
\\{free\_number}(\\{half\_threshold});\6
\\{free\_number}(\|v);\6
\\{free\_number}(\\{vv});\6
\&{return} (\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{638}It is convenient to have another subroutine for the special case
of \PB{\\{p\_plus\_fq}} when \PB{$\|f\K\T{1.0}$}. In this routine lists \PB{%
\|p} and \PB{\|q} are
both of the same type~\PB{\|t} (either \PB{\\{dependent}} or \PB{\\{mp\_proto%
\_dependent}}).

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_p\_plus\_q}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_value\_node} \|p${},\39{}$\&{mp\_value\_node} \|q${},\39\\{mp\_variable%
\_type}\|t){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{pp}${},{}$ \\{qq};\C{ \PB{\\{dep\_info}(\|p)} and \PB{\\{dep%
\_info}(\|q)}, respectively }\6
\&{mp\_value\_node} \|s;\C{ for list manipulation }\6
\&{mp\_value\_node} \|r;\C{ for list manipulation }\6
\&{mp\_number} \\{threshold};\C{ defines a neighborhood of zero }\6
\&{mp\_number} \|v${},{}$ \\{vv};\C{ temporary register }\7
\\{new\_number}(\|v);\6
\\{new\_number}(\\{vv});\6
\\{new\_number}(\\{threshold});\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\\{threshold},\39\\{fraction\_threshold\_k});{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{threshold},\39\\{scaled\_threshold\_k});{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\\{qq}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\NULL){}$\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Contribute a term from \PB{\|p}, plus the corresponding term from %
\PB{\|q} }\1\6
\&{mp\_number} \\{test};\7
\\{new\_number}(\\{test});\6
${}\\{set\_number\_from\_addition}(\|v,\39\\{dep\_value}(\|p),\39\\{dep%
\_value}(\|q));{}$\6
${}\\{set\_dep\_value}(\|p,\39\|v);{}$\6
${}\|s\K\|p;{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
${}\\{number\_clone}(\\{test},\39\|v);{}$\6
\\{number\_abs}(\\{test});\6
\&{if} ${}(\\{number\_less}(\\{test},\39\\{threshold})){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|s);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greaterequal}(\\{test},\39\\{coef\_bound\_k})\W\\{mp}\MG%
\\{watch\_coefs}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\\{qq})\K\\{independent\_needing\_fix};{}$\6
${}\\{mp}\MG\\{fix\_needed}\K\\{true};{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|s);\6
${}\|r\K\|s;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{test});\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\NULL){}$\1\5
\\{set\_number\_to\_zero}(\|v);\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\\{pp})\E\\{mp\_independent}){}$\1\5
${}\\{set\_number\_from\_scaled}(\|v,\39\\{indep\_value}(\\{pp}));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\|v,\39\\{value\_number}(\\{pp}));{}$\2\6
\&{if} ${}(\\{qq}\E\NULL){}$\1\5
\\{set\_number\_to\_zero}(\\{vv});\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\\{qq})\E\\{mp\_independent}){}$\1\5
${}\\{set\_number\_from\_scaled}(\\{vv},\39\\{indep\_value}(\\{qq}));{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\\{qq}));{}$\2\6
\&{if} ${}(\\{number\_less}(\|v,\39\\{vv})){}$\5
${}\{{}$\1\6
${}\|s\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_dep\_info}(\|s,\39\\{qq});{}$\6
${}\\{set\_dep\_value}(\|s,\39\\{dep\_value}(\|q));{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
${}\\{qq}\K\\{dep\_info}(\|q);{}$\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|s);\6
${}\|r\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{pp}\K\\{dep\_info}(\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{slow\_add}(\\{r1},\39\\{dep\_value}(\|p),\39\\{dep\_value}(\|q));{}$\6
${}\\{set\_dep\_value}(\|p,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\\{mp}\MG\\{dep\_final}\K\|p;{}$\6
\\{free\_number}(\|v);\6
\\{free\_number}(\\{vv});\6
\\{free\_number}(\\{threshold});\6
\&{return} (\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{639}A somewhat simpler routine will multiply a dependency list
by a given constant~\PB{\|v}. The constant is either a \PB{\\{fraction}} less
than
\PB{\\{fraction\_one}}, or it is \PB{\\{scaled}}. In the latter case we might
be forced to
convert a dependency list to a proto-dependency list.
Parameters \PB{\\{t0}} and \PB{\\{t1}} are the list types before and after;
they should agree unless \PB{$\\{t0}\K\\{mp\_dependent}$} and \PB{$\\{t1}\K%
\\{mp\_proto\_dependent}$}
and \PB{$\\{v\_is\_scaled}\K\\{true}$}.

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_p\_times\_v}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_value\_node} \|p${},\39{}$\&{mp\_number} \|v${},\39{}$\&{quarterword} %
\\{t0}${},\39{}$\&{quarterword} \\{t1}${},\39{}$\&{boolean} \\{v\_is\_scaled})%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|r${},{}$ \|s;\C{ for list manipulation }\6
\&{mp\_number} \|w;\C{ tentative coefficient }\6
\&{mp\_number} \\{threshold};\6
\&{boolean} \\{scaling\_down};\7
\\{new\_number}(\\{threshold});\6
\\{new\_number}(\|w);\6
\&{if} ${}(\\{t0}\I\\{t1}){}$\1\5
${}\\{scaling\_down}\K\\{true};{}$\2\6
\&{else}\1\5
${}\\{scaling\_down}\K(\R\\{v\_is\_scaled});{}$\2\6
\&{if} ${}(\\{t1}\E\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\\{threshold},\39\\{half\_fraction\_threshold\_k});{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{threshold},\39\\{half\_scaled\_threshold\_k});{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
\&{while} ${}(\\{dep\_info}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{test};\7
\\{new\_number}(\\{test});\6
\&{if} (\\{scaling\_down})\5
${}\{{}$\1\6
${}\\{take\_fraction}(\|w,\39\|v,\39\\{dep\_value}(\|p));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_scaled}(\|w,\39\|v,\39\\{dep\_value}(\|p));{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{test},\39\|w);{}$\6
\\{number\_abs}(\\{test});\6
\&{if} ${}(\\{number\_lessequal}(\\{test},\39\\{threshold})){}$\5
${}\{{}$\1\6
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|p);{}$\6
${}\|p\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greaterequal}(\\{test},\39\\{coef\_bound\_k})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{fix\_needed}\K\\{true};{}$\6
${}\\{mp\_type}(\\{dep\_info}(\|p))\K\\{independent\_needing\_fix};{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
${}\\{set\_dep\_value}(\|p,\39\|w);{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{test});\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
\&{if} (\\{v\_is\_scaled})\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{r1},\39\\{dep\_value}(\|p),\39\|v);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{take\_fraction}(\\{r1},\39\\{dep\_value}(\|p),\39\|v);{}$\6
\4${}\}{}$\2\6
${}\\{set\_dep\_value}(\|p,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\\{free\_number}(\|w);\6
\\{free\_number}(\\{threshold});\6
\&{return} (\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{640}Similarly, we sometimes need to divide a dependency list
by a given \PB{\\{scaled}} constant.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_value\_node} \\{mp\_p\_over\_v}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p${},\39{}$\&{mp\_number} \|v${},\39{}$\&{quarterword} %
\\{t0}${},\39{}$\&{quarterword} \\{t1});\par
\fi

\M{641}
\Y\B\4\D$\\{p\_over\_v\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{p\_over\_v\_threshold%
\_t}\par
\Y\B\&{mp\_value\_node} \\{mp\_p\_over\_v}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_number} \\{v\_orig}${},\39{}$\&{quarterword} %
\\{t0}${},\39{}$\&{quarterword} \\{t1})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|r${},{}$ \|s;\C{ for list manipulation }\6
\&{mp\_number} \|w;\C{ tentative coefficient }\6
\&{mp\_number} \\{threshold};\6
\&{mp\_number} \|v;\6
\&{boolean} \\{scaling\_down};\7
\\{new\_number}(\|v);\6
\\{new\_number}(\|w);\6
\\{new\_number}(\\{threshold});\6
${}\\{number\_clone}(\|v,\39\\{v\_orig});{}$\6
\&{if} ${}(\\{t0}\I\\{t1}){}$\1\5
${}\\{scaling\_down}\K\\{true};{}$\2\6
\&{else}\1\5
${}\\{scaling\_down}\K\\{false};{}$\2\6
\&{if} ${}(\\{t1}\E\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\\{threshold},\39\\{half\_fraction\_threshold\_k});{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{threshold},\39\\{half\_scaled\_threshold\_k});{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
\&{while} ${}(\\{dep\_info}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{scaling\_down})\5
${}\{{}$\1\6
\&{mp\_number} \|x${},{}$ \\{absv};\7
\\{new\_number}(\|x);\6
\\{new\_number}(\\{absv});\6
${}\\{number\_clone}(\\{absv},\39\|v);{}$\6
\\{number\_abs}(\\{absv});\6
\&{if} ${}(\\{number\_less}(\\{absv},\39\\{p\_over\_v\_threshold\_k})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\|v);{}$\6
\\{convert\_scaled\_to\_fraction}(\|x);\6
${}\\{make\_scaled}(\|w,\39\\{dep\_value}(\|p),\39\|x);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{dep\_value}(\|p));{}$\6
\\{fraction\_to\_round\_scaled}(\|x);\6
${}\\{make\_scaled}(\|w,\39\|x,\39\|v);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|x);\6
\\{free\_number}(\\{absv});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{make\_scaled}(\|w,\39\\{dep\_value}(\|p),\39\|v);{}$\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{test};\7
\\{new\_number}(\\{test});\6
${}\\{number\_clone}(\\{test},\39\|w);{}$\6
\\{number\_abs}(\\{test});\6
\&{if} ${}(\\{number\_lessequal}(\\{test},\39\\{threshold})){}$\5
${}\{{}$\1\6
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|p);{}$\6
${}\|p\K\|s;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_greaterequal}(\\{test},\39\\{coef\_bound\_k})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{fix\_needed}\K\\{true};{}$\6
${}\\{mp\_type}(\\{dep\_info}(\|p))\K\\{independent\_needing\_fix};{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
${}\\{set\_dep\_value}(\|p,\39\|w);{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{test});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \|p);\6
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\\{dep\_value}(\|p),\39\|v);{}$\6
${}\\{set\_dep\_value}(\|p,\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\\{free\_number}(\|v);\6
\\{free\_number}(\|w);\6
\\{free\_number}(\\{threshold});\6
\&{return} (\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{642}Here's another utility routine for dependency lists. When an independent
variable becomes dependent, we want to remove it from all existing
dependencies. The \PB{\\{p\_with\_x\_becoming\_q}} function computes the
dependency list of~\PB{\|p} after variable~\PB{\|x} has been replaced by~\PB{%
\|q}.

This procedure has basically the same calling conventions as \PB{\\{p\_plus%
\_fq}}:
List~\PB{\|q} is unchanged; list~\PB{\|p} is destroyed; the constant node and
the
final link are inherited from~\PB{\|p}; and the fourth parameter tells whether
or not \PB{\|p} is \PB{\\{mp\_proto\_dependent}}. However, the global variable %
\PB{\\{dep\_final}}
is not altered if \PB{\|x} does not occur in list~\PB{\|p}.

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_p\_with\_x\_becoming\_q}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_node} \|x${},\39{}$%
\&{mp\_node} \|q${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|r${},{}$ \|s;\C{ for list manipulation }\6
\&{integer} \\{sx};\C{ serial number of \PB{\|x} }\7
${}\|s\K\|p;{}$\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{sx}\K\\{indep\_value}(\|x);{}$\6
\&{while} ${}(\\{dep\_info}(\|s)\I\NULL\W\\{indep\_value}(\\{dep\_info}(\|s))>%
\\{sx}){}$\5
${}\{{}$\1\6
${}\|r\K\|s;{}$\6
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|s);\6
\4${}\}{}$\2\6
\&{if} ${}(\\{dep\_info}(\|s)\E\NULL\V\\{dep\_info}(\|s)\I\|x){}$\5
${}\{{}$\1\6
\&{return} \|p;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_value\_node} \\{ret};\6
\&{mp\_number} \\{v1};\7
\\{new\_number}(\\{v1});\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{temp\_head},\39{}$(\&{mp\_node}) \|p);\6
${}\\{set\_mp\_link}(\|r,\39\\{mp\_link}(\|s));{}$\6
${}\\{number\_clone}(\\{v1},\39\\{dep\_value}(\|s));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|s);{}$\6
${}\\{ret}\K\\{mp\_p\_plus\_fq}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{mp%
\_link}${}(\\{mp}\MG\\{temp\_head}),\39\\{v1},\39{}$(\&{mp\_value\_node}) %
\|q${},\39\|t,\39\\{mp\_dependent});{}$\6
\\{free\_number}(\\{v1});\6
\&{return} \\{ret};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{643}Here's a simple procedure that reports an error when a variable
has just received a known value that's out of the required range.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_val\_too\_big}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
\|x);\par
\fi

\M{644}\B\&{static} \&{void} \\{mp\_val\_too\_big}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|x)\1\1\2\2\6
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_warning\_check})))\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ equation\ I\ just}\)\.{\
processed\ has\ given}\)\.{\ some\ variable\ a"},\39\.{"value\ outside\ of\ th}%
\)\.{e\ safetyp\ range.\ Con}\)\.{tinue\ and\ I'll\ try"},\39\.{"to\ cope\ with%
\ that\ b}\)\.{ig\ value;\ but\ it\ mig}\)\.{ht\ be\ dangerous."},\39\.{"(Set\
warningcheck:=}\)\.{0\ to\ suppress\ this\ m}\)\.{essage.)"},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Value\ is\ too\ large\ }\)\.{(%
\%s)"},\39\\{number\_tostring}(\|x));{}$\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{645}When a dependent variable becomes known, the following routine
removes its dependency list. Here \PB{\|p} points to the variable, and
\PB{\|q} points to the dependency list (which is one node long).

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_make\_known}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_value\_node} \|q);\par
\fi

\M{646}\B\&{void} \\{mp\_make\_known}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_value\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_variable\_type}\|t;\C{ the previous type }\7
\&{mp\_number} \\{absp};\7
\\{new\_number}(\\{absp});\6
${}\\{set\_prev\_dep}(\\{mp\_link}(\|q),\39\\{prev\_dep}(\|p));{}$\6
${}\\{set\_mp\_link}(\\{prev\_dep}(\|p),\39\\{mp\_link}(\|q));{}$\6
${}\|t\K\\{mp\_type}(\|p);{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{dep\_value}(\|q));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
${}\\{number\_clone}(\\{absp},\39\\{value\_number}(\|p));{}$\6
\\{number\_abs}(\\{absp});\6
\&{if} ${}(\\{number\_greaterequal}(\\{absp},\39\\{warning\_limit\_t})){}$\1\5
${}\\{mp\_val\_too\_big}(\\{mp},\39\\{value\_number}(\|p));{}$\2\6
\&{if} ${}((\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing%
\_equations})))\W\\{mp\_interesting}(\\{mp},\39{}$(\&{mp\_node}) \|p))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\#\#\#\#\ "});{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39{}$(\&{mp\_node}) \|p);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
\\{print\_number}(\\{value\_number}(\|p));\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_exp\_node}(\,)\E{}$(\&{mp\_node}) \|p${}\W\\{mp}\MG\\{cur%
\_exp}.\\{type}\E\|t){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39{}$(\&{mp\_node}) \|p);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absp});\6
\4${}\}{}$\2\par
\fi

\M{647}The \PB{\\{fix\_dependencies}} routine is called into action when \PB{%
\\{fix\_needed}}
has been triggered. The program keeps a list~\PB{\|s} of independent variables
whose coefficients must be divided by~4.

In unusual cases, this fixup process might reduce one or more coefficients
to zero, so that a variable will become known more or less by default.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_fix\_dependencies}(\&{MP} \\{mp});\par
\fi

\M{648}
\Y\B\4\D$\\{independent\_being\_fixed}$ \5
\T{1}\C{ this variable already appears in \PB{\|s} }\par
\Y\B\&{static} \&{void} \\{mp\_fix\_dependencies}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p${},{}$ \|q${},{}$ \|r${},{}$ \|s${},{}$ \|t;\C{ list
manipulation registers }\6
\&{mp\_node} \|x;\C{ an independent variable }\7
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{dep\_head});{}$\6
${}\|s\K\NULL;{}$\6
\&{while} ${}(\|r\I\\{mp}\MG\\{dep\_head}){}$\5
${}\{{}$\1\6
${}\|t\K\|r{}$;\C{ Run through the dependency list for variable \PB{\|t},
fixing       all nodes, and ending with final link~\PB{\|q} }\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\|t\E\|r){}$\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\|t);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
\4${}\}{}$\2\6
${}\|x\K\\{dep\_info}(\|q);{}$\6
\&{if} ${}(\|x\E\NULL){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\|x)\Z\\{independent\_being\_fixed}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|x)<\\{independent\_being\_fixed}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_mp\_link}(\|p,\39{}$(\&{mp\_node}) \|s);\6
${}\|s\K\|p;{}$\6
${}\\{set\_dep\_info}(\|s,\39\|x);{}$\6
${}\\{mp\_type}(\|x)\K\\{independent\_being\_fixed};{}$\6
\4${}\}{}$\2\6
${}\\{set\_dep\_value}(\|q,\39\\{dep\_value}(\|q));{}$\6
${}\\{number\_divide\_int}(\\{dep\_value}(\|q),\39\T{4});{}$\6
\&{if} (\\{number\_zero}(\\{dep\_value}(\|q)))\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|r,\39\\{mp\_link}(\|q));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
${}\|q\K\|r;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|r\K\|q;{}$\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
\&{if} ${}(\|q\E{}$(\&{mp\_value\_node}) \\{dep\_list}(\|t))\1\5
${}\\{mp\_make\_known}(\\{mp},\39\|t,\39\|q);{}$\2\6
\4${}\}{}$\2\6
\&{while} ${}(\|s\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|s);\6
${}\|x\K\\{dep\_info}(\|s);{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|s);{}$\6
${}\|s\K\|p;{}$\6
${}\\{mp\_type}(\|x)\K\\{mp\_independent};{}$\6
${}\\{set\_indep\_scale}(\|x,\39\\{indep\_scale}(\|x)+\T{2});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{fix\_needed}\K\\{false};{}$\6
\4${}\}{}$\2\par
\fi

\M{649}The \PB{\\{new\_dep}} routine installs a dependency list~\PB{\|p} based
on the value node~\PB{\|q},
linking it into the list of all known dependencies. It replaces \PB{\|q} with
the new
dependency node. We assume that \PB{\\{dep\_final}} points to the final node of
list~\PB{\|p}.

\Y\B\&{static} \&{void} \\{mp\_new\_dep}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|q${},\39\\{mp\_variable\_type}\\{newtype},\39{}$\&{mp\_value\_node} \|p)\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|r;\C{ what used to be the first dependency }\7
${}\.{FUNCTION\_TRACE4}(\.{"mp\_new\_dep(\%p,\%d,\%p}\)\.{)\\n"},\39\|q,\39%
\\{newtype},\39\|p);{}$\6
${}\\{mp\_type}(\|q)\K\\{newtype};{}$\6
${}\\{set\_dep\_list}(\|q,\39\|p);{}$\6
${}\\{set\_prev\_dep}(\|q,\39{}$(\&{mp\_node}) \\{mp}${}\MG\\{dep\_head});{}$\6
${}\|r\K\\{mp\_link}(\\{mp}\MG\\{dep\_head});{}$\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{dep\_final},\39\|r);{}$\6
${}\\{set\_prev\_dep}(\|r,\39{}$(\&{mp\_node}) \\{mp}${}\MG\\{dep\_final});{}$\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{dep\_head},\39\|q);{}$\6
\4${}\}{}$\2\par
\fi

\M{650}Here is one of the ways a dependency list gets started.
The \PB{\\{const\_dependency}} routine produces a list that has nothing but
a constant term.

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_const\_dependency}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_number} \|v)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp}\MG\\{dep\_final}\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_dep\_value}(\\{mp}\MG\\{dep\_final},\39\|v);{}$\6
${}\\{set\_dep\_info}(\\{mp}\MG\\{dep\_final},\39\NULL);{}$\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ mp\_const\_depen}\)\.{dency(\%d)\\n"},\39%
\\{mp}\MG\\{dep\_final},\39\\{number\_to\_scaled}(\|v));{}$\6
\&{return} \\{mp}${}\MG\\{dep\_final};{}$\6
\4${}\}{}$\2\par
\fi

\M{651}And here's a more interesting way to start a dependency list from
scratch:
The parameter to \PB{\\{single\_dependency}} is the location of an
independent variable~\PB{\|x}, and the result is the simple dependency list
`\PB{$\|x+\T{0}$}'.

In the unlikely event that the given independent variable has been doubled so
often that we can't refer to it with a nonzero coefficient,
\PB{\\{single\_dependency}} returns the simple list `0'.  This case can be
recognized by testing that the returned list pointer is equal to
\PB{\\{dep\_final}}.

\Y\B\4\D$\\{two\_to\_the}(\|A)$ \5
$(\T{1}\LL(\&{unsigned})(\|A){}$)\par
\Y\B\&{static} \&{mp\_value\_node} \\{mp\_single\_dependency}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q${},{}$ \\{rr};\C{ the new dependency list }\6
\&{integer} \|m;\C{ the number of doublings }\7
${}\|m\K\\{indep\_scale}(\|p);{}$\6
\&{if} ${}(\|m>\T{28}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_const\_dependency}(\\{mp},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{set\_dep\_value}(\|q,\39\\{zero\_t});{}$\6
${}\\{set\_number\_from\_scaled}(\\{dep\_value}(\|q),\39{}$(\&{integer}) \\{two%
\_to\_the}${}(\T{28}-\|m));{}$\6
${}\\{set\_dep\_info}(\|q,\39\|p);{}$\6
${}\\{rr}\K\\{mp\_const\_dependency}(\\{mp},\39\\{zero\_t});{}$\6
${}\\{set\_mp\_link}(\|q,\39{}$(\&{mp\_node}) \\{rr});\6
\4${}\}{}$\2\6
${}\.{FUNCTION\_TRACE3}(\.{"\%p\ =\ mp\_single\_depe}\)\.{ndency(\%p)\\n"},\39%
\|q,\39\|p);{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{652}We sometimes need to make an exact copy of a dependency list.

\Y\B\&{static} \&{mp\_value\_node} \\{mp\_copy\_dep\_list}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_value\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ the new dependency list }\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_copy\_dep\_list(\%p}\)\.{)\\n"},\39\|p);{}$\6
${}\|q\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
${}\\{mp}\MG\\{dep\_final}\K\|q;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{set\_dep\_info}(\\{mp}\MG\\{dep\_final},\39\\{dep\_info}(\|p));{}$\6
${}\\{set\_dep\_value}(\\{mp}\MG\\{dep\_final},\39\\{dep\_value}(\|p));{}$\6
\&{if} ${}(\\{dep\_info}(\\{mp}\MG\\{dep\_final})\E\NULL){}$\1\5
\&{break};\2\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{dep\_final},\39{}$(\&{mp\_node}) \\{mp\_get%
\_dep\_node}(\\{mp}));\6
${}\\{mp}\MG\\{dep\_final}\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG%
\\{dep\_final});{}$\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{653}But how do variables normally become known? Ah, now we get to the heart
of the
equation-solving mechanism. The \PB{\\{linear\_eq}} procedure is given a \PB{%
\\{dependent}}
or \PB{\\{mp\_proto\_dependent}} list,~\PB{\|p}, in which at least one
independent variable
appears. It equates this list to zero, by choosing an independent variable
with the largest coefficient and making it dependent on the others. The
newly dependent variable is eliminated from all current dependencies,
thereby possibly making other dependent variables known.

The given list \PB{\|p} is, of course, totally destroyed by all this
processing.

\Y\B\&{static} \&{mp\_value\_node} \\{find\_node\_with\_largest\_coefficient}(%
\&{MP} \\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_number} ${}{*}%
\|v);{}$\6
\&{static} \&{void} \\{display\_new\_dependency}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p${},\39{}$\&{mp\_node} \|x${},\39{}$\&{integer} \|n);\6
\&{static} \&{void} \\{change\_to\_known}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_node} \|x${},\39{}$\&{mp\_value\_node} \\{final%
\_node}${},\39{}$\&{integer} \|n);\6
\&{static} \&{mp\_value\_node} \\{divide\_p\_by\_minusv\_removing\_q}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_value\_node} \|q${},%
\39{}$\&{mp\_value\_node} ${}{*}\\{final\_node},\39{}$\&{mp\_number} \|v${},%
\39{}$\&{quarterword} \|t);\6
\&{static} \&{mp\_value\_node} \\{divide\_p\_by\_2\_n}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_value\_node} \|p${},\39{}$\&{integer} \|n);\7
\&{static} \&{void} \\{mp\_linear\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|r;\C{ for link manipulation }\6
\&{mp\_node} \|x;\C{ the variable that loses its independence }\6
\&{integer} \|n;\C{ the number of times \PB{\|x} had been halved }\6
\&{mp\_number} \|v;\C{ the coefficient of \PB{\|x} in list \PB{\|p} }\6
\&{mp\_value\_node} \\{prev\_r};\C{ lags one step behind \PB{\|r} }\6
\&{mp\_value\_node} \\{final\_node};\C{ the constant term of the new dependency
list }\6
\&{mp\_value\_node} \\{qq};\7
\\{new\_number}(\|v);\6
${}\.{FUNCTION\_TRACE3}(\.{"mp\_linear\_eq(\%p,\%d)}\)\.{\\n"},\39\|p,\39%
\|t);{}$\6
${}\\{qq}\K\\{find\_node\_with\_largest\_coefficient}(\\{mp},\39\|p,\39{\AND}%
\|v);{}$\6
${}\|x\K\\{dep\_info}(\\{qq});{}$\6
${}\|n\K\\{indep\_scale}(\|x);{}$\6
${}\|p\K\\{divide\_p\_by\_minusv\_removing\_q}(\\{mp},\39\|p,\39\\{qq},\39{%
\AND}\\{final\_node},\39\|v,\39\|t);{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_equations})))\5
${}\{{}$\1\6
${}\\{display\_new\_dependency}(\\{mp},\39\|p,\39{}$(\&{mp\_node}) \|x${},\39%
\|n);{}$\6
\4${}\}{}$\2\6
${}\\{prev\_r}\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{dep\_head};{}$\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{dep\_head});{}$\6
\&{while} ${}(\|r\I\\{mp}\MG\\{dep\_head}){}$\5
${}\{{}$\1\6
\&{mp\_value\_node} \|s${}\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\|r);\6
\&{mp\_value\_node} \|q${}\K\\{mp\_p\_with\_x\_becoming\_q}(\\{mp},\39\|s,\39%
\|x,\39{}$(\&{mp\_node}) \|p${},\39\\{mp\_type}(\|r));{}$\7
\&{if} ${}(\\{dep\_info}(\|q)\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_make\_known}(\\{mp},\39\|r,\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_dep\_list}(\|r,\39\|q);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
\4${}\}{}$\2\5
\&{while} ${}(\\{dep\_info}(\|q)\I\NULL);{}$\6
${}\\{prev\_r}\K\|q;{}$\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\\{prev\_r});\6
\4${}\}{}$\2\6
\&{if} ${}(\|n>\T{0}){}$\5
${}\{{}$\1\6
${}\|p\K\\{divide\_p\_by\_2\_n}(\\{mp},\39\|p,\39\|n);{}$\6
\4${}\}{}$\2\6
${}\\{change\_to\_known}(\\{mp},\39\|p,\39{}$(\&{mp\_node}) \|x${},\39\\{final%
\_node},\39\|n);{}$\6
\&{if} ${}(\\{mp}\MG\\{fix\_needed}){}$\1\5
\\{mp\_fix\_dependencies}(\\{mp});\2\6
\\{free\_number}(\|v);\6
\4${}\}{}$\2\par
\fi

\M{654}
\Y\B\&{static} \&{mp\_value\_node} \\{find\_node\_with\_largest\_coefficient}(%
\&{MP} \\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_number} ${}{*}%
\|v){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{vabs};\C{ its absolute value of v}\6
\&{mp\_number} \\{rabs};\C{ the absolute value of \PB{\\{dep\_value}(\|r)} }\6
\&{mp\_value\_node} \|q${}\K\|p;{}$\6
\&{mp\_value\_node} \|r${}\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\7
\\{new\_number}(\\{vabs});\6
\\{new\_number}(\\{rabs});\6
${}\\{number\_clone}({*}\|v,\39\\{dep\_value}(\|q));{}$\6
\&{while} ${}(\\{dep\_info}(\|r)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vabs},\39{*}\|v);{}$\6
\\{number\_abs}(\\{vabs});\6
${}\\{number\_clone}(\\{rabs},\39\\{dep\_value}(\|r));{}$\6
\\{number\_abs}(\\{rabs});\6
\&{if} ${}(\\{number\_greater}(\\{rabs},\39\\{vabs})){}$\5
${}\{{}$\1\6
${}\|q\K\|r;{}$\6
${}\\{number\_clone}({*}\|v,\39\\{dep\_value}(\|r));{}$\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{vabs});\6
\\{free\_number}(\\{rabs});\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{655}Here we want to change the coefficients from \PB{\\{scaled}} to \PB{%
\\{fraction}},
except in the constant term. In the common case of a trivial equation
like `\.{x=3.14}', we will have \PB{$\|v\K{-}\\{fraction\_one}$}, \PB{$\|q\K%
\|p$}, and \PB{$\|t\K\\{mp\_dependent}$}.

\Y\B\&{static} \&{mp\_value\_node} \\{divide\_p\_by\_minusv\_removing\_q}(%
\&{MP} \\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_value\_node} %
\|q${},\39{}$\&{mp\_value\_node} ${}{*}\\{final\_node},\39{}$\&{mp\_number} %
\|v${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|r;\C{ for link manipulation }\6
\&{mp\_value\_node} \|s;\7
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\|s,\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\|r\E\|q){}$\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|s,\39\\{mp\_link}(\|r));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \|w;\C{ a tentative coefficient }\6
\&{mp\_number} \\{absw};\7
\\{new\_number}(\|w);\6
\\{new\_number}(\\{absw});\6
${}\\{make\_fraction}(\|w,\39\\{dep\_value}(\|r),\39\|v);{}$\6
${}\\{number\_clone}(\\{absw},\39\|w);{}$\6
\\{number\_abs}(\\{absw});\6
\&{if} ${}(\\{number\_lessequal}(\\{absw},\39\\{half\_fraction\_threshold%
\_k})){}$\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|s,\39\\{mp\_link}(\|r));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{number\_negate}(\|w);\6
${}\\{set\_dep\_value}(\|r,\39\|w);{}$\6
${}\|s\K\|r;{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|w);\6
\\{free\_number}(\\{absw});\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|s);\6
\4${}\}{}$\2\5
\&{while} ${}(\\{dep\_info}(\|r)\I\NULL);{}$\6
\&{if} ${}(\|t\E\\{mp\_proto\_dependent}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\\{dep\_value}(\|r),\39\|v);{}$\6
\\{number\_negate}(\\{ret});\6
${}\\{set\_dep\_value}(\|r,\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_to\_scaled}(\|v)\I{-}\\{number\_to\_scaled}(%
\\{fraction\_one\_t})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_fraction}(\\{ret});\6
${}\\{make\_fraction}(\\{ret},\39\\{dep\_value}(\|r),\39\|v);{}$\6
\\{number\_negate}(\\{ret});\6
${}\\{set\_dep\_value}(\|r,\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
${}{*}\\{final\_node}\K\|r;{}$\6
\&{return} (\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{656}
\Y\B\&{static} \&{void} \\{display\_new\_dependency}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_value\_node} \|p${},\39{}$\&{mp\_node} \|x${},\39{}$\&{integer} \|n)\1\1%
\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_interesting}(\\{mp},\39\|x)){}$\5
${}\{{}$\1\6
\&{int} \\{w0};\7
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\#\#\ "});{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|x);{}$\6
${}\\{w0}\K\|n;{}$\6
\&{while} ${}(\\{w0}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"*4"});{}$\6
${}\\{w0}\K\\{w0}-\T{2};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
${}\\{mp\_print\_dependency}(\\{mp},\39\|p,\39\\{mp\_dependent});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{657}The \PB{$\|n>\T{0}$} test is repeated here because it is of vital
importance to the
function's functioning.

\Y\B\&{static} \&{mp\_value\_node} \\{divide\_p\_by\_2\_n}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{integer} \|n)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \\{pp}${}\K\NULL;{}$\7
\&{if} ${}(\|n>\T{0}){}$\5
${}\{{}$\C{ Divide list \PB{\|p} by $2^n$ }\1\6
\&{mp\_value\_node} \|r;\6
\&{mp\_value\_node} \|s;\6
\&{mp\_number} \\{absw};\6
\&{mp\_number} \|w;\C{ a tentative coefficient }\7
\\{new\_number}(\|w);\6
\\{new\_number}(\\{absw});\6
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{temp\_head},\39{}$(\&{mp\_node}) \|p);\6
${}\|r\K\|p;{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\|n>\T{30}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\|w);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|w,\39\\{dep\_value}(\|r));{}$\6
${}\\{number\_divide\_int}(\|w,\39\\{two\_to\_the}(\|n));{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{absw},\39\|w);{}$\6
\\{number\_abs}(\\{absw});\6
\&{if} ${}(\\{number\_lessequal}(\\{absw},\39\\{half\_fraction\_threshold\_k})%
\W(\\{dep\_info}(\|r)\I\NULL)){}$\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|s,\39\\{mp\_link}(\|r));{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|r);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_dep\_value}(\|r,\39\|w);{}$\6
${}\|s\K\|r;{}$\6
\4${}\}{}$\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|s);\6
\4${}\}{}$\2\5
\&{while} ${}(\\{dep\_info}(\|s)\I\NULL);{}$\6
${}\\{pp}\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{temp%
\_head});{}$\6
\\{free\_number}(\\{absw});\6
\\{free\_number}(\|w);\6
\4${}\}{}$\2\6
\&{return} \\{pp};\6
\4${}\}{}$\2\par
\fi

\M{658}
\Y\B\&{static} \&{void} \\{change\_to\_known}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p${},\39{}$\&{mp\_node} \|x${},\39{}$\&{mp\_value\_node} %
\\{final\_node}${},\39{}$\&{integer} \|n)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{dep\_info}(\|p)\E\NULL){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{absx};\7
\\{new\_number}(\\{absx});\6
${}\\{mp\_type}(\|x)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|x,\39\\{dep\_value}(\|p));{}$\6
${}\\{number\_clone}(\\{absx},\39\\{value\_number}(\|x));{}$\6
\\{number\_abs}(\\{absx});\6
\&{if} ${}(\\{number\_greaterequal}(\\{absx},\39\\{warning\_limit\_t})){}$\1\5
${}\\{mp\_val\_too\_big}(\\{mp},\39\\{value\_number}(\|x));{}$\2\6
\\{free\_number}(\\{absx});\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\\{cur\_exp\_node}(\,)\E\|x\W\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp%
\_independent}){}$\5
${}\{{}$\1\6
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\|x));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|x);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{dep\_final}\K\\{final\_node};{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|x,\39\\{mp\_dependent},\39\|p);{}$\6
\&{if} ${}(\\{cur\_exp\_node}(\,)\E\|x\W\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp%
\_independent}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_dependent};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{659}Dynamic nonlinear equations.
Variables of numeric type are maintained by the general scheme of
independent, dependent, and known values that we have just studied;
and the components of pair and transform variables are handled in the
same way. But \MP\ also has five other types of values: \&{boolean},
\&{string}, \&{pen}, \&{path}, and \&{picture}; what about them?

Equations are allowed between nonlinear quantities, but only in a
simple form. Two variables that haven't yet been assigned values are
either equal to each other, or they're not.

Before a boolean variable has received a value, its type is \PB{\\{mp\_unknown%
\_boolean}};
similarly, there are variables whose type is \PB{\\{mp\_unknown\_string}}, \PB{%
\\{mp\_unknown\_pen}},
\PB{\\{mp\_unknown\_path}}, and \PB{\\{mp\_unknown\_picture}}. In such cases
the value is either
\PB{$\NULL$} (which means that no other variables are equivalent to this one),
or
it points to another variable of the same undefined type. The pointers in the
latter case form a cycle of nodes, which we shall call a ``ring.''
Rings of undefined variables may include capsules, which arise as
intermediate results within expressions or as \&{expr} parameters to macros.

When one member of a ring receives a value, the same value is given to
all the other members. In the case of paths and pictures, this implies
making separate copies of a potentially large data structure; users should
restrain their enthusiasm for such generality, unless they have lots and
lots of memory space.

\fi

\M{660}The following procedure is called when a capsule node is being
added to a ring (e.g., when an unknown variable is mentioned in an expression).

\Y\B\&{static} \&{mp\_node} \\{mp\_new\_ring\_entry}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the new capsule node }\7
${}\|q\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|q)\K\\{mp\_capsule};{}$\6
${}\\{mp\_type}(\|q)\K\\{mp\_type}(\|p);{}$\6
\&{if} ${}(\\{value\_node}(\|p)\E\NULL){}$\1\5
${}\\{set\_value\_node}(\|q,\39\|p);{}$\2\6
\&{else}\1\5
${}\\{set\_value\_node}(\|q,\39\\{value\_node}(\|p));{}$\2\6
${}\\{set\_value\_node}(\|p,\39\|q);{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{661}Conversely, we might delete a capsule or a variable before it becomes
known.
The following procedure simply detaches a quantity from its ring,
without recycling the storage.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_ring\_delete}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p);\par
\fi

\M{662}\B\&{void} \\{mp\_ring\_delete}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\7
(\&{void}) \\{mp};\6
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\|q\I\NULL\W\|q\I\|p){}$\5
${}\{{}$\1\6
\&{while} ${}(\\{value\_node}(\|q)\I\|p){}$\1\5
${}\|q\K\\{value\_node}(\|q);{}$\2\6
${}\\{set\_value\_node}(\|q,\39\\{value\_node}(\|p));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{663}Eventually there might be an equation that assigns values to all of the
variables in a ring. The \PB{\\{nonlinear\_eq}} subroutine does the necessary
propagation of values.

If the parameter \PB{\\{flush\_p}} is \PB{\\{true}}, node \PB{\|p} itself
needn't receive a
value, it will soon be recycled.

\Y\B\&{static} \&{void} \\{mp\_nonlinear\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value} \|v${},\39{}$\&{mp\_node} \|p${},\39{}$\&{boolean} \\{flush\_p})\1\1\2%
\2\6
${}\{{}$\1\6
\\{mp\_variable\_type}\|t;\C{ the type of ring \PB{\|p} }\7
\&{mp\_node} \|q${},{}$ \|r;\C{ link manipulation registers }\7
${}\|t\K(\\{mp\_type}(\|p)-\\{unknown\_tag});{}$\6
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} (\\{flush\_p})\1\5
${}\\{mp\_type}(\|p)\K\\{mp\_vacuous};{}$\2\6
\&{else}\1\5
${}\|p\K\|q;{}$\2\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\\{value\_node}(\|q);{}$\6
${}\\{mp\_type}(\|q)\K\|t;{}$\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_boolean\_type}:\5
${}\\{set\_value\_number}(\|q,\39\|v.\\{data}.\|n);{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
${}\\{set\_value\_str}(\|q,\39\|v.\\{data}.\\{str});{}$\6
${}\\{add\_str\_ref}(\|v.\\{data}.\\{str});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
${}\\{set\_value\_knot}(\|q,\39\\{copy\_pen}(\|v.\\{data}.\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{set\_value\_knot}(\|q,\39\\{mp\_copy\_path}(\\{mp},\39\|v.\\{data}.%
\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
${}\\{set\_value\_node}(\|q,\39\|v.\\{data}.\\{node});{}$\6
${}\\{add\_edge\_ref}(\|v.\\{data}.\\{node});{}$\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\C{ there ain't no more cases }\2\6
${}\|q\K\|r;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{664}If two members of rings are equated, and if they have the same type,
the \PB{\\{ring\_merge}} procedure is called on to make them equivalent.

\Y\B\&{static} \&{void} \\{mp\_ring\_merge}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p${},\39{}$\&{mp\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|r;\C{ traverses one list }\7
${}\|r\K\\{value\_node}(\|p);{}$\6
\&{while} ${}(\|r\I\|p){}$\5
${}\{{}$\1\6
\&{if} ${}(\|r\E\|q){}$\5
${}\{{}$\1\6
\\{exclaim\_redundant\_equation}(\\{mp});\6
\&{return};\6
\4${}\}{}$\2\6
;\6
${}\|r\K\\{value\_node}(\|r);{}$\6
\4${}\}{}$\2\6
${}\|r\K\\{value\_node}(\|p);{}$\6
${}\\{set\_value\_node}(\|p,\39\\{value\_node}(\|q));{}$\6
${}\\{set\_value\_node}(\|q,\39\|r);{}$\6
\4${}\}{}$\2\par
\fi

\M{665}\B\&{static} \&{void} \\{exclaim\_redundant\_equation}(\&{MP} \\{mp})\1%
\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ already\ knew\ that}\)\.{\ this\
equation\ was\ t}\)\.{rue."},\39\.{"But\ perhaps\ no\ harm}\)\.{\ has\ been\
done;\ let'}\)\.{s\ continue."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Redundant\ equation"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{666}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{exclaim\_redundant\_equation}(\&{MP} \\{mp});\par
\fi

\N{1}{667}Introduction to the syntactic routines.
Let's pause a moment now and try to look at the Big Picture.
The \MP\ program consists of three main parts: syntactic routines,
semantic routines, and output routines. The chief purpose of the
syntactic routines is to deliver the user's input to the semantic routines,
while parsing expressions and locating operators and operands. The
semantic routines act as an interpreter responding to these operators,
which may be regarded as commands. And the output routines are
periodically called on to produce compact font descriptions that can be
used for typesetting or for making interim proof drawings. We have
discussed the basic data structures and many of the details of semantic
operations, so we are good and ready to plunge into the part of \MP\ that
actually controls the activities.

Our current goal is to come to grips with the \PB{\\{get\_next}} procedure,
which is the keystone of \MP's input mechanism. Each call of \PB{\\{get\_next}}
sets the value of three variables \PB{\\{cur\_cmd}}, \PB{\\{cur\_mod}}, and %
\PB{\\{cur\_sym}},
representing the next input token.
$$\vbox{\halign{#\hfil\cr
\hbox{\PB{\\{cur\_cmd}} denotes a command code from the long list of codes
given earlier;}\cr
\hbox{\PB{\\{cur\_mod}} denotes a modifier or operand of the command code;}\cr
\hbox{\PB{\\{cur\_sym}} is the hash address of the symbolic token that was
just scanned,}\cr
\hbox{\qquad or zero in the case of a numeric or string
or capsule token.}\cr}}$$
Underlying this external behavior of \PB{\\{get\_next}} is all the machinery
necessary to convert from character files to tokens. At a given time we
may be only partially finished with the reading of several files (for
which \&{input} was specified), and partially finished with the expansion
of some user-defined macros and/or some macro parameters, and partially
finished reading some text that the user has inserted online,
and so on. When reading a character file, the characters must be
converted to tokens; comments and blank spaces must
be removed, numeric and string tokens must be evaluated.

To handle these situations, which might all be present simultaneously,
\MP\ uses various stacks that hold information about the incomplete
activities, and there is a finite state control for each level of the
input mechanism. These stacks record the current state of an implicitly
recursive process, but the \PB{\\{get\_next}} procedure is not recursive.

\Y\B\4\D$\\{cur\_cmd}()$ \5
$(\&{unsigned})(\\{mp}\MG\\{cur\_mod\_}\MG\\{type}{}$)\par
\B\4\D$\\{set\_cur\_cmd}(\|A)$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{type}\K{}$(\|A)\par
\B\4\D$\\{cur\_mod\_int}()$ \5
$\\{number\_to\_int}(\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\|n{}$)\C{ operand of
current command }\par
\B\4\D$\\{cur\_mod}()$ \5
$\\{number\_to\_scaled}(\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\|n{}$)\C{ operand
of current command }\par
\B\4\D$\\{cur\_mod\_number}()$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.{}$\|n\C{ operand of current command }\par
\B\4\D$\\{set\_cur\_mod}(\|A)$ \5
$\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\|n,\39(%
\|A){}$)\par
\B\4\D$\\{set\_cur\_mod\_number}(\|A)$ \5
$\\{number\_clone}(\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\|n,\39(\|A){}$)\par
\B\4\D$\\{cur\_mod\_node}()$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.{}$\\{node}\par
\B\4\D$\\{set\_cur\_mod\_node}(\|A)$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\\{node}\K{}$(\|A)\par
\B\4\D$\\{cur\_mod\_str}()$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.{}$\\{str}\par
\B\4\D$\\{set\_cur\_mod\_str}(\|A)$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\\{str}\K{}$(\|A)\par
\B\4\D$\\{cur\_sym}()$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.{}$\\{sym}\par
\B\4\D$\\{set\_cur\_sym}(\|A)$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{data}.\\{sym}\K{}$(\|A)\par
\B\4\D$\\{cur\_sym\_mod}()$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG{}$\\{name\_type}\par
\B\4\D$\\{set\_cur\_sym\_mod}(\|A)$ \5
$\\{mp}\MG\\{cur\_mod\_}\MG\\{name\_type}\K{}$(\|A)\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} \\{cur\_mod\_};\C{ current command, symbol, and its operands }\par
\fi

\M{668}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{cur\_mod\_}\K\\{mp\_get\_symbolic\_node}(\\{mp}){}$;\par
\fi

\M{669}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{mp}\MG\\{cur\_mod\_}){}$;\par
\fi

\M{670}The \PB{\\{print\_cmd\_mod}} routine prints a symbolic interpretation of
a
command code and its modifier.
It consists of a rather tedious sequence of print
commands, and most of it is essentially an inverse to the \PB{\\{primitive}}
routine that enters a \MP\ primitive into \PB{\\{hash}} and \PB{\\{eqtb}}.
Therefore almost
all of this procedure appears elsewhere in the program, together with the
corresponding \PB{\\{primitive}} calls.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_cmd\_mod}(\&{MP} \\{mp}${},\39{}$\&{integer} %
\|c${},\39{}$\&{integer} \|m);\par
\fi

\M{671}\B\&{void} \\{mp\_print\_cmd\_mod}(\&{MP} \\{mp}${},\39{}$\&{integer} %
\|c${},\39{}$\&{integer} \|m)\1\1 $\{$ \&{switch} (\|c) $\{$ \X233:Cases of %
\PB{\\{print\_cmd\_mod}} for symbolic printing of primitives\X \6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"[unknown\ command\ co}\)\.{de!]"});{}$\6
\&{break}; $\}$ $\}{}$\par
\fi

\M{672}Here is a procedure that displays a given command in braces, in the
user's transcript file.

\Y\B\4\D$\\{show\_cur\_cmd\_mod}$ \5
$\\{mp\_show\_cmd\_mod}(\\{mp},\39\\{cur\_cmd}(\,),\39\\{cur\_mod}(\,){}$)\par
\Y\B\&{static} \&{void} \\{mp\_show\_cmd\_mod}(\&{MP} \\{mp}${},\39{}$%
\&{integer} \|c${},\39{}$\&{integer} \|m)\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{"});{}$\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\|c,\39\|m);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{673}Input stacks and states.
The state of \MP's input mechanism appears in the input stack, whose
entries are records with five fields, called \PB{\\{index}}, \PB{\\{start}}, %
\PB{\\{loc}},
\PB{\\{limit}}, and \PB{\\{name}}. The top element of this stack is maintained
in a
global variable for which no subscripting needs to be done; the other
elements of the stack appear in an array. Hence the stack is declared thus:

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{char} ${}{*}\\{long\_name\_field};{}$\6
\&{halfword} \\{start\_field}${},{}$ \\{loc\_field}${},{}$ \\{limit\_field};\6
\&{mp\_node} \\{nstart\_field}${},{}$ \\{nloc\_field};\6
\&{mp\_string} \\{name\_field};\6
\&{quarterword} \\{index\_field};\2\6
${}\}{}$ \&{in\_state\_record};\par
\fi

\M{674}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{in\_state\_record} ${}{*}\\{input\_stack};{}$\6
\&{integer} \\{input\_ptr};\C{ first unused location of \PB{\\{input\_stack}} }%
\6
\&{integer} \\{max\_in\_stack};\C{ largest value of \PB{\\{input\_ptr}} when
pushing }\6
\&{in\_state\_record} \\{cur\_input};\C{ the ``top'' input state }\6
\&{int} \\{stack\_size};\C{ maximum number of simultaneous input sources }\par
\fi

\M{675}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{stack\_size}\K\T{16};{}$\6
${}\\{mp}\MG\\{input\_stack}\K\\{xmalloc}((\\{mp}\MG\\{stack\_size}+\T{1}),\39%
\&{sizeof}(\&{in\_state\_record})){}$;\par
\fi

\M{676}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{input\_stack}){}$;\par
\fi

\M{677}We've already defined the special variable \PB{$\\{loc}\E\\{cur\_input}.%
\\{loc\_field}$}
in our discussion of basic input-output routines. The other components of
\PB{\\{cur\_input}} are defined in the same way:

\Y\B\4\D$\\{iindex}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{index\_field}\C{ reference for buffer
information }\par
\B\4\D$\\{start}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{start\_field}\C{ starting position in \PB{%
\\{buffer}} }\par
\B\4\D$\\{limit}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{limit\_field}\C{ end of current line in \PB{%
\\{buffer}} }\par
\B\4\D$\\{name}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{name\_field}\C{ name of the current file }\par
\fi

\M{678}Let's look more closely now at the five control variables
(\PB{\\{index}},~\PB{\\{start}},~\PB{\\{loc}},~\PB{\\{limit}},~\PB{\\{name}}),
assuming that \MP\ is reading a line of characters that have been input
from some file or from the user's terminal. There is an array called
\PB{\\{buffer}} that acts as a stack of all lines of characters that are
currently being read from files, including all lines on subsidiary
levels of the input stack that are not yet completed. \MP\ will return to
the other lines when it is finished with the present input file.

(Incidentally, on a machine with byte-oriented addressing, it would be
appropriate to combine \PB{\\{buffer}} with the \PB{\\{str\_pool}} array,
letting the buffer entries grow downward from the top of the string pool
and checking that these two tables don't bump into each other.)

The line we are currently working on begins in position \PB{\\{start}} of the
buffer; the next character we are about to read is \PB{\\{buffer}[\\{loc}]};
and
\PB{\\{limit}} is the location of the last character present. We always have
\PB{$\\{loc}\Z\\{limit}$}. For convenience, \PB{\\{buffer}[\\{limit}]} has been
set to \PB{\.{"\%"}}, so
that the end of a line is easily sensed.

The \PB{\\{name}} variable is a string number that designates the name of
the current file, if we are reading an ordinary text file.  Special codes
\PB{$\\{is\_term}\MRL{{.}{.}}\\{max\_spec\_src}$} indicate other sources of
input text.

\Y\B\4\D$\\{is\_term}$ \5
(\&{mp\_string}) \T{0}\C{ \PB{\\{name}} value when reading from the terminal
for normal input }\par
\B\4\D$\\{is\_read}$ \5
(\&{mp\_string}) \T{1}\C{ \PB{\\{name}} value when executing a \&{readstring}
or \&{readfrom} }\par
\B\4\D$\\{is\_scantok}$ \5
(\&{mp\_string}) \T{2}\C{ \PB{\\{name}} value when reading text generated by %
\&{scantokens} }\par
\B\4\D$\\{max\_spec\_src}$ \5
\\{is\_scantok}\par
\fi

\M{679}Additional information about the current line is available via the
\PB{\\{index}} variable, which counts how many lines of characters are present
in the buffer below the current level. We have \PB{$\\{index}\K\T{0}$} when
reading
from the terminal and prompting the user for each line; then if the user types,
e.g., `\.{input figs}', we will have \PB{$\\{index}\K\T{1}$} while reading
the file \.{figs.mp}. However, it does not follow that \PB{\\{index}} is the
same as the input stack pointer, since many of the levels on the input
stack may come from token lists and some \PB{\\{index}} values may correspond
to \.{MPX} files that are not currently on the stack.

The global variable \PB{\\{in\_open}} is equal to the highest \PB{\\{index}}
value counting
\.{MPX} files but excluding token-list input levels.  Thus, the number of
partially read lines in the buffer is \PB{$\\{in\_open}+\T{1}$} and we have %
\PB{$\\{in\_open}\G\\{index}$}
when we are not reading a token list.

If we are not currently reading from the terminal,
we are reading from the file variable \PB{\\{input\_file}[\\{index}]}. We use
the notation \PB{\\{terminal\_input}} as a convenient abbreviation for \PB{$%
\\{name}\K\\{is\_term}$},
and \PB{\\{cur\_file}} as an abbreviation for \PB{\\{input\_file}[\\{index}]}.

When \MP\ is not reading from the terminal, the global variable \PB{\&{line}}
contains
the line number in the current file, for use in error messages. More precisely,
\PB{\&{line}} is a macro for \PB{\\{line\_stack}[\\{index}]} and the \PB{%
\\{line\_stack}} array gives
the line number for each file in the \PB{\\{input\_file}} array.

When an \.{MPX} file is opened the file name is stored in the \PB{\\{mpx%
\_name}}
array so that the name doesn't get lost when the file is temporarily removed
from the input stack.
Thus when \PB{\\{input\_file}[\|k]} is an \.{MPX} file, its name is \PB{\\{mpx%
\_name}[\|k]}
and it contains translated \TeX\ pictures for \PB{$\\{input\_file}[\|k-%
\T{1}]$}.
Since this is not an \.{MPX} file, we have
$$ \hbox{\PB{$\\{mpx\_name}[\|k-\T{1}]\Z\\{absent}$}}. $$
This \PB{\\{name}} field is set to \PB{\\{finished}} when \PB{\\{input\_file}[%
\|k]} is completely
read.

If more information about the input state is needed, it can be
included in small arrays like those shown here. For example,
the current page or segment number in the input file might be put
into a variable \PB{\\{page}}, that is really a macro for the current entry
in `\ignorespaces\PB{\\{page\_stack}: \\{array}[\T{0..}\\{max\_in\_open}]\\{of}
\&{integer}}\unskip'
by analogy with \PB{\\{line\_stack}}.

\Y\B\4\D$\\{terminal\_input}$ \5
$(\\{name}\E\\{is\_term}{}$)\C{ are we reading from the terminal? }\par
\B\4\D$\\{cur\_file}$ \5
$\\{mp}\MG\\{input\_file}{}$[\\{iindex}]\C{ the current \PB{\&{void} ${}{*}$}
variable }\par
\B\4\D$\&{line}$ \5
$\\{mp}\MG\\{line\_stack}{}$[\\{iindex}]\C{ current line number in the current
source file }\par
\B\4\D$\\{in\_ext}$ \5
$\\{mp}\MG\\{inext\_stack}{}$[\\{iindex}]\C{ a string used to construct \.{MPX}
file names }\par
\B\4\D$\\{in\_name}$ \5
$\\{mp}\MG\\{iname\_stack}{}$[\\{iindex}]\C{ a string used to construct \.{MPX}
file names }\par
\B\4\D$\\{in\_area}$ \5
$\\{mp}\MG\\{iarea\_stack}{}$[\\{iindex}]\C{ another string for naming \.{MPX}
files }\par
\B\4\D$\\{absent}$ \5
(\&{mp\_string}) \T{1}\C{ \PB{\\{name\_field}} value for unused \PB{\\{mpx\_in%
\_stack}} entries }\par
\B\4\D$\\{mpx\_reading}$ \5
$(\\{mp}\MG\\{mpx\_name}[\\{iindex}]>\\{absent}{}$)\C{ when reading a file, is
it an \.{MPX} file? }\par
\B\4\D$\\{mpx\_finished}$ \5
\T{0}\C{ \PB{\\{name\_field}} value when the corresponding \.{MPX} file is
finished }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{in\_open};\C{ the number of lines in the buffer, less one }\6
\&{integer} \\{in\_open\_max};\C{ highest value of \PB{\\{in\_open}} ever seen
}\6
\&{unsigned} \&{int} \\{open\_parens};\C{ the number of open text files }\6
\&{void} ${}{*}{*}\\{input\_file};{}$\6
\&{integer} ${}{*}\\{line\_stack}{}$;\C{ the line number for each file }\6
\&{char} ${}{*}{*}\\{inext\_stack}{}$;\C{ used for naming \.{MPX} files }\6
\&{char} ${}{*}{*}\\{iname\_stack}{}$;\C{ used for naming \.{MPX} files }\6
\&{char} ${}{*}{*}\\{iarea\_stack}{}$;\C{ used for naming \.{MPX} files }\6
\&{mp\_string} ${}{*}\\{mpx\_name}{}$;\par
\fi

\M{680}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_reallocate\_input\_stack}(\&{MP} \\{mp}${},\39{}$%
\&{int} \\{newsize});\par
\fi

\M{681}\B\&{static} \&{void} \\{mp\_reallocate\_input\_stack}(\&{MP} \\{mp}${},%
\39{}$\&{int} \\{newsize})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\6
\&{int} \|n${}\K\\{newsize}+\T{1};{}$\7
${}\.{XREALLOC}(\\{mp}\MG\\{input\_file},\39\|n,\39{}$\&{void} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{line\_stack},\39\|n,\39\&{integer});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{inext\_stack},\39\|n,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{iname\_stack},\39\|n,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{iarea\_stack},\39\|n,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{mpx\_name},\39\|n,\39\&{mp\_string});{}$\6
\&{for} ${}(\|k\K\\{mp}\MG\\{max\_in\_open};{}$ ${}\|k\Z\|n;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{input\_file}[\|k]\K\NULL;{}$\6
${}\\{mp}\MG\\{line\_stack}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{inext\_stack}[\|k]\K\NULL;{}$\6
${}\\{mp}\MG\\{iname\_stack}[\|k]\K\NULL;{}$\6
${}\\{mp}\MG\\{iarea\_stack}[\|k]\K\NULL;{}$\6
${}\\{mp}\MG\\{mpx\_name}[\|k]\K\NULL;{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{max\_in\_open}\K\\{newsize};{}$\6
\4${}\}{}$\2\par
\fi

\M{682}This has to be more than \PB{\\{file\_bottom}}, so:
\Y\B\4\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp\_reallocate\_input\_stack}(\\{mp},\39\\{file\_bottom}+\T{4}){}$;\par
\fi

\M{683}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|l;\7
\&{for} ${}(\|l\K\T{0};{}$ ${}\|l\Z\\{mp}\MG\\{max\_in\_open};{}$ ${}\|l\PP){}$%
\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{inext\_stack}[\|l]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{iname\_stack}[\|l]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{iarea\_stack}[\|l]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{input\_file});{}$\6
${}\\{xfree}(\\{mp}\MG\\{line\_stack});{}$\6
${}\\{xfree}(\\{mp}\MG\\{inext\_stack});{}$\6
${}\\{xfree}(\\{mp}\MG\\{iname\_stack});{}$\6
${}\\{xfree}(\\{mp}\MG\\{iarea\_stack});{}$\6
${}\\{xfree}(\\{mp}\MG\\{mpx\_name}){}$;\par
\fi

\M{684}However, all this discussion about input state really applies only to
the
case that we are inputting from a file. There is another important case,
namely when we are currently getting input from a token list. In this case
\PB{$\\{iindex}>\\{max\_in\_open}$}, and the conventions about the other state
variables
are different:

\yskip\hang\PB{\\{nloc}} is a pointer to the current node in the token list,
i.e.,
the node that will be read next. If \PB{$\\{nloc}\K\NULL$}, the token list has
been
fully read.

\yskip\hang\PB{\\{start}} points to the first node of the token list; this node
may or may not contain a reference count, depending on the type of token
list involved.

\yskip\hang\PB{\\{token\_type}}, which takes the place of \PB{\\{iindex}} in
the
discussion above, is a code number that explains what kind of token list
is being scanned.

\yskip\hang\PB{\\{name}} points to the \PB{\\{eqtb}} address of the control
sequence
being expanded, if the current token list is a macro not defined by
\&{vardef}. Macros defined by \&{vardef} have \PB{$\\{name}\K\NULL$}; their
name
can be deduced by looking at their first two parameters.

\yskip\hang\PB{\\{param\_start}}, which takes the place of \PB{\\{limit}},
tells where
the parameters of the current macro or loop text begin in the \PB{\\{param%
\_stack}}.

\yskip\noindent The \PB{\\{token\_type}} can take several values, depending on
where the current token list came from:

\yskip
\indent\PB{\\{forever\_text}}, if the token list being scanned is the body of
a \&{forever} loop;

\indent\PB{\\{loop\_text}}, if the token list being scanned is the body of
a \&{for} or \&{forsuffixes} loop;

\indent\PB{\\{parameter}}, if a \&{text} or \&{suffix} parameter is being
scanned;

\indent\PB{\\{backed\_up}}, if the token list being scanned has been inserted
as
`to be read again'.

\indent\PB{\\{inserted}}, if the token list being scanned has been inserted as
part of error recovery;

\indent\PB{\\{macro}}, if the expansion of a user-defined symbolic token is
being
scanned.

\yskip\noindent
The token list begins with a reference count if and only if \PB{$\\{token%
\_type}\K\\{macro}$}.

\Y\B\4\D$\\{nloc}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{nloc\_field}\C{ location of next node node }\par
\B\4\D$\\{nstart}$ \5
$\\{mp}\MG\\{cur\_input}.{}$\\{nstart\_field}\C{ location of next node node }%
\par
\B\4\D$\\{token\_type}$ \5
\\{iindex}\C{ type of current token list }\par
\B\4\D$\\{token\_state}$ \5
$(\\{iindex}\Z\\{macro}{}$)\C{ are we scanning a token list? }\par
\B\4\D$\\{file\_state}$ \5
$(\\{iindex}>\\{macro}{}$)\C{ are we scanning a file line? }\par
\B\4\D$\\{param\_start}$ \5
\\{limit}\C{ base of macro parameters in \PB{\\{param\_stack}} }\par
\B\4\D$\\{forever\_text}$ \5
\T{0}\C{ \PB{\\{token\_type}} code for loop texts }\par
\B\4\D$\\{loop\_text}$ \5
\T{1}\C{ \PB{\\{token\_type}} code for loop texts }\par
\B\4\D$\\{parameter}$ \5
\T{2}\C{ \PB{\\{token\_type}} code for parameter texts }\par
\B\4\D$\\{backed\_up}$ \5
\T{3}\C{ \PB{\\{token\_type}} code for texts to be reread }\par
\B\4\D$\\{inserted}$ \5
\T{4}\C{ \PB{\\{token\_type}} code for inserted texts }\par
\B\4\D$\\{macro}$ \5
\T{5}\C{ \PB{\\{token\_type}} code for macro replacement texts }\par
\B\4\D$\\{file\_bottom}$ \5
\T{6}\C{ lowest file code }\par
\fi

\M{685}The \PB{\\{param\_stack}} is an auxiliary array used to hold pointers to
the token
lists for parameters at the current level and subsidiary levels of input.
This stack grows at a different rate from the others, and is dynamically
reallocated
when needed.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} ${}{*}\\{param\_stack}{}$;\C{ token list pointers for parameters }%
\6
\&{integer} \\{param\_ptr};\C{ first unused entry in \PB{\\{param\_stack}} }\6
\&{integer} \\{max\_param\_stack};\C{ largest value of \PB{\\{param\_ptr}} }\par
\fi

\M{686}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{param\_stack}\K\\{xmalloc}((\\{mp}\MG\\{param\_size}+\T{1}),\39%
\&{sizeof}(\&{mp\_node})){}$;\par
\fi

\M{687}\B\&{static} \&{void} \\{mp\_check\_param\_size}(\&{MP} \\{mp}${},\39{}$%
\&{int} \|k)\1\1\2\2\6
${}\{{}$\1\6
\&{while} ${}(\|k\G\\{mp}\MG\\{param\_size}){}$\5
${}\{{}$\1\6
${}\.{XREALLOC}(\\{mp}\MG\\{param\_stack},\39(\|k+\|k/\T{4}),\39\&{mp%
\_node});{}$\6
${}\\{mp}\MG\\{param\_size}\K\|k+\|k/\T{4};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{688}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{param\_stack}){}$;\par
\fi

\M{689}Notice that the \PB{\&{line}} isn't valid when \PB{\\{token\_state}} is
true because it
depends on \PB{\\{iindex}}.  If we really need to know the line number for the
topmost file in the iindex stack we use the following function.  If a page
number or other information is needed, this routine should be modified to
compute it as well.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{integer} \\{mp\_true\_line}(\&{MP} \\{mp});\par
\fi

\M{690}\B\&{integer} \\{mp\_true\_line}(\&{MP} \\{mp})\1\1 $\{$ \&{int} \|k;\C{
an index into the input stack }\6
\&{if} ${}(\\{file\_state}\W(\\{name}>\\{max\_spec\_src}))$ $\{$ \&{return} %
\&{line}  ; $\}$ \6
\&{else}\5
${}\{{}$\1\6
${}\|k\K\\{mp}\MG\\{input\_ptr};{}$\6
\&{while} ${}((\|k>\T{0})\W((\\{mp}\MG\\{input\_stack}[(\|k-\T{1})].\\{index%
\_field}<\\{file\_bottom})\V(\\{mp}\MG\\{input\_stack}[(\|k-\T{1})].\\{name%
\_field}\Z\\{max\_spec\_src}))){}$\5
${}\{{}$\1\6
\\{decr}(\|k);\6
\4${}\}{}$\2\6
\&{return} ${}(\|k>\T{0}\?\\{mp}\MG\\{line\_stack}[(\|k-\T{1})+\\{file%
\_bottom}]:\T{0});{}$\6
\4${}\}{}$\2\6
$\}{}$\par
\fi

\M{691}Thus, the ``current input state'' can be very complicated indeed; there
can be many levels and each level can arise in a variety of ways. The
\PB{\\{show\_context}} procedure, which is used by \MP's error-reporting
routine to
print out the current input state on all levels down to the most recent
line of characters from an input file, illustrates most of these conventions.
The global variable \PB{\\{file\_ptr}} contains the lowest level that was
displayed by this procedure.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{file\_ptr};\C{ shallowest level shown by \PB{\\{show\_context}}
}\par
\fi

\M{692}The status at each level is indicated by printing two lines, where the
first
line indicates what was read so far and the second line shows what remains
to be read. The context is cropped, if necessary, so that the first line
contains at most \PB{\\{half\_error\_line}} characters, and the second contains
at most \PB{\\{error\_line}}. Non-current input levels whose \PB{\\{token%
\_type}} is
`\PB{\\{backed\_up}}' are shown only if they have not been fully read.

\Y\B\&{void} \\{mp\_show\_context}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ prints where the scanner is }\1\6
\&{unsigned} \\{old\_setting};\C{ saved \PB{\\{selector}} setting }\7
\X698:Local variables for formatting calculations\X;\6
${}\\{mp}\MG\\{file\_ptr}\K\\{mp}\MG\\{input\_ptr};{}$\6
${}\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{file\_ptr}]\K\\{mp}\MG\\{cur%
\_input}{}$;\C{ store current state }\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_input}\K\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{file%
\_ptr}]{}$;\C{ enter into the context }\6
\X693:Display the current context\X;\6
\&{if} (\\{file\_state})\1\6
\&{if} ${}((\\{name}>\\{max\_spec\_src})\V(\\{mp}\MG\\{file\_ptr}\E\T{0})){}$\1%
\5
\&{break};\2\2\6
${}\\{decr}(\\{mp}\MG\\{file\_ptr});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_input}\K\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{input%
\_ptr}]{}$;\C{ restore original state }\6
\4${}\}{}$\2\par
\fi

\M{693}\B\X693:Display the current context\X${}\E{}$\6
\&{if} ${}((\\{mp}\MG\\{file\_ptr}\E\\{mp}\MG\\{input\_ptr})\V\\{file\_state}%
\V(\\{token\_type}\I\\{backed\_up})\V(\\{nloc}\I\NULL)){}$\5
${}\{{}$\C{ we omit backed-up token lists that have already been read }\1\6
${}\\{mp}\MG\\{tally}\K\T{0}{}$;\C{ get ready to count characters }\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
\&{if} (\\{file\_state})\5
${}\{{}$\1\6
\X694:Print location of current line\X;\6
\X701:Pseudoprint the line\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X695:Print type of token list\X;\6
\X702:Pseudoprint the token list\X;\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting}{}$;\C{ stop pseudoprinting }\6
\X700:Print two lines using the tricky pseudoprinted information\X;\6
\4${}\}{}$\2\par
\U692.\fi

\M{694}This routine should be changed, if necessary, to give the best possible
indication of where the current line resides in the input file.
For example, on some systems it is best to print both a page and line number.

\Y\B\4\X694:Print location of current line\X${}\E{}$\6
\&{if} ${}(\\{name}>\\{max\_spec\_src}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"l."});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp\_true\_line}(\\{mp}));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{terminal\_input})\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{file\_ptr}\E\T{0}){}$\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<*>"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<insert>"});{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{name}\E\\{is\_scantok}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<scantokens>"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<read>"});{}$\6
\4${}\}{}$\2\6
$\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}){}$)\par
\U693.\fi

\M{695}Can't use case statement here because the \PB{\\{token\_type}} is not
a constant expression.

\Y\B\4\X695:Print type of token list\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{token\_type}\E\\{forever\_text}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<forever>\ "});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{token\_type}\E\\{loop\_text}){}$\5
${}\{{}$\1\6
\X696:Print the current loop value\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{token\_type}\E\\{parameter}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<argument>\ "});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{token\_type}\E\\{backed\_up}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{nloc}\E\NULL){}$\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<recently\ read>\ "});{}$\2\6
\&{else}\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<to\ be\ read\ again>\ }\)\.{"});{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{token\_type}\E\\{inserted}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<inserted\ text>\ "});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{token\_type}\E\\{macro}){}$\5
${}\{{}$\1\6
\\{mp\_print\_ln}(\\{mp});\6
\&{if} ${}(\\{name}\I\NULL){}$\1\5
${}\\{mp\_print\_str}(\\{mp},\39\\{name});{}$\2\6
\&{else}\1\5
\X697:Print the name of a \&{vardef}'d macro\X;\2\6
${}\\{mp\_print}(\\{mp},\39\.{"->"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"?"}){}$;\C{ this should never happen }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U693.\fi

\M{696}The parameter that corresponds to a loop text is either a token list
(in the case of \&{forsuffixes}) or a ``capsule'' (in the case of \&{for}).
We'll discuss capsules later; for now, all we need to know is that
the \PB{\\{link}} field in a capsule parameter is \PB{\&{void}} and that
\PB{$\\{print\_exp}(\|p,\T{0})$} displays the value of capsule~\PB{\|p} in
abbreviated form.

\Y\B\4\X696:Print the current loop value\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{pp};\7
${}\\{mp\_print\_nl}(\\{mp},\39\.{"<for("});{}$\6
${}\\{pp}\K\\{mp}\MG\\{param\_stack}[\\{param\_start}];{}$\6
\&{if} ${}(\\{pp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_link}(\\{pp})\E\.{MP\_VOID}){}$\1\5
${}\\{mp\_print\_exp}(\\{mp},\39\\{pp},\39\T{0}){}$;\C{ we're in a \&{for} loop
}\2\6
\&{else}\1\5
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{pp},\39\NULL,\39\T{20},\39\\{mp}\MG%
\\{tally});{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{")>\ "});{}$\6
\4${}\}{}$\2\par
\U695.\fi

\M{697}The first two parameters of a macro defined by \&{vardef} will be token
lists representing the macro's prefix and ``at point.'' By putting these
together, we get the macro's full name.

\Y\B\4\X697:Print the name of a \&{vardef}'d macro\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{pp}${}\K\\{mp}\MG\\{param\_stack}[\\{param\_start}];{}$\7
\&{if} ${}(\\{pp}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{mp}\MG\\{param\_stack}[\\{param%
\_start}+\T{1}],\39\NULL,\39\T{20},\39\\{mp}\MG\\{tally});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_node} \\{qq}${}\K\\{pp};{}$\7
\&{while} ${}(\\{mp\_link}(\\{qq})\I\NULL){}$\1\5
${}\\{qq}\K\\{mp\_link}(\\{qq});{}$\2\6
${}\\{mp\_link}(\\{qq})\K\\{mp}\MG\\{param\_stack}[\\{param\_start}+\T{1}];{}$\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{pp},\39\NULL,\39\T{20},\39\\{mp}\MG%
\\{tally});{}$\6
${}\\{mp\_link}(\\{qq})\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U695.\fi

\M{698}Now it is necessary to explain a little trick. We don't want to store a
long
string that corresponds to a token list, because that string might take up
lots of memory; and we are printing during a time when an error message is
being given, so we dare not do anything that might overflow one of \MP's
tables. So `pseudoprinting' is the answer: We enter a mode of printing
that stores characters into a buffer of length \PB{\\{error\_line}}, where
character
$k+1$ is placed into \hbox{\PB{\\{trick\_buf}[\|k\\{mod}\\{error\_line}]}} if
\PB{$\|k<\\{trick\_count}$}, otherwise character \PB{\|k} is dropped. Initially
we set
\PB{\\{tally}: $\K$ \T{0}} and \PB{\\{trick\_count}: $\K$ \T{1000000}}; then
when we reach the
point where transition from line 1 to line 2 should occur, we
set \PB{\\{first\_count}: $\K$ \\{tally}} and \PB{\\{trick\_count}: $\K$ $%
\hbox{max}(\\{error\_line},\\{tally}+\T{1}+\\{error\_line}-\\{half\_error%
\_line})$}. At the end of the
pseudoprinting, the values of \PB{\\{first\_count}}, \PB{\\{tally}}, and
\PB{\\{trick\_count}} give us all the information we need to print the two
lines,
and all of the necessary text is in \PB{\\{trick\_buf}}.

Namely, let \PB{\|l} be the length of the descriptive information that appears
on the first line. The length of the context information gathered for that
line is \PB{$\|k\K\\{first\_count}$}, and the length of the context information
gathered for line~2 is $m=\min(\PB{\\{tally}}, \PB{\\{trick\_count}})-k$. If %
\PB{$\|l+\|k\Z\|h$},
where \PB{$\|h\K\\{half\_error\_line}$}, we print \PB{$\\{trick\_buf}[\T{0..}%
\|k-\T{1}]$} after the
descriptive information on line~1, and set \PB{\|n: $\K$ $\|l+\|k$}; here \PB{%
\|n} is the
length of line~1. If $l+k>h$, some cropping is necessary, so we set \PB{\|n: $%
\K$ \|h}
and print `\.{...}' followed by
$$\hbox{\PB{$\\{trick\_buf}[(\|l+\|k-\|h+\T{3})\MRL{{.}{.}}\|k-\T{1}]$},}$$
where subscripts of \PB{\\{trick\_buf}} are circular modulo \PB{\\{error%
\_line}}. The
second line consists of \PB{\|n}~spaces followed by \PB{$\\{trick\_buf}[\|k%
\MRL{{.}{.}}(\|k+\|m-\T{1})]$},
unless \PB{$\|n+\|m>\\{error\_line}$}; in the latter case, further cropping is
done.
This is easier to program than to explain.

\Y\B\4\X698:Local variables for formatting calculations\X${}\E{}$\6
\&{int} \|i;\C{ index into \PB{\\{buffer}} }\6
\&{integer} \|l;\C{ length of descriptive information on line 1 }\6
\&{integer} \|m;\C{ context information gathered for line 2 }\6
\&{int} \|n;\C{ length of line 1 }\6
\&{integer} \|p;\C{ starting or ending place in \PB{\\{trick\_buf}} }\6
\&{integer} \|q;\C{ temporary index }\par
\U692.\fi

\M{699}The following code tells the print routines to gather
the desired information.

\Y\B\4\D$\\{begin\_pseudoprint}$ \6
${}\{{}$\1\6
${}\|l\K\\{mp}\MG\\{tally};{}$\6
${}\\{mp}\MG\\{tally}\K\T{0};{}$\6
${}\\{mp}\MG\\{selector}\K\\{pseudo};{}$\6
${}\\{mp}\MG\\{trick\_count}\K\T{1000000};{}$\6
\4${}\}{}$\2\par
\B\4\D$\\{set\_trick\_count}()$ \6
${}\{{}$\1\6
${}\\{mp}\MG\\{first\_count}\K\\{mp}\MG\\{tally};{}$\6
${}\\{mp}\MG\\{trick\_count}\K\\{mp}\MG\\{tally}+\T{1}+\\{mp}\MG\\{error%
\_line}-\\{mp}\MG\\{half\_error\_line};{}$\6
\&{if} ${}(\\{mp}\MG\\{trick\_count}<\\{mp}\MG\\{error\_line}){}$\1\5
${}\\{mp}\MG\\{trick\_count}\K\\{mp}\MG\\{error\_line};{}$\2\6
\4${}\}{}$\2\par
\fi

\M{700}And the following code uses the information after it has been gathered.

\Y\B\4\X700:Print two lines using the tricky pseudoprinted information\X${}%
\E{}$\6
\&{if} ${}(\\{mp}\MG\\{trick\_count}\E\T{1000000}){}$\1\5
\\{set\_trick\_count}(\,);\C{ \PB{\\{set\_trick\_count}} must be performed }\2\6
\&{if} ${}(\\{mp}\MG\\{tally}<\\{mp}\MG\\{trick\_count}){}$\1\5
${}\|m\K\\{mp}\MG\\{tally}-\\{mp}\MG\\{first\_count};{}$\2\6
\&{else}\1\5
${}\|m\K\\{mp}\MG\\{trick\_count}-\\{mp}\MG\\{first\_count}{}$;\C{ context on
line 2 }\2\6
\&{if} ${}(\|l+\\{mp}\MG\\{first\_count}\Z\\{mp}\MG\\{half\_error\_line}){}$\5
${}\{{}$\1\6
${}\|p\K\T{0};{}$\6
${}\|n\K\|l+\\{mp}\MG\\{first\_count};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"..."});{}$\6
${}\|p\K\|l+\\{mp}\MG\\{first\_count}-\\{mp}\MG\\{half\_error\_line}+\T{3};{}$\6
${}\|n\K\\{mp}\MG\\{half\_error\_line};{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|q\K\|p;{}$ ${}\|q\Z\\{mp}\MG\\{first\_count}-\T{1};{}$ ${}\|q%
\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{trick\_buf}[\|q\MOD\\{mp}\MG%
\\{error\_line}]);{}$\6
\4${}\}{}$\2\6
\\{mp\_print\_ln}(\\{mp});\6
\&{for} ${}(\|q\K\T{1};{}$ ${}\|q\Z\|n;{}$ ${}\|q\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '})){}$;\C{ print \PB{\|n}
spaces to begin line~2 }\6
\4${}\}{}$\2\6
\&{if} ${}(\|m+\|n\Z\\{mp}\MG\\{error\_line}){}$\1\5
${}\|p\K\\{mp}\MG\\{first\_count}+\|m;{}$\2\6
\&{else}\1\5
${}\|p\K\\{mp}\MG\\{first\_count}+(\\{mp}\MG\\{error\_line}-\|n-\T{3});{}$\2\6
\&{for} ${}(\|q\K\\{mp}\MG\\{first\_count};{}$ ${}\|q\Z\|p-\T{1};{}$ ${}\|q%
\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{trick\_buf}[\|q\MOD\\{mp}\MG%
\\{error\_line}]);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|m+\|n>\\{mp}\MG\\{error\_line})$ $\\{mp\_print}(\\{mp},\39%
\.{"..."}{}$)\par
\U693.\fi

\M{701}But the trick is distracting us from our current goal, which is to
understand the input state. So let's concentrate on the data structures that
are being pseudoprinted as we finish up the \PB{\\{show\_context}} procedure.

\Y\B\4\X701:Pseudoprint the line\X${}\E{}$\6
\\{begin\_pseudoprint};\6
\&{if} ${}(\\{limit}>\T{0}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|i\K\\{start};{}$ ${}\|i\Z\\{limit}-\T{1};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|i\E\\{loc}){}$\1\5
\\{set\_trick\_count}(\,);\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{buffer}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U693.\fi

\M{702}\B\X702:Pseudoprint the token list\X${}\E{}$\6
\\{begin\_pseudoprint}; \6
\&{if} ${}(\\{token\_type}\I\\{macro}){}$\1\5
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{nstart},\39\\{nloc},\39\T{100000},\39%
\T{0});{}$\2\6
\&{else} $\\{mp\_show\_macro}(\\{mp},\39\\{nstart},\39\\{nloc},\39%
\T{100000}{}$)\par
\U693.\fi

\N{1}{703}Maintaining the input stacks.
The following subroutines change the input status in commonly needed ways.

First comes \PB{\\{push\_input}}, which stores the current state and creates a
new level (having, initially, the same properties as the old).

\Y\B\4\D$\\{push\_input}$ \6
${}\{{}$\C{ enter a new input level, save the old }\1\6
\&{if} ${}(\\{mp}\MG\\{input\_ptr}>\\{mp}\MG\\{max\_in\_stack}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{max\_in\_stack}\K\\{mp}\MG\\{input\_ptr};{}$\6
\&{if} ${}(\\{mp}\MG\\{input\_ptr}\E\\{mp}\MG\\{stack\_size}){}$\5
${}\{{}$\1\6
\&{int} \|l${}\K(\\{mp}\MG\\{stack\_size}+(\\{mp}\MG\\{stack\_size}/\T{4}));{}$%
\7
${}\.{XREALLOC}(\\{mp}\MG\\{input\_stack},\39\|l,\39\&{in\_state\_record});{}$\6
${}\\{mp}\MG\\{stack\_size}\K\|l;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{input\_ptr}]\K\\{mp}\MG\\{cur%
\_input}{}$;\C{ stack the record }\6
${}\\{incr}(\\{mp}\MG\\{input\_ptr});{}$\6
\4${}\}{}$\2\par
\fi

\M{704}And of course what goes up must come down.

\Y\B\4\D$\\{pop\_input}$ \6
${}\{{}$\C{ leave an input level, re-enter the old }\1\6
${}\\{decr}(\\{mp}\MG\\{input\_ptr});{}$\6
${}\\{mp}\MG\\{cur\_input}\K\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{input%
\_ptr}];{}$\6
\4${}\}{}$\2\par
\fi

\M{705}Here is a procedure that starts a new level of token-list input, given
a token list \PB{\|p} and its type \PB{\|t}. If \PB{$\|t\K\\{macro}$}, the
calling routine should
set \PB{\\{name}}, reset~\PB{\\{loc}}, and increase the macro's reference
count.

\Y\B\4\D$\\{back\_list}(\|A)$ \5
$\\{mp\_begin\_token\_list}(\\{mp},\39(\|A),\39{}$(\&{quarterword}) \\{backed%
\_up})\C{ backs up a simple token list }\par
\Y\B\&{static} \&{void} \\{mp\_begin\_token\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\\{push\_input};\6
${}\\{nstart}\K\|p;{}$\6
${}\\{token\_type}\K\|t;{}$\6
${}\\{param\_start}\K\\{mp}\MG\\{param\_ptr};{}$\6
${}\\{nloc}\K\|p;{}$\6
\4${}\}{}$\2\par
\fi

\M{706}When a token list has been fully scanned, the following computations
should be done as we leave that level of input.

\Y\B\&{static} \&{void} \\{mp\_end\_token\_list}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ leave a token-list input level }\1\6
\&{mp\_node} \|p;\C{ temporary register }\7
\&{if} ${}(\\{token\_type}\G\\{backed\_up}){}$\5
${}\{{}$\C{ token list to be deleted }\1\6
\&{if} ${}(\\{token\_type}\Z\\{inserted}){}$\5
${}\{{}$\1\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\\{nstart});{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_delete\_mac\_ref}(\\{mp},\39\\{nstart}){}$;\C{ update reference count
}\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{param\_ptr}>\\{param\_start}){}$\5
${}\{{}$\C{ parameters must be flushed }\1\6
${}\\{decr}(\\{mp}\MG\\{param\_ptr});{}$\6
${}\|p\K\\{mp}\MG\\{param\_stack}[\\{mp}\MG\\{param\_ptr}];{}$\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_link}(\|p)\E\.{MP\_VOID}){}$\5
${}\{{}$\C{ it's an \&{expr} parameter }\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\|p){}$;\C{ it's a \&{suffix} or %
\&{text} parameter }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4\.{DONE}:\5
\\{pop\_input};\6
\\{check\_interrupt};\6
\4${}\}{}$\2\par
\fi

\M{707}The contents of \PB{$\\{cur\_cmd},\\{cur\_mod},\\{cur\_sym}$} are placed
into an equivalent
token by the \PB{\\{cur\_tok}} routine.

\Y\B\X940:Declare the procedure called \PB{\\{make\_exp\_copy}}\X;\7
\&{static} \&{mp\_node} \\{mp\_cur\_tok}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ a new token node }\7
\&{if} ${}(\\{cur\_sym}(\,)\E\NULL\W\\{cur\_sym\_mod}(\,)\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_capsule\_token}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{save\_exp\_num};\C{ possible \PB{\\{cur\_exp}} numerical to
be restored }\6
\&{mp\_value} \\{save\_exp}${}\K\\{mp}\MG\\{cur\_exp}{}$;\C{ \PB{\\{cur\_exp}}
to be restored }\7
\\{new\_number}(\\{save\_exp\_num});\6
${}\\{number\_clone}(\\{save\_exp\_num},\39\\{cur\_exp\_value\_number}(\,));{}$%
\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{cur\_mod\_node}(\,));{}$\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_link}(\|p)\K\NULL;{}$\6
${}\\{mp}\MG\\{cur\_exp}\K\\{save\_exp};{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n,\39\\{save\_exp%
\_num});{}$\6
\\{free\_number}(\\{save\_exp\_num});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_token\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_token};{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_numeric\_token}){}$\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{cur\_mod\_number}(\,));{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_known};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_value\_str}(\|p,\39\\{cur\_mod\_str}(\,));{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{cur\_sym}(\,));{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{cur\_sym\_mod}(\,);{}$\6
\4${}\}{}$\2\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{708}Sometimes \MP\ has read too far and wants to ``unscan'' what it has
seen. The \PB{\\{back\_input}} procedure takes care of this by putting the
token
just scanned back into the input stream, ready to be read again.
If \PB{$\\{cur\_sym}\MRL{{<}{>}}\T{0}$}, the values of \PB{\\{cur\_cmd}} and %
\PB{\\{cur\_mod}} are irrelevant.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_back\_input}(\&{MP} \\{mp});\par
\fi

\M{709}\B\&{void} \\{mp\_back\_input}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ undoes one token of input }\1\6
\&{mp\_node} \|p;\C{ a token list of length one }\7
${}\|p\K\\{mp\_cur\_tok}(\\{mp});{}$\6
\&{while} ${}(\\{token\_state}\W(\\{nloc}\E\NULL)){}$\1\5
\\{mp\_end\_token\_list}(\\{mp});\C{ conserve stack space }\2\6
\\{back\_list}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{710}The \PB{\\{back\_error}} routine is used when we want to restore or
replace an
offending token just before issuing an error message.  We disable interrupts
during the call of \PB{\\{back\_input}} so that the help message won't be lost.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_back\_error}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\\{msg},\39{}$\&{const} \&{char} ${}{*}{*}\\{hlp},\39{}$%
\&{boolean} \\{deletions\_allowed});\par
\fi

\M{711}\B\&{static} \&{void} \\{mp\_back\_error}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{msg},\39{}$\&{const} \&{char} ${}{*}{*}\\{hlp},%
\39{}$\&{boolean} \\{deletions\_allowed})\1\1\2\2\6
${}\{{}$\C{ back up one token and call \PB{\&{error}} }\1\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{false};{}$\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{true};{}$\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{deletions\_allowed});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_ins\_error}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\\{msg},\39{}$\&{const} \&{char} ${}{*}{*}\\{hlp},\39{}$%
\&{boolean} \\{deletions\_allowed})\1\1\2\2\6
${}\{{}$\C{ back up one inserted token and call \PB{\&{error}} }\1\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{false};{}$\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{token\_type}\K{}$(\&{quarterword}) \\{inserted};\6
${}\\{mp}\MG\\{OK\_to\_interrupt}\K\\{true};{}$\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{deletions\_allowed});{}$\6
\4${}\}{}$\2\par
\fi

\M{712}The \PB{\\{begin\_file\_reading}} procedure starts a new level of input
for lines
of characters to be read from a file, or as an insertion from the
terminal. It does not take care of opening the file, nor does it set \PB{%
\\{loc}}
or \PB{\\{limit}} or \PB{\&{line}}.

\Y\B\&{void} \\{mp\_begin\_file\_reading}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{in\_open}\E(\\{mp}\MG\\{max\_in\_open}-\T{1})){}$\1\5
${}\\{mp\_reallocate\_input\_stack}(\\{mp},\39(\\{mp}\MG\\{max\_in\_open}+%
\\{mp}\MG\\{max\_in\_open}/\T{4}));{}$\2\6
\&{if} ${}(\\{mp}\MG\\{first}\E\\{mp}\MG\\{buf\_size}){}$\1\5
${}\\{mp\_reallocate\_buffer}(\\{mp},\39(\\{mp}\MG\\{buf\_size}+\\{mp}\MG\\{buf%
\_size}/\T{4}));{}$\2\6
${}\\{mp}\MG\\{in\_open}\PP;{}$\6
\\{push\_input};\6
${}\\{iindex}\K{}$(\&{quarterword}) \\{mp}${}\MG\\{in\_open};{}$\6
\&{if} ${}(\\{mp}\MG\\{in\_open\_max}<\\{mp}\MG\\{in\_open}){}$\1\5
${}\\{mp}\MG\\{in\_open\_max}\K\\{mp}\MG\\{in\_open};{}$\2\6
${}\\{mp}\MG\\{mpx\_name}[\\{iindex}]\K\\{absent};{}$\6
${}\\{start}\K{}$(\&{halfword}) \\{mp}${}\MG\\{first};{}$\6
${}\\{name}\K\\{is\_term}{}$;\C{ \PB{\\{terminal\_input}} is now \PB{\\{true}}
}\6
\4${}\}{}$\2\par
\fi

\M{713}Conversely, the variables must be downdated when such a level of input
is finished.  Any associated \.{MPX} file must also be closed and popped
off the file stack. While finishing preloading, it is possible that the file
does not actually end with 'dump', so we capture that case here as well.

\Y\B\&{static} \&{void} \\{mp\_end\_file\_reading}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{reading\_preload}\W\\{mp}\MG\\{input\_ptr}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_dump});{}$\6
\\{mp\_back\_input}(\\{mp});\6
\&{return};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{in\_open}>\\{iindex}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{mp}\MG\\{mpx\_name}[\\{mp}\MG\\{in\_open}]\E\\{absent})\V(%
\\{name}\Z\\{max\_spec\_src})){}$\5
${}\{{}$\1\6
${}\\{mp\_confusion}(\\{mp},\39\.{"endinput"});{}$\6
;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{input\_file}[\\{mp}\MG\\{in%
\_open}]){}$;\C{ close an \.{MPX} file }\6
${}\\{delete\_str\_ref}(\\{mp}\MG\\{mpx\_name}[\\{mp}\MG\\{in\_open}]);{}$\6
${}\\{decr}(\\{mp}\MG\\{in\_open});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{first}\K{}$(\&{size\_t}) \\{start};\6
\&{if} ${}(\\{iindex}\I\\{mp}\MG\\{in\_open}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"endinput"});{}$\2\6
\&{if} ${}(\\{name}>\\{max\_spec\_src}){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{cur\_file});{}$\6
\\{xfree}(\\{in\_ext});\6
\\{xfree}(\\{in\_name});\6
\\{xfree}(\\{in\_area});\6
\4${}\}{}$\2\6
\\{pop\_input};\6
${}\\{decr}(\\{mp}\MG\\{in\_open});{}$\6
\4${}\}{}$\2\par
\fi

\M{714}Here is a function that tries to resume input from an \.{MPX} file
already
associated with the current input file.  It returns \PB{\\{false}} if this
doesn't
work.

\Y\B\&{static} \&{boolean} \\{mp\_begin\_mpx\_reading}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{in\_open}\I\\{iindex}+\T{1}){}$\5
${}\{{}$\1\6
\&{return} \\{false};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{mpx\_name}[\\{mp}\MG\\{in\_open}]\Z\\{absent}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"mpx"});{}$\2\6
\&{if} ${}(\\{mp}\MG\\{first}\E\\{mp}\MG\\{buf\_size}){}$\1\5
${}\\{mp\_reallocate\_buffer}(\\{mp},\39(\\{mp}\MG\\{buf\_size}+(\\{mp}\MG%
\\{buf\_size}/\T{4})));{}$\2\6
\\{push\_input};\6
${}\\{iindex}\K{}$(\&{quarterword}) \\{mp}${}\MG\\{in\_open};{}$\6
${}\\{start}\K{}$(\&{halfword}) \\{mp}${}\MG\\{first};{}$\6
${}\\{name}\K\\{mp}\MG\\{mpx\_name}[\\{mp}\MG\\{in\_open}];{}$\6
\\{add\_str\_ref}(\\{name});\C{ Put an empty line in the input buffer }\C{ We
want to make it look as though we have just read a blank line        without
really doing so. }\6
${}\\{mp}\MG\\{last}\K\\{mp}\MG\\{first};{}$\6
${}\\{limit}\K{}$(\&{halfword}) \\{mp}${}\MG\\{last}{}$;\C{ simulate \PB{%
\\{input\_ln}} and \PB{\\{firm\_up\_the\_line}} }\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};{}$\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{715}This procedure temporarily stops reading an \.{MPX} file.

\Y\B\&{static} \&{void} \\{mp\_end\_mpx\_reading}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{in\_open}\I\\{iindex}){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"mpx"});{}$\2\6
;\6
\&{if} ${}(\\{loc}<\\{limit}){}$\5
${}\{{}$\C{ Complain that we are not at the end of a line in the \.{MPX} file }%
\C{ Here we enforce a restriction that simplifies the input stacks
considerably.        This should not inconvenience the user because \.{MPX}
files are generated        by an auxiliary program called \.{DVItoMP}. }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ file\ contains\ }\)\.{picture%
\ expressions\ }\)\.{for\ btex...etex"},\39\.{"blocks.\ \ Such\ files}\)\.{\
are\ normally\ genera}\)\.{ted\ automatically"},\39\.{"but\ this\ one\ seems\ }%
\)\.{to\ be\ messed\ up.\ \ I'}\)\.{m\ going\ to\ ignore"},\39\.{"the\ rest\ of%
\ this\ li}\)\.{ne."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"`mpxbreak'\ must\ be\ }\)\.{at\ the\ end\ of\ a\
line}\)\.{"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{first}\K{}$(\&{size\_t}) \\{start};\6
\\{pop\_input};\6
\4${}\}{}$\2\par
\fi

\M{716}In order to keep the stack from overflowing during a long sequence of
inserted `\.{show}' commands, the following routine removes completed
error-inserted lines from memory.

\Y\B\&{void} \\{mp\_clear\_for\_error\_prompt}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{while} ${}(\\{file\_state}\W\\{terminal\_input}\W(\\{mp}\MG\\{input\_ptr}>%
\T{0})\W(\\{loc}\E\\{limit})){}$\1\5
\\{mp\_end\_file\_reading}(\\{mp});\2\6
\\{mp\_print\_ln}(\\{mp});\6
\\{clear\_terminal}(\,);\6
\4${}\}{}$\2\par
\fi

\M{717}To get \MP's whole input mechanism going, we perform the following
actions.

\Y\B\4\X717:Initialize the input routines\X${}\E{}$\6
$\{$ $\\{mp}\MG\\{input\_ptr}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_in\_stack}\K\\{file\_bottom};{}$\6
${}\\{mp}\MG\\{in\_open}\K\\{file\_bottom};{}$\6
${}\\{mp}\MG\\{open\_parens}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_buf\_stack}\K\T{0};{}$\6
${}\\{mp}\MG\\{param\_ptr}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_param\_stack}\K\T{0};{}$\6
${}\\{mp}\MG\\{first}\K\T{0};{}$\6
${}\\{start}\K\T{0};{}$\6
${}\\{iindex}\K\\{file\_bottom};$ \&{line} $\K$ \T{0};\6
${}\\{name}\K\\{is\_term};{}$\6
${}\\{mp}\MG\\{mpx\_name}[\\{file\_bottom}]\K\\{absent};{}$\6
${}\\{mp}\MG\\{force\_eof}\K\\{false};{}$\6
\&{if} ${}(\R\\{mp\_init\_terminal}(\\{mp})){}$\1\5
\\{mp\_jump\_out}(\\{mp});\2\6
${}\\{limit}\K{}$(\&{halfword}) \\{mp}${}\MG\\{last};{}$\6
${}\\{mp}\MG\\{first}\K\\{mp}\MG\\{last}+\T{1}{}$;\C{ \PB{\\{init\_terminal}}
has set \PB{\\{loc}} and \PB{\\{last}} }\6
$\}{}$\par
\A720.
\U1298.\fi

\N{1}{718}Getting the next token.
The heart of \MP's input mechanism is the \PB{\\{get\_next}} procedure, which
we shall develop in the next few sections of the program. Perhaps we
shouldn't actually call it the ``heart,'' however; it really acts as \MP's
eyes and mouth, reading the source files and gobbling them up. And it also
helps \MP\ to regurgitate stored token lists that are to be processed again.

The main duty of \PB{\\{get\_next}} is to input one token and to set \PB{\\{cur%
\_cmd}}
and \PB{\\{cur\_mod}} to that token's command code and modifier. Furthermore,
if
the input token is a symbolic token, that token's \PB{\\{hash}} address
is stored in \PB{\\{cur\_sym}}; otherwise \PB{\\{cur\_sym}} is set to zero.

Underlying this simple description is a certain amount of complexity
because of all the cases that need to be handled.
However, the inner loop of \PB{\\{get\_next}} is reasonably short and fast.

\fi

\M{719}Before getting into \PB{\\{get\_next}}, we need to consider a mechanism
by which
\MP\ helps keep errors from propagating too far. Whenever the program goes
into a mode where it keeps calling \PB{\\{get\_next}} repeatedly until a
certain
condition is met, it sets \PB{\\{scanner\_status}} to some value other than %
\PB{\\{normal}}.
Then if an input file ends, or if an `\&{outer}' symbol appears,
an appropriate error recovery will be possible.

The global variable \PB{\\{warning\_info}} helps in this error recovery by
providing
additional information. For example, \PB{\\{warning\_info}} might indicate the
name of a macro whose replacement text is being scanned.

\Y\B\4\D$\\{normal}$ \5
\T{0}\C{ \PB{\\{scanner\_status}} at ``quiet times'' }\par
\B\4\D$\\{skipping}$ \5
\T{1}\C{ \PB{\\{scanner\_status}} when false conditional text is being skipped
}\par
\B\4\D$\\{flushing}$ \5
\T{2}\C{ \PB{\\{scanner\_status}} when junk after a statement is being ignored
}\par
\B\4\D$\\{absorbing}$ \5
\T{3}\C{ \PB{\\{scanner\_status}} when a \&{text} parameter is being scanned }%
\par
\B\4\D$\\{var\_defining}$ \5
\T{4}\C{ \PB{\\{scanner\_status}} when a \&{vardef} is being scanned }\par
\B\4\D$\\{op\_defining}$ \5
\T{5}\C{ \PB{\\{scanner\_status}} when a macro \&{def} is being scanned }\par
\B\4\D$\\{loop\_defining}$ \5
\T{6}\C{ \PB{\\{scanner\_status}} when a \&{for} loop is being scanned }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\8\#\&{define} \\{tex\_flushing} \5\T{7}\C{ \PB{\\{scanner\_status}} when
skipping \TeX\ material }\6
\&{integer} \\{scanner\_status};\C{ are we scanning at high speed? }\6
\&{mp\_sym} \\{warning\_info};\C{ if so, what else do we need to know,
                  in case an error occurs? }\6
\&{integer} \\{warning\_line};\6
\&{mp\_node} \\{warning\_info\_node};\par
\fi

\M{720}\B\X717:Initialize the input routines\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{scanner\_status}\K\\{normal}{}$;\par
\fi

\M{721}The following subroutine
is called when an `\&{outer}' symbolic token has been scanned or
when the end of a file has been reached. These two cases are distinguished
by \PB{\\{cur\_sym}}, which is zero at the end of a file.

\Y\B\&{static} \&{boolean} \\{mp\_check\_outer\_validity}(\&{MP} \\{mp})\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ points to inserted token list }\7
\&{if} ${}(\\{mp}\MG\\{scanner\_status}\E\\{normal}){}$\5
${}\{{}$\1\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{scanner\_status}\E\\{tex\_flushing}){}$\5
${}\{{}$\1\6
\X722:Check if the file has ended while flushing \TeX\ material and set the
result value for \PB{\\{check\_outer\_validity}}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X723:Back up an outer symbolic token so that it can be reread\X;\6
\&{if} ${}(\\{mp}\MG\\{scanner\_status}>\\{skipping}){}$\5
${}\{{}$\1\6
\X724:Tell the user what has run away and try to recover\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ forbidden\ `outer'}\)\.{\ token\
occurred\ in\ s}\)\.{kipped\ text."},\39\.{"This\ kind\ of\ error\ }\)%
\.{happens\ when\ you\ say}\)\.{\ `if...'\ and\ forget"},\39\.{"the\ matching\
`fi'.\ }\)\.{I've\ inserted\ a\ `fi'}\)\.{;\ this\ might\ work."},\39\NULL%
\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Incomplete\ if;\ all\ }\)\.{text\
was\ ignored\ aft}\)\.{er\ line\ \%d"},\39{}$(\&{int}) \\{mp}${}\MG\\{warning%
\_line});{}$\6
;\6
\&{if} ${}(\\{cur\_sym}(\,)\E\NULL){}$\5
${}\{{}$\1\6
${}\\{hlp}[\T{0}]\K\.{"The\ file\ ended\ whil}\)\.{e\ I\ was\ skipping\ con}\)%
\.{ditional\ text."};{}$\6
\4${}\}{}$\2\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_fi});{}$\6
${}\\{mp\_ins\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{722}\B\X722:Check if the file has ended while flushing \TeX\ material and
set the result value for \PB{\\{check\_outer\_validity}}\X${}\E{}$\6
\&{if} ${}(\\{cur\_sym}(\,)\I\NULL){}$\5
${}\{{}$\1\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ file\ ended\ whil}\)\.{e\ I\
was\ looking\ for\ }\)\.{the\ `etex'\ to"},\39\.{"finish\ this\ TeX\ mat}\)%
\.{erial.\ \ I've\ inserte}\)\.{d\ `etex'\ now."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"TeX\ mode\ didn't\ end}\)\.{;\
all\ text\ was\ ignor}\)\.{ed\ after\ line\ \%d"},\39{}$(\&{int}) \\{mp}${}\MG%
\\{warning\_line});{}$\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_etex});{}$\6
${}\\{mp\_ins\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{false});{}$\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\U721.\fi

\M{723}\B\X723:Back up an outer symbolic token so that it can be reread\X${}%
\E{}$\6
\&{if} ${}(\\{cur\_sym}(\,)\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{cur\_sym}(\,));{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{cur\_sym\_mod}(\,);{}$\6
\\{back\_list}(\|p);\C{ prepare to read the symbolic token again }\6
\4${}\}{}$\2\par
\U721.\fi

\M{724}\B\X724:Tell the user what has run away and try to recover\X${}\E{}$\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{msg\_start}\K\NULL;{}$\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ suspect\ you\ have\ }\)%
\.{forgotten\ an\ `enddef}\)\.{',"},\39\.{"causing\ me\ to\ read\ }\)\.{past\
where\ you\ wante}\)\.{d\ me\ to\ stop."},\39\.{"I'll\ try\ to\ recover}\)\.{;\
but\ if\ the\ error\ i}\)\.{s\ serious,"},\39\.{"you'd\ better\ type\ `}\)\.{E'%
\ or\ `X'\ now\ and\ fi}\)\.{x\ your\ file."},\39\NULL\};{}$\7
\\{mp\_runaway}(\\{mp});\C{ print the definition-so-far }\6
\&{if} ${}(\\{cur\_sym}(\,)\E\NULL){}$\5
${}\{{}$\1\6
${}\\{msg\_start}\K\.{"File\ ended\ while\ sc}\)\.{anning"};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{msg\_start}\K\.{"Forbidden\ token\ fou}\)\.{nd\ while\ scanning"};{}$\6
\4${}\}{}$\2\6
\&{switch} ${}(\\{mp}\MG\\{scanner\_status}){}$\5
${}\{\X725:Complete the error message, and set \PB{\\{cur\_sym}} to a token
that might help recover from the error\X\}{}$\C{ there are no other cases }\6
${}\\{mp\_ins\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\U721.\fi

\M{725}As we consider various kinds of errors, it is also appropriate to
change the first line of the help message just given; \PB{\\{help\_line}[%
\T{3}]}
points to the string that might be changed.

\Y\B\4\X725:Complete the error message, and set \PB{\\{cur\_sym}} to a token
that might help recover from the error\X${}\E{}$\6
\4\&{case} \\{flushing}:\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ to\ the\ end\ of\ th}\)\.{e\
statement"},\39\\{msg\_start});{}$\6
${}\\{hlp}[\T{0}]\K\.{"A\ previous\ error\ se}\)\.{ems\ to\ have\ propagat}\)%
\.{ed,"};{}$\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_semicolon});{}$\6
\&{break};\6
\4\&{case} \\{absorbing}:\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ a\ text\ argument"},\39%
\\{msg\_start});{}$\6
${}\\{hlp}[\T{0}]\K\.{"It\ seems\ that\ a\ rig}\)\.{ht\ delimiter\ was\ lef}\)%
\.{t\ out,"};{}$\6
\&{if} ${}(\\{mp}\MG\\{warning\_info}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_end\_group});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_right\_delimiter}){}$;\C{ the next
line makes sure that the inserted delimiter will       match the delimiter that
already was read. }\6
${}\\{set\_equiv\_sym}(\\{cur\_sym}(\,),\39\\{mp}\MG\\{warning\_info});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{var\_defining}:\6
${}\{{}$\1\6
\&{mp\_string} \|s;\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\\{mp}\MG\\{warning\_info%
\_node});{}$\6
${}\|s\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ the\ definition\ o}\)\.{f\ %
\%s"},\39\\{msg\_start},\39\|s\MG\\{str});{}$\6
\\{delete\_str\_ref}(\|s);\6
\4${}\}{}$\2\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_end\_def});{}$\6
\&{break};\6
\4\&{case} \\{op\_defining}:\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{mp\_str}(\\{mp},\39\\{text}(\\{mp}\MG\\{warning%
\_info}));{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ the\ definition\ o}\)\.{f\ %
\%s"},\39\\{msg\_start},\39\|s);{}$\6
\4${}\}{}$\2\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_end\_def});{}$\6
\&{break};\6
\4\&{case} \\{loop\_defining}:\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\\{mp\_str}(\\{mp},\39\\{text}(\\{mp}\MG\\{warning%
\_info}));{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ the\ text\ of\ a\ \%s}\)\.{\
loop"},\39\\{msg\_start},\39\|s);{}$\6
\4${}\}{}$\2\6
${}\\{hlp}[\T{0}]\K\.{"I\ suspect\ you\ have\ }\)\.{forgotten\ an\ `endfor}\)%
\.{',"};{}$\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_end\_for});{}$\6
\&{break};\par
\U724.\fi

\M{726}The \PB{\\{runaway}} procedure displays the first part of the text that
occurred
when \MP\ began its special \PB{\\{scanner\_status}}, if that text has been
saved.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_runaway}(\&{MP} \\{mp});\par
\fi

\M{727}\B\&{void} \\{mp\_runaway}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{scanner\_status}>\\{flushing}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Runaway\ "});{}$\6
\&{switch} ${}(\\{mp}\MG\\{scanner\_status}){}$\5
${}\{{}$\1\6
\4\&{case} \\{absorbing}:\5
${}\\{mp\_print}(\\{mp},\39\.{"text?"});{}$\6
\&{break};\6
\4\&{case} \\{var\_defining}:\5
\&{case} \\{op\_defining}:\5
${}\\{mp\_print}(\\{mp},\39\.{"definition?"});{}$\6
\&{break};\6
\4\&{case} \\{loop\_defining}:\5
${}\\{mp\_print}(\\{mp},\39\.{"loop?"});{}$\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{mp\_link}(\\{mp}\MG\\{hold\_head}),%
\39\NULL,\39\\{mp}\MG\\{error\_line}-\T{10},\39\T{0});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{728}We need to mention a procedure that may be called by \PB{\\{get\_next}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_firm\_up\_the\_line}(\&{MP} \\{mp});\par
\fi

\M{729}And now we're ready to take the plunge into \PB{\\{get\_next}} itself.
Note that the behavior depends on the \PB{\\{scanner\_status}} because percent
signs
and double quotes need to be passed over when skipping TeX material.

\Y\B\&{void} \\{mp\_get\_next}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ sets \PB{\\{cur\_cmd}}, \PB{\\{cur\_mod}}, \PB{\\{cur\_sym}} to
next token }\1\6
\&{mp\_sym} \\{cur\_sym\_};\C{ speed up access }\7
\4\.{RESTART}:\5
${}\\{set\_cur\_sym}(\NULL);{}$\6
\\{set\_cur\_sym\_mod}(\T{0});\6
\&{if} (\\{file\_state})\5
${}\{{}$\1\6
\&{int} \|k;\C{ an index into \PB{\\{buffer}} }\6
\&{ASCII\_code} \|c;\C{ the current character in the buffer }\6
\&{int} \\{cclass};\C{ its class number }\C{ Input from external file; \PB{%
\&{goto} \\{restart}} if no input found,        or \PB{\&{return}} if a
non-symbolic token is found }\C{ A percent sign appears in \PB{\\{buffer}[%
\\{limit}]}; this makes it unnecessary        to have a special test for
end-of-line. }\7
\4\.{SWITCH}:\5
${}\|c\K\\{mp}\MG\\{buffer}[\\{loc}];{}$\6
\\{incr}(\\{loc});\6
${}\\{cclass}\K\\{mp}\MG\\{char\_class}[\|c];{}$\6
\&{switch} (\\{cclass})\5
${}\{{}$\1\6
\4\&{case} \\{digit\_class}:\5
${}\\{scan\_numeric\_token}((\|c-\.{'0'}));{}$\6
\&{return};\6
\&{break};\6
\4\&{case} \\{period\_class}:\5
${}\\{cclass}\K\\{mp}\MG\\{char\_class}[\\{mp}\MG\\{buffer}[\\{loc}]];{}$\6
\&{if} ${}(\\{cclass}>\\{period\_class}){}$\5
${}\{{}$\1\6
\&{goto} \.{SWITCH};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cclass}<\\{period\_class}){}$\5
${}\{{}$\C{ \PB{\&{class} $\K$ \\{digit\_class}} }\1\6
\\{scan\_fractional\_token}(\T{0});\6
\&{return};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{space\_class}:\5
\&{goto} \.{SWITCH};\6
\&{break};\6
\4\&{case} \\{percent\_class}:\6
\&{if} ${}(\\{mp}\MG\\{scanner\_status}\E\\{tex\_flushing}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{loc}<\\{limit}){}$\1\5
\&{goto} \.{SWITCH};\2\6
\4${}\}{}$\C{ Move to next line of file, or \PB{\&{goto} \\{restart}} if there
is no next line }\2\6
\&{switch} (\\{move\_to\_next\_line}(\\{mp}))\5
${}\{{}$\1\6
\4\&{case} \T{1}:\5
\&{goto} \.{RESTART};\6
\&{break};\6
\4\&{case} \T{2}:\5
\&{goto} \.{COMMON\_ENDING};\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
\\{check\_interrupt};\6
\&{goto} \.{SWITCH};\6
\&{break};\6
\4\&{case} \\{string\_class}:\6
\&{if} ${}(\\{mp}\MG\\{scanner\_status}\E\\{tex\_flushing}){}$\5
${}\{{}$\1\6
\&{goto} \.{SWITCH};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{buffer}[\\{loc}]\E\.{'"'}){}$\5
${}\{{}$\1\6
${}\\{set\_cur\_mod\_str}(\\{mp\_rts}(\\{mp},\39\.{""}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|k\K\\{loc};{}$\6
${}\\{mp}\MG\\{buffer}[\\{limit}+\T{1}]\K\\{xord}(\.{'"'});{}$\6
\&{do}\5
${}\{{}$\1\6
\\{incr}(\\{loc});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp}\MG\\{buffer}[\\{loc}]\I\.{'"'});{}$\6
\&{if} ${}(\\{loc}>\\{limit}){}$\5
${}\{{}$\C{ Decry the missing string delimiter and \PB{\&{goto} \\{restart}} }%
\C{ We go to \PB{\\{restart}} after this error message, not to \PB{\.{SWITCH}},
               because the \PB{\\{clear\_for\_error\_prompt}} routine might
have reinstated                \PB{\\{token\_state}} after \PB{\&{error}} has
finished. }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Strings\ should\ fini}\)\.{sh\ on\
the\ same\ line\ }\)\.{as\ they\ began."},\39\.{"I've\ deleted\ the\ pa}\)%
\.{rtial\ string;\ you\ mi}\)\.{ght\ want\ to"},\39\.{"insert\ another\ by\ t}%
\)\.{yping,\ e.g.,\ `I\\"new}\)\.{\ string\\"'."},\39\NULL\};{}$\7
${}\\{loc}\K\\{limit}{}$;\C{ the next character to be read on this line will be
\PB{\.{"\%"}} }\6
${}\\{mp\_error}(\\{mp},\39\.{"Incomplete\ string\ t}\)\.{oken\ has\ been\
flushe}\)\.{d"},\39\\{hlp},\39\\{false});{}$\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
${}\\{str\_room}((\&{size\_t})(\\{loc}-\|k));{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{append\_char}(\\{mp}\MG\\{buffer}[\|k]);{}$\6
\\{incr}(\|k);\6
\4${}\}{}$\2\5
\&{while} ${}(\|k\I\\{loc});{}$\6
\\{set\_cur\_mod\_str}(\\{mp\_make\_string}(\\{mp}));\6
\4${}\}{}$\2\6
\\{incr}(\\{loc});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_string\_token});\6
\&{return};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{isolated\_classes}:\5
${}\|k\K\\{loc}-\T{1};{}$\6
\&{goto} \.{FOUND};\6
\&{break};\6
\4\&{case} \\{invalid\_class}:\6
\&{if} ${}(\\{mp}\MG\\{scanner\_status}\E\\{tex\_flushing}){}$\5
${}\{{}$\1\6
\&{goto} \.{SWITCH};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Decry the invalid character and \PB{\&{goto} \\{restart}} }\C{ We
go to \PB{\\{restart}} instead of to \PB{\.{SWITCH}}, because we might enter
     \PB{\\{token\_state}} after the error has been dealt with         (cf.\ %
\PB{\\{clear\_for\_error\_prompt}}). }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ funny\ symbol\ that}\)\.{\ I\
can\\'t\ read\ has\ j}\)\.{ust\ been\ input."},\39\.{"Continue,\ and\ I'll\ }\)%
\.{forget\ that\ it\ ever\ }\)\.{happened."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Text\ line\ contains\ }\)\.{an\ invalid\
character}\)\.{"},\39\\{hlp},\39\\{false});{}$\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{default}:\5
\&{break};\C{ letters, etc. }\6
\4${}\}{}$\2\6
${}\|k\K\\{loc}-\T{1};{}$\6
\&{while} ${}(\\{mp}\MG\\{char\_class}[\\{mp}\MG\\{buffer}[\\{loc}]]\E%
\\{cclass}){}$\1\5
\\{incr}(\\{loc});\2\6
\4\.{FOUND}:\5
${}\\{set\_cur\_sym}(\\{mp\_id\_lookup}(\\{mp},\39{}$(\&{char} ${}{*})(\\{mp}%
\MG\\{buffer}+\|k),\39(\&{size\_t})(\\{loc}-\|k),\39\\{true}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Input from token list; \PB{\&{goto} \\{restart}} if end of list or
      if a parameter needs to be expanded,        or \PB{\&{return}} if a
non-symbolic token is found }\1\6
\&{if} ${}(\\{nloc}\I\NULL\W\\{mp\_type}(\\{nloc})\E\\{mp\_symbol\_node}){}$\5
${}\{{}$\C{ symbolic token }\1\6
\&{int} \\{cur\_sym\_mod\_}${}\K\\{mp\_name\_type}(\\{nloc});{}$\6
\&{halfword} \\{cur\_info}${}\K\\{mp\_sym\_info}(\\{nloc});{}$\7
\\{set\_cur\_sym}(\\{mp\_sym\_sym}(\\{nloc}));\6
\\{set\_cur\_sym\_mod}(\\{cur\_sym\_mod\_});\6
${}\\{nloc}\K\\{mp\_link}(\\{nloc}){}$;\C{ move to next }\6
\&{if} ${}(\\{cur\_sym\_mod\_}\E\\{mp\_expr\_sym}){}$\5
${}\{{}$\1\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_capsule\_token});\6
${}\\{set\_cur\_mod\_node}(\\{mp}\MG\\{param\_stack}[\\{param\_start}+\\{cur%
\_info}]);{}$\6
\\{set\_cur\_sym\_mod}(\T{0});\6
${}\\{set\_cur\_sym}(\NULL);{}$\6
\&{return};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_sym\_mod\_}\E\\{mp\_suffix\_sym}\V\\{cur\_sym\_mod%
\_}\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
${}\\{mp\_begin\_token\_list}(\\{mp},\39\\{mp}\MG\\{param\_stack}[\\{param%
\_start}+\\{cur\_info}],\39{}$(\&{quarterword}) \\{parameter});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{nloc}\I\NULL){}$\5
${}\{{}$\C{ Get a stored numeric or string or capsule token and \PB{\&{return}}
}\1\6
\&{if} ${}(\\{mp\_name\_type}(\\{nloc})\E\\{mp\_token}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{nloc})\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\\{set\_cur\_mod\_number}(\\{value\_number}(\\{nloc}));\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_numeric\_token});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_mod\_str}(\\{value\_str}(\\{nloc}));\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_string\_token});\6
\\{add\_str\_ref}(\\{cur\_mod\_str}(\,));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_mod\_node}(\\{nloc});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_capsule\_token});\6
\4${}\}{}$\2\6
${}\\{nloc}\K\\{mp\_link}(\\{nloc});{}$\6
\&{return};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ we are done with this token list }\1\6
\\{mp\_end\_token\_list}(\\{mp});\6
\&{goto} \.{RESTART};\C{ resume previous level }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4\.{COMMON\_ENDING}:\C{ When a symbolic token is declared to be `\&{outer}',
its command code      is increased by \PB{\\{outer\_tag}}. }\6
${}\\{cur\_sym\_}\K\\{cur\_sym}(\,);{}$\6
\\{set\_cur\_cmd}(\\{eq\_type}(\\{cur\_sym\_}));\6
\\{set\_cur\_mod}(\\{equiv}(\\{cur\_sym\_}));\6
\\{set\_cur\_mod\_node}(\\{equiv\_node}(\\{cur\_sym\_}));\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_outer\_tag}){}$\5
${}\{{}$\1\6
\&{if} (\\{mp\_check\_outer\_validity}(\\{mp}))\1\5
${}\\{set\_cur\_cmd}(\\{cur\_cmd}(\,)-\\{mp\_outer\_tag});{}$\2\6
\&{else}\1\5
\&{goto} \.{RESTART};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{730}The global variable \PB{\\{force\_eof}} is normally \PB{\\{false}}; it
is set \PB{\\{true}}
by an \&{endinput} command.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{force\_eof};\C{ should the next \&{input} be aborted early? }\par
\fi

\M{731}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{int} \\{move\_to\_next\_line}(\&{MP} \\{mp});\par
\fi

\M{732}\B\&{static} \&{int} \\{move\_to\_next\_line}(\&{MP} \\{mp})\1\1 $\{$ %
\&{if} ${}(\\{name}>\\{max\_spec\_src})$ $\{{}$\C{ Read next line of file into %
\PB{\\{buffer}}, or return 1       (\PB{\&{goto} \\{restart}}) if the file has
ended }\C{ We must decrement \PB{\\{loc}} in order to leave the buffer in a
valid state        when an error condition causes us to \PB{\&{goto} %
\\{restart}} without calling       \PB{\\{end\_file\_reading}}. }\6
$\{$ \\{incr} ( \&{line} )  ;\6
${}\\{mp}\MG\\{first}\K{}$(\&{size\_t}) \\{start};\6
\&{if} ${}(\R\\{mp}\MG\\{force\_eof}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_input\_ln}(\\{mp},\39\\{cur\_file}){}$)\C{ not end of file }%
\1\6
\\{mp\_firm\_up\_the\_line}(\\{mp});\C{ this sets \PB{\\{limit}} }\2\6
\&{else}\1\5
${}\\{mp}\MG\\{force\_eof}\K\\{true};{}$\2\6
\4${}\}{}$\2\6
;\6
\&{if} ${}(\\{mp}\MG\\{force\_eof}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{force\_eof}\K\\{false};{}$\6
\\{decr}(\\{loc});\6
\&{if} (\\{mpx\_reading})\5
${}\{{}$\C{ Complain that the \.{MPX} file ended unexpectly; then set
  \PB{\\{cur\_sym}: $\K$ $\\{mp}\MG\\{frozen\_mpx\_break}$} and \PB{\&{goto} %
\\{comon\_ending}} }\C{ We should never actually come to the end of an \.{MPX}
file because such              files should have an \&{mpxbreak} after the
translation of the last              \&{btex}$\,\ldots\,$\&{etex} block. }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ file\ had\ too\ fe}\)\.{w\
picture\ expression}\)\.{s\ for\ btex...etex"},\39\.{"blocks.\ \ Such\ files}\)%
\.{\ are\ normally\ genera}\)\.{ted\ automatically"},\39\.{"but\ this\ one\ got%
\ me}\)\.{ssed\ up.\ \ You\ might\ }\)\.{want\ to\ insert\ a"},\39\.{"picture\
expression\ }\)\.{now."},\39\NULL\};{}$\7
${}\\{mp}\MG\\{mpx\_name}[\\{iindex}]\K\\{mpx\_finished};{}$\6
${}\\{mp\_error}(\\{mp},\39\.{"mpx\ file\ ended\ unex}\)\.{pectedly"},\39%
\\{hlp},\39\\{false});{}$\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_mpx\_break});{}$\6
\&{return} \T{2};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
${}\\{decr}(\\{mp}\MG\\{open\_parens});{}$\6
\\{update\_terminal}(\,);\C{ show user that file has been read }\6
\\{mp\_end\_file\_reading}(\\{mp});\C{ resume previous level }\6
\&{if} (\\{mp\_check\_outer\_validity}(\\{mp}))\1\5
\&{return} \T{1};\2\6
\&{else}\1\5
\&{return} \T{1};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start}{}$;\C{ ready to read }\6
$\}$ $\}$ \6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{input\_ptr}>\T{0}){}$\5
${}\{{}$\C{ text was inserted during error recovery or by \&{scantokens} }\1\6
\\{mp\_end\_file\_reading}(\\{mp});\C{ goto RESTART }\6
\&{return} \T{1};\C{ resume previous level }\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL\W(\\{mp}\MG\\{selector}<\\{log\_only}%
\V\\{mp}\MG\\{selector}\G\\{write\_file})){}$\1\5
\\{mp\_open\_log\_file}(\\{mp});\2\6
\&{if} ${}(\\{mp}\MG\\{interaction}>\\{mp\_nonstop\_mode}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{limit}\E\\{start}{}$)\C{ previous line was empty }\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(Please\ type\ a\ comm}\)\.{and\ or\ say\
`end')"});{}$\2\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{first}\K{}$(\&{size\_t}) \\{start};\6
\\{prompt\_input}(\.{"*"});\C{ input on-line into \PB{\\{buffer}} }\6
${}\\{limit}\K{}$(\&{halfword}) \\{mp}${}\MG\\{last};{}$\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"***\ (job\ aborted,\ n}\)\.{o\ legal\ end%
\ found)"}){}$;\C{ nonstop mode, which is intended for overnight batch
processing,          never waits for on-line input }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{return} \T{0}; $\}{}$\par
\fi

\M{733}If the user has set the \PB{\\{mp\_pausing}} parameter to some positive
value,
and if nonstop mode has not been selected, each line of input is displayed
on the terminal and the transcript file, followed by `\.{=>}'.
\MP\ waits for a response. If the response is NULL (i.e., if nothing is
typed except perhaps a few blank spaces), the original
line is accepted as it stands; otherwise the line typed is
used instead of the line in the file.

\Y\B\&{void} \\{mp\_firm\_up\_the\_line}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|k;\C{ an index into \PB{\\{buffer}} }\7
${}\\{limit}\K{}$(\&{halfword}) \\{mp}${}\MG\\{last};{}$\6
\&{if} ${}((\R\\{mp}\MG\\{noninteractive})\W(\\{number\_positive}(\\{internal%
\_value}(\\{mp\_pausing})))\W(\\{mp}\MG\\{interaction}>\\{mp\_nonstop%
\_mode})){}$\5
${}\{{}$\1\6
\\{wake\_up\_terminal}(\,);\6
\\{mp\_print\_ln}(\\{mp});\6
\&{if} ${}(\\{start}<\\{limit}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|k\K{}$(\&{size\_t}) \\{start}; ${}\|k<{}$(\&{size\_t}) \\{limit};
${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{buffer}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{first}\K{}$(\&{size\_t}) \\{limit};\6
\\{prompt\_input}(\.{"=>"});\C{ wait for user response }\6
;\6
\&{if} ${}(\\{mp}\MG\\{last}>\\{mp}\MG\\{first}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|k\K\\{mp}\MG\\{first};{}$ ${}\|k<\\{mp}\MG\\{last};{}$ ${}\|k%
\PP){}$\5
${}\{{}$\C{ move line down in buffer }\1\6
${}\\{mp}\MG\\{buffer}[\|k+{}$(\&{size\_t}) \\{start}${}-\\{mp}\MG\\{first}]\K%
\\{mp}\MG\\{buffer}[\|k];{}$\6
\4${}\}{}$\2\6
${}\\{limit}\K{}$(\&{halfword})((\&{size\_t}) \\{start}${}+\\{mp}\MG\\{last}-%
\\{mp}\MG\\{first});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\N{1}{734}Dealing with \TeX\ material.
The \&{btex}$\,\ldots\,$\&{etex} and \&{verbatimtex}$\,\ldots\,$\&{etex}
features need to be implemented at a low level in the scanning process
so that \MP\ can stay in synch with the a preprocessor that treats
blocks of \TeX\ material as they occur in the input file without trying
to expand \MP\ macros.  Thus we need a special version of \PB{\\{get\_next}}
that does not expand macros and such but does handle \&{btex},
\&{verbatimtex}, etc.

The special version of \PB{\\{get\_next}} is called \PB{\\{get\_t\_next}}.  It
works by flushing
\&{btex}$\,\ldots\,$\&{etex} and \&{verbatimtex}\allowbreak
$\,\ldots\,$\&{etex} blocks, switching to the \.{MPX} file when it sees
\&{btex}, and switching back when it sees \&{mpxbreak}.

\Y\B\4\D$\\{btex\_code}$ \5
\T{0}\par
\B\4\D$\\{verbatim\_code}$ \5
\T{1}\par
\fi

\M{735}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"btex"},\39\\{mp\_start\_tex},\39\\{btex%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"verbatimtex"},\39\\{mp\_start\_tex},\39%
\\{verbatim\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"etex"},\39\\{mp\_etex\_marker},\39\T{0});{}$%
\6
${}\\{mp}\MG\\{frozen\_etex}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"etex"},%
\39\\{mp\_etex\_marker},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"mpxbreak"},\39\\{mp\_mpx\_break},\39%
\T{0});{}$\6
${}\\{mp}\MG\\{frozen\_mpx\_break}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{"mpxbreak"},\39\\{mp\_mpx\_break},\39\T{0}){}$;\par
\fi

\M{736}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_start\_tex}:\6
\&{if} ${}(\|m\E\\{btex\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"btex"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"verbatimtex"});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_etex\_marker}:\5
${}\\{mp\_print}(\\{mp},\39\.{"etex"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_mpx\_break}:\5
${}\\{mp\_print}(\\{mp},\39\.{"mpxbreak"});{}$\6
\&{break};\par
\fi

\M{737}Actually, \PB{\\{get\_t\_next}} is a macro that avoids procedure
overhead except
in the unusual case where \&{btex}, \&{verbatimtex}, \&{etex}, or \&{mpxbreak}
is encountered.

\Y\B\4\D$\\{get\_t\_next}(\|a)$ \5
\&{do} \6
${}\{{}$\1\6
\\{mp\_get\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_max\_pre\_command}){}$\1\5
\\{mp\_t\_next}(\\{mp});\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\par
\fi

\M{738}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_t\_next}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_start\_mpx\_input}(\&{MP} \\{mp});\par
\fi

\M{739}\B\&{static} \&{void} \\{mp\_t\_next}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \\{old\_status};\C{ saves the \PB{\\{scanner\_status}} }\6
\&{integer} \\{old\_info};\C{ saves the \PB{\\{warning\_info}} }\7
\&{while} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_max\_pre\_command}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_mpx\_break}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{file\_state}\V(\\{mp}\MG\\{mpx\_name}[\\{iindex}]\E%
\\{absent})){}$\5
${}\{{}$\1\6
\X743:Complain about a misplaced \&{mpxbreak}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_end\_mpx\_reading}(\\{mp});\6
\&{goto} \.{TEX\_FLUSH};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_start\_tex}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{token\_state}\V(\\{name}\Z\\{max\_spec\_src})){}$\5
${}\{{}$\1\6
\X742:Complain that we are not reading a file\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{mpx\_reading})\5
${}\{{}$\1\6
\X741:Complain that \.{MPX} files cannot contain \TeX\ material\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{cur\_mod}(\,)\I\\{verbatim\_code})\W(\\{mp}\MG\\{mpx%
\_name}[\\{iindex}]\I\\{mpx\_finished})){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_begin\_mpx\_reading}(\\{mp})){}$\1\5
\\{mp\_start\_mpx\_input}(\\{mp});\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{goto} \.{TEX\_FLUSH};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X744:Complain about a misplaced \&{etex}\X;\6
\4${}\}{}$\2\6
\&{goto} \.{COMMON\_ENDING};\6
\4\.{TEX\_FLUSH}:\5
\X740:Flush the \TeX\ material\X;\6
\4\.{COMMON\_ENDING}:\5
\\{mp\_get\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{740}We could be in the middle of an operation such as skipping false
conditional
text when \TeX\ material is encountered, so we must be careful to save the
\PB{\\{scanner\_status}}.

\Y\B\4\X740:Flush the \TeX\ material\X${}\E{}$\6
$\\{old\_status}\K\\{mp}\MG\\{scanner\_status};{}$\6
${}\\{old\_info}\K\\{mp}\MG\\{warning\_line};{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{tex\_flushing};$ $\\{mp}\MG\\{warning%
\_line}$ $\K$ \&{line}  ;\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_get\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\I\\{mp\_etex\_marker});{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{old\_status};$ $\\{mp}\MG\\{warning\_line}%
\K{}$\\{old\_info}\par
\U739.\fi

\M{741}\B\X741:Complain that \.{MPX} files cannot contain \TeX\ material\X${}%
\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ file\ contains\ }\)\.{picture%
\ expressions\ }\)\.{for\ btex...etex"},\39\.{"blocks.\ \ Such\ files}\)\.{\
are\ normally\ genera}\)\.{ted\ automatically"},\39\.{"but\ this\ one\ seems\ }%
\)\.{to\ be\ messed\ up.\ \ I'}\)\.{ll\ just\ keep\ going"},\39\.{"and\ hope\
for\ the\ be}\)\.{st."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"An\ mpx\ file\ cannot\ }\)\.{contain\ btex\ or\
verb}\)\.{atimtex\ blocks"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\U739.\fi

\M{742}\B\X742:Complain that we are not reading a file\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'll\ have\ to\ ignore}\)\.{\ this\
preprocessor\ c}\)\.{ommand\ because\ it"},\39\.{"only\ works\ when\ the}\)%
\.{re\ is\ a\ file\ to\ prep}\)\.{rocess.\ \ You\ might"},\39\.{"want\ to\
delete\ ever}\)\.{ything\ up\ to\ the\ nex}\)\.{t\ `etex`."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"You\ can\ only\ use\ `b}\)\.{tex'\ or\
`verbatimtex}\)\.{'\ in\ a\ file"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\U739.\fi

\M{743}\B\X743:Complain about a misplaced \&{mpxbreak}\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'll\ ignore\ this\ pr}\)%
\.{eprocessor\ command\ b}\)\.{ecause\ it"},\39\.{"doesn't\ belong\ here}\)%
\.{"},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Misplaced\ mpxbreak"},\39\\{hlp},\39%
\\{true});{}$\6
\4${}\}{}$\2\par
\U739.\fi

\M{744}\B\X744:Complain about a misplaced \&{etex}\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"There\ is\ no\ btex\ or}\)\.{\
verbatimtex\ for\ thi}\)\.{s\ to\ match"},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ etex\ will\ be\ }\)\.{ignored"},\39%
\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\U739.\fi

\N{1}{745}Scanning macro definitions.
\MP\ has a variety of ways to tuck tokens away into token lists for later
use: Macros can be defined with \&{def}, \&{vardef}, \&{primarydef}, etc.;
repeatable code can be defined with \&{for}, \&{forever}, \&{forsuffixes}.
All such operations are handled by the routines in this part of the program.

The modifier part of each command code is zero for the ``ending delimiters''
like \&{enddef} and \&{endfor}.

\Y\B\4\D$\\{start\_def}$ \5
\T{1}\C{ command modifier for \&{def} }\par
\B\4\D$\\{var\_def}$ \5
\T{2}\C{ command modifier for \&{vardef} }\par
\B\4\D$\\{end\_def}$ \5
\T{0}\C{ command modifier for \&{enddef} }\par
\B\4\D$\\{start\_forever}$ \5
\T{1}\C{ command modifier for \&{forever} }\par
\B\4\D$\\{start\_for}$ \5
\T{2}\C{ command modifier for \&{forever} }\par
\B\4\D$\\{start\_forsuffixes}$ \5
\T{3}\C{ command modifier for \&{forever} }\par
\B\4\D$\\{end\_for}$ \5
\T{0}\C{ command modifier for \&{endfor} }\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"def"},\39\\{mp\_macro\_def},\39\\{start%
\_def});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"vardef"},\39\\{mp\_macro\_def},\39\\{var%
\_def});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"primarydef"},\39\\{mp\_macro\_def},\39\\{mp%
\_secondary\_primary\_macro});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"secondarydef"},\39\\{mp\_macro\_def},\39%
\\{mp\_tertiary\_secondary\_macro});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tertiarydef"},\39\\{mp\_macro\_def},\39\\{mp%
\_expression\_tertiary\_macro});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"enddef"},\39\\{mp\_macro\_def},\39\\{end%
\_def});{}$\6
${}\\{mp}\MG\\{frozen\_end\_def}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{"enddef"},\39\\{mp\_macro\_def},\39\\{end\_def});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"for"},\39\\{mp\_iteration},\39\\{start%
\_for});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"forsuffixes"},\39\\{mp\_iteration},\39%
\\{start\_forsuffixes});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"forever"},\39\\{mp\_iteration},\39\\{start%
\_forever});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"endfor"},\39\\{mp\_iteration},\39\\{end%
\_for});{}$\6
${}\\{mp}\MG\\{frozen\_end\_for}\K\\{mp\_frozen\_primitive}(\\{mp},\39%
\.{"endfor"},\39\\{mp\_iteration},\39\\{end\_for}){}$;\par
\fi

\M{746}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_macro\_def}:\6
\&{if} ${}(\|m\Z\\{var\_def}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|m\E\\{start\_def}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"def"});{}$\2\6
\&{else} \&{if} ${}(\|m<\\{start\_def}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"enddef"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"vardef"});{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_secondary\_primary\_macro}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"primarydef"});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_tertiary\_secondary\_macro}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"secondarydef"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"tertiarydef"});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_iteration}:\6
\&{if} ${}(\|m\E\\{start\_forever}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"forever"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{end\_for}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"endfor"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{start\_for}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"for"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"forsuffixes"});{}$\2\6
\&{break};\par
\fi

\M{747}Different macro-absorbing operations have different syntaxes, but they
also have a lot in common. There is a list of special symbols that are to
be replaced by parameter tokens; there is a special command code that
ends the definition; the quotation conventions are identical.  Therefore
it makes sense to have most of the work done by a single subroutine. That
subroutine is called \PB{\\{scan\_toks}}.

The first parameter to \PB{\\{scan\_toks}} is the command code that will
terminate scanning (either \PB{\\{macro\_def}} or \PB{\\{iteration}}).

The second parameter, \PB{\\{subst\_list}}, points to a (possibly empty) list
of non-symbolic nodes whose \PB{\\{info}} and \PB{\\{value}} fields specify
symbol tokens
before and after replacement. The list will be returned to free storage
by \PB{\\{scan\_toks}}.

The third parameter is simply appended to the token list that is built.
And the final parameter tells how many of the special operations
\.{\#\AT!}, \.{\AT!}, and \.{\AT!\#} are to be replaced by suffix parameters.
When such parameters are present, they are called \.{(SUFFIX0)},
\.{(SUFFIX1)}, and \.{(SUFFIX2)}.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_subst\_list\_item} ${}\{{}$\1\6
\&{mp\_name\_type\_type} \\{info\_mod};\6
\&{quarterword} \\{value\_mod};\6
\&{mp\_sym} \\{info};\6
\&{halfword} \\{value\_data};\6
\&{struct} \&{mp\_subst\_list\_item} ${}{*}\\{link};{}$\2\6
${}\}{}$ \&{mp\_subst\_list\_item};\par
\fi

\M{748}
\Y\B\&{static} \&{mp\_node} \\{mp\_scan\_toks}(\&{MP} \\{mp}${},\39\\{mp%
\_command\_code}\\{terminator},\39{}$\&{mp\_subst\_list\_item} ${}{*}\\{subst%
\_list},\39{}$\&{mp\_node} \\{tail\_end}${},\39{}$\&{quarterword} \\{suffix%
\_count})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ tail of the token list being built }\6
\&{mp\_subst\_list\_item} ${}{*}\|q\K\NULL{}$;\C{ temporary for link management
}\6
\&{integer} \\{balance};\C{ left delimiters minus right delimiters }\6
\&{halfword} \\{cur\_data};\6
\&{quarterword} \\{cur\_data\_mod}${}\K\T{0};{}$\7
${}\|p\K\\{mp}\MG\\{hold\_head};{}$\6
${}\\{balance}\K\T{1};{}$\6
${}\\{mp\_link}(\\{mp}\MG\\{hold\_head})\K\NULL;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
${}\\{cur\_data}\K{-}\T{1};{}$\6
\&{if} ${}(\\{cur\_sym}(\,)\I\NULL){}$\5
${}\{{}$\1\6
\X751:Substitute for \PB{\\{cur\_sym}}, if it's on the \PB{\\{subst\_list}}\X;\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{terminator}){}$\5
${}\{{}$\1\6
\X752:Adjust the balance; \PB{\&{break}} if it's zero\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_macro\_special}){}$\5
${}\{{}$\C{ Handle quoted symbols, \.{\#\AT!}, \.{\AT!}, or \.{\AT!\#} }\1\6
\&{if} ${}(\\{cur\_mod}(\,)\E\\{quote}){}$\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\Z\\{suffix\_count}){}$\5
${}\{{}$\1\6
${}\\{cur\_data}\K\\{cur\_mod}(\,)-\T{1};{}$\6
${}\\{cur\_data\_mod}\K\\{mp\_suffix\_sym};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_data}\I{-}\T{1}){}$\5
${}\{{}$\1\6
\&{mp\_node} \\{pp}${}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\7
${}\\{set\_mp\_sym\_info}(\\{pp},\39\\{cur\_data});{}$\6
${}\\{mp\_name\_type}(\\{pp})\K\\{cur\_data\_mod};{}$\6
${}\\{mp\_link}(\|p)\K\\{pp};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_link}(\|p)\K\\{mp\_cur\_tok}(\\{mp});{}$\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|p)\K\\{tail\_end};{}$\6
\&{while} (\\{subst\_list})\5
${}\{{}$\1\6
${}\|q\K\\{subst\_list}\MG\\{link};{}$\6
\\{xfree}(\\{subst\_list});\6
${}\\{subst\_list}\K\|q;{}$\6
\4${}\}{}$\2\6
\&{return} \\{mp\_link}${}(\\{mp}\MG\\{hold\_head});{}$\6
\4${}\}{}$\2\par
\fi

\M{749}
\Y\B\&{void} \\{mp\_print\_sym}(\&{mp\_sym} \\{sym})\1\1\2\2\6
${}\{{}$\1\6
${}\\{printf}(\.{"\{type\ =\ \%d,\ v\ =\ \{ty}\)\.{pe\ =\ \%d,\ data\ =\ \{ind}%
\)\.{ep\ =\ \{scale\ =\ \%d,\ se}\)\.{rial\ =\ \%d\},\ n\ =\ \%d,\ }\)\.{str\ =%
\ \%p,\ sym\ =\ \%p,\ }\)\.{node\ =\ \%p,\ p\ =\ \%p\}\},}\)\.{\ text\ =\ \%p\}%
\\n"},\39\\{sym}\MG\\{type},\39\\{sym}\MG\|v.\\{type},\39{}$(\&{int}) %
\\{sym}${}\MG\|v.\\{data}.\\{indep}.\\{scale},\39{}$(\&{int}) \\{sym}${}\MG\|v.%
\\{data}.\\{indep}.\\{serial},\39\\{sym}\MG\|v.\\{data}.\|n.\\{type},\39\\{sym}%
\MG\|v.\\{data}.\\{str},\39\\{sym}\MG\|v.\\{data}.\\{sym},\39\\{sym}\MG\|v.%
\\{data}.\\{node},\39\\{sym}\MG\|v.\\{data}.\|p,\39\\{sym}\MG\\{text});{}$\6
\&{if} ${}(\\{is\_number}(\\{sym}\MG\|v.\\{data}.\|n)){}$\5
${}\{{}$\1\6
\&{mp\_number} \|n${}\K\\{sym}\MG\|v.\\{data}.\|n;{}$\7
${}\\{printf}(\.{"\{data\ =\ \{dval\ =\ \%f,}\)\.{\ val\ =\ \%d\},\ type\ =\ %
\%}\)\.{d\}\\n"},\39\|n.\\{data}.\\{dval},\39\|n.\\{data}.\\{val},\39\|n.%
\\{type});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{sym}\MG\\{text}\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_string} \|t${}\K\\{sym}\MG\\{text};{}$\7
${}\\{printf}(\.{"\{str\ =\ \%p\ \\"\%s\\",\ l}\)\.{en\ =\ \%d,\ refs\ =\ \%d\}%
\\}\)\.{n"},\39\|t\MG\\{str},\39\|t\MG\\{str},\39{}$(\&{int}) \|t${}\MG\\{len},%
\39\|t\MG\\{refs});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{750}
\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_print\_sym}(\&{mp\_sym} \\{sym});\par
\fi

\M{751}\B\X751:Substitute for \PB{\\{cur\_sym}}, if it's on the \PB{\\{subst%
\_list}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|q\K\\{subst\_list};{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\|q\MG\\{info}\E\\{cur\_sym}(\,)\W\|q\MG\\{info\_mod}\E\\{cur\_sym%
\_mod}(\,)){}$\5
${}\{{}$\1\6
${}\\{cur\_data}\K\|q\MG\\{value\_data};{}$\6
${}\\{cur\_data\_mod}\K\|q\MG\\{value\_mod};{}$\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_relax});\6
\&{break};\6
\4${}\}{}$\2\6
${}\|q\K\|q\MG\\{link};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U748.\fi

\M{752}\B\X752:Adjust the balance; \PB{\&{break}} if it's zero\X${}\E{}$\6
\&{if} ${}(\\{cur\_mod}(\,)>\T{0}){}$\5
${}\{{}$\1\6
\\{incr}(\\{balance});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{decr}(\\{balance});\6
\&{if} ${}(\\{balance}\E\T{0}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\par
\U748.\fi

\M{753}Four commands are intended to be used only within macro texts: %
\&{quote},
\.{\#\AT!}, \.{\AT!}, and \.{\AT!\#}. They are variants of a single command
code called \PB{\\{macro\_special}}.

\Y\B\4\D$\\{quote}$ \5
\T{0}\C{ \PB{\\{macro\_special}} modifier for \&{quote} }\par
\B\4\D$\\{macro\_prefix}$ \5
\T{1}\C{ \PB{\\{macro\_special}} modifier for \.{\#\AT!} }\par
\B\4\D$\\{macro\_at}$ \5
\T{2}\C{ \PB{\\{macro\_special}} modifier for \.{\AT!} }\par
\B\4\D$\\{macro\_suffix}$ \5
\T{3}\C{ \PB{\\{macro\_special}} modifier for \.{\AT!\#} }\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"quote"},\39\\{mp\_macro\_special},\39%
\\{quote});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"\#@"},\39\\{mp\_macro\_special},\39\\{macro%
\_prefix});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"@"},\39\\{mp\_macro\_special},\39\\{macro%
\_at});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"@\#"},\39\\{mp\_macro\_special},\39\\{macro%
\_suffix}){}$;\par
\fi

\M{754}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_macro\_special}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{macro\_prefix}:\5
${}\\{mp\_print}(\\{mp},\39\.{"\#@"});{}$\6
\&{break};\6
\4\&{case} \\{macro\_at}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'@'}));{}$\6
\&{break};\6
\4\&{case} \\{macro\_suffix}:\5
${}\\{mp\_print}(\\{mp},\39\.{"@\#"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"quote"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{755}Here is a routine that's used whenever a token will be redefined. If
the user's token is unredefinable, the `\PB{$\\{mp}\MG\\{frozen%
\_inaccessible}$}' token is
substituted; the latter is redefinable but essentially impossible to use,
hence \MP's tables won't get fouled up.

\Y\B\&{static} \&{void} \\{mp\_get\_symbol}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ sets \PB{\\{cur\_sym}} to a safe symbol }\1\6
\4\.{RESTART}:\5
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}((\\{cur\_sym}(\,)\E\NULL)\V\\{mp\_is\_frozen}(\\{mp},\39\\{cur%
\_sym}(\,))){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Sorry:\ You\ can\\'t\ r}\)%
\.{edefine\ a\ number,\ st}\)\.{ring,\ or\ expr."},\39\.{"I've\ inserted\ an\
in}\)\.{accessible\ symbol\ so}\)\.{\ that\ your"},\39\.{"definition\ will\ be\
}\)\.{completed\ without\ mi}\)\.{xing\ me\ up\ too\ badly}\)\.{."},\39\NULL%
\};{}$\7
\&{if} ${}(\\{cur\_sym}(\,)\I\NULL){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Sorry:\ You\ can\\'t\ r}\)\.{edefine\ my\ error-rec}\)%
\.{overy\ tokens."};{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_string\_token}){}$\1\5
\\{delete\_str\_ref}(\\{cur\_mod\_str}(\,));\2\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_inaccessible});{}$\6
${}\\{mp\_ins\_error}(\\{mp},\39\.{"Missing\ symbolic\ to}\)\.{ken\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{756}Before we actually redefine a symbolic token, we need to clear away its
former value, if it was a variable. The following stronger version of
\PB{\\{get\_symbol}} does that.

\Y\B\&{static} \&{void} \\{mp\_get\_clear\_symbol}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{mp\_clear\_symbol}(\\{mp},\39\\{cur\_sym}(\,),\39\\{false});{}$\6
\4${}\}{}$\2\par
\fi

\M{757}Here's another little subroutine; it checks that an equals sign
or assignment sign comes along at the proper place in a macro definition.

\Y\B\&{static} \&{void} \\{mp\_check\_equals}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_equals}){}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_assignment}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ next\ thing\ in\ t}\)\.{his\
`def'\ should\ hav}\)\.{e\ been\ `=',"},\39\.{"because\ I've\ alread}\)\.{y\
looked\ at\ the\ defi}\)\.{nition\ heading."},\39\.{"But\ don't\ worry;\ I'}\)%
\.{ll\ pretend\ that\ an\ e}\)\.{quals\ sign"},\39\.{"was\ present.\ Everyt}\)%
\.{hing\ from\ here\ to\ `e}\)\.{nddef'"},\39\.{"will\ be\ the\ replace}\)%
\.{ment\ text\ of\ this\ ma}\)\.{cro."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `='\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\2\6
\4${}\}{}$\2\par
\fi

\M{758}A \&{primarydef}, \&{secondarydef}, or \&{tertiarydef} is rather easily
handled now that we have \PB{\\{scan\_toks}}.  In this case there are
two parameters, which will be \.{EXPR0} and \.{EXPR1}.

\Y\B\&{static} \&{void} \\{mp\_make\_op\_def}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_command\_code}\|m;\C{ the type of definition }\7
\&{mp\_node} \|q${},{}$ \|r;\C{ for list manipulation }\6
\&{mp\_subst\_list\_item} ${}{*}\\{qm}\K\NULL,{}$ ${}{*}\\{qn}\K\NULL;{}$\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{qm}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\\{qm}\MG\\{link}\K\NULL;{}$\6
${}\\{qm}\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\\{qm}\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\\{qm}\MG\\{value\_data}\K\T{0};{}$\6
${}\\{qm}\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
\\{mp\_get\_clear\_symbol}(\\{mp});\6
${}\\{mp}\MG\\{warning\_info}\K\\{cur\_sym}(\,);{}$\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{qn}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\\{qn}\MG\\{link}\K\\{qm};{}$\6
${}\\{qn}\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\\{qn}\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\\{qn}\MG\\{value\_data}\K\T{1};{}$\6
${}\\{qn}\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
\\{get\_t\_next}(\\{mp});\6
\\{mp\_check\_equals}(\\{mp});\6
${}\\{mp}\MG\\{scanner\_status}\K\\{op\_defining};{}$\6
${}\|q\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_ref\_count}(\|q,\39\T{0});{}$\6
${}\|r\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{mp\_link}(\|q)\K\|r;{}$\6
${}\\{set\_mp\_sym\_info}(\|r,\39\\{mp\_general\_macro});{}$\6
${}\\{mp\_name\_type}(\|r)\K\\{mp\_macro\_sym};{}$\6
${}\\{mp\_link}(\|r)\K\\{mp\_scan\_toks}(\\{mp},\39\\{mp\_macro\_def},\39%
\\{qn},\39\NULL,\39\T{0});{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
${}\\{set\_eq\_type}(\\{mp}\MG\\{warning\_info},\39\|m);{}$\6
${}\\{set\_equiv\_node}(\\{mp}\MG\\{warning\_info},\39\|q);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{759}Parameters to macros are introduced by the keywords \&{expr},
\&{suffix}, \&{text}, \&{primary}, \&{secondary}, and \&{tertiary}.

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"expr"},\39\\{mp\_param\_type},\39\\{mp\_expr%
\_param});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"suffix"},\39\\{mp\_param\_type},\39\\{mp%
\_suffix\_param});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"text"},\39\\{mp\_param\_type},\39\\{mp\_text%
\_param});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"primary"},\39\\{mp\_param\_type},\39\\{mp%
\_primary\_macro});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"secondary"},\39\\{mp\_param\_type},\39\\{mp%
\_secondary\_macro});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"tertiary"},\39\\{mp\_param\_type},\39\\{mp%
\_tertiary\_macro}){}$;\par
\fi

\M{760}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_param\_type}:\6
\&{if} ${}(\|m\E\\{mp\_expr\_param}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"expr"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_suffix\_param}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"suffix"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_text\_param}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"text"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_primary\_macro}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"primary"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_secondary\_macro}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"secondary"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"tertiary"});{}$\2\6
\&{break};\par
\fi

\M{761}Let's turn next to the more complex processing associated with \&{def}
and \&{vardef}. When the following procedure is called, \PB{\\{cur\_mod}}
should be either \PB{\\{start\_def}} or \PB{\\{var\_def}}.

Note that although the macro scanner allows \PB{\\{def} $\K$ : $\K$ \\{enddef}}
and
\PB{\\{def}: $\MRL{{\K}{\K}}$ \\{enddef}}; \PB{$\\{def}\MRL{{\K}{\K}}%
\\{enddef}$} and \PB{\\{def}: $\K$ : $\K$ \\{enddef}} will generate
an error because by the time the second of the two identical tokens is
seen, its meaning has already become undefined.

\Y\B\&{static} \&{void} \\{mp\_scan\_def}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|m;\C{ the type of definition }\6
\&{int} \|n;\C{ the number of special suffix parameters }\6
\&{int} \|k;\C{ the total number of parameters }\6
\&{int} \|c;\C{ the kind of macro we're defining }\6
\&{mp\_subst\_list\_item} ${}{*}\|r\K\NULL,{}$ ${}{*}\\{rp}\K\NULL{}$;\C{
parameter-substitution list }\6
\&{mp\_node} \|q;\C{ tail of the macro token list }\6
\&{mp\_node} \|p;\C{ temporary storage }\6
\&{quarterword} \\{sym\_type};\C{ \PB{\\{expr\_sym}}, \PB{\\{suffix\_sym}}, or %
\PB{\\{text\_sym}} }\6
\&{mp\_sym} \\{l\_delim}${},{}$ \\{r\_delim};\C{ matching delimiters }\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
${}\|c\K\\{mp\_general\_macro};{}$\6
${}\\{mp\_link}(\\{mp}\MG\\{hold\_head})\K\NULL;{}$\6
${}\|q\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_ref\_count}(\|q,\39\T{0});{}$\6
${}\|r\K\NULL{}$;\C{ Scan the token or variable to be defined;     set \PB{%
\|n}, \PB{\\{scanner\_status}}, and \PB{\\{warning\_info}} }\6
\&{if} ${}(\|m\E\\{start\_def}){}$\5
${}\{{}$\1\6
\\{mp\_get\_clear\_symbol}(\\{mp});\6
${}\\{mp}\MG\\{warning\_info}\K\\{cur\_sym}(\,);{}$\6
\\{get\_t\_next}(\\{mp});\6
${}\\{mp}\MG\\{scanner\_status}\K\\{op\_defining};{}$\6
${}\|n\K\T{0};{}$\6
${}\\{set\_eq\_type}(\\{mp}\MG\\{warning\_info},\39\\{mp\_defined\_macro});{}$\6
${}\\{set\_equiv\_node}(\\{mp}\MG\\{warning\_info},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ var\_def }\1\6
${}\|p\K\\{mp\_scan\_declared\_variable}(\\{mp});{}$\6
${}\\{mp\_flush\_variable}(\\{mp},\39\\{equiv\_node}(\\{mp\_sym\_sym}(\|p)),\39%
\\{mp\_link}(\|p),\39\\{true});{}$\6
${}\\{mp}\MG\\{warning\_info\_node}\K\\{mp\_find\_variable}(\\{mp},\39\|p);{}$\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\\{mp}\MG\\{warning\_info\_node}\E\NULL){}$\5
${}\{{}$\C{ Change to `\.{a bad variable}' }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"After\ `vardef\ a'\ yo}\)\.{u\ can%
\\'t\ say\ `vardef}\)\.{\ a.b'."},\39\.{"So\ I'll\ have\ to\ dis}\)\.{card\
this\ definition}\)\.{."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"This\ variable\ alrea}\)\.{dy\ starts\ with\ a\
mac}\)\.{ro"},\39\\{hlp},\39\\{true});{}$\6
${}\\{mp}\MG\\{warning\_info\_node}\K\\{mp}\MG\\{bad\_vardef};{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{scanner\_status}\K\\{var\_defining};{}$\6
${}\|n\K\T{2};{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_macro\_special}\W\\{cur\_mod}(\,)\E\\{macro%
\_suffix}){}$\5
${}\{{}$\C{ \.{\AT!\#} }\1\6
${}\|n\K\T{3};{}$\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\\{mp}\MG\\{warning\_info\_node})\K(\&{quarterword})(\\{mp%
\_unsuffixed\_macro}-\T{2}+\|n){}$;\C{ \PB{$\\{mp\_suffixed\_macro}\K\\{mp%
\_unsuffixed\_macro}+\T{1}$} }\6
${}\\{set\_value\_node}(\\{mp}\MG\\{warning\_info\_node},\39\|q);{}$\6
\4${}\}{}$\2\6
${}\|k\K\|n;{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_delimiter}){}$\5
${}\{{}$\C{ Absorb delimited parameters, putting them into lists \PB{\|q} and %
\PB{\|r} }\1\6
\&{do}\5
${}\{{}$\1\6
${}\\{l\_delim}\K\\{cur\_sym}(\,);{}$\6
${}\\{r\_delim}\K\\{equiv\_sym}(\\{cur\_sym}(\,));{}$\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_param\_type})\W(\\{cur\_mod}(\,)\E\\{mp%
\_expr\_param})){}$\5
${}\{{}$\1\6
${}\\{sym\_type}\K\\{mp\_expr\_sym};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_param\_type})\W(\\{cur\_mod}(\,)%
\E\\{mp\_suffix\_param})){}$\5
${}\{{}$\1\6
${}\\{sym\_type}\K\\{mp\_suffix\_sym};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_param\_type})\W(\\{cur\_mod}(\,)%
\E\\{mp\_text\_param})){}$\5
${}\{{}$\1\6
${}\\{sym\_type}\K\\{mp\_text\_sym};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You\ should've\ had\ `}\)\.{expr'\
or\ `suffix'\ or}\)\.{\ `text'\ here."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ parameter\ t}\)\.{ype;\ `expr'\
will\ be\ }\)\.{assumed"},\39\\{hlp},\39\\{true});{}$\6
${}\\{sym\_type}\K\\{mp\_expr\_sym};{}$\6
\4${}\}{}$\C{ Absorb parameter tokens for type \PB{\\{sym\_type}} }\2\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_link}(\|q)\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\\{mp\_name\_type}(\|q)\K\\{sym\_type};{}$\6
${}\\{set\_mp\_sym\_info}(\|q,\39\|k);{}$\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{rp}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\\{rp}\MG\\{link}\K\NULL;{}$\6
${}\\{rp}\MG\\{value\_data}\K\|k;{}$\6
${}\\{rp}\MG\\{value\_mod}\K\\{sym\_type};{}$\6
${}\\{rp}\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\\{rp}\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\\{mp\_check\_param\_size}(\\{mp},\39\|k);{}$\6
\\{incr}(\|k);\6
${}\\{rp}\MG\\{link}\K\|r;{}$\6
${}\|r\K\\{rp};{}$\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
${}\\{mp\_check\_delimiter}(\\{mp},\39\\{l\_delim},\39\\{r\_delim});{}$\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_delimiter});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_param\_type}){}$\5
${}\{{}$\C{ Absorb undelimited parameters, putting them into list \PB{\|r} }\1\6
${}\\{rp}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\\{rp}\MG\\{link}\K\NULL;{}$\6
${}\\{rp}\MG\\{value\_data}\K\|k;{}$\6
\&{if} ${}(\\{cur\_mod}(\,)\E\\{mp\_expr\_param}){}$\5
${}\{{}$\1\6
${}\\{rp}\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
${}\|c\K\\{mp\_expr\_macro};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\\{mp\_suffix\_param}){}$\5
${}\{{}$\1\6
${}\\{rp}\MG\\{value\_mod}\K\\{mp\_suffix\_sym};{}$\6
${}\|c\K\\{mp\_suffix\_macro};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\\{mp\_text\_param}){}$\5
${}\{{}$\1\6
${}\\{rp}\MG\\{value\_mod}\K\\{mp\_text\_sym};{}$\6
${}\|c\K\\{mp\_text\_macro};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|c\K\\{cur\_mod}(\,);{}$\6
${}\\{rp}\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_check\_param\_size}(\\{mp},\39\|k);{}$\6
\\{incr}(\|k);\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{rp}\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\\{rp}\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\\{rp}\MG\\{link}\K\|r;{}$\6
${}\|r\K\\{rp};{}$\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\|c\E\\{mp\_expr\_macro}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_of\_token}){}$\5
${}\{{}$\1\6
${}\|c\K\\{mp\_of\_macro};{}$\6
${}\\{rp}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\\{rp}\MG\\{link}\K\NULL;{}$\6
${}\\{mp\_check\_param\_size}(\\{mp},\39\|k);{}$\6
${}\\{rp}\MG\\{value\_data}\K\|k;{}$\6
${}\\{rp}\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{rp}\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\\{rp}\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\\{rp}\MG\\{link}\K\|r;{}$\6
${}\|r\K\\{rp};{}$\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_check\_equals}(\\{mp});\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_info}(\|p,\39\|c);{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_macro\_sym};{}$\6
${}\\{mp\_link}(\|q)\K\|p{}$;\C{ Attach the replacement text to the tail of
node \PB{\|p} }\C{ We don't put `\PB{$\\{mp}\MG\\{frozen\_end\_group}$}' into
the replacement text of      a \&{vardef}, because the user may want to
redefine `\.{endgroup}'. }\6
\&{if} ${}(\|m\E\\{start\_def}){}$\5
${}\{{}$\1\6
${}\\{mp\_link}(\|p)\K\\{mp\_scan\_toks}(\\{mp},\39\\{mp\_macro\_def},\39\|r,%
\39\NULL,\39{}$(\&{quarterword}) \|n);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_node} \\{qq}${}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\7
${}\\{set\_mp\_sym\_sym}(\\{qq},\39\\{mp}\MG\\{bg\_loc});{}$\6
${}\\{mp\_link}(\|p)\K\\{qq};{}$\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{mp}\MG\\{eg\_loc});{}$\6
${}\\{mp\_link}(\\{qq})\K\\{mp\_scan\_toks}(\\{mp},\39\\{mp\_macro\_def},\39%
\|r,\39\|p,\39{}$(\&{quarterword}) \|n);\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{warning\_info\_node}\E\\{mp}\MG\\{bad\_vardef}){}$\1\5
${}\\{mp\_flush\_token\_list}(\\{mp},\39\\{value\_node}(\\{mp}\MG\\{bad%
\_vardef}));{}$\2\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{762}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_sym} \\{bg\_loc};\6
\&{mp\_sym} \\{eg\_loc};\C{ hash addresses of `\.{begingroup}' and `%
\.{endgroup}' }\par
\fi

\M{763}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{bad\_vardef}\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\\{mp}\MG\\{bad\_vardef})\K\\{mp\_root};{}$\6
${}\\{set\_value\_sym}(\\{mp}\MG\\{bad\_vardef},\39\\{mp}\MG\\{frozen\_bad%
\_vardef}){}$;\par
\fi

\M{764}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{bad\_vardef}){}$;\par
\fi

\N{1}{765}Expanding the next token.
Only a few command codes \PB{$<$ \\{min\_command}} can possibly be returned by
\PB{\\{get\_t\_next}}; in increasing order, they are
\PB{\\{if\_test}}, \PB{\\{fi\_or\_else}}, \PB{\\{input}}, \PB{\\{iteration}}, %
\PB{\\{repeat\_loop}},
\PB{\\{exit\_test}}, \PB{\\{relax}}, \PB{\\{scan\_tokens}}, \PB{\\{expand%
\_after}}, and \PB{\\{defined\_macro}}.

\MP\ usually gets the next token of input by saying \PB{\\{get\_x\_next}}. This
is
like \PB{\\{get\_t\_next}} except that it keeps getting more tokens until
finding \PB{$\\{cur\_cmd}\G\\{min\_command}$}. In other words, \PB{\\{get\_x%
\_next}} expands
macros and removes conditionals or iterations or input instructions that
might be present.

It follows that \PB{\\{get\_x\_next}} might invoke itself recursively. In fact,
there is massive recursion, since macro expansion can involve the
scanning of arbitrarily complex expressions, which in turn involve
macro expansion and conditionals, etc.

Therefore it's necessary to declare a whole bunch of \PB{\\{forward}}
procedures at this point, and to insert some other procedures
that will be invoked by \PB{\\{get\_x\_next}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_primary}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_scan\_secondary}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_scan\_tertiary}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_scan\_expression}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_scan\_suffix}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_pass\_text}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_conditional}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_start\_input}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_begin\_iteration}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_resume\_iteration}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_stop\_iteration}(\&{MP} \\{mp});\par
\fi

\M{766}A recursion depth counter is used to discover infinite recursions.
(Near) infinite recursion is a problem because it translates into
C function calls that eat up the available call stack. A better solution
would be to depend on signal trapping, but that is problematic when
Metapost is used as a library.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{expand\_depth\_count};\C{ current expansion depth }\6
\&{int} \\{expand\_depth};\C{ current expansion depth }\par
\fi

\M{767}The limit is set at \PB{\T{10000}}, which should be enough to allow
normal usages of metapost while preventing the most obvious
crashes on most all operating systems, but the value can be
raised if the runtime system allows a larger C stack.

\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{expand\_depth}\K\T{10000}{}$;\par
\fi

\M{768}Even better would be if the system allows discovery of the amount of
space available on the call stack.

In any case, when the limit is crossed, that is a fatal error.

\Y\B\4\D$\\{check\_expansion\_depth}()$ \5
\&{if} ${}(\PP\\{mp}\MG\\{expand\_depth\_count}\G\\{mp}\MG\\{expand\_depth})$ %
\\{mp\_expansion\_depth\_error}(\\{mp})\par
\Y\B\&{static} \&{void} \\{mp\_expansion\_depth\_error}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Recursive\ macro\ exp}\)\.{ansion\
cannot\ be\ unl}\)\.{imited\ because\ of\ ru}\)\.{ntime"},\39\.{"stack\
constraints.\ }\)\.{The\ limit\ is\ 10000\ r}\)\.{ecursion\ levels\ in\ t}\)%
\.{otal."},\39\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode}{}$;\C{ no more interaction }%
\2\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\.{"Maximum\ expansion\ d}\)\.{epth\ reached"},\39%
\\{hlp},\39\\{true});{}$\2\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{769}An auxiliary subroutine called \PB{\\{expand}} is used by \PB{\\{get\_x%
\_next}}
when it has to do exotic expansion commands.

\Y\B\&{static} \&{void} \\{mp\_expand}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|k;\C{ something that we hope is \PB{$\Z$ \\{buf\_size}} }\6
\&{size\_t} \|j;\C{ index into \PB{\\{str\_pool}} }\7
\\{check\_expansion\_depth}(\,);\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{unity\_t})){}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_defined\_macro}){}$\1\5
\\{show\_cur\_cmd\_mod};\2\2\6
\&{switch} (\\{cur\_cmd}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_if\_test}:\5
\\{mp\_conditional}(\\{mp});\C{ this procedure is discussed in Part 36 below }\6
\&{break};\6
\4\&{case} \\{mp\_fi\_or\_else}:\5
\X820:Terminate the current conditional and skip to \&{fi}\X;\6
\&{break};\6
\4\&{case} \\{mp\_input}:\5
\X773:Initiate or terminate input from a file\X;\6
\&{break};\6
\4\&{case} \\{mp\_iteration}:\6
\&{if} ${}(\\{cur\_mod}(\,)\E\\{end\_for}){}$\5
${}\{{}$\1\6
\X770:Scold the user for having an extra \&{endfor}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_begin\_iteration}(\\{mp});\C{ this procedure is discussed in Part 37
below }\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_repeat\_loop}:\5
\X774:Repeat a loop\X;\6
\&{break};\6
\4\&{case} \\{mp\_exit\_test}:\5
\X775:Exit a loop if the proper time has come\X;\6
\&{break};\6
\4\&{case} \\{mp\_relax}:\5
\&{break};\6
\4\&{case} \\{mp\_expand\_after}:\5
\X777:Expand the token after the next token\X;\6
\&{break};\6
\4\&{case} \\{mp\_scan\_tokens}:\5
\X778:Put a string into the input buffer\X;\6
\&{break};\6
\4\&{case} \\{mp\_defined\_macro}:\5
${}\\{mp\_macro\_call}(\\{mp},\39\\{cur\_mod\_node}(\,),\39\NULL,\39\\{cur%
\_sym}(\,));{}$\6
\&{break};\6
\4\&{default}:\5
\&{break};\C{ make the compiler happy }\6
\4${}\}{}$\2\6
;\C{ there are no other cases }\6
${}\\{mp}\MG\\{expand\_depth\_count}\MM;{}$\6
\4${}\}{}$\2\par
\fi

\M{770}\B\X770:Scold the user for having an extra \&{endfor}\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ not\ currently\ w}\)\.{orking\
on\ a\ for\ loop}\)\.{,"},\39\.{"so\ I\ had\ better\ not}\)\.{\ try\ to\ end\
anything}\)\.{."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ `endfor'"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\par
\U769.\fi

\M{771}The processing of \&{input} involves the \PB{\\{start\_input}}
subroutine,
which will be declared later; the processing of \&{endinput} is trivial.

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"input"},\39\\{mp\_input},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"endinput"},\39\\{mp\_input},\39\T{1}){}$;\par
\fi

\M{772}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_input}:\6
\&{if} ${}(\|m\E\T{0}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"input"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"endinput"});{}$\2\6
\&{break};\par
\fi

\M{773}\B\X773:Initiate or terminate input from a file\X${}\E{}$\6
\&{if} ${}(\\{cur\_mod}(\,)>\T{0}){}$\1\5
${}\\{mp}\MG\\{force\_eof}\K\\{true};{}$\2\6
\&{else} \\{mp\_start\_input}(\\{mp})\par
\U769.\fi

\M{774}We'll discuss the complicated parts of loop operations later. For now
it suffices to know that there's a global variable called \PB{\\{loop\_ptr}}
that will be \PB{$\NULL$} if no loop is in progress.

\Y\B\4\X774:Repeat a loop\X${}\E{}$\6
${}\{{}$\1\6
\&{while} ${}(\\{token\_state}\W(\\{nloc}\E\NULL)){}$\1\5
\\{mp\_end\_token\_list}(\\{mp});\C{ conserve stack space }\2\6
\&{if} ${}(\\{mp}\MG\\{loop\_ptr}\E\NULL){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ confused;\ after}\)\.{\
exiting\ from\ a\ loop}\)\.{,\ I\ still\ seem"},\39\.{"to\ want\ to\ repeat\ i}%
\)\.{t.\ I'll\ try\ to\ forge}\)\.{t\ the\ problem."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Lost\ loop"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_resume\_iteration}(\\{mp});\C{ this procedure is in Part 37 below }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U769.\fi

\M{775}\B\X775:Exit a loop if the proper time has come\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_get\_boolean}(\\{mp});\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{unity\_t})){}$\1\5
${}\\{mp\_show\_cmd\_mod}(\\{mp},\39\\{mp\_nullary},\39\\{cur\_exp\_value%
\_boolean}(\,));{}$\2\6
\&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_true\_code}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{loop\_ptr}\E\NULL){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Why\ say\ `exitif'\ wh}\)\.{en\
there's\ nothing\ t}\)\.{o\ exit\ from?"},\39\NULL\};{}$\7
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_semicolon}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\.{"No\ loop\ is\ in\ progr}\)\.{ess"},\39\\{hlp},%
\39\\{true});{}$\2\6
\&{else}\1\5
${}\\{mp\_back\_error}(\\{mp},\39\.{"No\ loop\ is\ in\ progr}\)\.{ess"},\39%
\\{hlp},\39\\{true});{}$\2\6
;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X776:Exit prematurely from an iteration\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_semicolon}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"After\ `exitif\ <bool}\)\.{ean\
exp>'\ I\ expect\ t}\)\.{o\ see\ a\ semicolon."},\39\.{"I\ shall\ pretend\ tha}%
\)\.{t\ one\ was\ there."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `;'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U769.\fi

\M{776}Here we use the fact that \PB{\\{forever\_text}} is the only \PB{%
\\{token\_type}} that
is less than \PB{\\{loop\_text}}.

\Y\B\4\X776:Exit prematurely from an iteration\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\NULL;{}$\7
\&{do}\5
${}\{{}$\1\6
\&{if} (\\{file\_state})\5
${}\{{}$\1\6
\\{mp\_end\_file\_reading}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{token\_type}\Z\\{loop\_text}){}$\1\5
${}\|p\K\\{nstart};{}$\2\6
\\{mp\_end\_token\_list}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\E\NULL);{}$\6
\&{if} ${}(\|p\I\\{mp}\MG\\{loop\_ptr}\MG\\{info}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"***\ (loop\ confusion}\)\.{)"});{}$\2\6
;\6
\\{mp\_stop\_iteration}(\\{mp});\C{ this procedure is in Part 34 below }\6
\4${}\}{}$\2\par
\U775.\fi

\M{777}\B\X777:Expand the token after the next token\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \|p;\7
\\{get\_t\_next}(\\{mp});\6
${}\|p\K\\{mp\_cur\_tok}(\\{mp});{}$\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_min\_command}){}$\1\5
\\{mp\_expand}(\\{mp});\2\6
\&{else}\1\5
\\{mp\_back\_input}(\\{mp});\2\6
\\{back\_list}(\|p);\6
\4${}\}{}$\2\par
\U769.\fi

\M{778}\B\X778:Put a string into the input buffer\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ going\ to\ flush\ }\)\.{this\
expression,\ sin}\)\.{ce"},\39\.{"scantokens\ should\ b}\)\.{e\ followed\ by\ a%
\ know}\)\.{n\ string."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ string"},\39\\{hlp},\39%
\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}>\T{0}){}$\1\5
\X779:Pretend we're reading a new one-line file\X;\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U769.\fi

\M{779}\B\X779:Pretend we're reading a new one-line file\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_begin\_file\_reading}(\\{mp});\6
${}\\{name}\K\\{is\_scantok};{}$\6
${}\|k\K\\{mp}\MG\\{first}+{}$(\&{size\_t}) \\{cur\_exp\_str}(\,)${}\MG%
\\{len};{}$\6
\&{if} ${}(\|k\G\\{mp}\MG\\{max\_buf\_stack}){}$\5
${}\{{}$\1\6
\&{while} ${}(\|k\G\\{mp}\MG\\{buf\_size}){}$\5
${}\{{}$\1\6
${}\\{mp\_reallocate\_buffer}(\\{mp},\39(\\{mp}\MG\\{buf\_size}+(\\{mp}\MG%
\\{buf\_size}/\T{4})));{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{max\_buf\_stack}\K\|k+\T{1};{}$\6
\4${}\}{}$\2\6
${}\|j\K\T{0};{}$\6
${}\\{limit}\K{}$(\&{halfword}) \|k;\6
\&{while} ${}(\\{mp}\MG\\{first}<{}$(\&{size\_t}) \\{limit})\5
${}\{{}$\1\6
${}\\{mp}\MG\\{buffer}[\\{mp}\MG\\{first}]\K{*}(\\{cur\_exp\_str}(\,)\MG%
\\{str}+\|j);{}$\6
${}\|j\PP;{}$\6
${}\\{incr}(\\{mp}\MG\\{first});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\U778.\fi

\M{780}Here finally is \PB{\\{get\_x\_next}}.

The expression scanning routines to be considered later
communicate via the global quantities \PB{\\{cur\_type}} and \PB{\\{cur\_exp}};
we must be very careful to save and restore these quantities while
macros are being expanded.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_get\_x\_next}(\&{MP} \\{mp});\par
\fi

\M{781}\B\&{void} \\{mp\_get\_x\_next}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{save\_exp};\C{ a capsule to save \PB{\\{cur\_type}} and \PB{%
\\{cur\_exp}} }\7
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_min\_command}){}$\5
${}\{{}$\1\6
${}\\{save\_exp}\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_defined\_macro}){}$\1\5
${}\\{mp\_macro\_call}(\\{mp},\39\\{cur\_mod\_node}(\,),\39\NULL,\39\\{cur%
\_sym}(\,));{}$\2\6
\&{else}\1\5
\\{mp\_expand}(\\{mp});\2\6
\\{get\_t\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)<\\{mp\_min\_command});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\\{save\_exp}){}$;\C{ that restores \PB{%
\\{cur\_type}} and \PB{\\{cur\_exp}} }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{782}Now let's consider the \PB{\\{macro\_call}} procedure, which is used to
start up
all user-defined macros. Since the arguments to a macro might be expressions,
\PB{\\{macro\_call}} is recursive.

The first parameter to \PB{\\{macro\_call}} points to the reference count of
the
token list that defines the macro. The second parameter contains any
arguments that have already been parsed (see below).  The third parameter
points to the symbolic token that names the macro. If the third parameter
is \PB{$\NULL$}, the macro was defined by \&{vardef}, so its name can be
reconstructed from the prefix and ``at'' arguments found within the
second parameter.

What is this second parameter? It's simply a linked list of symbolic items,
whose \PB{\\{info}} fields point to the arguments. In other words, if \PB{$%
\\{arg\_list}\K\NULL$},
no arguments have been scanned yet; otherwise \PB{\\{mp\_info}(\\{arg\_list})}
points to
the first scanned argument, and \PB{\\{mp\_link}(\\{arg\_list})} points to the
list of
further arguments (if any).

Arguments of type \&{expr} are so-called capsules, which we will
discuss later when we concentrate on expressions; they can be
recognized easily because their \PB{\\{link}} field is \PB{\&{void}}. Arguments
of type
\&{suffix} and \&{text} are token lists without reference counts.

\fi

\M{783}After argument scanning is complete, the arguments are moved to the
\PB{\\{param\_stack}}. (They can't be put on that stack any sooner, because
the stack is growing and shrinking in unpredictable ways as more arguments
are being acquired.)  Then the macro body is fed to the scanner; i.e.,
the replacement text of the macro is placed at the top of the \MP's
input stack, so that \PB{\\{get\_t\_next}} will proceed to read it next.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_macro\_call}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\\{def\_ref}${},\39{}$\&{mp\_node} \\{arg\_list}${},\39{}$\&{mp\_sym} \\{macro%
\_name});\par
\fi

\M{784}\B\&{void} \\{mp\_macro\_call}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\\{def\_ref}${},\39{}$\&{mp\_node} \\{arg\_list}${},\39{}$\&{mp\_sym} \\{macro%
\_name})\1\1\2\2\6
${}\{{}$\C{ invokes a user-defined control sequence }\1\6
\&{mp\_node} \|r;\C{ current node in the macro's token list }\6
\&{mp\_node} \|p${},{}$ \|q;\C{ for list manipulation }\6
\&{integer} \|n;\C{ the number of arguments }\6
\&{mp\_node} \\{tail}${}\K\T{0}{}$;\C{ tail of the argument list }\6
\&{mp\_sym} \\{l\_delim}${}\K\NULL,{}$ \\{r\_delim}${}\K\NULL{}$;\C{ a
delimiter pair }\7
${}\|r\K\\{mp\_link}(\\{def\_ref});{}$\6
\\{add\_mac\_ref}(\\{def\_ref});\6
\&{if} ${}(\\{arg\_list}\E\NULL){}$\5
${}\{{}$\1\6
${}\|n\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X790:Determine the number \PB{\|n} of arguments already supplied, and set \PB{%
\\{tail}} to the tail of \PB{\\{arg\_list}}\X;\6
\4${}\}{}$\2\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_macros})))\5
${}\{{}$\1\6
\X785:Show the text of the macro being expanded, and the existing arguments\X;\6
\4${}\}{}$\2\6
\X791:Scan the remaining arguments, if any; set \PB{\|r} to the first token of
the replacement text\X;\6
\X803:Feed the arguments and replacement text to the scanner\X;\6
\4${}\}{}$\2\par
\fi

\M{785}\B\X785:Show the text of the macro being expanded, and the existing
arguments\X${}\E{}$\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_print\_macro\_name}(\\{mp},\39\\{arg\_list},\39\\{macro\_name});{}$\6
\&{if} ${}(\|n\E\T{3}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"@\#"}){}$;\C{ indicate a suffixed macro }\2\6
${}\\{mp\_show\_macro}(\\{mp},\39\\{def\_ref},\39\NULL,\39\T{100000});{}$\6
\&{if} ${}(\\{arg\_list}\I\NULL){}$\5
${}\{{}$\1\6
${}\|n\K\T{0};{}$\6
${}\|p\K\\{arg\_list};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|p);\6
${}\\{mp\_print\_arg}(\\{mp},\39\|q,\39\|n,\39\T{0},\39\T{0});{}$\6
\\{incr}(\|n);\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\NULL);{}$\6
\4${}\}{}$\2\6
$\\{mp\_end\_diagnostic}(\\{mp},\39\\{false}{}$)\par
\U784.\fi

\M{786}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_macro\_name}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|a${},\39{}$\&{mp\_sym} \|n);\par
\fi

\M{787}\B\&{void} \\{mp\_print\_macro\_name}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|a${},\39{}$\&{mp\_sym} \|n)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ they traverse the first part of \PB{\|a} }\7
\&{if} ${}(\|n\I\NULL){}$\5
${}\{{}$\1\6
\\{mp\_print\_text}(\|n);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|a);\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
\\{mp\_print\_text}(\\{mp\_sym\_sym}((\&{mp\_node}) \\{mp\_sym\_sym}(\\{mp%
\_link}(\|a))));\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
\&{while} ${}(\\{mp\_link}(\|q)\I\NULL){}$\1\5
${}\|q\K\\{mp\_link}(\|q);{}$\2\6
${}\\{mp\_link}(\|q)\K{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\\{mp\_link}(\|a));\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\|p,\39\NULL,\39\T{1000},\39\T{0});{}$\6
${}\\{mp\_link}(\|q)\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{788}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_arg}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|q${},\39{}$\&{integer} \|n${},\39{}$\&{halfword} \|b${},\39{}$\&{quarterword}
\\{bb});\par
\fi

\M{789}\B\&{void} \\{mp\_print\_arg}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|q${},\39{}$\&{integer} \|n${},\39{}$\&{halfword} \|b${},\39{}$\&{quarterword}
\\{bb})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|q\W\\{mp\_link}(\|q)\E\.{MP\_VOID}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(EXPR"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}((\\{bb}<\\{mp\_text\_sym})\W(\|b\I\\{mp\_text\_macro})){}$\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(SUFFIX"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(TEXT"});{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_print\_int}(\\{mp},\39\|n);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{")<-"});{}$\6
\&{if} ${}(\|q\W\\{mp\_link}(\|q)\E\.{MP\_VOID}){}$\1\5
${}\\{mp\_print\_exp}(\\{mp},\39\|q,\39\T{1});{}$\2\6
\&{else}\1\5
${}\\{mp\_show\_token\_list}(\\{mp},\39\|q,\39\NULL,\39\T{1000},\39\T{0});{}$\2%
\6
\4${}\}{}$\2\par
\fi

\M{790}\B\X790:Determine the number \PB{\|n} of arguments already supplied, and
set \PB{\\{tail}} to the tail of \PB{\\{arg\_list}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|n\K\T{1};{}$\6
${}\\{tail}\K\\{arg\_list};{}$\6
\&{while} ${}(\\{mp\_link}(\\{tail})\I\NULL){}$\5
${}\{{}$\1\6
\\{incr}(\|n);\6
${}\\{tail}\K\\{mp\_link}(\\{tail});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U784.\fi

\M{791}\B\X791:Scan the remaining arguments, if any; set \PB{\|r} to the first
token of the replacement text\X${}\E{}$\6
$\\{set\_cur\_cmd}(\\{mp\_comma}+\T{1}){}$;\C{ anything \PB{$\MRL{{<}{>}}$ %
\\{comma}} will do }\6
\&{while} ${}(\\{mp\_name\_type}(\|r)\E\\{mp\_expr\_sym}\V\\{mp\_name\_type}(%
\|r)\E\\{mp\_suffix\_sym}\V\\{mp\_name\_type}(\|r)\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
\X792:Scan the delimited argument represented by \PB{\\{mp\_sym\_info}(\|r)}\X;%
\6
${}\|r\K\\{mp\_link}(\|r);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ going\ to\ assume}\)\.{\ that\
the\ comma\ I\ ju}\)\.{st\ read\ was\ a"},\39\.{"right\ delimiter,\ an}\)\.{d\
then\ I'll\ begin\ ex}\)\.{panding\ the\ macro."},\39\.{"You\ might\ want\ to\
d}\)\.{elete\ some\ tokens\ be}\)\.{fore\ continuing."},\39\NULL\};{}$\6
\&{mp\_string} \\{rname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_macro\_name}(\\{mp},\39\\{arg\_list},\39\\{macro\_name});{}$\6
${}\\{rname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Too\ many\ arguments\ }\)\.{to\ %
\%s;\ Missing\ `\%s'\ }\)\.{has\ been\ inserted"},\39\\{mp\_str}(\\{mp},\39%
\\{rname}),\39\\{mp\_str}(\\{mp},\39\\{text}(\\{r\_delim})));{}$\6
\\{delete\_str\_ref}(\\{rname});\6
;\6
;\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_sym\_info}(\|r)\I\\{mp\_general\_macro}){}$\5
${}\{{}$\1\6
\X800:Scan undelimited argument(s)\X;\6
\4${}\}{}$\2\6
$\|r\K\\{mp\_link}{}$(\|r)\par
\U784.\fi

\M{792}At this point, the reader will find it advisable to review the
explanation
of token list format that was presented earlier, paying special attention to
the conventions that apply only at the beginning of a macro's token list.

On the other hand, the reader will have to take the expression-parsing
aspects of the following program on faith; we will explain \PB{\\{cur\_type}}
and \PB{\\{cur\_exp}} later. (Several things in this program depend on each
other,
and it's necessary to jump into the circle somewhere.)

\Y\B\4\X792:Scan the delimited argument represented by \PB{\\{mp\_sym\_info}(%
\|r)}\X${}\E{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_left\_delimiter}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"That\ macro\ has\ more}\)\.{\
parameters\ than\ you}\)\.{\ thought."},\39\.{"I'll\ continue\ by\ pr}\)%
\.{etending\ that\ each\ m}\)\.{issing\ argument"},\39\.{"is\ either\ zero\ or\
n}\)\.{ull."},\39\NULL\};{}$\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_macro\_name}(\\{mp},\39\\{arg\_list},\39\\{macro\_name});{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ argument\ to}\)\.{\ %
\%s"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
;\6
\\{delete\_str\_ref}(\\{sname});\6
\&{if} ${}(\\{mp\_name\_type}(\|r)\E\\{mp\_suffix\_sym}\V\\{mp\_name\_type}(%
\|r)\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
\\{set\_cur\_exp\_value\_number}(\\{zero\_t});\C{ todo: this was \PB{\\{null}}
}\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_token\_list};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_exp\_value\_number}(\\{zero\_t});\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_right\_delimiter});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
${}\\{l\_delim}\K\\{cur\_sym}(\,);{}$\6
${}\\{r\_delim}\K\\{equiv\_sym}(\\{cur\_sym}(\,));{}$\6
\4${}\}{}$\2\6
\X795:Scan the argument represented by \PB{\\{mp\_sym\_info}(\|r)}\X;\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\1\5
\X793:Check that the proper right delimiter was present\X;\2\6
\.{FOUND}: \X794:Append the current expression to \PB{\\{arg\_list}}\X\par
\U791.\fi

\M{793}\B\X793:Check that the proper right delimiter was present\X${}\E{}$\6
\&{if} ${}((\\{cur\_cmd}(\,)\I\\{mp\_right\_delimiter})\V(\\{equiv\_sym}(\\{cur%
\_sym}(\,))\I\\{l\_delim})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_name\_type}(\\{mp\_link}(\|r))\E\\{mp\_expr\_sym}\V\\{mp%
\_name\_type}(\\{mp\_link}(\|r))\E\\{mp\_suffix\_sym}\V\\{mp\_name\_type}(\\{mp%
\_link}(\|r))\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ finished\ readi}\)\.{ng\ a\
macro\ argument\ }\)\.{and\ am\ about\ to"},\39\.{"read\ another;\ the\ a}\)%
\.{rguments\ weren't\ del}\)\.{imited\ correctly."},\39\.{"You\ might\ want\ to%
\ d}\)\.{elete\ some\ tokens\ be}\)\.{fore\ continuing."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `,'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_comma});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ gotten\ to\ the\ }\)\.{end\
of\ the\ macro\ par}\)\.{ameter\ list."},\39\.{"You\ might\ want\ to\ d}\)%
\.{elete\ some\ tokens\ be}\)\.{fore\ continuing."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ `\%s'\ has\ be}\)\.{en\
inserted"},\39\\{mp\_str}(\\{mp},\39\\{text}(\\{r\_delim})));{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U792.\fi

\M{794}A \&{suffix} or \&{text} parameter will have been scanned as
a token list pointed to by \PB{\\{cur\_exp}}, in which case we will have
\PB{$\\{cur\_type}\K\\{token\_list}$}.

\Y\B\4\X794:Append the current expression to \PB{\\{arg\_list}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_token\_list}){}$\1\5
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{mp}\MG\\{cur\_exp}.\\{data}.\\{node});{}$\2\6
\&{else}\1\5
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{mp\_stash\_cur\_exp}(\\{mp}));{}$\2\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_macros})))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_arg}(\\{mp},\39{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|p)${},\39%
\|n,\39\\{mp\_sym\_info}(\|r),\39\\{mp\_name\_type}(\|r));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{arg\_list}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{arg\_list}\K\|p;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_link}(\\{tail})\K\|p;{}$\6
\4${}\}{}$\2\6
${}\\{tail}\K\|p;{}$\6
\\{incr}(\|n);\6
\4${}\}{}$\2\par
\Us792\ET800.\fi

\M{795}\B\X795:Scan the argument represented by \PB{\\{mp\_sym\_info}(\|r)}%
\X${}\E{}$\6
\&{if} ${}(\\{mp\_name\_type}(\|r)\E\\{mp\_text\_sym}){}$\5
${}\{{}$\1\6
${}\\{mp\_scan\_text\_arg}(\\{mp},\39\\{l\_delim},\39\\{r\_delim});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{mp\_name\_type}(\|r)\E\\{mp\_suffix\_sym}){}$\1\5
\\{mp\_scan\_suffix}(\\{mp});\2\6
\&{else}\1\5
\\{mp\_scan\_expression}(\\{mp});\2\6
\4${}\}{}$\2\par
\U792.\fi

\M{796}The parameters to \PB{\\{scan\_text\_arg}} are either a pair of
delimiters
or zero; the latter case is for undelimited text arguments, which
end with the first semicolon or \&{endgroup} or \&{end} that is not
contained in a group.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_text\_arg}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\\{l\_delim}${},\39{}$\&{mp\_sym} \\{r\_delim});\par
\fi

\M{797}\B\&{void} \\{mp\_scan\_text\_arg}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\\{l\_delim}${},\39{}$\&{mp\_sym} \\{r\_delim})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \\{balance};\C{ excess of \PB{\\{l\_delim}} over \PB{\\{r\_delim}}
}\6
\&{mp\_node} \|p;\C{ list tail }\7
${}\\{mp}\MG\\{warning\_info}\K\\{l\_delim};{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{absorbing};{}$\6
${}\|p\K\\{mp}\MG\\{hold\_head};{}$\6
${}\\{balance}\K\T{1};{}$\6
${}\\{mp\_link}(\\{mp}\MG\\{hold\_head})\K\NULL;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{l\_delim}\E\NULL){}$\5
${}\{{}$\1\6
\X799:Adjust the balance for an undelimited argument; \PB{\&{break}} if done\X;%
\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X798:Adjust the balance for a delimited argument; \PB{\&{break}} if done\X;\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|p)\K\\{mp\_cur\_tok}(\\{mp});{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
${}\\{set\_cur\_exp\_node}(\\{mp\_link}(\\{mp}\MG\\{hold\_head}));{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_token\_list};{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\4${}\}{}$\2\par
\fi

\M{798}\B\X798:Adjust the balance for a delimited argument; \PB{\&{break}} if
done\X${}\E{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_right\_delimiter}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{equiv\_sym}(\\{cur\_sym}(\,))\E\\{l\_delim}){}$\5
${}\{{}$\1\6
\\{decr}(\\{balance});\6
\&{if} ${}(\\{balance}\E\T{0}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_delimiter}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{equiv\_sym}(\\{cur\_sym}(\,))\E\\{r\_delim}){}$\1\5
\\{incr}(\\{balance});\2\6
\4${}\}{}$\2\par
\U797.\fi

\M{799}\B\X799:Adjust the balance for an undelimited argument; \PB{\&{break}}
if done\X${}\E{}$\6
\&{if} (\\{mp\_end\_of\_statement})\5
${}\{{}$\C{ \PB{$\\{cur\_cmd}\K\\{semicolon}$}, \PB{\\{end\_group}}, or \PB{%
\\{stop}} }\1\6
\&{if} ${}(\\{balance}\E\T{1}){}$\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_end\_group}){}$\1\5
\\{decr}(\\{balance});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_begin\_group}){}$\5
${}\{{}$\1\6
\\{incr}(\\{balance});\6
\4${}\}{}$\2\par
\U797.\fi

\M{800}\B\X800:Scan undelimited argument(s)\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_sym\_info}(\|r)<\\{mp\_text\_macro}){}$\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{mp\_sym\_info}(\|r)\I\\{mp\_suffix\_macro}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_equals})\V(\\{cur\_cmd}(\,)\E\\{mp%
\_assignment})){}$\1\5
\\{mp\_get\_x\_next}(\\{mp});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{switch} (\\{mp\_sym\_info}(\|r))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_primary\_macro}:\5
\\{mp\_scan\_primary}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_secondary\_macro}:\5
\\{mp\_scan\_secondary}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_tertiary\_macro}:\5
\\{mp\_scan\_tertiary}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_expr\_macro}:\5
\\{mp\_scan\_expression}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_of\_macro}:\5
\X801:Scan an expression followed by `\&{of} $\langle$primary$\rangle$'\X;\6
\&{break};\6
\4\&{case} \\{mp\_suffix\_macro}:\5
\X802:Scan a suffix with optional delimiters\X;\6
\&{break};\6
\4\&{case} \\{mp\_text\_macro}:\5
${}\\{mp\_scan\_text\_arg}(\\{mp},\39\NULL,\39\NULL);{}$\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\\{mp\_back\_input}(\\{mp});\6
\X794:Append the current expression to \PB{\\{arg\_list}}\X;\6
\4${}\}{}$\2\par
\U791.\fi

\M{801}\B\X801:Scan an expression followed by `\&{of} $\langle$primary$%
\rangle$'\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_scan\_expression}(\\{mp});\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{mp\_stash\_cur\_exp}(\\{mp}));{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_macros})))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_arg}(\\{mp},\39{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|p)${},\39%
\|n,\39\T{0},\39\T{0});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{arg\_list}\E\NULL){}$\1\5
${}\\{arg\_list}\K\|p;{}$\2\6
\&{else}\1\5
${}\\{mp\_link}(\\{tail})\K\|p;{}$\2\6
${}\\{tail}\K\|p;{}$\6
\\{incr}(\|n);\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_of\_token}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ got\ the\ first\ }\)%
\.{argument;\ will\ look\ }\)\.{now\ for\ the\ other."},\39\NULL\};{}$\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_macro\_name}(\\{mp},\39\\{arg\_list},\39\\{macro\_name});{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ `of'\ has\ be}\)\.{en\
inserted\ for\ \%s"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
\\{delete\_str\_ref}(\\{sname});\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
\4${}\}{}$\2\par
\U800.\fi

\M{802}\B\X802:Scan a suffix with optional delimiters\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_left\_delimiter}){}$\5
${}\{{}$\1\6
${}\\{l\_delim}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{l\_delim}\K\\{cur\_sym}(\,);{}$\6
${}\\{r\_delim}\K\\{equiv\_sym}(\\{cur\_sym}(\,));{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\\{mp\_scan\_suffix}(\\{mp});\6
\&{if} ${}(\\{l\_delim}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{cur\_cmd}(\,)\I\\{mp\_right\_delimiter})\V(\\{equiv\_sym}(\\{cur%
\_sym}(\,))\I\\{l\_delim})){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ gotten\ to\ the\ }\)\.{end\
of\ the\ macro\ par}\)\.{ameter\ list."},\39\.{"You\ might\ want\ to\ d}\)%
\.{elete\ some\ tokens\ be}\)\.{fore\ continuing."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ `\%s'\ has\ be}\)\.{en\
inserted"},\39\\{mp\_str}(\\{mp},\39\\{text}(\\{r\_delim})));{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U800.\fi

\M{803}Before we put a new token list on the input stack, it is wise to clean
off
all token lists that have recently been depleted. Then a user macro that ends
with a call to itself will not require unbounded stack space.

\Y\B\4\X803:Feed the arguments and replacement text to the scanner\X${}\E{}$\6
\&{while} ${}(\\{token\_state}\W(\\{nloc}\E\NULL)){}$\1\5
\\{mp\_end\_token\_list}(\\{mp});\C{ conserve stack space }\2\6
\&{if} ${}(\\{mp}\MG\\{param\_ptr}+\|n>\\{mp}\MG\\{max\_param\_stack}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{max\_param\_stack}\K\\{mp}\MG\\{param\_ptr}+\|n;{}$\6
${}\\{mp\_check\_param\_size}(\\{mp},\39\\{mp}\MG\\{max\_param\_stack});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_begin\_token\_list}(\\{mp},\39\\{def\_ref},\39{}$(\&{quarterword}) %
\\{macro});\6
\&{if} (\\{macro\_name})\1\5
${}\\{name}\K\\{text}(\\{macro\_name});{}$\2\6
\&{else}\1\5
${}\\{name}\K\NULL;{}$\2\6
${}\\{nloc}\K\|r;{}$\6
\&{if} ${}(\|n>\T{0}){}$\5
${}\{{}$\1\6
${}\|p\K\\{arg\_list};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{param\_stack}[\\{mp}\MG\\{param\_ptr}]\K{}$(\&{mp\_node}) \\{mp%
\_sym\_sym}(\|p);\6
${}\\{incr}(\\{mp}\MG\\{param\_ptr});{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\NULL);{}$\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\\{arg\_list});{}$\6
\4${}\}{}$\2\par
\U784.\fi

\M{804}It's sometimes necessary to put a single argument onto \PB{\\{param%
\_stack}}.
The \PB{\\{stack\_argument}} subroutine does this.

\Y\B\&{static} \&{void} \\{mp\_stack\_argument}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{param\_ptr}\E\\{mp}\MG\\{max\_param\_stack}){}$\5
${}\{{}$\1\6
${}\\{incr}(\\{mp}\MG\\{max\_param\_stack});{}$\6
${}\\{mp\_check\_param\_size}(\\{mp},\39\\{mp}\MG\\{max\_param\_stack});{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{param\_stack}[\\{mp}\MG\\{param\_ptr}]\K\|p;{}$\6
${}\\{incr}(\\{mp}\MG\\{param\_ptr});{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{805}Conditional processing.
Let's consider now the way \&{if} commands are handled.

Conditions can be inside conditions, and this nesting has a stack
that is independent of other stacks.
Four global variables represent the top of the condition stack:
\PB{\\{cond\_ptr}} points to pushed-down entries, if~any; \PB{\\{cur\_if}}
tells whether
we are processing \&{if} or \&{elseif}; \PB{\\{if\_limit}} specifies
the largest code of a \PB{\\{fi\_or\_else}} command that is syntactically
legal;
and \PB{\\{if\_line}} is the line number at which the current conditional
began.

If no conditions are currently in progress, the condition stack has the
special state \PB{$\\{cond\_ptr}\K\NULL$}, \PB{$\\{if\_limit}\K\\{normal}$}, %
\PB{$\\{cur\_if}\K\T{0}$}, \PB{$\\{if\_line}\K\T{0}$}.
Otherwise \PB{\\{cond\_ptr}} points to a non-symbolic node; the \PB{\\{type}}, %
\PB{\\{name\_type}}, and
\PB{\\{link}} fields of the first word contain \PB{\\{if\_limit}}, \PB{\\{cur%
\_if}}, and
\PB{\\{cond\_ptr}} at the next level, and the second word contains the
corresponding \PB{\\{if\_line}}.

\Y\B\4\D$\\{if\_line\_field}(\|A)$ \5
$((\\{mp\_if\_node})(\|A))\MG{}$\\{if\_line\_field\_}\par
\B\4\D$\\{if\_code}$ \5
\T{1}\C{ code for \&{if} being evaluated }\par
\B\4\D$\\{fi\_code}$ \5
\T{2}\C{ code for \&{fi} }\par
\B\4\D$\\{else\_code}$ \5
\T{3}\C{ code for \&{else} }\par
\B\4\D$\\{else\_if\_code}$ \5
\T{4}\C{ code for \&{elseif} }\par
\Y\B\4\X6:MPlib internal header stuff\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_if\_node\_data} ${}\{{}$\1\6
\.{NODE\_BODY};\7
\&{int} \\{if\_line\_field\_};\2\6
${}\}{}$ \&{mp\_if\_node\_data};\6
\&{typedef} \&{struct} \&{mp\_if\_node\_data} ${}{*}\&{mp\_if\_node}{}$;\par
\fi

\M{806}
\Y\B\4\D$\\{if\_node\_size}$ \5
\&{sizeof}(\&{struct} \&{mp\_if\_node\_data})\C{ number of words in stack entry
for conditionals }\par
\Y\B\&{static} \&{mp\_node} \\{mp\_get\_if\_node}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_if\_node} \|p${}\K{}$(\&{mp\_if\_node}) \\{malloc\_node}(\\{if\_node%
\_size});\7
${}\\{mp\_type}(\|p)\K\\{mp\_if\_node\_type};{}$\6
\&{return} (\&{mp\_node}) \|p;\6
\4${}\}{}$\2\par
\fi

\M{807}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} \\{cond\_ptr};\C{ top of the condition stack }\6
\&{integer} \\{if\_limit};\C{ upper bound on \PB{\\{fi\_or\_else}} codes }\6
\&{quarterword} \\{cur\_if};\C{ type of conditional being worked on }\6
\&{integer} \\{if\_line};\C{ line where that conditional began }\par
\fi

\M{808}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{cond\_ptr}\K\NULL;{}$\6
${}\\{mp}\MG\\{if\_limit}\K\\{normal};{}$\6
${}\\{mp}\MG\\{cur\_if}\K\T{0};{}$\6
${}\\{mp}\MG\\{if\_line}\K\T{0}{}$;\par
\fi

\M{809}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"if"},\39\\{mp\_if\_test},\39\\{if\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fi"},\39\\{mp\_fi\_or\_else},\39\\{fi%
\_code});{}$\6
${}\\{mp}\MG\\{frozen\_fi}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"fi"},\39%
\\{mp\_fi\_or\_else},\39\\{fi\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"else"},\39\\{mp\_fi\_or\_else},\39\\{else%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"elseif"},\39\\{mp\_fi\_or\_else},\39\\{else%
\_if\_code}){}$;\par
\fi

\M{810}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_if\_test}:\5
\&{case} \\{mp\_fi\_or\_else}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{if\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"if"});{}$\6
\&{break};\6
\4\&{case} \\{fi\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"fi"});{}$\6
\&{break};\6
\4\&{case} \\{else\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"else"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"elseif"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{811}Here is a procedure that ignores text until coming to an \&{elseif},
\&{else}, or \&{fi} at level zero of $\&{if}\ldots\&{fi}$
nesting. After it has acted, \PB{\\{cur\_mod}} will indicate the token that
was found.

\MP's smallest two command codes are \PB{\\{if\_test}} and \PB{\\{fi\_or%
\_else}}; this
makes the skipping process a bit simpler.

\Y\B\&{void} \\{mp\_pass\_text}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \|l${}\K\T{0};{}$\7
${}\\{mp}\MG\\{scanner\_status}\K\\{skipping};{}$\6
${}\\{mp}\MG\\{warning\_line}\K\\{mp\_true\_line}(\\{mp});{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_fi\_or\_else}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_fi\_or\_else}){}$\5
${}\{{}$\1\6
\\{incr}(\|l);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|l\E\T{0}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{cur\_mod}(\,)\E\\{fi\_code}){}$\1\5
\\{decr}(\|l);\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X812:Decrease the string reference count, if the current token is a string\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\4${}\}{}$\2\par
\fi

\M{812}\B\X812:Decrease the string reference count, if the current token is a
string\X${}\E{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_string\_token}){}$\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_mod\_str}(\,));\6
\4${}\}{}$\2\par
\Us127, 811\ETs1050.\fi

\M{813}When we begin to process a new \&{if}, we set \PB{\\{if\_limit}: $\K$ %
\\{if\_code}}; then
if \&{elseif} or \&{else} or \&{fi} occurs before the current \&{if}
condition has been evaluated, a colon will be inserted.
A construction like `\.{if fi}' would otherwise get \MP\ confused.

\Y\B\4\X813:Push the condition stack\X${}\E{}$\6
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_if\_node}(\\{mp});{}$\6
${}\\{mp\_link}(\|p)\K\\{mp}\MG\\{cond\_ptr};{}$\6
${}\\{mp\_type}(\|p)\K{}$(\&{quarterword}) \\{mp}${}\MG\\{if\_limit};{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp}\MG\\{cur\_if};{}$\6
${}\\{if\_line\_field}(\|p)\K\\{mp}\MG\\{if\_line};{}$\6
${}\\{mp}\MG\\{cond\_ptr}\K\|p;{}$\6
${}\\{mp}\MG\\{if\_limit}\K\\{if\_code};{}$\6
${}\\{mp}\MG\\{if\_line}\K\\{mp\_true\_line}(\\{mp});{}$\6
${}\\{mp}\MG\\{cur\_if}\K\\{if\_code};{}$\6
\4${}\}{}$\2\par
\U817.\fi

\M{814}\B\X814:Pop the condition stack\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \|p${}\K\\{mp}\MG\\{cond\_ptr};{}$\7
${}\\{mp}\MG\\{if\_line}\K\\{if\_line\_field}(\|p);{}$\6
${}\\{mp}\MG\\{cur\_if}\K\\{mp\_name\_type}(\|p);{}$\6
${}\\{mp}\MG\\{if\_limit}\K\\{mp\_type}(\|p);{}$\6
${}\\{mp}\MG\\{cond\_ptr}\K\\{mp\_link}(\|p);{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\|p,\39\\{if\_node\_size});{}$\6
\4${}\}{}$\2\par
\Us817, 818\ETs820.\fi

\M{815}Here's a procedure that changes the \PB{\\{if\_limit}} code
corresponding to
a given value of \PB{\\{cond\_ptr}}.

\Y\B\&{static} \&{void} \\{mp\_change\_if\_limit}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|l${},\39{}$\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\7
\&{if} ${}(\|p\E\\{mp}\MG\\{cond\_ptr}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{if\_limit}\K\|l{}$;\C{ that's the easy case }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{cond\_ptr};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\|q\E\NULL){}$\1\5
${}\\{mp\_confusion}(\\{mp},\39\.{"if"});{}$\2\6
;\C{ clang: dereference of null pointer }\6
\\{assert}(\|q);\6
\&{if} ${}(\\{mp\_link}(\|q)\E\|p){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\|q)\K\|l;{}$\6
\&{return};\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{816}The user is supposed to put colons into the proper parts of conditional
statements. Therefore, \MP\ has to check for their presence.

\Y\B\&{static} \&{void} \\{mp\_check\_colon}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_colon}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"There\ should've\ bee}\)\.{n\ a\
colon\ after\ the\ }\)\.{condition."},\39\.{"I\ shall\ pretend\ tha}\)\.{t\ one%
\ was\ there."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `:'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{817}A condition is started when the \PB{\\{get\_x\_next}} procedure
encounters
an \PB{\\{if\_test}} command; in that case \PB{\\{get\_x\_next}} calls \PB{%
\\{conditional}},
which is a recursive procedure.

\Y\B\&{void} \\{mp\_conditional}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{save\_cond\_ptr};\C{ \PB{\\{cond\_ptr}} corresponding to this
conditional }\6
\&{int} \\{new\_if\_limit};\C{ future value of \PB{\\{if\_limit}} }\6
\&{mp\_node} \|p;\C{ temporary register }\7
\X813:Push the condition stack\X;\6
${}\\{save\_cond\_ptr}\K\\{mp}\MG\\{cond\_ptr};{}$\6
\4\.{RESWITCH}:\5
\\{mp\_get\_boolean}(\\{mp});\6
${}\\{new\_if\_limit}\K\\{else\_if\_code};{}$\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{unity\_t})){}$\5
${}\{{}$\1\6
\X819:Display the boolean value of \PB{\\{cur\_exp}}\X;\6
\4${}\}{}$\2\6
\4\.{FOUND}:\5
\\{mp\_check\_colon}(\\{mp});\6
\&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_true\_code}){}$\5
${}\{{}$\1\6
${}\\{mp\_change\_if\_limit}(\\{mp},\39{}$(\&{quarterword}) \\{new\_if%
\_limit}${},\39\\{save\_cond\_ptr});{}$\6
\&{return};\C{ wait for \&{elseif}, \&{else}, or \&{fi} }\6
\4${}\}{}$\2\6
;\6
\X818:Skip to \&{elseif} or \&{else} or \&{fi}, then \PB{\&{goto} \\{done}}\X;\6
\4\.{DONE}:\5
${}\\{mp}\MG\\{cur\_if}\K{}$(\&{quarterword}) \\{cur\_mod}(\,);\6
${}\\{mp}\MG\\{if\_line}\K\\{mp\_true\_line}(\\{mp});{}$\6
\&{if} ${}(\\{cur\_mod}(\,)\E\\{fi\_code}){}$\5
${}\{\X814:Pop the condition stack\X\}{}$\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\\{else\_if\_code}){}$\5
${}\{{}$\1\6
\&{goto} \.{RESWITCH};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_exp\_value\_boolean}(\\{mp\_true\_code});\6
${}\\{new\_if\_limit}\K\\{fi\_code};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{FOUND};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{818}In a construction like `\&{if} \&{if} \&{true}: $0=1$: \\{foo}
\&{else}: \\{bar} \&{fi}', the first \&{else}
that we come to after learning that the \&{if} is false is not the
\&{else} we're looking for. Hence the following curious logic is needed.

\Y\B\4\X818:Skip to \&{elseif} or \&{else} or \&{fi}, then \PB{\&{goto} %
\\{done}}\X${}\E{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{mp\_pass\_text}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cond\_ptr}\E\\{save\_cond\_ptr}){}$\1\5
\&{goto} \.{DONE};\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\\{fi\_code}){}$\1\5
\X814:Pop the condition stack\X;\2\6
\4${}\}{}$\2\par
\U817.\fi

\M{819}\B\X819:Display the boolean value of \PB{\\{cur\_exp}}\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
\&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_true\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\{true\}"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\{false\}"});{}$\2\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\par
\U817.\fi

\M{820}The processing of conditionals is complete except for the following
code, which is actually part of \PB{\\{get\_x\_next}}. It comes into play when
\&{elseif}, \&{else}, or \&{fi} is scanned.

\Y\B\4\X820:Terminate the current conditional and skip to \&{fi}\X${}\E{}$\6
\&{if} ${}(\\{cur\_mod}(\,)>\\{mp}\MG\\{if\_limit}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{if\_limit}\E\\{if\_code}){}$\5
${}\{{}$\C{ condition not yet evaluated }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Something\ was\ missi}\)\.{ng\
here"},\39\NULL\};{}$\7
\\{mp\_back\_input}(\\{mp});\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_colon});{}$\6
${}\\{mp\_ins\_error}(\\{mp},\39\.{"Missing\ `:'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ ignoring\ this;\ }\)\.{it\
doesn't\ match\ any}\)\.{\ if."},\39\NULL\};{}$\7
\&{if} ${}(\\{cur\_mod}(\,)\E\\{fi\_code}){}$\5
${}\{{}$\1\6
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ fi"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\\{else\_code}){}$\5
${}\{{}$\1\6
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ else"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ elseif"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{while} ${}(\\{cur\_mod}(\,)\I\\{fi\_code}){}$\1\5
\\{mp\_pass\_text}(\\{mp});\C{ skip to \&{fi} }\2\6
\X814:Pop the condition stack\X;\6
\4${}\}{}$\2\par
\U769.\fi

\N{1}{821}Iterations.
To bring our treatment of \PB{\\{get\_x\_next}} to a close, we need to consider
what
\MP\ does when it sees \&{for}, \&{forsuffixes}, and \&{forever}.

There's a global variable \PB{\\{loop\_ptr}} that keeps track of the \&{for}
loops
that are currently active. If \PB{$\\{loop\_ptr}\K\NULL$}, no loops are in
progress;
otherwise \PB{$\\{loop\_ptr}.\\{info}$} points to the iterative text of the
current
(innermost) loop, and \PB{$\\{loop\_ptr}.\\{link}$} points to the data for any
other
loops that enclose the current one.

A loop-control node also has two other fields, called \PB{\\{type}} and
\PB{\\{list}}, whose contents depend on the type of loop:

\yskip\indent\PB{$\\{loop\_ptr}.\\{type}\K\NULL$} means that the link of \PB{$%
\\{loop\_ptr}.\\{list}$}
points to a list of symbolic nodes whose \PB{\\{info}} fields point to the
remaining argument values of a suffix list and expression list.
In this case, an extra field \PB{$\\{loop\_ptr}.\\{start\_list}$} is needed to
make sure that \PB{\\{resume\_operation}} skips ahead.

\yskip\indent\PB{$\\{loop\_ptr}.\\{type}\K\.{MP\_VOID}$} means that the current
loop is
`\&{forever}'.

\yskip\indent\PB{$\\{loop\_ptr}.\\{type}\K\.{PROGRESSION\_FLAG}$} means that
\PB{$\\{loop\_ptr}.\\{value}$}, \PB{$\\{loop\_ptr}.\\{step\_size}$}, and \PB{$%
\\{loop\_ptr}.\\{final\_value}$}
contain the data for an arithmetic progression.

\yskip\indent\PB{$\\{loop\_ptr}.\\{type}\K\|p>\.{PROGRESSION\_FLAG}$} means
that \PB{\|p} points to an edge
header and \PB{$\\{loop\_ptr}.\\{list}$} points into the graphical object list
for
that edge header.

\Y\B\4\D$\.{PROGRESSION\_FLAG}$ \5
(\&{mp\_node})(\T{2})\C{ \PB{$\NULL+\T{2}$} }\C{ \PB{\\{loop\_type}} value when
\PB{\\{loop\_list}} points to a progression node }\par
\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{mp\_loop\_data} ${}\{{}$\1\6
\&{mp\_node} \\{info};\C{ iterative text of this loop }\6
\&{mp\_node} \\{type};\C{ the special type of this loop, or a pointer into
              mem }\6
\&{mp\_node} \\{list};\C{ the remaining list elements }\6
\&{mp\_node} \\{list\_start};\C{ head fo the list of elements }\6
\&{mp\_number} \\{value};\C{ current arithmetic value }\6
\&{mp\_number} \\{step\_size};\C{ arithmetic step size }\6
\&{mp\_number} \\{final\_value};\C{ end arithmetic value }\6
\&{struct} \&{mp\_loop\_data} ${}{*}\\{link}{}$;\C{ the enclosing loop, if any
}\2\6
${}\}{}$ \&{mp\_loop\_data};\par
\fi

\M{822}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_loop\_data} ${}{*}\\{loop\_ptr}{}$;\C{ top of the loop-control-node
stack }\par
\fi

\M{823}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{loop\_ptr}\K\NULL{}$;\par
\fi

\M{824}If the expressions that define an arithmetic progression in a
\&{for} loop don't have known numeric values, the \PB{\\{bad\_for}} subroutine
screams at the user.

\Y\B\&{static} \&{void} \\{mp\_bad\_for}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ say\ `for\ x}\)\.{=a\
step\ b\ until\ c',"},\39\.{"the\ initial\ value\ `}\)\.{a'\ and\ the\ step\
size}\)\.{\ `b'"},\39\.{"and\ the\ final\ value}\)\.{\ `c'\ must\ have\ known}%
\)\.{\ numeric\ values."},\39\.{"I'm\ zeroing\ this\ on}\)\.{e.\ Proceed,\ with%
\ fin}\)\.{gers\ crossed."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL){}$;\C{ show the bad expression above the
message }\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Improper\ \%s\ has\ bee}\)\.{n\
replaced\ by\ 0"},\39\|s);{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{825}Here's what \MP\ does when \&{for}, \&{forsuffixes}, or \&{forever}
has just been scanned. (This code requires slight familiarity with
expression-parsing routines that we have not yet discussed; but it
seems to belong in the present part of the program, even though the
original author didn't write it until later. The reader may wish to
come back to it.)

\Y\B\&{void} \\{mp\_begin\_iteration}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{halfword} \|m;\C{ \PB{\\{start\_for}} (\&{for}) or \PB{\\{start%
\_forsuffixes}}                    (\&{forsuffixes}) }\6
\&{mp\_sym} \|n;\C{ hash address of the current symbol }\6
\&{mp\_loop\_data} ${}{*}\|s{}$;\C{ the new loop-control node }\6
\&{mp\_subst\_list\_item} ${}{*}\|p\K\NULL{}$;\C{ substitution list for \PB{%
\\{scan\_toks}}                                  }\6
\&{mp\_node} \|q;\C{ link manipulation register }\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
${}\|n\K\\{cur\_sym}(\,);{}$\6
${}\|s\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_loop\_data}));{}$\6
${}\|s\MG\\{type}\K\|s\MG\\{list}\K\|s\MG\\{info}\K\|s\MG\\{list\_start}\K%
\NULL;{}$\6
${}\|s\MG\\{link}\K\NULL;{}$\6
${}\\{new\_number}(\|s\MG\\{value});{}$\6
${}\\{new\_number}(\|s\MG\\{step\_size});{}$\6
${}\\{new\_number}(\|s\MG\\{final\_value});{}$\6
\&{if} ${}(\|m\E\\{start\_forever}){}$\5
${}\{{}$\1\6
${}\|s\MG\\{type}\K\.{MP\_VOID};{}$\6
${}\|p\K\NULL;{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\|p\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{mp\_subst\_list\_item}));{}$\6
${}\|p\MG\\{link}\K\NULL;{}$\6
${}\|p\MG\\{info}\K\\{cur\_sym}(\,);{}$\6
${}\|p\MG\\{info\_mod}\K\\{cur\_sym\_mod}(\,);{}$\6
${}\|p\MG\\{value\_data}\K\T{0};{}$\6
\&{if} ${}(\|m\E\\{start\_for}){}$\5
${}\{{}$\1\6
${}\|p\MG\\{value\_mod}\K\\{mp\_expr\_sym};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ \PB{\\{start\_forsuffixes}} }\1\6
${}\|p\MG\\{value\_mod}\K\\{mp\_suffix\_sym};{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_within\_token}){}$\5
${}\{{}$\1\6
\X838:Set up a picture iteration\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X826:Check for the assignment in a loop header\X;\6
\X836:Scan the values to be used in the loop\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\X827:Check for the presence of a colon\X;\6
\X829:Scan the loop text and put it on the loop control stack\X;\6
\\{mp\_resume\_iteration}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{826}\B\X826:Check for the assignment in a loop header\X${}\E{}$\6
\&{if} ${}((\\{cur\_cmd}(\,)\I\\{mp\_equals})\W(\\{cur\_cmd}(\,)\I\\{mp%
\_assignment})){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ next\ thing\ in\ t}\)\.{his\
loop\ should\ have}\)\.{\ been\ `='\ or\ `:='."},\39\.{"But\ don't\ worry;\ I'}%
\)\.{ll\ pretend\ that\ an\ e}\)\.{quals\ sign"},\39\.{"was\ present,\ and\ I'}%
\)\.{ll\ look\ for\ the\ valu}\)\.{es\ next."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `='\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\par
\U825.\fi

\M{827}\B\X827:Check for the presence of a colon\X${}\E{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_colon}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ next\ thing\ in\ t}\)\.{his\
loop\ should\ have}\)\.{\ been\ a\ `:'."},\39\.{"So\ I'll\ pretend\ tha}\)\.{t\
a\ colon\ was\ presen}\)\.{t;"},\39\.{"everything\ from\ her}\)\.{e\ to\
`endfor'\ will\ b}\)\.{e\ iterated."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `:'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\par
\U825.\fi

\M{828}We append a special \PB{$\\{mp}\MG\\{frozen\_repeat\_loop}$} token in
place of the
`\&{endfor}' at the end of the loop. This will come through \MP's
scanner at the proper time to cause the loop to be repeated.

(If the user tries some shenanigan like `\&{for} $\ldots$ \&{let}
\&{endfor}', he will be foiled by the \PB{\\{get\_symbol}} routine, which
keeps frozen tokens unchanged. Furthermore the
\PB{$\\{mp}\MG\\{frozen\_repeat\_loop}$} is an \&{outer} token, so it won't be
lost
accidentally.)

\fi

\M{829}\B\X829:Scan the loop text and put it on the loop control stack\X${}%
\E{}$\6
$\|q\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|q,\39\\{mp}\MG\\{frozen\_repeat\_loop});{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{loop\_defining};{}$\6
${}\\{mp}\MG\\{warning\_info}\K\|n;{}$\6
${}\|s\MG\\{info}\K\\{mp\_scan\_toks}(\\{mp},\39\\{mp\_iteration},\39\|p,\39%
\|q,\39\T{0});{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
${}\|s\MG\\{link}\K\\{mp}\MG\\{loop\_ptr};$ $\\{mp}\MG\\{loop\_ptr}\K{}$\|s\par
\U825.\fi

\M{830}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{frozen\_repeat\_loop}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"\
ENDFOR"},\39\\{mp\_repeat\_loop}+\\{mp\_outer\_tag},\39\T{0}){}$;\par
\fi

\M{831}The loop text is inserted into \MP's scanning apparatus by the
\PB{\\{resume\_iteration}} routine.

\Y\B\&{void} \\{mp\_resume\_iteration}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ link registers }\7
${}\|p\K\\{mp}\MG\\{loop\_ptr}\MG\\{type};{}$\6
\&{if} ${}(\|p\E\.{PROGRESSION\_FLAG}){}$\5
${}\{{}$\1\6
${}\\{set\_cur\_exp\_value\_number}(\\{mp}\MG\\{loop\_ptr}\MG\\{value});{}$\6
\&{if} (\X832:The arithmetic progression has ended\X)\5
${}\{{}$\1\6
\\{mp\_stop\_iteration}(\\{mp});\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp}){}$;\C{ make \PB{\|q} an \&{expr}
argument }\6
${}\\{set\_number\_from\_addition}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{cur%
\_exp\_value\_number}(\,),\39\\{mp}\MG\\{loop\_ptr}\MG\\{step\_size}){}$;\C{
set \PB{\\{value}(\|p)} for the next iteration }\C{ detect numeric overflow }\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{loop\_ptr}\MG\\{step\_size})\W%
\\{number\_less}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{cur\_exp\_value%
\_number}(\,))){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{loop\_ptr}\MG\\{final\_value})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{mp}\MG\\{loop%
\_ptr}\MG\\{final\_value});{}$\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{loop\_ptr}\MG\\{final\_value},\39{-}%
\T{1});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{mp}\MG\\{loop%
\_ptr}\MG\\{final\_value});{}$\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\T{1});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_negative}(\\{mp}\MG\\{loop\_ptr}\MG\\{step%
\_size})\W\\{number\_greater}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{cur\_exp%
\_value\_number}(\,))){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{number\_negative}(\\{mp}\MG\\{loop\_ptr}\MG\\{final\_value})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{mp}\MG\\{loop%
\_ptr}\MG\\{final\_value});{}$\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{loop\_ptr}\MG\\{final\_value},\39%
\T{1});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39\\{mp}\MG\\{loop%
\_ptr}\MG\\{final\_value});{}$\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{loop\_ptr}\MG\\{value},\39{-}\T{1});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp}\MG\\{loop\_ptr}\MG\\{list};{}$\6
\&{if} ${}(\|p\I\NULL\W\|p\E\\{mp}\MG\\{loop\_ptr}\MG\\{list\_start}){}$\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|q);{}$\6
${}\\{mp}\MG\\{loop\_ptr}\MG\\{list}\K\|p;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
\\{mp\_stop\_iteration}(\\{mp});\6
\&{return};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{loop\_ptr}\MG\\{list}\K\\{mp\_link}(\|p);{}$\6
${}\|q\K{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|p);\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|p\E\.{MP\_VOID}){}$\5
${}\{{}$\1\6
${}\\{mp\_begin\_token\_list}(\\{mp},\39\\{mp}\MG\\{loop\_ptr}\MG\\{info},%
\39{}$(\&{quarterword}) \\{forever\_text});\6
\&{return};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X834:Make \PB{\|q} a capsule containing the next picture component from \PB{%
\\{loop\_list}(\\{loop\_ptr})} or \PB{\&{goto} \\{not\_found}}\X;\6
\4${}\}{}$\2\6
${}\\{mp\_begin\_token\_list}(\\{mp},\39\\{mp}\MG\\{loop\_ptr}\MG\\{info},%
\39{}$(\&{quarterword}) \\{loop\_text});\6
${}\\{mp\_stack\_argument}(\\{mp},\39\|q);{}$\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{unity\_t})){}$\5
${}\{{}$\1\6
\X833:Trace the start of a loop\X;\6
\4${}\}{}$\2\6
\&{return};\6
\4\.{NOT\_FOUND}:\5
\\{mp\_stop\_iteration}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{832}\B\X832:The arithmetic progression has ended\X${}\E{}$\6
$(\\{number\_positive}(\\{mp}\MG\\{loop\_ptr}\MG\\{step\_size})\W\\{number%
\_greater}(\\{cur\_exp\_value\_number}(\,),\39\\{mp}\MG\\{loop\_ptr}\MG\\{final%
\_value}))\V(\\{number\_negative}(\\{mp}\MG\\{loop\_ptr}\MG\\{step\_size})\W%
\\{number\_less}(\\{cur\_exp\_value\_number}(\,),\39\\{mp}\MG\\{loop\_ptr}\MG%
\\{final\_value}){}$)\par
\U831.\fi

\M{833}\B\X833:Trace the start of a loop\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{loop\ value="});{}$\6
;\6
\&{if} ${}((\|q\I\NULL)\W(\\{mp\_link}(\|q)\E\.{MP\_VOID})){}$\1\5
${}\\{mp\_print\_exp}(\\{mp},\39\|q,\39\T{1});{}$\2\6
\&{else}\1\5
${}\\{mp\_show\_token\_list}(\\{mp},\39\|q,\39\NULL,\39\T{50},\39\T{0});{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\par
\U831.\fi

\M{834}\B\X834:Make \PB{\|q} a capsule containing the next picture component
from \PB{\\{loop\_list}(\\{loop\_ptr})} or \PB{\&{goto} \\{not\_found}}\X${}%
\E{}$\6
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{loop\_ptr}\MG\\{list};{}$\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{if} ${}(\R\\{is\_start\_or\_stop}(\|q)){}$\1\5
${}\|q\K\\{mp\_link}(\|q);{}$\2\6
\&{else} \&{if} ${}(\R\\{is\_stop}(\|q)){}$\1\5
${}\|q\K\\{mp\_skip\_1component}(\\{mp},\39\|q);{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\\{set\_cur\_exp\_node}((\&{mp\_node}) \\{mp\_copy\_objects}${}(\\{mp},\39%
\\{mp}\MG\\{loop\_ptr}\MG\\{list},\39\|q));{}$\6
${}\\{mp\_init\_bbox}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{cur\_exp%
\_node}(\,));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
${}\\{mp}\MG\\{loop\_ptr}\MG\\{list}\K\|q;{}$\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\4${}\}{}$\2\par
\U831.\fi

\M{835}A level of loop control disappears when \PB{\\{resume\_iteration}} has
decided not to resume, or when an \&{exitif} construction has removed
the loop text from the input stack.

\Y\B\&{void} \\{mp\_stop\_iteration}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ the usual }\6
\&{mp\_loop\_data} ${}{*}\\{tmp}{}$;\C{ for free() }\7
${}\|p\K\\{mp}\MG\\{loop\_ptr}\MG\\{type};{}$\6
\&{if} ${}(\|p\E\.{PROGRESSION\_FLAG}){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{mp}\MG\\{loop\_ptr}\MG%
\\{list});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp}\MG\\{loop\_ptr}\MG\\{list};{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K{}$(\&{mp\_node}) \\{mp\_sym\_sym}(\|q);\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_link}(\|p)\E\.{MP\_VOID}){}$\5
${}\{{}$\C{ it's an \&{expr} parameter }\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\|p){}$;\C{ it's a \&{suffix} or %
\&{text}                                            parameter }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|p\K\|q;{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|p>\.{PROGRESSION\_FLAG}){}$\5
${}\{{}$\1\6
\\{delete\_edge\_ref}(\|p);\6
\4${}\}{}$\2\6
${}\\{tmp}\K\\{mp}\MG\\{loop\_ptr};{}$\6
${}\\{mp}\MG\\{loop\_ptr}\K\\{tmp}\MG\\{link};{}$\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\\{tmp}\MG\\{info});{}$\6
${}\\{free\_number}(\\{tmp}\MG\\{value});{}$\6
${}\\{free\_number}(\\{tmp}\MG\\{step\_size});{}$\6
${}\\{free\_number}(\\{tmp}\MG\\{final\_value});{}$\6
\\{xfree}(\\{tmp});\6
\4${}\}{}$\2\par
\fi

\M{836}Now that we know all about loop control, we can finish up the
missing portion of \PB{\\{begin\_iteration}} and we'll be done.

The following code is performed after the `\.=' has been scanned in a
\&{for} construction (if \PB{$\|m\K\\{start\_for}$}) or a \&{forsuffixes}
construction (if \PB{$\|m\K\\{start\_forsuffixes}$}).

\Y\B\4\X836:Scan the values to be used in the loop\X${}\E{}$\6
$\|s\MG\\{type}\K\NULL;{}$\6
${}\|s\MG\\{list}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|s\MG\\{list\_start}\K\|s\MG\\{list};{}$\6
${}\|q\K\|s\MG\\{list};$ \&{do} \6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\|m\I\\{start\_for}){}$\5
${}\{{}$\1\6
\\{mp\_scan\_suffix}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_colon}){}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_comma}){}$\1\5
\&{goto} \.{CONTINUE};\2\2\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_step\_token}){}$\1\6
\&{if} ${}(\|q\E\|s\MG\\{list}){}$\5
${}\{{}$\1\6
\X837:Prepare for step-until construction and \PB{\&{break}}\X;\6
\4${}\}{}$\2\2\6
\\{set\_cur\_exp\_node}(\\{mp\_stash\_cur\_exp}(\\{mp}));\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|q)\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
${}\\{set\_mp\_sym\_sym}(\|q,\39\\{mp}\MG\\{cur\_exp}.\\{data}.\\{node});{}$\6
\&{if} ${}(\|m\E\\{start\_for}){}$\1\5
${}\\{mp\_name\_type}(\|q)\K\\{mp\_expr\_sym};{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{start\_forsuffixes}){}$\1\5
${}\\{mp\_name\_type}(\|q)\K\\{mp\_suffix\_sym};{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4\.{CONTINUE}:\5
;\6
\4${}\}{}$\2\6
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}{}$)\par
\U825.\fi

\M{837}\B\X837:Prepare for step-until construction and \PB{\&{break}}\X${}\E{}$%
\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\1\5
${}\\{mp\_bad\_for}(\\{mp},\39\.{"initial\ value"});{}$\2\6
${}\\{number\_clone}(\|s\MG\\{value},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\1\5
${}\\{mp\_bad\_for}(\\{mp},\39\.{"step\ size"});{}$\2\6
${}\\{number\_clone}(\|s\MG\\{step\_size},\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_until\_token}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ assume\ you\ meant\ }\)\.{to\
say\ `until'\ after}\)\.{\ `step'."},\39\.{"So\ I'll\ look\ for\ th}\)\.{e\
final\ value\ and\ co}\)\.{lon\ next."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `until'\ has}\)\.{\ been\
inserted"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\1\5
${}\\{mp\_bad\_for}(\\{mp},\39\.{"final\ value"});{}$\2\6
${}\\{number\_clone}(\|s\MG\\{final\_value},\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
${}\|s\MG\\{type}\K\.{PROGRESSION\_FLAG};{}$\6
\&{break};\6
\4${}\}{}$\2\par
\U836.\fi

\M{838}The last case is when we have just seen ``\&{within}'', and we need to
parse a picture expression and prepare to iterate over it.

\Y\B\4\X838:Set up a picture iteration\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\X839:Make sure the current expression is a known picture\X;\6
${}\|s\MG\\{type}\K\\{mp}\MG\\{cur\_exp}.\\{data}.\\{node};{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
${}\|q\K\\{mp\_link}(\\{edge\_list}(\\{mp}\MG\\{cur\_exp}.\\{data}.%
\\{node}));{}$\6
\&{if} ${}(\|q\I\NULL){}$\1\6
\&{if} (\\{is\_start\_or\_stop}(\|q))\1\6
\&{if} ${}(\\{mp\_skip\_1component}(\\{mp},\39\|q)\E\NULL){}$\1\5
${}\|q\K\\{mp\_link}(\|q);{}$\2\2\2\6
${}\|s\MG\\{list}\K\|q;{}$\6
\4${}\}{}$\2\par
\U825.\fi

\M{839}\B\X839:Make sure the current expression is a known picture\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ say\ `for\ x}\)\.{\ in\
p',\ p\ must\ be\ a\ }\)\.{known\ picture."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{new\_expr}.\\{data}.\\{node}\K{}$(\&{mp\_node}) \\{mp\_get\_edge\_header%
\_node}(\\{mp});\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ iteration\ }\)\.{spec\ has\ been%
\ replac}\)\.{ed\ by\ nullpicture"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp\_init\_edges}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{mp}${}\MG%
\\{cur\_exp}.\\{data}.\\{node});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\4${}\}{}$\2\par
\U838.\fi

\N{1}{840}File names.
It's time now to fret about file names.  Besides the fact that different
operating systems treat files in different ways, we must cope with the
fact that completely different naming conventions are used by different
groups of people. The following programs show what is required for one
particular operating system; similar routines for other systems are not
difficult to devise.

\MP\ assumes that a file name has three parts: the name proper; its
``extension''; and a ``file area'' where it is found in an external file
system.  The extension of an input file is assumed to be
`\.{.mp}' unless otherwise specified; it is `\.{.log}' on the
transcript file that records each run of \MP; it is `\.{.tfm}' on the font
metric files that describe characters in any fonts created by \MP; it is
`\.{.ps}' or `.{\it nnn}' for some number {\it nnn} on the \ps\ output files.
The file area can be arbitrary on input files, but files are usually
output to the user's current area.  If an input file cannot be
found on the specified area, \MP\ will look for it on a special system
area; this special area is intended for commonly used input files.

Simple uses of \MP\ refer only to file names that have no explicit
extension or area. For example, a person usually says `\.{input} \.{cmr10}'
instead of `\.{input} \.{cmr10.new}'. Simple file
names are best, because they make the \MP\ source files portable;
whenever a file name consists entirely of letters and digits, it should be
treated in the same way by all implementations of \MP. However, users
need the ability to refer to other files in their environment, especially
when responding to error messages concerning unopenable files; therefore
we want to let them use the syntax that appears in their favorite
operating system.

\fi

\M{841}\MP\ uses the same conventions that have proved to be satisfactory for
\TeX\ and \MF. In order to isolate the system-dependent aspects of file names,
the system-independent parts of \MP\ are expressed in terms
of three system-dependent
procedures called \PB{\\{begin\_name}}, \PB{\\{more\_name}}, and \PB{\\{end%
\_name}}. In
essence, if the user-specified characters of the file name are $c_1\ldots c_n$,
the system-independent driver program does the operations
$$\PB{\\{begin\_name}};\,\PB{\\{more\_name}}(c_1);\,\ldots\,;\,\PB{\\{more%
\_name}}(c_n);
\,\PB{\\{end\_name}}.$$
These three procedures communicate with each other via global variables.
Afterwards the file name will appear in the string pool as three strings
called \PB{\\{cur\_name}}\penalty10000\hskip-.05em,
\PB{\\{cur\_area}}, and \PB{\\{cur\_ext}}; the latter two are NULL (i.e.,
\PB{\.{""}}), unless they were explicitly specified by the user.

Actually the situation is slightly more complicated, because \MP\ needs
to know when the file name ends. The \PB{\\{more\_name}} routine is a function
(with side effects) that returns \PB{\\{true}} on the calls \PB{\\{more%
\_name}}$(c_1)$,
\dots, \PB{\\{more\_name}}$(c_{n-1})$. The final call \PB{\\{more%
\_name}}$(c_n)$
returns \PB{\\{false}}; or, it returns \PB{\\{true}} and $c_n$ is the last
character
on the current input line. In other words,
\PB{\\{more\_name}} is supposed to return \PB{\\{true}} unless it is sure that
the
file name has been completely scanned; and \PB{\\{end\_name}} is supposed to be
able
to finish the assembly of \PB{\\{cur\_name}}, \PB{\\{cur\_area}}, and \PB{%
\\{cur\_ext}} regardless of
whether $\PB{\\{more\_name}}(c_n)$ returned \PB{\\{true}} or \PB{\\{false}}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{cur\_name}{}$;\C{ name of file just scanned }\6
\&{char} ${}{*}\\{cur\_area}{}$;\C{ file area just scanned, or \.{""} }\6
\&{char} ${}{*}\\{cur\_ext}{}$;\C{ file extension just scanned, or \.{""} }\par
\fi

\M{842}It is easier to maintain reference counts if we assign initial values.

\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{cur\_name}\K\\{xstrdup}(\.{""});{}$\6
${}\\{mp}\MG\\{cur\_area}\K\\{xstrdup}(\.{""});{}$\6
${}\\{mp}\MG\\{cur\_ext}\K\\{xstrdup}(\.{""}){}$;\par
\fi

\M{843}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{cur\_area});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_ext}){}$;\par
\fi

\M{844}The file names we shall deal with for illustrative purposes have the
following structure:  If the name contains `\.>' or `\.:', the file area
consists of all characters up to and including the final such character;
otherwise the file area is null.  If the remaining file name contains
`\..', the file extension consists of all such characters from the first
remaining `\..' to the end, otherwise the file extension is null.

We can scan such file names easily by using two global variables that keep
track
of the occurrences of area and extension delimiters.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{area\_delimiter};\C{ most recent `\.>' or `\.:' relative to \PB{%
\\{str\_start}[\\{str\_ptr}]} }\6
\&{integer} \\{ext\_delimiter};\C{ the relevant `\..', if any }\6
\&{boolean} \\{quoted\_filename};\C{ whether the filename is wrapped in "
markers }\par
\fi

\M{845}Here now is the first of the system-dependent routines for file name
scanning.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_begin\_name}(\&{MP} \\{mp});\6
\&{static} \&{boolean} \\{mp\_more\_name}(\&{MP} \\{mp}${},\39{}$\&{ASCII%
\_code} \|c);\6
\&{static} \&{void} \\{mp\_end\_name}(\&{MP} \\{mp});\par
\fi

\M{846}\B\&{void} \\{mp\_begin\_name}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{cur\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_area});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_ext});{}$\6
${}\\{mp}\MG\\{area\_delimiter}\K{-}\T{1};{}$\6
${}\\{mp}\MG\\{ext\_delimiter}\K{-}\T{1};{}$\6
${}\\{mp}\MG\\{quoted\_filename}\K\\{false};{}$\6
\4${}\}{}$\2\par
\fi

\M{847}And here's the second.

\Y\B\8\#\&{ifndef} \.{IS\_DIR\_SEP}\6
\8\#\&{define} \.{IS\_DIR\_SEP}(\|c) \5${}(\|c\E\.{'/'}\V\|c\E\.{'\\\\'}){}$\6
\8\#\&{endif}\6
\&{boolean} \\{mp\_more\_name}(\&{MP} \\{mp}${},\39{}$\&{ASCII\_code} \|c)\1\1%
\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|c\E\.{'"'}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{quoted\_filename}\K\R\\{mp}\MG\\{quoted\_filename};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\|c\E\.{'\ '}\V\|c\E\.{'\\t'})\W(\\{mp}\MG\\{quoted%
\_filename}\E\\{false})){}$\5
${}\{{}$\1\6
\&{return} \\{false};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} (\.{IS\_DIR\_SEP}(\|c))\5
${}\{{}$\1\6
${}\\{mp}\MG\\{area\_delimiter}\K{}$(\&{integer}) \\{mp}${}\MG\\{cur%
\_length};{}$\6
${}\\{mp}\MG\\{ext\_delimiter}\K{-}\T{1};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\.{'.'}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{ext\_delimiter}\K{}$(\&{integer}) \\{mp}${}\MG\\{cur%
\_length};{}$\6
\4${}\}{}$\2\6
\\{append\_char}(\|c);\C{ contribute \PB{\|c} to the current string }\6
\4${}\}{}$\2\6
\&{return} \\{true};\6
\4${}\}{}$\2\par
\fi

\M{848}The third.

\Y\B\4\D$\\{copy\_pool\_segment}(\|A,\|B,\|C)$ \6
${}\{{}$\1\6
${}\|A\K\\{xmalloc}(\|C+\T{1},\39\&{sizeof}(\&{char}));{}$\6
(\&{void}) \\{memcpy}${}(\|A,\39{}$(\&{char} ${}{*})(\\{mp}\MG\\{cur\_string}+%
\|B),\39\|C);{}$\6
${}\|A[\|C]\K\T{0};{}$\6
\4${}\}{}$\2\par
\Y\B\&{void} \\{mp\_end\_name}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|s${}\K\T{0}{}$;\C{ length of area, name, and extension }\6
\&{size\_t} \\{len};\C{ "my/w.mp" }\7
\&{if} ${}(\\{mp}\MG\\{area\_delimiter}<\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_area}\K\\{xstrdup}(\.{""});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{len}\K{}$(\&{size\_t}) \\{mp}${}\MG\\{area\_delimiter}-\|s+\T{1};{}$\6
${}\\{copy\_pool\_segment}(\\{mp}\MG\\{cur\_area},\39\|s,\39\\{len});{}$\6
${}\|s\MRL{+{\K}}\\{len};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{ext\_delimiter}<\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_ext}\K\\{xstrdup}(\.{""});{}$\6
${}\\{len}\K(\&{unsigned})(\\{mp}\MG\\{cur\_length}-\|s);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{copy\_pool\_segment}(\\{mp}\MG\\{cur\_ext},\39\\{mp}\MG\\{ext%
\_delimiter},\39(\\{mp}\MG\\{cur\_length}-{}$(\&{size\_t}) \\{mp}${}\MG\\{ext%
\_delimiter}));{}$\6
${}\\{len}\K{}$(\&{size\_t}) \\{mp}${}\MG\\{ext\_delimiter}-\|s;{}$\6
\4${}\}{}$\2\6
${}\\{copy\_pool\_segment}(\\{mp}\MG\\{cur\_name},\39\|s,\39\\{len});{}$\6
\\{mp\_reset\_cur\_string}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{849}Conversely, here is a routine that takes three strings and prints a file
name that might have produced them. (The routine is system dependent, because
some operating systems put the file area last instead of first.)

\Y\B\4\X85:Basic printing procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_file\_name}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|n,\39{}$\&{char} ${}{*}\|a,\39{}$\&{char} ${}{*}\|e){}$\1\1\2\2\6
${}\{{}$\1\6
\&{boolean} \\{must\_quote}${}\K\\{false};{}$\7
\&{if} ${}(((\|a\I\NULL)\W(\\{strchr}(\|a,\39\.{'\ '})\I\NULL))\V((\|n\I\NULL)%
\W(\\{strchr}(\|n,\39\.{'\ '})\I\NULL))\V((\|e\I\NULL)\W(\\{strchr}(\|e,\39\.{'%
\ '})\I\NULL))){}$\1\5
${}\\{must\_quote}\K\\{true};{}$\2\6
\&{if} (\\{must\_quote})\1\5
${}\\{mp\_print\_char}(\\{mp},\39{}$(\&{ASCII\_code}) \.{'"'});\2\6
${}\\{mp\_print}(\\{mp},\39\|a);{}$\6
${}\\{mp\_print}(\\{mp},\39\|n);{}$\6
${}\\{mp\_print}(\\{mp},\39\|e);{}$\6
\&{if} (\\{must\_quote})\1\5
${}\\{mp\_print\_char}(\\{mp},\39{}$(\&{ASCII\_code}) \.{'"'});\2\6
\4${}\}{}$\2\par
\fi

\M{850}Another system-dependent routine is needed to convert three internal
\MP\ strings
to the \PB{\\{name\_of\_file}} value that is used to open files. The present
code
allows both lowercase and uppercase letters in the file name.

\Y\B\4\D$\\{append\_to\_name}(\|A)$ \6
${}\{{}$\1\6
${}\\{mp}\MG\\{name\_of\_file}[\|k\PP]\K{}$(\&{char}) \\{xchr}(\\{xord}((%
\&{ASCII\_code})(\|A)));\6
\4${}\}{}$\2\par
\fi

\M{851}\B\&{void} \\{mp\_pack\_file\_name}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|n,\39{}$\&{const} \&{char} ${}{*}\|a,\39{}$\&{const} \&{char}
${}{*}\|e){}$\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \|k;\C{ number of positions filled in \PB{\\{name\_of\_file}} }\6
\&{const} \&{char} ${}{*}\|j{}$;\C{ a character  index }\6
\&{size\_t} \\{slen};\7
${}\|k\K\T{0};{}$\6
${}\\{assert}(\|n\I\NULL);{}$\6
${}\\{xfree}(\\{mp}\MG\\{name\_of\_file});{}$\6
${}\\{slen}\K\\{strlen}(\|n)+\T{1};{}$\6
\&{if} ${}(\|a\I\NULL){}$\1\5
${}\\{slen}\MRL{+{\K}}\\{strlen}(\|a);{}$\2\6
\&{if} ${}(\|e\I\NULL){}$\1\5
${}\\{slen}\MRL{+{\K}}\\{strlen}(\|e);{}$\2\6
${}\\{mp}\MG\\{name\_of\_file}\K\\{xmalloc}(\\{slen},\39\T{1});{}$\6
\&{if} ${}(\|a\I\NULL){}$\5
${}\{{}$\1\6
\&{for} ${}(\|j\K\|a;{}$ ${}{*}\|j\I\.{'\\0'};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
${}\\{append\_to\_name}({*}\|j);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{for} ${}(\|j\K\|n;{}$ ${}{*}\|j\I\.{'\\0'};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
${}\\{append\_to\_name}({*}\|j);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|e\I\NULL){}$\5
${}\{{}$\1\6
\&{for} ${}(\|j\K\|e;{}$ ${}{*}\|j\I\.{'\\0'};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
${}\\{append\_to\_name}({*}\|j);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{name\_of\_file}[\|k]\K\T{0};{}$\6
\4${}\}{}$\2\par
\fi

\M{852}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_pack\_file\_name}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\|n,\39{}$\&{const} \&{char} ${}{*}\|a,\39{}$\&{const} \&{char} ${}{*}%
\|e){}$;\par
\fi

\M{853}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{mem\_name}{}$;\C{ for commandline }\par
\fi

\M{854}Stripping a \PB{$.$ \\{mem}} extension here is for backward
compatibility.

\Y\B\4\X854:Find and load preload file, if required\X${}\E{}$\6
\&{if} ${}(\R\\{opt}\MG\\{ini\_version}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{mem\_name}\K\\{xstrdup}(\\{opt}\MG\\{mem\_name});{}$\6
\&{if} ${}(\\{mp}\MG\\{mem\_name}){}$\5
${}\{{}$\1\6
\&{size\_t} \|l${}\K\\{strlen}(\\{mp}\MG\\{mem\_name});{}$\7
\&{if} ${}(\|l>\T{4}){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\\{test}\K\\{strstr}(\\{mp}\MG\\{mem\_name},\39\.{".mem"});{}$\7
\&{if} ${}(\\{test}\E\\{mp}\MG\\{mem\_name}+\|l-\T{4}){}$\5
${}\{{}$\1\6
${}{*}\\{test}\K\T{0};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{mem\_name}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_open\_mem\_file}(\\{mp})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U16.\fi

\M{855}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{mem\_name}){}$;\par
\fi

\M{856}This part of the program becomes active when a ``virgin'' \MP\ is
trying to get going, just after the preliminary initialization.
The buffer contains the first line of input in \PB{$\\{buffer}[\\{loc}%
\MRL{{.}{.}}(\\{last}-\T{1})]$},
where \PB{$\\{loc}<\\{last}$} and \PB{$\\{buffer}[\\{loc}]\MRL{{<}{>}}\.{""}$}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{boolean} \\{mp\_open\_mem\_name}(\&{MP} \\{mp});\6
\&{static} \&{boolean} \\{mp\_open\_mem\_file}(\&{MP} \\{mp});\par
\fi

\M{857}\B\&{boolean} \\{mp\_open\_mem\_name}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{mem\_name}\I\NULL){}$\5
${}\{{}$\1\6
\&{size\_t} \|l${}\K\\{strlen}(\\{mp}\MG\\{mem\_name});{}$\6
\&{char} ${}{*}\|s\K\\{xstrdup}(\\{mp}\MG\\{mem\_name});{}$\7
\&{if} ${}(\|l>\T{4}){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\\{test}\K\\{strstr}(\|s,\39\.{".mp"});{}$\7
\&{if} ${}(\\{test}\E\NULL\V\\{test}\I\|s+\|l-\T{4}){}$\5
${}\{{}$\1\6
${}\|s\K\\{xrealloc}(\|s,\39\|l+\T{5},\39\T{1});{}$\6
${}\\{strcat}(\|s,\39\.{".mp"});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|s\K\\{xrealloc}(\|s,\39\|l+\T{5},\39\T{1});{}$\6
${}\\{strcat}(\|s,\39\.{".mp"});{}$\6
\4${}\}{}$\2\6
${}\|s\K(\\{mp}\MG\\{find\_file})(\\{mp},\39\|s,\39\.{"r"},\39\\{mp\_filetype%
\_program});{}$\6
${}\\{xfree}(\\{mp}\MG\\{name\_of\_file});{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} \\{false};\2\6
${}\\{mp}\MG\\{name\_of\_file}\K\\{xstrdup}(\|s);{}$\6
${}\\{mp}\MG\\{mem\_file}\K(\\{mp}\MG\\{open\_file})(\\{mp},\39\|s,\39\.{"r"},%
\39\\{mp\_filetype\_program});{}$\6
\\{free}(\|s);\6
\&{if} ${}(\\{mp}\MG\\{mem\_file}){}$\1\5
\&{return} \\{true};\2\6
\4${}\}{}$\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\7
\&{boolean} \\{mp\_open\_mem\_file}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{mem\_file}\I\NULL){}$\1\5
\&{return} \\{true};\2\6
\&{if} (\\{mp\_open\_mem\_name}(\\{mp}))\1\5
\&{return} \\{true};\2\6
\&{if} ${}(\\{mp\_xstrcmp}(\\{mp}\MG\\{mem\_name},\39\.{"plain"})){}$\5
${}\{{}$\1\6
\\{wake\_up\_terminal}(\,);\6
\\{wterm}(\.{"Sorry,\ I\ can\\'t\ fin}\)\.{d\ the\ '"});\6
${}\\{wterm}(\\{mp}\MG\\{mem\_name});{}$\6
\\{wterm}(\.{"'\ preload\ file;\ wil}\)\.{l\ try\ 'plain'."});\6
\\{wterm\_cr};\6
;\6
\\{update\_terminal}(\,);\C{ now pull out all the stops: try for the system %
\.{plain} file }\6
${}\\{xfree}(\\{mp}\MG\\{mem\_name});{}$\6
${}\\{mp}\MG\\{mem\_name}\K\\{xstrdup}(\.{"plain"});{}$\6
\&{if} (\\{mp\_open\_mem\_name}(\\{mp}))\1\5
\&{return} \\{true};\2\6
\4${}\}{}$\2\6
\\{wake\_up\_terminal}(\,);\6
\\{wterm\_ln}(\.{"I\ can't\ find\ the\ 'p}\)\.{lain'\ preload\ file!\\}\)%
\.{n"});\6
;\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M{858}Operating systems often make it possible to determine the exact name
(and
possible version number) of a file that has been opened. The following routine,
which simply makes a \MP\ string from the value of \PB{\\{name\_of\_file}},
should
ideally be changed to deduce the full name of file~\PB{\|f}, which is the file
most recently opened, if it is possible to do this.

\fi

\M{859}\B\&{static} \&{mp\_string} \\{mp\_make\_name\_string}(\&{MP} \\{mp})\1%
\1\2\2\6
${}\{{}$\1\6
\&{int} \|k;\C{ index into \PB{\\{name\_of\_file}} }\6
\&{int} \\{name\_length}${}\K{}$(\&{int}) \\{strlen}${}(\\{mp}\MG\\{name\_of%
\_file});{}$\7
\\{str\_room}(\\{name\_length});\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{name\_length};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\\{append\_char}(\\{xord}((\&{ASCII\_code}) \\{mp}${}\MG\\{name\_of\_file}[%
\|k]));{}$\6
\4${}\}{}$\2\6
\&{return} \\{mp\_make\_string}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{860}Now let's consider the ``driver''
routines by which \MP\ deals with file names
in a system-independent manner.  First comes a procedure that looks for a
file name in the input by taking the information from the input buffer.
(We can't use \PB{\\{get\_next}}, because the conversion to tokens would
destroy necessary information.)

This procedure doesn't allow semicolons or percent signs to be part of
file names, because of other conventions of \MP.
{\sl The {\logos METAFONT\/}book} doesn't
use semicolons or percents immediately after file names, but some users
no doubt will find it natural to do so; therefore system-dependent
changes to allow such characters in file names should probably
be made with reluctance, and only when an entire file name that
includes special characters is ``quoted'' somehow.

\Y\B\&{static} \&{void} \\{mp\_scan\_file\_name}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_begin\_name}(\\{mp});\6
\&{while} ${}(\\{mp}\MG\\{buffer}[\\{loc}]\E\.{'\ '}){}$\1\5
\\{incr}(\\{loc});\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}((\\{mp}\MG\\{buffer}[\\{loc}]\E\.{';'})\V(\\{mp}\MG\\{buffer}[%
\\{loc}]\E\.{'\%'})){}$\1\5
\&{break};\2\6
\&{if} ${}(\R\\{mp\_more\_name}(\\{mp},\39\\{mp}\MG\\{buffer}[\\{loc}])){}$\1\5
\&{break};\2\6
\\{incr}(\\{loc});\6
\4${}\}{}$\2\6
\\{mp\_end\_name}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{861}Here is another version that takes its input from a string.

\Y\B\4\X861:Declare subroutines for parsing file names\X${}\E{}$\6
\&{void} \\{mp\_str\_scan\_file}(\&{MP} \\{mp}${},\39{}$\&{mp\_string} \|s);\par
\A863.
\U10.\fi

\M{862}\B\&{void} \\{mp\_str\_scan\_file}(\&{MP} \\{mp}${},\39{}$\&{mp\_string}
\|s)\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|p${},{}$ \|q;\C{ current position and stopping point }\7
\\{mp\_begin\_name}(\\{mp});\6
${}\|p\K\T{0};{}$\6
${}\|q\K\|s\MG\\{len};{}$\6
\&{while} ${}(\|p<\|q){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_more\_name}(\\{mp},\39{*}(\|s\MG\\{str}+\|p))){}$\1\5
\&{break};\2\6
\\{incr}(\|p);\6
\4${}\}{}$\2\6
\\{mp\_end\_name}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{863}And one that reads from a \PB{\&{char} ${}{*}$}.

\Y\B\4\X861:Declare subroutines for parsing file names\X${}\mathrel+\E{}$\6
\&{extern} \&{void} \\{mp\_ptr\_scan\_file}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|s){}$;\par
\fi

\M{864}\B\&{void} \\{mp\_ptr\_scan\_file}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|p,{}$ ${}{*}\|q{}$;\C{ current position and stopping point }\7
\\{mp\_begin\_name}(\\{mp});\6
${}\|p\K\|s;{}$\6
${}\|q\K\|p+\\{strlen}(\|s);{}$\6
\&{while} ${}(\|p<\|q){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_more\_name}(\\{mp},\39(\&{ASCII\_code})({*}\|p))){}$\1\5
\&{break};\2\6
${}\|p\PP;{}$\6
\4${}\}{}$\2\6
\\{mp\_end\_name}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{865}The option variable \PB{\\{job\_name}} contains the file name that was
first
\&{input} by the user. This name is used to initialize the \PB{\\{job\_name}}
global
as well as the \PB{\\{mp\_job\_name}} internal, and is extended by `\.{.log}'
and
`\.{ps}' and `\.{.mem}' and `\.{.tfm}' in order to make the names of \MP's
output files.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{log\_opened};\C{ has the transcript file been opened? }\6
\&{char} ${}{*}\\{log\_name}{}$;\C{ full name of the log file }\par
\fi

\M{866}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{job\_name}{}$;\C{ principal file name }\par
\fi

\M{867}Initially \PB{$\\{job\_name}\K\NULL$}; it becomes nonzero as soon as the
true name is known.
We have \PB{$\\{job\_name}\K\NULL$} if and only if the `\.{log}' file has not
been opened,
except of course for a short time just after \PB{\\{job\_name}} has become
nonzero.

\Y\B\4\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{job\_name}\K\\{mp\_xstrdup}(\\{mp},\39\\{opt}\MG\\{job\_name}){}$;%
\C{ if (mp->job\_name != NULL) {   char *s = mp->job\_name + strlen
(mp->job\_name);   while (s > mp->job\_name) {     if (*s == '.') {       *s = '%
\\0';     }     s--;   } } }\6
\&{if} ${}(\\{opt}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\1\5
${}\\{mp}\MG\\{job\_name}\K\\{mp\_xstrdup}(\\{mp},\39\\{mp}\MG\\{mem%
\_name});{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{log\_opened}\K\\{false}{}$;\par
\fi

\M{868}Cannot do this earlier because at the \PB{$<$ \\{Allocate} ${\Xor}\,%
\ldots\,$ $>$}, the string
pool is not yet initialized.

\Y\B\4\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{internal\_string}(\\{mp\_job\_name})\I\T{0}){}$\1\5
\\{delete\_str\_ref}(\\{internal\_string}(\\{mp\_job\_name}));\2\6
${}\\{set\_internal\_string}(\\{mp\_job\_name},\39\\{mp\_rts}(\\{mp},\39\\{mp}%
\MG\\{job\_name}));{}$\6
\4${}\}{}$\2\par
\Us16, 875, 880, 1066\ETs1251.\fi

\M{869}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{job\_name}){}$;\par
\fi

\M{870}Here is a routine that manufactures the output file names, assuming that
\PB{$\\{job\_name}\MRL{{<}{>}}\T{0}$}. It ignores and changes the current
settings of \PB{\\{cur\_area}}
and \PB{\\{cur\_ext}}.

\Y\B\4\D$\\{pack\_cur\_name}$ \5
$\\{mp\_pack\_file\_name}(\\{mp},\39\\{mp}\MG\\{cur\_name},\39\\{mp}\MG\\{cur%
\_area},\39\\{mp}\MG\\{cur\_ext}{}$)\par
\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_pack\_job\_name}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\|s){}$;\par
\fi

\M{871}\B\&{void} \\{mp\_pack\_job\_name}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\C{ \PB{$\|s\K\.{".log"}$}, \PB{\.{".mem"}}, \PB{\.{".ps"}}, or .%
\\{nnn} }\1\6
${}\\{xfree}(\\{mp}\MG\\{cur\_name});{}$\6
${}\\{mp}\MG\\{cur\_name}\K\\{xstrdup}(\\{mp}\MG\\{job\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_area});{}$\6
${}\\{mp}\MG\\{cur\_area}\K\\{xstrdup}(\.{""});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_ext});{}$\6
${}\\{mp}\MG\\{cur\_ext}\K\\{xstrdup}(\|s);{}$\6
\\{pack\_cur\_name};\6
\4${}\}{}$\2\par
\fi

\M{872}If some trouble arises when \MP\ tries to open a file, the following
routine calls upon the user to supply another file name. Parameter~\PB{\|s}
is used in the error message to identify the type of file; parameter~\PB{\|e}
is the default extension if none is given. Upon exit from the routine,
variables \PB{\\{cur\_name}}, \PB{\\{cur\_area}}, \PB{\\{cur\_ext}}, and \PB{%
\\{name\_of\_file}} are
ready for another attempt at file opening.

\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_prompt\_file\_name}(\&{MP} \\{mp}${},\39{}$\&{const} \&{char}
${}{*}\|s,\39{}$\&{const} \&{char} ${}{*}\|e){}$;\par
\fi

\M{873}\B\&{void} \\{mp\_prompt\_file\_name}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s,\39{}$\&{const} \&{char} ${}{*}\|e){}$\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|k;\C{ index into \PB{\\{buffer}} }\6
\&{char} ${}{*}\\{saved\_cur\_name};{}$\7
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_scroll\_mode}){}$\1\5
\\{wake\_up\_terminal}(\,);\2\6
\&{if} ${}(\\{strcmp}(\|s,\39\.{"input\ file\ name"})\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_err}(\\{mp},\39\.{"I\ can\\'t\ open\ file\ }\)\.{`"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_err}(\\{mp},\39\.{"I\ can\\'t\ write\ on\ f}\)\.{ile\ `"});{}$%
\6
\4${}\}{}$\2\6
\&{if} ${}(\\{strcmp}(\|s,\39\.{"file\ name\ for\ outpu}\)\.{t"})\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{name\_of\_file});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_file\_name}(\\{mp},\39\\{mp}\MG\\{cur\_name},\39\\{mp}\MG%
\\{cur\_area},\39\\{mp}\MG\\{cur\_ext});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"'."});{}$\6
\&{if} ${}(\\{strcmp}(\|e,\39\.{""})\E\T{0}){}$\1\5
\\{mp\_show\_context}(\\{mp});\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Please\ type\ another}\)\.{\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\|s);{}$\6
;\6
\&{if} ${}(\\{mp}\MG\\{noninteractive}\V\\{mp}\MG\\{interaction}<\\{mp\_scroll%
\_mode}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"***\ (job\ aborted,\ f}\)\.{ile\ error\
in\ nonstop}\)\.{\ mode)"});{}$\2\6
;\6
${}\\{saved\_cur\_name}\K\\{xstrdup}(\\{mp}\MG\\{cur\_name});{}$\6
\\{clear\_terminal}(\,);\6
\\{prompt\_input}(\.{":\ "});\6
\X874:Scan file name in the buffer\X;\6
\&{if} ${}(\\{strcmp}(\\{mp}\MG\\{cur\_ext},\39\.{""})\E\T{0}){}$\1\5
${}\\{mp}\MG\\{cur\_ext}\K\\{xstrdup}(\|e);{}$\2\6
\&{if} ${}(\\{strlen}(\\{mp}\MG\\{cur\_name})\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_name}\K\\{saved\_cur\_name};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{xfree}(\\{saved\_cur\_name});\6
\4${}\}{}$\2\6
\\{pack\_cur\_name};\6
\4${}\}{}$\2\par
\fi

\M{874}\B\X874:Scan file name in the buffer\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_begin\_name}(\\{mp});\6
${}\|k\K\\{mp}\MG\\{first};{}$\6
\&{while} ${}((\\{mp}\MG\\{buffer}[\|k]\E\.{'\ '})\W(\|k<\\{mp}\MG\\{last})){}$%
\1\5
\\{incr}(\|k);\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\|k\E\\{mp}\MG\\{last}){}$\1\5
\&{break};\2\6
\&{if} ${}(\R\\{mp\_more\_name}(\\{mp},\39\\{mp}\MG\\{buffer}[\|k])){}$\1\5
\&{break};\2\6
\\{incr}(\|k);\6
\4${}\}{}$\2\6
\\{mp\_end\_name}(\\{mp});\6
\4${}\}{}$\2\par
\U873.\fi

\M{875}The \PB{\\{open\_log\_file}} routine is used to open the transcript file
and to help
it catch up to what has previously been printed on the terminal.

\Y\B\&{void} \\{mp\_open\_log\_file}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \\{old\_setting};\C{ previous \PB{\\{selector}} setting }\6
\&{int} \|k;\C{ index into \PB{\\{months}} and \PB{\\{buffer}} }\6
\&{int} \|l;\C{ end of first input line }\6
\&{integer} \|m;\C{ the current month }\6
\&{const} \&{char} ${}{*}\\{months}\K\.{"JANFEBMARAPRMAYJUNJ}\)%
\.{ULAUGSEPOCTNOVDEC"}{}$;\C{ abbreviations of month names }\7
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
\&{return};\2\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{job\_name}\K\\{xstrdup}(\.{"mpout"});{}$\6
\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X;\6
\4${}\}{}$\2\6
${}\\{mp\_pack\_job\_name}(\\{mp},\39\.{".log"});{}$\6
\&{while} ${}(\R\\{mp\_open\_out}(\\{mp},\39{\AND}\\{mp}\MG\\{log\_file},\39%
\\{mp\_filetype\_log})){}$\5
${}\{{}$\1\6
\X877:Try to get a different log file name\X;\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{log\_name}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
${}\\{mp}\MG\\{selector}\K\\{log\_only};{}$\6
${}\\{mp}\MG\\{log\_opened}\K\\{true};{}$\6
\X878:Print the banner line, including the date and time\X;\6
${}\\{mp}\MG\\{input\_stack}[\\{mp}\MG\\{input\_ptr}]\K\\{mp}\MG\\{cur%
\_input}{}$;\C{ make sure bottom level is in memory }\6
\&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"**"});{}$\6
;\6
${}\|l\K\\{mp}\MG\\{input\_stack}[\T{0}].\\{limit\_field}-\T{1}{}$;\C{ last
position of first line }\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\|l;{}$ ${}\|k\PP){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{mp}\MG\\{buffer}[\|k]);{}$\2\6
\\{mp\_print\_ln}(\\{mp});\C{ now the transcript file contains the first line
of input }\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting}+\T{2}{}$;\C{ \PB{\\{log\_only}} or %
\PB{\\{term\_and\_log}} }\6
\4${}\}{}$\2\par
\fi

\M{876}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{log\_name}){}$;\par
\fi

\M{877}Sometimes \PB{\\{open\_log\_file}} is called at awkward moments when \MP%
\ is
unable to print error messages or even to \PB{\\{show\_context}}.
The \PB{\\{prompt\_file\_name}} routine can result in a \PB{\\{fatal\_error}},
but the \PB{\&{error}}
routine will not be invoked because \PB{\\{log\_opened}} will be false.

The normal idea of \PB{\\{mp\_batch\_mode}} is that nothing at all should be
written
on the terminal. However, in the unusual case that
no log file could be opened, we make an exception and allow
an explanatory message to be seen.

Incidentally, the program always refers to the log file as a `\.{transcript
file}', because some systems cannot use the extension `\.{.log}' for
this file.

\Y\B\4\X877:Try to get a different log file name\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
${}\\{mp\_prompt\_file\_name}(\\{mp},\39\.{"transcript\ file\ nam}\)\.{e"},\39%
\.{".log"});{}$\6
\4${}\}{}$\2\par
\U875.\fi

\M{878}\B\X878:Print the banner line, including the date and time\X${}\E{}$\6
${}\{{}$\1\6
${}\\{wlog}(\\{mp}\MG\\{banner});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ \ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{round\_unscaled}(\\{internal\_value}(\\{mp%
\_day})));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\6
${}\|m\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_month}));{}$\6
\&{for} ${}(\|k\K\T{3}*\|m-\T{3};{}$ ${}\|k<\T{3}*\|m;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\\{wlog\_chr}((\&{unsigned} \&{char}) \\{months}[\|k]);\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{round\_unscaled}(\\{internal\_value}(\\{mp%
\_year})));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\6
${}\\{mp\_print\_dd}(\\{mp},\39\\{round\_unscaled}(\\{internal\_value}(\\{mp%
\_hour})));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{':'}));{}$\6
${}\\{mp\_print\_dd}(\\{mp},\39\\{round\_unscaled}(\\{internal\_value}(\\{mp%
\_minute})));{}$\6
\4${}\}{}$\2\par
\U875.\fi

\M{879}The \PB{\\{try\_extension}} function tries to open an input file
determined by
\PB{\\{cur\_name}}, \PB{\\{cur\_area}}, and the argument \PB{\\{ext}}.  It
returns \PB{\\{false}} if it
can't find the file in \PB{\\{cur\_area}} or the appropriate system area.

\Y\B\&{static} \&{boolean} \\{mp\_try\_extension}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{ext}){}$\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{mp}\MG\\{cur\_name},\39\\{mp}\MG\\{cur%
\_area},\39\\{ext});{}$\6
${}\\{in\_name}\K\\{xstrdup}(\\{mp}\MG\\{cur\_name});{}$\6
${}\\{in\_area}\K\\{xstrdup}(\\{mp}\MG\\{cur\_area});{}$\6
${}\\{in\_ext}\K\\{xstrdup}(\\{ext});{}$\6
\&{if} ${}(\\{mp\_open\_in}(\\{mp},\39{\AND}\\{cur\_file},\39\\{mp\_filetype%
\_program})){}$\5
${}\{{}$\1\6
\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{mp}\MG\\{cur\_name},\39\NULL,\39%
\\{ext});{}$\6
\&{return} \\{mp\_open\_in}${}(\\{mp},\39{\AND}\\{cur\_file},\39\\{mp\_filetype%
\_program});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{880}Let's turn now to the procedure that is used to initiate file reading
when an `\.{input}' command is being processed.

\Y\B\&{void} \\{mp\_start\_input}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ \MP\ will \.{input} something }\1\6
\&{char} ${}{*}\\{fname}\K\NULL;{}$\7
\X883:Put the desired file name in \PB{$(\\{cur\_name},\\{cur\_ext},\\{cur%
\_area})$}\X;\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{mp\_begin\_file\_reading}(\\{mp});\C{ set up \PB{\\{cur\_file}} and new
level of input }\6
\&{if} ${}(\\{strlen}(\\{mp}\MG\\{cur\_ext})\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_try\_extension}(\\{mp},\39\.{".mp"})){}$\1\5
\&{break};\2\6
\&{else} \&{if} ${}(\\{mp\_try\_extension}(\\{mp},\39\.{""})){}$\1\5
\&{break};\2\6
\&{else} \&{if} ${}(\\{mp\_try\_extension}(\\{mp},\39\.{".mf"})){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_try\_extension}(\\{mp},\39\\{mp}\MG\\{cur\_ext})){}$%
\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
\\{mp\_end\_file\_reading}(\\{mp});\C{ remove the level that didn't work }\6
${}\\{mp\_prompt\_file\_name}(\\{mp},\39\.{"input\ file\ name"},\39\.{""});{}$\6
\4${}\}{}$\2\6
${}\\{name}\K\\{mp\_make\_name\_string}(\\{mp});{}$\6
${}\\{fname}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{job\_name}\K\\{xstrdup}(\\{mp}\MG\\{cur\_name});{}$\6
\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{mp}\MG\\{log\_opened}){}$\5
${}\{{}$\1\6
\\{mp\_open\_log\_file}(\\{mp});\6
\4${}\}{}$\C{ \PB{\\{open\_log\_file}} doesn't \PB{\\{show\_context}}, so \PB{%
\\{limit}}                                    and \PB{\\{loc}} needn't be set
to meaningful values yet }\2\6
\&{if} (((\&{int}) \\{mp}${}\MG\\{term\_offset}+{}$(\&{int}) \\{strlen}(%
\\{fname}))${}>(\\{mp}\MG\\{max\_print\_line}-\T{2})){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{term\_offset}>\T{0})\V(\\{mp}\MG\\{file%
\_offset}>\T{0})){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{incr}(\\{mp}\MG\\{open\_parens});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{fname});{}$\6
\\{xfree}(\\{fname});\6
\\{update\_terminal}(\,);\6
\X881:Flush \PB{\\{name}} and replace it with \PB{\\{cur\_name}} if it won't be
needed\X;\6
\X882:Read the first line of the new file\X;\6
\4${}\}{}$\2\par
\fi

\M{881}This code should be omitted if \PB{\\{make\_name\_string}} returns
something other
than just a copy of its argument and the full file name is needed for opening
\.{MPX} files or implementing the switch-to-editor option.

\Y\B\4\X881:Flush \PB{\\{name}} and replace it with \PB{\\{cur\_name}} if it
won't be needed\X${}\E{}$\6
$\\{mp\_flush\_string}(\\{mp},\39\\{name});{}$\6
${}\\{name}\K\\{mp\_rts}(\\{mp},\39\\{mp}\MG\\{cur\_name});$ $\\{xfree}(\\{mp}%
\MG\\{cur\_name}{}$)\par
\U880.\fi

\M{882}If the file is empty, it is considered to contain a single blank line,
so there is no need to test the return value.

\Y\B\4\X882:Read the first line of the new file\X${}\E{}$\6
$\{$ \&{line} $\K$ \T{1};\6
(\&{void}) \\{mp\_input\_ln}${}(\\{mp},\39\\{cur\_file});{}$\6
\\{mp\_firm\_up\_the\_line}(\\{mp});\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};$ $\}{}$\par
\Us880\ET884.\fi

\M{883}\B\X883:Put the desired file name in \PB{$(\\{cur\_name},\\{cur\_ext},%
\\{cur\_area})$}\X${}\E{}$\6
\&{while} ${}(\\{token\_state}\W(\\{nloc}\E\NULL)){}$\1\5
\\{mp\_end\_token\_list}(\\{mp});\2\6
\&{if} (\\{token\_state})\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Sorry...I've\ conver}\)\.{ted\ what%
\ follows\ to\ }\)\.{tokens,"},\39\.{"possibly\ garbaging\ }\)\.{the\ name\ you%
\ gave."},\39\.{"Please\ delete\ the\ t}\)\.{okens\ and\ insert\ the}\)\.{\
name\ again."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"File\ names\ can't\ ap}\)\.{pear\ within\
macros"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\&{if} (\\{file\_state})\5
${}\{{}$\1\6
\\{mp\_scan\_file\_name}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{cur\_name});{}$\6
${}\\{mp}\MG\\{cur\_name}\K\\{xstrdup}(\.{""});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_ext});{}$\6
${}\\{mp}\MG\\{cur\_ext}\K\\{xstrdup}(\.{""});{}$\6
${}\\{xfree}(\\{mp}\MG\\{cur\_area});{}$\6
${}\\{mp}\MG\\{cur\_area}\K\\{xstrdup}(\.{""});{}$\6
\4${}\}{}$\2\par
\U880.\fi

\M{884}The following simple routine starts reading the \.{MPX} file associated
with the current input file.

\Y\B\&{void} \\{mp\_start\_mpx\_input}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\\{origname}\K\NULL{}$;\C{ a copy of nameoffile }\7
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{in\_name},\39\\{in\_area},\39\\{in%
\_ext});{}$\6
${}\\{origname}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{in\_name},\39\\{in\_area},\39%
\.{".mpx"});{}$\6
\&{if} ${}(\R(\\{mp}\MG\\{run\_make\_mpx})(\\{mp},\39\\{origname},\39\\{mp}\MG%
\\{name\_of\_file})){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\\{mp\_begin\_file\_reading}(\\{mp});\6
\&{if} ${}(\R\\{mp\_open\_in}(\\{mp},\39{\AND}\\{cur\_file},\39\\{mp\_filetype%
\_program})){}$\5
${}\{{}$\1\6
\\{mp\_end\_file\_reading}(\\{mp});\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
${}\\{name}\K\\{mp\_make\_name\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{mpx\_name}[\\{iindex}]\K\\{name};{}$\6
\\{add\_str\_ref}(\\{name});\6
\X882:Read the first line of the new file\X;\6
\\{xfree}(\\{origname});\6
\&{return};\6
\4\.{NOT\_FOUND}:\5
\X891:Explain that the \.{MPX} file can't be read and \PB{\\{succumb}}\X;\6
\\{xfree}(\\{origname});\6
\4${}\}{}$\2\par
\fi

\M{885}This should ideally be changed to do whatever is necessary to create the
\.{MPX} file given by \PB{\\{name\_of\_file}} if it does not exist or if it is
out
of date.  This requires invoking \.{MPtoTeX} on the \PB{\\{origname}} and
passing
the results through \TeX\ and \.{DVItoMP}.  (It is possible to use a
completely different typesetting program if suitable postprocessor is
available to perform the function of \.{DVItoMP}.)

\fi

\M{886}\B\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} ${}\&{int}({*}\\{mp\_makempx\_cmd}){}$(\&{MP} \\{mp}${},\39{}$%
\&{char} ${}{*}\\{origname},\39{}$\&{char} ${}{*}\\{mtxname}){}$;\par
\fi

\M{887}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\\{mp\_makempx\_cmd}\\{run\_make\_mpx};\par
\fi

\M{888}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
\\{set\_callback\_option}(\\{run\_make\_mpx});\par
\fi

\M{889}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{int} \\{mp\_run\_make\_mpx}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\\{origname},\39{}$\&{char} ${}{*}\\{mtxname}){}$;\par
\fi

\M{890}The default does nothing.
\Y\B\&{int} \\{mp\_run\_make\_mpx}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}%
\\{origname},\39{}$\&{char} ${}{*}\\{mtxname}){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
(\&{void}) \\{origname};\6
(\&{void}) \\{mtxname};\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M{891}\B\X891:Explain that the \.{MPX} file can't be read and \PB{\\{succumb}}%
\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ two\ files\ given}\)\.{\ above%
\ are\ one\ of\ yo}\)\.{ur\ source\ files"},\39\.{"and\ an\ auxiliary\ fi}\)%
\.{le\ I\ need\ to\ read\ to}\)\.{\ find\ out\ what\ your"},\39\.{"btex..etex\
blocks\ m}\)\.{ean.\ If\ you\ don't\ kn}\)\.{ow\ why\ I\ had\ trouble}\)\.{,"},%
\39\.{"try\ running\ it\ manu}\)\.{ally\ through\ MPtoTeX}\)\.{,\ TeX,\ and\
DVItoMP"},\39\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
\\{wake\_up\_terminal}(\,);\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{">>\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{origname});{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{">>\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{name\_of\_file});{}$\6
\\{xfree}(\\{origname});\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{interaction}\K\\{mp\_scroll\_mode}{}$;\C{ no more interaction }%
\2\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp\_error}(\\{mp},\39\.{"!\ Unable\ to\ make\ mp}\)\.{x\ file"},\39%
\\{hlp},\39\\{true});{}$\2\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\\{mp\_jump\_out}(\\{mp});\C{ irrecoverable error }\6
\4${}\}{}$\2\par
\U884.\fi

\M{892}The last file-opening commands are for files accessed via the %
\&{readfrom}
operator and the \&{write} command.  Such files are stored in separate arrays.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{unsigned} \&{int} \&{readf\_index};\C{ \PB{\T{0..}\\{max\_read%
\_files}} }\6
\&{typedef} \&{unsigned} \&{int} \&{write\_index};\C{ \PB{\T{0..}\\{max\_write%
\_files}} }\par
\fi

\M{893}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{readf\_index} \\{max\_read\_files};\C{ maximum number of simultaneously open
\&{readfrom} files }\6
\&{void} ${}{*}{*}\\{rd\_file}{}$;\C{ \&{readfrom} files }\6
\&{char} ${}{*}{*}\\{rd\_fname}{}$;\C{ corresponding file name or 0 if file not
open }\6
\&{readf\_index} \\{read\_files};\C{ number of valid entries in the above
arrays }\6
\&{write\_index} \\{max\_write\_files};\C{ maximum number of simultaneously
open \&{write} }\6
\&{void} ${}{*}{*}\\{wr\_file}{}$;\C{ \&{write} files }\6
\&{char} ${}{*}{*}\\{wr\_fname}{}$;\C{ corresponding file name or 0 if file not
open }\6
\&{write\_index} \\{write\_files};\C{ number of valid entries in the above
arrays }\par
\fi

\M{894}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{max\_read\_files}\K\T{8};{}$\6
${}\\{mp}\MG\\{rd\_file}\K\\{xmalloc}((\\{mp}\MG\\{max\_read\_files}+\T{1}),%
\39{}$\&{sizeof}(\&{void} ${}{*}));{}$\6
${}\\{mp}\MG\\{rd\_fname}\K\\{xmalloc}((\\{mp}\MG\\{max\_read\_files}+\T{1}),%
\39{}$\&{sizeof}(\&{char} ${}{*}));{}$\6
${}\\{memset}(\\{mp}\MG\\{rd\_fname},\39\T{0},\39{}$\&{sizeof}(\&{char}
${}{*})*(\\{mp}\MG\\{max\_read\_files}+\T{1}));{}$\6
${}\\{mp}\MG\\{max\_write\_files}\K\T{8};{}$\6
${}\\{mp}\MG\\{wr\_file}\K\\{xmalloc}((\\{mp}\MG\\{max\_write\_files}+\T{1}),%
\39{}$\&{sizeof}(\&{void} ${}{*}));{}$\6
${}\\{mp}\MG\\{wr\_fname}\K\\{xmalloc}((\\{mp}\MG\\{max\_write\_files}+\T{1}),%
\39{}$\&{sizeof}(\&{char} ${}{*}));{}$\6
${}\\{memset}(\\{mp}\MG\\{wr\_fname},\39\T{0},\39{}$\&{sizeof}(\&{char}
${}{*})*(\\{mp}\MG\\{max\_write\_files}+\T{1})){}$;\par
\fi

\M{895}This routine starts reading the file named by string~\PB{\|s} without
setting
\PB{\\{loc}}, \PB{\\{limit}}, or \PB{\\{name}}.  It returns \PB{\\{false}} if
the file is empty or cannot
be opened.  Otherwise it updates \PB{\\{rd\_file}[\|n]} and \PB{\\{rd\_fname}[%
\|n]}.

\Y\B\&{static} \&{boolean} \\{mp\_start\_read\_input}(\&{MP} \\{mp}${},\39{}$%
\&{char} ${}{*}\|s,\39{}$\&{readf\_index} \|n)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_ptr\_scan\_file}(\\{mp},\39\|s);{}$\6
\\{pack\_cur\_name};\6
\\{mp\_begin\_file\_reading}(\\{mp});\6
\&{if} ${}(\R\\{mp\_open\_in}(\\{mp},\39{\AND}\\{mp}\MG\\{rd\_file}[\|n],\39(%
\&{int})(\\{mp\_filetype\_text}+\|n))){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{if} ${}(\R\\{mp\_input\_ln}(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|n])){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|n]);{}$\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{rd\_fname}[\|n]\K\\{xstrdup}(\|s);{}$\6
\&{return} \\{true};\6
\4\.{NOT\_FOUND}:\5
\\{mp\_end\_file\_reading}(\\{mp});\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M{896}Open \PB{\\{wr\_file}[\|n]} using file name~\PB{\|s} and update \PB{%
\\{wr\_fname}[\|n]}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_open\_write\_file}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|s,\39{}$\&{readf\_index} \|n);\par
\fi

\M{897}\B\&{void} \\{mp\_open\_write\_file}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|s,\39{}$\&{readf\_index} \|n)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_ptr\_scan\_file}(\\{mp},\39\|s);{}$\6
\\{pack\_cur\_name};\6
\&{while} ${}(\R\\{mp\_open\_out}(\\{mp},\39{\AND}\\{mp}\MG\\{wr\_file}[\|n],%
\39(\&{int})(\\{mp\_filetype\_text}+\|n))){}$\1\5
${}\\{mp\_prompt\_file\_name}(\\{mp},\39\.{"file\ name\ for\ write}\)\.{\
output"},\39\.{""});{}$\2\6
${}\\{mp}\MG\\{wr\_fname}[\|n]\K\\{xstrdup}(\|s);{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{898}Introduction to the parsing routines.
We come now to the central nervous system that sparks many of \MP's activities.
By evaluating expressions, from their primary constituents to ever larger
subexpressions, \MP\ builds the structures that ultimately define complete
pictures or fonts of type.

Four mutually recursive subroutines are involved in this process: We call them
$$\hbox{\PB{\\{scan\_primary}}, \PB{\\{scan\_secondary}}, \PB{\\{scan%
\_tertiary}},
and \PB{\\{scan\_expression}}.}$$
Each of them is parameterless and begins with the first token to be scanned
already represented in \PB{\\{cur\_cmd}}, \PB{\\{cur\_mod}}, and \PB{\\{cur%
\_sym}}. After execution,
the value of the primary or secondary or tertiary or expression that was
found will appear in the global variables \PB{\\{cur\_type}} and \PB{\\{cur%
\_exp}}. The
token following the expression will be represented in \PB{\\{cur\_cmd}}, \PB{%
\\{cur\_mod}},
and \PB{\\{cur\_sym}}.

Technically speaking, the parsing algorithms are ``LL(1),'' more or less;
backup mechanisms have been added in order to provide reasonable error
recovery.

\Y\B\4\D$\\{cur\_exp\_value\_boolean}()$ \5
$\\{number\_to\_int}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n{}$)\par
\B\4\D$\\{cur\_exp\_value\_number}()$ \5
$\\{mp}\MG\\{cur\_exp}.\\{data}.{}$\|n\par
\B\4\D$\\{cur\_exp\_node}()$ \5
$\\{mp}\MG\\{cur\_exp}.\\{data}.{}$\\{node}\par
\B\4\D$\\{cur\_exp\_str}()$ \5
$\\{mp}\MG\\{cur\_exp}.\\{data}.{}$\\{str}\par
\B\4\D$\\{cur\_exp\_knot}()$ \5
$\\{mp}\MG\\{cur\_exp}.\\{data}.{}$\|p\par
\B\4\D$\\{set\_cur\_exp\_value\_scaled}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_scaled}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n,\39(%
\|A));{}$\6
${}\\{cur\_exp\_node}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_str}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_knot}(\,)\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_cur\_exp\_value\_boolean}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_int}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n,\39(\|A));{}$\6
${}\\{cur\_exp\_node}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_str}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_knot}(\,)\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_cur\_exp\_value\_number}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n,\39(\|A));{}$\6
${}\\{cur\_exp\_node}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_str}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_knot}(\,)\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_cur\_exp\_node}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{cur\_exp\_node}(\,)\K\|A;{}$\6
${}\\{cur\_exp\_str}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_knot}(\,)\K\NULL;{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_cur\_exp\_str}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{cur\_exp\_str}(\,)\K\|A;{}$\6
\\{add\_str\_ref}(\\{cur\_exp\_str}(\,));\6
${}\\{cur\_exp\_node}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_knot}(\,)\K\NULL;{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_cur\_exp\_knot}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\4${}\}{}$\2\6
${}\\{cur\_exp\_knot}(\,)\K\|A;{}$\6
${}\\{cur\_exp\_node}(\,)\K\NULL;{}$\6
${}\\{cur\_exp\_str}(\,)\K\NULL;{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\fi

\M{899}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_value} \\{cur\_exp};\C{ the value of the expression just found }\par
\fi

\M{900}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{memset}({\AND}\\{mp}\MG\\{cur\_exp}.\\{data},\39\T{0},\39\&{sizeof}(\&{mp%
\_value}));{}$\6
${}\\{new\_number}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n){}$;\par
\fi

\M{901}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n){}$;\par
\fi

\M{902}Many different kinds of expressions are possible, so it is wise to have
precise descriptions of what \PB{\\{cur\_type}} and \PB{\\{cur\_exp}} mean in
all cases:

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_vacuous}$} means that this expression didn't turn
out to have a
value at all, because it arose from a \&{begingroup}$\,\ldots\,$\&{endgroup}
construction in which there was no expression before the \&{endgroup}.
In this case \PB{\\{cur\_exp}} has some irrelevant value.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_boolean\_type}$} means that \PB{\\{cur\_exp}} is
either \PB{\\{true\_code}}
or \PB{\\{false\_code}}.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_unknown\_boolean}$} means that \PB{\\{cur\_exp}}
points to a capsule
node that is in
a ring of equivalent booleans whose value has not yet been defined.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_string\_type}$} means that \PB{\\{cur\_exp}} is a
string number (i.e., an
integer in the range \PB{$\T{0}\Z\\{cur\_exp}<\\{str\_ptr}$}). That string's
reference count
includes this particular reference.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_unknown\_string}$} means that \PB{\\{cur\_exp}}
points to a capsule
node that is in
a ring of equivalent strings whose value has not yet been defined.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_pen\_type}$} means that \PB{\\{cur\_exp}} points to
a node in a pen.  Nobody
else points to any of the nodes in this pen.  The pen may be polygonal or
elliptical.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_unknown\_pen}$} means that \PB{\\{cur\_exp}} points
to a capsule
node that is in
a ring of equivalent pens whose value has not yet been defined.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_path\_type}$} means that \PB{\\{cur\_exp}} points to
a the first node of
a path; nobody else points to this particular path. The control points of
the path will have been chosen.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_unknown\_path}$} means that \PB{\\{cur\_exp}} points
to a capsule
node that is in
a ring of equivalent paths whose value has not yet been defined.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_picture\_type}$} means that \PB{\\{cur\_exp}} points
to an edge header node.
There may be other pointers to this particular set of edges.  The header node
contains a reference count that includes this particular reference.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_unknown\_picture}$} means that \PB{\\{cur\_exp}}
points to a capsule
node that is in
a ring of equivalent pictures whose value has not yet been defined.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_transform\_type}$} means that \PB{\\{cur\_exp}}
points to a \PB{\\{mp\_transform\_type}}
capsule node. The \PB{\\{value}} part of this capsule
points to a transform node that contains six numeric values,
each of which is \PB{\\{independent}}, \PB{\\{dependent}}, \PB{\\{mp\_proto%
\_dependent}}, or \PB{\\{known}}.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_color\_type}$} means that \PB{\\{cur\_exp}} points
to a \PB{\\{color\_type}}
capsule node. The \PB{\\{value}} part of this capsule
points to a color node that contains three numeric values,
each of which is \PB{\\{independent}}, \PB{\\{dependent}}, \PB{\\{mp\_proto%
\_dependent}}, or \PB{\\{known}}.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_cmykcolor\_type}$} means that \PB{\\{cur\_exp}}
points to a \PB{\\{mp\_cmykcolor\_type}}
capsule node. The \PB{\\{value}} part of this capsule
points to a color node that contains four numeric values,
each of which is \PB{\\{independent}}, \PB{\\{dependent}}, \PB{\\{mp\_proto%
\_dependent}}, or \PB{\\{known}}.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_pair\_type}$} means that \PB{\\{cur\_exp}} points to
a capsule
node whose type is \PB{\\{mp\_pair\_type}}. The \PB{\\{value}} part of this
capsule
points to a pair node that contains two numeric values,
each of which is \PB{\\{independent}}, \PB{\\{dependent}}, \PB{\\{mp\_proto%
\_dependent}}, or \PB{\\{known}}.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_known}$} means that \PB{\\{cur\_exp}} is a \PB{%
\\{scaled}} value.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_dependent}$} means that \PB{\\{cur\_exp}} points to
a capsule node whose type
is \PB{\\{dependent}}. The \PB{\\{dep\_list}} field in this capsule points to
the associated
dependency list.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_proto\_dependent}$} means that \PB{\\{cur\_exp}}
points to a \PB{\\{mp\_proto\_dependent}}
capsule node. The \PB{\\{dep\_list}} field in this capsule
points to the associated dependency list.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{independent}$} means that \PB{\\{cur\_exp}} points to a
capsule node
whose type is \PB{\\{independent}}. This somewhat unusual case can arise, for
example, in the expression
`$x+\&{begingroup}\penalty0\,\&{string}\,x; 0\,\&{endgroup}$'.

\smallskip\hang
\PB{$\\{cur\_type}\K\\{mp\_token\_list}$} means that \PB{\\{cur\_exp}} points
to a linked list of
tokens.

\smallskip\noindent
The possible settings of \PB{\\{cur\_type}} have been listed here in increasing
numerical order. Notice that \PB{\\{cur\_type}} will never be \PB{\\{mp%
\_numeric\_type}} or
\PB{\\{suffixed\_macro}} or \PB{\\{mp\_unsuffixed\_macro}}, although variables
of those types
are allowed.  Conversely, \MP\ has no variables of type \PB{\\{mp\_vacuous}} or
\PB{\\{token\_list}}.

\fi

\M{903}Capsules are non-symbolic nodes that have a similar meaning
to \PB{\\{cur\_type}} and \PB{\\{cur\_exp}}. Such nodes have \PB{$\\{name%
\_type}\K\\{capsule}$},
and their \PB{\\{type}} field is one of the possibilities for \PB{\\{cur%
\_type}} listed above.
Also \PB{\\{link} $\Z$ \&{void}} in capsules that aren't part of a token list.

The \PB{\\{value}} field of a capsule is, in most cases, the value that
corresponds to its \PB{\\{type}}, as \PB{\\{cur\_exp}} corresponds to \PB{%
\\{cur\_type}}.
However, when \PB{\\{cur\_exp}} would point to a capsule,
no extra layer of indirection is present; the \PB{\\{value}}
field is what would have been called \PB{\\{value}(\\{cur\_exp})} if it had not
been
encapsulated.  Furthermore, if the type is \PB{\\{dependent}} or
\PB{\\{mp\_proto\_dependent}}, the \PB{\\{value}} field of a capsule is
replaced by
\PB{\\{dep\_list}} and \PB{\\{prev\_dep}} fields, since dependency lists in
capsules are
always part of the general \PB{\\{dep\_list}} structure.

The \PB{\\{get\_x\_next}} routine is careful not to change the values of \PB{%
\\{cur\_type}}
and \PB{\\{cur\_exp}} when it gets an expanded token. However, \PB{\\{get\_x%
\_next}} might
call a macro, which might parse an expression, which might execute lots of
commands in a group; hence it's possible that \PB{\\{cur\_type}} might change
from, say, \PB{\\{mp\_unknown\_boolean}} to \PB{\\{mp\_boolean\_type}}, or from
\PB{\\{dependent}} to
\PB{\\{known}} or \PB{\\{independent}}, during the time \PB{\\{get\_x\_next}}
is called. The
programs below are careful to stash sensitive intermediate results in
capsules, so that \MP's generality doesn't cause trouble.

Here's a procedure that illustrates these conventions. It takes
the contents of $(\PB{\\{cur\_type}}\kern-.3pt,\PB{\\{cur\_exp}}\kern-.3pt)$
and stashes them away in a
capsule. It is not used when \PB{$\\{cur\_type}\K\\{mp\_token\_list}$}.
After the operation, \PB{$\\{cur\_type}\K\\{mp\_vacuous}$}; hence there is no
need to
copy path lists or to update reference counts, etc.

The special link \PB{\.{MP\_VOID}} is put on the capsule returned by
\PB{\\{stash\_cur\_exp}}, because this procedure is used to store macro
parameters
that must be easily distinguishable from token lists.

\Y\B\4\X903:Declare the stashing/unstashing routines\X${}\E{}$\6
\&{static} \&{mp\_node} \\{mp\_stash\_cur\_exp}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ the capsule that will be returned }\7
${}\\{mp\_variable\_type}\\{exp\_type}\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
\&{switch} (\\{exp\_type})\5
${}\{{}$\1\6
\4\&{case} \\{unknown\_types}:\5
\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|p\K\\{cur\_exp\_node}(\,);{}$\6
\&{break};\C{ \PB{\&{case} \\{mp\_path\_type}: \&{case} \\{mp\_pen\_type}: %
\&{case} \\{mp\_string\_type}:} }\6
\4\&{default}:\5
${}\|p\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_capsule};{}$\6
${}\\{mp\_type}(\|p)\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{cur\_exp\_value\_number}(\,)){}$;\C{ this
also resets the rest to 0/NULL }\6
\&{if} (\\{cur\_exp\_str}(\,))\5
${}\{{}$\1\6
${}\\{set\_value\_str}(\|p,\39\\{cur\_exp\_str}(\,));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{cur\_exp\_knot}(\,))\5
${}\{{}$\1\6
${}\\{set\_value\_knot}(\|p,\39\\{cur\_exp\_knot}(\,));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{cur\_exp\_node}(\,))\5
${}\{{}$\1\6
${}\\{set\_value\_node}(\|p,\39\\{cur\_exp\_node}(\,));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
${}\\{mp\_link}(\|p)\K\.{MP\_VOID};{}$\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\A904.
\U906.\fi

\M{904}The inverse of \PB{\\{stash\_cur\_exp}} is the following procedure,
which
deletes an unnecessary capsule and puts its contents into \PB{\\{cur\_type}}
and \PB{\\{cur\_exp}}.

The program steps of \MP\ can be divided into two categories: those in
which \PB{\\{cur\_type}} and \PB{\\{cur\_exp}} are ``alive'' and those in which
they are
``dead,'' in the sense that \PB{\\{cur\_type}} and \PB{\\{cur\_exp}} contain
relevant
information or not. It's important not to ignore them when they're alive,
and it's important not to pay attention to them when they're dead.

There's also an intermediate category: If \PB{$\\{cur\_type}\K\\{mp%
\_vacuous}$}, then
\PB{\\{cur\_exp}} is irrelevant, hence we can proceed without caring if \PB{%
\\{cur\_type}}
and \PB{\\{cur\_exp}} are alive or dead. In such cases we say that \PB{\\{cur%
\_type}}
and \PB{\\{cur\_exp}} are {\sl dormant}. It is permissible to call \PB{\\{get%
\_x\_next}}
only when they are alive or dormant.

The \\{stash} procedure above assumes that \PB{\\{cur\_type}} and \PB{\\{cur%
\_exp}}
are alive or dormant. The \\{unstash} procedure assumes that they are
dead or dormant; it resuscitates them.

\Y\B\4\X903:Declare the stashing/unstashing routines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_unstash\_cur\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{905}\B\&{void} \\{mp\_unstash\_cur\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_type}(\|p);{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{unknown\_types}:\5
\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\\{set\_cur\_exp\_node}(\|p);\6
\&{break};\6
\4\&{case} \\{mp\_token\_list}:\C{ this is how symbols are stashed }\6
\\{set\_cur\_exp\_node}(\\{value\_node}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_pen\_type}:\5
\\{set\_cur\_exp\_knot}(\\{value\_knot}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
\\{set\_cur\_exp\_str}(\\{value\_str}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
\\{set\_cur\_exp\_node}(\\{value\_node}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_known}:\5
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\|p));\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{default}:\5
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\|p));\6
\&{if} (\\{value\_knot}(\|p))\5
${}\{{}$\1\6
\\{set\_cur\_exp\_knot}(\\{value\_knot}(\|p));\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{value\_node}(\|p))\5
${}\{{}$\1\6
\\{set\_cur\_exp\_node}(\\{value\_node}(\|p));\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{value\_str}(\|p))\5
${}\{{}$\1\6
\\{set\_cur\_exp\_str}(\\{value\_str}(\|p));\6
\4${}\}{}$\2\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{906}The following procedure prints the values of expressions in an
abbreviated format. If its first parameter \PB{\|p} is NULL, the value of
\PB{$(\\{cur\_type},\\{cur\_exp})$} is displayed; otherwise \PB{\|p} should be
a capsule
containing the desired value. The second parameter controls the amount of
output. If it is~0, dependency lists will be abbreviated to
`\.{linearform}' unless they consist of a single term.  If it is greater
than~1, complicated structures (pens, pictures, and paths) will be displayed
in full.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\X915:Declare the procedure called \PB{\\{print\_dp}}\X;\6
\X903:Declare the stashing/unstashing routines\X;\7
\&{static} \&{void} \\{mp\_print\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{quarterword} \\{verbosity});\par
\fi

\M{907}\B\&{void} \\{mp\_print\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{quarterword} \\{verbosity})\1\1\2\2\6
${}\{{}$\1\6
\&{boolean} \\{restore\_cur\_exp};\C{ should \PB{\\{cur\_exp}} be restored? }\7
\\{mp\_variable\_type}\|t;\C{ the type of the expression }\7
\&{mp\_number} \\{vv};\C{ the value of the expression }\6
\&{mp\_node} \|v${}\K\NULL;{}$\7
\\{new\_number}(\\{vv});\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\\{restore\_cur\_exp}\K\\{false};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{restore\_cur\_exp}\K\\{true};{}$\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_type}(\|p);{}$\6
\&{if} ${}(\|t<\\{mp\_dependent}){}$\5
${}\{{}$\C{ no dep list, could be a capsule }\1\6
\&{if} ${}(\|t\I\\{mp\_vacuous}\W\|t\I\\{mp\_known}\W\\{value\_node}(\|p)\I%
\NULL){}$\1\5
${}\|v\K\\{value\_node}(\|p);{}$\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\|p));{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t<\\{mp\_independent}){}$\5
${}\{{}$\1\6
${}\|v\K{}$(\&{mp\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p);\6
\4${}\}{}$\2\6
\X908:Print an abbreviated value of \PB{\|v} or \PB{\\{vv}} with format
depending on \PB{\|t}\X;\6
\&{if} (\\{restore\_cur\_exp})\1\5
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\2\6
\\{free\_number}(\\{vv});\6
\4${}\}{}$\2\par
\fi

\M{908}\B\X908:Print an abbreviated value of \PB{\|v} or \PB{\\{vv}} with
format depending on \PB{\|t}\X${}\E{}$\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
${}\\{mp\_print}(\\{mp},\39\.{"vacuous"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_boolean\_type}:\6
\&{if} ${}(\\{number\_to\_boolean}(\\{vv})\E\\{mp\_true\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"true"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"false"});{}$\2\6
\&{break};\6
\4\&{case} \\{unknown\_types}:\5
\&{case} \\{mp\_numeric\_type}:\5
\X916:Display a variable that's been declared but not defined\X;\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{value\_str}(\|p));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_picture\_type}:\5
\X914:Display a complex type\X;\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\6
\&{if} ${}(\\{number\_zero}(\\{vv})\W\|v\E\NULL){}$\1\5
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\2\6
\&{else}\1\5
\X911:Display a transform node\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\6
\&{if} ${}(\\{number\_zero}(\\{vv})\W\|v\E\NULL){}$\1\5
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\2\6
\&{else}\1\5
\X912:Display a color node\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_pair\_type}:\6
\&{if} ${}(\\{number\_zero}(\\{vv})\W\|v\E\NULL){}$\1\5
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\2\6
\&{else}\1\5
\X910:Display a pair node\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\6
\&{if} ${}(\\{number\_zero}(\\{vv})\W\|v\E\NULL){}$\1\5
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\2\6
\&{else}\1\5
\X913:Display a cmykcolor node\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_known}:\5
\\{print\_number}(\\{vv});\6
\&{break};\6
\4\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
${}\\{mp\_print\_dp}(\\{mp},\39\|t,\39{}$(\&{mp\_value\_node}) \|v${},\39%
\\{verbosity});{}$\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_confusion}(\\{mp},\39\.{"exp"});{}$\6
\&{break};\6
\4${}\}{}$\2\par
\U907.\fi

\M{909}\B\X909:Display big node item \PB{\|v}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|v)\E\\{mp\_known}){}$\1\5
\\{print\_number}(\\{value\_number}(\|v));\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|v)\E\\{mp\_independent}){}$\1\5
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|v);{}$\2\6
\&{else}\1\5
${}\\{mp\_print\_dp}(\\{mp},\39\\{mp\_type}(\|v),\39{}$(\&{mp\_value\_node}) %
\\{dep\_list}((\&{mp\_value\_node}) \|v)${},\39\\{verbosity});{}$\2\6
\4${}\}{}$\2\par
\Us910, 911, 912\ETs913.\fi

\M{910}In these cases, \PB{\|v} starts as the big node.

\Y\B\4\X910:Display a pair node\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{vvv}${}\K\|v;{}$\7
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('})){}$;\C{ clang: dereference
of null pointer }\6
\\{assert}(\\{vvv});\6
${}\|v\K\\{x\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{y\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\U908.\fi

\M{911}\B\X911:Display a transform node\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{vvv}${}\K\|v;{}$\7
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('})){}$;\C{ clang: dereference
of null pointer }\6
\\{assert}(\\{vvv});\6
${}\|v\K\\{tx\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{ty\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{xx\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{xy\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{yx\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{yy\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\U908.\fi

\M{912}\B\X912:Display a color node\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{vvv}${}\K\|v;{}$\7
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('})){}$;\C{ clang: dereference
of null pointer }\6
\\{assert}(\\{vvv});\6
${}\|v\K\\{red\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{green\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{blue\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\U908.\fi

\M{913}\B\X913:Display a cmykcolor node\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \\{vvv}${}\K\|v;{}$\7
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('})){}$;\C{ clang: dereference
of null pointer }\6
\\{assert}(\\{vvv});\6
${}\|v\K\\{cyan\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{magenta\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{yellow\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{','}));{}$\6
${}\|v\K\\{black\_part}(\\{vvv});{}$\6
\X909:Display big node item \PB{\|v}\X;\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\U908.\fi

\M{914}Values of type \&{picture}, \&{path}, and \&{pen} are displayed
verbosely
in the log file only, unless the user has given a positive value to
\\{tracingonline}.

\Y\B\4\X914:Display a complex type\X${}\E{}$\6
\&{if} ${}(\\{verbosity}\Z\T{1}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{selector}\E\\{term\_and\_log}){}$\1\6
\&{if} (\\{number\_nonpositive}(\\{internal\_value}(\\{mp\_tracing\_online})))\5
${}\{{}$\1\6
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ (see\ the\ transcrip}\)\.{t\ file)"});{}$\6
${}\\{mp}\MG\\{selector}\K\\{term\_and\_log};{}$\6
\4${}\}{}$\2\2\6
;\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pen\_type}:\5
${}\\{mp\_print\_pen}(\\{mp},\39\\{value\_knot}(\|p),\39\.{""},\39%
\\{false});{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{mp\_print\_path}(\\{mp},\39\\{value\_knot}(\|p),\39\.{""},\39%
\\{false});{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
${}\\{mp\_print\_edges}(\\{mp},\39\|v,\39\.{""},\39\\{false});{}$\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U908.\fi

\M{915}\B\X915:Declare the procedure called \PB{\\{print\_dp}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_print\_dp}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|t${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{quarterword} \\{verbosity})\1%
\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ the node following \PB{\|p} }\7
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\&{if} ${}((\\{dep\_info}(\|q)\E\NULL)\V(\\{verbosity}>\T{0})){}$\1\5
${}\\{mp\_print\_dependency}(\\{mp},\39\|p,\39\|t);{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"linearform"});{}$\2\6
\4${}\}{}$\2\par
\U906.\fi

\M{916}The displayed name of a variable in a ring will not be a capsule unless
the ring consists entirely of capsules.

\Y\B\4\X916:Display a variable that's been declared but not defined\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\6
\&{if} ${}(\|v\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\6
\&{while} ${}((\\{mp\_name\_type}(\|v)\E\\{mp\_capsule})\W(\|v\I\|p)){}$\1\5
${}\|v\K\\{value\_node}(\|v);{}$\2\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|v);{}$\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\par
\U908.\fi

\M{917}When errors are detected during parsing, it is often helpful to
display an expression just above the error message, using \PB{\\{disp\_err}}
just before \PB{\\{mp\_error}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_disp\_err}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);%
\par
\fi

\M{918}\B\&{void} \\{mp\_disp\_err}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1%
\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
\\{wake\_up\_terminal}(\,);\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{">>\ "});{}$\6
;\6
${}\\{mp\_print\_exp}(\\{mp},\39\|p,\39\T{1}){}$;\C{ ``medium verbose''
printing of the expression }\6
\4${}\}{}$\2\par
\fi

\M{919}If \PB{\\{cur\_type}} and \PB{\\{cur\_exp}} contain relevant information
that should
be recycled, we will use the following procedure, which changes \PB{\\{cur%
\_type}}
to \PB{\\{known}} and stores a given value in \PB{\\{cur\_exp}}. We can think
of \PB{\\{cur\_type}}
and \PB{\\{cur\_exp}} as either alive or dormant after this has been done,
because \PB{\\{cur\_exp}} will not contain a pointer value.

\fi

\M{920}\B\&{void} \\{mp\_flush\_cur\_exp}(\&{MP} \\{mp}${},\39{}$\&{mp\_value} %
\|v)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{is\_number}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n)){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{cur\_exp}.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{unknown\_types}:\5
\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
${}\\{mp\_recycle\_value}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_path\_type}:\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
\\{delete\_edge\_ref}(\\{cur\_exp\_node}(\,));\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}\K\|v;{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\4${}\}{}$\2\par
\fi

\M{921}There's a much more general procedure that is capable of releasing
the storage associated with any non-symbolic value packet.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_recycle\_value}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p);\par
\fi

\M{922}\B\&{static} \&{void} \\{mp\_recycle\_value}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_variable\_type}\|t;\C{ a type code }\6
${}\.{FUNCTION\_TRACE2}(\.{"mp\_recycle\_value(\%p}\)\.{)\\n"},\39\|p);{}$\6
${}\|t\K\\{mp\_type}(\|p);{}$\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_known}:\5
\&{case} \\{mp\_numeric\_type}:\5
\&{break};\6
\4\&{case} \\{unknown\_types}:\5
${}\\{mp\_ring\_delete}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
\\{delete\_str\_ref}(\\{value\_str}(\|p));\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_pen\_type}:\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{value\_knot}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
\\{delete\_edge\_ref}(\\{value\_node}(\|p));\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\6
\&{if} ${}(\\{value\_node}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{cyan\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{magenta\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{yellow\_part}(\\{value\_node}(\|p)));{}$%
\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{black\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{cyan\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{magenta\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{black\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{yellow\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\\{value\_node}(\|p),\39\\{cmykcolor\_node%
\_size});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_pair\_type}:\6
\&{if} ${}(\\{value\_node}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{x\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{y\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{x\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{y\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_pair\_node}(\\{mp},\39\\{value\_node}(\|p));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\6
\&{if} ${}(\\{value\_node}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{red\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{green\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{blue\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{red\_part}(\\{value\_node}(\|p)));{}$%
\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{green\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{blue\_part}(\\{value\_node}(%
\|p)));{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\\{value\_node}(\|p),\39\\{color\_node%
\_size});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\6
\&{if} ${}(\\{value\_node}(\|p)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{tx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{ty\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{xx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{xy\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{yx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{yy\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{tx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{ty\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{xx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{xy\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{yx\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{yy\_part}(\\{value\_node}(\|p)));{}$\6
${}\\{mp\_free\_node}(\\{mp},\39\\{value\_node}(\|p),\39\\{transform\_node%
\_size});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\C{ Recycle a dependency list }\6
${}\{{}$\1\6
\&{mp\_value\_node} \\{qq}${}\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp%
\_value\_node}) \|p);\7
\&{while} ${}(\\{dep\_info}(\\{qq})\I\NULL){}$\1\5
${}\\{qq}\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\\{qq});\2\6
\\{set\_mp\_link}(\\{prev\_dep}((\&{mp\_value\_node}) \|p)${},\39\\{mp\_link}(%
\\{qq}));{}$\6
${}\\{set\_prev\_dep}(\\{mp\_link}(\\{qq}),\39{}$\\{prev\_dep}((\&{mp\_value%
\_node}) \|p));\6
${}\\{set\_mp\_link}(\\{qq},\39\NULL);{}$\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39{}$(\&{mp\_node}) \\{dep\_list}((\&{mp%
\_value\_node}) \|p));\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
\X923:Recycle an independent variable\X;\6
\&{break};\6
\4\&{case} \\{mp\_token\_list}:\5
\&{case} \\{mp\_structured}:\5
${}\\{mp\_confusion}(\\{mp},\39\.{"recycle"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_unsuffixed\_macro}:\5
\&{case} \\{mp\_suffixed\_macro}:\5
${}\\{mp\_delete\_mac\_ref}(\\{mp},\39\\{value\_node}(\|p));{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_undefined};{}$\6
\4${}\}{}$\2\par
\fi

\M{923}When an independent variable disappears, it simply fades away, unless
something depends on it. In the latter case, a dependent variable whose
coefficient of dependence is maximal will take its place.
The relevant algorithm is due to Ignacio~A. Zabala, who implemented it
as part of his Ph.n->data. thesis (Stanford University, December 1982).

For example, suppose that variable $x$ is being recycled, and that the
only variables depending on~$x$ are $y=2x+a$ and $z=x+b$. In this case
we want to make $y$ independent and $z=.5y-.5a+b$; no other variables
will depend on~$y$. If $\\{tracingequations}>0$ in this situation,
we will print `\.{\#\#\# -2x=-y+a}'.

There's a slight complication, however: An independent variable $x$
can occur both in dependency lists and in proto-dependency lists.
This makes it necessary to be careful when deciding which coefficient
is maximal.

Furthermore, this complication is not so slight when
a proto-dependent variable is chosen to become independent. For example,
suppose that $y=2x+100a$ is proto-dependent while $z=x+b$ is dependent;
then we must change $z=.5y-50a+b$ to a proto-dependency, because of the
large coefficient `50'.

In order to deal with these complications without wasting too much time,
we shall link together the occurrences of~$x$ among all the linear
dependencies, maintaining separate lists for the dependent and
proto-dependent cases.

\Y\B\4\X923:Recycle an independent variable\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q${},{}$ \|r${},{}$ \|s;\6
\&{mp\_node} \\{pp};\C{ link manipulation register }\6
\&{mp\_number} \|v;\C{ a value }\6
\&{mp\_number} \\{test};\C{ a temporary value }\7
\\{new\_number}(\\{test});\6
\\{new\_number}(\|v);\6
\&{if} ${}(\|t<\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|p));{}$\2\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{max\_c}[\\{mp\_dependent}]);{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{max\_c}[\\{mp\_proto\_dependent}]);{}$%
\6
${}\\{mp}\MG\\{max\_link}[\\{mp\_dependent}]\K\NULL;{}$\6
${}\\{mp}\MG\\{max\_link}[\\{mp\_proto\_dependent}]\K\NULL;{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{dep\_head});{}$\6
\&{while} ${}(\|q\I\\{mp}\MG\\{dep\_head}){}$\5
${}\{{}$\1\6
${}\|s\K{}$(\&{mp\_value\_node}) \\{mp}${}\MG\\{temp\_head};{}$\6
${}\\{set\_mp\_link}(\|s,\39\\{dep\_list}(\|q));{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|s);\6
\&{if} ${}(\\{dep\_info}(\|r)\E\NULL){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{dep\_info}(\|r)\I\|p){}$\5
${}\{{}$\1\6
${}\|s\K\|r;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|t\K\\{mp\_type}(\|q);{}$\6
\&{if} ${}(\\{mp\_link}(\|s)\E\\{dep\_list}(\|q)){}$\5
${}\{{}$\C{ reset the \PB{\\{dep\_list}} }\1\6
${}\\{set\_dep\_list}(\|q,\39\\{mp\_link}(\|r));{}$\6
\4${}\}{}$\2\6
${}\\{set\_mp\_link}(\|s,\39\\{mp\_link}(\|r));{}$\6
${}\\{set\_dep\_info}(\|r,\39{}$(\&{mp\_node}) \|q);\6
${}\\{number\_clone}(\\{test},\39\\{dep\_value}(\|r));{}$\6
\\{number\_abs}(\\{test});\6
\&{if} ${}(\\{number\_greater}(\\{test},\39\\{mp}\MG\\{max\_c}[\|t])){}$\5
${}\{{}$\C{ Record a new maximum coefficient of type \PB{\|t} }\1\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{max\_c}[\|t])){}$\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{max\_ptr}[\|t],\39{}$(\&{mp\_node}) \\{mp}${}%
\MG\\{max\_link}[\|t]);{}$\6
${}\\{mp}\MG\\{max\_link}[\|t]\K\\{mp}\MG\\{max\_ptr}[\|t];{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{max\_c}[\|t],\39\\{test});{}$\6
${}\\{mp}\MG\\{max\_ptr}[\|t]\K\|r;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_mp\_link}(\|r,\39{}$(\&{mp\_node}) \\{mp}${}\MG\\{max\_link}[%
\|t]);{}$\6
${}\\{mp}\MG\\{max\_link}[\|t]\K\|r;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{max\_c}[\\{mp\_dependent}])\V%
\\{number\_positive}(\\{mp}\MG\\{max\_c}[\\{mp\_proto\_dependent}])){}$\5
${}\{{}$\C{ Choose a dependent variable to take the place of the disappearing
     independent variable, and change all remaining dependencies
accordingly }\1\6
\&{mp\_number} \\{test}${},{}$ \\{ret};\C{ temporary use }\7
\\{new\_number}(\\{ret});\6
\\{new\_number}(\\{test});\6
${}\\{number\_clone}(\\{test},\39\\{mp}\MG\\{max\_c}[\\{mp\_dependent}]);{}$\6
${}\\{number\_divide\_int}(\\{test},\39\T{4096});{}$\6
\&{if} ${}(\\{number\_greaterequal}(\\{test},\39\\{mp}\MG\\{max\_c}[\\{mp%
\_proto\_dependent}])){}$\1\5
${}\|t\K\\{mp\_dependent};{}$\2\6
\&{else}\1\5
${}\|t\K\\{mp\_proto\_dependent}{}$;\C{ Let \PB{$\|s\K\\{max\_ptr}[\|t]$}. At
this point we have $\PB{\\{value}}(s)=\pm\PB{\\{max\_c}}[t]$,        and \PB{%
\\{dep\_info}(\|s)} points to the dependent variable~\PB{\\{pp}} of type~\PB{%
\|t} from        whose dependency list we have removed node~\PB{\|s}. We must
reinsert        node~\PB{\|s} into the dependency list, with coefficient
$-1.0$, and with        \PB{\\{pp}} as the new independent variable. Since \PB{%
\\{pp}} will have a larger serial        number than any other variable, we can
put node \PB{\|s} at the head of the        list. }\C{ Determine the dependency
list \PB{\|s} to substitute for the independent        variable~\PB{\|p} }\2\6
${}\|s\K\\{mp}\MG\\{max\_ptr}[\|t];{}$\6
${}\\{pp}\K{}$(\&{mp\_node}) \\{dep\_info}(\|s);\6
${}\\{number\_clone}(\|v,\39\\{dep\_value}(\|s));{}$\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{set\_dep\_value}(\|s,\39\\{fraction\_one\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_dep\_value}(\|s,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\\{number\_negate}(\\{dep\_value}(\|s));\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \\{pp});\6
${}\\{set\_mp\_link}(\|s,\39{}$(\&{mp\_node}) \|r);\6
\&{while} ${}(\\{dep\_info}(\|r)\I\NULL){}$\1\5
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\2\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
${}\\{set\_mp\_link}(\|r,\39\NULL);{}$\6
${}\\{set\_prev\_dep}(\|q,\39{}$\\{prev\_dep}((\&{mp\_value\_node}) \\{pp}));\6
\\{set\_mp\_link}(\\{prev\_dep}((\&{mp\_value\_node}) \\{pp})${},\39{}$(\&{mp%
\_node}) \|q);\6
${}\\{mp\_new\_indep}(\\{mp},\39\\{pp});{}$\6
\&{if} ${}(\\{cur\_exp\_node}(\,)\E\\{pp}\W\\{mp}\MG\\{cur\_exp}.\\{type}\E%
\|t){}$\1\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_independent};{}$\2\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_equations})))\5
${}\{{}$\C{ Show the transformed dependency }\1\6
\&{if} ${}(\\{mp\_interesting}(\\{mp},\39\|p)){}$\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_show\_transformed\_dependency}(\\{mp},\39\|v,\39\|t,\39\|p);{}$\6
${}\\{mp\_print\_dependency}(\\{mp},\39\|s,\39\|t);{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|t\K(\&{quarterword})(\\{mp\_dependent}+\\{mp\_proto\_dependent}-\|t){}$;%
\C{ complement \PB{\|t} }\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{max\_c}[\|t])){}$\5
${}\{{}$\C{ we need to pick up an unchosen dependency }\1\6
${}\\{set\_mp\_link}(\\{mp}\MG\\{max\_ptr}[\|t],\39{}$(\&{mp\_node}) \\{mp}${}%
\MG\\{max\_link}[\|t]);{}$\6
${}\\{mp}\MG\\{max\_link}[\|t]\K\\{mp}\MG\\{max\_ptr}[\|t];{}$\6
\4${}\}{}$\C{ Finally, there are dependent and proto-dependent variables whose
      dependency lists must be brought up to date. }\2\6
\&{if} ${}(\|t\I\\{mp\_dependent}){}$\5
${}\{{}$\C{ Substitute new dependencies in place of \PB{\|p} }\1\6
\&{for} ${}(\|t\K\\{mp\_dependent};{}$ ${}\|t\Z\\{mp\_proto\_dependent};{}$ ${}%
\|t\K\|t+\T{1}){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp}\MG\\{max\_link}[\|t];{}$\6
\&{while} ${}(\|r\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{dep\_info}(\|r);\6
${}\\{number\_clone}(\\{test},\39\|v);{}$\6
\\{number\_negate}(\\{test});\6
${}\\{make\_fraction}(\\{ret},\39\\{dep\_value}(\|r),\39\\{test});{}$\6
${}\\{set\_dep\_list}(\|q,\39\\{mp\_p\_plus\_fq}(\\{mp},\39{}$(\&{mp\_value%
\_node}) \\{dep\_list}(\|q)${},\39\\{ret},\39\|s,\39\|t,\39\\{mp%
\_dependent}));{}$\6
\&{if} ${}(\\{dep\_list}(\|q)\E{}$(\&{mp\_node}) \\{mp}${}\MG\\{dep\_final}){}$%
\1\5
${}\\{mp\_make\_known}(\\{mp},\39\|q,\39\\{mp}\MG\\{dep\_final});{}$\2\6
${}\|q\K\|r;{}$\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Substitute new proto-dependencies in place of \PB{\|p} }\1\6
\&{for} ${}(\|t\K\\{mp\_dependent};{}$ ${}\|t\Z\\{mp\_proto\_dependent};{}$ ${}%
\|t\K\|t+\T{1}){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp}\MG\\{max\_link}[\|t];{}$\6
\&{while} ${}(\|r\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{dep\_info}(\|r);\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\C{ for safety's sake, we change \PB{\|q} to \PB{\\{mp\_proto%
\_dependent}} }\1\6
\&{if} ${}(\\{cur\_exp\_node}(\,)\E{}$(\&{mp\_node}) \|q${}\W\\{mp}\MG\\{cur%
\_exp}.\\{type}\E\\{mp\_dependent}){}$\1\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_proto\_dependent};{}$\2\6
${}\\{set\_dep\_list}(\|q,\39\\{mp\_p\_over\_v}(\\{mp},\39{}$(\&{mp\_value%
\_node}) \\{dep\_list}(\|q)${},\39\\{unity\_t},\39\\{mp\_dependent},\39\\{mp%
\_proto\_dependent}));{}$\6
${}\\{mp\_type}(\|q)\K\\{mp\_proto\_dependent};{}$\6
\\{fraction\_to\_round\_scaled}(\\{dep\_value}(\|r));\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{test},\39\|v);{}$\6
\\{number\_negate}(\\{test});\6
${}\\{make\_scaled}(\\{ret},\39\\{dep\_value}(\|r),\39\\{test});{}$\6
${}\\{set\_dep\_list}(\|q,\39\\{mp\_p\_plus\_fq}(\\{mp},\39{}$(\&{mp\_value%
\_node}) \\{dep\_list}(\|q)${},\39\\{ret},\39\|s,\39\\{mp\_proto\_dependent},%
\39\\{mp\_proto\_dependent}));{}$\6
\&{if} ${}(\\{dep\_list}(\|q)\E{}$(\&{mp\_node}) \\{mp}${}\MG\\{dep\_final}){}$%
\1\5
${}\\{mp\_make\_known}(\\{mp},\39\|q,\39\\{mp}\MG\\{dep\_final});{}$\2\6
${}\|q\K\|r;{}$\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39{}$(\&{mp\_node}) \|s);\6
\&{if} ${}(\\{mp}\MG\\{fix\_needed}){}$\1\5
\\{mp\_fix\_dependencies}(\\{mp});\2\6
\\{check\_arith}(\,);\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\\{free\_number}(\|v);\6
\\{free\_number}(\\{test});\6
\4${}\}{}$\2\par
\U922.\fi

\M{924}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_show\_transformed\_dependency}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_number} \|v${},\39\\{mp\_variable\_type}\|t,\39{}$\&{mp\_node} %
\|p);\par
\fi

\M{925}\B\&{static} \&{void} \\{mp\_show\_transformed\_dependency}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_number} \|v${},\39\\{mp\_variable\_type}\|t,\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{vv};\C{ for temp use }\7
\\{new\_number}(\\{vv});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\#\#\#\ "});{}$\6
\&{if} (\\{number\_positive}(\|v))\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'-'}));{}$\2\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vv},\39\\{mp}\MG\\{max\_c}[\\{mp\_dependent}]);{}$\6
\\{fraction\_to\_round\_scaled}(\\{vv});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vv},\39\\{mp}\MG\\{max\_c}[\\{mp\_proto%
\_dependent}]);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{number\_equal}(\\{vv},\39\\{unity\_t})){}$\5
${}\{{}$\1\6
\\{print\_number}(\\{vv});\6
\4${}\}{}$\2\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|p);{}$\6
\&{while} ${}(\\{indep\_scale}(\|p)>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"*4"});{}$\6
${}\\{set\_indep\_scale}(\|p,\39\\{indep\_scale}(\|p)-\T{2});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\ =\ "});{}$\2\6
\\{free\_number}(\\{vv});\6
\4${}\}{}$\2\par
\fi

\M{926}The code for independency removal makes use of three non-symbolic
arrays.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} ${}\\{max\_c}[\\{mp\_proto\_dependent}+\T{1}]{}$;\C{ max
coefficient magnitude }\6
\&{mp\_value\_node} ${}\\{max\_ptr}[\\{mp\_proto\_dependent}+\T{1}]{}$;\C{
where \PB{\|p} occurs with \PB{\\{max\_c}} }\6
\&{mp\_value\_node} ${}\\{max\_link}[\\{mp\_proto\_dependent}+\T{1}]{}$;\C{
other occurrences of \PB{\|p} }\par
\fi

\M{927}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{mp\_proto\_dependent}+\T{1};{}$ ${}\|i%
\PP){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{mp}\MG\\{max\_c}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{928}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{mp\_proto\_dependent}+\T{1};{}$ ${}\|i%
\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{max\_c}[\|i]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{929}A global variable \PB{\\{var\_flag}} is set to a special command code
just before \MP\ calls \PB{\\{scan\_expression}}, if the expression should be
treated as a variable when this command code immediately follows. For
example, \PB{\\{var\_flag}} is set to \PB{\\{assignment}} at the beginning of a
statement, because we want to know the {\sl location\/} of a variable at
the left of `\.{:=}', not the {\sl value\/} of that variable.

The \PB{\\{scan\_expression}} subroutine calls \PB{\\{scan\_tertiary}},
which calls \PB{\\{scan\_secondary}}, which calls \PB{\\{scan\_primary}}, which
sets
\PB{\\{var\_flag}: $\K$ \T{0}}. In this way each of the scanning routines
``knows''
when it has been called with a special \PB{\\{var\_flag}}, but \PB{\\{var%
\_flag}} is
usually zero.

A variable preceding a command that equals \PB{\\{var\_flag}} is converted to a
token list rather than a value. Furthermore, an `\.{=}' sign following an
expression with \PB{$\\{var\_flag}\K\\{assignment}$} is not considered to be a
relation
that produces boolean expressions.


\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{var\_flag};\C{ command that wants a variable }\par
\fi

\M{930}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{var\_flag}\K\T{0}{}$;\par
\fi

\N{1}{931}Parsing primary expressions.
The first parsing routine, \PB{\\{scan\_primary}}, is also the most complicated
one,
since it involves so many different cases. But each case---with one
exception---is fairly simple by itself.

When \PB{\\{scan\_primary}} begins, the first token of the primary to be
scanned
should already appear in \PB{\\{cur\_cmd}}, \PB{\\{cur\_mod}}, and \PB{\\{cur%
\_sym}}. The values
of \PB{\\{cur\_type}} and \PB{\\{cur\_exp}} should be either dead or dormant,
as explained
earlier. If \PB{\\{cur\_cmd}} is not between \PB{\\{min\_primary\_command}} and
\PB{\\{max\_primary\_command}}, inclusive, a syntax error will be signaled.

Later we'll come to procedures that perform actual operations like
addition, square root, and so on; our purpose now is to do the parsing.
But we might as well mention those future procedures now, so that the
suspense won't be too bad:

\smallskip
\PB{\\{do\_nullary}(\|c)} does primitive operations that have no operands
(e.g.,
`\&{true}' or `\&{pencircle}');

\smallskip
\PB{\\{do\_unary}(\|c)} applies a primitive operation to the current
expression;

\smallskip
\PB{$\\{do\_binary}(\|p,\|c)$} applies a primitive operation to the capsule~%
\PB{\|p}
and the current expression.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\E{}$\6
\&{static} \&{void} \\{check\_for\_mediation}(\&{MP} \\{mp});\7
\&{void} \\{mp\_scan\_primary}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_command\_code}\\{my\_var\_flag};\C{ initial value of \PB{\\{my\_var%
\_flag}} }\6
${}\\{my\_var\_flag}\K\\{mp}\MG\\{var\_flag};{}$\6
${}\\{mp}\MG\\{var\_flag}\K\T{0};{}$\6
\4\.{RESTART}:\5
\\{check\_arith}(\,);\C{ Supply diagnostic information, if requested }\6
\&{if} ${}(\\{mp}\MG\\{interrupt}\I\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{OK\_to\_interrupt}){}$\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
\\{check\_interrupt};\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{switch} (\\{cur\_cmd}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_left\_delimiter}:\6
${}\{{}$\C{ Scan a delimited primary }\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ for list manipulation }\6
\&{mp\_sym} \\{l\_delim}${},{}$ \\{r\_delim};\C{ hash addresses of a delimiter
pair }\7
${}\\{l\_delim}\K\\{cur\_sym}(\,);{}$\6
${}\\{r\_delim}\K\\{equiv\_sym}(\\{cur\_sym}(\,));{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_comma})\W(\\{mp}\MG\\{cur\_exp}.\\{type}\G%
\\{mp\_known})){}$\5
${}\{{}$\C{ Scan the rest of a delimited set of numerics }\C{ This code uses
the fact that \PB{\\{red\_part}} and \PB{\\{green\_part}}          are
synonymous with \PB{\\{x\_part}} and \PB{\\{y\_part}}. }\1\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\C{ Make sure the second part of a pair or
color has a numeric type }\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ started\ to\ sca}\)\.{n\ a\
pair\ `(a,b)'\ or\ }\)\.{a\ color\ `(a,b,c)';"},\39\.{"but\ after\ finding\ a}%
\)\.{\ nice\ `a'\ I\ found\ a\ }\)\.{`b'\ that\ isn't"},\39\.{"of\ numeric\
type.\ So}\)\.{\ I've\ changed\ that\ p}\)\.{art\ to\ zero."},\39\.{"(The\ b\
that\ I\ didn'}\)\.{t\ like\ appears\ above}\)\.{\ the\ error\ message.)}\)%
\.{"},\39\NULL\};{}$\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Nonnumeric\ ypart\ ha}\)\.{s\ been\
replaced\ by\ 0}\)\.{"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|q)\K\\{mp\_capsule};{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}){}$\5
${}\{{}$\1\6
${}\\{mp\_init\_color\_node}(\\{mp},\39\|q);{}$\6
${}\|r\K\\{value\_node}(\|q);{}$\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{y\_part}(\|r));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{x\_part}(\|r)){}$;\C{ Scan the last of a
triplet of numerics }\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ just\ scanned\ a}\)\.{\ color%
\ `(a,b,c)'\ or\ }\)\.{cmykcolor(a,b,c,d);\ }\)\.{but\ the\ `c'"},\39\.{"isn't\
of\ numeric\ ty}\)\.{pe.\ So\ I've\ changed\ }\)\.{that\ part\ to\ zero."},\39%
\.{"(The\ c\ that\ I\ didn'}\)\.{t\ like\ appears\ above}\)\.{\ the\ error\
message.)}\)\.{"},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Nonnumeric\ third\ pa}\)\.{rt\ has\ been\
replaced}\)\.{\ by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{blue\_part}(\|r));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|t;\C{ a token }\7
${}\\{mp\_init\_cmykcolor\_node}(\\{mp},\39\|q);{}$\6
${}\|t\K\\{value\_node}(\|q);{}$\6
${}\\{mp\_type}(\\{cyan\_part}(\|t))\K\\{mp\_type}(\\{red\_part}(\|r));{}$\6
${}\\{set\_value\_number}(\\{cyan\_part}(\|t),\39\\{value\_number}(\\{red%
\_part}(\|r)));{}$\6
${}\\{mp\_type}(\\{magenta\_part}(\|t))\K\\{mp\_type}(\\{green\_part}(\|r));{}$%
\6
${}\\{set\_value\_number}(\\{magenta\_part}(\|t),\39\\{value\_number}(\\{green%
\_part}(\|r)));{}$\6
${}\\{mp\_type}(\\{yellow\_part}(\|t))\K\\{mp\_type}(\\{blue\_part}(\|r));{}$\6
${}\\{set\_value\_number}(\\{yellow\_part}(\|t),\39\\{value\_number}(\\{blue%
\_part}(\|r)));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|r);{}$\6
${}\|r\K\|t{}$;\C{ Scan the last of a quartet of numerics }\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ just\ scanned\ a}\)\.{\
cmykcolor\ `(c,m,y,k}\)\.{)';\ but\ the\ `k'\ isn'}\)\.{t"},\39\.{"of\ numeric\
type.\ So}\)\.{\ I've\ changed\ that\ p}\)\.{art\ to\ zero."},\39\.{"(The\ k\
that\ I\ didn'}\)\.{t\ like\ appears\ above}\)\.{\ the\ error\ message.)}\)%
\.{"},\39\NULL\};{}$\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Nonnumeric\ blackpar}\)\.{t\ has\ been\
replaced\ }\)\.{by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{black\_part}(\|r));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_init\_pair\_node}(\\{mp},\39\|q);{}$\6
${}\|r\K\\{value\_node}(\|q);{}$\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{y\_part}(\|r));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
${}\\{mp\_stash\_in}(\\{mp},\39\\{x\_part}(\|r));{}$\6
\4${}\}{}$\2\6
${}\\{mp\_check\_delimiter}(\\{mp},\39\\{l\_delim},\39\\{r\_delim});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_type}(\|q);{}$\6
\\{set\_cur\_exp\_node}(\|q);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_check\_delimiter}(\\{mp},\39\\{l\_delim},\39\\{r\_delim});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_begin\_group}:\C{ Scan a grouped primary }\C{ The local
variable \PB{\\{group\_line}} keeps track of the line        where a %
\&{begingroup} command occurred; this will be useful        in an error message
if the group doesn't actually end. }\6
${}\{{}$\1\6
\&{integer} \\{group\_line};\C{ where a group began }\7
${}\\{group\_line}\K\\{mp\_true\_line}(\\{mp});{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_commands})))\1%
\5
\\{show\_cur\_cmd\_mod};\2\6
\\{mp\_save\_boundary}(\\{mp});\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_do\_statement}(\\{mp});\C{ ends with \PB{$\\{cur\_cmd}\G\\{semicolon}$}
}\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_semicolon});{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_end\_group}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ saw\ a\ `begingroup}\)\.{'\ back%
\ there\ that\ ha}\)\.{sn't\ been\ matched"},\39\.{"by\ `endgroup'.\ So\ I}\)%
\.{'ve\ inserted\ `endgro}\)\.{up'\ now."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"A\ group\ begun\ on\ li}\)\.{ne\ %
\%d\ never\ ended"},\39{}$(\&{int}) \\{group\_line});\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_end\_group});\6
\4${}\}{}$\2\6
\\{mp\_unsave}(\\{mp});\C{ this might change \PB{\\{cur\_type}}, if independent
variables are recycled }\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_commands})))\1%
\5
\\{show\_cur\_cmd\_mod};\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_string\_token}:\C{ Scan a string constant }\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\\{set\_cur\_exp\_str}(\\{cur\_mod\_str}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_numeric\_token}:\6
${}\{{}$\C{ Scan a primary that starts with a numeric token }\C{ A numeric
token might be a primary by itself, or it might be the        numerator of a
fraction composed solely of numeric tokens, or it might        multiply the
primary that follows (provided that the primary doesn't begin        with a
plus sign or a minus sign). The code here uses the facts that        \PB{$%
\\{max\_primary\_command}\K\\{plus\_or\_minus}$} and        \PB{$\\{max%
\_primary\_command}-\T{1}\K\\{numeric\_token}$}. If a fraction is found that is
less        than unity, we try to retain higher precision when we use it in
scalar        multiplication. }\1\6
\&{mp\_number} \\{num}${},{}$ \\{denom};\C{ for primaries that are fractions,
like `1/2' }\7
\\{new\_number}(\\{num});\6
\\{new\_number}(\\{denom});\6
\\{set\_cur\_exp\_value\_number}(\\{cur\_mod\_number}(\,));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_slash}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\\{num});\6
\\{set\_number\_to\_zero}(\\{denom});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_numeric\_token}){}$\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_slash});\6
\\{set\_cur\_mod}(\\{mp\_over});\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_slash});{}$\6
\\{free\_number}(\\{num});\6
\\{free\_number}(\\{denom});\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{num},\39\\{cur\_exp\_value\_number}(\,));{}$\6
${}\\{number\_clone}(\\{denom},\39\\{cur\_mod\_number}(\,));{}$\6
\&{if} (\\{number\_zero}(\\{denom}))\5
${}\{{}$\C{ Protest division by zero }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'll\ pretend\ that\ y}\)\.{ou\
meant\ to\ divide\ b}\)\.{y\ 1."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Division\ by\ zero"},\39\\{hlp},\39\\{true});{}$%
\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\\{num},\39\\{denom});{}$\6
\\{set\_cur\_exp\_value\_number}(\\{ret});\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\\{check\_arith}(\,);\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_min\_primary\_command}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_numeric\_token}){}$\5
${}\{{}$\C{ in particular, \PB{$\\{cur\_cmd}\MRL{{<}{>}}\\{plus\_or\_minus}$} }%
\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{mp\_number} \\{absnum}${},{}$ \\{absdenom};\7
\\{new\_number}(\\{absnum});\6
\\{new\_number}(\\{absdenom});\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_scan\_primary}(\\{mp});\6
${}\\{number\_clone}(\\{absnum},\39\\{num});{}$\6
\\{number\_abs}(\\{absnum});\6
${}\\{number\_clone}(\\{absdenom},\39\\{denom});{}$\6
\\{number\_abs}(\\{absdenom});\6
\&{if} ${}(\\{number\_greaterequal}(\\{absnum},\39\\{absdenom})\V(\\{mp}\MG%
\\{cur\_exp}.\\{type}<\\{mp\_color\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\\{mp\_times});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_frac\_mult}(\\{mp},\39\\{num},\39\\{denom});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absnum});\6
\\{free\_number}(\\{absdenom});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{num});\6
\\{free\_number}(\\{denom});\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_nullary}:\C{ Scan a nullary operation }\6
${}\\{mp\_do\_nullary}(\\{mp},\39{}$(\&{quarterword}) \\{cur\_mod}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_unary}:\5
\&{case} \\{mp\_type\_name}:\5
\&{case} \\{mp\_cycle}:\5
\&{case} \\{mp\_plus\_or\_minus}:\6
${}\{{}$\C{ Scan a unary operation }\1\6
\&{quarterword} \|c;\C{ a primitive operation code }\7
${}\|c\K{}$(\&{quarterword}) \\{cur\_mod}(\,);\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
${}\\{mp\_do\_unary}(\\{mp},\39\|c);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_primary\_binary}:\6
${}\{{}$\C{ Scan a binary operation with `\&{of}' between its operands }\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{quarterword} \|c;\C{ a primitive operation code }\7
${}\|c\K{}$(\&{quarterword}) \\{cur\_mod}(\,);\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_of\_token}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ got\ the\ first\ }\)%
\.{argument;\ will\ look\ }\)\.{now\ for\ the\ other."},\39\NULL\};{}$\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{mp\_primary\_binary},\39\|c);{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ `of'\ has\ be}\)\.{en\
inserted\ for\ \%s"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\|c);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_str\_op}:\C{ Convert a suffix to a string }\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_suffix}(\\{mp});\6
${}\\{mp}\MG\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{cur\_exp\_node}(\,),\39\NULL,\39%
\T{100000},\39\T{0});{}$\6
${}\\{mp\_flush\_token\_list}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\\{set\_cur\_exp\_str}(\\{mp\_make\_string}(\\{mp}));\6
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{old\_setting};{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\&{goto} \.{DONE};\6
\&{break};\6
\4\&{case} \\{mp\_internal\_quantity}:\C{ Scan an internal numeric quantity }%
\C{ If an internal quantity appears all by itself on the left of an
assignment, we return a token list of length one, containing the address
of the internal quantity, with \PB{\\{name\_type}} equal to \PB{\\{mp\_internal%
\_sym}}.        (This accords with the conventions of the save stack, as
described earlier.) }\6
${}\{{}$\1\6
\&{halfword} \\{qq}${}\K\\{cur\_mod}(\,);{}$\7
\&{if} ${}(\\{my\_var\_flag}\E\\{mp\_assignment}){}$\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_assignment}){}$\5
${}\{{}$\1\6
\\{set\_cur\_exp\_node}(\\{mp\_get\_symbolic\_node}(\\{mp}));\6
${}\\{set\_mp\_sym\_info}(\\{cur\_exp\_node}(\,),\39\\{qq});{}$\6
${}\\{mp\_name\_type}(\\{cur\_exp\_node}(\,))\K\\{mp\_internal\_sym};{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_token\_list};{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\\{mp\_back\_input}(\\{mp});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{internal\_type}(\\{qq})\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\\{set\_cur\_exp\_str}(\\{internal\_string}(\\{qq}));\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_exp\_value\_number}(\\{internal\_value}(\\{qq}));\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{internal\_type}(\\{qq});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_capsule\_token}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{cur\_mod\_node}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_tag\_token}:\5
\X936:Scan a variable primary; \PB{\&{goto} \\{restart}} if it turns out to be
a macro\X;\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_bad\_exp}(\\{mp},\39\.{"A\ primary"});{}$\6
\&{goto} \.{RESTART};\6
\&{break};\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\C{ the routines \PB{\&{goto} \\{done}} if they
don't want this }\6
\4\.{DONE}:\5
\\{check\_for\_mediation}(\\{mp});\6
\4${}\}{}$\2\par
\As932, 943, 944, 946, 947, 948\ETs953.
\U1285.\fi

\M{932} Expressions of the form `\.{a[b,c]}' are converted into
`\.{b+a*(c-b)}', without checking the types of \.b~or~\.c,
provided that \.a is numeric.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{check\_for\_mediation}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ for list manipulation }\7
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_bracket}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\G\\{mp\_known}){}$\5
${}\{{}$\C{ Scan a mediation construction }\1\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\5
${}\{{}$\C{ Put the left bracket and the expression back to be rescanned }\C{
The left bracket that we thought was introducing a subscript might have
   actually been the left bracket in a mediation construction like `%
\.{x[a,b]}'.            So we don't issue an error message at this point; but
we do want to back up            so as to avoid any embarrassment about our
incorrect assumption. }\1\6
\\{mp\_back\_input}(\\{mp});\C{ that was the token following the current
expression }\6
\\{mp\_back\_expr}(\\{mp});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_left\_bracket});\6
\\{set\_cur\_mod\_number}(\\{zero\_t});\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_left\_bracket});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_right\_bracket}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ scanned\ an\ exp}\)\.{ression%
\ of\ the\ form\ }\)\.{`a[b,c',"},\39\.{"so\ a\ right\ bracket\ }\)\.{should\
have\ come\ nex}\)\.{t."},\39\.{"I\ shall\ pretend\ tha}\)\.{t\ one\ was\
there."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `]'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
${}\|r\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|q);{}$\6
${}\\{mp\_do\_binary}(\\{mp},\39\|r,\39\\{mp\_minus});{}$\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\\{mp\_times});{}$\6
${}\\{mp\_do\_binary}(\\{mp},\39\|q,\39\\{mp\_plus});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{933}Errors at the beginning of expressions are flagged by \PB{\\{bad\_exp}}.

\Y\B\&{static} \&{void} \\{mp\_bad\_exp}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{int} \\{save\_flag};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ afraid\ I\ need\ s}\)\.{ome\
sort\ of\ value\ in}\)\.{\ order\ to\ continue,"},\39\.{"so\ I've\ tentatively}%
\)\.{\ inserted\ `0'.\ You\ m}\)\.{ay\ want\ to"},\39\.{"delete\ this\ zero\
an}\)\.{d\ insert\ something\ e}\)\.{lse;"},\39\.{"see\ Chapter\ 27\ of\ T}\)%
\.{he\ METAFONTbook\ for\ }\)\.{an\ example."},\39\NULL\};{}$\7
;\6
${}\{{}$\1\6
\&{mp\_string} \\{cm};\6
\&{int} \\{old\_selector}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{cur\_cmd}(\,),\39\\{cur\_mod}(\,));{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_selector};{}$\6
${}\\{cm}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s\ expression\ can't}\)\.{\
begin\ with\ `\%s'"},\39\|s,\39\\{mp\_str}(\\{mp},\39\\{cm}));{}$\6
\\{delete\_str\_ref}(\\{cm});\6
\4${}\}{}$\2\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{set\_cur\_sym}(\NULL);{}$\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_numeric\_token});\6
\\{set\_cur\_mod\_number}(\\{zero\_t});\6
${}\\{mp\_ins\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
${}\\{save\_flag}\K\\{mp}\MG\\{var\_flag};{}$\6
${}\\{mp}\MG\\{var\_flag}\K\T{0};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{var\_flag}\K\\{save\_flag};{}$\6
\4${}\}{}$\2\par
\fi

\M{934}The \PB{\\{stash\_in}} subroutine puts the current (numeric) expression
into a field
within a ``big node.''

\Y\B\&{static} \&{void} \\{mp\_stash\_in}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ temporary register }\7
${}\\{mp\_type}(\|p)\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{cur\_exp\_value\_number}(\,));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_independent}){}$\5
${}\{{}$\C{ Stash an independent \PB{\\{cur\_exp}} into a big node }\C{ In rare
cases the current expression can become \PB{\\{independent}}. There
may be many dependency lists pointing to such an independent capsule, 	 so we
can't simply move it into place within a big node. Instead, 	 we copy it, then
recycle it. }\1\6
${}\|q\K\\{mp\_single\_dependency}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\|q\E\\{mp}\MG\\{dep\_final}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\|p)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{zero\_t});{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_new\_dep}(\\{mp},\39\|p,\39\\{mp\_dependent},\39\|q);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_dep\_list}((\&{mp\_value\_node}) \|p${},\39{}$\\{dep\_list}((\&{mp%
\_value\_node}) \\{cur\_exp\_node}(\,)));\6
\\{set\_prev\_dep}((\&{mp\_value\_node}) \|p${},\39{}$\\{prev\_dep}((\&{mp%
\_value\_node}) \\{cur\_exp\_node}(\,)));\6
\\{set\_mp\_link}(\\{prev\_dep}((\&{mp\_value\_node}) \|p)${},\39\|p);{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{cur\_exp%
\_node}(\,));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\par
\fi

\M{935}The most difficult part of \PB{\\{scan\_primary}} has been saved for
last, since
it was necessary to build up some confidence first. We can now face the task
of scanning a variable.

As we scan a variable, we build a token list containing the relevant
names and subscript values, simultaneously following along in the
``collective'' structure to see if we are actually dealing with a macro
instead of a value.

The local variables \PB{\\{pre\_head}} and \PB{\\{post\_head}} will point to
the beginning
of the prefix and suffix lists; \PB{\\{tail}} will point to the end of the list
that is currently growing.

Another local variable, \PB{\\{tt}}, contains partial information about the
declared type of the variable-so-far. If \PB{$\\{tt}\G\\{mp\_unsuffixed%
\_macro}$}, the
relation \PB{$\\{tt}\K\\{mp\_type}(\|q)$} will always hold. If \PB{$\\{tt}\K%
\\{undefined}$}, the routine
doesn't bother to update its information about type. And if
\PB{$\\{undefined}<\\{tt}<\\{mp\_unsuffixed\_macro}$}, the precise value of %
\PB{\\{tt}} isn't critical.

\fi

\M{936}\B\X936:Scan a variable primary; \PB{\&{goto} \\{restart}} if it turns
out to be a macro\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q;\C{ for list manipulation }\6
\&{mp\_node} \|t;\C{ a token }\6
\&{mp\_node} \\{pre\_head}${},{}$ \\{post\_head}${},{}$ \\{tail};\C{ prefix and
suffix list variables }\6
\&{quarterword} \\{tt};\C{ approximation to the type of the variable-so-far }\6
\&{mp\_node} \\{macro\_ref}${}\K\T{0}{}$;\C{ reference count for a suffixed
macro }\7
${}\\{pre\_head}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{tail}\K\\{pre\_head};{}$\6
${}\\{post\_head}\K\NULL;{}$\6
${}\\{tt}\K\\{mp\_vacuous};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|t\K\\{mp\_cur\_tok}(\\{mp});{}$\6
${}\\{mp\_link}(\\{tail})\K\|t;{}$\6
\&{if} ${}(\\{tt}\I\\{mp\_undefined}){}$\5
${}\{{}$\C{ Find the approximate type \PB{\\{tt}} and corresponding~\PB{\|q} }%
\C{ Every time we call \PB{\\{get\_x\_next}}, there's a chance that the
variable we've          been looking at will disappear. Thus, we cannot safely
keep \PB{\|q} pointing          into the variable structure; we need to start
searching from the root each          time. }\1\6
\&{mp\_sym} \\{qq};\7
${}\|p\K\\{mp\_link}(\\{pre\_head});{}$\6
${}\\{qq}\K\\{mp\_sym\_sym}(\|p);{}$\6
${}\\{tt}\K\\{mp\_undefined};{}$\6
\&{if} ${}(\\{eq\_type}(\\{qq})\MOD\\{mp\_outer\_tag}\E\\{mp\_tag\_token}){}$\5
${}\{{}$\1\6
${}\|q\K\\{equiv\_node}(\\{qq});{}$\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\&{goto} \.{DONE2};\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\\{tt}\K\\{mp\_type}(\|q);{}$\6
\&{goto} \.{DONE2};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\|q)\I\\{mp\_structured}){}$\1\5
\&{goto} \.{DONE2};\2\6
${}\|q\K\\{mp\_link}(\\{attr\_head}(\|q)){}$;\C{ the \PB{\\{collective%
\_subscript}} attribute }\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_symbol\_node}){}$\5
${}\{{}$\C{ it's not a subscript }\1\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\R(\\{hashloc}(\|q)\G\\{mp\_sym\_sym}(\|p)));{}$\6
\&{if} ${}(\\{hashloc}(\|q)>\\{mp\_sym\_sym}(\|p)){}$\1\5
\&{goto} \.{DONE2};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4\.{DONE2}:\6
\&{if} ${}(\\{tt}\G\\{mp\_unsuffixed\_macro}){}$\5
${}\{{}$\C{ Either begin an unsuffixed macro call or           prepare for a
suffixed one }\1\6
${}\\{mp\_link}(\\{tail})\K\NULL;{}$\6
\&{if} ${}(\\{tt}>\\{mp\_unsuffixed\_macro}){}$\5
${}\{{}$\C{ \PB{$\\{tt}\K\\{mp\_suffixed\_macro}$} }\1\6
${}\\{post\_head}\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{tail}\K\\{post\_head};{}$\6
${}\\{mp\_link}(\\{tail})\K\|t;{}$\6
${}\\{tt}\K\\{mp\_undefined};{}$\6
${}\\{macro\_ref}\K\\{value\_node}(\|q);{}$\6
\\{add\_mac\_ref}(\\{macro\_ref});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Set up unsuffixed macro call and \PB{\&{goto} \\{restart}} }\C{ The
only complication associated with macro calling is that the prefix
and ``at'' parameters must be packaged in an appropriate list of lists. }\1\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\\{pre\_head},\39\\{mp\_link}(\\{pre\_head}));{}$\6
${}\\{mp\_link}(\\{pre\_head})\K\|p;{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\|t);{}$\6
${}\\{mp\_macro\_call}(\\{mp},\39\\{value\_node}(\|q),\39\\{pre\_head},\39%
\NULL);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{tail}\K\|t;{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_bracket}){}$\5
${}\{{}$\C{ Scan for a subscript; replace \PB{\\{cur\_cmd}} by \PB{\\{numeric%
\_token}} if found }\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_right\_bracket}){}$\5
${}\{{}$\C{ Put the left bracket and the expression back to be rescanned }\C{
The left bracket that we thought was introducing a subscript might have
   actually been the left bracket in a mediation construction like `%
\.{x[a,b]}'.            So we don't issue an error message at this point; but
we do want to back up            so as to avoid any embarrassment about our
incorrect assumption. }\1\6
\\{mp\_back\_input}(\\{mp});\C{ that was the token following the current
expression }\6
\\{mp\_back\_expr}(\\{mp});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_left\_bracket});\6
\\{set\_cur\_mod\_number}(\\{zero\_t});\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{frozen\_left\_bracket});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\1\5
\\{mp\_bad\_subscript}(\\{mp});\2\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_numeric\_token});\6
\\{set\_cur\_mod\_number}(\\{cur\_exp\_value\_number}(\,));\6
${}\\{set\_cur\_sym}(\NULL);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)>\\{mp\_max\_suffix\_token}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_min\_suffix\_token}){}$\1\5
\&{break};\2\6
\4${}\}{}$\C{ now \PB{\\{cur\_cmd}} is \PB{\\{internal\_quantity}}, \PB{\\{tag%
\_token}}, or \PB{\\{numeric\_token}} }\C{ Handle unusual cases that masquerade
as variables, and \PB{\&{goto} \\{restart}} or       \PB{\&{goto} \\{done}} if
appropriate; otherwise make a copy of the variable and \PB{\&{goto} \\{done}} }%
\C{ If the variable does exist, we also need to check       for a few other
special cases before deciding that a plain old ordinary       variable has,
indeed, been scanned. }\2\6
\&{if} ${}(\\{post\_head}\I\NULL){}$\5
${}\{{}$\C{ Set up suffixed macro call and \PB{\&{goto} \\{restart}} }\C{ If
the ``variable'' that turned out to be a suffixed macro no longer exists,
 we don't care, because we have reserved a pointer (\PB{\\{macro\_ref}}) to its
       token list. }\1\6
\\{mp\_back\_input}(\\{mp});\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|q\K\\{mp\_link}(\\{post\_head});{}$\6
${}\\{set\_mp\_sym\_sym}(\\{pre\_head},\39\\{mp\_link}(\\{pre\_head}));{}$\6
${}\\{mp\_link}(\\{pre\_head})\K\\{post\_head};{}$\6
${}\\{set\_mp\_sym\_sym}(\\{post\_head},\39\|q);{}$\6
${}\\{mp\_link}(\\{post\_head})\K\|p;{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{mp\_link}(\|q));{}$\6
${}\\{mp\_link}(\|q)\K\NULL;{}$\6
${}\\{mp\_macro\_call}(\\{mp},\39\\{macro\_ref},\39\\{pre\_head},\39\NULL);{}$\6
\\{decr\_mac\_ref}(\\{macro\_ref});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_link}(\\{pre\_head});{}$\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\\{pre\_head});{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{my\_var\_flag}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_token\_list};{}$\6
\\{set\_cur\_exp\_node}(\|q);\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_find\_variable}(\\{mp},\39\|q);{}$\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"While\ I\ was\ evaluat}\)\.{ing\
the\ suffix\ of\ th}\)\.{is\ variable,"},\39\.{"something\ was\ redef}\)%
\.{ined,\ and\ it's\ no\ lo}\)\.{nger\ a\ variable!"},\39\.{"In\ order\ to\ get%
\ bac}\)\.{k\ on\ my\ feet,\ I've\ i}\)\.{nserted\ `0'\ instead.}\)\.{"},\39%
\NULL\};{}$\6
\&{char} ${}{*}\\{msg}\K\\{mp\_obliterated}(\\{mp},\39\|q);{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{free}(\\{msg});\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\|q);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U931.\fi

\M{937}Here's a routine that puts the current expression back to be read again.

\Y\B\&{static} \&{void} \\{mp\_back\_expr}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ capsule token }\7
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_link}(\|p)\K\NULL;{}$\6
\\{back\_list}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{938}Unknown subscripts lead to the following error message.

\Y\B\&{static} \&{void} \\{mp\_bad\_subscript}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ bracketed\ subscri}\)\.{pt\ must%
\ have\ a\ known}\)\.{\ numeric\ value;"},\39\.{"unfortunately,\ what}\)\.{\ I\
found\ was\ the\ val}\)\.{ue\ that\ appears\ just}\)\.{"},\39\.{"above\ this\
error\ me}\)\.{ssage.\ So\ I'll\ try\ a}\)\.{\ zero\ subscript."},\39\NULL%
\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_error}(\\{mp},\39\.{"Improper\ subscript\ }\)\.{has\ been\ replaced\
by}\)\.{\ zero"},\39\\{hlp},\39\\{true});{}$\6
;\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{939}How do things stand now? Well, we have scanned an entire variable name,
including possible subscripts and/or attributes; \PB{\\{cur\_cmd}}, \PB{\\{cur%
\_mod}}, and
\PB{\\{cur\_sym}} represent the token that follows. If \PB{$\\{post\_head}\K%
\NULL$}, a
token list for this variable name starts at \PB{\\{mp\_link}(\\{pre\_head})},
with all
subscripts evaluated. But if \PB{$\\{post\_head}\MRL{{<}{>}}\NULL$}, the
variable turned out
to be a suffixed macro; \PB{\\{pre\_head}} is the head of the prefix list,
while
\PB{\\{post\_head}} is the head of a token list containing both `\.{\AT!}' and
the suffix.

Our immediate problem is to see if this variable still exists. (Variable
structures can change drastically whenever we call \PB{\\{get\_x\_next}}; users
aren't supposed to do this, but the fact that it is possible means that
we must be cautious.)

The following procedure creates an error message for when a variable
unexpectedly disappears.

\Y\B\&{static} \&{char} ${}{*}{}$\\{mp\_obliterated}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\|q,\39\NULL,\39\T{1000},\39\T{0});{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Variable\ \%s\ has\ bee}\)\.{n\
obliterated"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
;\6
\\{delete\_str\_ref}(\\{sname});\6
\&{return} \\{xstrdup}(\\{msg});\6
\4${}\}{}$\2\par
\fi

\M{940}Our remaining job is simply to make a copy of the value that has been
found. Some cases are harder than others, but complexity arises solely
because of the multiplicity of possible cases.

\Y\B\4\X940:Declare the procedure called \PB{\\{make\_exp\_copy}}\X${}\E{}$\6
\X941:Declare subroutines needed by \PB{\\{make\_exp\_copy}}\X;\7
\&{static} \&{void} \\{mp\_make\_exp\_copy}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|t;\C{ register(s) for list manipulation }\6
\&{mp\_value\_node} \|q;\7
\4\.{RESTART}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_type}(\|p);{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_known}:\5
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\|p));\6
\&{break};\6
\4\&{case} \\{unknown\_types}:\5
${}\|t\K\\{mp\_new\_ring\_entry}(\\{mp},\39\|p);{}$\6
\\{set\_cur\_exp\_node}(\|t);\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
\\{set\_cur\_exp\_str}(\\{value\_str}(\|p));\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
\\{set\_cur\_exp\_node}(\\{value\_node}(\|p));\6
\\{add\_edge\_ref}(\\{cur\_exp\_node}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
\\{set\_cur\_exp\_knot}(\\{copy\_pen}(\\{value\_knot}(\|p)));\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{set\_cur\_exp\_knot}(\\{mp\_copy\_path}(\\{mp},\39\\{value\_knot}(%
\|p)));{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\C{ Copy the big node \PB{\|p} }\C{ The most
tedious case arises when the user refers to a        \&{pair}, \&{color}, or %
\&{transform} variable; we must copy several fields,        each of which can
be \PB{\\{independent}}, \PB{\\{dependent}}, \PB{\\{mp\_proto\_dependent}},
   or \PB{\\{known}}. }\6
\&{if} ${}(\\{value\_node}(\|p)\E\NULL){}$\5
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\\{mp\_init\_pair\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\\{mp\_init\_color\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\\{mp\_init\_cmykcolor\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\\{mp\_init\_transform\_node}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\|t)\K\\{mp\_capsule};{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{value\_node}(\|p);\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\\{mp\_init\_pair\_node}(\\{mp},\39\|t);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{y\_part}(\\{value\_node}(\|t)),\39\\{y\_part}(%
\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{x\_part}(\\{value\_node}(\|t)),\39\\{x\_part}(%
\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\\{mp\_init\_color\_node}(\\{mp},\39\|t);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{blue\_part}(\\{value\_node}(\|t)),\39\\{blue%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{green\_part}(\\{value\_node}(\|t)),\39\\{green%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{red\_part}(\\{value\_node}(\|t)),\39\\{red%
\_part}(\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\\{mp\_init\_cmykcolor\_node}(\\{mp},\39\|t);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{black\_part}(\\{value\_node}(\|t)),\39\\{black%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yellow\_part}(\\{value\_node}(\|t)),\39%
\\{yellow\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{magenta\_part}(\\{value\_node}(\|t)),\39%
\\{magenta\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{cyan\_part}(\\{value\_node}(\|t)),\39\\{cyan%
\_part}(\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\\{mp\_init\_transform\_node}(\\{mp},\39\|t);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yy\_part}(\\{value\_node}(\|t)),\39\\{yy%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yx\_part}(\\{value\_node}(\|t)),\39\\{yx%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{xy\_part}(\\{value\_node}(\|t)),\39\\{xy%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{xx\_part}(\\{value\_node}(\|t)),\39\\{xx%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{ty\_part}(\\{value\_node}(\|t)),\39\\{ty%
\_part}(\|q));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{tx\_part}(\\{value\_node}(\|t)),\39\\{tx%
\_part}(\|q));{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\\{set\_cur\_exp\_node}(\|t);\6
\&{break};\6
\4\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
${}\\{mp\_encapsulate}(\\{mp},\39\\{mp\_copy\_dep\_list}(\\{mp},\39{}$(\&{mp%
\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p)));\6
\&{break};\6
\4\&{case} \\{mp\_numeric\_type}:\5
${}\\{mp\_new\_indep}(\\{mp},\39\|p);{}$\6
\&{goto} \.{RESTART};\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\|q\K\\{mp\_single\_dependency}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\|q\E\\{mp}\MG\\{dep\_final}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\\{set\_cur\_exp\_value\_number}(\\{zero\_t});\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_dependent};{}$\6
${}\\{mp\_encapsulate}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_confusion}(\\{mp},\39\.{"copy"});{}$\6
;\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U707.\fi

\M{941}The \PB{\\{encapsulate}} subroutine assumes that \PB{\\{dep\_final}} is
the
tail of dependency list~\PB{\|p}.

\Y\B\4\X941:Declare subroutines needed by \PB{\\{make\_exp\_copy}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_encapsulate}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${}\K\\{mp\_get\_value\_node}(\\{mp});{}$\7
${}\.{FUNCTION\_TRACE2}(\.{"mp\_encapsulate(\%p)\\}\)\.{n"},\39\|p);{}$\6
${}\\{mp\_name\_type}(\|q)\K\\{mp\_capsule};{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|q,\39\\{mp}\MG\\{cur\_exp}.\\{type},\39\|p);{}$%
\6
\\{set\_cur\_exp\_node}(\|q);\6
\4${}\}{}$\2\par
\A942.
\U940.\fi

\M{942}The \PB{\\{install}} procedure copies a numeric field~\PB{\|q} into
field~\PB{\|r} of
a big node that will be part of a capsule.

\Y\B\4\X941:Declare subroutines needed by \PB{\\{make\_exp\_copy}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_install}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|r${},%
\39{}$\&{mp\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p;\C{ temporary register }\7
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\|r)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|r,\39\\{value\_number}(\|q));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_independent}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_single\_dependency}(\\{mp},\39\|q);{}$\6
\&{if} ${}(\|p\E\\{mp}\MG\\{dep\_final}){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\|r)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|r,\39\\{zero\_t});{}$\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_dependent},\39\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\|q),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) %
\|q)));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{943}Here is a comparatively simple routine that is used to scan the
\&{suffix} parameters of a macro.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_suffix}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|h${},{}$ \|t;\C{ head and tail of the list being built }\6
\&{mp\_node} \|p;\C{ temporary register }\7
${}\|h\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|t\K\|h;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_bracket}){}$\5
${}\{{}$\C{ Scan a bracketed subscript and set \PB{\\{cur\_cmd}: $\K$ %
\\{numeric\_token}} }\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\1\5
\\{mp\_bad\_subscript}(\\{mp});\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_right\_bracket}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ seen\ a\ `['\ and}\)\.{\ a\
subscript\ value,\ }\)\.{in\ a\ suffix,"},\39\.{"so\ a\ right\ bracket\ }\)%
\.{should\ have\ come\ nex}\)\.{t."},\39\.{"I\ shall\ pretend\ tha}\)\.{t\ one\
was\ there."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `]'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_numeric\_token});\6
\\{set\_cur\_mod\_number}(\\{cur\_exp\_value\_number}(\,));\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_numeric\_token}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{cur\_mod\_number}(\,));{}$\6
${}\|p\K\\{mp\_new\_num\_tok}(\\{mp},\39\\{arg1});{}$\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_tag\_token})\V(\\{cur\_cmd}(\,)\E%
\\{mp\_internal\_quantity})){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|p,\39\\{cur\_sym}(\,));{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{cur\_sym\_mod}(\,);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|t)\K\|p;{}$\6
${}\|t\K\|p;{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\\{set\_cur\_exp\_node}(\\{mp\_link}(\|h));\6
${}\\{mp\_free\_symbolic\_node}(\\{mp},\39\|h);{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_token\_list};{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{944}Parsing secondary and higher expressions.

After the intricacies of \PB{\\{scan\_primary}}\kern-1pt,
the \PB{\\{scan\_secondary}} routine is
refreshingly simple. It's not trivial, but the operations are relatively
straightforward; the main difficulty is, again, that expressions and data
structures might change drastically every time we call \PB{\\{get\_x\_next}},
so a
cautious approach is mandatory. For example, a macro defined by
\&{primarydef} might have disappeared by the time its second argument has
been scanned; we solve this by increasing the reference count of its token
list, so that the macro can be called even after it has been clobbered.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_secondary}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{halfword} \|c${},{}$ \|d;\C{ operation codes or modifiers }\6
\&{mp\_node} \\{cc}${}\K\NULL;{}$\6
\&{mp\_sym} \\{mac\_name}${}\K\NULL{}$;\C{ token defined with \&{primarydef} }\7
\4\.{RESTART}:\6
\&{if} ${}((\\{cur\_cmd}(\,)<\\{mp\_min\_primary\_command})\V(\\{cur\_cmd}(\,)>%
\\{mp\_max\_primary\_command})){}$\1\5
${}\\{mp\_bad\_exp}(\\{mp},\39\.{"A\ secondary"});{}$\2\6
;\6
\\{mp\_scan\_primary}(\\{mp});\6
\4\.{CONTINUE}:\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_max\_secondary\_command}\W\\{cur\_cmd}(\,)%
\G\\{mp\_min\_secondary\_command}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\|d\K\\{cur\_cmd}(\,);{}$\6
${}\|c\K\\{cur\_mod}(\,);{}$\6
\&{if} ${}(\|d\E\\{mp\_secondary\_primary\_macro}){}$\5
${}\{{}$\1\6
${}\\{cc}\K\\{cur\_mod\_node}(\,);{}$\6
${}\\{mac\_name}\K\\{cur\_sym}(\,);{}$\6
\\{add\_mac\_ref}(\\{cc});\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
\&{if} ${}(\|d\I\\{mp\_secondary\_primary\_macro}){}$\5
${}\{{}$\1\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\|c);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{mp\_binary\_mac}(\\{mp},\39\|p,\39\\{cc},\39\\{mac\_name});{}$\6
\\{decr\_mac\_ref}(\\{cc});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{945}The following procedure calls a macro that has two parameters,
\PB{\|p} and \PB{\\{cur\_exp}}.

\Y\B\&{static} \&{void} \\{mp\_binary\_mac}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p${},\39{}$\&{mp\_node} \|c${},\39{}$\&{mp\_sym} \|n)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r;\C{ nodes in the parameter list }\7
${}\|q\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|r\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{mp\_link}(\|q)\K\|r;{}$\6
${}\\{set\_mp\_sym\_sym}(\|q,\39\|p);{}$\6
${}\\{set\_mp\_sym\_sym}(\|r,\39\\{mp\_stash\_cur\_exp}(\\{mp}));{}$\6
${}\\{mp\_macro\_call}(\\{mp},\39\|c,\39\|q,\39\|n);{}$\6
\4${}\}{}$\2\par
\fi

\M{946}The next procedure, \PB{\\{scan\_tertiary}}, is pretty much the same
deal.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_tertiary}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{halfword} \|c${},{}$ \|d;\C{ operation codes or modifiers }\6
\&{mp\_node} \\{cc}${}\K\NULL;{}$\6
\&{mp\_sym} \\{mac\_name}${}\K\NULL{}$;\C{ token defined with \&{secondarydef}
}\7
\4\.{RESTART}:\6
\&{if} ${}((\\{cur\_cmd}(\,)<\\{mp\_min\_primary\_command})\V(\\{cur\_cmd}(\,)>%
\\{mp\_max\_primary\_command})){}$\1\5
${}\\{mp\_bad\_exp}(\\{mp},\39\.{"A\ tertiary"});{}$\2\6
;\6
\\{mp\_scan\_secondary}(\\{mp});\6
\4\.{CONTINUE}:\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_max\_tertiary\_command}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_min\_tertiary\_command}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\|c\K\\{cur\_mod}(\,);{}$\6
${}\|d\K\\{cur\_cmd}(\,);{}$\6
\&{if} ${}(\|d\E\\{mp\_tertiary\_secondary\_macro}){}$\5
${}\{{}$\1\6
${}\\{cc}\K\\{cur\_mod\_node}(\,);{}$\6
${}\\{mac\_name}\K\\{cur\_sym}(\,);{}$\6
\\{add\_mac\_ref}(\\{cc});\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_secondary}(\\{mp});\6
\&{if} ${}(\|d\I\\{mp\_tertiary\_secondary\_macro}){}$\5
${}\{{}$\1\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\|c);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{mp\_binary\_mac}(\\{mp},\39\|p,\39\\{cc},\39\\{mac\_name});{}$\6
\\{decr\_mac\_ref}(\\{cc});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{947}Finally we reach the deepest level in our quartet of parsing routines.
This one is much like the others; but it has an extra complication from
paths, which materialize here.

\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{int} \\{mp\_scan\_path}(\&{MP} \\{mp});\7
\&{static} \&{void} \\{mp\_scan\_expression}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \\{my\_var\_flag};\C{ initial value of \PB{\\{var\_flag}} }\7
${}\\{my\_var\_flag}\K\\{mp}\MG\\{var\_flag};{}$\6
\\{check\_expansion\_depth}(\,);\6
\4\.{RESTART}:\6
\&{if} ${}((\\{cur\_cmd}(\,)<\\{mp\_min\_primary\_command})\V(\\{cur\_cmd}(\,)>%
\\{mp\_max\_primary\_command})){}$\1\5
${}\\{mp\_bad\_exp}(\\{mp},\39\.{"An"});{}$\2\6
;\6
\\{mp\_scan\_tertiary}(\\{mp});\6
\4\.{CONTINUE}:\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_max\_expression\_command}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_min\_expression\_command}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{cur\_cmd}(\,)\I\\{mp\_equals})\V(\\{my\_var\_flag}\I\\{mp%
\_assignment})){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{mp\_node} \\{cc}${}\K\NULL;{}$\6
\&{halfword} \|c;\6
\&{halfword} \|d;\C{ operation codes or modifiers }\6
\&{mp\_sym} \\{mac\_name};\C{ token defined with \&{tertiarydef} }\7
${}\\{mac\_name}\K\NULL;{}$\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\|d\K\\{cur\_cmd}(\,);{}$\6
${}\|c\K\\{cur\_mod}(\,);{}$\6
\&{if} ${}(\|d\E\\{mp\_expression\_tertiary\_macro}){}$\5
${}\{{}$\1\6
${}\\{cc}\K\\{cur\_mod\_node}(\,);{}$\6
${}\\{mac\_name}\K\\{cur\_sym}(\,);{}$\6
\\{add\_mac\_ref}(\\{cc});\6
\4${}\}{}$\2\6
\&{if} ${}((\|d<\\{mp\_ampersand})\V((\|d\E\\{mp\_ampersand})\W((\\{mp\_type}(%
\|p)\E\\{mp\_pair\_type})\V(\\{mp\_type}(\|p)\E\\{mp\_path\_type})))){}$\5
${}\{{}$\C{ Scan a path construction operation;  but \PB{\&{return}} if \PB{%
\|p} has the wrong type }\1\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\R\\{mp\_scan\_path}(\\{mp})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{expand\_depth\_count}\MM;{}$\6
\&{return};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_tertiary}(\\{mp});\6
\&{if} ${}(\|d\I\\{mp\_expression\_tertiary\_macro}){}$\5
${}\{{}$\1\6
${}\\{mp\_do\_binary}(\\{mp},\39\|p,\39\|c);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
${}\\{mp\_binary\_mac}(\\{mp},\39\|p,\39\\{cc},\39\\{mac\_name});{}$\6
\\{decr\_mac\_ref}(\\{cc});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{expand\_depth\_count}\MM;{}$\6
\4${}\}{}$\2\par
\fi

\M{948}The reader should review the data structure conventions for paths before
hoping to understand the next part of this code.

\Y\B\4\D$\\{min\_tension}$ \5
\\{three\_quarter\_unit\_t}\par
\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{force\_valid\_tension\_setting}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known})\V\\{number\_less}(%
\\{cur\_exp\_value\_number}(\,),\39\\{min\_tension})){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ expression\ abov}\)\.{e\
should\ have\ been\ a}\)\.{\ number\ >=3/4."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{unity\_t});{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ tension\ ha}\)\.{s\ been\ set\
to\ 1"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{int} \\{mp\_scan\_path}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \\{path\_p}${},{}$ \\{path\_q}${},{}$ \|r;\6
\&{mp\_knot} \\{pp}${},{}$ \\{qq};\6
\&{halfword} \|d;\C{ operation code or modifier }\6
\&{boolean} \\{cycle\_hit};\C{ did a path expression just end with `\&{cycle}'?
}\6
\&{mp\_number} \|x${},{}$ \|y;\C{ explicit coordinates or tension at a path
join }\6
\&{int} \|t;\C{ knot type following a path join }\7
${}\|t\K\T{0};{}$\6
${}\\{cycle\_hit}\K\\{false}{}$;\C{ Convert the left operand, \PB{\|p}, into a
partial path ending at~\PB{\|q};     but \PB{\&{return}} if \PB{\|p} doesn't
have a suitable type }\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
${}\\{path\_p}\K\\{mp\_pair\_to\_knot}(\\{mp});{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type}){}$\1\5
${}\\{path\_p}\K\\{cur\_exp\_knot}(\,);{}$\2\6
\&{else}\1\5
\&{return} \T{0};\2\6
${}\\{path\_q}\K\\{path\_p};{}$\6
\&{while} ${}(\\{mp\_next\_knot}(\\{path\_q})\I\\{path\_p}){}$\1\5
${}\\{path\_q}\K\\{mp\_next\_knot}(\\{path\_q});{}$\2\6
\&{if} ${}(\\{mp\_left\_type}(\\{path\_p})\I\\{mp\_endpoint}){}$\5
${}\{{}$\C{ open up a cycle }\1\6
${}\|r\K\\{mp\_copy\_knot}(\\{mp},\39\\{path\_p});{}$\6
${}\\{mp\_next\_knot}(\\{path\_q})\K\|r;{}$\6
${}\\{path\_q}\K\|r;{}$\6
\4${}\}{}$\2\6
${}\\{mp\_left\_type}(\\{path\_p})\K\\{mp\_open};{}$\6
${}\\{mp\_right\_type}(\\{path\_q})\K\\{mp\_open};{}$\6
\\{new\_number}(\|y);\6
\\{new\_number}(\|x);\6
\4\.{CONTINUE\_PATH}:\C{ Determine the path join parameters;     but \PB{%
\&{goto} \\{finish\_path}} if there's only a direction specifier }\C{ At this
point \PB{\\{cur\_cmd}} is either \PB{\\{ampersand}}, \PB{\\{left\_brace}}, or %
\PB{\\{path\_join}}. }\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_brace}){}$\5
${}\{{}$\C{ Put the pre-join direction information into node \PB{\|q} }\C{ At
this point \PB{\\{mp\_right\_type}(\|q)} is usually \PB{\\{open}}, but it may
have been        set to some other value by a previous operation. We must
maintain        the value of \PB{\\{mp\_right\_type}(\|q)} in cases such as
   `\.{..\{curl2\}z\{0,0\}..}'. }\1\6
${}\|t\K\\{mp\_scan\_direction}(\\{mp});{}$\6
\&{if} ${}(\|t\I\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{path\_q})\K{}$(\&{unsigned} \&{short}) \|t;\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_given},\39\\{cur\_exp\_value%
\_number}(\,));{}$\6
\&{if} ${}(\\{mp\_left\_type}(\\{path\_q})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\\{path\_q})\K{}$(\&{unsigned} \&{short}) \|t;\6
${}\\{number\_clone}(\\{path\_q}\MG\\{left\_given},\39\\{cur\_exp\_value%
\_number}(\,));{}$\6
\4${}\}{}$\C{ note that \PB{$\\{left\_given}(\|q)\K\\{left\_curl}(\|q)$} }\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|d\K\\{cur\_cmd}(\,);{}$\6
\&{if} ${}(\|d\E\\{mp\_path\_join}){}$\5
${}\{{}$\C{ Determine the tension and/or control points }\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_tension}){}$\5
${}\{{}$\C{ Set explicit tensions }\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{set\_number\_from\_scaled}(\|y,\39\\{cur\_cmd}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_at\_least}){}$\1\5
\\{mp\_get\_x\_next}(\\{mp});\2\6
\\{mp\_scan\_primary}(\\{mp});\6
\\{force\_valid\_tension\_setting}(\\{mp});\6
\&{if} ${}(\\{number\_to\_scaled}(\|y)\E\\{mp\_at\_least}){}$\5
${}\{{}$\1\6
\&{if} (\\{is\_number}(\\{cur\_exp\_value\_number}(\,)))\1\5
\\{number\_negate}(\\{cur\_exp\_value\_number}(\,));\2\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_tension},\39\\{cur\_exp\_value%
\_number}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_and\_command}){}$\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{set\_number\_from\_scaled}(\|y,\39\\{cur\_cmd}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_at\_least}){}$\1\5
\\{mp\_get\_x\_next}(\\{mp});\2\6
\\{mp\_scan\_primary}(\\{mp});\6
\\{force\_valid\_tension\_setting}(\\{mp});\6
\&{if} ${}(\\{number\_to\_scaled}(\|y)\E\\{mp\_at\_least}){}$\5
${}\{{}$\1\6
\&{if} (\\{is\_number}(\\{cur\_exp\_value\_number}(\,)))\1\5
\\{number\_negate}(\\{cur\_exp\_value\_number}(\,));\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\|y,\39\\{cur\_exp\_value\_number}(\,));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_controls}){}$\5
${}\{{}$\C{ Set explicit control points }\1\6
${}\\{mp\_right\_type}(\\{path\_q})\K\\{mp\_explicit};{}$\6
${}\|t\K\\{mp\_explicit};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
\\{mp\_known\_pair}(\\{mp});\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_x},\39\\{mp}\MG\\{cur\_x});{}$\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_y},\39\\{mp}\MG\\{cur\_y});{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_and\_command}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{path\_q}\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{path\_q}\MG\\{right\_y});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_primary}(\\{mp});\6
\\{mp\_known\_pair}(\\{mp});\6
${}\\{number\_clone}(\|x,\39\\{mp}\MG\\{cur\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{mp}\MG\\{cur\_y});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}(\\{path\_q}\MG\\{right\_tension});{}$\6
\\{set\_number\_to\_unity}(\|y);\6
\\{mp\_back\_input}(\\{mp});\C{ default tension }\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
;\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_path\_join}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ path\ join\ command}\)\.{\
should\ end\ with\ two}\)\.{\ dots."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `..'\ has\ be}\)\.{en\
inserted"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\4\.{DONE}:\5
;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|d\I\\{mp\_ampersand}){}$\5
${}\{{}$\1\6
\&{goto} \.{FINISH\_PATH};\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_brace}){}$\5
${}\{{}$\C{ Put the post-join direction information into \PB{\|x} and \PB{\|t}
}\C{ Since \PB{\\{left\_tension}} and \PB{\\{mp\_left\_y}} share the same
position in knot nodes,        and since \PB{\\{left\_given}} is similarly
equivalent to \PB{\\{left\_x}}, we use        \PB{\|x} and \PB{\|y} to hold the
given direction and tension information when        there are no explicit
control points. }\1\6
${}\|t\K\\{mp\_scan\_direction}(\\{mp});{}$\6
\&{if} ${}(\\{mp\_right\_type}(\\{path\_q})\I\\{mp\_explicit}){}$\1\5
${}\\{number\_clone}(\|x,\39\\{cur\_exp\_value\_number}(\,));{}$\2\6
\&{else}\1\5
${}\|t\K\\{mp\_explicit}{}$;\C{ the direction information is superfluous }\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_right\_type}(\\{path\_q})\I\\{mp\_explicit}){}$\5
${}\{{}$\1\6
${}\|t\K\\{mp\_open};{}$\6
\\{set\_number\_to\_zero}(\|x);\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_cycle}){}$\5
${}\{{}$\C{ Get ready to close a cycle }\C{ If a person tries to define an
entire path by saying `\.{(x,y)\&cycle}',        we silently change the
specification to `\.{(x,y)..cycle}', since a cycle        shouldn't have length
zero. }\1\6
${}\\{cycle\_hit}\K\\{true};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{pp}\K\\{path\_p};{}$\6
${}\\{qq}\K\\{path\_p};{}$\6
\&{if} ${}(\|d\E\\{mp\_ampersand}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{path\_p}\E\\{path\_q}){}$\5
${}\{{}$\1\6
${}\|d\K\\{mp\_path\_join};{}$\6
${}\\{set\_number\_to\_unity}(\\{path\_q}\MG\\{right\_tension});{}$\6
\\{set\_number\_to\_unity}(\|y);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_scan\_tertiary}(\\{mp});\C{ Convert the right operand, \PB{\\{cur%
\_exp}},       into a partial path from \PB{\\{pp}} to~\PB{\\{qq}} }\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\1\5
${}\\{pp}\K\\{mp\_pair\_to\_knot}(\\{mp});{}$\2\6
\&{else}\1\5
${}\\{pp}\K\\{cur\_exp\_knot}(\,);{}$\2\6
${}\\{qq}\K\\{pp};{}$\6
\&{while} ${}(\\{mp\_next\_knot}(\\{qq})\I\\{pp}){}$\1\5
${}\\{qq}\K\\{mp\_next\_knot}(\\{qq});{}$\2\6
\&{if} ${}(\\{mp\_left\_type}(\\{pp})\I\\{mp\_endpoint}){}$\5
${}\{{}$\C{ open up a cycle }\1\6
${}\|r\K\\{mp\_copy\_knot}(\\{mp},\39\\{pp});{}$\6
${}\\{mp\_next\_knot}(\\{qq})\K\|r;{}$\6
${}\\{qq}\K\|r;{}$\6
\4${}\}{}$\2\6
${}\\{mp\_left\_type}(\\{pp})\K\\{mp\_open};{}$\6
${}\\{mp\_right\_type}(\\{qq})\K\\{mp\_open};{}$\6
\4${}\}{}$\C{ Join the partial paths and reset \PB{\|p} and \PB{\|q} to the
head and tail     of the result }\2\6
\&{if} ${}(\|d\E\\{mp\_ampersand}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R(\\{number\_equal}(\\{path\_q}\MG\\{x\_coord},\39\\{pp}\MG\\{x%
\_coord}))\V\R(\\{number\_equal}(\\{path\_q}\MG\\{y\_coord},\39\\{pp}\MG\\{y%
\_coord}))){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"When\ you\ join\ paths}\)\.{\ `p%
\&q',\ the\ ending\ p}\)\.{oint\ of\ p"},\39\.{"must\ be\ exactly\ equ}\)\.{al\
to\ the\ starting\ p}\)\.{oint\ of\ q."},\39\.{"So\ I'm\ going\ to\ pre}\)%
\.{tend\ that\ you\ said\ `}\)\.{p..q'\ instead."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Paths\ don't\ touch;\ }\)\.{`\&'\ will\ be%
\ changed\ }\)\.{to\ `..'"},\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\|d\K\\{mp\_path\_join};{}$\6
${}\\{set\_number\_to\_unity}(\\{path\_q}\MG\\{right\_tension});{}$\6
\\{set\_number\_to\_unity}(\|y);\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ Plug an opening in \PB{\\{mp\_right\_type}(\\{pp})}, if possible
}\2\6
\&{if} ${}(\\{mp\_right\_type}(\\{pp})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
\&{if} ${}((\|t\E\\{mp\_curl})\V(\|t\E\\{mp\_given})){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{pp})\K{}$(\&{unsigned} \&{short}) \|t;\6
${}\\{number\_clone}(\\{pp}\MG\\{right\_given},\39\|x);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|d\E\\{mp\_ampersand}){}$\5
${}\{{}$\C{ Splice independent paths together }\1\6
\&{if} ${}(\\{mp\_left\_type}(\\{path\_q})\E\\{mp\_open}){}$\1\6
\&{if} ${}(\\{mp\_right\_type}(\\{path\_q})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\\{path\_q})\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\\{path\_q}\MG\\{left\_curl});{}$\6
\4${}\}{}$\2\2\6
\&{if} ${}(\\{mp\_right\_type}(\\{pp})\E\\{mp\_open}){}$\1\6
\&{if} ${}(\|t\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{pp})\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\\{pp}\MG\\{right\_curl});{}$\6
\4${}\}{}$\2\2\6
${}\\{mp\_right\_type}(\\{path\_q})\K\\{mp\_right\_type}(\\{pp});{}$\6
${}\\{mp\_next\_knot}(\\{path\_q})\K\\{mp\_next\_knot}(\\{pp});{}$\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_x},\39\\{pp}\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_y},\39\\{pp}\MG\\{right\_y});{}$\6
\\{mp\_xfree}(\\{pp});\6
\&{if} ${}(\\{qq}\E\\{pp}){}$\1\5
${}\\{qq}\K\\{path\_q};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Plug an opening in \PB{\\{mp\_right\_type}(\|q)}, if possible }\1\6
\&{if} ${}(\\{mp\_right\_type}(\\{path\_q})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{mp\_left\_type}(\\{path\_q})\E\\{mp\_curl})\V(\\{mp\_left%
\_type}(\\{path\_q})\E\\{mp\_given})){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{path\_q})\K\\{mp\_left\_type}(\\{path\_q});{}$\6
${}\\{number\_clone}(\\{path\_q}\MG\\{right\_given},\39\\{path\_q}\MG\\{left%
\_given});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_next\_knot}(\\{path\_q})\K\\{pp};{}$\6
${}\\{number\_clone}(\\{pp}\MG\\{left\_y},\39\|y);{}$\6
\&{if} ${}(\|t\I\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{pp}\MG\\{left\_x},\39\|x);{}$\6
${}\\{mp\_left\_type}(\\{pp})\K{}$(\&{unsigned} \&{short}) \|t;\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
${}\\{path\_q}\K\\{qq};{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\G\\{mp\_min\_expression\_command}){}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\Z\\{mp\_ampersand}){}$\1\6
\&{if} ${}(\R\\{cycle\_hit}){}$\1\5
\&{goto} \.{CONTINUE\_PATH};\2\2\2\6
\4\.{FINISH\_PATH}:\C{ Choose control points for the path and put the result
into \PB{\\{cur\_exp}} }\6
\&{if} (\\{cycle\_hit})\5
${}\{{}$\1\6
\&{if} ${}(\|d\E\\{mp\_ampersand}){}$\1\5
${}\\{path\_p}\K\\{path\_q};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\\{path\_p})\K\\{mp\_endpoint};{}$\6
\&{if} ${}(\\{mp\_right\_type}(\\{path\_p})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_right\_type}(\\{path\_p})\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\\{path\_p}\MG\\{right\_curl});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_right\_type}(\\{path\_q})\K\\{mp\_endpoint};{}$\6
\&{if} ${}(\\{mp\_left\_type}(\\{path\_q})\E\\{mp\_open}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\\{path\_q})\K\\{mp\_curl};{}$\6
${}\\{set\_number\_to\_unity}(\\{path\_q}\MG\\{left\_curl});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_next\_knot}(\\{path\_q})\K\\{path\_p};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_make\_choices}(\\{mp},\39\\{path\_p});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\\{set\_cur\_exp\_knot}(\\{path\_p});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\|y);\6
\&{return} \T{1};\6
\4${}\}{}$\2\par
\fi

\M{949}A pair of numeric values is changed into a knot node for a one-point
path
when \MP\ discovers that the pair is part of a path.

\Y\B\&{static} \&{mp\_knot} \\{mp\_pair\_to\_knot}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ convert a pair to a knot with two endpoints }\1\6
\&{mp\_knot} \|q;\C{ the new node }\7
${}\|q\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_left\_type}(\|q)\K\\{mp\_endpoint};{}$\6
${}\\{mp\_right\_type}(\|q)\K\\{mp\_endpoint};{}$\6
${}\\{mp\_originator}(\|q)\K\\{mp\_metapost\_user};{}$\6
${}\\{mp\_next\_knot}(\|q)\K\|q;{}$\6
\\{mp\_known\_pair}(\\{mp});\6
${}\\{number\_clone}(\|q\MG\\{x\_coord},\39\\{mp}\MG\\{cur\_x});{}$\6
${}\\{number\_clone}(\|q\MG\\{y\_coord},\39\\{mp}\MG\\{cur\_y});{}$\6
\&{return} \|q;\6
\4${}\}{}$\2\par
\fi

\M{950}The \PB{\\{known\_pair}} subroutine sets \PB{\\{cur\_x}} and \PB{\\{cur%
\_y}} to the components
of the current expression, assuming that the current expression is a
pair of known numerics. Unknown components are zeroed, and the
current expression is flushed.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_known\_pair}(\&{MP} \\{mp});\par
\fi

\M{951}\B\&{void} \\{mp\_known\_pair}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{mp\_node} \|p;\C{ the pair node }\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ need\ x\ and\ y\ numb}\)\.{ers\
for\ this\ part\ of}\)\.{\ the\ path."},\39\.{"The\ value\ I\ found\ (}\)\.{see%
\ above)\ was\ no\ go}\)\.{od;"},\39\.{"so\ I'll\ try\ to\ keep}\)\.{\ going\
by\ using\ zero}\)\.{\ instead."},\39\.{"(Chapter\ 27\ of\ The\ }\)%
\.{METAFONTbook\ explain}\)\.{s\ that"},\39\.{"you\ might\ want\ to\ t}\)\.{ype%
\ `I\ ??"}\.{"?'\ now.)"},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ coordinat}\)\.{es\ have\ been\
replace}\)\.{d\ by\ (0,0)"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_x});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_y});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,)){}$;\C{ Make sure that both \PB{%
\|x} and \PB{\|y} parts of \PB{\|p} are known;        copy them into \PB{\\{cur%
\_x}} and \PB{\\{cur\_y}} }\6
\&{if} ${}(\\{mp\_type}(\\{x\_part}(\|p))\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_x},\39\\{value\_number}(\\{x\_part}(%
\|p)));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ need\ a\ `known'\ x\ }\)\.{value%
\ for\ this\ part\ }\)\.{of\ the\ path."},\39\.{"The\ value\ I\ found\ (}\)%
\.{see\ above)\ was\ no\ go}\)\.{od;"},\39\.{"so\ I'll\ try\ to\ keep}\)\.{\
going\ by\ using\ zero}\)\.{\ instead."},\39\.{"(Chapter\ 27\ of\ The\ }\)%
\.{METAFONTbook\ explain}\)\.{s\ that"},\39\.{"you\ might\ want\ to\ t}\)\.{ype%
\ `I\ ??"}\.{"?'\ now.)"},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\\{x\_part}(\|p));{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ x\ coordin}\)\.{ate\ has\ been\
replace}\)\.{d\ by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{x\_part}(\|p));{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_x});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\\{y\_part}(\|p))\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_y},\39\\{value\_number}(\\{y\_part}(%
\|p)));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ need\ a\ `known'\ y\ }\)\.{value%
\ for\ this\ part\ }\)\.{of\ the\ path."},\39\.{"The\ value\ I\ found\ (}\)%
\.{see\ above)\ was\ no\ go}\)\.{od;"},\39\.{"so\ I'll\ try\ to\ keep}\)\.{\
going\ by\ using\ zero}\)\.{\ instead."},\39\.{"(Chapter\ 27\ of\ The\ }\)%
\.{METAFONTbook\ explain}\)\.{s\ that"},\39\.{"you\ might\ want\ to\ t}\)\.{ype%
\ `I\ ??"}\.{"?'\ now.)"},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\\{y\_part}(\|p));{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ y\ coordin}\)\.{ate\ has\ been\
replace}\)\.{d\ by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{y\_part}(\|p));{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{cur\_y});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{952}The \PB{\\{scan\_direction}} subroutine looks at the directional
information
that is enclosed in braces, and also scans ahead to the following character.
A type code is returned, either \PB{\\{open}} (if the direction was $(0,0)$),
or \PB{\\{curl}} (if the direction was a curl of known value \PB{\\{cur%
\_exp}}), or
\PB{\\{given}} (if the direction is given by the \PB{\\{angle}} value that now
appears in \PB{\\{cur\_exp}}).

There's nothing difficult about this subroutine, but the program is rather
lengthy because a variety of potential errors need to be nipped in the bud.

\Y\B\&{static} \&{quarterword} \\{mp\_scan\_direction}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|t;\C{ the type of information found }\7
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_curl\_command}){}$\5
${}\{{}$\C{ Scan a curl specification }\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known})\V(\\{number%
\_negative}(\\{cur\_exp\_value\_number}(\,)))){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ curl\ must\ be\ a\ kn}\)\.{own,\
nonnegative\ num}\)\.{ber."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_unity}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ curl\ has\ b}\)\.{een\ replaced\
by\ 1"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_curl};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Scan a given direction }\1\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}>\\{mp\_pair\_type}){}$\5
${}\{{}$\C{ Get given directions separated by commas }\1\6
\&{mp\_number} \\{xx};\7
\\{new\_number}(\\{xx});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ need\ a\ `known'\ x\ }\)\.{value%
\ for\ this\ part\ }\)\.{of\ the\ path."},\39\.{"The\ value\ I\ found\ (}\)%
\.{see\ above)\ was\ no\ go}\)\.{od;"},\39\.{"so\ I'll\ try\ to\ keep}\)\.{\
going\ by\ using\ zero}\)\.{\ instead."},\39\.{"(Chapter\ 27\ of\ The\ }\)%
\.{METAFONTbook\ explain}\)\.{s\ that"},\39\.{"you\ might\ want\ to\ t}\)\.{ype%
\ `I\ ??"}\.{"?'\ now.)"},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ x\ coordin}\)\.{ate\ has\ been\
replace}\)\.{d\ by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{xx},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ got\ the\ x\ coor}\)\.{dinate%
\ of\ a\ path\ dir}\)\.{ection;"},\39\.{"will\ look\ for\ the\ y}\)\.{\
coordinate\ next."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `,'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ need\ a\ `known'\ y\ }\)\.{value%
\ for\ this\ part\ }\)\.{of\ the\ path."},\39\.{"The\ value\ I\ found\ (}\)%
\.{see\ above)\ was\ no\ go}\)\.{od;"},\39\.{"so\ I'll\ try\ to\ keep}\)\.{\
going\ by\ using\ zero}\)\.{\ instead."},\39\.{"(Chapter\ 27\ of\ The\ }\)%
\.{METAFONTbook\ explain}\)\.{s\ that"},\39\.{"you\ might\ want\ to\ t}\)\.{ype%
\ `I\ ??"}\.{"?'\ now.)"},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ y\ coordin}\)\.{ate\ has\ been\
replace}\)\.{d\ by\ 0"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_y},\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{cur\_x},\39\\{xx});{}$\6
\\{free\_number}(\\{xx});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_known\_pair}(\\{mp});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_zero}(\\{mp}\MG\\{cur\_x})\W\\{number\_zero}(\\{mp}\MG%
\\{cur\_y})){}$\1\5
${}\|t\K\\{mp\_open};{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{narg};\7
\\{new\_angle}(\\{narg});\6
${}\\{n\_arg}(\\{narg},\39\\{mp}\MG\\{cur\_x},\39\\{mp}\MG\\{cur\_y});{}$\6
${}\|t\K\\{mp\_given};{}$\6
\\{set\_cur\_exp\_value\_number}(\\{narg});\6
\\{free\_number}(\\{narg});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_right\_brace}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ scanned\ a\ dire}\)\.{ction\
spec\ for\ part\ }\)\.{of\ a\ path,"},\39\.{"so\ a\ right\ brace\ sh}\)\.{ould\
have\ come\ next.}\)\.{"},\39\.{"I\ shall\ pretend\ tha}\)\.{t\ one\ was\
there."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `\}'\ has\ bee}\)\.{n\
inserted"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{return} (\&{quarterword}) \|t;\6
\4${}\}{}$\2\par
\fi

\M{953}Finally, we sometimes need to scan an expression whose value is
supposed to be either \PB{\\{true\_code}} or \PB{\\{false\_code}}.

\Y\B\4\D$\\{mp\_get\_boolean}(\\{mp})$ \5
\&{do} \6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_boolean\_type}){}$\5
${}\{{}$\1\6
\\{do\_boolean\_error}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\4\X931:Declare the basic parsing subroutines\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{do\_boolean\_error}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ expression\ show}\)\.{n\ above%
\ should\ have\ }\)\.{had\ a\ definite"},\39\.{"true-or-false\ value}\)\.{.\
I'm\ changing\ it\ to}\)\.{\ `false'."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Undefined\ condition}\)\.{\ will\ be\
treated\ as\ }\)\.{`false'"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4${}\}{}$\2\par
\fi

\M{954}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{do\_boolean\_error}(\&{MP} \\{mp});\par
\fi

\N{1}{955}Doing the operations.
The purpose of parsing is primarily to permit people to avoid piles of
parentheses. But the real work is done after the structure of an expression
has been recognized; that's when new expressions are generated. We
turn now to the guts of \MP, which handles individual operators that
have come through the parsing mechanism.

We'll start with the easy ones that take no operands, then work our way
up to operators with one and ultimately two arguments. In other words,
we will write the three procedures \PB{\\{do\_nullary}}, \PB{\\{do\_unary}},
and \PB{\\{do\_binary}}
that are invoked periodically by the expression scanners.

First let's make sure that all of the primitive operators are in the
hash table. Although \PB{\\{scan\_primary}} and its relatives made use of the
\\{cmd} code for these operators, the \\{do} routines base everything
on the \\{mod} code. For example, \PB{\\{do\_binary}} doesn't care whether the
operation it performs is a \PB{\\{primary\_binary}} or \PB{\\{secondary%
\_binary}}, etc.

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"true"},\39\\{mp\_nullary},\39\\{mp\_true%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"false"},\39\\{mp\_nullary},\39\\{mp\_false%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"nullpicture"},\39\\{mp\_nullary},\39\\{mp%
\_null\_picture\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"nullpen"},\39\\{mp\_nullary},\39\\{mp\_null%
\_pen\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"readstring"},\39\\{mp\_nullary},\39\\{mp%
\_read\_string\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"pencircle"},\39\\{mp\_nullary},\39\\{mp\_pen%
\_circle});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"normaldeviate"},\39\\{mp\_nullary},\39\\{mp%
\_normal\_deviate});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"readfrom"},\39\\{mp\_unary},\39\\{mp\_read%
\_from\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"closefrom"},\39\\{mp\_unary},\39\\{mp\_close%
\_from\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"odd"},\39\\{mp\_unary},\39\\{mp\_odd%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"known"},\39\\{mp\_unary},\39\\{mp\_known%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"unknown"},\39\\{mp\_unary},\39\\{mp\_unknown%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"not"},\39\\{mp\_unary},\39\\{mp\_not%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"decimal"},\39\\{mp\_unary},\39\\{mp%
\_decimal});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"reverse"},\39\\{mp\_unary},\39\\{mp%
\_reverse});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"makepath"},\39\\{mp\_unary},\39\\{mp\_make%
\_path\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"makepen"},\39\\{mp\_unary},\39\\{mp\_make%
\_pen\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"oct"},\39\\{mp\_unary},\39\\{mp\_oct%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"hex"},\39\\{mp\_unary},\39\\{mp\_hex%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"ASCII"},\39\\{mp\_unary},\39\\{mp\_ASCII%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"char"},\39\\{mp\_unary},\39\\{mp\_char%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"length"},\39\\{mp\_unary},\39\\{mp\_length%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"turningnumber"},\39\\{mp\_unary},\39\\{mp%
\_turning\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"xpart"},\39\\{mp\_unary},\39\\{mp\_x%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"ypart"},\39\\{mp\_unary},\39\\{mp\_y%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"xxpart"},\39\\{mp\_unary},\39\\{mp\_xx%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"xypart"},\39\\{mp\_unary},\39\\{mp\_xy%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"yxpart"},\39\\{mp\_unary},\39\\{mp\_yx%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"yypart"},\39\\{mp\_unary},\39\\{mp\_yy%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"redpart"},\39\\{mp\_unary},\39\\{mp\_red%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"greenpart"},\39\\{mp\_unary},\39\\{mp\_green%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"bluepart"},\39\\{mp\_unary},\39\\{mp\_blue%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"cyanpart"},\39\\{mp\_unary},\39\\{mp\_cyan%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"magentapart"},\39\\{mp\_unary},\39\\{mp%
\_magenta\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"yellowpart"},\39\\{mp\_unary},\39\\{mp%
\_yellow\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"blackpart"},\39\\{mp\_unary},\39\\{mp\_black%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"greypart"},\39\\{mp\_unary},\39\\{mp\_grey%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"colormodel"},\39\\{mp\_unary},\39\\{mp%
\_color\_model\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontpart"},\39\\{mp\_unary},\39\\{mp\_font%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"textpart"},\39\\{mp\_unary},\39\\{mp\_text%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"prescriptpart"},\39\\{mp\_unary},\39\\{mp%
\_prescript\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"postscriptpart"},\39\\{mp\_unary},\39\\{mp%
\_postscript\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"pathpart"},\39\\{mp\_unary},\39\\{mp\_path%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"penpart"},\39\\{mp\_unary},\39\\{mp\_pen%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"dashpart"},\39\\{mp\_unary},\39\\{mp\_dash%
\_part});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"sqrt"},\39\\{mp\_unary},\39\\{mp\_sqrt%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"mexp"},\39\\{mp\_unary},\39\\{mp\_m\_exp%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"mlog"},\39\\{mp\_unary},\39\\{mp\_m\_log%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"sind"},\39\\{mp\_unary},\39\\{mp\_sin\_d%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"cosd"},\39\\{mp\_unary},\39\\{mp\_cos\_d%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"floor"},\39\\{mp\_unary},\39\\{mp\_floor%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"uniformdeviate"},\39\\{mp\_unary},\39\\{mp%
\_uniform\_deviate});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"charexists"},\39\\{mp\_unary},\39\\{mp\_char%
\_exists\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontsize"},\39\\{mp\_unary},\39\\{mp\_font%
\_size});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"llcorner"},\39\\{mp\_unary},\39\\{mp\_ll%
\_corner\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"lrcorner"},\39\\{mp\_unary},\39\\{mp\_lr%
\_corner\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"ulcorner"},\39\\{mp\_unary},\39\\{mp\_ul%
\_corner\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"urcorner"},\39\\{mp\_unary},\39\\{mp\_ur%
\_corner\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"arclength"},\39\\{mp\_unary},\39\\{mp\_arc%
\_length});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"angle"},\39\\{mp\_unary},\39\\{mp\_angle%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"cycle"},\39\\{mp\_cycle},\39\\{mp\_cycle%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"stroked"},\39\\{mp\_unary},\39\\{mp\_stroked%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"filled"},\39\\{mp\_unary},\39\\{mp\_filled%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"textual"},\39\\{mp\_unary},\39\\{mp\_textual%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"clipped"},\39\\{mp\_unary},\39\\{mp\_clipped%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"bounded"},\39\\{mp\_unary},\39\\{mp\_bounded%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"+"},\39\\{mp\_plus\_or\_minus},\39\\{mp%
\_plus});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"-"},\39\\{mp\_plus\_or\_minus},\39\\{mp%
\_minus});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"*"},\39\\{mp\_secondary\_binary},\39\\{mp%
\_times});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"/"},\39\\{mp\_slash},\39\\{mp\_over});{}$\6
${}\\{mp}\MG\\{frozen\_slash}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"/"},\39%
\\{mp\_slash},\39\\{mp\_over});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"++"},\39\\{mp\_tertiary\_binary},\39\\{mp%
\_pythag\_add});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"+-+"},\39\\{mp\_tertiary\_binary},\39\\{mp%
\_pythag\_sub});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"or"},\39\\{mp\_tertiary\_binary},\39\\{mp%
\_or\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"and"},\39\\{mp\_and\_command},\39\\{mp\_and%
\_op});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"<"},\39\\{mp\_expression\_binary},\39\\{mp%
\_less\_than});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"<="},\39\\{mp\_expression\_binary},\39\\{mp%
\_less\_or\_equal});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{">"},\39\\{mp\_expression\_binary},\39\\{mp%
\_greater\_than});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{">="},\39\\{mp\_expression\_binary},\39\\{mp%
\_greater\_or\_equal});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"="},\39\\{mp\_equals},\39\\{mp\_equal%
\_to});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"<>"},\39\\{mp\_expression\_binary},\39\\{mp%
\_unequal\_to});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"substring"},\39\\{mp\_primary\_binary},\39%
\\{mp\_substring\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"subpath"},\39\\{mp\_primary\_binary},\39%
\\{mp\_subpath\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"directiontime"},\39\\{mp\_primary\_binary},%
\39\\{mp\_direction\_time\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"point"},\39\\{mp\_primary\_binary},\39\\{mp%
\_point\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"precontrol"},\39\\{mp\_primary\_binary},\39%
\\{mp\_precontrol\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"postcontrol"},\39\\{mp\_primary\_binary},\39%
\\{mp\_postcontrol\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"penoffset"},\39\\{mp\_primary\_binary},\39%
\\{mp\_pen\_offset\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"arctime"},\39\\{mp\_primary\_binary},\39%
\\{mp\_arc\_time\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"mpversion"},\39\\{mp\_nullary},\39\\{mp%
\_version});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"\&"},\39\\{mp\_ampersand},\39\\{mp%
\_concatenate});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"rotated"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_rotated\_by});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"slanted"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_slanted\_by});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"scaled"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_scaled\_by});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"shifted"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_shifted\_by});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"transformed"},\39\\{mp\_secondary\_binary},%
\39\\{mp\_transformed\_by});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"xscaled"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_x\_scaled});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"yscaled"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_y\_scaled});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"zscaled"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_z\_scaled});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"infont"},\39\\{mp\_secondary\_binary},\39%
\\{mp\_in\_font});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"intersectiontimes"},\39\\{mp\_tertiary%
\_binary},\39\\{mp\_intersect});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"envelope"},\39\\{mp\_primary\_binary},\39%
\\{mp\_envelope\_of});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"glyph"},\39\\{mp\_primary\_binary},\39\\{mp%
\_glyph\_infont}){}$;\par
\fi

\M{956}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_nullary}:\5
\&{case} \\{mp\_unary}:\5
\&{case} \\{mp\_primary\_binary}:\5
\&{case} \\{mp\_secondary\_binary}:\5
\&{case} \\{mp\_tertiary\_binary}:\5
\&{case} \\{mp\_expression\_binary}:\5
\&{case} \\{mp\_cycle}:\5
\&{case} \\{mp\_plus\_or\_minus}:\5
\&{case} \\{mp\_slash}:\5
\&{case} \\{mp\_ampersand}:\5
\&{case} \\{mp\_equals}:\5
\&{case} \\{mp\_and\_command}:\5
${}\\{mp\_print\_op}(\\{mp},\39{}$(\&{quarterword}) \|m);\6
\&{break};\par
\fi

\M{957}OK, let's look at the simplest \\{do} procedure first.

\Y\B\X958:Declare nullary action procedure\X;\7
\&{static} \&{void} \\{mp\_do\_nullary}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|c)\1\1\2\2\6
${}\{{}$\1\6
\\{check\_arith}(\,);\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\1\5
${}\\{mp\_show\_cmd\_mod}(\\{mp},\39\\{mp\_nullary},\39\|c);{}$\2\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_true\_code}:\5
\&{case} \\{mp\_false\_code}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\\{set\_cur\_exp\_value\_boolean}(\|c);\6
\&{break};\6
\4\&{case} \\{mp\_null\_picture\_code}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\\{set\_cur\_exp\_node}((\&{mp\_node}) \\{mp\_get\_edge\_header\_node}(%
\\{mp}));\6
${}\\{mp\_init\_edges}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{cur\_exp%
\_node}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_null\_pen\_code}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_get\_pen\_circle}(\\{mp},\39\\{zero\_t}));{}$%
\6
\&{break};\6
\4\&{case} \\{mp\_normal\_deviate}:\6
${}\{{}$\1\6
\&{mp\_number} \|r;\7
\\{new\_number}(\|r);\6
${}\\{mp\_norm\_rand}(\\{mp},\39{\AND}\|r);{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
\\{set\_cur\_exp\_value\_number}(\|r);\6
\\{free\_number}(\|r);\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_pen\_circle}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_get\_pen\_circle}(\\{mp},\39\\{unity%
\_t}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_version}:\5
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
${}\\{set\_cur\_exp\_str}(\\{mp\_intern}(\\{mp},\39\\{metapost\_version}));{}$\6
\&{break};\6
\4\&{case} \\{mp\_read\_string\_op}:\C{ Read a string from the terminal }\6
\&{if} ${}(\\{mp}\MG\\{noninteractive}\V\\{mp}\MG\\{interaction}\Z\\{mp%
\_nonstop\_mode}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"***\ (cannot\ readstr}\)\.{ing\ in\
nonstop\ modes}\)\.{)"});{}$\2\6
\\{mp\_begin\_file\_reading}(\\{mp});\6
${}\\{name}\K\\{is\_read};{}$\6
${}\\{limit}\K\\{start};{}$\6
\\{prompt\_input}(\.{""});\6
\\{mp\_finish\_read}(\\{mp});\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\\{check\_arith}(\,);\6
\4${}\}{}$\2\par
\fi

\M{958}\B\X958:Declare nullary action procedure\X${}\E{}$\6
\&{static} \&{void} \\{mp\_finish\_read}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ copy \PB{\\{buffer}} line to \PB{\\{cur\_exp}} }\1\6
\&{size\_t} \|k;\7
\\{str\_room}(((\&{int}) \\{mp}${}\MG\\{last}-{}$(\&{int}) \\{start}));\6
\&{for} ${}(\|k\K{}$(\&{size\_t}) \\{start}; ${}\|k<\\{mp}\MG\\{last};{}$ ${}%
\|k\PP){}$\5
${}\{{}$\1\6
${}\\{append\_char}(\\{mp}\MG\\{buffer}[\|k]);{}$\6
\4${}\}{}$\2\6
\\{mp\_end\_file\_reading}(\\{mp});\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\\{set\_cur\_exp\_str}(\\{mp\_make\_string}(\\{mp}));\6
\4${}\}{}$\2\par
\U957.\fi

\M{959}Things get a bit more interesting when there's an operand. The
operand to \PB{\\{do\_unary}} appears in \PB{\\{cur\_type}} and \PB{\\{cur%
\_exp}}.

This complicated if test makes sure that any \PB{\\{bounds}} or \PB{\\{clip}}
picture objects that get passed into \&{within} do not raise an
error when queried using the color part primitives (this is needed
for backward compatibility) .

\Y\B\4\D$\\{cur\_pic\_item}$ \5
\\{mp\_link}(\\{edge\_list}(\\{cur\_exp\_node}(\,)))\par
\B\4\D$\\{pict\_color\_type}(\|A)$ \5
$((\\{cur\_pic\_item}\I\NULL)\W((\R\\{has\_color}(\\{cur\_pic\_item}))\V(((%
\&{mp\_color\_model}(\\{cur\_pic\_item})\E\|A)\V((\&{mp\_color\_model}(\\{cur%
\_pic\_item})\E\\{mp\_uninitialized\_model})\W(\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_default\_color\_model}))/\\{number\_to\_scaled}(%
\\{unity\_t}))\E(\|A))))){}$)\par
\B\4\D$\\{boolean\_reset}(\|A)$ \6
\&{if} ((\|A))\1\5
\\{set\_cur\_exp\_value\_boolean}(\\{mp\_true\_code});\2\6
\&{else} \\{set\_cur\_exp\_value\_boolean}(\\{mp\_false\_code})\par
\B\4\D$\\{type\_range}(\|A,\|B)$ \6
${}\{{}$\1\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\G(\|A))\W(\\{mp}\MG\\{cur\_exp}.%
\\{type}\Z(\|B))){}$\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_true%
\_code});{}$\2\6
\&{else}\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4${}\}{}$\2\par
\B\4\D$\\{type\_test}(\|A)$ \6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E(\\{mp\_variable\_type})(\|A)){}$\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_true%
\_code});{}$\2\6
\&{else}\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4${}\}{}$\2\par
\Y\B\X960:Declare unary action procedures\X;\7
\&{static} \&{void} \\{mp\_do\_unary}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{mp\_value} \\{new\_expr};\7
\\{check\_arith}(\,);\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\5
${}\{{}$\C{ Trace the current unary operation }\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{"});{}$\6
${}\\{mp\_print\_op}(\\{mp},\39\|c);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{0}){}$;\C{ show the operand, but
not verbosely }\6
${}\\{mp\_print}(\\{mp},\39\.{")\}"});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_plus}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_color\_type}){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_plus});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_minus}:\5
\\{negate\_cur\_expr}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_not\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_boolean\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_not\_op});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{halfword} \\{bb};\7
\&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_true\_code}){}$\1\5
${}\\{bb}\K\\{mp\_false\_code};{}$\2\6
\&{else}\1\5
${}\\{bb}\K\\{mp\_true\_code};{}$\2\6
\\{set\_cur\_exp\_value\_boolean}(\\{bb});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_sqrt\_op}:\5
\&{case} \\{mp\_m\_exp\_op}:\5
\&{case} \\{mp\_m\_log\_op}:\5
\&{case} \\{mp\_sin\_d\_op}:\5
\&{case} \\{mp\_cos\_d\_op}:\5
\&{case} \\{mp\_floor\_op}:\5
\&{case} \\{mp\_uniform\_deviate}:\5
\&{case} \\{mp\_odd\_op}:\5
\&{case} \\{mp\_char\_exists\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_sqrt\_op}:\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{square\_rt}(\\{r1},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{set\_cur\_exp\_value\_number}(\\{r1});\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_m\_exp\_op}:\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{m\_exp}(\\{r1},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{set\_cur\_exp\_value\_number}(\\{r1});\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_m\_log\_op}:\6
${}\{{}$\1\6
\&{mp\_number} \\{r1};\7
\\{new\_number}(\\{r1});\6
${}\\{m\_log}(\\{r1},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{set\_cur\_exp\_value\_number}(\\{r1});\6
\\{free\_number}(\\{r1});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_sin\_d\_op}:\5
\&{case} \\{mp\_cos\_d\_op}:\6
${}\{{}$\1\6
\&{mp\_number} \\{n\_sin}${},{}$ \\{n\_cos}${},{}$ \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_fraction}(\\{n\_sin});\6
\\{new\_fraction}(\\{n\_cos});\C{ results computed by \PB{\\{n\_sin\_cos}} }\6
${}\\{number\_clone}(\\{arg1},\39\\{cur\_exp\_value\_number}(\,));{}$\6
${}\\{number\_clone}(\\{arg2},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{360});{}$\6
${}\\{number\_modulo}(\\{arg1},\39\\{arg2});{}$\6
\\{convert\_scaled\_to\_angle}(\\{arg1});\6
${}\\{n\_sin\_cos}(\\{arg1},\39\\{n\_cos},\39\\{n\_sin});{}$\6
\&{if} ${}(\|c\E\\{mp\_sin\_d\_op}){}$\5
${}\{{}$\1\6
\\{fraction\_to\_round\_scaled}(\\{n\_sin});\6
\\{set\_cur\_exp\_value\_number}(\\{n\_sin});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{fraction\_to\_round\_scaled}(\\{n\_cos});\6
\\{set\_cur\_exp\_value\_number}(\\{n\_cos});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{n\_sin});\6
\\{free\_number}(\\{n\_cos});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_floor\_op}:\6
${}\{{}$\1\6
\&{mp\_number} \\{vvx};\7
\\{new\_number}(\\{vvx});\6
${}\\{number\_clone}(\\{vvx},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{floor\_scaled}(\\{vvx});\6
\\{set\_cur\_exp\_value\_number}(\\{vvx});\6
\\{free\_number}(\\{vvx});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_uniform\_deviate}:\6
${}\{{}$\1\6
\&{mp\_number} \\{vvx};\7
\\{new\_number}(\\{vvx});\6
${}\\{mp\_unif\_rand}(\\{mp},\39{\AND}\\{vvx},\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\\{set\_cur\_exp\_value\_number}(\\{vvx});\6
\\{free\_number}(\\{vvx});\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_odd\_op}:\6
${}\{{}$\1\6
\&{integer} \\{vvx}${}\K\\{odd}(\\{round\_unscaled}(\\{cur\_exp\_value%
\_number}(\,)));{}$\7
\\{boolean\_reset}(\\{vvx});\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_char\_exists\_op}:\C{ Determine if a character has been
shipped out }\6
${}\\{set\_cur\_exp\_value\_scaled}(\\{round\_unscaled}(\\{cur\_exp\_value%
\_number}(\,))\MOD\T{256});{}$\6
\&{if} (\\{number\_negative}(\\{cur\_exp\_value\_number}(\,)))\5
${}\{{}$\1\6
\&{halfword} \\{vv}${}\K\\{number\_to\_scaled}(\\{cur\_exp\_value\_number}(%
\,));{}$\7
${}\\{set\_cur\_exp\_value\_scaled}(\\{vv}+\T{256});{}$\6
\4${}\}{}$\2\6
${}\\{boolean\_reset}(\\{mp}\MG\\{char\_exists}[\\{number\_to\_scaled}(\\{cur%
\_exp\_value\_number}(\,))]);{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_angle\_op}:\6
\&{if} ${}(\\{mp\_nice\_pair}(\\{mp},\39\\{cur\_exp\_node}(\,),\39\\{mp}\MG%
\\{cur\_exp}.\\{type})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{narg};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{new\_angle}(\\{narg});\6
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
${}\\{n\_arg}(\\{narg},\39\\{value\_number}(\\{x\_part}(\|p)),\39\\{value%
\_number}(\\{y\_part}(\|p)));{}$\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{narg});{}$\6
${}\\{convert\_angle\_to\_scaled}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{free\_number}(\\{narg});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_angle\_op});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_x\_part}:\5
\&{case} \\{mp\_y\_part}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type})\V(\\{mp}\MG%
\\{cur\_exp}.\\{type}\E\\{mp\_transform\_type})){}$\1\5
${}\\{mp\_take\_part}(\\{mp},\39\|c);{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\1%
\5
${}\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part}:\5
\&{case} \\{mp\_xy\_part}:\5
\&{case} \\{mp\_yx\_part}:\5
\&{case} \\{mp\_yy\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_transform\_type}){}$\1\5
${}\\{mp\_take\_part}(\\{mp},\39\|c);{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\1%
\5
${}\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_red\_part}:\5
\&{case} \\{mp\_green\_part}:\5
\&{case} \\{mp\_blue\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\1\5
${}\\{mp\_take\_part}(\\{mp},\39\|c);{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{if} \\{pict\_color\_type}\1\5
${}(\\{mp\_rgb\_model})\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_color\_part}(\\{mp},\39\|c);{}$\2\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part}:\5
\&{case} \\{mp\_magenta\_part}:\5
\&{case} \\{mp\_yellow\_part}:\5
\&{case} \\{mp\_black\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$\1\5
${}\\{mp\_take\_part}(\\{mp},\39\|c);{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{if} \\{pict\_color\_type}\1\5
${}(\\{mp\_cmyk\_model})\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_color\_part}(\\{mp},\39\|c);{}$\2\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_grey\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\1\5
;\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{if} \\{pict\_color\_type}\1\5
${}(\\{mp\_grey\_model})\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_color\_part}(\\{mp},\39\|c);{}$\2\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_model\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\1\5
${}\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_font\_part}:\5
\&{case} \\{mp\_text\_part}:\5
\&{case} \\{mp\_path\_part}:\5
\&{case} \\{mp\_pen\_part}:\5
\&{case} \\{mp\_dash\_part}:\5
\&{case} \\{mp\_prescript\_part}:\5
\&{case} \\{mp\_postscript\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_picture\_type}){}$\1\5
${}\\{mp\_take\_pict\_part}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_char\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_char\_op});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{int} \\{vv}${}\K\\{round\_unscaled}(\\{cur\_exp\_value\_number}(\,))\MOD%
\T{256};{}$\7
\\{set\_cur\_exp\_value\_scaled}(\\{vv});\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\&{if} (\\{number\_negative}(\\{cur\_exp\_value\_number}(\,)))\5
${}\{{}$\1\6
${}\\{vv}\K\\{number\_to\_scaled}(\\{cur\_exp\_value\_number}(\,))+\T{256};{}$\6
\\{set\_cur\_exp\_value\_scaled}(\\{vv});\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{unsigned} \&{char} \\{ss}[\T{2}];\7
${}\\{ss}[\T{0}]\K{}$(\&{unsigned} \&{char}) \\{number\_to\_scaled}(\\{cur\_exp%
\_value\_number}(\,));\6
${}\\{ss}[\T{1}]\K\.{'\\0'};{}$\6
${}\\{set\_cur\_exp\_str}(\\{mp\_rtsl}(\\{mp},\39{}$(\&{char} ${}{*}){}$ %
\\{ss}${},\39\T{1}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_decimal}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_decimal});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
\\{print\_number}(\\{cur\_exp\_value\_number}(\,));\6
\\{set\_cur\_exp\_str}(\\{mp\_make\_string}(\\{mp}));\6
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{old\_setting};{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_oct\_op}:\5
\&{case} \\{mp\_hex\_op}:\5
\&{case} \\{mp\_ASCII\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_str\_to\_num}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_font\_size}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_font\_size});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Find the design size of the font whose name is \PB{\\{cur\_exp}} }%
\C{ One simple application of \PB{\\{find\_font}} is the implementation of the %
\PB{\\{font\_size}}          operator that gets the design size for a given
font name. }\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_from\_scaled}(\\{new\_expr}.\\{data}.\|n,\39(\\{mp}\MG%
\\{font\_dsize}[\\{mp\_find\_font}(\\{mp},\39\\{mp\_str}(\\{mp},\39\\{cur\_exp%
\_str}(\,)))]+\T{8})/\T{16});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_length\_op}:\C{ The length operation is somewhat unusual in
that it applies to a variety        of different types of operands. }\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_string\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{new\_expr}.\\{data}.\|n,\39\\{cur\_exp\_str}(%
\,)\MG\\{len});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_path\_length}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\&{break};\6
\4\&{case} \\{mp\_known}:\5
\\{set\_cur\_exp\_value\_number}(\\{cur\_exp\_value\_number}(\,));\6
\\{number\_abs}(\\{cur\_exp\_value\_number}(\,));\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_pict\_length}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\&{break};\6
\4\&{default}:\6
\&{if} ${}(\\{mp\_nice\_pair}(\\{mp},\39\\{cur\_exp\_node}(\,),\39\\{mp}\MG%
\\{cur\_exp}.\\{type})){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{pyth\_add}(\\{new\_expr}.\\{data}.\|n,\39\\{value\_number}(\\{x\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))),\39\\{value\_number}(\\{y\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_turning\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_turning\_op});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\E\\{mp%
\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{new\_expr}.\\{data}.\|p\K\NULL;{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr}){}$;\C{ not a cyclic path }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_turn\_cycles\_wrapper}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n,\39%
\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_boolean\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_boolean\_type},\39\\{mp\_unknown\_boolean});{}$\6
\&{break};\6
\4\&{case} \\{mp\_string\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_string\_type},\39\\{mp\_unknown\_string});{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_pen\_type},\39\\{mp\_unknown\_pen});{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_path\_type},\39\\{mp\_unknown\_path});{}$\6
\&{break};\6
\4\&{case} \\{mp\_picture\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_picture\_type},\39\\{mp\_unknown\_picture});{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{type\_test}(\|c);\6
\&{break};\6
\4\&{case} \\{mp\_numeric\_type}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{type\_range}(\\{mp\_known},\39\\{mp\_independent});{}$\6
\&{break};\6
\4\&{case} \\{mp\_known\_op}:\5
\&{case} \\{mp\_unknown\_op}:\5
${}\\{mp\_test\_known}(\\{mp},\39\|c);{}$\6
\&{break};\6
\4\&{case} \\{mp\_cycle\_op}:\5
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\2\6
\&{else} \&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\I\\{mp%
\_endpoint}){}$\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_true%
\_code});{}$\2\6
\&{else}\1\5
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\&{break};\6
\4\&{case} \\{mp\_arc\_length}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_arc\_length});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_get\_arc\_length}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n,\39%
\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_filled\_op}:\5
\&{case} \\{mp\_stroked\_op}:\5
\&{case} \\{mp\_textual\_op}:\5
\&{case} \\{mp\_clipped\_op}:\5
\&{case} \\{mp\_bounded\_op}:\C{ Here we use the fact that \PB{$\|c-\\{filled%
\_op}+\\{fill\_code}$} is the desired graphical     object \PB{\\{type}}. }\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_link}(\\{edge\_list}(\\{cur\_exp\_node}(\,)))\E%
\NULL){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\\{mp\_link}(\\{edge\_list}(\\{cur\_exp%
\_node}(\,))))\E(\\{mp\_variable\_type})(\|c+\\{mp\_fill\_node\_type}-\\{mp%
\_filled\_op})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_true%
\_code});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\&{break};\6
\4\&{case} \\{mp\_make\_pen\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_make\_pen\_op});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_make\_pen}(\\{mp},\39\\{cur\_exp\_knot}(\,),%
\39\\{true}));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_make\_path\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_pen\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_make\_path\_op});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
${}\\{mp\_make\_path}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_reverse}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
\&{mp\_knot} \\{pk}${}\K\\{mp\_htap\_ypoc}(\\{mp},\39\\{cur\_exp\_knot}(%
\,));{}$\7
\&{if} ${}(\\{mp\_right\_type}(\\{pk})\E\\{mp\_endpoint}){}$\1\5
${}\\{pk}\K\\{mp\_next\_knot}(\\{pk});{}$\2\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\\{set\_cur\_exp\_knot}(\\{pk});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
\\{mp\_pair\_to\_path}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_reverse});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_ll\_corner\_op}:\6
\&{if} ${}(\R\\{mp\_get\_cur\_bbox}(\\{mp})){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_ll\_corner\_op});{}$\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\\{mp\_minx},\39\\{mp\_miny});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_lr\_corner\_op}:\6
\&{if} ${}(\R\\{mp\_get\_cur\_bbox}(\\{mp})){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_lr\_corner\_op});{}$\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\\{mp\_maxx},\39\\{mp\_miny});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_ul\_corner\_op}:\6
\&{if} ${}(\R\\{mp\_get\_cur\_bbox}(\\{mp})){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_ul\_corner\_op});{}$\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\\{mp\_minx},\39\\{mp\_maxy});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_ur\_corner\_op}:\6
\&{if} ${}(\R\\{mp\_get\_cur\_bbox}(\\{mp})){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_ur\_corner\_op});{}$\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\\{mp\_maxx},\39\\{mp\_maxy});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_read\_from\_op}:\5
\&{case} \\{mp\_close\_from\_op}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\1\5
${}\\{mp\_bad\_unary}(\\{mp},\39\|c);{}$\2\6
\&{else}\1\5
${}\\{mp\_do\_read\_or\_close}(\\{mp},\39\|c);{}$\2\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\\{check\_arith}(\,);\6
\4${}\}{}$\2\par
\fi

\M{960}The \PB{\\{nice\_pair}} function returns \PB{\\{true}} if both
components of a pair
are known.

\Y\B\4\X960:Declare unary action procedures\X${}\E{}$\6
\&{static} \&{boolean} \\{mp\_nice\_pair}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\|t\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\|p\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\\{x\_part}(\|p))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{y\_part}(\|p))\E\\{mp\_known}){}$\1\5
\&{return} \\{true};\2\2\6
\4${}\}{}$\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\As961, 962, 963, 964, 965, 966, 969, 973, 974, 975, 976, 977, 978, 980, 981,
982, 983, 984\ETs985.
\U959.\fi

\M{961}The \PB{\\{nice\_color\_or\_pair}} function is analogous except that it
also accepts
fully known colors.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{boolean} \\{mp\_nice\_color\_or\_pair}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p${},\39{}$\&{quarterword} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\7
(\&{void}) \\{mp};\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\\{x\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{y\_part}(\|q))\E\\{mp\_known}){}$\1\5
\&{return} \\{true};\2\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\\{red\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{green\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{blue\_part}(\|q))\E\\{mp\_known}){}$\1\5
\&{return} \\{true};\2\2\2\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\\{cyan\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{magenta\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{yellow\_part}(\|q))\E\\{mp\_known}){}$\1\6
\&{if} ${}(\\{mp\_type}(\\{black\_part}(\|q))\E\\{mp\_known}){}$\1\5
\&{return} \\{true};\2\2\2\2\6
\&{break};\6
\4${}\}{}$\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M{962}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_print\_known\_or\_unknown\_type}(\&{MP} \\{mp}${},%
\39{}$\&{quarterword} \|t${},\39{}$\&{mp\_node} \|v)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
\&{if} ${}(\|t>\\{mp\_known}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"unknown\ numeric"});{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}((\|t\E\\{mp\_pair\_type})\V(\|t\E\\{mp\_color\_type})\V(\|t\E\\{mp%
\_cmykcolor\_type})){}$\1\6
\&{if} ${}(\R\\{mp\_nice\_color\_or\_pair}(\\{mp},\39\|v,\39\|t)){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"unknown\ "});{}$\2\2\6
${}\\{mp\_print\_type}(\\{mp},\39\|t);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
\4${}\}{}$\2\par
\fi

\M{963}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_bad\_unary}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|c)\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ afraid\ I\ don't\ }\)\.{know\
how\ to\ apply\ th}\)\.{at\ operation\ to\ that}\)\.{"},\39\.{"particular\
type.\ Co}\)\.{ntinue,\ and\ I'll\ sim}\)\.{ply\ return\ the"},\39\.{"argument\
(shown\ abo}\)\.{ve)\ as\ the\ result\ of}\)\.{\ the\ operation."},\39\NULL%
\};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_op}(\\{mp},\39\|c);{}$\6
${}\\{mp\_print\_known\_or\_unknown\_type}(\\{mp},\39\\{mp}\MG\\{cur\_exp}.%
\\{type},\39\\{cur\_exp\_node}(\,));{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Not\ implemented:\ \%s}\)\.{"},%
\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{964}Negation is easy except when the current expression
is of type \PB{\\{independent}}, or when it is a pair with one or more
\PB{\\{independent}} components.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_negate\_dep\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_value\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{number\_negate}(\\{dep\_value}(\|p));\6
\&{if} ${}(\\{dep\_info}(\|p)\E\NULL){}$\1\5
\&{return};\2\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{965}It is tempting to argue that the negative of an independent variable
is an independent variable, hence we don't have to do anything when
negating it. The fallacy is that other dependent variables pointing
to the current expression must change the sign of their
coefficients if we make no change to the current expression.

Instead, we work around the problem by copying the current expression
and recycling it afterwards (cf.~the \PB{\\{stash\_in}} routine).

\Y\B\4\D$\\{negate\_value}(\|A)$ \6
\&{if} ${}(\\{mp\_type}(\|A)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|A,\39(\\{value\_number}(\|A))){}$;\C{ to clear the
rest }\6
\\{number\_negate}(\\{value\_number}(\|A));\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_negate\_dep\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}((%
\&{mp\_value\_node}) \|A));\6
\4${}\}{}$\2\par
\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{negate\_cur\_expr}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ for list manipulation }\7
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
\&{case} \\{mp\_independent}:\5
${}\|q\K\\{cur\_exp\_node}(\,);{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|q);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
${}\\{mp\_negate\_dep\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}((%
\&{mp\_value\_node}) \\{cur\_exp\_node}(\,)));\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\Z\\{mp\_pair\_type}){}$\5
${}\{{}$\C{ \PB{\\{mp\_color\_type}} \PB{\\{mp\_cmykcolor\_type}}, or \PB{\\{mp%
\_pair\_type}} }\1\6
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\|r\K\\{x\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{y\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\|r\K\\{red\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{green\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{blue\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|r\K\\{cyan\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{magenta\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{yellow\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
${}\|r\K\\{black\_part}(\|p);{}$\6
\\{negate\_value}(\|r);\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ if \PB{$\\{cur\_type}\K\\{mp\_known}$} then \PB{$\\{cur\_exp}\K%
\T{0}$} }\2\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|q);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|q);{}$\6
\&{break};\6
\4\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
${}\\{mp\_negate\_dep\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}((%
\&{mp\_value\_node}) \\{cur\_exp\_node}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_known}:\6
\&{if} (\\{is\_number}(\\{cur\_exp\_value\_number}(\,)))\1\5
\\{number\_negate}(\\{cur\_exp\_value\_number}(\,));\2\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_bad\_unary}(\\{mp},\39\\{mp\_minus});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{966}If the current expression is a pair, but the context wants it to
be a path, we call \PB{\\{pair\_to\_path}}.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_pair\_to\_path}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{set\_cur\_exp\_knot}(\\{mp\_pair\_to\_knot}(\\{mp}));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\4${}\}{}$\2\par
\fi

\M{967}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_bad\_color\_part}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c);\par
\fi

\M{968}\B\&{static} \&{void} \\{mp\_bad\_color\_part}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ the big node }\6
\&{mp\_value} \\{new\_expr};\6
\&{char} \\{msg}[\T{256}];\6
\&{int} \\{old\_setting};\6
\&{mp\_string} \\{sname};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You\ can\ only\ ask\ fo}\)\.{r\ the%
\ redpart,\ green}\)\.{part,\ bluepart\ of\ a\ }\)\.{rgb\ object,"},\39\.{"the\
cyanpart,\ magen}\)\.{tapart,\ yellowpart\ o}\)\.{r\ blackpart\ of\ a\ cmy}\)%
\.{k\ object,\ "},\39\.{"or\ the\ greypart\ of\ }\)\.{a\ grey\ object.\ No\ mi}%
\)\.{xing\ and\ matching,\ p}\)\.{lease."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_op}(\\{mp},\39\|c);{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
;\6
\&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_grey\_model}){}$\1\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Wrong\ picture\ color}\)\.{\
model:\ \%s\ of\ grey\ o}\)\.{bject"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$%
\2\6
\&{else} \&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_cmyk\_model}){}$\1\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Wrong\ picture\ color}\)\.{\
model:\ \%s\ of\ cmyk\ o}\)\.{bject"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$%
\2\6
\&{else} \&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_rgb\_model}){}$\1\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Wrong\ picture\ color}\)\.{\
model:\ \%s\ of\ rgb\ ob}\)\.{ject"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\2%
\6
\&{else} \&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_no\_model}){}$\1\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Wrong\ picture\ color}\)\.{\
model:\ \%s\ of\ markin}\)\.{g\ object"},\39\\{mp\_str}(\\{mp},\39%
\\{sname}));{}$\2\6
\&{else}\1\5
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Wrong\ picture\ color}\)\.{\
model:\ \%s\ of\ defaul}\)\.{ted\ object"},\39\\{mp\_str}(\\{mp},\39%
\\{sname}));{}$\2\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\&{if} ${}(\|c\E\\{mp\_black\_part}){}$\1\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{unity\_t});{}$\2\6
\&{else}\1\5
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{969}In the following procedure, \PB{\\{cur\_exp}} points to a capsule, which
points to
a big node. We want to delete all but one part of the big node.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_take\_part}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ the big node }\7
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
${}\\{set\_value\_node}(\\{mp}\MG\\{temp\_val},\39\|p);{}$\6
${}\\{mp\_type}(\\{mp}\MG\\{temp\_val})\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
${}\\{mp\_link}(\|p)\K\\{mp}\MG\\{temp\_val};{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_x\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{x\_part}(\|p));{}$\2\6
\&{else}\1\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{tx\_part}(\|p));{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_y\_part}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{y\_part}(\|p));{}$\2\6
\&{else}\1\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{ty\_part}(\|p));{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{xx\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_xy\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{xy\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yx\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{yx\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yy\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{yy\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_red\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{red\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_green\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{green\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_blue\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{blue\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{cyan\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_magenta\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{magenta\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_yellow\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{yellow\_part}(\|p));{}$\6
\&{break};\6
\4\&{case} \\{mp\_black\_part}:\5
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{black\_part}(\|p));{}$\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{mp}\MG\\{temp\_val});{}$\6
\4${}\}{}$\2\par
\fi

\M{970}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{temp\_val}\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{mp\_name\_type}(\\{mp}\MG\\{temp\_val})\K\\{mp\_capsule}{}$;\par
\fi

\M{971}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{temp\_val}){}$;\par
\fi

\M{972}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_edge\_header\_node} \\{mp\_scale\_edges}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_number} \\{se\_sf}${},\39{}$\&{mp\_edge\_header\_node} \\{se%
\_pic});\par
\fi

\M{973}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_take\_pict\_part}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ first graphical object in \PB{\\{cur\_exp}} }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\\{cur\_exp\_node}(\,)));{}$\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_x\_part}:\5
\&{case} \\{mp\_y\_part}:\5
\&{case} \\{mp\_xx\_part}:\5
\&{case} \\{mp\_xy\_part}:\5
\&{case} \\{mp\_yx\_part}:\5
\&{case} \\{mp\_yy\_part}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_text\_node\_type}){}$\5
${}\{{}$\1\6
\&{mp\_text\_node} \\{p0}${}\K{}$(\&{mp\_text\_node}) \|p;\7
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_x\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{tx});{}$\6
\&{break};\6
\4\&{case} \\{mp\_y\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{ty});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xx\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{txx});{}$\6
\&{break};\6
\4\&{case} \\{mp\_xy\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{txy});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yx\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{tyx});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yy\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{p0}\MG\\{tyy});{}$\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{break};\6
\4\&{case} \\{mp\_red\_part}:\5
\&{case} \\{mp\_green\_part}:\5
\&{case} \\{mp\_blue\_part}:\6
\&{if} (\\{has\_color}(\|p))\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_red\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{red});{}$\6
\&{break};\6
\4\&{case} \\{mp\_green\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{green});{}$\6
\&{break};\6
\4\&{case} \\{mp\_blue\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{blue});{}$\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{break};\6
\4\&{case} \\{mp\_cyan\_part}:\5
\&{case} \\{mp\_magenta\_part}:\5
\&{case} \\{mp\_yellow\_part}:\5
\&{case} \\{mp\_black\_part}:\6
\&{if} (\\{has\_color}(\|p))\5
${}\{{}$\1\6
\&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_uninitialized\_model}\W\|c\E\\{mp%
\_black\_part}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_unity}(\\{new\_expr}.\\{data}.\|n);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_cyan\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{cyan});{}$\6
\&{break};\6
\4\&{case} \\{mp\_magenta\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{magenta});{}$\6
\&{break};\6
\4\&{case} \\{mp\_yellow\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{yellow});{}$\6
\&{break};\6
\4\&{case} \\{mp\_black\_part}:\5
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{black});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{break};\6
\4\&{case} \\{mp\_grey\_part}:\6
\&{if} (\\{has\_color}(\|p))\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39{}$((\&{mp\_stroked\_node}) %
\|p)${}\MG\\{grey});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_model\_part}:\6
\&{if} (\\{has\_color}(\|p))\5
${}\{{}$\1\6
\&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_uninitialized\_model}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{internal\_value}(\\{mp%
\_default\_color\_model}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{new\_expr}.\\{data}.\|n,\39\&{mp\_color%
\_model}(\|p));{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{break};\6
\4\&{case} \\{mp\_text\_part}:\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_text\_node\_type}){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_text\_p}(\|p);{}$\6
${}\\{add\_str\_ref}(\\{new\_expr}.\\{data}.\\{str});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{mp\_prescript\_part}:\6
\&{if} ${}(\R\\{has\_color}(\|p)){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} (\\{mp\_pre\_script}(\|p))\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_pre\_script}(\|p);{}$\6
${}\\{add\_str\_ref}(\\{new\_expr}.\\{data}.\\{str});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_rts}(\\{mp},\39\.{""});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{mp\_postscript\_part}:\6
\&{if} ${}(\R\\{has\_color}(\|p)){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} (\\{mp\_post\_script}(\|p))\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_post\_script}(\|p);{}$\6
${}\\{add\_str\_ref}(\\{new\_expr}.\\{data}.\\{str});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_rts}(\\{mp},\39\.{""});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{mp\_font\_part}:\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_text\_node\_type}){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_rts}(\\{mp},\39\\{mp}\MG\\{font%
\_name}[\\{mp\_font\_n}(\|p)]);{}$\6
${}\\{add\_str\_ref}(\\{new\_expr}.\\{data}.\\{str});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{mp\_path\_part}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_text\_node\_type}){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{is\_stop}(\|p))\5
${}\{{}$\1\6
${}\\{mp\_confusion}(\\{mp},\39\.{"pict"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{node}\K\NULL;{}$\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_copy\_path}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_fill\_node}) \|p));\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_copy\_path}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_stroked\_node}) \|p));\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_copy\_path}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_start\_bounds\_node}) \|p));\6
\&{break};\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_copy\_path}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_start\_clip\_node}) \|p));\6
\&{break};\6
\4\&{default}:\5
\\{assert}(\T{0});\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_pen\_part}:\6
\&{if} ${}(\R\\{has\_pen}(\|p)){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|p)${}\E\NULL){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\|p\K\\{copy\_pen}{}$(\\{mp\_pen\_p}((\&{mp\_fill%
\_node}) \|p));\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p)${}\E\NULL){}$\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\|p\K\\{copy\_pen}{}$(\\{mp\_pen\_p}((\&{mp\_stroked%
\_node}) \|p));\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{default}:\5
\\{assert}(\T{0});\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_dash\_part}:\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_stroked\_node\_type}){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_dash\_p}(\|p)\E\NULL){}$\5
${}\{{}$\1\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{add\_edge\_ref}(\\{mp\_dash\_p}(\|p));\6
${}\\{new\_expr}.\\{data}.\\{node}\K{}$(\&{mp\_node}) \\{mp\_scale\_edges}${}(%
\\{mp},\39{}$((\&{mp\_stroked\_node}) \|p)${}\MG\\{dash\_scale},\39{}$(\&{mp%
\_edge\_header\_node}) \\{mp\_dash\_p}(\|p));\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4${}\}{}$\C{ all cases have been enumerated }\2\6
\&{return};\6
\4${}\}{}$\2\6
;\6
\4\.{NOT\_FOUND}:\C{ Convert the current expression to a NULL value appropriate
for \PB{\|c} }\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_text\_part}:\5
\&{case} \\{mp\_font\_part}:\5
\&{case} \\{mp\_prescript\_part}:\5
\&{case} \\{mp\_postscript\_part}:\5
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp\_rts}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\&{break};\6
\4\&{case} \\{mp\_path\_part}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_new\_knot}(\\{mp});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\K\\{mp\_endpoint};{}$\6
${}\\{mp\_right\_type}(\\{cur\_exp\_knot}(\,))\K\\{mp\_endpoint};{}$\6
${}\\{mp\_next\_knot}(\\{cur\_exp\_knot}(\,))\K\\{cur\_exp\_knot}(\,);{}$\6
${}\\{set\_number\_to\_zero}(\\{cur\_exp\_knot}(\,)\MG\\{x\_coord});{}$\6
${}\\{set\_number\_to\_zero}(\\{cur\_exp\_knot}(\,)\MG\\{y\_coord});{}$\6
${}\\{mp\_originator}(\\{cur\_exp\_knot}(\,))\K\\{mp\_metapost\_user};{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_part}:\5
${}\\{new\_expr}.\\{data}.\|p\K\\{mp\_get\_pen\_circle}(\\{mp},\39\\{zero%
\_t});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pen\_type};{}$\6
\&{break};\6
\4\&{case} \\{mp\_dash\_part}:\5
${}\\{new\_expr}.\\{data}.\\{node}\K{}$(\&{mp\_node}) \\{mp\_get\_edge\_header%
\_node}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp\_init\_edges}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{cur\_exp%
\_node}(\,));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{974}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_str\_to\_num}(\&{MP} \\{mp}${},\39{}$\&{quarterword}
\|c)\1\1\2\2\6
${}\{{}$\C{ converts a string to a number }\1\6
\&{integer} \|n;\C{ accumulator }\6
\&{ASCII\_code} \|m;\C{ current character }\6
\&{unsigned} \|k;\C{ index into \PB{\\{str\_pool}} }\6
\&{int} \|b;\C{ radix of conversion }\6
\&{boolean} \\{bad\_char};\C{ did the string contain an invalid digit? }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\|c\E\\{mp\_ASCII\_op}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}\E\T{0}){}$\1\5
${}\|n\K{-}\T{1};{}$\2\6
\&{else}\1\5
${}\|n\K\\{cur\_exp\_str}(\,)\MG\\{str}[\T{0}];{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|c\E\\{mp\_oct\_op}){}$\1\5
${}\|b\K\T{8};{}$\2\6
\&{else}\1\5
${}\|b\K\T{16};{}$\2\6
${}\|n\K\T{0};{}$\6
${}\\{bad\_char}\K\\{false};{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{cur\_exp\_str}(\,)\MG\\{len};{}$ ${}\|k%
\PP){}$\5
${}\{{}$\1\6
${}\|m\K(\&{ASCII\_code})({*}(\\{cur\_exp\_str}(\,)\MG\\{str}+\|k));{}$\6
\&{if} ${}((\|m\G\.{'0'})\W(\|m\Z\.{'9'})){}$\1\5
${}\|m\K(\&{ASCII\_code})(\|m-\.{'0'});{}$\2\6
\&{else} \&{if} ${}((\|m\G\.{'A'})\W(\|m\Z\.{'F'})){}$\1\5
${}\|m\K(\&{ASCII\_code})(\|m-\.{'A'}+\T{10});{}$\2\6
\&{else} \&{if} ${}((\|m\G\.{'a'})\W(\|m\Z\.{'f'})){}$\1\5
${}\|m\K(\&{ASCII\_code})(\|m-\.{'a'}+\T{10});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{bad\_char}\K\\{true};{}$\6
${}\|m\K\T{0};{}$\6
\4${}\}{}$\2\6
;\6
\&{if} ((\&{int}) \|m${}\G\|b){}$\5
${}\{{}$\1\6
${}\\{bad\_char}\K\\{true};{}$\6
${}\|m\K\T{0};{}$\6
\4${}\}{}$\2\6
;\6
\&{if} ${}(\|n<\T{32768}/\|b){}$\1\5
${}\|n\K\|n*\|b+\|m;{}$\2\6
\&{else}\1\5
${}\|n\K\T{32767};{}$\2\6
\4${}\}{}$\C{ Give error messages if \PB{\\{bad\_char}} or \PB{$\|n\G\T{4096}$}
}\2\6
\&{if} (\\{bad\_char})\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ zeroed\ out\ charac}\)\.{ters\
that\ weren't\ he}\)\.{x\ digits."},\39\NULL\};{}$\7
\&{if} ${}(\|c\E\\{mp\_oct\_op}){}$\5
${}\{{}$\1\6
${}\\{hlp}[\T{0}]\K\.{"I\ zeroed\ out\ charac}\)\.{ters\ that\ weren't\ in}\)%
\.{\ the\ range\ 0..7."};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"String\ contains\ ill}\)\.{egal\ digits"},%
\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{if} ${}((\|n>\T{4095})){}$\5
${}\{{}$\C{ todo, this is scaled specific }\1\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_warning\_check})))\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ have\ trouble\ with}\)\.{\
numbers\ greater\ tha}\)\.{n\ 4095;\ watch\ out."},\39\.{"(Set\ warningcheck:=}%
\)\.{0\ to\ suppress\ this\ m}\)\.{essage.)"},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Number\ too\ large\ (\%}\)%
\.{d)"},\39{}$(\&{int}) \|n);\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{new\_expr}.\\{data}.\|n,\39\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{975}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_path\_length}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|n){}$\1\1\2\2\6
${}\{{}$\C{ computes the length of the current path }\1\6
\&{mp\_knot} \|p;\C{ traverser }\7
${}\\{set\_number\_to\_zero}({*}\|n);{}$\6
${}\|p\K\\{cur\_exp\_knot}(\,);{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{number\_substract}({*}\|n,\39\\{unity\_t}){}$;\C{ -unity }\6
\4${}\}{}$\2\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{number\_add}({*}\|n,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\\{cur\_exp\_knot}(\,));{}$\6
\4${}\}{}$\2\par
\fi

\M{976}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_pict\_length}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|n){}$\1\1\2\2\6
${}\{{}$\C{ counts interior components in picture \PB{\\{cur\_exp}} }\1\6
\&{mp\_node} \|p;\C{ traverser }\7
${}\\{set\_number\_to\_zero}({*}\|n);{}$\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\\{cur\_exp\_node}(\,)));{}$\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{is\_start\_or\_stop}(\|p))\1\6
\&{if} ${}(\\{mp\_skip\_1component}(\\{mp},\39\|p)\E\NULL){}$\1\5
${}\|p\K\\{mp\_link}(\|p);{}$\2\2\6
\&{while} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{is\_start\_or\_stop}(\|p)){}$\1\5
${}\|p\K\\{mp\_link}(\|p);{}$\2\6
\&{else} \&{if} ${}(\R\\{is\_stop}(\|p)){}$\1\5
${}\|p\K\\{mp\_skip\_1component}(\\{mp},\39\|p);{}$\2\6
\&{else}\1\5
\&{return};\2\6
${}\\{number\_add}({*}\|n,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{977}The function \PB{\\{an\_angle}} returns the value of the \PB{\\{angle}}
primitive, or $0$ if the
argument is \PB{\\{origin}}.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_an\_angle}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \\{xpar}${},\39{}$\&{mp\_number} \\{ypar})\1%
\1\2\2\6
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}({*}\\{ret});{}$\6
\&{if} ${}((\R(\\{number\_zero}(\\{xpar})\W\\{number\_zero}(\\{ypar})))){}$\5
${}\{{}$\1\6
${}\\{n\_arg}({*}\\{ret},\39\\{xpar},\39\\{ypar});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{978}The actual turning number is (for the moment) computed in a C function
that receives eight integers corresponding to the four controlling points,
and returns a single angle.  Besides those, we have to account for discrete
moves at the actual points.

\Y\B\4\D$\\{mp\_floor}(\|a)$ \5
$((\|a)\G\T{0}\?(\&{int})(\|a):{-}(\&{int})({-}(\|a)){}$)\par
\B\4\D$\\{bezier\_error}$ \5
$(\T{720}*(\T{256}*\T{256}*\T{16}))+{}$\T{1}\par
\B\4\D$\\{mp\_sign}(\|v)$ \5
$((\|v)>\T{0}\?\T{1}:((\|v)<\T{0}\?{-}\T{1}:\T{0}){}$)\par
\B\4\D$\\{mp\_out}(\|A)$ \5
$(\&{double})((\|A)/\T{16}{}$)\par
\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_bezier\_slope}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{ret},\39{}$\&{mp\_number} \.{AX}${},\39{}$\&{mp\_number} \.{AY}${},%
\39{}$\&{mp\_number} \.{BX}${},\39{}$\&{mp\_number} \.{BY}${},\39{}$\&{mp%
\_number} \.{CX}${},\39{}$\&{mp\_number} \.{CY}${},\39{}$\&{mp\_number} %
\.{DX}${},\39{}$\&{mp\_number} \.{DY});\par
\fi

\M{979}\B\&{static} \&{void} \\{mp\_bezier\_slope}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_number} \.{AX}${},\39{}$\&{mp\_number} %
\.{AY}${},\39{}$\&{mp\_number} \.{BX}${},\39{}$\&{mp\_number} \.{BY}${},\39{}$%
\&{mp\_number} \.{CX}${},\39{}$\&{mp\_number} \.{CY}${},\39{}$\&{mp\_number} %
\.{DX}${},\39{}$\&{mp\_number} \.{DY})\1\1\2\2\6
${}\{{}$\1\6
\&{double} \|a${},{}$ \|b${},{}$ \|c;\6
\&{mp\_number} \\{deltax}${},{}$ \\{deltay};\6
\&{double} \\{ax}${},{}$ \\{ay}${},{}$ \\{bx}${},{}$ \\{by}${},{}$ %
\\{cx}${},{}$ \\{cy}${},{}$ \\{dx}${},{}$ \\{dy};\6
\&{mp\_number} \\{xi}${},{}$ \\{xo}${},{}$ \\{xm};\6
\&{double} \\{res}${}\K\T{0};{}$\7
${}\\{ax}\K\\{number\_to\_double}(\.{AX});{}$\6
${}\\{ay}\K\\{number\_to\_double}(\.{AY});{}$\6
${}\\{bx}\K\\{number\_to\_double}(\.{BX});{}$\6
${}\\{by}\K\\{number\_to\_double}(\.{BY});{}$\6
${}\\{cx}\K\\{number\_to\_double}(\.{CX});{}$\6
${}\\{cy}\K\\{number\_to\_double}(\.{CY});{}$\6
${}\\{dx}\K\\{number\_to\_double}(\.{DX});{}$\6
${}\\{dy}\K\\{number\_to\_double}(\.{DY});{}$\6
\\{new\_number}(\\{deltax});\6
\\{new\_number}(\\{deltay});\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{BX},\39\.{AX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{BY},\39\.{AY});{}$\6
\&{if} ${}(\\{number\_zero}(\\{deltax})\W\\{number\_zero}(\\{deltay})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{CX},\39\.{AX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{CY},\39\.{AY});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_zero}(\\{deltax})\W\\{number\_zero}(\\{deltay})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{DX},\39\.{AX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{DY},\39\.{AY});{}$\6
\4${}\}{}$\2\6
\\{new\_number}(\\{xi});\6
\\{new\_number}(\\{xm});\6
\\{new\_number}(\\{xo});\6
${}\\{mp\_an\_angle}(\\{mp},\39{\AND}\\{xi},\39\\{deltax},\39\\{deltay});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{CX},\39\.{BX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{CY},\39\.{BY});{}$\6
${}\\{mp\_an\_angle}(\\{mp},\39{\AND}\\{xm},\39\\{deltax},\39\\{deltay}){}$;\C{
!!! never used? }\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{DX},\39\.{CX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{DY},\39\.{CY});{}$\6
\&{if} ${}(\\{number\_zero}(\\{deltax})\W\\{number\_zero}(\\{deltay})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{DX},\39\.{BX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{DY},\39\.{BY});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_zero}(\\{deltax})\W\\{number\_zero}(\\{deltay})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_substraction}(\\{deltax},\39\.{DX},\39\.{AX});{}$\6
${}\\{set\_number\_from\_substraction}(\\{deltay},\39\.{DY},\39\.{AY});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_an\_angle}(\\{mp},\39{\AND}\\{xo},\39\\{deltax},\39\\{deltay});{}$\6
${}\|a\K(\\{bx}-\\{ax})*(\\{cy}-\\{by})-(\\{cx}-\\{bx})*(\\{by}-\\{ay}){}$;\C{
a = (bp-ap)x(cp-bp); }\6
${}\|b\K(\\{bx}-\\{ax})*(\\{dy}-\\{cy})-(\\{by}-\\{ay})*(\\{dx}-\\{cx});{}$\6
;\C{ b = (bp-ap)x(dp-cp); }\6
${}\|c\K(\\{cx}-\\{bx})*(\\{dy}-\\{cy})-(\\{dx}-\\{cx})*(\\{cy}-\\{by}){}$;\C{
c = (cp-bp)x(dp-cp); }\6
\&{if} ${}((\|a\E\T{0})\W(\|c\E\T{0})){}$\5
${}\{{}$\1\6
${}\\{res}\K(\|b\E\T{0}\?\T{0}:(\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-%
\\{mp\_out}(\\{number\_to\_double}(\\{xi}))));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\|a\E\T{0})\V(\|c\E\T{0})){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{mp\_sign}(\|b)\E\\{mp\_sign}(\|a))\V(\\{mp\_sign}(\|b)\E\\{mp%
\_sign}(\|c))){}$\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi})){}$;\C{ ? }\6
\&{if} ${}(\\{res}<{-}\T{180.0}){}$\1\5
${}\\{res}\MRL{+{\K}}\T{360.0};{}$\2\6
\&{else} \&{if} ${}(\\{res}>\T{180.0}){}$\1\5
${}\\{res}\MRL{-{\K}}\T{360.0};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi})){}$;\C{ ? }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp\_sign}(\|a)*\\{mp\_sign}(\|c))<\T{0}){}$\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi})){}$;\C{ ? }\6
\&{if} ${}(\\{res}<{-}\T{180.0}){}$\1\5
${}\\{res}\MRL{+{\K}}\T{360.0};{}$\2\6
\&{else} \&{if} ${}(\\{res}>\T{180.0}){}$\1\5
${}\\{res}\MRL{-{\K}}\T{360.0};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_sign}(\|a)\E\\{mp\_sign}(\|b)){}$\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi})){}$;\C{ ? }\6
\&{if} ${}(\\{res}<{-}\T{180.0}){}$\1\5
${}\\{res}\MRL{+{\K}}\T{360.0};{}$\2\6
\&{else} \&{if} ${}(\\{res}>\T{180.0}){}$\1\5
${}\\{res}\MRL{-{\K}}\T{360.0};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}((\|b*\|b)\E(\T{4}*\|a*\|c)){}$\5
${}\{{}$\1\6
${}\\{res}\K{}$(\&{double}) \\{bezier\_error};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\|b*\|b)<(\T{4}*\|a*\|c)){}$\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi})){}$;\C{ ? }\6
\&{if} ${}(\\{res}\Z\T{0.0}\W\\{res}>{-}\T{180.0}){}$\1\5
${}\\{res}\MRL{+{\K}}\T{360.0};{}$\2\6
\&{else} \&{if} ${}(\\{res}\G\T{0.0}\W\\{res}<\T{180.0}){}$\1\5
${}\\{res}\MRL{-{\K}}\T{360.0};{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{res}\K\\{mp\_out}(\\{number\_to\_double}(\\{xo}))-\\{mp\_out}(\\{number%
\_to\_double}(\\{xi}));{}$\6
\&{if} ${}(\\{res}<{-}\T{180.0}){}$\1\5
${}\\{res}\MRL{+{\K}}\T{360.0};{}$\2\6
\&{else} \&{if} ${}(\\{res}>\T{180.0}){}$\1\5
${}\\{res}\MRL{-{\K}}\T{360.0};{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{deltax});\6
\\{free\_number}(\\{deltay});\6
\\{free\_number}(\\{xi});\6
\\{free\_number}(\\{xo});\6
\\{free\_number}(\\{xm});\6
${}\\{set\_number\_from\_double}({*}\\{ret},\39\\{res});{}$\6
${}\\{convert\_scaled\_to\_angle}({*}\\{ret});{}$\6
\4${}\}{}$\2\par
\fi

\M{980}
\Y\B\4\D$\\{p\_nextnext}$ \5
\\{mp\_next\_knot}(\\{mp\_next\_knot}(\|p))\par
\B\4\D$\\{p\_next}$ \5
\\{mp\_next\_knot}(\|p)\par
\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_turn\_cycles}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\\{turns},\39{}$\&{mp\_knot} \|c)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_angle}\\{res},\39\\{ang}{}$;\C{  the angles of intermediate results
}\7
\&{mp\_knot} \|p;\C{  for running around the path  }\6
\&{mp\_number} \\{xp}${},{}$ \\{yp};\C{  coordinates of next point  }\6
\&{mp\_number} \|x${},{}$ \|y;\C{  helper coordinates  }\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
${}\\{mp\_angle}\\{in\_angle},\39\\{out\_angle}{}$;\C{  helper angles }\6
${}\\{mp\_angle}\\{seven\_twenty\_deg\_t},\39\\{neg\_one\_eighty\_deg\_t};{}$\7
\&{unsigned} \\{old\_setting};\C{ saved \PB{\\{selector}} setting }\7
${}\\{set\_number\_to\_zero}({*}\\{turns});{}$\6
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_number}(\\{xp});\6
\\{new\_number}(\\{yp});\6
\\{new\_number}(\|x);\6
\\{new\_number}(\|y);\6
\\{new\_angle}(\\{in\_angle});\6
\\{new\_angle}(\\{out\_angle});\6
\\{new\_angle}(\\{ang});\6
\\{new\_angle}(\\{res});\6
\\{new\_angle}(\\{seven\_twenty\_deg\_t});\6
\\{new\_angle}(\\{neg\_one\_eighty\_deg\_t});\6
${}\\{number\_clone}(\\{seven\_twenty\_deg\_t},\39\\{three\_sixty\_deg\_t});{}$%
\6
\\{number\_double}(\\{seven\_twenty\_deg\_t});\6
${}\\{number\_clone}(\\{neg\_one\_eighty\_deg\_t},\39\\{one\_eighty\_deg%
\_t});{}$\6
\\{number\_negate}(\\{neg\_one\_eighty\_deg\_t});\6
${}\|p\K\|c;{}$\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{unity\_t})){}$\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{do}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{xp},\39\\{p\_next}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\\{yp},\39\\{p\_next}\MG\\{y\_coord});{}$\6
${}\\{mp\_bezier\_slope}(\\{mp},\39{\AND}\\{ang},\39\|p\MG\\{x\_coord},\39\|p%
\MG\\{y\_coord},\39\|p\MG\\{right\_x},\39\|p\MG\\{right\_y},\39\\{p\_next}\MG%
\\{left\_x},\39\\{p\_next}\MG\\{left\_y},\39\\{xp},\39\\{yp});{}$\6
\&{if} ${}(\\{number\_greater}(\\{ang},\39\\{seven\_twenty\_deg\_t})){}$\5
${}\{{}$\1\6
${}\\{mp\_error}(\\{mp},\39\.{"Strange\ path"},\39\NULL,\39\\{true});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{set\_number\_to\_zero}({*}\\{turns});{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
${}\\{number\_add}(\\{res},\39\\{ang});{}$\6
\&{if} ${}(\\{number\_greater}(\\{res},\39\\{one\_eighty\_deg\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_substract}(\\{res},\39\\{three\_sixty\_deg\_t});{}$\6
${}\\{number\_add}({*}\\{turns},\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_lessequal}(\\{res},\39\\{neg\_one\_eighty\_deg\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{res},\39\\{three\_sixty\_deg\_t});{}$\6
${}\\{number\_substract}({*}\\{turns},\39\\{unity\_t});{}$\6
\4${}\}{}$\C{  incoming angle at next point  }\2\6
${}\\{number\_clone}(\|x,\39\\{p\_next}\MG\\{left\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{p\_next}\MG\\{left\_y});{}$\6
\&{if} ${}(\\{number\_equal}(\\{xp},\39\|x)\W\\{number\_equal}(\\{yp},\39%
\|y)){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\|p\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|y,\39\|p\MG\\{right\_y});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_equal}(\\{xp},\39\|x)\W\\{number\_equal}(\\{yp},\39%
\|y)){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\|p\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|y,\39\|p\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{xp},\39\|x);{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\\{yp},\39\|y);{}$\6
${}\\{mp\_an\_angle}(\\{mp},\39{\AND}\\{in\_angle},\39\\{arg1},\39\\{arg2}){}$;%
\C{  outgoing angle at next point  }\6
${}\\{number\_clone}(\|x,\39\\{p\_next}\MG\\{right\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{p\_next}\MG\\{right\_y});{}$\6
\&{if} ${}(\\{number\_equal}(\\{xp},\39\|x)\W\\{number\_equal}(\\{yp},\39%
\|y)){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{p\_nextnext}\MG\\{left\_x});{}$\6
${}\\{number\_clone}(\|y,\39\\{p\_nextnext}\MG\\{left\_y});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_equal}(\\{xp},\39\|x)\W\\{number\_equal}(\\{yp},\39%
\|y)){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{p\_nextnext}\MG\\{x\_coord});{}$\6
${}\\{number\_clone}(\|y,\39\\{p\_nextnext}\MG\\{y\_coord});{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\|x,\39\\{xp});{}$\6
${}\\{set\_number\_from\_substraction}(\\{arg2},\39\|y,\39\\{yp});{}$\6
${}\\{mp\_an\_angle}(\\{mp},\39{\AND}\\{out\_angle},\39\\{arg1},\39%
\\{arg2});{}$\6
${}\\{set\_number\_from\_substraction}(\\{ang},\39\\{out\_angle},\39\\{in%
\_angle});{}$\6
${}\\{mp\_reduce\_angle}(\\{mp},\39{\AND}\\{ang});{}$\6
\&{if} (\\{number\_nonzero}(\\{ang}))\5
${}\{{}$\1\6
${}\\{number\_add}(\\{res},\39\\{ang});{}$\6
\&{if} ${}(\\{number\_greaterequal}(\\{res},\39\\{one\_eighty\_deg\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_substract}(\\{res},\39\\{three\_sixty\_deg\_t});{}$\6
${}\\{number\_add}({*}\\{turns},\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_lessequal}(\\{res},\39\\{neg\_one\_eighty\_deg\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{res},\39\\{three\_sixty\_deg\_t});{}$\6
${}\\{number\_substract}({*}\\{turns},\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\|c);{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
\4\.{DONE}:\5
\\{free\_number}(\\{xp});\6
\\{free\_number}(\\{yp});\6
\\{free\_number}(\|x);\6
\\{free\_number}(\|y);\6
\\{free\_number}(\\{seven\_twenty\_deg\_t});\6
\\{free\_number}(\\{neg\_one\_eighty\_deg\_t});\6
\\{free\_number}(\\{in\_angle});\6
\\{free\_number}(\\{out\_angle});\6
\\{free\_number}(\\{ang});\6
\\{free\_number}(\\{res});\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\par
\fi

\M{981}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_turn\_cycles\_wrapper}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} ${}{*}\\{ret},\39{}$\&{mp\_knot} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_next\_knot}(\|c)\E\|c){}$\5
${}\{{}$\C{ one-knot paths always have a turning number of 1 }\1\6
${}\\{set\_number\_to\_unity}({*}\\{ret});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_turn\_cycles}(\\{mp},\39\\{ret},\39\|c);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{982}\B\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_test\_known}(\&{MP} \\{mp}${},\39{}$\&{quarterword} %
\|c)\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|b;\C{ is the current expression known? }\6
\&{mp\_node} \|p;\C{ location in a big node }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\|b\K\\{mp\_false\_code};{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_vacuous}:\5
\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_string\_type}:\5
\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_picture\_type}:\5
\&{case} \\{mp\_known}:\5
${}\|b\K\\{mp\_true\_code};{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp\_type}(\\{tx\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{ty\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{xx\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{xy\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{yx\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{yy\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
${}\|b\K\\{mp\_true\_code};{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp\_type}(\\{red\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{green\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{blue\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
${}\|b\K\\{mp\_true\_code};{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp\_type}(\\{cyan\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{magenta\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{yellow\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{black\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
${}\|b\K\\{mp\_true\_code};{}$\6
\&{break};\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\|p\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp\_type}(\\{x\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{mp\_type}(\\{y\_part}(\|p))\I\\{mp\_known}){}$\1\5
\&{break};\2\6
${}\|b\K\\{mp\_true\_code};{}$\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\E\\{mp\_known\_op}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\|b);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|b\E\\{mp\_true\_code}){}$\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_true%
\_code});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{cur\_exp\_node}(\,)\K\NULL{}$;\C{ !! do not replace with \PB{\\{set\_cur%
\_exp\_node}(\,)} !! }\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4${}\}{}$\2\par
\fi

\M{983}The \PB{\\{pair\_value}} routine changes the current expression to a
given ordered pair of values.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_pair\_value}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} %
\|x${},\39{}$\&{mp\_number} \|y)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ a pair node }\6
\&{mp\_value} \\{new\_expr};\6
\&{mp\_number} \\{x1}${},{}$ \\{y1};\7
\\{new\_number}(\\{x1});\6
\\{new\_number}(\\{y1});\6
${}\\{number\_clone}(\\{x1},\39\|x);{}$\6
${}\\{number\_clone}(\\{y1},\39\|y);{}$\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\|p\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{new\_expr}.\\{type}\K\\{mp\_type}(\|p);{}$\6
${}\\{new\_expr}.\\{data}.\\{node}\K\|p;{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_pair\_type};{}$\6
${}\\{mp\_name\_type}(\|p)\K\\{mp\_capsule};{}$\6
${}\\{mp\_init\_pair\_node}(\\{mp},\39\|p);{}$\6
${}\|p\K\\{value\_node}(\|p);{}$\6
${}\\{mp\_type}(\\{x\_part}(\|p))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{x\_part}(\|p),\39\\{x1});{}$\6
${}\\{mp\_type}(\\{y\_part}(\|p))\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\\{y\_part}(\|p),\39\\{y1});{}$\6
\\{free\_number}(\\{x1});\6
\\{free\_number}(\\{y1});\6
\4${}\}{}$\2\par
\fi

\M{984}Here is a function that sets \PB{\\{minx}}, \PB{\\{maxx}}, \PB{%
\\{miny}}, \PB{\\{maxy}} to the bounding
box of the current expression.  The boolean result is \PB{\\{false}} if the
expression
has the wrong type.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{boolean} \\{mp\_get\_cur\_bbox}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_picture\_type}:\6
${}\{{}$\1\6
\&{mp\_edge\_header\_node} \\{p0}${}\K{}$(\&{mp\_edge\_header\_node}) \\{cur%
\_exp\_node}(\,);\7
${}\\{mp\_set\_bbox}(\\{mp},\39\\{p0},\39\\{true});{}$\6
\&{if} ${}(\\{number\_greater}(\\{p0}\MG\\{minx},\39\\{p0}\MG\\{maxx})){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\\{mp\_minx});\6
\\{set\_number\_to\_zero}(\\{mp\_maxx});\6
\\{set\_number\_to\_zero}(\\{mp\_miny});\6
\\{set\_number\_to\_zero}(\\{mp\_maxy});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp\_minx},\39\\{p0}\MG\\{minx});{}$\6
${}\\{number\_clone}(\\{mp\_maxx},\39\\{p0}\MG\\{maxx});{}$\6
${}\\{number\_clone}(\\{mp\_miny},\39\\{p0}\MG\\{miny});{}$\6
${}\\{number\_clone}(\\{mp\_maxy},\39\\{p0}\MG\\{maxy});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_path\_type}:\5
${}\\{mp\_path\_bbox}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_pen\_type}:\5
${}\\{mp\_pen\_bbox}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\&{break};\6
\4\&{default}:\5
\&{return} \\{false};\6
\4${}\}{}$\2\6
\&{return} \\{true};\6
\4${}\}{}$\2\par
\fi

\M{985}Here is a routine that interprets \PB{\\{cur\_exp}} as a file name and
tries to read
a line from the file or to close the file.

\Y\B\4\X960:Declare unary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_read\_or\_close}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{readf\_index} \|n${},{}$ \\{n0};\C{ indices for searching \PB{\\{rd\_fname}}
}\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n){}$;\C{ Find the \PB{\|n} where %
\PB{$\\{rd\_fname}[\|n]\K\\{cur\_exp}$}; if \PB{\\{cur\_exp}} must be inserted,
     call \PB{\\{start\_read\_input}} and \PB{\&{goto} \\{found}} or \PB{\\{not%
\_found}} }\C{ Free slots in the \PB{\\{rd\_file}} and \PB{\\{rd\_fname}}
arrays are marked with NULL's in      \PB{\\{rd\_fname}}. }\6
${}\{{}$\1\6
\&{char} ${}{*}\\{fn};{}$\7
${}\|n\K\\{mp}\MG\\{read\_files};{}$\6
${}\\{n0}\K\\{mp}\MG\\{read\_files};{}$\6
${}\\{fn}\K\\{mp\_xstrdup}(\\{mp},\39\\{mp\_str}(\\{mp},\39\\{cur\_exp\_str}(%
\,)));{}$\6
\&{while} ${}(\\{mp\_xstrcmp}(\\{fn},\39\\{mp}\MG\\{rd\_fname}[\|n])\I\T{0}){}$%
\5
${}\{{}$\1\6
\&{if} ${}(\|n>\T{0}){}$\5
${}\{{}$\1\6
\\{decr}(\|n);\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\\{mp\_close\_from\_op}){}$\5
${}\{{}$\1\6
\&{goto} \.{CLOSE\_FILE};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{n0}\E\\{mp}\MG\\{read\_files}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{read\_files}<\\{mp}\MG\\{max\_read\_files}){}$\5
${}\{{}$\1\6
${}\\{incr}(\\{mp}\MG\\{read\_files});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{void} ${}{*}{*}\\{rd\_file};{}$\6
\&{char} ${}{*}{*}\\{rd\_fname};{}$\6
\&{readf\_index} \|l${},{}$ \|k;\7
${}\|l\K\\{mp}\MG\\{max\_read\_files}+(\\{mp}\MG\\{max\_read\_files}/\T{4});{}$%
\6
${}\\{rd\_file}\K\\{xmalloc}((\|l+\T{1}),\39{}$\&{sizeof}(\&{void} ${}{*}));{}$%
\6
${}\\{rd\_fname}\K\\{xmalloc}((\|l+\T{1}),\39{}$\&{sizeof}(\&{char}
${}{*}));{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\|l;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|k\Z\\{mp}\MG\\{max\_read\_files}){}$\5
${}\{{}$\1\6
${}\\{rd\_file}[\|k]\K\\{mp}\MG\\{rd\_file}[\|k];{}$\6
${}\\{rd\_fname}[\|k]\K\\{mp}\MG\\{rd\_fname}[\|k];{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{rd\_file}[\|k]\K\T{0};{}$\6
${}\\{rd\_fname}[\|k]\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{rd\_file});{}$\6
${}\\{xfree}(\\{mp}\MG\\{rd\_fname});{}$\6
${}\\{mp}\MG\\{max\_read\_files}\K\|l;{}$\6
${}\\{mp}\MG\\{rd\_file}\K\\{rd\_file};{}$\6
${}\\{mp}\MG\\{rd\_fname}\K\\{rd\_fname};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|n\K\\{n0};{}$\6
\&{if} ${}(\\{mp\_start\_read\_input}(\\{mp},\39\\{fn},\39\|n)){}$\1\5
\&{goto} \.{FOUND};\2\6
\&{else}\1\5
\&{goto} \.{NOT\_FOUND};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{rd\_fname}[\|n]\E\NULL){}$\5
${}\{{}$\1\6
${}\\{n0}\K\|n;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\E\\{mp\_close\_from\_op}){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|n]);{}$\6
\&{goto} \.{NOT\_FOUND};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_begin\_file\_reading}(\\{mp});\6
${}\\{name}\K\\{is\_read};{}$\6
\&{if} ${}(\\{mp\_input\_ln}(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|n])){}$\1\5
\&{goto} \.{FOUND};\2\6
\\{mp\_end\_file\_reading}(\\{mp});\6
\4\.{NOT\_FOUND}:\C{ Record the end of file and set \PB{\\{cur\_exp}} to a
dummy value  }\6
${}\\{xfree}(\\{mp}\MG\\{rd\_fname}[\|n]);{}$\6
${}\\{mp}\MG\\{rd\_fname}[\|n]\K\NULL;{}$\6
\&{if} ${}(\|n\E\\{mp}\MG\\{read\_files}-\T{1}){}$\1\5
${}\\{mp}\MG\\{read\_files}\K\|n;{}$\2\6
\&{if} ${}(\|c\E\\{mp\_close\_from\_op}){}$\1\5
\&{goto} \.{CLOSE\_FILE};\2\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{mp}\MG\\{eof\_line};{}$\6
${}\\{add\_str\_ref}(\\{new\_expr}.\\{data}.\\{str});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_string\_type};{}$\6
\&{return};\6
\4\.{CLOSE\_FILE}:\5
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\&{return};\6
\4\.{FOUND}:\5
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\\{mp\_finish\_read}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{986}The string denoting end-of-file is a one-byte string at position zero,
by definition.
I have to cheat a little here because

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_string} \\{eof\_line};\par
\fi

\M{987}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{eof\_line}\K\\{mp\_rtsl}(\\{mp},\39\.{"\\0"},\39\T{1});{}$\6
${}\\{mp}\MG\\{eof\_line}\MG\\{refs}\K\.{MAX\_STR\_REF}{}$;\par
\fi

\M{988}Finally, we have the operations that combine a capsule~\PB{\|p}
with the current expression.

Several of the binary operations are potentially complicated by the
fact that \PB{\\{independent}} values can sneak into capsules. For example,
we've seen an instance of this difficulty in the unary operation
of negation. In order to reduce the number of cases that need to be
handled, we first change the two operands (if necessary)
to rid them of \PB{\\{independent}} components. The original operands are
put into capsules called \PB{\\{old\_p}} and \PB{\\{old\_exp}}, which will be
recycled after the binary operation has been safely carried out.

\Y\B\4\D$\\{binary\_return}$ \6
${}\{{}$\1\6
${}\\{mp\_finish\_binary}(\\{mp},\39\\{old\_p},\39\\{old\_exp});{}$\6
\&{return};\6
\4${}\}{}$\2\par
\Y\B\X989:Declare binary action procedures\X;\7
\&{static} \&{void} \\{mp\_finish\_binary}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\\{old\_p}${},\39{}$\&{mp\_node} \\{old\_exp})\1\1\2\2\6
${}\{{}$\1\6
\\{check\_arith}(\,);\C{ Recycle any sidestepped \PB{\\{independent}} capsules
}\6
\&{if} ${}(\\{old\_p}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{old\_p});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{old\_p});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{old\_exp}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{old\_exp});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{old\_exp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_do\_binary}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{integer} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r${},{}$ \\{rr};\C{ for list manipulation }\6
\&{mp\_node} \\{old\_p}${},{}$ \\{old\_exp};\C{ capsules to recycle }\6
\&{mp\_value} \\{new\_expr};\7
\\{check\_arith}(\,);\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\5
${}\{{}$\C{ Trace the current binary operation }\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{("});{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\|p,\39\T{0}){}$;\C{ show the operand, but not
verbosely }\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{')'}));{}$\6
${}\\{mp\_print\_op}(\\{mp},\39{}$(\&{quarterword}) \|c);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{0});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{")\}"});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\C{ Sidestep \PB{\\{independent}} cases in capsule \PB{\|p} }\C{ A
big node is considered to be ``tarnished'' if it contains at least one
independent component. We will define a simple function called `\PB{%
\\{tarnished}}'      that returns \PB{$\NULL$} if and only if its argument is
not tarnished. }\2\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
${}\\{old\_p}\K\\{mp\_tarnished}(\\{mp},\39\|p);{}$\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\\{old\_p}\K\.{MP\_VOID};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{old\_p}\K\NULL;{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{old\_p}\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{old\_p}\K\|p;{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{old\_p});{}$\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\C{ Sidestep \PB{\\{independent}} cases in the current expression }\2%
\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
${}\\{old\_exp}\K\\{mp\_tarnished}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\\{old\_exp}\K\.{MP\_VOID};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{old\_exp}\K\NULL;{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{old\_exp}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{old\_exp}\K\\{cur\_exp\_node}(\,);{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{old\_exp});{}$\6
\4${}\}{}$\2\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_plus}:\5
\&{case} \\{mp\_minus}:\C{ Add or subtract the current expression from \PB{\|p}
}\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_color\_type})\V(\\{mp\_type}(%
\|p)<\\{mp\_color\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{quarterword} \\{cc}${}\K{}$(\&{quarterword}) \|c;\7
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}>\\{mp\_pair\_type})\W(\\{mp\_type}(%
\|p)>\\{mp\_pair\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\|p,\39\NULL,\39\\{cc});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_type}(\|p)){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{cc});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|q\K\\{value\_node}(\|p);{}$\6
${}\|r\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{x\_part}(\|q),\39\\{x\_part}(\|r),\39%
\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{y\_part}(\|q),\39\\{y\_part}(\|r),\39%
\\{cc});{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{red\_part}(\|q),\39\\{red\_part}(%
\|r),\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{green\_part}(\|q),\39\\{green\_part}(%
\|r),\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{blue\_part}(\|q),\39\\{blue\_part}(%
\|r),\39\\{cc});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{cyan\_part}(\|q),\39\\{cyan\_part}(%
\|r),\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{magenta\_part}(\|q),\39\\{magenta%
\_part}(\|r),\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yellow\_part}(\|q),\39\\{yellow%
\_part}(\|r),\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{black\_part}(\|q),\39\\{black\_part}(%
\|r),\39\\{cc});{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{tx\_part}(\|q),\39\\{tx\_part}(\|r),%
\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{ty\_part}(\|q),\39\\{ty\_part}(\|r),%
\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{xx\_part}(\|q),\39\\{xx\_part}(\|r),%
\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{xy\_part}(\|q),\39\\{xy\_part}(\|r),%
\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yx\_part}(\|q),\39\\{yx\_part}(\|r),%
\39\\{cc});{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yy\_part}(\|q),\39\\{yy\_part}(\|r),%
\39\\{cc});{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_less\_than}:\5
\&{case} \\{mp\_less\_or\_equal}:\5
\&{case} \\{mp\_greater\_than}:\5
\&{case} \\{mp\_greater\_or\_equal}:\5
\&{case} \\{mp\_equal\_to}:\5
\&{case} \\{mp\_unequal\_to}:\5
\\{check\_arith}(\,);\C{ at this point \PB{\\{arith\_error}} should be \PB{%
\\{false}}? }\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}>\\{mp\_pair\_type})\W(\\{mp\_type}(%
\|p)>\\{mp\_pair\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\|p,\39\NULL,\39\\{mp\_minus}){}$;\C{ %
\PB{\\{cur\_exp}: $\K$ $(\|p)-\\{cur\_exp}$} }\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_type}(\|p)){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_from\_scaled}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_str\_vs%
\_str}(\\{mp},\39\\{value\_str}(\|p),\39\\{cur\_exp\_str}(\,)));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_unknown\_string})%
\V(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_unknown\_boolean})){}$\5
${}\{{}$\C{ Check if unknowns have been equated }\C{ When two unknown strings
are in the same ring, we know that they are          equal. Otherwise, we don't
know whether they are equal or not, so we          make no change. }\1\6
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{while} ${}((\|q\I\\{cur\_exp\_node}(\,))\W(\|q\I\|p)){}$\1\5
${}\|q\K\\{value\_node}(\|q);{}$\2\6
\&{if} ${}(\|q\E\|p){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_cur\_exp\_node}(\NULL);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\Z\\{mp\_pair\_type})\W(%
\\{mp}\MG\\{cur\_exp}.\\{type}\G\\{mp\_transform\_type})){}$\5
${}\{{}$\C{ Reduce comparison of big nodes to comparison of scalars }\C{ In the
following, the \PB{\&{while}} loops exist just so that \PB{\&{break}} can be
used,          each loop runs exactly once. }\1\6
\&{quarterword} \\{part\_type};\7
${}\|q\K\\{value\_node}(\|p);{}$\6
${}\|r\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
${}\\{part\_type}\K\T{0};{}$\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\6
\&{while} ${}(\\{part\_type}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{rr}\K\\{x\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_x\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{x\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{y\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_y\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{y\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
${}\\{mp\_take\_part}(\\{mp},\39\\{part\_type});{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\6
\&{while} ${}(\\{part\_type}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{rr}\K\\{red\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_red\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{red\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{green\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_green\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{green\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{blue\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_blue\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{blue\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
${}\\{mp\_take\_part}(\\{mp},\39\\{part\_type});{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\6
\&{while} ${}(\\{part\_type}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{rr}\K\\{cyan\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_cyan\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{cyan\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{magenta\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_magenta\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{magenta\_part}(\|q),\39\\{rr},\39%
\\{mp\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{yellow\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_yellow\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yellow\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{black\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_black\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{black\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
${}\\{mp\_take\_part}(\\{mp},\39\\{part\_type});{}$\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\6
\&{while} ${}(\\{part\_type}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{rr}\K\\{tx\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_x\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{tx\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{ty\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_y\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{ty\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{xx\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_xx\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{xx\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{xy\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_xy\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{xy\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{yx\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_yx\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yx\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
${}\\{rr}\K\\{yy\_part}(\|r);{}$\6
${}\\{part\_type}\K\\{mp\_yy\_part};{}$\6
${}\\{mp\_add\_or\_subtract}(\\{mp},\39\\{yy\_part}(\|q),\39\\{rr},\39\\{mp%
\_minus});{}$\6
\&{if} ${}(\\{mp\_type}(\\{rr})\I\\{mp\_known}\V\R\\{number\_zero}(\\{value%
\_number}(\\{rr}))){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
${}\\{mp\_take\_part}(\\{mp},\39\\{part\_type});{}$\6
\&{break};\6
\4\&{default}:\5
\\{assert}(\T{0});\C{ todo: \PB{$\\{mp}\MG\\{cur\_exp}.\\{type}>\\{mp%
\_transform\_node\_type}$} ? }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_boolean\_type}){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{number\_to%
\_scaled}(\\{cur\_exp\_value\_number}(\,))-\\{number\_to\_scaled}(\\{value%
\_number}(\|p)));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\&{goto} \.{DONE};\6
\4${}\}{}$\C{ Compare the current expression with zero }\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Oh\ dear.\ I\ can\\'t\ d}\)\.{ecide%
\ if\ the\ express}\)\.{ion\ above\ is\ positiv}\)\.{e,"},\39\.{"negative,\ or\
zero.\ }\)\.{So\ this\ comparison\ t}\)\.{est\ won't\ be\ `true'.}\)\.{"},\39%
\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_disp\_err}(\\{mp},\39\|p);{}$\6
${}\\{hlp}[\T{0}]\K\.{"The\ quantities\ show}\)\.{n\ above\ have\ not\ bee}\)%
\.{n\ equated."};{}$\6
${}\\{hlp}[\T{1}]\K\NULL;{}$\6
\4${}\}{}$\2\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_from\_boolean}(\\{new\_expr}.\\{data}.\|n,\39\\{mp\_false%
\_code});{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Unknown\ relation\ wi}\)\.{ll\ be\
considered\ fal}\)\.{se"},\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_less\_than}:\5
\\{boolean\_reset}(\\{number\_negative}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_less\_or\_equal}:\5
\\{boolean\_reset}(\\{number\_nonpositive}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_greater\_than}:\5
\\{boolean\_reset}(\\{number\_positive}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_greater\_or\_equal}:\5
\\{boolean\_reset}(\\{number\_nonnegative}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_equal\_to}:\5
\\{boolean\_reset}(\\{number\_zero}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4\&{case} \\{mp\_unequal\_to}:\5
\\{boolean\_reset}(\\{number\_nonzero}(\\{cur\_exp\_value\_number}(\,)));\6
\&{break};\6
\4${}\}{}$\2\6
;\C{ there are no other cases }\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_boolean\_type};{}$\6
\4\.{DONE}:\5
${}\\{mp}\MG\\{arith\_error}\K\\{false}{}$;\C{ ignore overflow in comparisons }%
\6
\&{break};\6
\4\&{case} \\{mp\_and\_op}:\5
\&{case} \\{mp\_or\_op}:\C{ Here we use the sneaky fact that \PB{$\\{and\_op}-%
\\{false\_code}\K\\{or\_op}-\\{true\_code}$} }\6
\&{if} ${}((\\{mp\_type}(\|p)\I\\{mp\_boolean\_type})\V(\\{mp}\MG\\{cur\_exp}.%
\\{type}\I\\{mp\_boolean\_type})){}$\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\2\6
\&{else} \&{if} ${}(\\{number\_to\_boolean}(\|p\MG\\{data}.\|n)\E\|c+\\{mp%
\_false\_code}-\\{mp\_and\_op}){}$\5
${}\{{}$\1\6
${}\\{set\_cur\_exp\_value\_boolean}(\\{number\_to\_boolean}(\|p\MG\\{data}.%
\|n));{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_times}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}<\\{mp\_color\_type})\V(\\{mp\_type}(%
\|p)<\\{mp\_color\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_times});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known})\V(\\{mp%
\_type}(\|p)\E\\{mp\_known})){}$\5
${}\{{}$\C{ Multiply when at least one operand is known }\1\6
\&{mp\_number} \\{vv};\7
\\{new\_fraction}(\\{vv});\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\|p));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vv},\39\\{cur\_exp\_value\_number}(\,));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39\\{cur\_exp\_value\_number}(\,),\39\\{vv});{}$\6
\\{set\_cur\_exp\_value\_number}(\\{ret});\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{x\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{y\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{red\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{green\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{blue\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$%
\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{cyan\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{magenta\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{yellow\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{black\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{vv},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39\NULL,\39\\{vv},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{vv});\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp\_nice\_color\_or\_pair}(\\{mp},\39\|p,\39\\{mp%
\_type}(\|p))\W(\\{mp}\MG\\{cur\_exp}.\\{type}>\\{mp\_pair\_type}))\V(\\{mp%
\_nice\_color\_or\_pair}(\\{mp},\39\\{cur\_exp\_node}(\,),\39\\{mp}\MG\\{cur%
\_exp}.\\{type})\W(\\{mp\_type}(\|p)>\\{mp\_pair\_type}))){}$\5
${}\{{}$\1\6
${}\\{mp\_hard\_times}(\\{mp},\39\|p);{}$\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_times});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_over}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known})\V(\\{mp\_type}(\|p)<%
\\{mp\_color\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_over});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{v\_n};\7
\\{new\_number}(\\{v\_n});\6
${}\\{number\_clone}(\\{v\_n},\39\\{cur\_exp\_value\_number}(\,));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\&{if} (\\{number\_zero}(\\{v\_n}))\5
${}\{{}$\C{ Squeal about division by zero }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You're\ trying\ to\ di}\)\.{vide\
the\ quantity\ sh}\)\.{own\ above\ the\ error"},\39\.{"message\ by\ zero.\ I'}%
\)\.{m\ going\ to\ divide\ it}\)\.{\ by\ one\ instead."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Division\ by\ zero"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\\{cur\_exp\_value\_number}(\,),\39\\{v\_n});{}$%
\6
\\{set\_cur\_exp\_value\_number}(\\{ret});\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{x\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{y\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{red\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{green\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{blue\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$%
\5
${}\{{}$\1\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{cyan\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{magenta\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{yellow\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
${}\\{mp\_dep\_div}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{black\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\\{v\_n});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_dep\_div}(\\{mp},\39\NULL,\39\\{v\_n});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{v\_n});\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_pythag\_add}:\5
\&{case} \\{mp\_pythag\_sub}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known})\W(\\{mp\_type}(\|p)%
\E\\{mp\_known})){}$\5
${}\{{}$\1\6
\&{mp\_number} \|r;\7
\\{new\_number}(\|r);\6
\&{if} ${}(\|c\E\\{mp\_pythag\_add}){}$\5
${}\{{}$\1\6
${}\\{pyth\_add}(\|r,\39\\{value\_number}(\|p),\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{pyth\_sub}(\|r,\39\\{value\_number}(\|p),\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\4${}\}{}$\2\6
\\{set\_cur\_exp\_value\_number}(\|r);\6
\\{free\_number}(\|r);\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\2\6
\&{break};\6
\4\&{case} \\{mp\_rotated\_by}:\5
\&{case} \\{mp\_slanted\_by}:\5
\&{case} \\{mp\_scaled\_by}:\5
\&{case} \\{mp\_shifted\_by}:\5
\&{case} \\{mp\_transformed\_by}:\5
\&{case} \\{mp\_x\_scaled}:\5
\&{case} \\{mp\_y\_scaled}:\5
\&{case} \\{mp\_z\_scaled}:\C{ The next few sections of the program deal with
affine transformations     of coordinate data. }\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
\\{path\_trans}((\&{quarterword}) \|c${},\39\|p);{}$\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_pen\_type}){}$\5
${}\{{}$\1\6
\\{pen\_trans}((\&{quarterword}) \|c${},\39\|p);{}$\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_convex\_hull}(\\{mp},\39\\{cur\_exp\_knot}(%
\,))){}$;\C{ rounding error could destroy convexity }\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{mp\_type}(\|p)\E\\{mp\_pair\_type})\V(\\{mp\_type}(\|p)%
\E\\{mp\_transform\_type})){}$\5
${}\{{}$\1\6
${}\\{mp\_big\_trans}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_do\_edges\_trans}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_concatenate}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_string\_type})\W(\\{mp%
\_type}(\|p)\E\\{mp\_string\_type})){}$\5
${}\{{}$\1\6
\&{mp\_string} \\{str}${}\K\\{mp\_cat}(\\{mp},\39\\{value\_str}(\|p),\39\\{cur%
\_exp\_str}(\,));{}$\7
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\\{set\_cur\_exp\_str}(\\{str});\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_concatenate});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_substring\_of}:\6
\&{if} ${}(\\{mp\_nice\_pair}(\\{mp},\39\|p,\39\\{mp\_type}(\|p))\W(\\{mp}\MG%
\\{cur\_exp}.\\{type}\E\\{mp\_string\_type})){}$\5
${}\{{}$\1\6
\&{mp\_string} \\{str}${}\K\\{mp\_chop\_string}(\\{mp},\39\\{cur\_exp\_str}(%
\,),\39\\{round\_unscaled}(\\{value\_number}(\\{x\_part}(\\{value\_node}(%
\|p)))),\39\\{round\_unscaled}(\\{value\_number}(\\{y\_part}(\\{value\_node}(%
\|p)))));{}$\7
\\{delete\_str\_ref}(\\{cur\_exp\_str}(\,));\6
\\{set\_cur\_exp\_str}(\\{str});\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_substring\_of});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_subpath\_of}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}(\\{mp\_nice\_pair}(\\{mp},\39\|p,\39\\{mp\_type}(\|p))\W(\\{mp}\MG%
\\{cur\_exp}.\\{type}\E\\{mp\_path\_type})){}$\1\5
${}\\{mp\_chop\_path}(\\{mp},\39\\{value\_node}(\|p));{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_subpath\_of});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_point\_of}:\5
\&{case} \\{mp\_precontrol\_of}:\5
\&{case} \\{mp\_postcontrol\_of}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type})\W(\\{mp\_type}(%
\|p)\E\\{mp\_known})){}$\1\5
${}\\{mp\_find\_point}(\\{mp},\39\\{value\_number}(\|p),\39{}$(\&{quarterword})
\|c);\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\2\6
\&{break};\6
\4\&{case} \\{mp\_pen\_offset\_of}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pen\_type})\W\\{mp\_nice%
\_pair}(\\{mp},\39\|p,\39\\{mp\_type}(\|p))){}$\1\5
${}\\{mp\_set\_up\_offset}(\\{mp},\39\\{value\_node}(\|p));{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_pen\_offset\_of});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_direction\_time\_of}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type})\W\\{mp\_nice%
\_pair}(\\{mp},\39\|p,\39\\{mp\_type}(\|p))){}$\1\5
${}\\{mp\_set\_up\_direction\_time}(\\{mp},\39\\{value\_node}(\|p));{}$\2\6
\&{else}\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_direction\_time\_of});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_envelope\_of}:\6
\&{if} ${}((\\{mp\_type}(\|p)\I\\{mp\_pen\_type})\V(\\{mp}\MG\\{cur\_exp}.%
\\{type}\I\\{mp\_path\_type})){}$\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_envelope\_of});{}$\2\6
\&{else}\1\5
${}\\{mp\_set\_up\_envelope}(\\{mp},\39\|p);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_glyph\_infont}:\6
\&{if} ${}((\\{mp\_type}(\|p)\I\\{mp\_string\_type}\W\\{mp\_type}(\|p)\I\\{mp%
\_known})\V(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type})){}$\1\5
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_glyph\_infont});{}$\2\6
\&{else}\1\5
${}\\{mp\_set\_up\_glyph\_infont}(\\{mp},\39\|p);{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_arc\_time\_of}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type})\W(\\{mp\_type}(%
\|p)\E\\{mp\_known})){}$\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_get\_arc\_time}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n,\39\\{cur%
\_exp\_knot}(\,),\39\\{value\_number}(\|p));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|c);\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_intersect}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\\{mp\_pair\_to\_path}(\\{mp});\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|q);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_path\_type})\W(\\{mp\_type}(%
\|p)\E\\{mp\_path\_type})){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{mp\_path\_intersection}(\\{mp},\39\\{value\_knot}(\|p),\39\\{cur\_exp%
\_knot}(\,));{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{mp}\MG\\{cur\_t});{}$\6
${}\\{number\_clone}(\\{arg2},\39\\{mp}\MG\\{cur\_tt});{}$\6
${}\\{mp\_pair\_value}(\\{mp},\39\\{arg1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_intersect});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_in\_font}:\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type})\V\\{mp%
\_type}(\|p)\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bad\_binary}(\\{mp},\39\|p,\39\\{mp\_in\_font});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_do\_infont}(\\{mp},\39\|p);{}$\6
\\{binary\_return};\6
\4${}\}{}$\2\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p){}$;\C{ \PB{\&{return}} to avoid
this }\6
${}\\{mp\_finish\_binary}(\\{mp},\39\\{old\_p},\39\\{old\_exp});{}$\6
\4${}\}{}$\2\par
\fi

\M{989}\B\X989:Declare binary action procedures\X${}\E{}$\6
\&{static} \&{void} \\{mp\_bad\_binary}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ afraid\ I\ don't\ }\)\.{know\
how\ to\ apply\ th}\)\.{at\ operation\ to\ that}\)\.{"},\39\.{"combination\ of\
type}\)\.{s.\ Continue,\ and\ I'l}\)\.{l\ return\ the\ second"},\39\.{"argument%
\ (see\ above}\)\.{)\ as\ the\ result\ of\ t}\)\.{he\ operation."},\39\NULL%
\};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
\&{if} ${}(\|c\G\\{mp\_min\_of}){}$\1\5
${}\\{mp\_print\_op}(\\{mp},\39\|c);{}$\2\6
${}\\{mp\_print\_known\_or\_unknown\_type}(\\{mp},\39\\{mp\_type}(\|p),\39%
\|p);{}$\6
\&{if} ${}(\|c\G\\{mp\_min\_of}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"of"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print\_op}(\\{mp},\39\|c);{}$\2\6
${}\\{mp\_print\_known\_or\_unknown\_type}(\\{mp},\39\\{mp}\MG\\{cur\_exp}.%
\\{type},\39\\{cur\_exp\_node}(\,));{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Not\ implemented:\ \%s}\)\.{"},%
\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
;\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_disp\_err}(\\{mp},\39\|p);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_bad\_envelope\_pen}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ afraid\ I\ don't\ }\)\.{know\
how\ to\ apply\ th}\)\.{at\ operation\ to\ that}\)\.{"},\39\.{"combination\ of\
type}\)\.{s.\ Continue,\ and\ I'l}\)\.{l\ return\ the\ second"},\39\.{"argument%
\ (see\ above}\)\.{)\ as\ the\ result\ of\ t}\)\.{he\ operation."},\39\NULL%
\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ implemented:\ en}\)%
\.{velope(elliptical\ pe}\)\.{n)of(path)"},\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\As990, 991, 993, 996, 997, 998, 1005, 1006, 1007, 1008, 1009, 1019, 1027,
1028, 1029, 1030\ETs1031.
\U988.\fi

\M{990}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{mp\_tarnished}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ beginning of the big node }\6
\&{mp\_node} \|r;\C{ moving value node pointer }\7
(\&{void}) \\{mp};\6
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{switch} (\\{mp\_type}(\|p))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\|r\K\\{x\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{y\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\|r\K\\{red\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{green\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{blue\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\|r\K\\{cyan\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{magenta\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{yellow\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{black\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\|r\K\\{tx\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{ty\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{xx\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{xy\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{yx\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
${}\|r\K\\{yy\_part}(\|q);{}$\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_independent}){}$\1\5
\&{return} \.{MP\_VOID};\2\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\par
\fi

\M{991}The first argument to \PB{\\{add\_or\_subtract}} is the location of a
value node
in a capsule or pair node that will soon be recycled. The second argument
is either a location within a pair or transform node of \PB{\\{cur\_exp}},
or it is NULL (which means that \PB{\\{cur\_exp}} itself should be the second
argument).  The third argument is either \PB{\\{plus}} or \PB{\\{minus}}.

The sum or difference of the numeric quantities will replace the second
operand.  Arithmetic overflow may go undetected; users aren't supposed to
be monkeying around with really big values.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\X992:Declare the procedure called \PB{\\{dep\_finish}}\X;\7
\&{static} \&{void} \\{mp\_add\_or\_subtract}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{mp\_node} \|q${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_variable\_type}\|s,\39\|t{}$;\C{ operand types }\7
\&{mp\_value\_node} \|r;\C{ dependency list traverser }\6
\&{mp\_value\_node} \|v${}\K\NULL{}$;\C{ second operand value for dep lists }\6
\&{mp\_number} \\{vv};\C{ second operand value for known values }\7
\\{new\_number}(\\{vv});\6
\&{if} ${}(\|q\E\NULL){}$\5
${}\{{}$\1\6
${}\|t\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
\&{if} ${}(\|t<\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\\{vv},\39\\{cur\_exp\_value\_number}(\,));{}$\2\6
\&{else}\1\5
${}\|v\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \\{cur%
\_exp\_node}(\,));\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|t\K\\{mp\_type}(\|q);{}$\6
\&{if} ${}(\|t<\\{mp\_dependent}){}$\1\5
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\|q));{}$\2\6
\&{else}\1\5
${}\|v\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|q);\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|t\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_value\_node} \\{qq}${}\K{}$(\&{mp\_value\_node}) \|q;\7
\&{if} ${}(\|c\E\\{mp\_minus}){}$\1\5
\\{number\_negate}(\\{vv});\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{slow\_add}(\\{vv},\39\\{value\_number}(\|p),\39\\{vv});{}$\6
\&{if} ${}(\|q\E\NULL){}$\1\5
\\{set\_cur\_exp\_value\_number}(\\{vv});\2\6
\&{else}\1\5
${}\\{set\_value\_number}(\|q,\39\\{vv});{}$\2\6
\\{free\_number}(\\{vv});\6
\&{return};\6
\4${}\}{}$\C{ Add a known value to the constant term of \PB{\\{dep\_list}(\|p)}
}\2\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p);\6
\&{while} ${}(\\{dep\_info}(\|r)\I\NULL){}$\1\5
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\2\6
${}\\{slow\_add}(\\{vv},\39\\{dep\_value}(\|r),\39\\{vv});{}$\6
${}\\{set\_dep\_value}(\|r,\39\\{vv});{}$\6
\&{if} ${}(\\{qq}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{qq}\K\\{mp\_get\_dep\_node}(\\{mp});{}$\6
\\{set\_cur\_exp\_node}((\&{mp\_node}) \\{qq});\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_type}(\|p);{}$\6
${}\\{mp\_name\_type}(\\{qq})\K\\{mp\_capsule}{}$;\C{ clang: never read: q =
(mp\_node) qq; }\6
\4${}\}{}$\2\6
${}\\{set\_dep\_list}(\\{qq},\39{}$\\{dep\_list}((\&{mp\_value\_node}) \|p));\6
${}\\{mp\_type}(\\{qq})\K\\{mp\_type}(\|p);{}$\6
${}\\{set\_prev\_dep}(\\{qq},\39{}$\\{prev\_dep}((\&{mp\_value\_node}) \|p));\6
\\{mp\_link}(\\{prev\_dep}((\&{mp\_value\_node}) \|p))${}\K{}$(\&{mp\_node}) %
\\{qq};\6
${}\\{mp\_type}(\|p)\K\\{mp\_known}{}$;\C{ this will keep the recycler from
collecting non-garbage }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|c\E\\{mp\_minus}){}$\1\5
${}\\{mp\_negate\_dep\_list}(\\{mp},\39\|v){}$;\C{ Add operand \PB{\|p} to the
dependency list \PB{\|v} }\C{ We prefer \PB{\\{dependent}} lists to \PB{\\{mp%
\_proto\_dependent}} ones, because it is        nice to retain the extra
accuracy of \PB{\\{fraction}} coefficients.        But we have to handle both
kinds, and mixtures too. }\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\C{ Add the known \PB{\\{value}(\|p)} to the constant term of \PB{\|v}
}\1\6
\&{while} ${}(\\{dep\_info}(\|v)\I\NULL){}$\5
${}\{{}$\1\6
${}\|v\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|v);\6
\4${}\}{}$\2\6
${}\\{slow\_add}(\\{vv},\39\\{value\_number}(\|p),\39\\{dep\_value}(\|v));{}$\6
${}\\{set\_dep\_value}(\|v,\39\\{vv});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|s\K\\{mp\_type}(\|p);{}$\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p);\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|s\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret1}${},{}$ \\{ret2};\7
\\{new\_fraction}(\\{ret1});\6
\\{new\_fraction}(\\{ret2});\6
${}\\{mp\_max\_coef}(\\{mp},\39{\AND}\\{ret1},\39\|r);{}$\6
${}\\{mp\_max\_coef}(\\{mp},\39{\AND}\\{ret2},\39\|v);{}$\6
${}\\{number\_add}(\\{ret1},\39\\{ret2});{}$\6
\\{free\_number}(\\{ret2});\6
\&{if} ${}(\\{number\_less}(\\{ret1},\39\\{coef\_bound\_k})){}$\5
${}\{{}$\1\6
${}\|v\K\\{mp\_p\_plus\_q}(\\{mp},\39\|v,\39\|r,\39\\{mp\_dependent});{}$\6
\\{free\_number}(\\{ret1});\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ret1});\6
\4${}\}{}$\C{ \PB{\\{fix\_needed}} will necessarily be false }\2\6
${}\|t\K\\{mp\_proto\_dependent};{}$\6
${}\|v\K\\{mp\_p\_over\_v}(\\{mp},\39\|v,\39\\{unity\_t},\39\\{mp\_dependent},%
\39\\{mp\_proto\_dependent});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|s\E\\{mp\_proto\_dependent}){}$\1\5
${}\|v\K\\{mp\_p\_plus\_q}(\\{mp},\39\|v,\39\|r,\39\\{mp\_proto%
\_dependent});{}$\2\6
\&{else}\1\5
${}\|v\K\\{mp\_p\_plus\_fq}(\\{mp},\39\|v,\39\\{unity\_t},\39\|r,\39\\{mp%
\_proto\_dependent},\39\\{mp\_dependent});{}$\2\6
\4\.{DONE}:\C{ Output the answer, \PB{\|v} (which might have become \PB{%
\\{known}}) }\6
\&{if} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_finish}(\\{mp},\39\|v,\39{}$(\&{mp\_value\_node}) \|q${},\39%
\|t);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\|t;{}$\6
${}\\{mp\_dep\_finish}(\\{mp},\39\|v,\39\NULL,\39\|t);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{vv});\6
\4${}\}{}$\2\par
\fi

\M{992}Here's the current situation: The dependency list \PB{\|v} of type \PB{%
\|t}
should either be put into the current expression (if \PB{$\|q\K\NULL$}) or
into location \PB{\|q} within a pair node (otherwise). The destination (\PB{%
\\{cur\_exp}}
or \PB{\|q}) formerly held a dependency list with the same
final pointer as the list \PB{\|v}.

\Y\B\4\X992:Declare the procedure called \PB{\\{dep\_finish}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_dep\_finish}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|v${},\39{}$\&{mp\_value\_node} \|q${},\39{}$\&{quarterword} \|t)\1\1%
\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p;\C{ the destination }\7
\&{if} ${}(\|q\E\NULL){}$\1\5
${}\|p\K{}$(\&{mp\_value\_node}) \\{cur\_exp\_node}(\,);\2\6
\&{else}\1\5
${}\|p\K\|q;{}$\2\6
${}\\{set\_dep\_list}(\|p,\39\|v);{}$\6
${}\\{mp\_type}(\|p)\K\|t;{}$\6
\&{if} ${}(\\{dep\_info}(\|v)\E\NULL){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{vv};\C{ the value, if it is \PB{\\{known}} }\7
\\{new\_number}(\\{vv});\6
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\|v));{}$\6
\&{if} ${}(\|q\E\NULL){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\\{vv});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39{}$(\&{mp\_node}) \|p);\6
${}\\{mp\_type}(\|q)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|q,\39\\{vv});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{vv});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|q\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\|t;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{fix\_needed}){}$\1\5
\\{mp\_fix\_dependencies}(\\{mp});\2\6
\4${}\}{}$\2\par
\U991.\fi

\M{993}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_dep\_mult}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_number} \|v${},\39{}$\&{boolean} \\{v\_is\_scaled})%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ the dependency list being multiplied by \PB{\|v} }\6
\&{quarterword} \|s${},{}$ \|t;\C{ its type, before and after }\7
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{cur\_exp\_node}(\,);\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\|q\K\|p;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{dep\_value}(\|p));{}$\6
\&{if} (\\{v\_is\_scaled})\5
${}\{{}$\1\6
\\{new\_number}(\\{r1});\6
${}\\{take\_scaled}(\\{r1},\39\\{arg1},\39\|v);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{new\_fraction}(\\{r1});\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\|v);{}$\6
\4${}\}{}$\2\6
${}\\{set\_dep\_value}(\|p,\39\\{r1});{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{return};\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_type}(\|q);{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\|q);\6
${}\|s\K\|t;{}$\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
\&{if} (\\{v\_is\_scaled})\5
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{new\_number}(\\{arg2});\6
\\{new\_fraction}(\\{arg1});\6
${}\\{mp\_max\_coef}(\\{mp},\39{\AND}\\{arg1},\39\|q);{}$\6
${}\\{number\_clone}(\\{arg2},\39\|v);{}$\6
\\{number\_abs}(\\{arg2});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{arg2},\39\\{coef\_bound%
\_minus\_1},\39\\{unity\_t});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\&{if} (\\{number\_nonnegative}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
${}\|t\K\\{mp\_proto\_dependent};{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_p\_times\_v}(\\{mp},\39\|q,\39\|v,\39\|s,\39\|t,\39\\{v\_is%
\_scaled});{}$\6
${}\\{mp\_dep\_finish}(\\{mp},\39\|q,\39\|p,\39\|t);{}$\6
\4${}\}{}$\2\par
\fi

\M{994}Here is a routine that is similar to \PB{\\{times}}; but it is invoked
only
internally, when \PB{\|v} is a \PB{\\{fraction}} whose magnitude is at most~1,
and when \PB{$\\{cur\_type}\G\\{mp\_color\_type}$}.

\Y\B\&{static} \&{void} \\{mp\_frac\_mult}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|n${},\39{}$\&{mp\_number} \|d)\1\1\2\2\6
${}\{{}$\C{ multiplies \PB{\\{cur\_exp}} by \PB{$\|n/\|d$} }\1\6
\&{mp\_node} \\{old\_exp};\C{ a capsule to recycle }\6
\&{mp\_number} \|v;\C{ \PB{$\|n/\|d$} }\7
\\{new\_fraction}(\|v);\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\5
${}\{{}$\1\6
\X995:Trace the fraction multiplication\X;\6
\4${}\}{}$\2\6
\&{switch} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}){}$\5
${}\{{}$\1\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\5
${}\\{old\_exp}\K\\{mp\_tarnished}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\&{break};\6
\4\&{case} \\{mp\_independent}:\5
${}\\{old\_exp}\K\.{MP\_VOID};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{old\_exp}\K\NULL;{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{old\_exp}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{old\_exp}\K\\{cur\_exp\_node}(\,);{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\\{old\_exp});{}$\6
\4${}\}{}$\2\6
${}\\{make\_fraction}(\|v,\39\|n,\39\|d);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{arg1};\7
\\{new\_fraction}(\\{r1});\6
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{cur\_exp\_value\_number}(\,));{}$\6
${}\\{take\_fraction}(\\{r1},\39\\{arg1},\39\|v);{}$\6
\\{set\_cur\_exp\_value\_number}(\\{r1});\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{x\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{y\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{red\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{green\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{blue\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$%
\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{cyan\_part}(\\{value%
\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{magenta\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{yellow\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{black\_part}(%
\\{value\_node}(\\{cur\_exp\_node}(\,)))${},\39\|v,\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39\NULL,\39\|v,\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{old\_exp}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{old\_exp});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{old\_exp});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|v);\6
\4${}\}{}$\2\par
\fi

\M{995}\B\X995:Trace the fraction multiplication\X${}\E{}$\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{("});{}$\6
\\{print\_number}(\|n);\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'/'}));{}$\6
\\{print\_number}(\|d);\6
${}\\{mp\_print}(\\{mp},\39\.{")*("});{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{0});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{")\}"});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\par
\U994.\fi

\M{996}The \PB{\\{hard\_times}} routine multiplies a nice color or pair by a
dependency list.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_hard\_times}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ a copy of the dependent variable \PB{\|p} }\6
\&{mp\_value\_node} \\{pp};\C{ for typecasting p }\6
\&{mp\_node} \|r;\C{ a component of the big node for the nice color or pair }\6
\&{mp\_number} \|v;\C{ the known value for \PB{\|r} }\7
\\{new\_number}(\|v);\6
\&{if} ${}(\\{mp\_type}(\|p)\Z\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_stash\_cur\_exp}(\\{mp});\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
${}\|p\K{}$(\&{mp\_node}) \|q;\6
\4${}\}{}$\C{ now \PB{$\\{cur\_type}\K\\{mp\_pair\_type}$} or \PB{$\\{cur%
\_type}\K\\{mp\_color\_type}$} or \PB{$\\{cur\_type}\K\\{mp\_cmykcolor\_type}$}
}\2\6
${}\\{pp}\K{}$(\&{mp\_value\_node}) \|p;\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\|r\K\\{x\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{y\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\5
${}\{{}$\1\6
${}\|r\K\\{red\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{green\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{blue\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$%
\5
${}\{{}$\1\6
${}\|r\K\\{cyan\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{yellow\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{magenta\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
${}\|r\K\\{black\_part}(\\{value\_node}(\\{cur\_exp\_node}(\,)));{}$\6
${}\\{number\_clone}(\|v,\39\\{value\_number}(\|r));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|r,\39\\{mp\_type}(\\{pp}),\39\\{mp\_copy\_dep%
\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{pp})));\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|r${},\39\|v,\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|v);\6
\4${}\}{}$\2\par
\fi

\M{997}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_dep\_div}(\&{MP} \\{mp}${},\39{}$\&{mp\_value\_node}
\|p${},\39{}$\&{mp\_number} \|v)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|q;\C{ the dependency list being divided by \PB{\|v} }\6
\&{quarterword} \|s${},{}$ \|t;\C{ its type, before and after }\7
\&{if} ${}(\|p\E\NULL){}$\1\5
${}\|q\K{}$(\&{mp\_value\_node}) \\{cur\_exp\_node}(\,);\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_known}){}$\1\5
${}\|q\K\|p;{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{make\_scaled}(\\{ret},\39\\{value\_number}(\|p),\39\|v);{}$\6
${}\\{set\_value\_number}(\|p,\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\&{return};\6
\4${}\}{}$\2\6
${}\|t\K\\{mp\_type}(\|q);{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\|q);\6
${}\|s\K\|t;{}$\6
\&{if} ${}(\|t\E\\{mp\_dependent}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ab\_vs\_cd};\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{ab\_vs\_cd});\6
\\{new\_number}(\\{arg2});\6
\\{new\_fraction}(\\{arg1});\6
${}\\{mp\_max\_coef}(\\{mp},\39{\AND}\\{arg1},\39\|q);{}$\6
${}\\{number\_clone}(\\{arg2},\39\|v);{}$\6
\\{number\_abs}(\\{arg2});\6
${}\\{ab\_vs\_cd}(\\{ab\_vs\_cd},\39\\{arg1},\39\\{unity\_t},\39\\{coef\_bound%
\_minus\_1},\39\\{arg2});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\&{if} (\\{number\_nonnegative}(\\{ab\_vs\_cd}))\5
${}\{{}$\1\6
${}\|t\K\\{mp\_proto\_dependent};{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ab\_vs\_cd});\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_p\_over\_v}(\\{mp},\39\|q,\39\|v,\39\|s,\39\|t);{}$\6
${}\\{mp\_dep\_finish}(\\{mp},\39\|q,\39\|p,\39\|t);{}$\6
\4${}\}{}$\2\par
\fi

\M{998}Let \PB{\|c} be one of the eight transform operators. The procedure call
\PB{\\{set\_up\_trans}(\|c)} first changes \PB{\\{cur\_exp}} to a transform
that corresponds to
\PB{\|c} and the original value of \PB{\\{cur\_exp}}. (In particular, \PB{%
\\{cur\_exp}} doesn't
change at all if \PB{$\|c\K\\{transformed\_by}$}.)

Then, if all components of the resulting transform are \PB{\\{known}}, they are
moved to the global variables \PB{\\{txx}}, \PB{\\{txy}}, \PB{\\{tyx}}, \PB{%
\\{tyy}}, \PB{\\{tx}}, \PB{\\{ty}};
and \PB{\\{cur\_exp}} is changed to the known value zero.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_up\_trans}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ list manipulation registers }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
\&{if} ${}((\|c\I\\{mp\_transformed\_by})\V(\\{mp}\MG\\{cur\_exp}.\\{type}\I%
\\{mp\_transform\_type})){}$\5
${}\{{}$\C{ Put the current transform into \PB{\\{cur\_exp}} }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ expression\ show}\)\.{n\ above%
\ has\ the\ wron}\)\.{g\ type,"},\39\.{"so\ I\ can\\'t\ transfo}\)\.{rm\
anything\ using\ it}\)\.{."},\39\.{"Proceed,\ and\ I'll\ o}\)\.{mit\ the\
transformati}\)\.{on."},\39\NULL\};{}$\7
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{set\_cur\_exp\_node}(\\{mp\_id\_transform}(\\{mp}));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_transform\_type};{}$\6
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\X1002:For each of the eight cases, change the relevant fields of \PB{\\{cur%
\_exp}} and \PB{\&{goto} \\{done}}; but do nothing if capsule \PB{\|p} doesn't
have the appropriate type\X;\6
\4${}\}{}$\2\6
;\C{ there are no other cases }\6
${}\\{mp\_disp\_err}(\\{mp},\39\|p);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ transforma}\)\.{tion\
argument"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4\.{DONE}:\5
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\C{ If the current transform is entirely known, stash it in global
variables;     otherwise \PB{\&{return}} }\2\6
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp\_type}(\\{tx\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp\_type}(\\{ty\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp\_type}(\\{xx\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp\_type}(\\{xy\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp\_type}(\\{yx\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mp\_type}(\\{yy\_part}(\|q))\I\\{mp\_known}){}$\1\5
\&{return};\2\6
${}\\{number\_clone}(\\{mp}\MG\\{txx},\39\\{value\_number}(\\{xx\_part}(%
\|q)));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{txy},\39\\{value\_number}(\\{xy\_part}(%
\|q)));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{tyx},\39\\{value\_number}(\\{yx\_part}(%
\|q)));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{tyy},\39\\{value\_number}(\\{yy\_part}(%
\|q)));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{tx},\39\\{value\_number}(\\{tx\_part}(%
\|q)));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{ty},\39\\{value\_number}(\\{ty\_part}(%
\|q)));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{999}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{txx};\6
\&{mp\_number} \\{txy};\6
\&{mp\_number} \\{tyx};\6
\&{mp\_number} \\{tyy};\6
\&{mp\_number} \\{tx};\6
\&{mp\_number} \\{ty};\C{ current transform coefficients }\par
\fi

\M{1000}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{txx});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{txy});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{tyx});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{tyy});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{tx});{}$\6
${}\\{new\_number}(\\{mp}\MG\\{ty}){}$;\par
\fi

\M{1001}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{txx});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{txy});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{tyx});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{tyy});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{tx});{}$\6
${}\\{free\_number}(\\{mp}\MG\\{ty}){}$;\par
\fi

\M{1002}\B\X1002:For each of the eight cases, change the relevant fields of %
\PB{\\{cur\_exp}} and \PB{\&{goto} \\{done}}; but do nothing if capsule \PB{%
\|p} doesn't have the appropriate type\X${}\E{}$\6
\4\&{case} \\{mp\_rotated\_by}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\1\5
\X1003:Install sines and cosines, then \PB{\&{goto} \\{done}}\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_slanted\_by}:\6
\&{if} ${}(\\{mp\_type}(\|p)>\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_install}(\\{mp},\39\\{xy\_part}(\|q),\39\|p);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_scaled\_by}:\6
\&{if} ${}(\\{mp\_type}(\|p)>\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_install}(\\{mp},\39\\{xx\_part}(\|q),\39\|p);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yy\_part}(\|q),\39\|p);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_shifted\_by}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\|r\K\\{value\_node}(\|p);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{tx\_part}(\|q),\39\\{x\_part}(\|r));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{ty\_part}(\|q),\39\\{y\_part}(\|r));{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_x\_scaled}:\6
\&{if} ${}(\\{mp\_type}(\|p)>\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_install}(\\{mp},\39\\{xx\_part}(\|q),\39\|p);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_y\_scaled}:\6
\&{if} ${}(\\{mp\_type}(\|p)>\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_install}(\\{mp},\39\\{yy\_part}(\|q),\39\|p);{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_z\_scaled}:\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_pair\_type}){}$\1\5
\X1004:Install a complex multiplier, then \PB{\&{goto} \\{done}}\X;\2\6
\&{break};\6
\4\&{case} \\{mp\_transformed\_by}:\5
\&{break};\par
\U998.\fi

\M{1003}\B\X1003:Install sines and cosines, then \PB{\&{goto} \\{done}}\X${}%
\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{n\_sin}${},{}$ \\{n\_cos}${},{}$ \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
\\{new\_fraction}(\\{n\_sin});\6
\\{new\_fraction}(\\{n\_cos});\C{ results computed by \PB{\\{n\_sin\_cos}} }\6
${}\\{number\_clone}(\\{arg2},\39\\{unity\_t});{}$\6
${}\\{number\_clone}(\\{arg1},\39\\{value\_number}(\|p));{}$\6
${}\\{number\_multiply\_int}(\\{arg2},\39\T{360});{}$\6
${}\\{number\_modulo}(\\{arg1},\39\\{arg2});{}$\6
\\{convert\_scaled\_to\_angle}(\\{arg1});\6
${}\\{n\_sin\_cos}(\\{arg1},\39\\{n\_cos},\39\\{n\_sin});{}$\6
\\{fraction\_to\_round\_scaled}(\\{n\_sin});\6
\\{fraction\_to\_round\_scaled}(\\{n\_cos});\6
${}\\{set\_value\_number}(\\{xx\_part}(\|q),\39\\{n\_cos});{}$\6
${}\\{set\_value\_number}(\\{yx\_part}(\|q),\39\\{n\_sin});{}$\6
${}\\{set\_value\_number}(\\{xy\_part}(\|q),\39\\{value\_number}(\\{yx\_part}(%
\|q)));{}$\6
\\{number\_negate}(\\{value\_number}(\\{xy\_part}(\|q)));\6
${}\\{set\_value\_number}(\\{yy\_part}(\|q),\39\\{value\_number}(\\{xx\_part}(%
\|q)));{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
\\{free\_number}(\\{n\_sin});\6
\\{free\_number}(\\{n\_cos});\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U1002.\fi

\M{1004}\B\X1004:Install a complex multiplier, then \PB{\&{goto} \\{done}}\X${}%
\E{}$\6
${}\{{}$\1\6
${}\|r\K\\{value\_node}(\|p);{}$\6
${}\\{mp\_install}(\\{mp},\39\\{xx\_part}(\|q),\39\\{x\_part}(\|r));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yy\_part}(\|q),\39\\{x\_part}(\|r));{}$\6
${}\\{mp\_install}(\\{mp},\39\\{yx\_part}(\|q),\39\\{y\_part}(\|r));{}$\6
\&{if} ${}(\\{mp\_type}(\\{y\_part}(\|r))\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\\{y\_part}(\|r),\39\\{value\_number}(\\{y\_part}(%
\|r)));{}$\6
\\{number\_negate}(\\{value\_number}(\\{y\_part}(\|r)));\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_negate\_dep\_list}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}((%
\&{mp\_value\_node}) \\{y\_part}(\|r)));\6
\4${}\}{}$\2\6
${}\\{mp\_install}(\\{mp},\39\\{xy\_part}(\|q),\39\\{y\_part}(\|r));{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U1002.\fi

\M{1005}Procedure \PB{\\{set\_up\_known\_trans}} is like \PB{\\{set\_up%
\_trans}}, but it
insists that the transformation be entirely known.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_up\_known\_trans}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_set\_up\_trans}(\\{mp},\39\|c);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ unable\ to\ apply}\)\.{\ a\
partially\ specifi}\)\.{ed\ transformation"},\39\.{"except\ to\ a\ fully\ k}\)%
\.{nown\ pair\ or\ transfo}\)\.{rm."},\39\.{"Proceed,\ and\ I'll\ o}\)\.{mit\
the\ transformati}\)\.{on."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Transform\ component}\)\.{s\ aren't\ all\
known"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{set\_number\_to\_unity}(\\{mp}\MG\\{txx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{txy});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tyx});{}$\6
${}\\{set\_number\_to\_unity}(\\{mp}\MG\\{tyy});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ty});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1006}Here's a procedure that applies the transform \PB{$\\{txx}\MRL{{.}{.}}%
\\{ty}$} to a pair of
coordinates in locations \PB{\|p} and~\PB{\|q}.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_number\_trans}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
${}{*}\|p,\39{}$\&{mp\_number} ${}{*}\|q){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{r1}${},{}$ \\{r2}${},{}$ \|v;\7
\\{new\_number}(\\{r1});\6
\\{new\_number}(\\{r2});\6
\\{new\_number}(\|v);\6
${}\\{take\_scaled}(\\{r1},\39{*}\|p,\39\\{mp}\MG\\{txx});{}$\6
${}\\{take\_scaled}(\\{r2},\39{*}\|q,\39\\{mp}\MG\\{txy});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}(\|v,\39\\{r1},\39\\{mp}\MG\\{tx});{}$\6
${}\\{take\_scaled}(\\{r1},\39{*}\|p,\39\\{mp}\MG\\{tyx});{}$\6
${}\\{take\_scaled}(\\{r2},\39{*}\|q,\39\\{mp}\MG\\{tyy});{}$\6
${}\\{number\_add}(\\{r1},\39\\{r2});{}$\6
${}\\{set\_number\_from\_addition}({*}\|q,\39\\{r1},\39\\{mp}\MG\\{ty});{}$\6
${}\\{number\_clone}({*}\|p,\39\|v);{}$\6
\\{free\_number}(\\{r1});\6
\\{free\_number}(\\{r2});\6
\\{free\_number}(\|v);\6
\4${}\}{}$\2\par
\fi

\M{1007}The simplest transformation procedure applies a transform to all
coordinates of a path.  The \PB{\\{path\_trans}(\|c)(\|p)} macro applies
a transformation defined by \PB{\\{cur\_exp}} and the transform operator \PB{%
\|c}
to the path~\PB{\|p}.

\Y\B\4\D$\\{path\_trans}(\|A,\|B)$ \6
${}\{{}$\1\6
${}\\{mp\_set\_up\_known\_trans}(\\{mp},\39(\|A));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39(\|B));{}$\6
${}\\{mp\_do\_path\_trans}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\4${}\}{}$\2\par
\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_path\_trans}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot}
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ list traverser }\7
${}\|q\K\|p;{}$\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|q)\I\\{mp\_endpoint}){}$\1\5
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|q\MG\\{left\_x},\39{\AND}\|q\MG%
\\{left\_y});{}$\2\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|q\MG\\{x\_coord},\39{\AND}\|q\MG\\{y%
\_coord});{}$\6
\&{if} ${}(\\{mp\_right\_type}(\|q)\I\\{mp\_endpoint}){}$\1\5
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|q\MG\\{right\_x},\39{\AND}\|q\MG%
\\{right\_y});{}$\2\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{1008}Transforming a pen is very similar, except that there are no \PB{\\{mp%
\_left\_type}}
and \PB{\\{mp\_right\_type}} fields.

\Y\B\4\D$\\{pen\_trans}(\|A,\|B)$ \6
${}\{{}$\1\6
${}\\{mp\_set\_up\_known\_trans}(\\{mp},\39(\|A));{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39(\|B));{}$\6
${}\\{mp\_do\_pen\_trans}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\4${}\}{}$\2\par
\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_pen\_trans}(\&{MP} \\{mp}${},\39{}$\&{mp\_knot} %
\|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ list traverser }\7
\&{if} (\\{pen\_is\_elliptical}(\|p))\5
${}\{{}$\1\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|p\MG\\{left\_x},\39{\AND}\|p\MG%
\\{left\_y});{}$\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|p\MG\\{right\_x},\39{\AND}\|p\MG%
\\{right\_y});{}$\6
\4${}\}{}$\2\6
${}\|q\K\|p;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}\|q\MG\\{x\_coord},\39{\AND}\|q\MG\\{y%
\_coord});{}$\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\|p);{}$\6
\4${}\}{}$\2\par
\fi

\M{1009}The next transformation procedure applies to edge structures. It will
do
any transformation, but the results may be substandard if the picture contains
text that uses downloaded bitmap fonts.  The binary action procedure is
\PB{\\{do\_edges\_trans}}, but we also need a function that just scales a
picture.
That routine is \PB{\\{scale\_edges}}.  Both it and the underlying routine \PB{%
\\{edges\_trans}}
should be thought of as procedures that update an edge structure \PB{\|h},
except
that they have to return a (possibly new) structure because of the need to call
\PB{\\{private\_edges}}.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_edge\_header\_node} \\{mp\_edges\_trans}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_edge\_header\_node} \|h)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ the object being transformed }\6
\&{mp\_dash\_node} \|r${},{}$ \|s;\C{ for list manipulation }\6
\&{mp\_number} \\{sx}${},{}$ \\{sy};\C{ saved transformation parameters }\6
\&{mp\_number} \\{sqdet};\C{ square root of determinant for \PB{\\{dash%
\_scale}} }\6
\&{mp\_number} \\{sgndet};\C{ sign of the determinant }\7
${}\|h\K\\{mp\_private\_edges}(\\{mp},\39\|h);{}$\6
\\{new\_number}(\\{sx});\6
\\{new\_number}(\\{sy});\6
\\{new\_number}(\\{sqdet});\6
\\{new\_number}(\\{sgndet});\6
${}\\{mp\_sqrt\_det}(\\{mp},\39{\AND}\\{sqdet},\39\\{mp}\MG\\{txx},\39\\{mp}\MG%
\\{txy},\39\\{mp}\MG\\{tyx},\39\\{mp}\MG\\{tyy});{}$\6
${}\\{ab\_vs\_cd}(\\{sgndet},\39\\{mp}\MG\\{txx},\39\\{mp}\MG\\{tyy},\39\\{mp}%
\MG\\{txy},\39\\{mp}\MG\\{tyx});{}$\6
\&{if} ${}(\\{dash\_list}(\|h)\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
\X1010:Try to transform the dash list of \PB{\|h}\X;\6
\4${}\}{}$\2\6
\X1013:Make the bounding box of \PB{\|h} unknown if it can't be updated
properly without scanning the whole structure\X;\6
${}\|q\K\\{mp\_link}(\\{edge\_list}(\|h));{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\X1016:Transform graphical object \PB{\|q}\X;\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{sx});\6
\\{free\_number}(\\{sy});\6
\\{free\_number}(\\{sqdet});\6
\\{free\_number}(\\{sgndet});\6
\&{return} \|h;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_do\_edges\_trans}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_set\_up\_known\_trans}(\\{mp},\39\|c);{}$\6
${}\\{set\_value\_node}(\|p,\39{}$(\&{mp\_node}) \\{mp\_edges\_trans}${}(%
\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{value\_node}(\|p)));\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\7
\&{static} \&{mp\_edge\_header\_node} \\{mp\_scale\_edges}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_number} \\{se\_sf}${},\39{}$\&{mp\_edge\_header\_node} \\{se%
\_pic})\1\1\2\2\6
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{txx},\39\\{se\_sf});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{tyy},\39\\{se\_sf});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{txy});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tyx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ty});{}$\6
\&{return} \\{mp\_edges\_trans}${}(\\{mp},\39\\{se\_pic});{}$\6
\4${}\}{}$\2\par
\fi

\M{1010}\B\X1010:Try to transform the dash list of \PB{\|h}\X${}\E{}$\6
\&{if} ${}(\\{number\_nonzero}(\\{mp}\MG\\{txy})\V\\{number\_nonzero}(\\{mp}\MG%
\\{tyx})\V\\{number\_nonzero}(\\{mp}\MG\\{ty})\V\\{number\_nonequalabs}(\\{mp}%
\MG\\{txx},\39\\{mp}\MG\\{tyy})){}$\5
${}\{{}$\1\6
${}\\{mp\_flush\_dash\_list}(\\{mp},\39\|h);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{abs\_tyy}${},{}$ \\{ret};\7
\\{new\_number}(\\{abs\_tyy});\6
\&{if} ${}(\\{number\_negative}(\\{mp}\MG\\{txx})){}$\5
${}\{{}$\1\6
\X1011:Reverse the dash list of \PB{\|h}\X;\6
\4${}\}{}$\2\6
\X1012:Scale the dash list by \PB{\\{txx}} and shift it by \PB{\\{tx}}\X;\6
${}\\{number\_clone}(\\{abs\_tyy},\39\\{mp}\MG\\{tyy});{}$\6
\\{number\_abs}(\\{abs\_tyy});\6
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39\|h\MG\\{dash\_y},\39\\{abs\_tyy});{}$\6
${}\\{number\_clone}(\|h\MG\\{dash\_y},\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{abs\_tyy});\6
\4${}\}{}$\2\par
\U1009.\fi

\M{1011}\B\X1011:Reverse the dash list of \PB{\|h}\X${}\E{}$\6
${}\{{}$\1\6
${}\|r\K\\{dash\_list}(\|h);{}$\6
${}\\{set\_dash\_list}(\|h,\39\\{mp}\MG\\{null\_dash});{}$\6
\&{while} ${}(\|r\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
${}\|s\K\|r;{}$\6
${}\|r\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|r);\6
${}\\{number\_swap}(\|s\MG\\{start\_x},\39\|s\MG\\{stop\_x});{}$\6
${}\\{mp\_link}(\|s)\K{}$(\&{mp\_node}) \\{dash\_list}(\|h);\6
${}\\{set\_dash\_list}(\|h,\39\|s);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1010.\fi

\M{1012}\B\X1012:Scale the dash list by \PB{\\{txx}} and shift it by \PB{%
\\{tx}}\X${}\E{}$\6
$\|r\K\\{dash\_list}(\|h);{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
\&{while} ${}(\|r\I\\{mp}\MG\\{null\_dash}){}$\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{arg1},\39\|r\MG\\{start\_x},\39\\{mp}\MG\\{txx});{}$\6
${}\\{set\_number\_from\_addition}(\|r\MG\\{start\_x},\39\\{arg1},\39\\{mp}\MG%
\\{tx});{}$\6
${}\\{take\_scaled}(\\{arg1},\39\|r\MG\\{stop\_x},\39\\{mp}\MG\\{txx});{}$\6
${}\\{set\_number\_from\_addition}(\|r\MG\\{stop\_x},\39\\{arg1},\39\\{mp}\MG%
\\{tx});{}$\6
${}\|r\K{}$(\&{mp\_dash\_node}) \\{mp\_link}(\|r);\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\par
\U1010.\fi

\M{1013}\B\X1013:Make the bounding box of \PB{\|h} unknown if it can't be
updated properly without scanning the whole structure\X${}\E{}$\6
\&{if} ${}(\\{number\_zero}(\\{mp}\MG\\{txx})\W\\{number\_zero}(\\{mp}\MG%
\\{tyy})){}$\5
${}\{{}$\1\6
\X1014:Swap the $x$ and $y$ parameters in the bounding box of \PB{\|h}\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_nonzero}(\\{mp}\MG\\{txy})\V\\{number\_nonzero}(%
\\{mp}\MG\\{tyx})){}$\5
${}\{{}$\1\6
${}\\{mp\_init\_bbox}(\\{mp},\39\|h);{}$\6
\&{goto} \.{DONE1};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_lessequal}(\|h\MG\\{minx},\39\|h\MG\\{maxx})){}$\5
${}\{{}$\1\6
\X1015:Scale the bounding box by \PB{$\\{txx}+\\{txy}$} and \PB{$\\{tyx}+%
\\{tyy}$}; then shift by \PB{$(\\{tx},\\{ty})$}\X;\6
\4${}\}{}$\2\6
\.{DONE1}:\par
\U1009.\fi

\M{1014}\B\X1014:Swap the $x$ and $y$ parameters in the bounding box of \PB{%
\|h}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{number\_swap}(\|h\MG\\{minx},\39\|h\MG\\{miny});{}$\6
${}\\{number\_swap}(\|h\MG\\{maxx},\39\|h\MG\\{maxy});{}$\6
\4${}\}{}$\2\par
\U1013.\fi

\M{1015}The sum ``\PB{$\\{txx}+\\{txy}$}'' is whichever of \PB{\\{txx}} or \PB{%
\\{txy}} is nonzero.  The other
sum is similar.

\Y\B\4\X1015:Scale the bounding box by \PB{$\\{txx}+\\{txy}$} and \PB{$\\{tyx}+%
\\{tyy}$}; then shift by \PB{$(\\{tx},\\{ty})$}\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{tot}${},{}$ \\{ret};\7
\\{new\_number}(\\{tot});\6
\\{new\_number}(\\{ret});\6
${}\\{set\_number\_from\_addition}(\\{tot},\39\\{mp}\MG\\{txx},\39\\{mp}\MG%
\\{txy});{}$\6
${}\\{take\_scaled}(\\{ret},\39\|h\MG\\{minx},\39\\{tot});{}$\6
${}\\{set\_number\_from\_addition}(\|h\MG\\{minx},\39\\{ret},\39\\{mp}\MG%
\\{tx});{}$\6
${}\\{take\_scaled}(\\{ret},\39\|h\MG\\{maxx},\39\\{tot});{}$\6
${}\\{set\_number\_from\_addition}(\|h\MG\\{maxx},\39\\{ret},\39\\{mp}\MG%
\\{tx});{}$\6
${}\\{set\_number\_from\_addition}(\\{tot},\39\\{mp}\MG\\{tyx},\39\\{mp}\MG%
\\{tyy});{}$\6
${}\\{take\_scaled}(\\{ret},\39\|h\MG\\{miny},\39\\{tot});{}$\6
${}\\{set\_number\_from\_addition}(\|h\MG\\{miny},\39\\{ret},\39\\{mp}\MG%
\\{ty});{}$\6
${}\\{take\_scaled}(\\{ret},\39\|h\MG\\{maxy},\39\\{tot});{}$\6
${}\\{set\_number\_from\_addition}(\|h\MG\\{maxy},\39\\{ret},\39\\{mp}\MG%
\\{ty});{}$\6
${}\\{set\_number\_from\_addition}(\\{tot},\39\\{mp}\MG\\{txx},\39\\{mp}\MG%
\\{txy});{}$\6
\&{if} (\\{number\_negative}(\\{tot}))\5
${}\{{}$\1\6
${}\\{number\_swap}(\|h\MG\\{minx},\39\|h\MG\\{maxx});{}$\6
\4${}\}{}$\2\6
${}\\{set\_number\_from\_addition}(\\{tot},\39\\{mp}\MG\\{tyx},\39\\{mp}\MG%
\\{tyy});{}$\6
\&{if} (\\{number\_negative}(\\{tot}))\5
${}\{{}$\1\6
${}\\{number\_swap}(\|h\MG\\{miny},\39\|h\MG\\{maxy});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{ret});\6
\\{free\_number}(\\{tot});\6
\4${}\}{}$\2\par
\U1013.\fi

\M{1016}Now we ready for the main task of transforming the graphical objects in
edge
structure~\PB{\|h}.

\Y\B\4\X1016:Transform graphical object \PB{\|q}\X${}\E{}$\6
\&{switch} (\\{mp\_type}(\|q))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_fill\_node} \\{qq}${}\K{}$(\&{mp\_fill\_node}) \|q;\7
${}\\{mp\_do\_path\_trans}(\\{mp},\39\\{mp\_path\_p}(\\{qq}));{}$\6
\X1017:Transform \PB{\\{mp\_pen\_p}(\\{qq})}, making sure polygonal pens stay
counter-clockwise\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\6
${}\{{}$\1\6
\&{mp\_stroked\_node} \\{qq}${}\K{}$(\&{mp\_stroked\_node}) \|q;\7
${}\\{mp\_do\_path\_trans}(\\{mp},\39\\{mp\_path\_p}(\\{qq}));{}$\6
\X1017:Transform \PB{\\{mp\_pen\_p}(\\{qq})}, making sure polygonal pens stay
counter-clockwise\X;\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_start\_clip\_node\_type}:\5
${}\\{mp\_do\_path\_trans}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_clip%
\_node}) \|q));\6
\&{break};\6
\4\&{case} \\{mp\_start\_bounds\_node\_type}:\5
${}\\{mp\_do\_path\_trans}(\\{mp},\39{}$\\{mp\_path\_p}((\&{mp\_start\_bounds%
\_node}) \|q));\6
\&{break};\6
\4\&{case} \\{mp\_text\_node\_type}:\5
\X1018:Transform the compact transformation\X;\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
\&{case} \\{mp\_stop\_bounds\_node\_type}:\5
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\par
\U1009.\fi

\M{1017}Note that the shift parameters \PB{$(\\{tx},\\{ty})$} apply only to the
path being stroked.
The \PB{\\{dash\_scale}} has to be adjusted  to scale the dash lengths in \PB{%
\\{mp\_dash\_p}(\|q)}
since the \ps\ output procedures will try to compensate for the transformation
we are applying to \PB{\\{mp\_pen\_p}(\|q)}.  Since this compensation is based
on the square
root of the determinant, \PB{\\{sqdet}} is the appropriate factor.

We pass the mptrap test only if \PB{\\{dash\_scale}} is not adjusted, nowadays
(backend is changed?)

\Y\B\4\X1017:Transform \PB{\\{mp\_pen\_p}(\\{qq})}, making sure polygonal pens
stay counter-clockwise\X${}\E{}$\6
\&{if} ${}(\\{mp\_pen\_p}(\\{qq})\I\NULL){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{sx},\39\\{mp}\MG\\{tx});{}$\6
${}\\{number\_clone}(\\{sy},\39\\{mp}\MG\\{ty});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ty});{}$\6
${}\\{mp\_do\_pen\_trans}(\\{mp},\39\\{mp\_pen\_p}(\\{qq}));{}$\6
\&{if} ${}(\\{number\_nonzero}(\\{sqdet})\W((\\{mp\_type}(\|q)\E\\{mp\_stroked%
\_node\_type})\W(\\{mp\_dash\_p}(\|q)\I\NULL))){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39{}$((\&{mp\_stroked\_node}) \|q)${}\MG\\{dash%
\_scale},\39\\{sqdet});{}$\6
\\{number\_clone}(((\&{mp\_stroked\_node}) \|q)${}\MG\\{dash\_scale},\39%
\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{pen\_is\_elliptical}(\\{mp\_pen\_p}(\\{qq}))){}$\1\6
\&{if} (\\{number\_negative}(\\{sgndet}))\1\5
${}\\{mp\_pen\_p}(\\{qq})\K\\{mp\_make\_pen}(\\{mp},\39\\{mp\_copy\_path}(%
\\{mp},\39\\{mp\_pen\_p}(\\{qq})),\39\\{true}){}$;\C{ this unreverses the pen }%
\2\2\6
${}\\{number\_clone}(\\{mp}\MG\\{tx},\39\\{sx});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{ty},\39\\{sy});{}$\6
\4${}\}{}$\2\par
\U1016.\fi

\M{1018}\B\X1018:Transform the compact transformation\X${}\E{}$\6
$\\{mp\_number\_trans}(\\{mp},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG%
\\{tx},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG\\{ty});{}$\6
${}\\{number\_clone}(\\{sx},\39\\{mp}\MG\\{tx});{}$\6
${}\\{number\_clone}(\\{sy},\39\\{mp}\MG\\{ty});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{tx});{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{ty});{}$\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG%
\\{txx},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG\\{tyx});{}$\6
${}\\{mp\_number\_trans}(\\{mp},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG%
\\{txy},\39{\AND}{}$((\&{mp\_text\_node}) \|q)${}\MG\\{tyy});{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{tx},\39\\{sx});$ $\\{number\_clone}(\\{mp}\MG%
\\{ty},\39\\{sy}{}$)\par
\U1016.\fi

\M{1019}The hard cases of transformation occur when big nodes are involved,
and when some of their components are unknown.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\X1021:Declare subroutines needed by \PB{\\{big\_trans}}\X;\7
\&{static} \&{void} \\{mp\_big\_trans}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\|p${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q${},{}$ \|r${},{}$ \\{pp}${},{}$ \\{qq};\C{ list manipulation
registers }\7
${}\|q\K\\{value\_node}(\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_pair\_node\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{x\_part}(\|q))\I\\{mp\_known}\V\\{mp\_type}(\\{y%
\_part}(\|q))\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\X1020:Transform an unknown big node and \PB{\&{return}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ \PB{\\{mp\_transform\_type}} }\1\6
\&{if} ${}(\\{mp\_type}(\\{tx\_part}(\|q))\I\\{mp\_known}\V\\{mp\_type}(\\{ty%
\_part}(\|q))\I\\{mp\_known}\V\\{mp\_type}(\\{xx\_part}(\|q))\I\\{mp\_known}\V%
\\{mp\_type}(\\{xy\_part}(\|q))\I\\{mp\_known}\V\\{mp\_type}(\\{yx\_part}(\|q))%
\I\\{mp\_known}\V\\{mp\_type}(\\{yy\_part}(\|q))\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\X1020:Transform an unknown big node and \PB{\&{return}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\X1022:Transform a known big node\X;\6
\4${}\}{}$\C{ node \PB{\|p} will now be recycled by \PB{\\{do\_binary}} }\2\par
\fi

\M{1020}\B\X1020:Transform an unknown big node and \PB{\&{return}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_set\_up\_known\_trans}(\\{mp},\39\|c);{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|p);{}$\6
${}\|r\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_transform\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bilin1}(\\{mp},\39\\{yy\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{xy%
\_part}(\|q),\39\\{mp}\MG\\{tyx},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin1}(\\{mp},\39\\{yx\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{xx%
\_part}(\|q),\39\\{mp}\MG\\{tyx},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin1}(\\{mp},\39\\{xy\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{yy%
\_part}(\|q),\39\\{mp}\MG\\{txy},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin1}(\\{mp},\39\\{xx\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{yx%
\_part}(\|q),\39\\{mp}\MG\\{txy},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_bilin1}(\\{mp},\39\\{y\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{x%
\_part}(\|q),\39\\{mp}\MG\\{tyx},\39\\{mp}\MG\\{ty});{}$\6
${}\\{mp\_bilin1}(\\{mp},\39\\{x\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{y%
\_part}(\|q),\39\\{mp}\MG\\{txy},\39\\{mp}\MG\\{tx});{}$\6
\&{return};\6
\4${}\}{}$\2\par
\U1019.\fi

\M{1021}Let \PB{\|p} point to a value field inside a big node of \PB{\\{cur%
\_exp}},
and let \PB{\|q} point to a another value field. The \PB{\\{bilin1}} procedure
replaces \PB{\|p} by $p\cdot t+q\cdot u+\delta$.

\Y\B\4\X1021:Declare subroutines needed by \PB{\\{big\_trans}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_bilin1}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p${},%
\39{}$\&{mp\_number} \|t${},\39{}$\&{mp\_node} \|q${},\39{}$\&{mp\_number} %
\|u${},\39{}$\&{mp\_number} \\{delta\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{delta};\7
\\{new\_number}(\\{delta});\6
${}\\{number\_clone}(\\{delta},\39\\{delta\_orig});{}$\6
\&{if} ${}(\R\\{number\_equal}(\|t,\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\\{mp\_dep\_mult}(\\{mp},\39{}$(\&{mp\_value\_node}) \|p${},\39\|t,\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_nonzero}(\|u))\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\7
\\{new\_number}(\\{tmp});\6
${}\\{take\_scaled}(\\{tmp},\39\\{value\_number}(\|q),\39\|u);{}$\6
${}\\{number\_add}(\\{delta},\39\\{tmp});{}$\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Ensure that \PB{$\\{type}(\|p)\K\\{mp\_proto\_dependent}$} }\1\6
\&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_proto\_dependent}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_new\_dep}(\\{mp},\39\|p,\39\\{mp\_type}(\|p),\39\\{mp\_const%
\_dependency}(\\{mp},\39\\{value\_number}(\|p)));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_dep\_list}((\&{mp\_value\_node}) \|p${},\39\\{mp\_p\_times\_v}(\\{mp},%
\39{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p)${},\39%
\\{unity\_t},\39\\{mp\_dependent},\39\\{mp\_proto\_dependent},\39\\{true}));{}$%
\6
\4${}\}{}$\2\6
${}\\{mp\_type}(\|p)\K\\{mp\_proto\_dependent};{}$\6
\4${}\}{}$\2\6
\\{set\_dep\_list}((\&{mp\_value\_node}) \|p${},\39\\{mp\_p\_plus\_fq}(\\{mp},%
\39{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p)${},\39\|u,%
\39{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|q)${},\39%
\\{mp\_proto\_dependent},\39\\{mp\_type}(\|q)));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{value\_number}(\|p));{}$\6
${}\\{number\_add}(\\{value\_number}(\|p),\39\\{delta});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \\{tmp};\6
\&{mp\_value\_node} \|r;\C{ list traverser }\7
\\{new\_number}(\\{tmp});\6
${}\|r\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|p);\6
\&{while} ${}(\\{dep\_info}(\|r)\I\NULL){}$\1\5
${}\|r\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|r);\2\6
${}\\{number\_clone}(\\{tmp},\39\\{value\_number}(\|r));{}$\6
${}\\{number\_add}(\\{delta},\39\\{tmp});{}$\6
\&{if} ${}(\|r\I{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) %
\|p))\1\5
${}\\{set\_value\_number}(\|r,\39\\{delta});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{delta});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{tmp});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{fix\_needed}){}$\1\5
\\{mp\_fix\_dependencies}(\\{mp});\2\6
\\{free\_number}(\\{delta});\6
\4${}\}{}$\2\par
\As1023, 1024\ETs1026.
\U1019.\fi

\M{1022}\B\X1022:Transform a known big node\X${}\E{}$\6
$\\{mp\_set\_up\_trans}(\\{mp},\39\|c);{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\X1025:Transform known by known\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{pp}\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{qq}\K\\{value\_node}(\\{pp});{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|p);{}$\6
${}\|r\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_transform\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bilin2}(\\{mp},\39\\{yy\_part}(\|r),\39\\{yy\_part}(\\{qq}),\39%
\\{value\_number}(\\{xy\_part}(\|q)),\39\\{yx\_part}(\\{qq}),\39\NULL);{}$\6
${}\\{mp\_bilin2}(\\{mp},\39\\{yx\_part}(\|r),\39\\{yy\_part}(\\{qq}),\39%
\\{value\_number}(\\{xx\_part}(\|q)),\39\\{yx\_part}(\\{qq}),\39\NULL);{}$\6
${}\\{mp\_bilin2}(\\{mp},\39\\{xy\_part}(\|r),\39\\{xx\_part}(\\{qq}),\39%
\\{value\_number}(\\{yy\_part}(\|q)),\39\\{xy\_part}(\\{qq}),\39\NULL);{}$\6
${}\\{mp\_bilin2}(\\{mp},\39\\{xx\_part}(\|r),\39\\{xx\_part}(\\{qq}),\39%
\\{value\_number}(\\{yx\_part}(\|q)),\39\\{xy\_part}(\\{qq}),\39\NULL);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_bilin2}(\\{mp},\39\\{y\_part}(\|r),\39\\{yy\_part}(\\{qq}),\39%
\\{value\_number}(\\{x\_part}(\|q)),\39\\{yx\_part}(\\{qq}),\39\\{y\_part}(%
\\{qq}));{}$\6
${}\\{mp\_bilin2}(\\{mp},\39\\{x\_part}(\|r),\39\\{xx\_part}(\\{qq}),\39%
\\{value\_number}(\\{y\_part}(\|q)),\39\\{xy\_part}(\\{qq}),\39\\{x\_part}(%
\\{qq}));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{pp});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{pp});{}$\6
\4${}\}{}$\2\par
\U1019.\fi

\M{1023}Let \PB{\|p} be a \PB{\\{mp\_proto\_dependent}} value whose dependency
list ends
at \PB{\\{dep\_final}}. The following procedure adds \PB{\|v} times another
numeric quantity to~\PB{\|p}.

\Y\B\4\X1021:Declare subroutines needed by \PB{\\{big\_trans}}\X${}\mathrel+%
\E{}$\6
\&{static} \&{void} \\{mp\_add\_mult\_dep}(\&{MP} \\{mp}${},\39{}$\&{mp\_value%
\_node} \|p${},\39{}$\&{mp\_number} \|v${},\39{}$\&{mp\_node} \|r)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39\\{value\_number}(\|r),\39\|v);{}$\6
${}\\{set\_dep\_value}(\\{mp}\MG\\{dep\_final},\39\\{dep\_value}(\\{mp}\MG%
\\{dep\_final}));{}$\6
${}\\{number\_add}(\\{dep\_value}(\\{mp}\MG\\{dep\_final}),\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_dep\_list}(\|p,\39\\{mp\_p\_plus\_fq}(\\{mp},\39{}$(\&{mp\_value%
\_node}) \\{dep\_list}(\|p)${},\39\|v,\39{}$(\&{mp\_value\_node}) \\{dep%
\_list}((\&{mp\_value\_node}) \|r)${},\39\\{mp\_proto\_dependent},\39\\{mp%
\_type}(\|r)));{}$\6
\&{if} ${}(\\{mp}\MG\\{fix\_needed}){}$\1\5
\\{mp\_fix\_dependencies}(\\{mp});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1024}The \PB{\\{bilin2}} procedure is something like \PB{\\{bilin1}}, but
with known
and unknown quantities reversed. Parameter \PB{\|p} points to a value field
within the big node for \PB{\\{cur\_exp}}; and \PB{$\\{type}(\|p)\K\\{mp%
\_known}$}. Parameters
\PB{\|t} and~\PB{\|u} point to value fields elsewhere; so does parameter~\PB{%
\|q},
unless it is \PB{$\NULL$} (which stands for zero). Location~\PB{\|p} will be
replaced by $p\cdot t+v\cdot u+q$.

\Y\B\4\X1021:Declare subroutines needed by \PB{\\{big\_trans}}\X${}\mathrel+%
\E{}$\6
\&{static} \&{void} \\{mp\_bilin2}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p${},%
\39{}$\&{mp\_node} \|t${},\39{}$\&{mp\_number} \|v${},\39{}$\&{mp\_node} %
\|u${},\39{}$\&{mp\_node} \|q)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{vv};\C{ temporary storage for \PB{\\{value}(\|p)} }\7
\\{new\_number}(\\{vv});\6
${}\\{number\_clone}(\\{vv},\39\\{value\_number}(\|p));{}$\6
${}\\{mp\_new\_dep}(\\{mp},\39\|p,\39\\{mp\_proto\_dependent},\39\\{mp\_const%
\_dependency}(\\{mp},\39\\{zero\_t})){}$;\C{ this sets \PB{\\{dep\_final}} }\6
\&{if} (\\{number\_nonzero}(\\{vv}))\5
${}\{{}$\1\6
${}\\{mp\_add\_mult\_dep}(\\{mp},\39{}$(\&{mp\_value\_node}) \|p${},\39\\{vv},%
\39\|t){}$;\C{ \PB{\\{dep\_final}} doesn't change }\6
\4${}\}{}$\2\6
\&{if} (\\{number\_nonzero}(\|v))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\|v);{}$\6
${}\\{mp\_add\_mult\_dep}(\\{mp},\39{}$(\&{mp\_value\_node}) \|p${},\39%
\\{arg1},\39\|u);{}$\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\I\NULL){}$\1\5
${}\\{mp\_add\_mult\_dep}(\\{mp},\39{}$(\&{mp\_value\_node}) \|p${},\39\\{unity%
\_t},\39\|q);{}$\2\6
\&{if} (\\{dep\_list}((\&{mp\_value\_node}) \|p)${}\E{}$(\&{mp\_node}) %
\\{mp}${}\MG\\{dep\_final}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{vv},\39\\{dep\_value}(\\{mp}\MG\\{dep\_final}));{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_type}(\|p)\K\\{mp\_known};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{vv});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{vv});\6
\4${}\}{}$\2\par
\fi

\M{1025}\B\X1025:Transform known by known\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|p);{}$\6
${}\|r\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_transform\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_bilin3}(\\{mp},\39\\{yy\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{value%
\_number}(\\{xy\_part}(\|q)),\39\\{mp}\MG\\{tyx},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin3}(\\{mp},\39\\{yx\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{value%
\_number}(\\{xx\_part}(\|q)),\39\\{mp}\MG\\{tyx},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin3}(\\{mp},\39\\{xy\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{value%
\_number}(\\{yy\_part}(\|q)),\39\\{mp}\MG\\{txy},\39\\{zero\_t});{}$\6
${}\\{mp\_bilin3}(\\{mp},\39\\{xx\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{value%
\_number}(\\{yx\_part}(\|q)),\39\\{mp}\MG\\{txy},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_bilin3}(\\{mp},\39\\{y\_part}(\|r),\39\\{mp}\MG\\{tyy},\39\\{value%
\_number}(\\{x\_part}(\|q)),\39\\{mp}\MG\\{tyx},\39\\{mp}\MG\\{ty});{}$\6
${}\\{mp\_bilin3}(\\{mp},\39\\{x\_part}(\|r),\39\\{mp}\MG\\{txx},\39\\{value%
\_number}(\\{y\_part}(\|q)),\39\\{mp}\MG\\{txy},\39\\{mp}\MG\\{tx});{}$\6
\4${}\}{}$\2\par
\U1022.\fi

\M{1026}Finally, in \PB{\\{bilin3}} everything is \PB{\\{known}}.

\Y\B\4\X1021:Declare subroutines needed by \PB{\\{big\_trans}}\X${}\mathrel+%
\E{}$\6
\&{static} \&{void} \\{mp\_bilin3}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p${},%
\39{}$\&{mp\_number} \|t${},\39{}$\&{mp\_number} \|v${},\39{}$\&{mp\_number} %
\|u${},\39{}$\&{mp\_number} \\{delta\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{delta};\6
\&{mp\_number} \\{tmp};\7
\\{new\_number}(\\{tmp});\6
\\{new\_number}(\\{delta});\6
${}\\{number\_clone}(\\{delta},\39\\{delta\_orig});{}$\6
\&{if} ${}(\R\\{number\_equal}(\|t,\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\\{take\_scaled}(\\{tmp},\39\\{value\_number}(\|p),\39\|t);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{tmp},\39\\{value\_number}(\|p));{}$\6
\4${}\}{}$\2\6
${}\\{number\_add}(\\{delta},\39\\{tmp});{}$\6
\&{if} (\\{number\_nonzero}(\|u))\5
${}\{{}$\1\6
\&{mp\_number} \\{ret};\7
\\{new\_number}(\\{ret});\6
${}\\{take\_scaled}(\\{ret},\39\|v,\39\|u);{}$\6
${}\\{set\_value\_number}(\|p,\39\\{delta});{}$\6
${}\\{number\_add}(\\{value\_number}(\|p),\39\\{ret});{}$\6
\\{free\_number}(\\{ret});\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\\{set\_value\_number}(\|p,\39\\{delta});{}$\2\6
\\{free\_number}(\\{tmp});\6
\\{free\_number}(\\{delta});\6
\4${}\}{}$\2\par
\fi

\M{1027}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_chop\_path}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|q;\C{ a knot in the original path }\6
\&{mp\_knot} \\{pp}${},{}$ \\{qq}${},{}$ \\{rr}${},{}$ \\{ss};\C{ link
variables for copies of path nodes }\6
\&{mp\_number} \|a${},{}$ \|b;\C{ indices for chopping }\6
\&{mp\_number} \|l;\6
\&{boolean} \\{reversed};\C{ was \PB{$\|a>\|b$}? }\7
\\{new\_number}(\|a);\6
\\{new\_number}(\|b);\6
\\{new\_number}(\|l);\6
${}\\{mp\_path\_length}(\\{mp},\39{\AND}\|l);{}$\6
${}\\{number\_clone}(\|a,\39\\{value\_number}(\\{x\_part}(\|p)));{}$\6
${}\\{number\_clone}(\|b,\39\\{value\_number}(\\{y\_part}(\|p)));{}$\6
\&{if} ${}(\\{number\_lessequal}(\|a,\39\|b)){}$\5
${}\{{}$\1\6
${}\\{reversed}\K\\{false};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{reversed}\K\\{true};{}$\6
${}\\{number\_swap}(\|a,\39\|b);{}$\6
\4${}\}{}$\C{ Dispense with the cases \PB{$\|a<\T{0}$} and/or \PB{$\|b>\|l$} }%
\2\6
\&{if} (\\{number\_negative}(\|a))\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\|a);\6
\&{if} (\\{number\_negative}(\|b))\1\5
\\{set\_number\_to\_zero}(\|b);\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
${}\\{number\_add}(\|a,\39\|l);{}$\6
${}\\{number\_add}(\|b,\39\|l);{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_negative}(\|a));\C{ a cycle always has length \PB{$\|l>%
\T{0}$} }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\|b,\39\|l)){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|b,\39\|l);{}$\6
\&{if} ${}(\\{number\_greater}(\|a,\39\|l)){}$\1\5
${}\\{number\_clone}(\|a,\39\|l);{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{while} ${}(\\{number\_greaterequal}(\|a,\39\|l)){}$\5
${}\{{}$\1\6
${}\\{number\_substract}(\|a,\39\|l);{}$\6
${}\\{number\_substract}(\|b,\39\|l);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|q\K\\{cur\_exp\_knot}(\,);{}$\6
\&{while} ${}(\\{number\_greaterequal}(\|a,\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{number\_substract}(\|a,\39\\{unity\_t});{}$\6
${}\\{number\_substract}(\|b,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_equal}(\|b,\39\|a)){}$\5
${}\{{}$\C{ Construct a path from \PB{\\{pp}} to \PB{\\{qq}} of length zero }\1%
\6
\&{if} (\\{number\_positive}(\|a))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\|a);{}$\6
\\{convert\_scaled\_to\_fraction}(\\{arg1});\6
${}\\{mp\_split\_cubic}(\\{mp},\39\|q,\39\\{arg1});{}$\6
\\{free\_number}(\\{arg1});\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
\4${}\}{}$\2\6
${}\\{pp}\K\\{mp\_copy\_knot}(\\{mp},\39\|q);{}$\6
${}\\{qq}\K\\{pp};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Construct a path from \PB{\\{pp}} to \PB{\\{qq}} of length $\lceil
b\rceil$ }\1\6
${}\\{pp}\K\\{mp\_copy\_knot}(\\{mp},\39\|q);{}$\6
${}\\{qq}\K\\{pp};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|q\K\\{mp\_next\_knot}(\|q);{}$\6
${}\\{rr}\K\\{qq};{}$\6
${}\\{qq}\K\\{mp\_copy\_knot}(\\{mp},\39\|q);{}$\6
${}\\{mp\_next\_knot}(\\{rr})\K\\{qq};{}$\6
${}\\{number\_substract}(\|b,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\5
\&{while} (\\{number\_positive}(\|b));\6
\&{if} (\\{number\_positive}(\|a))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{ss}\K\\{pp};{}$\6
${}\\{number\_clone}(\\{arg1},\39\|a);{}$\6
\\{convert\_scaled\_to\_fraction}(\\{arg1});\6
${}\\{mp\_split\_cubic}(\\{mp},\39\\{ss},\39\\{arg1});{}$\6
\\{free\_number}(\\{arg1});\6
${}\\{pp}\K\\{mp\_next\_knot}(\\{ss});{}$\6
${}\\{mp\_toss\_knot}(\\{mp},\39\\{ss});{}$\6
\&{if} ${}(\\{rr}\E\\{ss}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1}${},{}$ \\{arg2};\7
\\{new\_number}(\\{arg1});\6
\\{new\_number}(\\{arg2});\6
${}\\{set\_number\_from\_substraction}(\\{arg1},\39\\{unity\_t},\39\|a);{}$\6
${}\\{number\_clone}(\\{arg2},\39\|b);{}$\6
${}\\{make\_scaled}(\|b,\39\\{arg2},\39\\{arg1});{}$\6
\\{free\_number}(\\{arg1});\6
\\{free\_number}(\\{arg2});\6
${}\\{rr}\K\\{pp};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{number\_negative}(\|b))\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\|b,\39\\{unity\_t});{}$\6
\\{convert\_scaled\_to\_fraction}(\\{arg1});\6
${}\\{mp\_split\_cubic}(\\{mp},\39\\{rr},\39\\{arg1});{}$\6
\\{free\_number}(\\{arg1});\6
${}\\{mp\_toss\_knot}(\\{mp},\39\\{qq});{}$\6
${}\\{qq}\K\\{mp\_next\_knot}(\\{rr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_left\_type}(\\{pp})\K\\{mp\_endpoint};{}$\6
${}\\{mp\_right\_type}(\\{qq})\K\\{mp\_endpoint};{}$\6
${}\\{mp\_next\_knot}(\\{qq})\K\\{pp};{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
\&{if} (\\{reversed})\5
${}\{{}$\1\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_next\_knot}(\\{mp\_htap\_ypoc}(\\{mp},\39%
\\{pp})));{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{pp});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_exp\_knot}(\\{pp});\6
\4${}\}{}$\2\6
\\{free\_number}(\|l);\6
\\{free\_number}(\|a);\6
\\{free\_number}(\|b);\6
\4${}\}{}$\2\par
\fi

\M{1028}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_up\_offset}(\&{MP} \\{mp}${},\39{}$\&{mp\_node}
\|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_find\_offset}(\\{mp},\39\\{value\_number}(\\{x\_part}(\|p)),\39%
\\{value\_number}(\\{y\_part}(\|p)),\39\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp\_pair\_value}(\\{mp},\39\\{mp}\MG\\{cur\_x},\39\\{mp}\MG\\{cur%
\_y});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_set\_up\_direction\_time}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_find\_direction\_time}(\\{mp},\39{\AND}\\{new\_expr}.\\{data}.\|n,\39%
\\{value\_number}(\\{x\_part}(\|p)),\39\\{value\_number}(\\{y\_part}(\|p)),\39%
\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_set\_up\_envelope}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \&{char} \\{ljoin}${},{}$ \\{lcap};\6
\&{mp\_number} \\{miterlim};\6
\&{mp\_knot} \|q${}\K\\{mp\_copy\_path}(\\{mp},\39\\{cur\_exp\_knot}(\,)){}$;%
\C{ the original path }\7
\\{new\_number}(\\{miterlim});\C{ TODO: accept elliptical pens for straight
paths }\6
\&{if} (\\{pen\_is\_elliptical}(\\{value\_knot}(\|p)))\5
${}\{{}$\1\6
\\{mp\_bad\_envelope\_pen}(\\{mp});\6
\\{set\_cur\_exp\_knot}(\|q);\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\&{return};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_linejoin}),\39%
\\{unity\_t})){}$\1\5
${}\\{ljoin}\K\T{2};{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_linejoin})))\1%
\5
${}\\{ljoin}\K\T{1};{}$\2\6
\&{else}\1\5
${}\\{ljoin}\K\T{0};{}$\2\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_linecap}),\39\\{unity%
\_t})){}$\1\5
${}\\{lcap}\K\T{2};{}$\2\6
\&{else} \&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_linecap})))\1\5
${}\\{lcap}\K\T{1};{}$\2\6
\&{else}\1\5
${}\\{lcap}\K\T{0};{}$\2\6
\&{if} ${}(\\{number\_less}(\\{internal\_value}(\\{mp\_miterlimit}),\39\\{unity%
\_t})){}$\1\5
\\{set\_number\_to\_unity}(\\{miterlim});\2\6
\&{else}\1\5
${}\\{number\_clone}(\\{miterlim},\39\\{internal\_value}(\\{mp%
\_miterlimit}));{}$\2\6
${}\\{set\_cur\_exp\_knot}(\\{mp\_make\_envelope}(\\{mp},\39\|q,\39\\{value%
\_knot}(\|p),\39\\{ljoin},\39\\{lcap},\39\\{miterlim}));{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_path\_type};{}$\6
\4${}\}{}$\2\par
\fi

\M{1029}This is pretty straightfoward. The one silly thing is that
the output of \PB{\\{mp\_ps\_do\_font\_charstring}} has to be un-exported.

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_up\_glyph\_infont}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_edge\_object}*\|h\K\NULL;{}$\6
${}\\{mp\_ps\_font}*\|f\K\NULL;{}$\7
\&{char} ${}{*}\|n\K\\{mp\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\7
${}\|f\K\\{mp\_ps\_font\_parse}(\\{mp},\39{}$(\&{int}) \\{mp\_find\_font}${}(%
\\{mp},\39\|n));{}$\6
\&{if} ${}(\|f\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{int} \|v${}\K\\{round\_unscaled}(\\{value\_number}(\|p));{}$\7
\&{if} ${}(\|v<\T{0}\V\|v>\T{255}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"glyph\ index\ too\ hig}\)\.{h\ (%
\%d)"},\39\|v);{}$\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\NULL,\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|h\K\\{mp\_ps\_font\_charstring}(\\{mp},\39\|f,\39\|v);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|n\K\\{mp\_str}(\\{mp},\39\\{value\_str}(\|p));{}$\6
${}\|h\K\\{mp\_ps\_do\_font\_charstring}(\\{mp},\39\|f,\39\|n);{}$\6
\4${}\}{}$\2\6
${}\\{mp\_ps\_font\_free}(\\{mp},\39\|f);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|h\I\NULL){}$\5
${}\{{}$\1\6
\\{set\_cur\_exp\_node}((\&{mp\_node}) \\{mp\_gr\_import}${}(\\{mp},\39%
\|h));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_cur\_exp\_node}((\&{mp\_node}) \\{mp\_get\_edge\_header\_node}(%
\\{mp}));\6
${}\\{mp\_init\_edges}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{cur\_exp%
\_node}(\,));\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\4${}\}{}$\2\par
\fi

\M{1030}\B\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_find\_point}(\&{MP} \\{mp}${},\39{}$\&{mp\_number} %
\\{v\_orig}${},\39{}$\&{quarterword} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_knot} \|p;\C{ the path }\6
\&{mp\_number} \|n;\C{ its length }\6
\&{mp\_number} \|v;\7
\\{new\_number}(\|v);\6
\\{new\_number}(\|n);\6
${}\\{number\_clone}(\|v,\39\\{v\_orig});{}$\6
${}\|p\K\\{cur\_exp\_knot}(\,);{}$\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_unity}(\|n);\6
\\{number\_negate}(\|n);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\|n);\6
\4${}\}{}$\2\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{number\_add}(\|n,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|p\I\\{cur\_exp\_knot}(\,));{}$\6
\&{if} (\\{number\_zero}(\|n))\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\|v);\6
\4${}\}{}$\2\6
\&{else} \&{if} (\\{number\_negative}(\|v))\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(\|v);\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ v = n - 1 - ((-v - 1) \% n)           == - ((-v - 1) \% n) - 1 + n }%
%\1\6
\\{number\_negate}(\|v);\6
${}\\{number\_add\_scaled}(\|v,\39{-}\T{1});{}$\6
${}\\{number\_modulo}(\|v,\39\|n);{}$\6
\\{number\_negate}(\|v);\6
${}\\{number\_add\_scaled}(\|v,\39{-}\T{1});{}$\6
${}\\{number\_add}(\|v,\39\|n);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{number\_greater}(\|v,\39\|n)){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_endpoint}){}$\1\5
${}\\{number\_clone}(\|v,\39\|n);{}$\2\6
\&{else}\1\5
${}\\{number\_modulo}(\|v,\39\|n);{}$\2\6
\4${}\}{}$\2\6
${}\|p\K\\{cur\_exp\_knot}(\,);{}$\6
\&{while} ${}(\\{number\_greaterequal}(\|v,\39\\{unity\_t})){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
${}\\{number\_substract}(\|v,\39\\{unity\_t});{}$\6
\4${}\}{}$\2\6
\&{if} (\\{number\_nonzero}(\|v))\5
${}\{{}$\C{ Insert a fractional node by splitting the cubic }\1\6
\\{convert\_scaled\_to\_fraction}(\|v);\6
${}\\{mp\_split\_cubic}(\\{mp},\39\|p,\39\|v);{}$\6
${}\|p\K\\{mp\_next\_knot}(\|p);{}$\6
\4${}\}{}$\C{ Set the current expression to the desired path coordinates }\2\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_point\_of}:\5
${}\\{mp\_pair\_value}(\\{mp},\39\|p\MG\\{x\_coord},\39\|p\MG\\{y\_coord});{}$\6
\&{break};\6
\4\&{case} \\{mp\_precontrol\_of}:\6
\&{if} ${}(\\{mp\_left\_type}(\|p)\E\\{mp\_endpoint}){}$\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\|p\MG\\{x\_coord},\39\|p\MG\\{y\_coord});{}$%
\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\|p\MG\\{left\_x},\39\|p\MG\\{left\_y});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_postcontrol\_of}:\6
\&{if} ${}(\\{mp\_right\_type}(\|p)\E\\{mp\_endpoint}){}$\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\|p\MG\\{x\_coord},\39\|p\MG\\{y\_coord});{}$%
\2\6
\&{else}\1\5
${}\\{mp\_pair\_value}(\\{mp},\39\|p\MG\\{right\_x},\39\|p\MG\\{right\_y});{}$%
\2\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\\{free\_number}(\|v);\6
\\{free\_number}(\|n);\6
\4${}\}{}$\2\par
\fi

\M{1031}Function \PB{\\{new\_text\_node}} owns the reference count for its
second argument
(the text string) but not its first (the font name).

\Y\B\4\X989:Declare binary action procedures\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_infont}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_edge\_header\_node} \|q;\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\|q\K\\{mp\_get\_edge\_header\_node}(\\{mp});{}$\6
${}\\{mp\_init\_edges}(\\{mp},\39\|q);{}$\6
\\{add\_str\_ref}(\\{cur\_exp\_str}(\,));\6
${}\\{mp\_link}(\\{obj\_tail}(\|q))\K\\{mp\_new\_text\_node}(\\{mp},\39\\{mp%
\_str}(\\{mp},\39\\{cur\_exp\_str}(\,)),\39\\{value\_str}(\|p));{}$\6
${}\\{obj\_tail}(\|q)\K\\{mp\_link}(\\{obj\_tail}(\|q));{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\|p);{}$\6
${}\\{new\_expr}.\\{data}.\\{node}\K{}$(\&{mp\_node}) \|q;\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_picture\_type};{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{1032}Statements and commands.
The chief executive of \MP\ is the \PB{\\{do\_statement}} routine, which
contains the master switch that causes all the various pieces of \MP\
to do their things, in the right order.

In a sense, this is the grand climax of the program: It applies all the
tools that we have worked so hard to construct. In another sense, this is
the messiest part of the program: It necessarily refers to other pieces
of code all over the place, so that a person can't fully understand what is
going on without paging back and forth to be reminded of conventions that
are defined elsewhere. We are now at the hub of the web.

The structure of \PB{\\{do\_statement}} itself is quite simple.  The first
token
of the statement is fetched using \PB{\\{get\_x\_next}}.  If it can be the
first
token of an expression, we look for an equation, an assignment, or a
title. Otherwise we use a \&{case} construction to branch at high speed to
the appropriate routine for various and sundry other types of commands,
each of which has an ``action procedure'' that does the necessary work.

The program uses the fact that
$$\hbox{\PB{$\\{min\_primary\_command}\K\\{max\_statement\_command}\K\\{type%
\_name}$}}$$
to interpret a statement that starts with, e.g., `\&{string}',
as a type declaration rather than a boolean expression.

\Y\B\&{static} \&{void} \\{worry\_about\_bad\_statement}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{flush\_unparsable\_junk\_after\_statement}(\&{MP} %
\\{mp});\7
\&{void} \\{mp\_do\_statement}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ governs \MP's activities }\1\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)>\\{mp\_max\_primary\_command}){}$\5
${}\{{}$\1\6
\\{worry\_about\_bad\_statement}(\\{mp});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)>\\{mp\_max\_statement\_command}){}$\5
${}\{{}$\C{ Do an equation, assignment, title, or      `$\langle\,$expression$%
\,\rangle\,$\&{endgroup}'; }\C{ The most important statements begin with
expressions }\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{mp}\MG\\{var\_flag}\K\\{mp\_assignment};{}$\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_end\_group}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_equals}){}$\1\5
\\{mp\_do\_equation}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_assignment}){}$\1\5
\\{mp\_do\_assignment}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_string\_type}){}$\5
${}\{{}$\C{ Do a title }\1\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_titles})))\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
\\{update\_terminal}(\,);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_vacuous}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ couldn't\ find\ an\ }\)\.{`='\
or\ `:='\ after\ th}\)\.{e"},\39\.{"expression\ that\ is\ }\)\.{shown\ above\
this\ err}\)\.{or\ message,"},\39\.{"so\ I\ guess\ I'll\ jus}\)\.{t\ ignore\ it%
\ and\ carr}\)\.{y\ on."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Isolated\ expression}\)\.{"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Do a statement that doesn't begin with an expression }\C{ If \PB{%
\\{do\_statement}} ends with \PB{$\\{cur\_cmd}\K\\{end\_group}$}, we should
have        \PB{$\\{cur\_type}\K\\{mp\_vacuous}$} unless the statement was
simply an expression;        in the latter case, \PB{\\{cur\_type}} and \PB{%
\\{cur\_exp}} should represent that        expression. }\1\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_commands})))\1%
\5
\\{show\_cur\_cmd\_mod};\2\6
\&{switch} (\\{cur\_cmd}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_type\_name}:\5
\\{mp\_do\_type\_declaration}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_macro\_def}:\6
\&{if} ${}(\\{cur\_mod}(\,)>\\{var\_def}){}$\1\5
\\{mp\_make\_op\_def}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)>\\{end\_def}){}$\1\5
\\{mp\_scan\_def}(\\{mp});\2\6
\&{break};\6
\4\&{case} \\{mp\_random\_seed}:\5
\\{mp\_do\_random\_seed}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_mode\_command}:\5
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{interaction}\K\\{cur\_mod}(\,);{}$\6
\\{initialize\_print\_selector}(\,);\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\1\5
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{selector}+\T{2};{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_protection\_command}:\5
\\{mp\_do\_protection}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_delimiters}:\5
\\{mp\_def\_delims}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_save\_command}:\5
\&{do}\5
${}\{{}$\1\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{mp\_save\_variable}(\\{mp},\39\\{cur\_sym}(\,));{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\&{break};\6
\4\&{case} \\{mp\_interim\_command}:\5
\\{mp\_do\_interim}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_let\_command}:\5
\\{mp\_do\_let}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_new\_internal}:\5
\\{mp\_do\_new\_internal}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_show\_command}:\5
\\{mp\_do\_show\_whatever}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_add\_to\_command}:\5
\\{mp\_do\_add\_to}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_bounds\_command}:\5
\\{mp\_do\_bounds}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_ship\_out\_command}:\5
\\{mp\_do\_ship\_out}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_every\_job\_command}:\5
\\{mp\_get\_symbol}(\\{mp});\6
${}\\{mp}\MG\\{start\_sym}\K\\{cur\_sym}(\,);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_message\_command}:\5
\\{mp\_do\_message}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_write\_command}:\5
\\{mp\_do\_write}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_tfm\_command}:\5
\\{mp\_do\_tfm\_command}(\\{mp});\6
\&{break};\6
\4\&{case} \\{mp\_special\_command}:\6
\&{if} ${}(\\{cur\_mod}(\,)\E\T{0}){}$\1\5
\\{mp\_do\_special}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{cur\_mod}(\,)\E\T{1}){}$\1\5
\\{mp\_do\_mapfile}(\\{mp});\2\6
\&{else}\1\5
\\{mp\_do\_mapline}(\\{mp});\2\6
\&{break};\6
\4\&{default}:\5
\&{break};\C{ make the compiler happy }\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_semicolon}){}$\1\5
\\{flush\_unparsable\_junk\_after\_statement}(\\{mp});\2\6
${}\\{mp}\MG\\{error\_count}\K\T{0};{}$\6
\4${}\}{}$\2\par
\fi

\M{1033}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X\par
\fi

\M{1034}The only command codes \PB{$>$ \\{max\_primary\_command}} that can be
present
at the beginning of a statement are \PB{\\{semicolon}} and higher; these
occur when the statement is null.

\Y\B\&{static} \&{void} \\{worry\_about\_bad\_statement}(\&{MP} \\{mp})\1\1\2\2%
\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_semicolon}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ was\ looking\ for\ t}\)\.{he\
beginning\ of\ a\ ne}\)\.{w\ statement."},\39\.{"If\ you\ just\ proceed}\)\.{\
without\ changing\ an}\)\.{ything,\ I'll\ ignore"},\39\.{"everything\ up\ to\
th}\)\.{e\ next\ `;'.\ Please\ i}\)\.{nsert\ a\ semicolon"},\39\.{"now\ in\
front\ of\ any}\)\.{thing\ that\ you\ don't}\)\.{\ want\ me\ to\ delete."},\39%
\.{"(See\ Chapter\ 27\ of\ }\)\.{The\ METAFONTbook\ for}\)\.{\ an\ example.)"},%
\39\NULL\};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{cur\_cmd}(\,),\39\\{cur\_mod}(\,));{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"A\ statement\ can't\ b}\)\.{egin\
with\ `\%s'"},\39\\{mp\_str}(\\{mp},\39\\{sname}));{}$\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1035}The help message printed here says that everything is flushed up to
a semicolon, but actually the commands \PB{\\{end\_group}} and \PB{\\{stop}}
will
also terminate a statement.

\Y\B\&{static} \&{void} \\{flush\_unparsable\_junk\_after\_statement}(\&{MP} %
\\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I've\ just\ read\ as\ m}\)\.{uch\
of\ that\ statemen}\)\.{t\ as\ I\ could\ fathom,}\)\.{"},\39\.{"so\ a\
semicolon\ shou}\)\.{ld\ have\ been\ next.\ I}\)\.{t's\ very\ puzzling...}\)%
\.{"},\39\.{"but\ I'll\ try\ to\ get}\)\.{\ myself\ back\ togethe}\)\.{r,\ by\
ignoring"},\39\.{"everything\ up\ to\ th}\)\.{e\ next\ `;'.\ Please\ i}\)%
\.{nsert\ a\ semicolon"},\39\.{"now\ in\ front\ of\ any}\)\.{thing\ that\ you\
don't}\)\.{\ want\ me\ to\ delete."},\39\.{"(See\ Chapter\ 27\ of\ }\)\.{The\
METAFONTbook\ for}\)\.{\ an\ example.)"},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Extra\ tokens\ will\ b}\)\.{e\ flushed"},%
\39\\{hlp},\39\\{true});{}$\6
${}\\{mp}\MG\\{scanner\_status}\K\\{flushing};{}$\6
\&{do}\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_string\_token}){}$\5
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{cur\_mod\_str}(\,));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\R\\{mp\_end\_of\_statement}){}$;\C{ \PB{$\\{cur\_cmd}\K%
\\{semicolon}$}, \PB{\\{end\_group}}, or \PB{\\{stop}} }\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\4${}\}{}$\2\par
\fi

\M{1036}Equations and assignments are performed by the pair of mutually
recursive
routines \PB{\\{do\_equation}} and \PB{\\{do\_assignment}}. These routines are
called when
\PB{$\\{cur\_cmd}\K\\{equals}$} and when \PB{$\\{cur\_cmd}\K\\{assignment}$},
respectively; the left-hand
side is in \PB{\\{cur\_type}} and \PB{\\{cur\_exp}}, while the right-hand side
is yet
to be scanned. After the routines are finished, \PB{\\{cur\_type}} and \PB{%
\\{cur\_exp}}
will be equal to the right-hand side (which will normally be equal
to the left-hand side).

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\X1040:Declare the procedure called \PB{\\{make\_eq}}\X;\7
\&{static} \&{void} \\{mp\_do\_equation}(\&{MP} \\{mp});\par
\fi

\M{1037}\B\&{static} \&{void} \\{trace\_equation}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{("});{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\\{lhs},\39\T{0});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{")=("});{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{0});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{")\}"});{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_do\_equation}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{lhs};\C{ capsule for the left-hand side }\7
${}\\{lhs}\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{var\_flag}\K\\{mp\_assignment};{}$\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_equals}){}$\1\5
\\{mp\_do\_equation}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_assignment}){}$\1\5
\\{mp\_do\_assignment}(\\{mp});\2\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\5
${}\{{}$\1\6
${}\\{trace\_equation}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_unknown\_path}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{lhs})\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ temporary register }\7
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\\{lhs});{}$\6
${}\\{lhs}\K\|p;{}$\6
\4${}\}{}$\C{ in this case \PB{\\{make\_eq}} will change the pair to a path }\2%
\6
\4${}\}{}$\2\6
${}\\{mp\_make\_eq}(\\{mp},\39\\{lhs}){}$;\C{ equate \PB{\\{lhs}} to \PB{$(%
\\{cur\_type},\\{cur\_exp})$} }\6
\4${}\}{}$\2\par
\fi

\M{1038}And \PB{\\{do\_assignment}} is similar to \PB{\\{do\_equation}}:

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_assignment}(\&{MP} \\{mp});\par
\fi

\M{1039}\B\&{static} \&{void} \\{bad\_lhs}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ didn't\ find\ a\ var}\)\.{iable\
name\ at\ the\ le}\)\.{ft\ of\ the\ `:=',"},\39\.{"so\ I'm\ going\ to\ pre}\)%
\.{tend\ that\ you\ said\ `}\)\.{='\ instead."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_error}(\\{mp},\39\.{"Improper\ `:='\ will\ }\)\.{be\ changed\ to\
`='"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_do\_equation}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{bad\_internal\_assignment}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ can\\'t\ set\ this\ i}\)%
\.{nternal\ quantity\ to\ }\)\.{anything\ but\ a\ known}\)\.{"},\39\.{"numeric\
value,\ so\ I}\)\.{'ll\ have\ to\ ignore\ t}\)\.{his\ assignment."},\39\NULL%
\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
\&{if} ${}(\\{internal\_type}(\\{mp\_sym\_info}(\\{lhs}))\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Internal\ quantity\ `}\)\.{\%s'\
must\ receive\ a\ k}\)\.{nown\ numeric\ value"},\39\\{internal\_name}(\\{mp%
\_sym\_info}(\\{lhs})));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Internal\ quantity\ `}\)\.{\%s'\
must\ receive\ a\ k}\)\.{nown\ string"},\39\\{internal\_name}(\\{mp\_sym%
\_info}(\\{lhs})));{}$\6
${}\\{hlp}[\T{1}]\K\.{"string,\ so\ I'll\ hav}\)\.{e\ to\ ignore\ this\ ass}\)%
\.{ignment."};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{forbidden\_internal\_assignment}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ can\\'t\ set\ this\ i}\)%
\.{nternal\ quantity\ to\ }\)\.{anything\ just\ yet"},\39\.{"(it\ is\
read-only),\ }\)\.{so\ I'll\ have\ to\ igno}\)\.{re\ this\ assignment."},\39%
\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Internal\ quantity\ `}\)\.{\%s'\
is\ read-only"},\39\\{internal\_name}(\\{mp\_sym\_info}(\\{lhs})));{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{bad\_internal\_assignment\_precision}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \\{lhs}${},\39{}$\&{mp\_number} \\{min}${},\39{}$\&{mp%
\_number} \\{max})\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{char} \|s[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Precision\ values\ ar}\)\.{e\
limited\ by\ the\ cur}\)\.{rent\ numbersystem."},\39\NULL,\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Bad\ '\%s'\ has\ been\ i}\)%
\.{gnored"},\39\\{internal\_name}(\\{mp\_sym\_info}(\\{lhs})));{}$\6
${}\\{mp\_snprintf}(\|s,\39\T{256},\39\.{"Currently\ I\ am\ usin}\)\.{g\ '\%s';%
\ the\ allowed\ }\)\.{precision\ range\ is\ [}\)\.{\%s,\%s]."},\39\\{mp\_str}(%
\\{mp},\39\\{internal\_string}(\\{mp\_number\_system})),\39\\{number%
\_tostring}(\\{min}),\39\\{number\_tostring}(\\{max}));{}$\6
${}\\{hlp}[\T{1}]\K\|s;{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{bad\_expression\_assignment}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"It\ seems\ you\ did\ a\ }\)\.{nasty%
\ thing---probab}\)\.{ly\ by\ accident,"},\39\.{"but\ nevertheless\ yo}\)\.{u\
nearly\ hornswoggle}\)\.{d\ me..."},\39\.{"While\ I\ was\ evaluat}\)\.{ing\ the%
\ right-hand\ s}\)\.{ide\ of\ this"},\39\.{"command,\ something\ }\)%
\.{happened,\ and\ the\ le}\)\.{ft-hand\ side"},\39\.{"is\ no\ longer\ a\ vari}%
\)\.{able!\ So\ I\ won't\ cha}\)\.{nge\ anything."},\39\NULL\};{}$\6
\&{char} ${}{*}\\{msg}\K\\{mp\_obliterated}(\\{mp},\39\\{lhs});{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{free}(\\{msg});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{trace\_assignment}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{"});{}$\6
\&{if} ${}(\\{mp\_name\_type}(\\{lhs})\E\\{mp\_internal\_sym}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\\{internal\_name}(\\{mp\_sym\_info}(\\{lhs})));{}$%
\2\6
\&{else}\1\5
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{lhs},\39\NULL,\39\T{1000},\39%
\T{0});{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{":="});{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{0});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_do\_assignment}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_token\_list}){}$\5
${}\{{}$\1\6
\\{bad\_lhs}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_node} \\{lhs};\C{ token list for the left-hand side }\7
${}\\{lhs}\K\\{cur\_exp\_node}(\,);{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{var\_flag}\K\\{mp\_assignment};{}$\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_equals}){}$\1\5
\\{mp\_do\_equation}(\\{mp});\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_assignment}){}$\1\5
\\{mp\_do\_assignment}(\\{mp});\2\6
\&{if} ${}(\\{number\_greater}(\\{internal\_value}(\\{mp\_tracing\_commands}),%
\39\\{two\_t})){}$\5
${}\{{}$\1\6
${}\\{trace\_assignment}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp\_name\_type}(\\{lhs})\E\\{mp\_internal\_sym}){}$\5
${}\{{}$\C{ Assign the current expression to an internal variable }\1\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}\V\\{mp}\MG\\{cur%
\_exp}.\\{type}\E\\{mp\_string\_type})\W(\\{internal\_type}(\\{mp\_sym\_info}(%
\\{lhs}))\E\\{mp}\MG\\{cur\_exp}.\\{type})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_sym\_info}(\\{lhs})\E\\{mp\_number\_system}){}$\5
${}\{{}$\1\6
${}\\{forbidden\_internal\_assignment}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_sym\_info}(\\{lhs})\E\\{mp\_number\_precision}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}\W(\R\\{number%
\_less}(\\{cur\_exp\_value\_number}(\,),\39\\{precision\_min}))\W(\R\\{number%
\_greater}(\\{cur\_exp\_value\_number}(\,),\39\\{precision\_max})))){}$\5
${}\{{}$\1\6
${}\\{bad\_internal\_assignment\_precision}(\\{mp},\39\\{lhs},\39\\{precision%
\_min},\39\\{precision\_max});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_internal\_from\_cur\_exp}(\\{mp\_sym\_info}(\\{lhs}));\6
\\{set\_precision}(\,);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_internal\_from\_cur\_exp}(\\{mp\_sym\_info}(\\{lhs}));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{bad\_internal\_assignment}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Assign the current expression to the variable \PB{\\{lhs}} }\1\6
\&{mp\_node} \|p;\C{ where the left-hand value is stored }\6
\&{mp\_node} \|q;\C{ temporary capsule for the right-hand value }\7
${}\|p\K\\{mp\_find\_variable}(\\{mp},\39\\{lhs});{}$\6
\&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\|q\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_und\_type}(\\{mp},\39\|p);{}$\6
${}\\{mp\_recycle\_value}(\\{mp},\39\|p);{}$\6
${}\\{mp\_type}(\|p)\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
${}\\{set\_value\_number}(\|p,\39\\{zero\_t});{}$\6
${}\\{mp\_make\_exp\_copy}(\\{mp},\39\|p);{}$\6
${}\|p\K\\{mp\_stash\_cur\_exp}(\\{mp});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\|q);{}$\6
${}\\{mp\_make\_eq}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{bad\_expression\_assignment}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1040}And now we get to the nitty-gritty. The \PB{\\{make\_eq}} procedure is
given
a pointer to a capsule that is to be equated to the current expression.

\Y\B\4\X1040:Declare the procedure called \PB{\\{make\_eq}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_make\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} %
\\{lhs});\par
\U1036.\fi

\M{1041}
\Y\B\&{static} \&{void} \\{announce\_bad\_equation}(\&{MP} \\{mp}${},\39{}$%
\&{mp\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ sorry,\ but\ I\ do}\)\.{n't\
know\ how\ to\ make}\)\.{\ such\ things\ equal."},\39\.{"(See\ the\ two\
expres}\)\.{sions\ just\ above\ the}\)\.{\ error\ message.)"},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Equation\ cannot\ be\ }\)%
\.{performed\ (\%s=\%s)"},\39(\\{mp\_type}(\\{lhs})\Z\\{mp\_pair\_type}\?\\{mp%
\_type\_string}(\\{mp\_type}(\\{lhs})):\.{"numeric"}),\39(\\{mp}\MG\\{cur%
\_exp}.\\{type}\Z\\{mp\_pair\_type}\?\\{mp\_type\_string}(\\{mp}\MG\\{cur%
\_exp}.\\{type}):\.{"numeric"}));{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\\{lhs});{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{exclaim\_inconsistent\_equation}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ equation\ I\ just}\)\.{\ read\
contradicts\ wh}\)\.{at\ was\ said\ before."},\39\.{"But\ don't\ worry;\ co}\)%
\.{ntinue\ and\ I'll\ just}\)\.{\ ignore\ it."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Inconsistent\ equati}\)\.{on"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{exclaim\_redundant\_or\_inconsistent\_equation}(\&{MP} %
\\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"An\ equation\ between}\)\.{\
already-known\ quant}\)\.{ities\ can't\ help."},\39\.{"But\ don't\ worry;\ co}%
\)\.{ntinue\ and\ I'll\ just}\)\.{\ ignore\ it."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Redundant\ or\ incons}\)\.{istent\
equation"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{report\_redundant\_or\_inconsistent\_equation}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_node} \\{lhs}${},\39{}$\&{mp\_number} \|v)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\Z\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_str\_vs\_str}(\\{mp},\39\\{value\_str}(\\{lhs}),\39\\{cur%
\_exp\_str}(\,))\I\T{0}){}$\5
${}\{{}$\1\6
\\{exclaim\_inconsistent\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{exclaim\_redundant\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\R\\{number\_equal}(\|v,\39\\{cur\_exp\_value\_number}(%
\,))){}$\5
${}\{{}$\1\6
\\{exclaim\_inconsistent\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{exclaim\_redundant\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{exclaim\_redundant\_or\_inconsistent\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{void} \\{mp\_make\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \\{lhs})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
\\{mp\_variable\_type}\|t;\C{ type of the left-hand side }\7
\&{mp\_number} \|v;\C{ value of the left-hand side }\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
\\{new\_number}(\|v);\6
\4\.{RESTART}:\5
${}\|t\K\\{mp\_type}(\\{lhs});{}$\6
\&{if} ${}(\|t\Z\\{mp\_pair\_type}){}$\1\5
${}\\{number\_clone}(\|v,\39\\{value\_number}(\\{lhs})){}$;\C{ For each type %
\PB{\|t}, make an equation or complain if \PB{\\{cur\_type}}      is
incompatible with~\PB{\|t} }\2\6
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_boolean\_type}:\5
\&{case} \\{mp\_string\_type}:\5
\&{case} \\{mp\_pen\_type}:\5
\&{case} \\{mp\_path\_type}:\5
\&{case} \\{mp\_picture\_type}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\|t+\\{unknown\_tag}){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\|t\E\\{mp\_boolean\_type}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{new\_expr}.\\{data}.\|n,\39\|v);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{str}\K\\{value\_str}(\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
${}\\{new\_expr}.\\{data}.\\{node}\K\\{value\_node}(\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ pen or path }\1\6
${}\\{new\_expr}.\\{data}.\|p\K\\{value\_knot}(\\{lhs});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_nonlinear\_eq}(\\{mp},\39\\{new\_expr},\39\\{cur\_exp\_node}(\,),\39%
\\{false});{}$\6
${}\\{mp\_unstash\_cur\_exp}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\|t){}$\5
${}\{{}$\1\6
${}\\{report\_redundant\_or\_inconsistent\_equation}(\\{mp},\39\\{lhs},\39%
\|v);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{unknown\_types}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\|t-\\{unknown\_tag}){}$\5
${}\{{}$\1\6
${}\\{mp\_nonlinear\_eq}(\\{mp},\39\\{mp}\MG\\{cur\_exp},\39\\{lhs},\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\|t){}$\5
${}\{{}$\1\6
${}\\{mp\_ring\_merge}(\\{mp},\39\\{lhs},\39\\{cur\_exp\_node}(\,));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|t\E\\{mp\_unknown\_path}){}$\5
${}\{{}$\1\6
\\{mp\_pair\_to\_path}(\\{mp});\6
\&{goto} \.{RESTART};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_transform\_type}:\5
\&{case} \\{mp\_color\_type}:\5
\&{case} \\{mp\_cmykcolor\_type}:\5
\&{case} \\{mp\_pair\_type}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\|t){}$\5
${}\{{}$\C{ Do multiple equations }\1\6
\&{mp\_node} \|q${}\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\&{mp\_node} \|p${}\K\\{value\_node}(\\{lhs});{}$\7
\&{switch} (\|t)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_transform\_type}:\5
${}\\{mp\_try\_eq}(\\{mp},\39\\{yy\_part}(\|p),\39\\{yy\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{yx\_part}(\|p),\39\\{yx\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{xy\_part}(\|p),\39\\{xy\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{xx\_part}(\|p),\39\\{xx\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{ty\_part}(\|p),\39\\{ty\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{tx\_part}(\|p),\39\\{tx\_part}(\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_color\_type}:\5
${}\\{mp\_try\_eq}(\\{mp},\39\\{blue\_part}(\|p),\39\\{blue\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{green\_part}(\|p),\39\\{green\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{red\_part}(\|p),\39\\{red\_part}(\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_cmykcolor\_type}:\5
${}\\{mp\_try\_eq}(\\{mp},\39\\{black\_part}(\|p),\39\\{black\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{yellow\_part}(\|p),\39\\{yellow\_part}(%
\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{magenta\_part}(\|p),\39\\{magenta\_part}(%
\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{cyan\_part}(\|p),\39\\{cyan\_part}(\|q));{}$\6
\&{break};\6
\4\&{case} \\{mp\_pair\_type}:\5
${}\\{mp\_try\_eq}(\\{mp},\39\\{y\_part}(\|p),\39\\{y\_part}(\|q));{}$\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{x\_part}(\|p),\39\\{x\_part}(\|q));{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_known}:\5
\&{case} \\{mp\_dependent}:\5
\&{case} \\{mp\_proto\_dependent}:\5
\&{case} \\{mp\_independent}:\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\G\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{mp\_try\_eq}(\\{mp},\39\\{lhs},\39\NULL);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_vacuous}:\5
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
${}\\{announce\_bad\_equation}(\\{mp},\39\\{lhs});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\\{check\_arith}(\,);\6
${}\\{mp\_recycle\_value}(\\{mp},\39\\{lhs});{}$\6
\\{free\_number}(\|v);\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{lhs});{}$\6
\4${}\}{}$\2\par
\fi

\M{1042}The first argument to \PB{\\{try\_eq}} is the location of a value node
in a capsule that will soon be recycled. The second argument is
either a location within a pair or transform node pointed to by
\PB{\\{cur\_exp}}, or it is \PB{$\NULL$} (which means that \PB{\\{cur\_exp}}
itself
serves as the second argument). The idea is to leave \PB{\\{cur\_exp}}
unchanged,
but to equate the two operands.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_try\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|l${},%
\39{}$\&{mp\_node} \|r);\par
\fi

\M{1043}
\Y\B\4\D$\\{equation\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{equation\_threshold%
\_t}\par
\Y\B\&{static} \&{void} \\{deal\_with\_redundant\_or\_inconsistent\_equation}(%
\&{MP} \\{mp}${},\39{}$\&{mp\_value\_node} \|p${},\39{}$\&{mp\_node} \|r)\1\1\2%
\2\6
${}\{{}$\1\6
\&{mp\_number} \\{absp};\7
\\{new\_number}(\\{absp});\6
${}\\{number\_clone}(\\{absp},\39\\{value\_number}(\|p));{}$\6
\\{number\_abs}(\\{absp});\6
\&{if} ${}(\\{number\_greater}(\\{absp},\39\\{equation\_threshold\_k})){}$\5
${}\{{}$\C{ off by .001 or more }\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ equation\ I\ just}\)\.{\ read\
contradicts\ wh}\)\.{at\ was\ said\ before."},\39\.{"But\ don't\ worry;\ co}\)%
\.{ntinue\ and\ I'll\ just}\)\.{\ ignore\ it."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Inconsistent\ equati}\)\.{on\
(off\ by\ \%s)"},\39\\{number\_tostring}(\\{value\_number}(\|p)));{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|r\E\NULL){}$\5
${}\{{}$\1\6
\\{exclaim\_redundant\_equation}(\\{mp});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absp});\6
${}\\{mp\_free\_dep\_node}(\\{mp},\39\|p);{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_try\_eq}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|l${},\39{}$\&{mp%
\_node} \|r)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p;\C{ dependency list for right operand minus left
operand }\7
\\{mp\_variable\_type}\|t;\C{ the type of list \PB{\|p} }\7
\&{mp\_value\_node} \|q;\C{ the constant term of \PB{\|p} is here }\6
\&{mp\_value\_node} \\{pp};\C{ dependency list for right operand }\7
\\{mp\_variable\_type}\\{tt};\C{ the type of list \PB{\\{pp}} }\7
\&{boolean} \\{copied};\C{ have we copied a list that ought to be recycled? }%
\C{ Remove the left operand from its container, negate it, and      put it into
dependency list~\PB{\|p} with constant term~\PB{\|q} }\7
${}\|t\K\\{mp\_type}(\|l);{}$\6
\&{if} ${}(\|t\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\\{value\_number}(\|l));{}$\6
\\{number\_negate}(\\{arg1});\6
${}\|t\K\\{mp\_dependent};{}$\6
${}\|p\K\\{mp\_const\_dependency}(\\{mp},\39\\{arg1});{}$\6
${}\|q\K\|p;{}$\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_independent}){}$\5
${}\{{}$\1\6
${}\|t\K\\{mp\_dependent};{}$\6
${}\|p\K\\{mp\_single\_dependency}(\\{mp},\39\|l);{}$\6
\\{number\_negate}(\\{dep\_value}(\|p));\6
${}\|q\K\\{mp}\MG\\{dep\_final};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_value\_node} \\{ll}${}\K{}$(\&{mp\_value\_node}) \|l;\7
${}\|p\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\\{ll});\6
${}\|q\K\|p;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{number\_negate}(\\{dep\_value}(\|q));\6
\&{if} ${}(\\{dep\_info}(\|q)\E\NULL){}$\1\5
\&{break};\2\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\\{prev\_dep}(\\{ll}))\K\\{mp\_link}(\|q);{}$\6
\\{set\_prev\_dep}((\&{mp\_value\_node}) \\{mp\_link}(\|q)${},\39\\{prev\_dep}(%
\\{ll}));{}$\6
${}\\{mp\_type}(\\{ll})\K\\{mp\_known};{}$\6
\4${}\}{}$\C{ Add the right operand to list \PB{\|p} }\2\6
\&{if} ${}(\|r\E\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{value\_number}(\|q),\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\&{goto} \.{DONE1};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{tt}\K\\{mp}\MG\\{cur\_exp}.\\{type};{}$\6
\&{if} ${}(\\{tt}\E\\{mp\_independent}){}$\1\5
${}\\{pp}\K\\{mp\_single\_dependency}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\2\6
\&{else}\1\5
${}\\{pp}\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \\{cur%
\_exp\_node}(\,));\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|r)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\\{number\_add}(\\{dep\_value}(\|q),\39\\{value\_number}(\|r));{}$\6
\&{goto} \.{DONE1};\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{tt}\K\\{mp\_type}(\|r);{}$\6
\&{if} ${}(\\{tt}\E\\{mp\_independent}){}$\1\5
${}\\{pp}\K\\{mp\_single\_dependency}(\\{mp},\39\|r);{}$\2\6
\&{else}\1\5
${}\\{pp}\K{}$(\&{mp\_value\_node}) \\{dep\_list}((\&{mp\_value\_node}) \|r);\2%
\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{tt}\I\\{mp\_independent}){}$\5
${}\{{}$\1\6
${}\\{copied}\K\\{false};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{copied}\K\\{true};{}$\6
${}\\{tt}\K\\{mp\_dependent};{}$\6
\4${}\}{}$\C{ Add dependency list \PB{\\{pp}} of type \PB{\\{tt}} to dependency
list~\PB{\|p} of type~\PB{\|t} }\2\6
${}\\{mp}\MG\\{watch\_coefs}\K\\{false};{}$\6
\&{if} ${}(\|t\E\\{tt}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_p\_plus\_q}(\\{mp},\39\|p,\39\\{pp},\39{}$(\&{quarterword}) %
\|t);\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_proto\_dependent}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_p\_plus\_fq}(\\{mp},\39\|p,\39\\{unity\_t},\39\\{pp},\39\\{mp%
\_proto\_dependent},\39\\{mp\_dependent});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_number} \|x;\7
\\{new\_number}(\|x);\6
${}\|q\K\|p;{}$\6
\&{while} ${}(\\{dep\_info}(\|q)\I\NULL){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{dep\_value}(\|q));{}$\6
\\{fraction\_to\_round\_scaled}(\|x);\6
${}\\{set\_dep\_value}(\|q,\39\|x);{}$\6
${}\|q\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|q);\6
\4${}\}{}$\2\6
\\{free\_number}(\|x);\6
${}\|t\K\\{mp\_proto\_dependent};{}$\6
${}\|p\K\\{mp\_p\_plus\_q}(\\{mp},\39\|p,\39\\{pp},\39{}$(\&{quarterword}) %
\|t);\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{watch\_coefs}\K\\{true};{}$\6
\&{if} (\\{copied})\1\5
${}\\{mp\_flush\_node\_list}(\\{mp},\39{}$(\&{mp\_node}) \\{pp});\2\6
\4\.{DONE1}:\6
\&{if} ${}(\\{dep\_info}(\|p)\E\NULL){}$\5
${}\{{}$\1\6
${}\\{deal\_with\_redundant\_or\_inconsistent\_equation}(\\{mp},\39\|p,\39%
\|r);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_linear\_eq}(\\{mp},\39\|p,\39{}$(\&{quarterword}) \|t);\6
\&{if} ${}(\|r\E\NULL\W\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{cur\_exp\_node}(\,))\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{mp\_node} \\{pp}${}\K\\{cur\_exp\_node}(\,);{}$\7
\\{set\_cur\_exp\_value\_number}(\\{value\_number}(\\{pp}));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_known};{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{pp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1044}Our next goal is to process type declarations. For this purpose it's
convenient to have a procedure that scans a $\langle\,$declared
variable$\,\rangle$ and returns the corresponding token list. After the
following procedure has acted, the token after the declared variable
will have been scanned, so it will appear in \PB{\\{cur\_cmd}}, \PB{\\{cur%
\_mod}},
and~\PB{\\{cur\_sym}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{mp\_scan\_declared\_variable}(\&{MP} \\{mp});\par
\fi

\M{1045}\B\&{mp\_node} \\{mp\_scan\_declared\_variable}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \|x;\C{ hash address of the variable's root }\6
\&{mp\_node} \|h${},{}$ \|t;\C{ head and tail of the token list to be returned
}\7
\\{mp\_get\_symbol}(\\{mp});\6
${}\|x\K\\{cur\_sym}(\,);{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_tag\_token}){}$\1\5
${}\\{mp\_clear\_symbol}(\\{mp},\39\|x,\39\\{false});{}$\2\6
${}\|h\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\\{set\_mp\_sym\_sym}(\|h,\39\|x);{}$\6
${}\|t\K\|h;{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_sym}(\,)\E\NULL){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_tag\_token}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_internal\_quantity}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_bracket}){}$\5
${}\{{}$\C{ Descend past a collective subscript }\C{ If the subscript isn't
collective, we don't accept it as part of the   	     declared variable. }\1\6
\&{mp\_sym} \\{ll}${}\K\\{cur\_sym}(\,){}$;\C{ hash address of left bracket }\7
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_right\_bracket}){}$\5
${}\{{}$\1\6
\\{set\_cur\_sym}(\\{collective\_subscript});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
\\{set\_cur\_sym}(\\{ll});\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_left\_bracket});\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\|t)\K\\{mp\_get\_symbolic\_node}(\\{mp});{}$\6
${}\|t\K\\{mp\_link}(\|t);{}$\6
${}\\{set\_mp\_sym\_sym}(\|t,\39\\{cur\_sym}(\,));{}$\6
${}\\{mp\_name\_type}(\|t)\K\\{cur\_sym\_mod}(\,);{}$\6
\4${}\}{}$\2\6
\&{if} ${}((\\{eq\_type}(\|x)\MOD\\{mp\_outer\_tag})\I\\{mp\_tag\_token}){}$\1\5
${}\\{mp\_clear\_symbol}(\\{mp},\39\|x,\39\\{false});{}$\2\6
\&{if} ${}(\\{equiv\_node}(\|x)\E\NULL){}$\1\5
${}\\{mp\_new\_root}(\\{mp},\39\|x);{}$\2\6
\&{return} \|h;\6
\4${}\}{}$\2\par
\fi

\M{1046}Type declarations are introduced by the following primitive operations.

\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"numeric"},\39\\{mp\_type\_name},\39\\{mp%
\_numeric\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"string"},\39\\{mp\_type\_name},\39\\{mp%
\_string\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"boolean"},\39\\{mp\_type\_name},\39\\{mp%
\_boolean\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"path"},\39\\{mp\_type\_name},\39\\{mp\_path%
\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"pen"},\39\\{mp\_type\_name},\39\\{mp\_pen%
\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"picture"},\39\\{mp\_type\_name},\39\\{mp%
\_picture\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"transform"},\39\\{mp\_type\_name},\39\\{mp%
\_transform\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"color"},\39\\{mp\_type\_name},\39\\{mp%
\_color\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"rgbcolor"},\39\\{mp\_type\_name},\39\\{mp%
\_color\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"cmykcolor"},\39\\{mp\_type\_name},\39\\{mp%
\_cmykcolor\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"pair"},\39\\{mp\_type\_name},\39\\{mp\_pair%
\_type}){}$;\par
\fi

\M{1047}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_type\_name}:\5
${}\\{mp\_print\_type}(\\{mp},\39{}$(\&{quarterword}) \|m);\6
\&{break};\par
\fi

\M{1048}Now we are ready to handle type declarations, assuming that a
\PB{\\{type\_name}} has just been scanned.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\E{}$\6
\&{static} \&{void} \\{mp\_do\_type\_declaration}(\&{MP} \\{mp});\par
\As1074, 1083, 1086, 1091, 1093, 1101, 1103, 1107, 1109, 1111, 1115, 1117,
1119, 1124, 1126, 1131, 1133, 1135, 1137, 1145, 1153, 1177, 1179, 1182, 1244%
\ETs1264.
\U1033.\fi

\M{1049}\B\&{static} \&{void} \\{flush\_spurious\_symbols\_after\_declared%
\_variable}(\&{MP} \\{mp});\7
\&{void} \\{mp\_do\_type\_declaration}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \|t;\C{ the type being declared }\6
\&{mp\_node} \|p;\C{ token list for a declared variable }\6
\&{mp\_node} \|q;\C{ value node for the variable }\7
\&{if} ${}(\\{cur\_mod}(\,)\G\\{mp\_transform\_type}){}$\1\5
${}\|t\K{}$(\&{quarterword}) \\{cur\_mod}(\,);\2\6
\&{else}\1\5
${}\|t\K(\&{quarterword})(\\{cur\_mod}(\,)+\\{unknown\_tag});{}$\2\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_scan\_declared\_variable}(\\{mp});{}$\6
${}\\{mp\_flush\_variable}(\\{mp},\39\\{equiv\_node}(\\{mp\_sym\_sym}(\|p)),\39%
\\{mp\_link}(\|p),\39\\{false});{}$\6
${}\|q\K\\{mp\_find\_variable}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_type}(\|q)\K\|t;{}$\6
${}\\{set\_value\_number}(\|q,\39\\{zero\_t}){}$;\C{ todo: this was \PB{%
\\{null}} }\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You\ can't\ use,\ e.g.}\)\.{,\
`numeric\ foo[]'\ af}\)\.{ter\ `vardef\ foo'."},\39\.{"Proceed,\ and\ I'll\ i}%
\)\.{gnore\ the\ illegal\ re}\)\.{declaration."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Declared\ variable\ c}\)\.{onflicts\ with\
previo}\)\.{us\ vardef"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)<\\{mp\_comma}){}$\5
${}\{{}$\1\6
\\{flush\_spurious\_symbols\_after\_declared\_variable}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\R\\{mp\_end\_of\_statement});{}$\6
\4${}\}{}$\2\par
\fi

\M{1050}
\Y\B\&{static} \&{void} \\{flush\_spurious\_symbols\_after\_declared%
\_variable}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Variables\ in\ declar}\)\.{ations\
must\ consist\ }\)\.{entirely\ of"},\39\.{"names\ and\ collectiv}\)\.{e\
subscripts,\ e.g.,\ }\)\.{`x[]a'."},\39\.{"Are\ you\ trying\ to\ u}\)\.{se\ a\
reserved\ word\ i}\)\.{n\ a\ variable\ name?"},\39\.{"I'm\ going\ to\ discar}\)%
\.{d\ the\ junk\ I\ found\ h}\)\.{ere,"},\39\.{"up\ to\ the\ next\ comm}\)\.{a\
or\ the\ end\ of\ the\ }\)\.{declaration."},\39\NULL\};{}$\7
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_numeric\_token}){}$\1\5
${}\\{hlp}[\T{2}]\K\.{"Explicit\ subscripts}\)\.{\ like\ `x15a'\ aren't\ }\)%
\.{permitted."};{}$\2\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Illegal\ suffix\ of\ d}\)\.{eclared\
variable\ wil}\)\.{l\ be\ flushed"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{scanner\_status}\K\\{flushing};{}$\6
\&{do}\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\X812:Decrease the string reference count, if the current token is a string\X;\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)<\\{mp\_comma}){}$;\C{ break on either \PB{\\{end%
\_of\_statement}} or \PB{\\{comma}} }\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\4${}\}{}$\2\par
\fi

\M{1051}\MP's \PB{\\{main\_control}} procedure just calls \PB{\\{do%
\_statement}} repeatedly
until coming to the end of the user's program.
Each execution of \PB{\\{do\_statement}} concludes with
\PB{$\\{cur\_cmd}\K\\{semicolon}$}, \PB{\\{end\_group}}, or \PB{\\{stop}}.

\Y\B\&{static} \&{void} \\{mp\_main\_control}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_do\_statement}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_end\_group}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ not\ currently\ w}\)\.{orking\
on\ a\ `begingr}\)\.{oup',"},\39\.{"so\ I\ had\ better\ not}\)\.{\ try\ to\ end%
\ anything}\)\.{."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_error}(\\{mp},\39\.{"Extra\ `endgroup'"},\39\\{hlp},\39\\{true});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\I\\{mp\_stop});{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_run}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{history}<\\{mp\_fatal\_error\_stop}){}$\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{jump\_buf});{}$\6
${}\\{mp}\MG\\{jump\_buf}\K\\{malloc}(\&{sizeof}(\&{jmp\_buf}));{}$\6
\&{if} ${}(\\{mp}\MG\\{jump\_buf}\E\NULL\V\\{setjmp}({*}(\\{mp}\MG\\{jump%
\_buf}))\I\T{0}){}$\1\5
\&{return} \\{mp}${}\MG\\{history};{}$\2\6
\\{mp\_main\_control}(\\{mp});\C{ come to life }\6
\\{mp\_final\_cleanup}(\\{mp});\C{ prepare for death }\6
\\{mp\_close\_files\_and\_terminate}(\\{mp});\6
\4${}\}{}$\2\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\par
\fi

\M{1052}This function allows setting of internals from an external
source (like the command line or a controlling application).

It accepts two \PB{\&{char} ${}{*}$}'s, even for numeric assignments when
it calls \PB{\\{atoi}} to get an integer from the start of the string.

\Y\B\&{void} \\{mp\_set\_internal}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}\|n,%
\39{}$\&{char} ${}{*}\|v,\39{}$\&{int} \\{isstring})\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|l${}\K\\{strlen}(\|n);{}$\6
\&{char} \\{err}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{errid}\K\NULL;{}$\7
\&{if} ${}(\|l>\T{0}){}$\5
${}\{{}$\1\6
\&{mp\_sym} \|p${}\K\\{mp\_id\_lookup}(\\{mp},\39\|n,\39\|l,\39\\{false});{}$\7
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\\{errid}\K\.{"variable\ does\ not\ e}\)\.{xist"};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{eq\_type}(\|p)\E\\{mp\_internal\_quantity}){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{internal\_type}(\\{equiv}(\|p))\E\\{mp\_string\_type})\W(%
\\{isstring})){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{equiv}(\|p),\39\\{mp\_rts}(\\{mp},\39\|v));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}((\\{internal\_type}(\\{equiv}(\|p))\E\\{mp\_known})\W(\R%
\\{isstring})){}$\5
${}\{{}$\1\6
\&{int} \\{test}${}\K\\{atoi}(\|v);{}$\7
\&{if} ${}(\\{test}>\T{16383}){}$\5
${}\{{}$\1\6
${}\\{errid}\K\.{"value\ is\ too\ large"};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{test}<{-}\T{16383}){}$\5
${}\{{}$\1\6
${}\\{errid}\K\.{"value\ is\ too\ small"};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_internal\_from\_number}(\\{equiv}(\|p),\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{equiv}(\|p)),\39%
\\{test});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{errid}\K\.{"value\ has\ the\ wrong}\)\.{\ type"};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{errid}\K\.{"variable\ is\ not\ an\ }\)\.{internal"};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{errid}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{isstring})\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"\%s=\\"\%s\\":\ \%s,\ assi}\)%
\.{gnment\ ignored."},\39\|n,\39\|v,\39\\{errid});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"\%s=\%d:\ \%s,\ assignme}\)\.{nt\
ignored."},\39\|n,\39\\{atoi}(\|v),\39\\{errid});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_warn}(\\{mp},\39\\{err});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1053}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_set\_internal}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}\|n,\39{}$%
\&{char} ${}{*}\|v,\39{}$\&{int} \\{isstring});\par
\fi

\M{1054}For \PB{\\{mp\_execute}}, we need to define a structure to store the
redirected input and output. This structure holds the five relevant
streams: the three informational output streams, the PostScript
generation stream, and the input stream. These streams have many
things in common, so it makes sense to give them their own structure
definition.

\item{fptr} is a virtual file pointer
\item{data} is the data this stream holds
\item{cur}  is a cursor pointing into \PB{\\{data}}
\item{size} is the allocated length of the data stream
\item{used} is the actual length of the data stream

There are small differences between input and output: \PB{\\{term\_in}} never
uses \PB{\\{used}}, whereas the other four never use \PB{\\{cur}}.

The file \PB{$\\{luatexdir}/\\{tex}/\\{texfileio}.\|h$} defines \PB{\\{term%
\_in}} as \PB{\\{stdin}} and
\PB{\\{term\_out}} as \PB{\\{stdout}}.  Moreover \PB{$\\{stdio}.\|h$} for MinGW
defines \PB{\\{stdin}} as
\PB{$({\AND}\\{\_iob}[\T{0}])$} and \PB{\\{stdout}} as \PB{$({\AND}\\{\_iob}[%
\T{1}])$}.  We must avoid all that.

\Y\B\4\X15:Exported types\X${}\mathrel+\E{}$\6
\8\#\&{undef} \\{term\_in}\6
\8\#\&{undef} \\{term\_out}\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{void} ${}{*}\\{fptr};{}$\6
\&{char} ${}{*}\\{data};{}$\6
\&{char} ${}{*}\\{cur};{}$\6
\&{size\_t} \\{size};\6
\&{size\_t} \\{used};\2\6
${}\}{}$ \&{mp\_stream};\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{mp\_stream} \\{term\_out};\6
\&{mp\_stream} \\{error\_out};\6
\&{mp\_stream} \\{log\_out};\6
\&{mp\_stream} \\{ship\_out};\6
\&{mp\_stream} \\{term\_in};\6
\&{struct} \\{mp\_edge\_object} ${}{*}\\{edges};{}$\2\6
${}\}{}$ \&{mp\_run\_data};\par
\fi

\M{1055}We need a function to clear an output stream, this is called at the
beginning of \PB{\\{mp\_execute}}. We also need one for destroying an output
stream, this is called just before a stream is (re)opened.

\Y\B\&{static} \&{void} \\{mp\_reset\_stream}(\&{mp\_stream} ${}{*}\\{str}){}$%
\1\1\2\2\6
${}\{{}$\1\6
${}\\{xfree}(\\{str}\MG\\{data});{}$\6
${}\\{str}\MG\\{cur}\K\NULL;{}$\6
${}\\{str}\MG\\{size}\K\T{0};{}$\6
${}\\{str}\MG\\{used}\K\T{0};{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_free\_stream}(\&{mp\_stream} ${}{*}\\{str}){}$\1\1\2%
\2\6
${}\{{}$\1\6
${}\\{xfree}(\\{str}\MG\\{fptr});{}$\6
\\{mp\_reset\_stream}(\\{str});\6
\4${}\}{}$\2\par
\fi

\M{1056}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_reset\_stream}(\&{mp\_stream} ${}{*}\\{str});{}$\6
\&{static} \&{void} \\{mp\_free\_stream}(\&{mp\_stream} ${}{*}\\{str}){}$;\par
\fi

\M{1057}The global instance contains a pointer instead of the actual structure
even though it is essentially static, because that makes it is easier to move
the object around.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_run\_data} \\{run\_data};\par
\fi

\M{1058}Another type is needed: the indirection will overload some of the
file pointer objects in the instance (but not all). For clarity, an
indirect object is used that wraps a \PB{\&{FILE} ${}{*}$}.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{File} ${}\{{}$\1\6
\&{FILE} ${}{*}\|f;{}$\2\6
${}\}{}$ \&{File};\par
\fi

\M{1059}Here are all of the functions that need to be overloaded for \PB{\\{mp%
\_execute}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} ${}{*}{}$\\{mplib\_open\_file}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},%
\39{}$\&{int} \\{ftype});\6
\&{static} \&{int} \\{mplib\_get\_char}(\&{void} ${}{*}\|f,\39{}$\&{mp\_run%
\_data} ${}{*}\\{mplib\_data});{}$\6
\&{static} \&{void} \\{mplib\_unget\_char}(\&{void} ${}{*}\|f,\39{}$\&{mp\_run%
\_data} ${}{*}\\{mplib\_data},\39{}$\&{int} \|c);\6
\&{static} \&{char} ${}{*}{}$\\{mplib\_read\_ascii\_file}(\&{MP} \\{mp}${},%
\39{}$\&{void} ${}{*}\\{ff},\39{}$\&{size\_t} ${}{*}\\{size});{}$\6
\&{static} \&{void} \\{mplib\_write\_ascii\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{const} \&{char} ${}{*}\|s);{}$\6
\&{static} \&{void} \\{mplib\_read\_binary\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{void} ${}{*}{*}\\{data},\39{}$\&{size\_t} ${}{*}%
\\{size});{}$\6
\&{static} \&{void} \\{mplib\_write\_binary\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{void} ${}{*}\|s,\39{}$\&{size\_t} \\{size});\6
\&{static} \&{void} \\{mplib\_close\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\\{ff});{}$\6
\&{static} \&{int} \\{mplib\_eof\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\\{ff});{}$\6
\&{static} \&{void} \\{mplib\_flush\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\\{ff});{}$\6
\&{static} \&{void} \\{mplib\_shipout\_backend}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|h){}$;\par
\fi

\M{1060}The \PB{$\\{xmalloc}(\T{1},\T{1})$} calls make sure the stored
indirection values are unique.

\Y\B\4\D$\\{reset\_stream}(\|a)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{mp\_reset\_stream}({\AND}(\|a));{}$\6
\&{if} ${}(\R\\{ff}\MG\|f){}$\5
${}\{{}$\1\6
${}\\{ff}\MG\|f\K\\{xmalloc}(\T{1},\39\T{1});{}$\6
${}(\|a).\\{fptr}\K\\{ff}\MG\|f;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{void} ${}{*}{}$\\{mplib\_open\_file}(\&{MP} \\{mp}${},\39{}$%
\&{const} \&{char} ${}{*}\\{fname},\39{}$\&{const} \&{char} ${}{*}\\{fmode},%
\39{}$\&{int} \\{ftype})\1\1\2\2\6
${}\{{}$\1\6
\&{File} ${}{*}\\{ff}\K\\{xmalloc}(\T{1},\39\&{sizeof}(\&{File}));{}$\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\7
${}\\{ff}\MG\|f\K\NULL;{}$\6
\&{if} ${}(\\{ftype}\E\\{mp\_filetype\_terminal}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{fmode}[\T{0}]\E\.{'r'}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{ff}\MG\|f){}$\5
${}\{{}$\1\6
${}\\{ff}\MG\|f\K\\{xmalloc}(\T{1},\39\T{1});{}$\6
${}\\{run}\MG\\{term\_in}.\\{fptr}\K\\{ff}\MG\|f;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{reset\_stream}(\\{run}\MG\\{term\_out});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{ftype}\E\\{mp\_filetype\_error}){}$\5
${}\{{}$\1\6
${}\\{reset\_stream}(\\{run}\MG\\{error\_out});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{ftype}\E\\{mp\_filetype\_log}){}$\5
${}\{{}$\1\6
${}\\{reset\_stream}(\\{run}\MG\\{log\_out});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{ftype}\E\\{mp\_filetype\_postscript}){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_stream}({\AND}(\\{run}\MG\\{ship\_out}));{}$\6
${}\\{ff}\MG\|f\K\\{xmalloc}(\T{1},\39\T{1});{}$\6
${}\\{run}\MG\\{ship\_out}.\\{fptr}\K\\{ff}\MG\|f;{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{ftype}\E\\{mp\_filetype\_bitmap}){}$\5
${}\{{}$\1\6
${}\\{mp\_free\_stream}({\AND}(\\{run}\MG\\{ship\_out}));{}$\6
${}\\{ff}\MG\|f\K\\{xmalloc}(\T{1},\39\T{1});{}$\6
${}\\{run}\MG\\{ship\_out}.\\{fptr}\K\\{ff}\MG\|f;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{realmode}[\T{3}];\6
\&{char} ${}{*}\|f\K(\\{mp}\MG\\{find\_file})(\\{mp},\39\\{fname},\39\\{fmode},%
\39\\{ftype});{}$\7
\&{if} ${}(\|f\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{realmode}[\T{0}]\K{*}\\{fmode};{}$\6
${}\\{realmode}[\T{1}]\K\.{'b'};{}$\6
${}\\{realmode}[\T{2}]\K\T{0};{}$\6
${}\\{ff}\MG\|f\K\\{fopen}(\|f,\39\\{realmode});{}$\6
\\{free}(\|f);\6
\&{if} ${}((\\{fmode}[\T{0}]\E\.{'r'})\W(\\{ff}\MG\|f\E\NULL)){}$\5
${}\{{}$\1\6
\\{free}(\\{ff});\6
\&{return} ${}\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{return} \\{ff};\6
\4${}\}{}$\2\7
\&{static} \&{int} \\{mplib\_get\_char}(\&{void} ${}{*}\|f,\39{}$\&{mp\_run%
\_data} ${}{*}\\{run}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|c;\7
\&{if} ${}(\|f\E\\{run}\MG\\{term\_in}.\\{fptr}\W\\{run}\MG\\{term\_in}.%
\\{data}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{run}\MG\\{term\_in}.\\{size}\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{run}\MG\\{term\_in}.\\{cur}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{run}\MG\\{term\_in}.\\{cur}\K\NULL;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{xfree}(\\{run}\MG\\{term\_in}.\\{data});{}$\6
\4${}\}{}$\2\6
${}\|c\K\.{EOF};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{run}\MG\\{term\_in}.\\{size}\MM;{}$\6
${}\|c\K{*}(\\{run}\MG\\{term\_in}.\\{cur})\PP;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|c\K\\{fgetc}(\|f);{}$\6
\4${}\}{}$\2\6
\&{return} \|c;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_unget\_char}(\&{void} ${}{*}\|f,\39{}$\&{mp\_run%
\_data} ${}{*}\\{run},\39{}$\&{int} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|f\E\\{run}\MG\\{term\_in}.\\{fptr}\W\\{run}\MG\\{term\_in}.\\{cur}%
\I\NULL){}$\5
${}\{{}$\1\6
${}\\{run}\MG\\{term\_in}.\\{size}\PP;{}$\6
${}\\{run}\MG\\{term\_in}.\\{cur}\MM;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{ungetc}(\|c,\39\|f);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{char} ${}{*}{}$\\{mplib\_read\_ascii\_file}(\&{MP} \\{mp}${},%
\39{}$\&{void} ${}{*}\\{ff},\39{}$\&{size\_t} ${}{*}\\{size}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|s\K\NULL;{}$\7
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{int} \|c;\6
\&{size\_t} \\{len}${}\K\T{0},{}$ \\{lim}${}\K\T{128};{}$\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\6
\&{FILE} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\7
\&{if} ${}(\|f\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}{*}\\{size}\K\T{0};{}$\6
${}\|c\K\\{mplib\_get\_char}(\|f,\39\\{run});{}$\6
\&{if} ${}(\|c\E\.{EOF}){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\|s\K\\{malloc}(\\{lim});{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
\&{while} ${}(\|c\I\.{EOF}\W\|c\I\.{'\\n'}\W\|c\I\.{'\\r'}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{len}\G(\\{lim}-\T{1})){}$\5
${}\{{}$\1\6
${}\|s\K\\{xrealloc}(\|s,\39(\\{lim}+(\\{lim}\GG\T{2})),\39\T{1});{}$\6
\&{if} ${}(\|s\E\NULL){}$\1\5
\&{return} ${}\NULL;{}$\2\6
${}\\{lim}\MRL{+{\K}}(\\{lim}\GG\T{2});{}$\6
\4${}\}{}$\2\6
${}\|s[\\{len}\PP]\K{}$(\&{char}) \|c;\6
${}\|c\K\\{mplib\_get\_char}(\|f,\39\\{run});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\E\.{'\\r'}){}$\5
${}\{{}$\1\6
${}\|c\K\\{mplib\_get\_char}(\|f,\39\\{run});{}$\6
\&{if} ${}(\|c\I\.{EOF}\W\|c\I\.{'\\n'}){}$\1\5
${}\\{mplib\_unget\_char}(\|f,\39\\{run},\39\|c);{}$\2\6
\4${}\}{}$\2\6
${}\|s[\\{len}]\K\T{0};{}$\6
${}{*}\\{size}\K\\{len};{}$\6
\4${}\}{}$\2\6
\&{return} \|s;\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_append\_string}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_stream} ${}{*}\|a,\39{}$\&{const} \&{char} ${}{*}\|b){}$\1\1\2\2\6
${}\{{}$\1\6
\&{size\_t} \|l${}\K\\{strlen}(\|b)+\T{1}{}$;\C{ don't forget the trailing '\\0'
}\7
\&{if} ${}((\|a\MG\\{used}+\|l)\G\|a\MG\\{size}){}$\5
${}\{{}$\1\6
${}\|a\MG\\{size}\MRL{+{\K}}\T{256}+(\|a\MG\\{size})/\T{5}+\|l;{}$\6
${}\|a\MG\\{data}\K\\{xrealloc}(\|a\MG\\{data},\39\|a\MG\\{size},\39\T{1});{}$\6
\4${}\}{}$\2\6
${}\\{memcpy}(\|a\MG\\{data}+\|a\MG\\{used},\39\|b,\39\|l);{}$\6
${}\|a\MG\\{used}\MRL{+{\K}}(\|l-\T{1});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_append\_data}(\&{MP} \\{mp}${},\39{}$\&{mp\_stream}
${}{*}\|a,\39{}$\&{void} ${}{*}\|b,\39{}$\&{size\_t} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}((\|a\MG\\{used}+\|l)\G\|a\MG\\{size}){}$\5
${}\{{}$\1\6
${}\|a\MG\\{size}\MRL{+{\K}}\T{256}+(\|a\MG\\{size})/\T{5}+\|l;{}$\6
${}\|a\MG\\{data}\K\\{xrealloc}(\|a\MG\\{data},\39\|a\MG\\{size},\39\T{1});{}$\6
\4${}\}{}$\2\6
${}\\{memcpy}(\|a\MG\\{data}+\|a\MG\\{used},\39\|b,\39\|l);{}$\6
${}\|a\MG\\{used}\MRL{+{\K}}\|l;{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_write\_ascii\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{const} \&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{void} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\7
\&{if} ${}(\|f\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\|f\E\\{run}\MG\\{term\_out}.\\{fptr}){}$\5
${}\{{}$\1\6
${}\\{mp\_append\_string}(\\{mp},\39{\AND}(\\{run}\MG\\{term\_out}),\39\|s);{}$%
\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|f\E\\{run}\MG\\{error\_out}.\\{fptr}){}$\5
${}\{{}$\1\6
${}\\{mp\_append\_string}(\\{mp},\39{\AND}(\\{run}\MG\\{error\_out}),\39%
\|s);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|f\E\\{run}\MG\\{log\_out}.\\{fptr}){}$\5
${}\{{}$\1\6
${}\\{mp\_append\_string}(\\{mp},\39{\AND}(\\{run}\MG\\{log\_out}),\39\|s);{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|f\E\\{run}\MG\\{ship\_out}.\\{fptr}){}$\5
${}\{{}$\1\6
${}\\{mp\_append\_string}(\\{mp},\39{\AND}(\\{run}\MG\\{ship\_out}),\39\|s);{}$%
\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{fprintf}((\&{FILE} ${}{*}){}$ \|f${},\39\.{"\%s"},\39\|s);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_read\_binary\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{void} ${}{*}{*}\\{data},\39{}$\&{size\_t} ${}{*}%
\\{size}){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{size\_t} \\{len}${}\K\T{0};{}$\6
\&{FILE} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\7
\&{if} ${}(\|f\I\NULL){}$\1\5
${}\\{len}\K\\{fread}({*}\\{data},\39\T{1},\39{*}\\{size},\39\|f);{}$\2\6
${}{*}\\{size}\K\\{len};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_write\_binary\_file}(\&{MP} \\{mp}${},\39{}$%
\&{void} ${}{*}\\{ff},\39{}$\&{void} ${}{*}\|s,\39{}$\&{size\_t} \\{size})\1\1%
\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{void} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\7
\&{if} ${}(\|f\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\|f\E\\{run}\MG\\{ship\_out}.\\{fptr}){}$\5
${}\{{}$\1\6
${}\\{mp\_append\_data}(\\{mp},\39{\AND}(\\{run}\MG\\{ship\_out}),\39\|s,\39%
\\{size});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
(\&{void}) \\{fwrite}${}(\|s,\39\\{size},\39\T{1},\39\|f);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_close\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\\{ff}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\6
\&{void} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\7
\&{if} ${}(\|f\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\|f\I\\{run}\MG\\{term\_out}.\\{fptr}\W\|f\I\\{run}\MG\\{error%
\_out}.\\{fptr}\W\|f\I\\{run}\MG\\{log\_out}.\\{fptr}\W\|f\I\\{run}\MG\\{ship%
\_out}.\\{fptr}\W\|f\I\\{run}\MG\\{term\_in}.\\{fptr}){}$\5
${}\{{}$\1\6
\\{fclose}(\|f);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free}(\\{ff});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{int} \\{mplib\_eof\_file}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\\{ff}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{ff}\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\6
\&{FILE} ${}{*}\|f\K{}$((\&{File} ${}{*}){}$ \\{ff})${}\MG\|f;{}$\7
\&{if} ${}(\|f\E\NULL){}$\1\5
\&{return} \T{1};\2\6
\&{if} ${}(\|f\E\\{run}\MG\\{term\_in}.\\{fptr}\W\\{run}\MG\\{term\_in}.%
\\{data}\I\NULL){}$\5
${}\{{}$\1\6
\&{return} ${}(\\{run}\MG\\{term\_in}.\\{size}\E\T{0});{}$\6
\4${}\}{}$\2\6
\&{return} \\{feof}(\|f);\6
\4${}\}{}$\2\6
\&{return} \T{1};\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_flush\_file}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\\{ff}){}$\1\1\2\2\6
${}\{{}$\1\6
(\&{void}) \\{mp};\6
(\&{void}) \\{ff};\6
\&{return};\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mplib\_shipout\_backend}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\\{voidh}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_edge\_header\_node} \|h${}\K{}$(\&{mp\_edge\_header\_node}) \\{voidh};\7
${}\\{mp\_edge\_object}*\\{hh}\K\\{mp\_gr\_export}(\\{mp},\39\|h);{}$\6
\&{if} (\\{hh})\5
${}\{{}$\1\6
\&{mp\_run\_data} ${}{*}\\{run}\K\\{mp\_rundata}(\\{mp});{}$\7
\&{if} ${}(\\{run}\MG\\{edges}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{run}\MG\\{edges}\K\\{hh};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_edge\_object}*\|p\K\\{run}\MG\\{edges};{}$\6
\&{while} ${}(\|p\MG\\{next}\I\NULL){}$\5
${}\{{}$\1\6
${}\|p\K\|p\MG\\{next};{}$\6
\4${}\}{}$\2\6
${}\|p\MG\\{next}\K\\{hh};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1061}This is where we fill them all in.
\Y\B\4\X1061:Prepare function pointers for non-interactive use\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp}\MG\\{open\_file}\K\\{mplib\_open\_file};{}$\6
${}\\{mp}\MG\\{close\_file}\K\\{mplib\_close\_file};{}$\6
${}\\{mp}\MG\\{eof\_file}\K\\{mplib\_eof\_file};{}$\6
${}\\{mp}\MG\\{flush\_file}\K\\{mplib\_flush\_file};{}$\6
${}\\{mp}\MG\\{write\_ascii\_file}\K\\{mplib\_write\_ascii\_file};{}$\6
${}\\{mp}\MG\\{read\_ascii\_file}\K\\{mplib\_read\_ascii\_file};{}$\6
${}\\{mp}\MG\\{write\_binary\_file}\K\\{mplib\_write\_binary\_file};{}$\6
${}\\{mp}\MG\\{read\_binary\_file}\K\\{mplib\_read\_binary\_file};{}$\6
${}\\{mp}\MG\\{shipout\_backend}\K\\{mplib\_shipout\_backend};{}$\6
\4${}\}{}$\2\par
\U16.\fi

\M{1062}Perhaps this is the most important API function in the library.

\Y\B\4\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{extern} \&{mp\_run\_data} ${}{*}{}$\\{mp\_rundata}(\&{MP} \\{mp});\par
\fi

\M{1063}\B\&{mp\_run\_data} ${}{*}{}$\\{mp\_rundata}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} ${}{\AND}(\\{mp}\MG\\{run\_data});{}$\6
\4${}\}{}$\2\par
\fi

\M{1064}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{mp\_free\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{term\_in}));{}$\6
${}\\{mp\_free\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{term\_out}));{}$\6
${}\\{mp\_free\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{log\_out}));{}$\6
${}\\{mp\_free\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{error\_out}));{}$\6
${}\\{mp\_free\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{ship\_out})){}$;\par
\fi

\M{1065}\B\X1065:Finish non-interactive use\X${}\E{}$\6
$\\{xfree}(\\{mp}\MG\\{term\_out});{}$\6
${}\\{xfree}(\\{mp}\MG\\{term\_in});{}$\6
${}\\{xfree}(\\{mp}\MG\\{err\_out}){}$;\par
\U12.\fi

\M{1066}\B\X1066:Start non-interactive work\X${}\E{}$\6
\X81:Initialize the output routines\X;\6
${}\\{mp}\MG\\{input\_ptr}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_in\_stack}\K\\{file\_bottom};{}$\6
${}\\{mp}\MG\\{in\_open}\K\\{file\_bottom};{}$\6
${}\\{mp}\MG\\{open\_parens}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_buf\_stack}\K\T{0};{}$\6
${}\\{mp}\MG\\{param\_ptr}\K\T{0};{}$\6
${}\\{mp}\MG\\{max\_param\_stack}\K\T{0};{}$\6
${}\\{start}\K\\{loc}\K\T{0};{}$\6
${}\\{iindex}\K\\{file\_bottom};{}$\6
${}\\{nloc}\K\\{nstart}\K\NULL;{}$\6
${}\\{mp}\MG\\{first}\K\T{0};$ \&{line} $\K$ \T{0};\6
${}\\{name}\K\\{is\_term};{}$\6
${}\\{mp}\MG\\{mpx\_name}[\\{file\_bottom}]\K\\{absent};{}$\6
${}\\{mp}\MG\\{force\_eof}\K\\{false};{}$\6
\\{t\_open\_in}(\,);\6
${}\\{mp}\MG\\{scanner\_status}\K\\{normal};{}$\6
\&{if} ${}(\R\\{mp}\MG\\{ini\_version}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_load\_preload\_file}(\\{mp})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_fix\_date\_and\_time}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{random\_seed}\E\T{0}){}$\1\5
${}\\{mp}\MG\\{random\_seed}\K(\\{number\_to\_scaled}(\\{internal\_value}(\\{mp%
\_time}))/\\{number\_to\_scaled}(\\{unity\_t}))+\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_day}));{}$\2\6
${}\\{init\_randoms}(\\{mp}\MG\\{random\_seed});{}$\6
\\{initialize\_print\_selector}(\,);\6
\\{mp\_open\_log\_file}(\\{mp});\6
\\{mp\_set\_job\_id}(\\{mp});\6
${}\\{mp\_init\_map\_file}(\\{mp},\39\\{mp}\MG\\{troff\_mode});{}$\6
${}\\{mp}\MG\\{history}\K\\{mp\_spotless}{}$;\C{ ready to go! }\6
\&{if} ${}(\\{mp}\MG\\{troff\_mode}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_gtroffmode}),\39\\{unity%
\_t});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_prologues}),\39\\{unity%
\_t});{}$\6
\4${}\}{}$\2\6
\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X;\6
\&{if} ${}(\\{mp}\MG\\{start\_sym}\I\NULL){}$\5
${}\{{}$\C{ insert the `\&{everyjob}' symbol }\1\6
${}\\{set\_cur\_sym}(\\{mp}\MG\\{start\_sym});{}$\6
\\{mp\_back\_input}(\\{mp});\6
\4${}\}{}$\2\par
\U1067.\fi

\M{1067}\B\&{int} \\{mp\_execute}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}\|s,%
\39{}$\&{size\_t} \|l)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_reset\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{term\_out}));{}$\6
${}\\{mp\_reset\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{log\_out}));{}$\6
${}\\{mp\_reset\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{error\_out}));{}$\6
${}\\{mp\_reset\_stream}({\AND}(\\{mp}\MG\\{run\_data}.\\{ship\_out}));{}$\6
\&{if} ${}(\\{mp}\MG\\{finished}){}$\5
${}\{{}$\1\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{history}<\\{mp\_fatal\_error\_stop}){}$\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{jump\_buf});{}$\6
${}\\{mp}\MG\\{jump\_buf}\K\\{malloc}(\&{sizeof}(\&{jmp\_buf}));{}$\6
\&{if} ${}(\\{mp}\MG\\{jump\_buf}\E\NULL\V\\{setjmp}({*}(\\{mp}\MG\\{jump%
\_buf}))\I\T{0}){}$\5
${}\{{}$\1\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|s\E\NULL){}$\5
${}\{{}$\C{ this signals EOF }\1\6
\\{mp\_final\_cleanup}(\\{mp});\C{ prepare for death }\6
\\{mp\_close\_files\_and\_terminate}(\\{mp});\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{tally}\K\T{0};{}$\6
${}\\{mp}\MG\\{term\_offset}\K\T{0};{}$\6
${}\\{mp}\MG\\{file\_offset}\K\T{0}{}$;\C{ Perhaps some sort of warning here
when \PB{\\{data}} is not      * yet exhausted would be nice ...  this happens
after errors      }\6
\&{if} ${}(\\{mp}\MG\\{run\_data}.\\{term\_in}.\\{data}){}$\1\5
${}\\{xfree}(\\{mp}\MG\\{run\_data}.\\{term\_in}.\\{data});{}$\2\6
${}\\{mp}\MG\\{run\_data}.\\{term\_in}.\\{data}\K\\{xstrdup}(\|s);{}$\6
${}\\{mp}\MG\\{run\_data}.\\{term\_in}.\\{cur}\K\\{mp}\MG\\{run\_data}.\\{term%
\_in}.\\{data};{}$\6
${}\\{mp}\MG\\{run\_data}.\\{term\_in}.\\{size}\K\|l;{}$\6
\&{if} ${}(\\{mp}\MG\\{run\_state}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
\X1066:Start non-interactive work\X;\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{run\_state}\K\T{1};{}$\6
(\&{void}) \\{mp\_input\_ln}${}(\\{mp},\39\\{mp}\MG\\{term\_in});{}$\6
\\{mp\_firm\_up\_the\_line}(\\{mp});\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};{}$\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_do\_statement}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\I\\{mp\_stop});{}$\6
\\{mp\_final\_cleanup}(\\{mp});\6
\\{mp\_close\_files\_and\_terminate}(\\{mp});\6
\4${}\}{}$\2\6
\&{return} \\{mp}${}\MG\\{history};{}$\6
\4${}\}{}$\2\par
\fi

\M{1068}This function cleans up
\Y\B\&{int} \\{mp\_finish}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \\{history}${}\K\T{0};{}$\7
\&{if} ${}(\\{mp}\MG\\{finished}\V\\{mp}\MG\\{history}\G\\{mp\_fatal\_error%
\_stop}){}$\5
${}\{{}$\1\6
${}\\{history}\K\\{mp}\MG\\{history};{}$\6
\\{mp\_free}(\\{mp});\6
\&{return} \\{history};\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{jump\_buf});{}$\6
${}\\{mp}\MG\\{jump\_buf}\K\\{malloc}(\&{sizeof}(\&{jmp\_buf}));{}$\6
\&{if} ${}(\\{mp}\MG\\{jump\_buf}\E\NULL\V\\{setjmp}({*}(\\{mp}\MG\\{jump%
\_buf}))\I\T{0}){}$\5
${}\{{}$\1\6
${}\\{history}\K\\{mp}\MG\\{history};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{history}\K\\{mp}\MG\\{history};{}$\6
\\{mp\_final\_cleanup}(\\{mp});\C{ prepare for death }\6
\4${}\}{}$\2\6
\\{mp\_close\_files\_and\_terminate}(\\{mp});\6
\\{mp\_free}(\\{mp});\6
\&{return} \\{history};\6
\4${}\}{}$\2\par
\fi

\M{1069}People may want to know the library version
\Y\B\&{char} ${}{*}\\{mp\_metapost\_version}(\&{void}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{return} \\{mp\_strdup}(\\{metapost\_version});\6
\4${}\}{}$\2\7
\&{void} \\{mp\_show\_library\_versions}(\&{void})\1\1\2\2\6
${}\{{}$\1\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ cairo}\)\.{\ \%s;\ using\ \%s%
\\n"},\39\.{CAIRO\_VERSION\_STRING},\39\\{cairo\_version\_string}(\,));{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ pixma}\)\.{n\ \%s;\ using\ \%s%
\\n"},\39\.{PIXMAN\_VERSION\_STRING},\39\\{pixman\_version\_string}(\,));{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ libpn}\)\.{g\ \%s;\ using\ \%s%
\\n"},\39\.{PNG\_LIBPNG\_VER\_STRING},\39\\{png\_libpng\_ver});{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ zlib\ }\)\.{\%s;\ using\ \%s%
\\n"},\39\.{ZLIB\_VERSION},\39\\{zlibVersion}(\,));{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ mpfr\ }\)\.{\%s;\ using\ \%s%
\\n"},\39\.{MPFR\_VERSION\_STRING},\39\\{mpfr\_get\_version}(\,));{}$\6
${}\\{fprintf}(\\{stdout},\39\.{"Compiled\ with\ gmp\ \%}\)\.{d.\%d.\%d;\ using%
\ \%s\\n\\}\)\.{n"},\39\.{\_\_GNU\_MP\_VERSION},\39\.{\_\_GNU\_MP\_VERSION%
\_MINOR},\39\.{\_\_GNU\_MP\_VERSION\_PATCHLEVEL},\39\\{gmp\_version});{}$\6
\4${}\}{}$\2\par
\fi

\M{1070}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{int} \\{mp\_run}(\&{MP} \\{mp});\6
\&{int} \\{mp\_execute}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}\|s,\39{}$\&{size%
\_t} \|l);\6
\&{int} \\{mp\_finish}(\&{MP} \\{mp});\6
\&{char} ${}{*}\\{mp\_metapost\_version}(\&{void});{}$\6
\&{void} \\{mp\_show\_library\_versions}(\&{void});\par
\fi

\M{1071}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"end"},\39\\{mp\_stop},\39\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"dump"},\39\\{mp\_stop},\39\T{1});{}$\6
${}\\{mp}\MG\\{frozen\_dump}\K\\{mp\_frozen\_primitive}(\\{mp},\39\.{"dump"},%
\39\\{mp\_stop},\39\T{1}){}$;\par
\fi

\M{1072}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_stop}:\6
\&{if} ${}(\\{cur\_mod}(\,)\E\T{0}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"end"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"dump"});{}$\2\6
\&{break};\par
\fi

\N{1}{1073}Commands.
Let's turn now to statements that are classified as ``commands'' because
of their imperative nature. We'll begin with simple ones, so that it
will be clear how to hook command processing into the \PB{\\{do\_statement}}
routine;
then we'll tackle the tougher commands.

Here's one of the simplest:

\fi

\M{1074}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_random\_seed}(\&{MP} \\{mp});\par
\fi

\M{1075}\B\&{void} \\{mp\_do\_random\_seed}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_assignment}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Always\ say\ `randoms}\)%
\.{eed:=<numeric\ expres}\)\.{sion>'."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `:='\ has\ be}\)\.{en\
inserted"},\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Your\ expression\ was}\)\.{\ too\
random\ for\ me\ t}\)\.{o\ handle,"},\39\.{"so\ I\ won't\ change\ t}\)\.{he\
random\ seed\ just\ }\)\.{now."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Unknown\ value\ will\ }\)\.{be\ ignored"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X1076:Initialize the random seed to \PB{\\{cur\_exp}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1076}\B\X1076:Initialize the random seed to \PB{\\{cur\_exp}}\X${}\E{}$\6
${}\{{}$\1\6
\\{init\_randoms}(\\{number\_to\_scaled}(\\{cur\_exp\_value\_number}(\,)));\6
\&{if} ${}(\\{mp}\MG\\{selector}\G\\{log\_only}\W\\{mp}\MG\\{selector}<\\{write%
\_file}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{log\_only};{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"\{randomseed:="});{}$\6
\\{print\_number}(\\{cur\_exp\_value\_number}(\,));\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\}'}));{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{old\_setting};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1075.\fi

\M{1077}And here's another simple one (somewhat different in flavor):

\fi

\M{1078}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"batchmode"},\39\\{mp\_mode\_command},\39\\{mp%
\_batch\_mode});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"nonstopmode"},\39\\{mp\_mode\_command},\39%
\\{mp\_nonstop\_mode});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"scrollmode"},\39\\{mp\_mode\_command},\39%
\\{mp\_scroll\_mode});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"errorstopmode"},\39\\{mp\_mode\_command},\39%
\\{mp\_error\_stop\_mode}){}$;\par
\fi

\M{1079}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_mode\_command}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{mp\_batch\_mode}:\5
${}\\{mp\_print}(\\{mp},\39\.{"batchmode"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_nonstop\_mode}:\5
${}\\{mp\_print}(\\{mp},\39\.{"nonstopmode"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_scroll\_mode}:\5
${}\\{mp\_print}(\\{mp},\39\.{"scrollmode"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"errorstopmode"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{1080}The `\&{inner}' and `\&{outer}' commands are only slightly harder.

\fi

\M{1081}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"inner"},\39\\{mp\_protection\_command},\39%
\T{0});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"outer"},\39\\{mp\_protection\_command},\39%
\T{1}){}$;\par
\fi

\M{1082}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_protection\_command}:\6
\&{if} ${}(\|m\E\T{0}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"inner"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"outer"});{}$\2\6
\&{break};\par
\fi

\M{1083}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_protection}(\&{MP} \\{mp});\par
\fi

\M{1084}\B\&{void} \\{mp\_do\_protection}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|m;\C{ 0 to unprotect, 1 to protect }\6
\&{halfword} \|t;\C{ the \PB{\\{eq\_type}} before we change it }\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_get\_symbol}(\\{mp});\6
${}\|t\K\\{eq\_type}(\\{cur\_sym}(\,));{}$\6
\&{if} ${}(\|m\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|t\G\\{mp\_outer\_tag}){}$\1\5
${}\\{set\_eq\_type}(\\{cur\_sym}(\,),\39(\|t-\\{mp\_outer\_tag}));{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t<\\{mp\_outer\_tag}){}$\5
${}\{{}$\1\6
${}\\{set\_eq\_type}(\\{cur\_sym}(\,),\39(\|t+\\{mp\_outer\_tag}));{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\4${}\}{}$\2\par
\fi

\M{1085}\MP\ never defines the tokens `\.(' and `\.)' to be primitives, but
plain \MP\ begins with the declaration `\&{delimiters} \.{()}'. Such a
declaration assigns the command code \PB{\\{left\_delimiter}} to `\.{(}' and
\PB{\\{right\_delimiter}} to `\.{)}'; the \PB{\\{equiv}} of each delimiter is
the
hash address of its mate.

\fi

\M{1086}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_def\_delims}(\&{MP} \\{mp});\par
\fi

\M{1087}\B\&{void} \\{mp\_def\_delims}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \\{l\_delim}${},{}$ \\{r\_delim};\C{ the new delimiter pair }\7
\\{mp\_get\_clear\_symbol}(\\{mp});\6
${}\\{l\_delim}\K\\{cur\_sym}(\,);{}$\6
\\{mp\_get\_clear\_symbol}(\\{mp});\6
${}\\{r\_delim}\K\\{cur\_sym}(\,);{}$\6
${}\\{set\_eq\_type}(\\{l\_delim},\39\\{mp\_left\_delimiter});{}$\6
${}\\{set\_equiv\_sym}(\\{l\_delim},\39\\{r\_delim});{}$\6
${}\\{set\_eq\_type}(\\{r\_delim},\39\\{mp\_right\_delimiter});{}$\6
${}\\{set\_equiv\_sym}(\\{r\_delim},\39\\{l\_delim});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{1088}Here is a procedure that is called when \MP\ has reached a point
where some right delimiter is mandatory.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_check\_delimiter}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym}
\\{l\_delim}${},\39{}$\&{mp\_sym} \\{r\_delim});\par
\fi

\M{1089}\B\&{void} \\{mp\_check\_delimiter}(\&{MP} \\{mp}${},\39{}$\&{mp\_sym} %
\\{l\_delim}${},\39{}$\&{mp\_sym} \\{r\_delim})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_right\_delimiter}){}$\1\6
\&{if} ${}(\\{equiv\_sym}(\\{cur\_sym}(\,))\E\\{l\_delim}){}$\1\5
\&{return};\2\2\6
\&{if} ${}(\\{cur\_sym}(\,)\I\\{r\_delim}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ found\ no\ right\ de}\)%
\.{limiter\ to\ match\ a\ l}\)\.{eft\ one.\ So\ I've"},\39\.{"put\ one\ in,\
behind\ }\)\.{the\ scenes;\ this\ may}\)\.{\ fix\ the\ problem."},\39\NULL%
\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ `\%s'\ has\ be}\)\.{en\
inserted"},\39\\{mp\_str}(\\{mp},\39\\{text}(\\{r\_delim})));{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Strange:\ This\ token}\)\.{\ has\
lost\ its\ former}\)\.{\ meaning!"},\39\.{"I'll\ read\ it\ as\ a\ r}\)\.{ight\
delimiter\ this\ }\)\.{time;"},\39\.{"but\ watch\ out,\ I'll}\)\.{\ probably\
miss\ it\ la}\)\.{ter."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"The\ token\ `\%s'\ is\ n}\)\.{o\
longer\ a\ right\ del}\)\.{imiter"},\39\\{mp\_str}(\\{mp},\39\\{text}(\\{r%
\_delim})));{}$\6
;\6
${}\\{mp\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1090}The next four commands save or change the values associated with
tokens.

\fi

\M{1091}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_statement}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_do\_interim}(\&{MP} \\{mp});\par
\fi

\M{1092}\B\&{void} \\{mp\_do\_interim}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_internal\_quantity}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Something\ like\ `tra}\)%
\.{cingonline'\ should\ f}\)\.{ollow\ `interim'."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"The\ token\ `\%s'\ isn'}\)\.{t\
an\ internal\ quanti}\)\.{ty"},\39(\\{cur\_sym}(\,)\E\NULL\?\.{"(\%CAPSULE)"}:%
\\{mp\_str}(\\{mp},\39\\{text}(\\{cur\_sym}(\,)))));{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_save\_internal}(\\{mp},\39\\{cur\_mod}(\,));{}$\6
\\{mp\_back\_input}(\\{mp});\6
\4${}\}{}$\2\6
\\{mp\_do\_statement}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{1093}The following procedure is careful not to undefine the left-hand symbol
too soon, lest commands like `{\tt let x=x}' have a surprising effect.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_let}(\&{MP} \\{mp});\par
\fi

\M{1094}\B\&{void} \\{mp\_do\_let}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_sym} \|l;\C{ hash location of the left-hand symbol }\7
\\{mp\_get\_symbol}(\\{mp});\6
${}\|l\K\\{cur\_sym}(\,);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_equals}\W\\{cur\_cmd}(\,)\I\\{mp%
\_assignment}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"You\ should\ have\ sai}\)\.{d\ `let%
\ symbol\ =\ some}\)\.{thing'."},\39\.{"But\ don't\ worry;\ I'}\)\.{ll\ pretend%
\ that\ an\ e}\)\.{quals\ sign"},\39\.{"was\ present.\ The\ ne}\)\.{xt\ token\
I\ read\ will}\)\.{\ be\ `something'."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `='\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\\{mp\_get\_symbol}(\\{mp});\6
\&{switch} (\\{cur\_cmd}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_defined\_macro}:\5
\&{case} \\{mp\_secondary\_primary\_macro}:\5
\&{case} \\{mp\_tertiary\_secondary\_macro}:\5
\&{case} \\{mp\_expression\_tertiary\_macro}:\5
\\{add\_mac\_ref}(\\{cur\_mod\_node}(\,));\6
\&{break};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp\_clear\_symbol}(\\{mp},\39\|l,\39\\{false});{}$\6
${}\\{set\_eq\_type}(\|l,\39\\{cur\_cmd}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_tag\_token}){}$\1\5
${}\\{set\_equiv}(\|l,\39\T{0}){}$;\C{ todo: this was \PB{\\{null}} }\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_defined\_macro}\V\\{cur\_cmd}(\,)%
\E\\{mp\_secondary\_primary\_macro}\V\\{cur\_cmd}(\,)\E\\{mp\_tertiary%
\_secondary\_macro}\V\\{cur\_cmd}(\,)\E\\{mp\_expression\_tertiary\_macro}){}$%
\1\5
${}\\{set\_equiv\_node}(\|l,\39\\{cur\_mod\_node}(\,));{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_left\_delimiter}\V\\{cur\_cmd}(\,)%
\E\\{mp\_right\_delimiter}){}$\1\5
${}\\{set\_equiv\_sym}(\|l,\39\\{equiv\_sym}(\\{cur\_sym}(\,)));{}$\2\6
\&{else}\1\5
${}\\{set\_equiv}(\|l,\39\\{cur\_mod}(\,));{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{1095}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_new\_internal}(\&{MP} \\{mp});\par
\fi

\M{1096}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_grow\_internals}(\&{MP} \\{mp}${},\39{}$\&{int} \|l);\par
\fi

\M{1097}\B\&{void} \\{mp\_grow\_internals}(\&{MP} \\{mp}${},\39{}$\&{int} \|l)%
\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_internal} ${}{*}\\{internal};{}$\6
\&{int} \|k;\7
\&{if} ${}(\|l>\\{max\_halfword}){}$\5
${}\{{}$\1\6
${}\\{mp\_confusion}(\\{mp},\39\.{"out\ of\ memory\ space}\)\.{"}){}$;\C{ can't
be reached }\6
\4${}\}{}$\2\6
${}\\{internal}\K\\{xmalloc}((\|l+\T{1}),\39\&{sizeof}(\&{mp\_internal}));{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\|l;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|k\Z\\{mp}\MG\\{max\_internal}){}$\5
${}\{{}$\1\6
${}\\{memcpy}(\\{internal}+\|k,\39\\{mp}\MG\\{internal}+\|k,\39\&{sizeof}(\&{mp%
\_internal}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{memset}(\\{internal}+\|k,\39\T{0},\39\&{sizeof}(\&{mp\_internal}));{}$\6
\\{new\_number}(((\&{mp\_internal} ${}{*})(\\{internal}+\|k))\MG\|v.\\{data}.%
\|n);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{internal});{}$\6
${}\\{mp}\MG\\{internal}\K\\{internal};{}$\6
${}\\{mp}\MG\\{max\_internal}\K\|l;{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_do\_new\_internal}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \\{the\_type}${}\K\\{mp\_known};{}$\7
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_type\_name}\W\\{cur\_mod}(\,)\E\\{mp%
\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{the\_type}\K\\{mp\_string\_type};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\R(\\{cur\_cmd}(\,)\E\\{mp\_type\_name}\W\\{cur\_mod}(\,)\E\\{mp%
\_numeric\_type})){}$\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{do}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{int\_ptr}\E\\{mp}\MG\\{max\_internal}){}$\5
${}\{{}$\1\6
${}\\{mp\_grow\_internals}(\\{mp},\39(\\{mp}\MG\\{max\_internal}+(\\{mp}\MG%
\\{max\_internal}/\T{4})));{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_clear\_symbol}(\\{mp});\6
${}\\{incr}(\\{mp}\MG\\{int\_ptr});{}$\6
${}\\{set\_eq\_type}(\\{cur\_sym}(\,),\39\\{mp\_internal\_quantity});{}$\6
${}\\{set\_equiv}(\\{cur\_sym}(\,),\39\\{mp}\MG\\{int\_ptr});{}$\6
\&{if} ${}(\\{internal\_name}(\\{mp}\MG\\{int\_ptr})\I\NULL){}$\1\5
${}\\{xfree}(\\{internal\_name}(\\{mp}\MG\\{int\_ptr}));{}$\2\6
${}\\{set\_internal\_name}(\\{mp}\MG\\{int\_ptr},\39\\{mp\_xstrdup}(\\{mp},\39%
\\{mp\_str}(\\{mp},\39\\{text}(\\{cur\_sym}(\,)))));{}$\6
\&{if} ${}(\\{the\_type}\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp}\MG\\{int\_ptr},\39\\{mp\_rts}(\\{mp},\39%
\.{""}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}(\\{internal\_value}(\\{mp}\MG\\{int\_ptr}));{}$\6
\4${}\}{}$\2\6
${}\\{set\_internal\_type}(\\{mp}\MG\\{int\_ptr},\39\\{the\_type});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\4${}\}{}$\2\par
\fi

\M{1098}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\\{mp}\MG\\{max\_internal};{}$ ${}\|k\PP){}$%
\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{internal}[\|k].\|v.\\{data}.\|n);{}$\6
\\{xfree}(\\{internal\_name}(\|k));\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{internal}){}$;\par
\fi

\M{1099}The various `\&{show}' commands are distinguished by modifier fields
in the usual way.

\Y\B\4\D$\\{show\_token\_code}$ \5
\T{0}\C{ show the meaning of a single token }\par
\B\4\D$\\{show\_stats\_code}$ \5
\T{1}\C{ show current memory and string usage }\par
\B\4\D$\\{show\_code}$ \5
\T{2}\C{ show a list of expressions }\par
\B\4\D$\\{show\_var\_code}$ \5
\T{3}\C{ show a variable and its descendents }\par
\B\4\D$\\{show\_dependencies\_code}$ \5
\T{4}\C{ show dependent variables in terms of independents }\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"showtoken"},\39\\{mp\_show\_command},\39%
\\{show\_token\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"showstats"},\39\\{mp\_show\_command},\39%
\\{show\_stats\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"show"},\39\\{mp\_show\_command},\39\\{show%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"showvariable"},\39\\{mp\_show\_command},\39%
\\{show\_var\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"showdependencies"},\39\\{mp\_show\_command},%
\39\\{show\_dependencies\_code}){}$;\par
\fi

\M{1100}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_show\_command}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{show\_token\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"showtoken"});{}$\6
\&{break};\6
\4\&{case} \\{show\_stats\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"showstats"});{}$\6
\&{break};\6
\4\&{case} \\{show\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"show"});{}$\6
\&{break};\6
\4\&{case} \\{show\_var\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"showvariable"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"showdependencies"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{1101}The value of \PB{\\{cur\_mod}} controls the \PB{\\{verbosity}} in the %
\PB{\\{print\_exp}} routine:
if it's \PB{\\{show\_code}}, complicated structures are abbreviated, otherwise
they aren't.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show}(\&{MP} \\{mp});\par
\fi

\M{1102}\B\&{void} \\{mp\_do\_show}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
\&{do}\5
${}\{{}$\1\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{">>\ "});{}$\6
;\6
${}\\{mp\_print\_exp}(\\{mp},\39\NULL,\39\T{2});{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\4${}\}{}$\2\par
\fi

\M{1103}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_disp\_token}(\&{MP} \\{mp});\par
\fi

\M{1104}\B\&{void} \\{mp\_disp\_token}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{">\ "});{}$\6
;\6
\&{if} ${}(\\{cur\_sym}(\,)\E\NULL){}$\5
${}\{{}$\1\6
\X1105:Show a numeric or string or capsule token\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_print\_text}(\\{cur\_sym}(\,));\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
\&{if} ${}(\\{eq\_type}(\\{cur\_sym}(\,))\G\\{mp\_outer\_tag}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"(outer)\ "});{}$\2\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{cur\_cmd}(\,),\39\\{cur\_mod}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_defined\_macro}){}$\5
${}\{{}$\1\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_show\_macro}(\\{mp},\39\\{cur\_mod\_node}(\,),\39\NULL,\39%
\T{100000});{}$\6
\4${}\}{}$\C{ this avoids recursion between \PB{\\{show\_macro}} and \PB{%
\\{print\_cmd\_mod}} }\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1105}\B\X1105:Show a numeric or string or capsule token\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_numeric\_token}){}$\5
${}\{{}$\1\6
\\{print\_number}(\\{cur\_mod\_number}(\,));\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_capsule\_token}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_capsule}(\\{mp},\39\\{cur\_mod\_node}(\,));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{cur\_mod\_str}(\,));{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'"'}));{}$\6
\\{delete\_str\_ref}(\\{cur\_mod\_str}(\,));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1104.\fi

\M{1106}The following cases of \PB{\\{print\_cmd\_mod}} might arise in
connection
with \PB{\\{disp\_token}}, although they don't necessarily correspond to
primitive tokens.

\Y\B\4\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_left\_delimiter}:\5
\&{case} \\{mp\_right\_delimiter}:\6
\&{if} ${}(\|c\E\\{mp\_left\_delimiter}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"left"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"right"});{}$\2\6
\8\#\&{if} \T{0}\6
${}\\{mp\_print}(\\{mp},\39\.{"\ delimiter\ that\ mat}\)\.{ches\ "});{}$\6
\\{mp\_print\_text}(\|m);\6
\8\#\&{else}\6
${}\\{mp\_print}(\\{mp},\39\.{"\ delimiter"});{}$\6
\8\#\&{endif}\6
\&{break};\6
\4\&{case} \\{mp\_tag\_token}:\6
\&{if} ${}(\|m\E\T{0}{}$)\C{ todo: this was \PB{\\{null}} }\1\6
${}\\{mp\_print}(\\{mp},\39\.{"tag"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"variable"});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_defined\_macro}:\5
${}\\{mp\_print}(\\{mp},\39\.{"macro:"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_secondary\_primary\_macro}:\5
\&{case} \\{mp\_tertiary\_secondary\_macro}:\5
\&{case} \\{mp\_expression\_tertiary\_macro}:\5
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{mp\_macro\_def},\39\|c);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"'d\ macro:"});{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\\{mp\_link}(\\{mp\_link}(\\{cur\_mod%
\_node}(\,))),\39\T{0},\39\T{1000},\39\T{0});{}$\6
\&{break};\6
\4\&{case} \\{mp\_repeat\_loop}:\5
${}\\{mp\_print}(\\{mp},\39\.{"[repeat\ the\ loop]"});{}$\6
\&{break};\6
\4\&{case} \\{mp\_internal\_quantity}:\5
${}\\{mp\_print}(\\{mp},\39\\{internal\_name}(\|m));{}$\6
\&{break};\par
\fi

\M{1107}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show\_token}(\&{MP} \\{mp});\par
\fi

\M{1108}\B\&{void} \\{mp\_do\_show\_token}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\\{mp\_disp\_token}(\\{mp});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\4${}\}{}$\2\par
\fi

\M{1109}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show\_stats}(\&{MP} \\{mp});\par
\fi

\M{1110}\B\&{void} \\{mp\_do\_show\_stats}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Memory\ usage\ "});{}$\6
;\6
${}\\{mp\_print\_int}(\\{mp},\39{}$(\&{integer}) \\{mp}${}\MG\\{var\_used});{}$%
\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"String\ usage\ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39{}$(\&{int}) \\{mp}${}\MG\\{strs\_in\_use});{}$%
\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\&'}));{}$\6
${}\\{mp\_print\_int}(\\{mp},\39{}$(\&{int}) \\{mp}${}\MG\\{pool\_in\_use});{}$%
\6
\\{mp\_print\_ln}(\\{mp});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{1111}Here's a recursive procedure that gives an abbreviated account
of a variable, for use by \PB{\\{do\_show\_var}}.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_disp\_var}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p);%
\par
\fi

\M{1112}\B\&{void} \\{mp\_disp\_var}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1%
\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|q;\C{ traverses attributes and subscripts }\6
\&{int} \|n;\C{ amount of macro text to show }\7
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_structured}){}$\5
${}\{{}$\1\6
\X1113:Descend the structure\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\G\\{mp\_unsuffixed\_macro}){}$\5
${}\{{}$\1\6
\X1114:Display a variable macro\X;\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_undefined}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|p);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\6
${}\\{mp\_print\_exp}(\\{mp},\39\|p,\39\T{0});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1113}\B\X1113:Descend the structure\X${}\E{}$\6
${}\{{}$\1\6
${}\|q\K\\{attr\_head}(\|p);{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp\_disp\_var}(\\{mp},\39\|q);{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|q\I\\{mp}\MG\\{end\_attr});{}$\6
${}\|q\K\\{subscr\_head}(\|p);{}$\6
\&{while} ${}(\\{mp\_name\_type}(\|q)\E\\{mp\_subscr}){}$\5
${}\{{}$\1\6
${}\\{mp\_disp\_var}(\\{mp},\39\|q);{}$\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1112.\fi

\M{1114}\B\X1114:Display a variable macro\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39\|p);{}$\6
\&{if} ${}(\\{mp\_type}(\|p)>\\{mp\_unsuffixed\_macro}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"@\#"}){}$;\C{ \PB{\\{suffixed\_macro}} }\2\6
${}\\{mp\_print}(\\{mp},\39\.{"=macro:"});{}$\6
\&{if} ((\&{int}) \\{mp}${}\MG\\{file\_offset}\G\\{mp}\MG\\{max\_print\_line}-%
\T{20}){}$\1\5
${}\|n\K\T{5};{}$\2\6
\&{else}\1\5
${}\|n\K\\{mp}\MG\\{max\_print\_line}-{}$(\&{int}) \\{mp}${}\MG\\{file%
\_offset}-\T{15};{}$\2\6
${}\\{mp\_show\_macro}(\\{mp},\39\\{value\_node}(\|p),\39\NULL,\39\|n);{}$\6
\4${}\}{}$\2\par
\U1112.\fi

\M{1115}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show\_var}(\&{MP} \\{mp});\par
\fi

\M{1116}\B\&{void} \\{mp\_do\_show\_var}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
\\{get\_t\_next}(\\{mp});\6
\&{if} ${}(\\{cur\_sym}(\,)\I\NULL){}$\1\6
\&{if} ${}(\\{cur\_sym\_mod}(\,)\E\T{0}){}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_tag\_token}){}$\1\6
\&{if} ${}(\\{cur\_mod}(\,)\I\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_disp\_var}(\\{mp},\39\\{cur\_mod\_node}(\,));{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\2\2\2\6
\\{mp\_disp\_token}(\\{mp});\6
\4\.{DONE}:\5
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma});{}$\6
\4${}\}{}$\2\par
\fi

\M{1117}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show\_dependencies}(\&{MP} \\{mp});\par
\fi

\M{1118}\B\&{void} \\{mp\_do\_show\_dependencies}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_value\_node} \|p;\C{ link that runs through all dependencies }\7
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}${}(\\{mp}\MG\\{dep\_head});{}$\6
\&{while} ${}(\|p\I\\{mp}\MG\\{dep\_head}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_interesting}(\\{mp},\39{}$(\&{mp\_node}) \|p))\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_variable\_name}(\\{mp},\39{}$(\&{mp\_node}) \|p);\6
\&{if} ${}(\\{mp\_type}(\|p)\E\\{mp\_dependent}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'='}));{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"\ =\ "}){}$;\C{ extra spaces imply
proto-dependency }\2\6
${}\\{mp\_print\_dependency}(\\{mp},\39{}$(\&{mp\_value\_node}) \\{dep\_list}(%
\|p)${},\39\\{mp\_type}(\|p));{}$\6
\4${}\}{}$\2\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{dep\_list}(\|p);\6
\&{while} ${}(\\{dep\_info}(\|p)\I\NULL){}$\1\5
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\2\6
${}\|p\K{}$(\&{mp\_value\_node}) \\{mp\_link}(\|p);\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\fi

\M{1119}Finally we are ready for the procedure that governs all of the
show commands.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_show\_whatever}(\&{MP} \\{mp});\par
\fi

\M{1120}\B\&{void} \\{mp\_do\_show\_whatever}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{interaction}\E\\{mp\_error\_stop\_mode}){}$\1\5
\\{wake\_up\_terminal}(\,);\2\6
\&{switch} (\\{cur\_mod}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{show\_token\_code}:\5
\\{mp\_do\_show\_token}(\\{mp});\6
\&{break};\6
\4\&{case} \\{show\_stats\_code}:\5
\\{mp\_do\_show\_stats}(\\{mp});\6
\&{break};\6
\4\&{case} \\{show\_code}:\5
\\{mp\_do\_show}(\\{mp});\6
\&{break};\6
\4\&{case} \\{show\_var\_code}:\5
\\{mp\_do\_show\_var}(\\{mp});\6
\&{break};\6
\4\&{case} \\{show\_dependencies\_code}:\5
\\{mp\_do\_show\_dependencies}(\\{mp});\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_showstopping})))\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ isn't\ an\ error}\)\.{\
message;\ I'm\ just\ s}\)\.{howing\ something."},\39\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{interaction}<\\{mp\_error\_stop\_mode}){}$\5
${}\{{}$\1\6
${}\\{hlp}[\T{0}]\K\NULL;{}$\6
${}\\{decr}(\\{mp}\MG\\{error\_count});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_semicolon}){}$\5
${}\{{}$\1\6
${}\\{mp\_error}(\\{mp},\39\.{"OK"},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"OK"},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1121}The `\&{addto}' command needs the following additional primitives:

\Y\B\4\D$\\{double\_path\_code}$ \5
\T{0}\C{ command modifier for `\&{doublepath}' }\par
\B\4\D$\\{contour\_code}$ \5
\T{1}\C{ command modifier for `\&{contour}' }\par
\B\4\D$\\{also\_code}$ \5
\T{2}\C{ command modifier for `\&{also}' }\par
\fi

\M{1122}Pre and postscripts need two new identifiers:

\Y\B\4\D$\\{with\_mp\_pre\_script}$ \5
\T{11}\par
\B\4\D$\\{with\_mp\_post\_script}$ \5
\T{13}\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"doublepath"},\39\\{mp\_thing\_to\_add},\39%
\\{double\_path\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"contour"},\39\\{mp\_thing\_to\_add},\39%
\\{contour\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"also"},\39\\{mp\_thing\_to\_add},\39\\{also%
\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withpen"},\39\\{mp\_with\_option},\39\\{mp%
\_pen\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"dashed"},\39\\{mp\_with\_option},\39\\{mp%
\_picture\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withprescript"},\39\\{mp\_with\_option},\39%
\\{with\_mp\_pre\_script});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withpostscript"},\39\\{mp\_with\_option},\39%
\\{with\_mp\_post\_script});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withoutcolor"},\39\\{mp\_with\_option},\39%
\\{mp\_no\_model});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withgreyscale"},\39\\{mp\_with\_option},\39%
\\{mp\_grey\_model});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withcolor"},\39\\{mp\_with\_option},\39\\{mp%
\_uninitialized\_model}){}$;\C{  \&{withrgbcolor} is an alias for \&{withcolor}
}\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withrgbcolor"},\39\\{mp\_with\_option},\39%
\\{mp\_rgb\_model});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"withcmykcolor"},\39\\{mp\_with\_option},\39%
\\{mp\_cmyk\_model}){}$;\par
\fi

\M{1123}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_thing\_to\_add}:\6
\&{if} ${}(\|m\E\\{contour\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"contour"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{double\_path\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"doublepath"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"also"});{}$\2\6
\&{break};\6
\4\&{case} \\{mp\_with\_option}:\6
\&{if} ${}(\|m\E\\{mp\_pen\_type}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withpen"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{with\_mp\_pre\_script}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withprescript"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{with\_mp\_post\_script}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withpostscript"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_no\_model}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withoutcolor"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_rgb\_model}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withrgbcolor"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_uninitialized\_model}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withcolor"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_cmyk\_model}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withcmykcolor"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_grey\_model}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"withgreyscale"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"dashed"});{}$\2\6
\&{break};\par
\fi

\M{1124}The \PB{\\{scan\_with\_list}} procedure parses a $\langle$with list$%
\rangle$ and
updates the list of graphical objects starting at \PB{\|p}.  Each $\langle$with
clause$\rangle$ updates all graphical objects whose \PB{\\{type}} is
compatible.
Other objects are ignored.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_scan\_with\_list}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_node} \|p);\par
\fi

\M{1125}Forcing the color to be between \PB{\T{0}} and \PB{\\{unity}} here
guarantees that no
picture will ever contain a color outside the legal range for \ps\ graphics.

\Y\B\4\D$\\{make\_cp\_a\_colored\_object}()$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{cp}\K\|p;{}$\6
\&{while} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{has\_color}(\\{cp}))\1\5
\&{break};\2\6
${}\\{cp}\K\\{mp\_link}(\\{cp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{clear\_color}(\|A)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}(((\&{mp\_stroked\_node})(\|A))\MG\\{cyan});{}$\6
${}\\{set\_number\_to\_zero}(((\&{mp\_stroked\_node})(\|A))\MG\\{magenta});{}$\6
${}\\{set\_number\_to\_zero}(((\&{mp\_stroked\_node})(\|A))\MG\\{yellow});{}$\6
${}\\{set\_number\_to\_zero}(((\&{mp\_stroked\_node})(\|A))\MG\\{black});{}$\6
${}\&{mp\_color\_model}((\|A))\K\\{mp\_uninitialized\_model};{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\B\4\D$\\{set\_color\_val}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
${}\\{number\_clone}(\|A,\39(\|B));{}$\6
\&{if} (\\{number\_negative}(\|A))\1\5
\\{set\_number\_to\_zero}(\|A);\2\6
\&{if} ${}(\\{number\_greater}(\|A,\39\\{unity\_t})){}$\1\5
\\{set\_number\_to\_unity}(\|A);\2\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{int} \\{is\_invalid\_with\_list}(\&{MP} \\{mp}${},\39\\{mp%
\_variable\_type}\|t){}$\1\1\2\2\6
${}\{{}$\1\6
\&{return} ${}((\|t\E\\{with\_mp\_pre\_script})\W(\\{mp}\MG\\{cur\_exp}.%
\\{type}\I\\{mp\_string\_type}))\V((\|t\E\\{with\_mp\_post\_script})\W(\\{mp}%
\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}))\V((\|t\E(\\{mp\_variable%
\_type})\\{mp\_uninitialized\_model})\W((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp%
\_cmykcolor\_type})\W(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_color\_type})\W(%
\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known})\W(\\{mp}\MG\\{cur\_exp}.\\{type}%
\I\\{mp\_boolean\_type})))\V((\|t\E(\\{mp\_variable\_type})\\{mp\_cmyk\_model})%
\W(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_cmykcolor\_type}))\V((\|t\E(\\{mp%
\_variable\_type})\\{mp\_rgb\_model})\W(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp%
\_color\_type}))\V((\|t\E(\\{mp\_variable\_type})\\{mp\_grey\_model})\W(\\{mp}%
\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}))\V((\|t\E(\\{mp\_variable\_type})\\{mp%
\_pen\_type})\W(\\{mp}\MG\\{cur\_exp}.\\{type}\I\|t))\V((\|t\E(\\{mp\_variable%
\_type})\\{mp\_picture\_type})\W(\\{mp}\MG\\{cur\_exp}.\\{type}\I\|t));{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{complain\_invalid\_with\_list}(\&{MP} \\{mp}${},\39\\{mp%
\_variable\_type}\|t){}$\1\1\2\2\6
${}\{{}$\C{ Complain about improper type }\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Next\ time\ say\ `with}\)\.{pen\
<known\ pen\ expre}\)\.{ssion>';"},\39\.{"I'll\ ignore\ the\ bad}\)\.{\ `with'\
clause\ and\ l}\)\.{ook\ for\ another."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
\&{if} ${}(\|t\E\\{with\_mp\_pre\_script}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{prescript\ <known\ str}\)%
\.{ing\ expression>';"};{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{with\_mp\_post\_script}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{postscript\ <known\ st}\)%
\.{ring\ expression>';"};{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_picture\_type}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `dash}\)\.{ed\ <known\ picture\ ex}\)%
\.{pression>';"};{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_uninitialized%
\_model}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{color\ <known\ color\ e}\)%
\.{xpression>';"};{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_rgb\_model}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{rgbcolor\ <known\ colo}\)%
\.{r\ expression>';"};{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_cmyk\_model}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{cmykcolor\ <known\ cmy}\)%
\.{kcolor\ expression>';}\)\.{"};{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_grey\_model}){}$\1\5
${}\\{hlp}[\T{0}]\K\.{"Next\ time\ say\ `with}\)\.{greyscale\ <known\ num}\)%
\.{eric\ expression>';"};{}$\2\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ type"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\7
\&{void} \\{mp\_scan\_with\_list}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|p)\1\1%
\2\2\6
${}\{{}$\1\6
\\{mp\_variable\_type}\|t;\C{ \PB{\\{cur\_mod}} of the \PB{\\{with\_option}}
(should match \PB{\\{cur\_type}}) }\7
\&{mp\_node} \|q;\C{ for list manipulation }\6
\&{mp\_node} \\{cp}${},{}$ \\{pp}${},{}$ \\{dp}${},{}$ \\{ap}${},{}$ \\{bp};\C{
objects being updated; \PB{\&{void}} initially; \PB{$\NULL$} to suppress update
}\7
${}\\{cp}\K\.{MP\_VOID};{}$\6
${}\\{pp}\K\.{MP\_VOID};{}$\6
${}\\{dp}\K\.{MP\_VOID};{}$\6
${}\\{ap}\K\.{MP\_VOID};{}$\6
${}\\{bp}\K\.{MP\_VOID};{}$\6
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_with\_option}){}$\5
${}\{{}$\C{ todo this is not very nice: the color models have their own
enumeration }\1\6
${}\|t\K(\\{mp\_variable\_type})\\{cur\_mod}(\,);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}(\|t\I(\\{mp\_variable\_type})\\{mp\_no\_model}){}$\1\5
\\{mp\_scan\_expression}(\\{mp});\2\6
\&{if} ${}(\\{is\_invalid\_with\_list}(\\{mp},\39\|t)){}$\5
${}\{{}$\1\6
${}\\{complain\_invalid\_with\_list}(\\{mp},\39\|t);{}$\6
\&{continue};\6
\4${}\}{}$\2\6
\&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_uninitialized\_model}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{cp}\E\.{MP\_VOID}){}$\1\5
\\{make\_cp\_a\_colored\_object}(\,);\2\6
\&{if} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\C{ Transfer a color from the current expression to object~\PB{\\{cp}}
}\1\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_color\_type}){}$\5
${}\{{}$\C{ Transfer a rgbcolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\\{clear\_color}(\\{cp0});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_rgb\_model};{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{red},\39\\{value\_number}(\\{red\_part}(%
\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{green},\39\\{value\_number}(\\{green%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{blue},\39\\{value\_number}(\\{blue\_part}(%
\|q)));{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_cmykcolor\_type}){}$%
\5
${}\{{}$\C{ Transfer a cmykcolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{cyan},\39\\{value\_number}(\\{cyan\_part}(%
\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{magenta},\39\\{value\_number}(\\{magenta%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{yellow},\39\\{value\_number}(\\{yellow%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{black},\39\\{value\_number}(\\{black%
\_part}(\|q)));{}$\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_cmyk\_model};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\C{ Transfer a greyscale from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_number} \\{qq};\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
\\{new\_number}(\\{qq});\6
${}\\{number\_clone}(\\{qq},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{clear\_color}(\\{cp});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_grey\_model};{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{grey},\39\\{qq});{}$\6
\\{free\_number}(\\{qq});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_false\_code}){}$\5
${}\{{}$\C{ Transfer a noncolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\\{clear\_color}(\\{cp});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_no\_model};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_exp\_value\_boolean}(\,)\E\\{mp\_true\_code}){}$\5
${}\{{}$\C{ Transfer no color from the current expression to object~\PB{\\{cp}}
}\1\6
\\{clear\_color}(\\{cp});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_uninitialized\_model};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_rgb\_model}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{cp}\E\.{MP\_VOID}){}$\1\5
\\{make\_cp\_a\_colored\_object}(\,);\2\6
\&{if} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\C{ Transfer a rgbcolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
\\{clear\_color}(\\{cp0});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_rgb\_model};{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{red},\39\\{value\_number}(\\{red\_part}(%
\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{green},\39\\{value\_number}(\\{green%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{blue},\39\\{value\_number}(\\{blue\_part}(%
\|q)));{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_cmyk\_model}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{cp}\E\.{MP\_VOID}){}$\1\5
\\{make\_cp\_a\_colored\_object}(\,);\2\6
\&{if} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\C{ Transfer a cmykcolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
${}\|q\K\\{value\_node}(\\{cur\_exp\_node}(\,));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{cyan},\39\\{value\_number}(\\{cyan\_part}(%
\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{magenta},\39\\{value\_number}(\\{magenta%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{yellow},\39\\{value\_number}(\\{yellow%
\_part}(\|q)));{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{black},\39\\{value\_number}(\\{black%
\_part}(\|q)));{}$\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_cmyk\_model};{}$\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_grey\_model}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{if} ${}(\\{cp}\E\.{MP\_VOID}){}$\1\5
\\{make\_cp\_a\_colored\_object}(\,);\2\6
\&{if} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\C{ Transfer a greyscale from the current expression to object~\PB{%
\\{cp}} }\1\6
\&{mp\_number} \\{qq};\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
\\{new\_number}(\\{qq});\6
${}\\{number\_clone}(\\{qq},\39\\{cur\_exp\_value\_number}(\,));{}$\6
\\{clear\_color}(\\{cp});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_grey\_model};{}$\6
${}\\{set\_color\_val}(\\{cp0}\MG\\{grey},\39\\{qq});{}$\6
\\{free\_number}(\\{qq});\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E(\\{mp\_variable\_type})\\{mp\_no\_model}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cp}\E\.{MP\_VOID}){}$\1\5
\\{make\_cp\_a\_colored\_object}(\,);\2\6
\&{if} ${}(\\{cp}\I\NULL){}$\5
${}\{{}$\C{ Transfer a noncolor from the current expression to object~\PB{%
\\{cp}} }\1\6
\\{clear\_color}(\\{cp});\6
${}\&{mp\_color\_model}(\\{cp})\K\\{mp\_no\_model};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{mp\_pen\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{pp}\E\.{MP\_VOID}){}$\5
${}\{{}$\C{ Make \PB{\\{pp}} an object in list~\PB{\|p} that needs a pen }\1\6
${}\\{pp}\K\|p;{}$\6
\&{while} ${}(\\{pp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{has\_pen}(\\{pp}))\1\5
\&{break};\2\6
${}\\{pp}\K\\{mp\_link}(\\{pp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{pp}\I\NULL){}$\5
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\\{pp}))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_fill\_node}) \\{pp})${}\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_fill\_node}) %
\\{pp}));\2\6
\\{mp\_pen\_p}((\&{mp\_fill\_node}) \\{pp})${}\K\\{cur\_exp\_knot}(\,);{}$\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \\{pp})${}\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_stroked\_node})
\\{pp}));\2\6
\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \\{pp})${}\K\\{cur\_exp\_knot}(\,);{}$\6
\&{break};\6
\4\&{default}:\5
\\{assert}(\T{0});\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{with\_mp\_pre\_script}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{ap}\E\.{MP\_VOID}){}$\1\5
${}\\{ap}\K\|p;{}$\2\6
\&{while} ${}((\\{ap}\I\NULL)\W(\R\\{has\_color}(\\{ap}))){}$\1\5
${}\\{ap}\K\\{mp\_link}(\\{ap});{}$\2\6
\&{if} ${}(\\{ap}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_pre\_script}(\\{ap})\I\NULL){}$\5
${}\{{}$\C{  build a new,combined string  }\1\6
\&{unsigned} \\{old\_setting};\C{ saved \PB{\\{selector}} setting }\6
\&{mp\_string} \|s;\C{ for string cleanup after combining  }\7
${}\|s\K\\{mp\_pre\_script}(\\{ap});{}$\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{str\_room}(\\{mp\_pre\_script}(\\{ap})\MG\\{len}+\\{cur\_exp\_str}(\,)\MG%
\\{len}+\T{2});{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
\\{append\_char}(\T{13});\C{ a forced \ps\ newline  }\6
${}\\{mp\_print\_str}(\\{mp},\39\\{mp\_pre\_script}(\\{ap}));{}$\6
${}\\{mp\_pre\_script}(\\{ap})\K\\{mp\_make\_string}(\\{mp});{}$\6
\\{delete\_str\_ref}(\|s);\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_pre\_script}(\\{ap})\K\\{cur\_exp\_str}(\,);{}$\6
\4${}\}{}$\2\6
\\{add\_str\_ref}(\\{mp\_pre\_script}(\\{ap}));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|t\E\\{with\_mp\_post\_script}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}){}$\5
${}\{{}$\1\6
\&{mp\_node} \|k${}\K\NULL{}$;\C{ for finding the near-last item in a list  }\7
\&{if} ${}(\\{bp}\E\.{MP\_VOID}){}$\1\5
${}\|k\K\|p;{}$\2\6
${}\\{bp}\K\|k;{}$\6
\&{while} ${}(\|k\W\\{mp\_link}(\|k)\I\NULL){}$\5
${}\{{}$\C{ clang: dereference null pointer 'k' }\1\6
${}\|k\K\\{mp\_link}(\|k);{}$\6
\&{if} (\\{has\_color}(\|k))\1\5
${}\\{bp}\K\|k;{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{bp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_post\_script}(\\{bp})\I\NULL){}$\5
${}\{{}$\1\6
\&{unsigned} \\{old\_setting};\C{ saved \PB{\\{selector}} setting }\6
\&{mp\_string} \|s;\C{ for string cleanup after combining  }\7
${}\|s\K\\{mp\_post\_script}(\\{bp});{}$\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{str\_room}(\\{mp\_post\_script}(\\{bp})\MG\\{len}+\\{cur\_exp\_str}(\,)%
\MG\\{len}+\T{2});{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{mp\_post\_script}(\\{bp}));{}$\6
\\{append\_char}(\T{13});\C{ a forced \ps\ newline  }\6
${}\\{mp\_print\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
${}\\{mp\_post\_script}(\\{bp})\K\\{mp\_make\_string}(\\{mp});{}$\6
\\{delete\_str\_ref}(\|s);\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_post\_script}(\\{bp})\K\\{cur\_exp\_str}(\,);{}$\6
\4${}\}{}$\2\6
\\{add\_str\_ref}(\\{mp\_post\_script}(\\{bp}));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{dp}\E\.{MP\_VOID}){}$\5
${}\{{}$\C{ Make \PB{\\{dp}} a stroked node in list~\PB{\|p} }\1\6
${}\\{dp}\K\|p;{}$\6
\&{while} ${}(\\{dp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\\{dp})\E\\{mp\_stroked\_node\_type}){}$\1\5
\&{break};\2\6
${}\\{dp}\K\\{mp\_link}(\\{dp});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{dp}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_dash\_p}(\\{dp})\I\NULL){}$\1\5
\\{delete\_edge\_ref}(\\{mp\_dash\_p}(\\{dp}));\2\6
${}\\{mp\_dash\_p}(\\{dp})\K{}$(\&{mp\_node}) \\{mp\_make\_dashes}${}(\\{mp},%
\39{}$(\&{mp\_edge\_header\_node}) \\{cur\_exp\_node}(\,));\6
\\{set\_number\_to\_unity}(((\&{mp\_stroked\_node}) \\{dp})${}\MG\\{dash%
\_scale});{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ Copy the information from objects \PB{\\{cp}}, \PB{\\{pp}}, and %
\PB{\\{dp}} into the rest     of the list }\2\6
\&{if} ${}(\\{cp}>\.{MP\_VOID}){}$\5
${}\{{}$\C{ Copy \PB{\\{cp}}'s color into the colored objects linked to~\PB{%
\\{cp}} }\1\6
${}\|q\K\\{mp\_link}(\\{cp});{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{has\_color}(\|q))\5
${}\{{}$\1\6
\&{mp\_stroked\_node} \\{q0}${}\K{}$(\&{mp\_stroked\_node}) \|q;\6
\&{mp\_stroked\_node} \\{cp0}${}\K{}$(\&{mp\_stroked\_node}) \\{cp};\7
${}\\{number\_clone}(\\{q0}\MG\\{red},\39\\{cp0}\MG\\{red});{}$\6
${}\\{number\_clone}(\\{q0}\MG\\{green},\39\\{cp0}\MG\\{green});{}$\6
${}\\{number\_clone}(\\{q0}\MG\\{blue},\39\\{cp0}\MG\\{blue});{}$\6
${}\\{number\_clone}(\\{q0}\MG\\{black},\39\\{cp0}\MG\\{black});{}$\6
${}\&{mp\_color\_model}(\|q)\K\&{mp\_color\_model}(\\{cp});{}$\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{pp}>\.{MP\_VOID}){}$\5
${}\{{}$\C{ Copy \PB{\\{mp\_pen\_p}(\\{pp})} into stroked and filled nodes
linked to \PB{\\{pp}} }\1\6
${}\|q\K\\{mp\_link}(\\{pp});{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\&{if} (\\{has\_pen}(\|q))\5
${}\{{}$\1\6
\&{switch} (\\{mp\_type}(\|q))\5
${}\{{}$\1\6
\4\&{case} \\{mp\_fill\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|q)${}\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_fill\_node}) %
\|q));\2\6
\\{mp\_pen\_p}((\&{mp\_fill\_node}) \|q)${}\K\\{copy\_pen}{}$(\\{mp\_pen\_p}((%
\&{mp\_fill\_node}) \\{pp}));\6
\&{break};\6
\4\&{case} \\{mp\_stroked\_node\_type}:\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|q)${}\I\NULL){}$\1\5
${}\\{mp\_toss\_knot\_list}(\\{mp},\39{}$\\{mp\_pen\_p}((\&{mp\_stroked\_node})
\|q));\2\6
\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|q)${}\K\\{copy\_pen}{}$(\\{mp\_pen%
\_p}((\&{mp\_stroked\_node}) \\{pp}));\6
\&{break};\6
\4\&{default}:\5
\\{assert}(\T{0});\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{dp}>\.{MP\_VOID}){}$\5
${}\{{}$\C{ Make stroked nodes linked to \PB{\\{dp}} refer to \PB{\\{mp\_dash%
\_p}(\\{dp})} }\1\6
${}\|q\K\\{mp\_link}(\\{dp});{}$\6
\&{while} ${}(\|q\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_type}(\|q)\E\\{mp\_stroked\_node\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_dash\_p}(\|q)\I\NULL){}$\1\5
\\{delete\_edge\_ref}(\\{mp\_dash\_p}(\|q));\2\6
${}\\{mp\_dash\_p}(\|q)\K\\{mp\_dash\_p}(\\{dp});{}$\6
\\{set\_number\_to\_unity}(((\&{mp\_stroked\_node}) \|q)${}\MG\\{dash%
\_scale});{}$\6
\&{if} ${}(\\{mp\_dash\_p}(\|q)\I\NULL){}$\1\5
\\{add\_edge\_ref}(\\{mp\_dash\_p}(\|q));\2\6
\4${}\}{}$\2\6
${}\|q\K\\{mp\_link}(\|q);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1126}One of the things we need to do when we've parsed an \&{addto} or
similar command is find the header of a supposed \&{picture} variable, given
a token list for that variable.  Since the edge structure is about to be
updated, we use \PB{\\{private\_edges}} to make sure that this is possible.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{mp\_edge\_header\_node} \\{mp\_find\_edges\_var}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_node} \|t);\par
\fi

\M{1127}\B\&{mp\_edge\_header\_node} \\{mp\_find\_edges\_var}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_node} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\6
\&{mp\_edge\_header\_node} \\{cur\_edges};\C{ the return value }\7
${}\|p\K\\{mp\_find\_variable}(\\{mp},\39\|t);{}$\6
${}\\{cur\_edges}\K\NULL;{}$\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"It\ seems\ you\ did\ a\ }\)\.{nasty%
\ thing---probab}\)\.{ly\ by\ accident,"},\39\.{"but\ nevertheless\ yo}\)\.{u\
nearly\ hornswoggle}\)\.{d\ me..."},\39\.{"While\ I\ was\ evaluat}\)\.{ing\ the%
\ right-hand\ s}\)\.{ide\ of\ this"},\39\.{"command,\ something\ }\)%
\.{happened,\ and\ the\ le}\)\.{ft-hand\ side"},\39\.{"is\ no\ longer\ a\ vari}%
\)\.{able!\ So\ I\ won't\ cha}\)\.{nge\ anything."},\39\NULL\};{}$\6
\&{char} ${}{*}\\{msg}\K\\{mp\_obliterated}(\\{mp},\39\|t);{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{free}(\\{msg});\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_type}(\|p)\I\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{mp\_string} \\{sname};\6
\&{int} \\{old\_setting}${}\K\\{mp}\MG\\{selector};{}$\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ was\ looking\ for\ a}\)\.{\ %
\\"known\\"\ picture\ v}\)\.{ariable."},\39\.{"So\ I'll\ not\ change\ }\)%
\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\\{mp\_show\_token\_list}(\\{mp},\39\|t,\39\NULL,\39\T{1000},\39\T{0});{}$\6
${}\\{sname}\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Variable\ \%s\ is\ the\ }\)%
\.{wrong\ type(\%s)"},\39\\{mp\_str}(\\{mp},\39\\{sname}),\39\\{mp\_type%
\_string}(\\{mp\_type}(\|p)));{}$\6
;\6
\\{delete\_str\_ref}(\\{sname});\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_value\_node}(\|p,\39{}$(\&{mp\_node}) \\{mp\_private\_edges}${}(%
\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{value\_node}(\|p)));\6
${}\\{cur\_edges}\K{}$(\&{mp\_edge\_header\_node}) \\{value\_node}(\|p);\6
\4${}\}{}$\2\6
${}\\{mp\_flush\_node\_list}(\\{mp},\39\|t);{}$\6
\&{return} \\{cur\_edges};\6
\4${}\}{}$\2\par
\fi

\M{1128}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"clip"},\39\\{mp\_bounds\_command},\39\\{mp%
\_start\_clip\_node\_type});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"setbounds"},\39\\{mp\_bounds\_command},\39%
\\{mp\_start\_bounds\_node\_type}){}$;\par
\fi

\M{1129}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_bounds\_command}:\6
\&{if} ${}(\|m\E\\{mp\_start\_clip\_node\_type}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"clip"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"setbounds"});{}$\2\6
\&{break};\par
\fi

\M{1130}The following function parses the beginning of an \&{addto} or \&{clip}
command: it expects a variable name followed by a token with \PB{$\\{cur\_cmd}%
\K\\{sep}$}
and then an expression.  The function returns the token list for the variable
and stores the command modifier for the separator token in the global variable
\PB{\\{last\_add\_type}}.  We must be careful because this variable might get
overwritten
any time we call \PB{\\{get\_x\_next}}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{quarterword} \\{last\_add\_type};\C{ command modifier that identifies the
last \&{addto} command }\par
\fi

\M{1131}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{mp\_start\_draw\_cmd}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \\{sep});\par
\fi

\M{1132}\B\&{mp\_node} \\{mp\_start\_draw\_cmd}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \\{sep})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{lhv};\C{ variable to add to left }\6
\&{quarterword} \\{add\_type}${}\K\T{0}{}$;\C{ value to be returned in \PB{%
\\{last\_add\_type}} }\7
${}\\{lhv}\K\NULL;{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{var\_flag}\K\\{sep};{}$\6
\\{mp\_scan\_primary}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_token\_list}){}$\5
${}\{{}$\C{ Abandon edges command because there's no variable }\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"At\ this\ point\ I\ nee}\)\.{ded\
to\ see\ the\ name\ }\)\.{of\ a\ picture\ variabl}\)\.{e."},\39\.{"(Or\ perhaps%
\ you\ hav}\)\.{e\ indeed\ presented\ m}\)\.{e\ with\ one;\ I\ might"},\39%
\.{"have\ missed\ it,\ if\ }\)\.{it\ wasn't\ followed\ b}\)\.{y\ the\ proper\
token.)}\)\.{"},\39\.{"So\ I'll\ not\ change\ }\)\.{anything\ just\ now."},\39%
\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ suitable\ vari}\)\.{able"},\39%
\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{lhv}\K\\{cur\_exp\_node}(\,);{}$\6
${}\\{add\_type}\K{}$(\&{quarterword}) \\{cur\_mod}(\,);\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{last\_add\_type}\K\\{add\_type};{}$\6
\&{return} \\{lhv};\6
\4${}\}{}$\2\par
\fi

\M{1133}Here is an example of how to use \PB{\\{start\_draw\_cmd}}.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_bounds}(\&{MP} \\{mp});\par
\fi

\M{1134}\B\&{void} \\{mp\_do\_bounds}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{lhv};\C{ variable on left, the corresponding edge structure }\6
\&{mp\_edge\_header\_node} \\{lhe};\6
\&{mp\_node} \|p;\C{ for list manipulation }\6
\&{integer} \|m;\C{ initial value of \PB{\\{cur\_mod}} }\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
${}\\{lhv}\K\\{mp\_start\_draw\_cmd}(\\{mp},\39\\{mp\_to\_token});{}$\6
\&{if} ${}(\\{lhv}\I\NULL){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{lhe}\K\\{mp\_find\_edges\_var}(\\{mp},\39\\{lhv});{}$\6
\&{if} ${}(\\{lhe}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ expression\ sho}\)\.{uld\
have\ specified\ a}\)\.{\ known\ path."},\39\.{"So\ I'll\ not\ change\ }\)%
\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ `clip'"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\E\\{mp%
\_endpoint}){}$\5
${}\{{}$\C{ Complain about a non-cycle }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"That\ contour\ should}\)\.{\ have\
ended\ with\ `..}\)\.{cycle'\ or\ `\&cycle'."},\39\.{"So\ I'll\ not\ change\ }%
\)\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ cycle"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Make \PB{\\{cur\_exp}} into a \&{setbounds} or clipping path and
add it to \PB{\\{lhe}} }\1\6
${}\|p\K\\{mp\_new\_bounds\_node}(\\{mp},\39\\{cur\_exp\_knot}(\,),\39{}$(%
\&{quarterword}) \|m);\6
${}\\{mp\_link}(\|p)\K\\{mp\_link}(\\{edge\_list}(\\{lhe}));{}$\6
${}\\{mp\_link}(\\{edge\_list}(\\{lhe}))\K\|p;{}$\6
\&{if} ${}(\\{obj\_tail}(\\{lhe})\E\\{edge\_list}(\\{lhe})){}$\1\5
${}\\{obj\_tail}(\\{lhe})\K\|p;{}$\2\6
\&{if} ${}(\|m\E\\{mp\_start\_clip\_node\_type}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_new\_bounds\_node}(\\{mp},\39\NULL,\39\\{mp\_stop\_clip\_node%
\_type});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{mp\_start\_bounds\_node\_type}){}$\5
${}\{{}$\1\6
${}\|p\K\\{mp\_new\_bounds\_node}(\\{mp},\39\NULL,\39\\{mp\_stop\_bounds\_node%
\_type});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_link}(\\{obj\_tail}(\\{lhe}))\K\|p;{}$\6
${}\\{obj\_tail}(\\{lhe})\K\|p;{}$\6
${}\\{mp\_init\_bbox}(\\{mp},\39\\{lhe});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1135}The \PB{\\{do\_add\_to}} procedure is a little like \PB{\\{do\_clip}}
but there are a lot more
cases to deal with.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_add\_to}(\&{MP} \\{mp});\par
\fi

\M{1136}\B\&{void} \\{mp\_do\_add\_to}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \\{lhv};\6
\&{mp\_edge\_header\_node} \\{lhe};\C{ variable on left, the corresponding edge
structure }\6
\&{mp\_node} \|p;\C{ the graphical object or list for \PB{\\{scan\_with\_list}}
to update }\6
\&{mp\_edge\_header\_node} \|e;\C{ an edge structure to be merged }\6
\&{quarterword} \\{add\_type};\C{ \PB{\\{also\_code}}, \PB{\\{contour\_code}},
or \PB{\\{double\_path\_code}} }\7
${}\\{lhv}\K\\{mp\_start\_draw\_cmd}(\\{mp},\39\\{mp\_thing\_to\_add});{}$\6
${}\\{add\_type}\K\\{mp}\MG\\{last\_add\_type};{}$\6
\&{if} ${}(\\{lhv}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{add\_type}\E\\{also\_code}){}$\5
${}\{{}$\C{ Make sure the current expression is a suitable picture and set \PB{%
\|e} and \PB{\|p}          appropriately }\C{ Setting \PB{\|p: $\K$ $\NULL$}
causes the $\langle$with list$\rangle$ to be ignored;          setting \PB{\|e:
$\K$ $\NULL$} prevents anything from being added to \PB{\\{lhe}}. }\1\6
${}\|p\K\NULL;{}$\6
${}\|e\K\NULL;{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ expression\ sho}\)\.{uld\
have\ specified\ a}\)\.{\ known\ picture."},\39\.{"So\ I'll\ not\ change\ }\)%
\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ `addto'"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|e\K\\{mp\_private\_edges}(\\{mp},\39{}$(\&{mp\_edge\_header\_node}) \\{cur%
\_exp\_node}(\,));\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\|e));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ Create a graphical object \PB{\|p} based on \PB{\\{add\_type}} and
the current          expression }\C{ In this case \PB{$\\{add\_type}%
\MRL{{<}{>}}\\{also\_code}$} so setting \PB{\|p: $\K$ $\NULL$} suppresses
future          attempts to add to the edge structure. }\1\6
${}\|e\K\NULL;{}$\6
${}\|p\K\NULL;{}$\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_pair\_type}){}$\1\5
\\{mp\_pair\_to\_path}(\\{mp});\2\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_path\_type}){}$\5
${}\{{}$\1\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ expression\ sho}\)\.{uld\
have\ specified\ a}\)\.{\ known\ path."},\39\.{"So\ I'll\ not\ change\ }\)%
\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ `addto'"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{add\_type}\E\\{contour\_code}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_left\_type}(\\{cur\_exp\_knot}(\,))\E\\{mp\_endpoint}){}$\5
${}\{{}$\C{ Complain about a non-cycle }\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"That\ contour\ should}\)\.{\ have\
ended\ with\ `..}\)\.{cycle'\ or\ `\&cycle'."},\39\.{"So\ I'll\ not\ change\ }%
\)\.{anything\ just\ now."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ cycle"},\39\\{hlp},\39%
\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_new\_fill\_node}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_new\_stroked\_node}(\\{mp},\39\\{cur\_exp\_knot}(\,));{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_scan\_with\_list}(\\{mp},\39\|p){}$;\C{ Use \PB{\|p}, \PB{\|e}, and %
\PB{\\{add\_type}} to augment \PB{\\{lhv}} as requested }\6
${}\\{lhe}\K\\{mp\_find\_edges\_var}(\\{mp},\39\\{lhv});{}$\6
\&{if} ${}(\\{lhe}\E\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}((\|e\E\NULL)\W(\|p\I\NULL)){}$\1\5
${}\|e\K\\{mp\_toss\_gr\_object}(\\{mp},\39\|p);{}$\2\6
\&{if} ${}(\|e\I\NULL){}$\1\5
\\{delete\_edge\_ref}(\|e);\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{add\_type}\E\\{also\_code}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|e\I\NULL){}$\5
${}\{{}$\C{ Merge \PB{\|e} into \PB{\\{lhe}} and delete \PB{\|e} }\1\6
\&{if} ${}(\\{mp\_link}(\\{edge\_list}(\|e))\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_link}(\\{obj\_tail}(\\{lhe}))\K\\{mp\_link}(\\{edge\_list}(\|e));{}$\6
${}\\{obj\_tail}(\\{lhe})\K\\{obj\_tail}(\|e);{}$\6
${}\\{obj\_tail}(\|e)\K\\{edge\_list}(\|e);{}$\6
${}\\{mp\_link}(\\{edge\_list}(\|e))\K\NULL;{}$\6
${}\\{mp\_flush\_dash\_list}(\\{mp},\39\\{lhe});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_toss\_edges}(\\{mp},\39\|e);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|p\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_link}(\\{obj\_tail}(\\{lhe}))\K\|p;{}$\6
${}\\{obj\_tail}(\\{lhe})\K\|p;{}$\6
\&{if} ${}(\\{add\_type}\E\\{double\_path\_code}){}$\5
${}\{{}$\1\6
\&{if} (\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p)${}\E\NULL){}$\5
${}\{{}$\1\6
\\{mp\_pen\_p}((\&{mp\_stroked\_node}) \|p)${}\K\\{mp\_get\_pen\_circle}(%
\\{mp},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1137}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\X1269:Declare the \ps\ output procedures\X;\7
\&{static} \&{void} \\{mp\_do\_ship\_out}(\&{MP} \\{mp});\par
\fi

\M{1138}\B\&{void} \\{mp\_do\_ship\_out}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \|c;\C{ the character code }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_picture\_type}){}$\5
${}\{{}$\1\6
\X1139:Complain that it's not a known picture\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|c\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_char\_code}))\MOD%
\T{256};{}$\6
\&{if} ${}(\|c<\T{0}){}$\1\5
${}\|c\K\|c+\T{256};{}$\2\6
\X1173:Store the width information for character code~\PB{\|c}\X;\6
${}\\{mp\_ship\_out}(\\{mp},\39\\{cur\_exp\_node}(\,));{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1139}\B\X1139:Complain that it's not a known picture\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ can\ only\ output\ k}\)\.{nown\
pictures."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ known\ picture}\)\.{"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\U1138.\fi

\M{1140}The \&{everyjob} command simply assigns a nonzero value to the global
variable
\PB{\\{start\_sym}}.


\fi

\M{1141}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_sym} \\{start\_sym};\C{ a symbolic token to insert at beginning of job }%
\par
\fi

\M{1142}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{start\_sym}\K\NULL{}$;\par
\fi

\M{1143}Finally, we have only the ``message'' commands remaining.

\Y\B\4\D$\\{message\_code}$ \5
\T{0}\par
\B\4\D$\\{err\_message\_code}$ \5
\T{1}\par
\B\4\D$\\{err\_help\_code}$ \5
\T{2}\par
\B\4\D$\\{filename\_template\_code}$ \5
\T{3}\par
\B\4\D$\\{print\_with\_leading\_zeroes}(\|A,\|B)$ \5
\&{do} \6
${}\{{}$\1\6
\&{size\_t} \|g${}\K\\{mp}\MG\\{cur\_length};{}$\6
\&{size\_t} \|f${}\K(\&{size\_t})(\|B);{}$\7
${}\\{mp\_print\_int}(\\{mp},\39(\|A));{}$\6
${}\|g\K\\{mp}\MG\\{cur\_length}-\|g;{}$\6
\&{if} ${}(\|f>\|g){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{cur\_length}\K\\{mp}\MG\\{cur\_length}-\|g;{}$\6
\&{while} ${}(\|f>\|g){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'0'}));{}$\6
\\{decr}(\|f);\6
\4${}\}{}$\2\6
;\6
${}\\{mp\_print\_int}(\\{mp},\39(\|A));{}$\6
\4${}\}{}$\2\6
;\6
${}\|f\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"message"},\39\\{mp\_message\_command},\39%
\\{message\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"errmessage"},\39\\{mp\_message\_command},\39%
\\{err\_message\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"errhelp"},\39\\{mp\_message\_command},\39%
\\{err\_help\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"filenametemplate"},\39\\{mp\_message%
\_command},\39\\{filename\_template\_code}){}$;\par
\fi

\M{1144}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_message\_command}:\6
\&{if} ${}(\|m<\\{err\_message\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"message"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{err\_message\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"errmessage"});{}$\2\6
\&{else} \&{if} ${}(\|m\E\\{filename\_template\_code}){}$\1\5
${}\\{mp\_print}(\\{mp},\39\.{"filenametemplate"});{}$\2\6
\&{else}\1\5
${}\\{mp\_print}(\\{mp},\39\.{"errhelp"});{}$\2\6
\&{break};\par
\fi

\M{1145}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\X1148:Declare a procedure called \PB{\\{no\_string\_err}}\X;\7
\&{static} \&{void} \\{mp\_do\_message}(\&{MP} \\{mp});\par
\fi

\M{1146}
\Y\B\&{void} \\{mp\_do\_message}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|m;\C{ the type of message }\6
\&{mp\_value} \\{new\_expr};\7
${}\|m\K\\{cur\_mod}(\,);{}$\6
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\1\5
${}\\{mp\_no\_string\_err}(\\{mp},\39\.{"A\ message\ should\ be}\)\.{\ a\ known%
\ string\ expr}\)\.{ession."});{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{message\_code}:\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
\&{break};\6
\4\&{case} \\{err\_message\_code}:\5
\X1152:Print string \PB{\\{cur\_exp}} as an error message\X;\6
\&{break};\6
\4\&{case} \\{err\_help\_code}:\5
\X1149:Save string \PB{\\{cur\_exp}} as the \PB{\\{err\_help}}\X;\6
\&{break};\6
\4\&{case} \\{filename\_template\_code}:\5
\X1147:Save the filename template\X;\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\4${}\}{}$\2\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{1147}\B\X1147:Save the filename template\X${}\E{}$\6
${}\{{}$\1\6
\\{delete\_str\_ref}(\\{internal\_string}(\\{mp\_output\_template}));\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_output\_template},\39\\{mp\_rts}(\\{mp},\39%
\.{"\%j.\%c"}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_internal\_string}(\\{mp\_output\_template},\39\\{cur\_exp\_str}(%
\,));{}$\6
\\{add\_str\_ref}(\\{internal\_string}(\\{mp\_output\_template}));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1146.\fi

\M{1148}\B\X1148:Declare a procedure called \PB{\\{no\_string\_err}}\X${}\E{}$\6
\&{static} \&{void} \\{mp\_no\_string\_err}(\&{MP} \\{mp}${},\39{}$\&{const} %
\&{char} ${}{*}\|s){}$\1\1\2\2\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\|s,\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Not\ a\ string"},\39\\{hlp},\39%
\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\U1145.\fi

\M{1149}The global variable \PB{\\{err\_help}} is zero when the user has most
recently
given an empty help string, or if none has ever been given.

\Y\B\4\X1149:Save string \PB{\\{cur\_exp}} as the \PB{\\{err\_help}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{err\_help}\I\NULL){}$\1\5
${}\\{delete\_str\_ref}(\\{mp}\MG\\{err\_help});{}$\2\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}\E\T{0}){}$\1\5
${}\\{mp}\MG\\{err\_help}\K\NULL;{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{err\_help}\K\\{cur\_exp\_str}(\,);{}$\6
${}\\{add\_str\_ref}(\\{mp}\MG\\{err\_help});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1146.\fi

\M{1150}If \&{errmessage} occurs often in \PB{\\{mp\_scroll\_mode}}, without
user-defined
\&{errhelp}, we don't want to give a long help message each time. So we
give a verbose explanation only once.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{long\_help\_seen};\C{ has the long \.{\\errmessage} help been
used? }\par
\fi

\M{1151}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{long\_help\_seen}\K\\{false}{}$;\par
\fi

\M{1152}\B\X1152:Print string \PB{\\{cur\_exp}} as an error message\X${}\E{}$\6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"\%s"},\39\\{mp\_str}(\\{mp},\39%
\\{cur\_exp\_str}(\,)));{}$\6
\&{if} ${}(\\{mp}\MG\\{err\_help}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{use\_err\_help}\K\\{true};{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\NULL,\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{long\_help\_seen}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"(That\ was\ another\ `}\)%
\.{errmessage'.)"},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"This\ error\ message\ }\)\.{was\
generated\ by\ an\ }\)\.{`errmessage'"},\39\.{"command,\ so\ I\ can\\'}\)\.{t\
give\ any\ explicit\ }\)\.{help."},\39\.{"Pretend\ that\ you're}\)\.{\ Miss\
Marple:\ Examin}\)\.{e\ all\ clues,"},\39\.{"and\ deduce\ the\ trut}\)\.{h\ by\
inspired\ guesse}\)\.{s."},\39\NULL\};{}$\7
\&{if} ${}(\\{mp}\MG\\{interaction}<\\{mp\_error\_stop\_mode}){}$\1\5
${}\\{mp}\MG\\{long\_help\_seen}\K\\{true};{}$\2\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp}\MG\\{use\_err\_help}\K\\{false};{}$\6
\4${}\}{}$\2\par
\U1146.\fi

\M{1153}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_write}(\&{MP} \\{mp});\par
\fi

\M{1154}\B\&{void} \\{mp\_do\_write}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_string} \|t;\C{ the line of text to be written }\6
\&{write\_index} \|n${},{}$ \\{n0};\C{ for searching \PB{\\{wr\_fname}} and %
\PB{\\{wr\_file}} arrays }\6
\&{unsigned} \\{old\_setting};\C{ for saving \PB{\\{selector}} during output }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
${}\\{mp\_no\_string\_err}(\\{mp},\39\.{"The\ text\ to\ be\ writ}\)\.{ten\
should\ be\ a\ know}\)\.{n\ string\ expression"});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_to\_token}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ write\ command\ sho}\)\.{uld\
end\ with\ `to\ <fi}\)\.{lename>'"},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `to'\ clause}\)\.{"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|t\K\\{cur\_exp\_str}(\,);{}$\6
${}\\{mp}\MG\\{cur\_exp}.\\{type}\K\\{mp\_vacuous};{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\1\5
${}\\{mp\_no\_string\_err}(\\{mp},\39\.{"I\ can\\'t\ write\ to\ t}\)\.{hat\
file\ name.\ \ It\ i}\)\.{sn't\ a\ known\ string"});{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X1155:Write \PB{\|t} to the file named by \PB{\\{cur\_exp}}\X;\6
\4${}\}{}$\C{ \PB{\\{delete\_str\_ref}(\|t);} }\C{ todo: is this right? }\2\6
\4${}\}{}$\2\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\par
\fi

\M{1155}\B\X1155:Write \PB{\|t} to the file named by \PB{\\{cur\_exp}}\X${}%
\E{}$\6
${}\{{}$\1\6
\X1156:Find \PB{\|n} where \PB{$\\{wr\_fname}[\|n]\K\\{cur\_exp}$} and call %
\PB{\\{open\_write\_file}} if \PB{\\{cur\_exp}} must be inserted\X;\6
\&{if} ${}(\\{mp\_str\_vs\_str}(\\{mp},\39\|t,\39\\{mp}\MG\\{eof\_line})\E%
\T{0}){}$\5
${}\{{}$\1\6
\X1157:Record the end of file on \PB{\\{wr\_file}[\|n]}\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\|n+\\{write\_file};{}$\6
${}\\{mp\_print\_str}(\\{mp},\39\|t);{}$\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1154.\fi

\M{1156}\B\X1156:Find \PB{\|n} where \PB{$\\{wr\_fname}[\|n]\K\\{cur\_exp}$}
and call \PB{\\{open\_write\_file}} if \PB{\\{cur\_exp}} must be inserted\X${}%
\E{}$\6
${}\{{}$\1\6
\&{char} ${}{*}\\{fn}\K\\{mp\_str}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\7
${}\|n\K\\{mp}\MG\\{write\_files};{}$\6
${}\\{n0}\K\\{mp}\MG\\{write\_files};{}$\6
\&{while} ${}(\\{mp\_xstrcmp}(\\{fn},\39\\{mp}\MG\\{wr\_fname}[\|n])\I\T{0}){}$%
\5
${}\{{}$\1\6
\&{if} ${}(\|n\E\T{0}){}$\5
${}\{{}$\C{ bottom reached }\1\6
\&{if} ${}(\\{n0}\E\\{mp}\MG\\{write\_files}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{write\_files}<\\{mp}\MG\\{max\_write\_files}){}$\5
${}\{{}$\1\6
${}\\{incr}(\\{mp}\MG\\{write\_files});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{void} ${}{*}{*}\\{wr\_file};{}$\6
\&{char} ${}{*}{*}\\{wr\_fname};{}$\6
\&{write\_index} \|l${},{}$ \|k;\7
${}\|l\K\\{mp}\MG\\{max\_write\_files}+(\\{mp}\MG\\{max\_write\_files}/%
\T{4});{}$\6
${}\\{wr\_file}\K\\{xmalloc}((\|l+\T{1}),\39{}$\&{sizeof}(\&{void} ${}{*}));{}$%
\6
${}\\{wr\_fname}\K\\{xmalloc}((\|l+\T{1}),\39{}$\&{sizeof}(\&{char}
${}{*}));{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\|l;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|k\Z\\{mp}\MG\\{max\_write\_files}){}$\5
${}\{{}$\1\6
${}\\{wr\_file}[\|k]\K\\{mp}\MG\\{wr\_file}[\|k];{}$\6
${}\\{wr\_fname}[\|k]\K\\{mp}\MG\\{wr\_fname}[\|k];{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{wr\_file}[\|k]\K\T{0};{}$\6
${}\\{wr\_fname}[\|k]\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{wr\_file});{}$\6
${}\\{xfree}(\\{mp}\MG\\{wr\_fname});{}$\6
${}\\{mp}\MG\\{max\_write\_files}\K\|l;{}$\6
${}\\{mp}\MG\\{wr\_file}\K\\{wr\_file};{}$\6
${}\\{mp}\MG\\{wr\_fname}\K\\{wr\_fname};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|n\K\\{n0};{}$\6
${}\\{mp\_open\_write\_file}(\\{mp},\39\\{fn},\39\|n);{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{decr}(\|n);\6
\&{if} ${}(\\{mp}\MG\\{wr\_fname}[\|n]\E\NULL){}$\1\5
${}\\{n0}\K\|n;{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1155.\fi

\M{1157}\B\X1157:Record the end of file on \PB{\\{wr\_file}[\|n]}\X${}\E{}$\6
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{wr\_file}[\|n]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{wr\_fname}[\|n]);{}$\6
\&{if} ${}(\|n\E\\{mp}\MG\\{write\_files}-\T{1}){}$\1\5
${}\\{mp}\MG\\{write\_files}\K\|n;{}$\2\6
\4${}\}{}$\2\par
\U1155.\fi

\N{1}{1158}Writing font metric data.
\TeX\ gets its knowledge about fonts from font metric files, also called
\.{TFM} files; the `\.T' in `\.{TFM}' stands for \TeX,
but other programs know about them too. One of \MP's duties is to
write \.{TFM} files so that the user's fonts can readily be
applied to typesetting.

The information in a \.{TFM} file appears in a sequence of 8-bit bytes.
Since the number of bytes is always a multiple of~4, we could
also regard the file as a sequence of 32-bit words, but \MP\ uses the
byte interpretation. The format of \.{TFM} files was designed by
Lyle Ramshaw in 1980. The intent is to convey a lot of different kinds
of information in a compact but useful form.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{tfm\_file}{}$;\C{ the font metric output goes here }\6
\&{char} ${}{*}\\{metric\_file\_name}{}$;\C{ full name of the font metric file
}\par
\fi

\M{1159}The first 24 bytes (6 words) of a \.{TFM} file contain twelve 16-bit
integers that give the lengths of the various subsequent portions
of the file. These twelve integers are, in order:
$$\vbox{\halign{\hfil#&$\null=\null$#\hfil\cr
\PB{\\{lf}}&length of the entire file, in words;\cr
\PB{\\{lh}}&length of the header data, in words;\cr
\PB{\\{bc}}&smallest character code in the font;\cr
\PB{\\{ec}}&largest character code in the font;\cr
\PB{\\{nw}}&number of words in the width table;\cr
\PB{\\{nh}}&number of words in the height table;\cr
\PB{\\{nd}}&number of words in the depth table;\cr
\PB{\\{ni}}&number of words in the italic correction table;\cr
\PB{\\{nl}}&number of words in the lig/kern table;\cr
\PB{\\{nk}}&number of words in the kern table;\cr
\PB{\\{ne}}&number of words in the extensible character table;\cr
\PB{\\{np}}&number of font parameter words.\cr}}$$
They are all nonnegative and less than $2^{15}$. We must have \PB{$\\{bc}-\T{1}%
\Z\\{ec}\Z\T{255}$},
\PB{$\\{ne}\Z\T{256}$}, and
$$\hbox{\PB{$\\{lf}\K\T{6}+\\{lh}+(\\{ec}-\\{bc}+\T{1})+\\{nw}+\\{nh}+\\{nd}+%
\\{ni}+\\{nl}+\\{nk}+\\{ne}+\\{np}$}.}$$
Note that a font may contain as many as 256 characters (if \PB{$\\{bc}\K\T{0}$}
and \PB{$\\{ec}\K\T{255}$}),
and as few as 0 characters (if \PB{$\\{bc}\K\\{ec}+\T{1}$}).

Incidentally, when two or more 8-bit bytes are combined to form an integer of
16 or more bits, the most significant bytes appear first in the file.
This is called BigEndian order.

\fi

\M{1160}The rest of the \.{TFM} file may be regarded as a sequence of ten data
arrays.

The most important data type used here is a \PB{\\{fix\_word}}, which is
a 32-bit representation of a binary fraction. A \PB{\\{fix\_word}} is a signed
quantity, with the two's complement of the entire word used to represent
negation. Of the 32 bits in a \PB{\\{fix\_word}}, exactly 12 are to the left of
the
binary point; thus, the largest \PB{\\{fix\_word}} value is $2048-2^{-20}$, and
the smallest is $-2048$. We will see below, however, that all but two of
the \PB{\\{fix\_word}} values must lie between $-16$ and $+16$.

\fi

\M{1161}The first data array is a block of header information, which contains
general facts about the font. The header must contain at least two words,
\PB{\\{header}[\T{0}]} and \PB{\\{header}[\T{1}]}, whose meaning is explained
below.  Additional
header information of use to other software routines might also be
included, and \MP\ will generate it if the \.{headerbyte} command occurs.
For example, 16 more words of header information are in use at the Xerox
Palo Alto Research Center; the first ten specify the character coding
scheme used (e.g., `\.{XEROX TEXT}' or `\.{TEX MATHSY}'), the next five
give the font family name (e.g., `\.{HELVETICA}' or `\.{CMSY}'), and the
last gives the ``face byte.''

\yskip\hang\PB{\\{header}[\T{0}]} is a 32-bit check sum that \MP\ will copy
into
the \.{GF} output file. This helps ensure consistency between files,
since \TeX\ records the check sums from the \.{TFM}'s it reads, and these
should match the check sums on actual fonts that are used.  The actual
relation between this check sum and the rest of the \.{TFM} file is not
important; the check sum is simply an identification number with the
property that incompatible fonts almost always have distinct check sums.

\yskip\hang\PB{\\{header}[\T{1}]} is a \PB{\\{fix\_word}} containing the design
size of the
font, in units of \TeX\ points. This number must be at least 1.0; it is
fairly arbitrary, but usually the design size is 10.0 for a ``10 point''
font, i.e., a font that was designed to look best at a 10-point size,
whatever that really means. When a \TeX\ user asks for a font `\.{at}
$\delta$ \.{pt}', the effect is to override the design size and replace it
by $\delta$, and to multiply the $x$ and~$y$ coordinates of the points in
the font image by a factor of $\delta$ divided by the design size.  {\sl
All other dimensions in the\/ \.{TFM} file are \PB{\\{fix\_word}}\kern-1pt\
numbers in design-size units.} Thus, for example, the value of \PB{\\{param}[%
\T{6}]},
which defines the \.{em} unit, is often the \PB{\\{fix\_word}} value
$2^{20}=1.0$,
since many fonts have a design size equal to one em.  The other dimensions
must be less than 16 design-size units in absolute value; thus,
\PB{\\{header}[\T{1}]} and \PB{\\{param}[\T{1}]} are the only \PB{\\{fix%
\_word}} entries in the whole
\.{TFM} file whose first byte might be something besides 0 or 255.

\fi

\M{1162}Next comes the \PB{\\{char\_info}} array, which contains one \PB{%
\\{char\_info\_word}}
per character. Each word in this part of the file contains six fields
packed into four bytes as follows.

\yskip\hang first byte: \PB{\\{width\_index}} (8 bits)\par
\hang second byte: \PB{\\{height\_index}} (4 bits) times 16, plus \PB{\\{depth%
\_index}}
(4~bits)\par
\hang third byte: \PB{\\{italic\_index}} (6 bits) times 4, plus \PB{\\{tag}}
(2~bits)\par
\hang fourth byte: \PB{\\{remainder}} (8 bits)\par
\yskip\noindent
The actual width of a character is \\{width}\PB{[\\{width\_index}]}, in
design-size
units; this is a device for compressing information, since many characters
have the same width. Since it is quite common for many characters
to have the same height, depth, or italic correction, the \.{TFM} format
imposes a limit of 16 different heights, 16 different depths, and
64 different italic corrections.

Incidentally, the relation $\\{width}[0]=\\{height}[0]=\\{depth}[0]=
\\{italic}[0]=0$ should always hold, so that an index of zero implies a
value of zero.  The \PB{\\{width\_index}} should never be zero unless the
character does not exist in the font, since a character is valid if and
only if it lies between \PB{\\{bc}} and \PB{\\{ec}} and has a nonzero \PB{%
\\{width\_index}}.

\fi

\M{1163}The \PB{\\{tag}} field in a \PB{\\{char\_info\_word}} has four values
that explain how to
interpret the \PB{\\{remainder}} field.

\yskip\hang\PB{$\\{tag}\K\T{0}$} (\PB{\\{no\_tag}}) means that \PB{%
\\{remainder}} is unused.\par
\hang\PB{$\\{tag}\K\T{1}$} (\PB{\\{lig\_tag}}) means that this character has a
ligature/kerning
program starting at location \PB{\\{remainder}} in the \PB{\\{lig\_kern}}
array.\par
\hang\PB{$\\{tag}\K\T{2}$} (\PB{\\{list\_tag}}) means that this character is
part of a chain of
characters of ascending sizes, and not the largest in the chain.  The
\PB{\\{remainder}} field gives the character code of the next larger character.%
\par
\hang\PB{$\\{tag}\K\T{3}$} (\PB{\\{ext\_tag}}) means that this character code
represents an
extensible character, i.e., a character that is built up of smaller pieces
so that it can be made arbitrarily large. The pieces are specified in
\PB{\\{exten}[\\{remainder}]}.\par
\yskip\noindent
Characters with \PB{$\\{tag}\K\T{2}$} and \PB{$\\{tag}\K\T{3}$} are treated as
characters with \PB{$\\{tag}\K\T{0}$}
unless they are used in special circumstances in math formulas. For example,
\TeX's \.{\\sum} operation looks for a \PB{\\{list\_tag}}, and the \.{\\left}
operation looks for both \PB{\\{list\_tag}} and \PB{\\{ext\_tag}}.

\Y\B\4\D$\\{no\_tag}$ \5
\T{0}\C{ vanilla character }\par
\B\4\D$\\{lig\_tag}$ \5
\T{1}\C{ character has a ligature/kerning program }\par
\B\4\D$\\{list\_tag}$ \5
\T{2}\C{ character has a successor in a charlist }\par
\B\4\D$\\{ext\_tag}$ \5
\T{3}\C{ character is extensible }\par
\fi

\M{1164}The \PB{\\{lig\_kern}} array contains instructions in a simple
programming language
that explains what to do for special letter pairs. Each word in this array is a
\PB{\\{lig\_kern\_command}} of four bytes.

\yskip\hang first byte: \PB{\\{skip\_byte}}, indicates that this is the final
program
step if the byte is 128 or more, otherwise the next step is obtained by
skipping this number of intervening steps.\par
\hang second byte: \PB{\\{next\_char}}, ``if \PB{\\{next\_char}} follows the
current character,
then perform the operation and stop, otherwise continue.''\par
\hang third byte: \PB{\\{op\_byte}}, indicates a ligature step if less
than~128,
a kern step otherwise.\par
\hang fourth byte: \PB{\\{remainder}}.\par
\yskip\noindent
In a kern step, an
additional space equal to \PB{$\\{kern}[\T{256}*(\\{op\_byte}-\T{128})+%
\\{remainder}]$} is inserted
between the current character and \PB{\\{next\_char}}. This amount is
often negative, so that the characters are brought closer together
by kerning; but it might be positive.

There are eight kinds of ligature steps, having \PB{\\{op\_byte}} codes
$4a+2b+c$ where
$0\le a\le b+c$ and $0\le b,c\le1$. The character whose code is
\PB{\\{remainder}} is inserted between the current character and \PB{\\{next%
\_char}};
then the current character is deleted if $b=0$, and \PB{\\{next\_char}} is
deleted if $c=0$; then we pass over $a$~characters to reach the next
current character (which may have a ligature/kerning program of its own).

If the very first instruction of the \PB{\\{lig\_kern}} array has \PB{$\\{skip%
\_byte}\K\T{255}$},
the \PB{\\{next\_char}} byte is the so-called right boundary character of this
font;
the value of \PB{\\{next\_char}} need not lie between \PB{\\{bc}} and~\PB{%
\\{ec}}.
If the very last instruction of the \PB{\\{lig\_kern}} array has \PB{$\\{skip%
\_byte}\K\T{255}$},
there is a special ligature/kerning program for a left boundary character,
beginning at location \PB{$\T{256}*\\{op\_byte}+\\{remainder}$}.
The interpretation is that \TeX\ puts implicit boundary characters
before and after each consecutive string of characters from the same font.
These implicit characters do not appear in the output, but they can affect
ligatures and kerning.

If the very first instruction of a character's \PB{\\{lig\_kern}} program has
\PB{$\\{skip\_byte}>\T{128}$}, the program actually begins in location
\PB{$\T{256}*\\{op\_byte}+\\{remainder}$}. This feature allows access to large %
\PB{\\{lig\_kern}}
arrays, because the first instruction must otherwise
appear in a location \PB{$\Z$ \T{255}}.

Any instruction with \PB{$\\{skip\_byte}>\T{128}$} in the \PB{\\{lig\_kern}}
array must satisfy
the condition
$$\hbox{\PB{$\T{256}*\\{op\_byte}+\\{remainder}<\\{nl}$}.}$$
If such an instruction is encountered during
normal program execution, it denotes an unconditional halt; no ligature
command is performed.

\Y\B\4\D$\\{stop\_flag}$ \5
(\T{128})\C{ value indicating `\.{STOP}' in a lig/kern program }\par
\B\4\D$\\{kern\_flag}$ \5
(\T{128})\C{ op code for a kern step }\par
\B\4\D$\\{skip\_byte}(\|A)$ \5
$\\{mp}\MG\\{lig\_kern}[(\|A)].{}$\\{b0}\par
\B\4\D$\\{next\_char}(\|A)$ \5
$\\{mp}\MG\\{lig\_kern}[(\|A)].{}$\\{b1}\par
\B\4\D$\\{op\_byte}(\|A)$ \5
$\\{mp}\MG\\{lig\_kern}[(\|A)].{}$\\{b2}\par
\B\4\D$\\{rem\_byte}(\|A)$ \5
$\\{mp}\MG\\{lig\_kern}[(\|A)].{}$\\{b3}\par
\fi

\M{1165}Extensible characters are specified by an \PB{\\{extensible\_recipe}},
which
consists of four bytes called \PB{\\{top}}, \PB{\\{mid}}, \PB{\\{bot}}, and %
\PB{\\{rep}} (in this
order). These bytes are the character codes of individual pieces used to
build up a large symbol.  If \PB{\\{top}}, \PB{\\{mid}}, or \PB{\\{bot}} are
zero, they are not
present in the built-up result. For example, an extensible vertical line is
like an extensible bracket, except that the top and bottom pieces are missing.

Let $T$, $M$, $B$, and $R$ denote the respective pieces, or an empty box
if the piece isn't present. Then the extensible characters have the form
$TR^kMR^kB$ from top to bottom, for some \PB{$\|k\G\T{0}$}, unless $M$ is
absent;
in the latter case we can have $TR^kB$ for both even and odd values of~\PB{%
\|k}.
The width of the extensible character is the width of $R$; and the
height-plus-depth is the sum of the individual height-plus-depths of the
components used, since the pieces are butted together in a vertical list.

\Y\B\4\D$\\{ext\_top}(\|A)$ \5
$\\{mp}\MG\\{exten}[(\|A)].{}$\\{b0}\C{ \PB{\\{top}} piece in a recipe }\par
\B\4\D$\\{ext\_mid}(\|A)$ \5
$\\{mp}\MG\\{exten}[(\|A)].{}$\\{b1}\C{ \PB{\\{mid}} piece in a recipe }\par
\B\4\D$\\{ext\_bot}(\|A)$ \5
$\\{mp}\MG\\{exten}[(\|A)].{}$\\{b2}\C{ \PB{\\{bot}} piece in a recipe }\par
\B\4\D$\\{ext\_rep}(\|A)$ \5
$\\{mp}\MG\\{exten}[(\|A)].{}$\\{b3}\C{ \PB{\\{rep}} piece in a recipe }\par
\fi

\M{1166}The final portion of a \.{TFM} file is the \PB{\\{param}} array, which
is another
sequence of \PB{\\{fix\_word}} values.

\yskip\hang\PB{$\\{param}[\T{1}]\K\\{slant}$} is the amount of italic slant,
which is used
to help position accents. For example, \PB{$\\{slant}\K\T{.25}$} means that
when you go
up one unit, you also go .25 units to the right. The \PB{\\{slant}} is a pure
number; it is the only \PB{\\{fix\_word}} other than the design size itself
that is
not scaled by the design size.

\hang\PB{$\\{param}[\T{2}]\K\\{space}$} is the normal spacing between words in
text.
Note that character 040 in the font need not have anything to do with
blank spaces.

\hang\PB{$\\{param}[\T{3}]\K\\{space\_stretch}$} is the amount of glue
stretching between words.

\hang\PB{$\\{param}[\T{4}]\K\\{space\_shrink}$} is the amount of glue shrinking
between words.

\hang\PB{$\\{param}[\T{5}]\K\\{x\_height}$} is the size of one ex in the font;
it is also
the height of letters for which accents don't have to be raised or lowered.

\hang\PB{$\\{param}[\T{6}]\K\\{quad}$} is the size of one em in the font.

\hang\PB{$\\{param}[\T{7}]\K\\{extra\_space}$} is the amount added to \PB{%
\\{param}[\T{2}]} at the
ends of sentences.

\yskip\noindent
If fewer than seven parameters are present, \TeX\ sets the missing parameters
to zero.

\Y\B\4\D$\\{slant\_code}$ \5
\T{1}\par
\B\4\D$\\{space\_code}$ \5
\T{2}\par
\B\4\D$\\{space\_stretch\_code}$ \5
\T{3}\par
\B\4\D$\\{space\_shrink\_code}$ \5
\T{4}\par
\B\4\D$\\{x\_height\_code}$ \5
\T{5}\par
\B\4\D$\\{quad\_code}$ \5
\T{6}\par
\B\4\D$\\{extra\_space\_code}$ \5
\T{7}\par
\fi

\M{1167}So that is what \.{TFM} files hold. One of \MP's duties is to output
such
information, and it does this all at once at the end of a job.
In order to prepare for such frenetic activity, it squirrels away the
necessary facts in various arrays as information becomes available.

Character dimensions (\&{charwd}, \&{charht}, \&{chardp}, and \&{charic})
are stored respectively in \PB{\\{tfm\_width}}, \PB{\\{tfm\_height}}, \PB{%
\\{tfm\_depth}}, and
\PB{\\{tfm\_ital\_corr}}. Other information about a character (e.g., about
its ligatures or successors) is accessible via the \PB{\\{char\_tag}} and
\PB{\\{char\_remainder}} arrays. Other information about the font as a whole
is kept in additional arrays called \PB{\\{header\_byte}}, \PB{\\{lig\_kern}},
\PB{\\{kern}}, \PB{\\{exten}}, and \PB{\\{param}}.

\Y\B\4\D$\\{max\_tfm\_int}$ \5
\T{32510}\par
\B\4\D$\\{undefined\_label}$ \5
\\{max\_tfm\_int}\C{ an undefined local label }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\8\#\&{define} \.{TFM\_ITEMS} \5\T{257}\6
\&{eight\_bits} \\{bc};\6
\&{eight\_bits} \\{ec};\C{ smallest and largest character codes shipped out }\6
\&{mp\_node} \\{tfm\_width}[\.{TFM\_ITEMS}];\C{ \&{charwd} values }\6
\&{mp\_node} \\{tfm\_height}[\.{TFM\_ITEMS}];\C{ \&{charht} values }\6
\&{mp\_node} \\{tfm\_depth}[\.{TFM\_ITEMS}];\C{ \&{chardp} values }\6
\&{mp\_node} \\{tfm\_ital\_corr}[\.{TFM\_ITEMS}];\C{ \&{charic} values }\6
\&{boolean} \\{char\_exists}[\.{TFM\_ITEMS}];\C{ has this code been shipped
out? }\6
\&{int} \\{char\_tag}[\.{TFM\_ITEMS}];\C{ \PB{\\{remainder}} category }\6
\&{int} \\{char\_remainder}[\.{TFM\_ITEMS}];\C{ the \PB{\\{remainder}} byte }\6
\&{char} ${}{*}\\{header\_byte}{}$;\C{ bytes of the \.{TFM} header }\6
\&{int} \\{header\_last};\C{ last initialized \.{TFM} header byte }\6
\&{int} \\{header\_size};\C{ size of the \.{TFM} header }\6
\&{four\_quarters} ${}{*}\\{lig\_kern}{}$;\C{ the ligature/kern table }\6
\&{short} \\{nl};\C{ the number of ligature/kern steps so far }\6
\&{mp\_number} ${}{*}\\{kern}{}$;\C{ distinct kerning amounts }\6
\&{short} \\{nk};\C{ the number of distinct kerns so far }\6
\&{four\_quarters} \\{exten}[\.{TFM\_ITEMS}];\C{ extensible character recipes }%
\6
\&{short} \\{ne};\C{ the number of extensible characters so far }\6
\&{mp\_number} ${}{*}\\{param}{}$;\C{ \&{fontinfo} parameters }\6
\&{short} \\{np};\C{ the largest \&{fontinfo} parameter specified so far }\6
\&{short} \\{nw};\6
\&{short} \\{nh};\6
\&{short} \\{nd};\6
\&{short} \\{ni};\C{ sizes of \.{TFM} subtables }\6
\&{short} \\{skip\_table}[\.{TFM\_ITEMS}];\C{ local label status }\6
\&{boolean} \\{lk\_started};\C{ has there been a lig/kern step in this command
yet? }\6
\&{integer} \\{bchar};\C{ right boundary character }\6
\&{short} \\{bch\_label};\C{ left boundary starting location }\6
\&{short} \\{ll};\6
\&{short} \\{lll};\C{ registers used for lig/kern processing }\6
\&{short} \\{label\_loc}[\T{257}];\C{ lig/kern starting addresses }\6
\&{eight\_bits} \\{label\_char}[\T{257}];\C{ characters for \PB{\\{label\_loc}}
}\6
\&{short} \\{label\_ptr};\C{ highest position occupied in \PB{\\{label\_loc}} }%
\par
\fi

\M{1168}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{header\_last}\K\T{7};{}$\6
${}\\{mp}\MG\\{header\_size}\K\T{128}{}$;\C{ just for init }\6
${}\\{mp}\MG\\{header\_byte}\K\\{xmalloc}(\\{mp}\MG\\{header\_size},\39%
\&{sizeof}(\&{char})){}$;\par
\fi

\M{1169}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{header\_byte});{}$\6
${}\\{xfree}(\\{mp}\MG\\{lig\_kern});{}$\6
\&{if} ${}(\\{mp}\MG\\{kern}){}$\5
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<(\\{max\_tfm\_int}+\T{1});{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{kern}[\|i]);{}$\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{kern});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{param}){}$\5
${}\{{}$\1\6
\&{int} \|i;\7
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<(\\{max\_tfm\_int}+\T{1});{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{free\_number}(\\{mp}\MG\\{param}[\|i]);{}$\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{param});{}$\6
\4${}\}{}$\2\par
\fi

\M{1170}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{255};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{tfm\_width}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{tfm\_height}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{tfm\_depth}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{tfm\_ital\_corr}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{char\_exists}[\|k]\K\\{false};{}$\6
${}\\{mp}\MG\\{char\_tag}[\|k]\K\\{no\_tag};{}$\6
${}\\{mp}\MG\\{char\_remainder}[\|k]\K\T{0};{}$\6
${}\\{mp}\MG\\{skip\_table}[\|k]\K\\{undefined\_label};{}$\6
\4${}\}{}$\2\6
${}\\{memset}(\\{mp}\MG\\{header\_byte},\39\T{0},\39{}$(\&{size\_t}) \\{mp}${}%
\MG\\{header\_size});{}$\6
${}\\{mp}\MG\\{bc}\K\T{255};{}$\6
${}\\{mp}\MG\\{ec}\K\T{0};{}$\6
${}\\{mp}\MG\\{nl}\K\T{0};{}$\6
${}\\{mp}\MG\\{nk}\K\T{0};{}$\6
${}\\{mp}\MG\\{ne}\K\T{0};{}$\6
${}\\{mp}\MG\\{np}\K\T{0};{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_boundary\_char},\39\\{unity\_t});{}$\6
\\{number\_negate}(\\{internal\_value}(\\{mp\_boundary\_char}));\6
${}\\{mp}\MG\\{bch\_label}\K\\{undefined\_label};{}$\6
${}\\{mp}\MG\\{label\_loc}[\T{0}]\K{-}\T{1};{}$\6
${}\\{mp}\MG\\{label\_ptr}\K\T{0}{}$;\par
\fi

\M{1171}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{mp\_node} \\{mp\_tfm\_check}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|m);\par
\fi

\M{1172}\B\&{static} \&{mp\_node} \\{mp\_tfm\_check}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|m)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \\{absm};\6
\&{mp\_node} \|p${}\K\\{mp\_get\_value\_node}(\\{mp});{}$\7
\\{new\_number}(\\{absm});\6
${}\\{number\_clone}(\\{absm},\39\\{internal\_value}(\|m));{}$\6
\\{number\_abs}(\\{absm});\6
\&{if} ${}(\\{number\_greaterequal}(\\{absm},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Font\ metric\ dimensi}\)\.{ons\
must\ be\ less\ tha}\)\.{n\ 2048pt."},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Enormous\ \%s\ has\ bee}\)\.{n\
reduced"},\39\\{internal\_name}(\|m));{}$\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\|m)))\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{fraction\_half\_t});{}$\6
${}\\{number\_add\_scaled}(\\{value\_number}(\|p),\39{-}\T{1});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{fraction\_half\_t});{}$\6
\\{number\_negate}(\\{value\_number}(\|p));\6
${}\\{number\_add\_scaled}(\\{value\_number}(\|p),\39\T{1});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_value\_number}(\|p,\39\\{internal\_value}(\|m));{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{absm});\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{1173}\B\X1173:Store the width information for character code~\PB{\|c}\X${}%
\E{}$\6
\&{if} ${}(\|c<\\{mp}\MG\\{bc}){}$\1\5
${}\\{mp}\MG\\{bc}\K{}$(\&{eight\_bits}) \|c;\2\6
\&{if} ${}(\|c>\\{mp}\MG\\{ec}){}$\1\5
${}\\{mp}\MG\\{ec}\K{}$(\&{eight\_bits}) \|c;\2\6
${}\\{mp}\MG\\{char\_exists}[\|c]\K\\{true};{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{tfm\_width}[\|c]);{}$\6
${}\\{mp}\MG\\{tfm\_width}[\|c]\K\\{mp\_tfm\_check}(\\{mp},\39\\{mp\_char%
\_wd});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{tfm\_height}[\|c]);{}$\6
${}\\{mp}\MG\\{tfm\_height}[\|c]\K\\{mp\_tfm\_check}(\\{mp},\39\\{mp\_char%
\_ht});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{tfm\_depth}[\|c]);{}$\6
${}\\{mp}\MG\\{tfm\_depth}[\|c]\K\\{mp\_tfm\_check}(\\{mp},\39\\{mp\_char%
\_dp});{}$\6
${}\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{tfm\_ital\_corr}[\|c]);$ $%
\\{mp}\MG\\{tfm\_ital\_corr}[\|c]\K\\{mp\_tfm\_check}(\\{mp},\39\\{mp\_char%
\_ic}{}$)\par
\U1138.\fi

\M{1174}Now let's consider \MP's special \.{TFM}-oriented commands.


\fi

\M{1175}\B\D$\\{char\_list\_code}$ \5
\T{0}\par
\B\4\D$\\{lig\_table\_code}$ \5
\T{1}\par
\B\4\D$\\{extensible\_code}$ \5
\T{2}\par
\B\4\D$\\{header\_byte\_code}$ \5
\T{3}\par
\B\4\D$\\{font\_dimen\_code}$ \5
\T{4}\par
\Y\B\4\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+\E{}$%
\6
$\\{mp\_primitive}(\\{mp},\39\.{"charlist"},\39\\{mp\_tfm\_command},\39\\{char%
\_list\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"ligtable"},\39\\{mp\_tfm\_command},\39\\{lig%
\_table\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"extensible"},\39\\{mp\_tfm\_command},\39%
\\{extensible\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"headerbyte"},\39\\{mp\_tfm\_command},\39%
\\{header\_byte\_code});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"fontdimen"},\39\\{mp\_tfm\_command},\39%
\\{font\_dimen\_code}){}$;\par
\fi

\M{1176}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_tfm\_command}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \\{char\_list\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"charlist"});{}$\6
\&{break};\6
\4\&{case} \\{lig\_table\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"ligtable"});{}$\6
\&{break};\6
\4\&{case} \\{extensible\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"extensible"});{}$\6
\&{break};\6
\4\&{case} \\{header\_byte\_code}:\5
${}\\{mp\_print}(\\{mp},\39\.{"headerbyte"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"fontdimen"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{1177}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{eight\_bits} \\{mp\_get\_code}(\&{MP} \\{mp});\par
\fi

\M{1178}\B\&{eight\_bits} \\{mp\_get\_code}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ scans a character code value }\1\6
\&{integer} \|c;\C{ the code value found }\6
\&{mp\_value} \\{new\_expr};\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ was\ looking\ for\ a}\)\.{\
number\ between\ 0\ an}\)\.{d\ 255,\ or\ for\ a"},\39\.{"string\ of\ length\
1.}\)\.{\ Didn't\ find\ it;\ wil}\)\.{l\ use\ 0\ instead."},\39\NULL\};{}$\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_known}){}$\5
${}\{{}$\1\6
${}\|c\K\\{round\_unscaled}(\\{cur\_exp\_value\_number}(\,));{}$\6
\&{if} ${}(\|c\G\T{0}){}$\1\6
\&{if} ${}(\|c<\T{256}){}$\1\5
\&{return} (\&{eight\_bits}) \|c;\2\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cur\_exp\_str}(\,)\MG\\{len}\E\T{1}){}$\5
${}\{{}$\1\6
${}\|c\K(\&{integer})({*}(\\{cur\_exp\_str}(\,)\MG\\{str}));{}$\6
\&{return} (\&{eight\_bits}) \|c;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Invalid\ code\ has\ be}\)\.{en\ replaced\
by\ 0"},\39\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
${}\|c\K\T{0};{}$\6
\&{return} (\&{eight\_bits}) \|c;\6
\4${}\}{}$\2\par
\fi

\M{1179}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_tag}(\&{MP} \\{mp}${},\39{}$\&{halfword} %
\|c${},\39{}$\&{quarterword} \|t${},\39{}$\&{halfword} \|r);\par
\fi

\M{1180}\B\&{void} \\{mp\_set\_tag}(\&{MP} \\{mp}${},\39{}$\&{halfword} \|c${},%
\39{}$\&{quarterword} \|t${},\39{}$\&{halfword} \|r)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_tag}[\|c]\E\\{no\_tag}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{char\_tag}[\|c]\K\|t;{}$\6
${}\\{mp}\MG\\{char\_remainder}[\|c]\K\|r;{}$\6
\&{if} ${}(\|t\E\\{lig\_tag}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{label\_ptr}\PP;{}$\6
${}\\{mp}\MG\\{label\_loc}[\\{mp}\MG\\{label\_ptr}]\K{}$(\&{short}) \|r;\6
${}\\{mp}\MG\\{label\_char}[\\{mp}\MG\\{label\_ptr}]\K{}$(\&{eight\_bits}) \|c;%
\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\X1181:Complain about a character tag conflict\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1181}\B\X1181:Complain about a character tag conflict\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{xtra}\K\NULL;{}$\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"It's\ not\ legal\ to\ l}\)\.{abel\
a\ character\ mor}\)\.{e\ than\ once."},\39\.{"So\ I'll\ not\ change\ }\)%
\.{anything\ just\ now."},\39\NULL\};{}$\7
\&{switch} ${}(\\{mp}\MG\\{char\_tag}[\|c]){}$\5
${}\{{}$\1\6
\4\&{case} \\{lig\_tag}:\5
${}\\{xtra}\K\.{"in\ a\ ligtable"};{}$\6
\&{break};\6
\4\&{case} \\{list\_tag}:\5
${}\\{xtra}\K\.{"in\ a\ charlist"};{}$\6
\&{break};\6
\4\&{case} \\{ext\_tag}:\5
${}\\{xtra}\K\.{"extensible"};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{xtra}\K\.{""};{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{if} ${}((\|c>\.{'\ '})\W(\|c<\T{127})){}$\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Character\ \%c\ is\ alr}\)\.{eady%
\ \%s"},\39\\{xord}(\|c),\39\\{xtra});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|c\E\T{256}){}$\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Character\ ||\ is\ alr}\)\.{eady\
\%s"},\39\\{xtra});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Character\ code\ \%d\ i}\)\.{s\
already\ \%s"},\39\|c,\39\\{xtra});{}$\6
\4${}\}{}$\2\6
;\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\U1180.\fi

\M{1182}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_tfm\_command}(\&{MP} \\{mp});\par
\fi

\M{1183}\B\&{void} \\{mp\_do\_tfm\_command}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|c${},{}$ \\{cc};\C{ character codes }\6
\&{int} \|k;\C{ index into the \PB{\\{kern}} array }\6
\&{int} \|j;\C{ index into \PB{\\{header\_byte}} or \PB{\\{param}} }\6
\&{mp\_value} \\{new\_expr};\7
${}\\{memset}({\AND}\\{new\_expr},\39\T{0},\39\&{sizeof}(\&{mp\_value}));{}$\6
${}\\{new\_number}(\\{new\_expr}.\\{data}.\|n);{}$\6
\&{switch} (\\{cur\_mod}(\,))\5
${}\{{}$\1\6
\4\&{case} \\{char\_list\_code}:\5
${}\|c\K\\{mp\_get\_code}(\\{mp}){}$;\C{ we will store a list of character
successors }\6
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_colon}){}$\5
${}\{{}$\1\6
${}\\{cc}\K\\{mp\_get\_code}(\\{mp});{}$\6
${}\\{mp\_set\_tag}(\\{mp},\39\|c,\39\\{list\_tag},\39\\{cc});{}$\6
${}\|c\K\\{cc};{}$\6
\4${}\}{}$\2\6
;\6
\&{break};\6
\4\&{case} \\{lig\_table\_code}:\6
\&{if} ${}(\\{mp}\MG\\{lig\_kern}\E\NULL){}$\1\5
${}\\{mp}\MG\\{lig\_kern}\K\\{xmalloc}((\\{max\_tfm\_int}+\T{1}),\39\&{sizeof}(%
\&{four\_quarters}));{}$\2\6
\&{if} ${}(\\{mp}\MG\\{kern}\E\NULL){}$\5
${}\{{}$\1\6
\&{int} \|i;\7
${}\\{mp}\MG\\{kern}\K\\{xmalloc}((\\{max\_tfm\_int}+\T{1}),\39\&{sizeof}(\&{mp%
\_number}));{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<(\\{max\_tfm\_int}+\T{1});{}$ ${}\|i\PP){}$\1%
\5
${}\\{new\_number}(\\{mp}\MG\\{kern}[\|i]);{}$\2\6
\4${}\}{}$\2\6
\X1184:Store a list of ligature/kern steps\X;\6
\&{break};\6
\4\&{case} \\{extensible\_code}:\5
\X1190:Define an extensible recipe\X;\6
\&{break};\6
\4\&{case} \\{header\_byte\_code}:\5
\&{case} \\{font\_dimen\_code}:\5
${}\|c\K\\{cur\_mod}(\,);{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}((\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known})\V\\{number\_less}(%
\\{cur\_exp\_value\_number}(\,),\39\\{half\_unit\_t})){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ was\ looking\ for\ a}\)\.{\
known,\ positive\ num}\)\.{ber."},\39\.{"For\ safety's\ sake\ I}\)\.{'ll\
ignore\ the\ prese}\)\.{nt\ command."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ location"},\39\\{hlp},\39%
\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|j\K\\{round\_unscaled}(\\{cur\_exp\_value\_number}(\,));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_colon}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"A\ colon\ should\ foll}\)\.{ow\ a\
headerbyte\ or\ f}\)\.{ontinfo\ location."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Missing\ `:'\ has\ bee}\)\.{n\ inserted"},%
\39\\{hlp},\39\\{true});{}$\6
;\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\E\\{header\_byte\_code}){}$\5
${}\{{}$\1\6
\X1191:Store a list of header bytes\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{param}\E\NULL){}$\5
${}\{{}$\1\6
\&{int} \|i;\7
${}\\{mp}\MG\\{param}\K\\{xmalloc}((\\{max\_tfm\_int}+\T{1}),\39\&{sizeof}(%
\&{mp\_number}));{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<(\\{max\_tfm\_int}+\T{1});{}$ ${}\|i\PP){}$\1%
\5
${}\\{new\_number}(\\{mp}\MG\\{param}[\|i]);{}$\2\6
\4${}\}{}$\2\6
\X1192:Store a list of font dimensions\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4${}\}{}$\C{ there are no other cases }\2\6
\4${}\}{}$\2\par
\fi

\M{1184}\B\X1184:Store a list of ligature/kern steps\X${}\E{}$\6
${}\{{}$\1\6
${}\\{mp}\MG\\{lk\_started}\K\\{false};{}$\6
\4\.{CONTINUE}:\5
\\{mp\_get\_x\_next}(\\{mp});\6
\&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_skip\_to})\W\\{mp}\MG\\{lk\_started}){}$\1%
\5
\X1187:Process a \PB{\\{skip\_to}} command and \PB{\&{goto} \\{done}}\X;\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_bchar\_label}){}$\5
${}\{{}$\1\6
${}\|c\K\T{256};{}$\6
\\{set\_cur\_cmd}((\\{mp\_variable\_type})\\{mp\_colon});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_back\_input}(\\{mp});\6
${}\|c\K\\{mp\_get\_code}(\\{mp});{}$\6
\4${}\}{}$\2\6
;\6
\&{if} ${}((\\{cur\_cmd}(\,)\E\\{mp\_colon})\V(\\{cur\_cmd}(\,)\E\\{mp\_double%
\_colon})){}$\5
${}\{{}$\1\6
\X1188:Record a label in a lig/kern subprogram and \PB{\&{goto} \&{continue}}%
\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_lig\_kern\_token}){}$\5
${}\{{}$\1\6
\X1189:Compile a ligature/kern command\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I\ was\ looking\ for\ `}\)\.{=:'\
or\ `kern'\ here."},\39\NULL\};{}$\7
${}\\{mp\_back\_error}(\\{mp},\39\.{"Illegal\ ligtable\ st}\)\.{ep"},\39%
\\{hlp},\39\\{true});{}$\6
;\6
${}\\{next\_char}(\\{mp}\MG\\{nl})\K\\{qi}(\T{0});{}$\6
${}\\{op\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\T{0});{}$\6
${}\\{rem\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\T{0});{}$\6
${}\\{skip\_byte}(\\{mp}\MG\\{nl})\K\\{stop\_flag}+\T{1}{}$;\C{ this specifies
an unconditional stop }\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{nl}\E\\{max\_tfm\_int}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"ligtable\ too\ large"});{}$\2\6
${}\\{mp}\MG\\{nl}\PP;{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}){}$\1\5
\&{goto} \.{CONTINUE};\2\6
\&{if} ${}(\\{skip\_byte}(\\{mp}\MG\\{nl}-\T{1})<\\{stop\_flag}){}$\1\5
${}\\{skip\_byte}(\\{mp}\MG\\{nl}-\T{1})\K\\{stop\_flag};{}$\2\6
\4${}\}{}$\2\6
\.{DONE}:\par
\U1183.\fi

\M{1185}\B\X200:Put each of \MP's primitives into the hash table\X${}\mathrel+%
\E{}$\6
$\\{mp\_primitive}(\\{mp},\39\.{"=:"},\39\\{mp\_lig\_kern\_token},\39\T{0});{}$%
\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"=:|"},\39\\{mp\_lig\_kern\_token},\39%
\T{1});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"=:|>"},\39\\{mp\_lig\_kern\_token},\39%
\T{5});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"|=:"},\39\\{mp\_lig\_kern\_token},\39%
\T{2});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"|=:>"},\39\\{mp\_lig\_kern\_token},\39%
\T{6});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"|=:|"},\39\\{mp\_lig\_kern\_token},\39%
\T{3});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"|=:|>"},\39\\{mp\_lig\_kern\_token},\39%
\T{7});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"|=:|>>"},\39\\{mp\_lig\_kern\_token},\39%
\T{11});{}$\6
;\6
${}\\{mp\_primitive}(\\{mp},\39\.{"kern"},\39\\{mp\_lig\_kern\_token},\39\\{mp%
\_kern\_flag}){}$;\par
\fi

\M{1186}\B\X233:Cases of \PB{\\{print\_cmd\_mod}} for symbolic printing of
primitives\X${}\mathrel+\E{}$\6
\4\&{case} \\{mp\_lig\_kern\_token}:\6
\&{switch} (\|m)\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
${}\\{mp\_print}(\\{mp},\39\.{"=:"});{}$\6
\&{break};\6
\4\&{case} \T{1}:\5
${}\\{mp\_print}(\\{mp},\39\.{"=:|"});{}$\6
\&{break};\6
\4\&{case} \T{2}:\5
${}\\{mp\_print}(\\{mp},\39\.{"|=:"});{}$\6
\&{break};\6
\4\&{case} \T{3}:\5
${}\\{mp\_print}(\\{mp},\39\.{"|=:|"});{}$\6
\&{break};\6
\4\&{case} \T{5}:\5
${}\\{mp\_print}(\\{mp},\39\.{"=:|>"});{}$\6
\&{break};\6
\4\&{case} \T{6}:\5
${}\\{mp\_print}(\\{mp},\39\.{"|=:>"});{}$\6
\&{break};\6
\4\&{case} \T{7}:\5
${}\\{mp\_print}(\\{mp},\39\.{"|=:|>"});{}$\6
\&{break};\6
\4\&{case} \T{11}:\5
${}\\{mp\_print}(\\{mp},\39\.{"|=:|>>"});{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{mp\_print}(\\{mp},\39\.{"kern"});{}$\6
\&{break};\6
\4${}\}{}$\2\6
\&{break};\par
\fi

\M{1187}Local labels are implemented by maintaining the \PB{\\{skip\_table}}
array,
where \PB{\\{skip\_table}[\|c]} is either \PB{\\{undefined\_label}} or the
address of the
most recent lig/kern instruction that skips to local label~\PB{\|c}. In the
latter case, the \PB{\\{skip\_byte}} in that instruction will (temporarily)
be zero if there were no prior skips to this label, or it will be the
distance to the prior skip.

We may need to cancel skips that span more than 127 lig/kern steps.

\Y\B\4\D$\\{cancel\_skips}(\|A)$ \5
$\\{mp}\MG\\{ll}\K(\|A);$ \&{do} \6
${}\{{}$\1\6
${}\\{mp}\MG\\{lll}\K\\{qo}(\\{skip\_byte}(\\{mp}\MG\\{ll}));{}$\6
${}\\{skip\_byte}(\\{mp}\MG\\{ll})\K\\{stop\_flag};{}$\6
${}\\{mp}\MG\\{ll}\K(\&{short})(\\{mp}\MG\\{ll}-\\{mp}\MG\\{lll});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{lll}\I\T{0}{}$)\par
\B\4\D$\\{skip\_error}(\|A)$ \6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"At\ most\ 127\ lig/ker}\)\.{n\
steps\ can\ separate}\)\.{\ skipto1\ from\ 1::."},\39\NULL\};{}$\7
${}\\{mp\_error}(\\{mp},\39\.{"Too\ far\ to\ skip"},\39\\{hlp},\39\\{true});{}$%
\6
\\{cancel\_skips}((\|A));\6
\4${}\}{}$\2\par
\Y\B\4\X1187:Process a \PB{\\{skip\_to}} command and \PB{\&{goto} \\{done}}%
\X${}\E{}$\6
${}\{{}$\1\6
${}\|c\K\\{mp\_get\_code}(\\{mp});{}$\6
\&{if} ${}(\\{mp}\MG\\{nl}-\\{mp}\MG\\{skip\_table}[\|c]>\T{128}){}$\5
${}\{{}$\1\6
${}\\{skip\_error}(\\{mp}\MG\\{skip\_table}[\|c]);{}$\6
${}\\{mp}\MG\\{skip\_table}[\|c]\K{}$(\&{short}) \\{undefined\_label};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{skip\_table}[\|c]\E\\{undefined\_label}){}$\1\5
${}\\{skip\_byte}(\\{mp}\MG\\{nl}-\T{1})\K\\{qi}(\T{0});{}$\2\6
\&{else}\1\5
${}\\{skip\_byte}(\\{mp}\MG\\{nl}-\T{1})\K\\{qi}(\\{mp}\MG\\{nl}-\\{mp}\MG%
\\{skip\_table}[\|c]-\T{1});{}$\2\6
${}\\{mp}\MG\\{skip\_table}[\|c]\K(\&{short})(\\{mp}\MG\\{nl}-\T{1});{}$\6
\&{goto} \.{DONE};\6
\4${}\}{}$\2\par
\U1184.\fi

\M{1188}\B\X1188:Record a label in a lig/kern subprogram and \PB{\&{goto} %
\&{continue}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{cur\_cmd}(\,)\E\\{mp\_colon}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|c\E\T{256}){}$\1\5
${}\\{mp}\MG\\{bch\_label}\K\\{mp}\MG\\{nl};{}$\2\6
\&{else}\1\5
${}\\{mp\_set\_tag}(\\{mp},\39\|c,\39\\{lig\_tag},\39\\{mp}\MG\\{nl});{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{mp}\MG\\{skip\_table}[\|c]<\\{undefined\_label}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{ll}\K\\{mp}\MG\\{skip\_table}[\|c];{}$\6
${}\\{mp}\MG\\{skip\_table}[\|c]\K\\{undefined\_label};{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{lll}\K\\{qo}(\\{skip\_byte}(\\{mp}\MG\\{ll}));{}$\6
\&{if} ${}(\\{mp}\MG\\{nl}-\\{mp}\MG\\{ll}>\T{128}){}$\5
${}\{{}$\1\6
${}\\{skip\_error}(\\{mp}\MG\\{ll});{}$\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\6
${}\\{skip\_byte}(\\{mp}\MG\\{ll})\K\\{qi}(\\{mp}\MG\\{nl}-\\{mp}\MG\\{ll}-%
\T{1});{}$\6
${}\\{mp}\MG\\{ll}\K(\&{short})(\\{mp}\MG\\{ll}-\\{mp}\MG\\{lll});{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp}\MG\\{lll}\I\T{0});{}$\6
\4${}\}{}$\2\6
\&{goto} \.{CONTINUE};\6
\4${}\}{}$\2\par
\U1184.\fi

\M{1189}\B\X1189:Compile a ligature/kern command\X${}\E{}$\6
${}\{{}$\1\6
${}\\{next\_char}(\\{mp}\MG\\{nl})\K\\{qi}(\|c);{}$\6
${}\\{skip\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\T{0});{}$\6
\&{if} ${}(\\{cur\_mod}(\,)<\T{128}){}$\5
${}\{{}$\C{ ligature op }\1\6
${}\\{op\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\\{cur\_mod}(\,));{}$\6
${}\\{rem\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\\{mp\_get\_code}(\\{mp}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"The\ amount\ of\ kern\ }\)\.{should%
\ be\ a\ known\ nu}\)\.{meric\ value."},\39\.{"I'm\ zeroing\ this\ on}\)\.{e.\
Proceed,\ with\ fin}\)\.{gers\ crossed."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ kern"},\39\\{hlp},\39%
\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{kern}[\\{mp}\MG\\{nk}],\39\\{cur\_exp\_value%
\_number}(\,));{}$\6
${}\|k\K\T{0};{}$\6
\&{while} ${}(\R\\{number\_equal}(\\{mp}\MG\\{kern}[\|k],\39\\{cur\_exp\_value%
\_number}(\,))){}$\1\5
\\{incr}(\|k);\2\6
\&{if} ${}(\|k\E\\{mp}\MG\\{nk}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{nk}\E\\{max\_tfm\_int}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"too\ many\ TFM\ kerns"});{}$\2\6
${}\\{mp}\MG\\{nk}\PP;{}$\6
\4${}\}{}$\2\6
${}\\{op\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\\{kern\_flag}+(\|k/\T{256}));{}$\6
${}\\{rem\_byte}(\\{mp}\MG\\{nl})\K\\{qi}((\|k\MOD\T{256}));{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{lk\_started}\K\\{true};{}$\6
\4${}\}{}$\2\par
\U1184.\fi

\M{1190}\B\D$\\{missing\_extensible\_punctuation}(\|A)$ \6
${}\{{}$\1\6
\&{char} \\{msg}[\T{256}];\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ processing\ `ext}\)\.{ensible\
c:\ t,m,b,r'.}\)\.{"},\39\NULL\};{}$\7
${}\\{mp\_snprintf}(\\{msg},\39\T{256},\39\.{"Missing\ \%s\ has\ been}\)\.{\
inserted"},\39(\|A));{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\\{msg},\39\\{hlp},\39\\{true});{}$\6
\4${}\}{}$\2\par
\Y\B\4\X1190:Define an extensible recipe\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{ne}\E\T{256}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"too\ many\ extensible}\)\.{\
recipies"});{}$\2\6
${}\|c\K\\{mp\_get\_code}(\\{mp});{}$\6
${}\\{mp\_set\_tag}(\\{mp},\39\|c,\39\\{ext\_tag},\39\\{mp}\MG\\{ne});{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_colon}){}$\1\5
\\{missing\_extensible\_punctuation}(\.{":"});\2\6
${}\\{ext\_top}(\\{mp}\MG\\{ne})\K\\{qi}(\\{mp\_get\_code}(\\{mp}));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\1\5
\\{missing\_extensible\_punctuation}(\.{","});\2\6
${}\\{ext\_mid}(\\{mp}\MG\\{ne})\K\\{qi}(\\{mp\_get\_code}(\\{mp}));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\1\5
\\{missing\_extensible\_punctuation}(\.{","});\2\6
${}\\{ext\_bot}(\\{mp}\MG\\{ne})\K\\{qi}(\\{mp\_get\_code}(\\{mp}));{}$\6
\&{if} ${}(\\{cur\_cmd}(\,)\I\\{mp\_comma}){}$\1\5
\\{missing\_extensible\_punctuation}(\.{","});\2\6
${}\\{ext\_rep}(\\{mp}\MG\\{ne})\K\\{qi}(\\{mp\_get\_code}(\\{mp}));{}$\6
${}\\{mp}\MG\\{ne}\PP;{}$\6
\4${}\}{}$\2\par
\U1183.\fi

\M{1191}The header could contain ASCII zeroes, so can't use \PB{\\{strdup}}.

\Y\B\4\X1191:Store a list of header bytes\X${}\E{}$\6
$\|j\MM;$ \&{do} \6
${}\{{}$\1\6
\&{if} ${}(\|j\G\\{mp}\MG\\{header\_size}){}$\5
${}\{{}$\1\6
\&{size\_t} \|l${}\K(\&{size\_t})(\\{mp}\MG\\{header\_size}+(\\{mp}\MG\\{header%
\_size}/\T{4}));{}$\6
\&{char} ${}{*}\|t\K\\{xmalloc}(\|l,\39\T{1});{}$\7
${}\\{memset}(\|t,\39\T{0},\39\|l);{}$\6
(\&{void}) \\{memcpy}${}(\|t,\39\\{mp}\MG\\{header\_byte},\39{}$(\&{size\_t}) %
\\{mp}${}\MG\\{header\_size});{}$\6
${}\\{xfree}(\\{mp}\MG\\{header\_byte});{}$\6
${}\\{mp}\MG\\{header\_byte}\K\|t;{}$\6
${}\\{mp}\MG\\{header\_size}\K{}$(\&{int}) \|l;\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{header\_byte}[\|j]\K{}$(\&{char}) \\{mp\_get\_code}(\\{mp});\6
\\{incr}(\|j);\6
${}\\{incr}(\\{mp}\MG\\{header\_last});{}$\6
\4${}\}{}$\2\6
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}{}$)\par
\U1183.\fi

\M{1192}\B\X1192:Store a list of font dimensions\X${}\E{}$\6
\&{do} \6
${}\{{}$\1\6
\&{if} ${}(\|j>\\{max\_tfm\_int}){}$\1\5
${}\\{mp\_fatal\_error}(\\{mp},\39\.{"too\ many\ fontdimens}\)\.{"});{}$\2\6
\&{while} ${}(\|j>\\{mp}\MG\\{np}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{np}\PP;{}$\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{param}[\\{mp}\MG\\{np}]);{}$\6
\4${}\}{}$\2\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"I'm\ zeroing\ this\ on}\)\.{e.\
Proceed,\ with\ fin}\)\.{gers\ crossed."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{set\_number\_to\_zero}(\\{new\_expr}.\\{data}.\|n);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Improper\ font\ param}\)\.{eter"},\39%
\\{hlp},\39\\{true});{}$\6
;\6
\\{mp\_get\_x\_next}(\\{mp});\6
${}\\{mp\_flush\_cur\_exp}(\\{mp},\39\\{new\_expr});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{mp}\MG\\{param}[\|j],\39\\{cur\_exp\_value\_number}(%
\,));{}$\6
\\{incr}(\|j);\6
\4${}\}{}$\2\6
\&{while} ${}(\\{cur\_cmd}(\,)\E\\{mp\_comma}{}$)\par
\U1183.\fi

\M{1193}OK: We've stored all the data that is needed for the \.{TFM} file.
All that remains is to output it in the correct format.

An interesting problem needs to be solved in this connection, because
the \.{TFM} format allows at most 256~widths, 16~heights, 16~depths,
and 64~italic corrections. If the data has more distinct values than
this, we want to meet the necessary restrictions by perturbing the
given values as little as possible.

\MP\ solves this problem in two steps. First the values of a given
kind (widths, heights, depths, or italic corrections) are sorted;
then the list of sorted values is perturbed, if necessary.

The sorting operation is facilitated by having a special node of
essentially infinite \PB{\\{value}} at the end of the current list.

\Y\B\4\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{inf\_val}\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{set\_value\_number}(\\{mp}\MG\\{inf\_val},\39\\{fraction\_four\_t}){}$;%
\par
\fi

\M{1194}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{inf\_val}){}$;\par
\fi

\M{1195}Straight linear insertion is good enough for sorting, since the lists
are usually not terribly long. As we work on the data, the current list
will start at \PB{\\{mp\_link}(\\{temp\_head})} and end at \PB{\\{inf\_val}};
the nodes in this
list will be in increasing order of their \PB{\\{value}} fields.

Given such a list, the \PB{\\{sort\_in}} function takes a value and returns a
pointer
to where that value can be found in the list. The value is inserted in
the proper place, if necessary.

At the time we need to do these operations, most of \MP's work has been
completed, so we will have plenty of memory to play with. The value nodes
that are allocated for sorting will never be returned to free storage.

\Y\B\4\D$\\{clear\_the\_list}$ \5
$\\{mp\_link}(\\{mp}\MG\\{temp\_head})\K\\{mp}\MG{}$\\{inf\_val}\par
\Y\B\&{static} \&{mp\_node} \\{mp\_sort\_in}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|v)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ list manipulation registers }\7
${}\|p\K\\{mp}\MG\\{temp\_head};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|q\K\\{mp\_link}(\|p);{}$\6
\&{if} ${}(\\{number\_lessequal}(\|v,\39\\{value\_number}(\|q))){}$\1\5
\&{break};\2\6
${}\|p\K\|q;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_less}(\|v,\39\\{value\_number}(\|q))){}$\5
${}\{{}$\1\6
${}\|r\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{set\_value\_number}(\|r,\39\|v);{}$\6
${}\\{mp\_link}(\|r)\K\|q;{}$\6
${}\\{mp\_link}(\|p)\K\|r;{}$\6
\4${}\}{}$\2\6
\&{return} \\{mp\_link}(\|p);\6
\4${}\}{}$\2\par
\fi

\M{1196}Now we come to the interesting part, where we reduce the list if
necessary
until it has the required size. The \PB{\\{min\_cover}} routine is basic to
this
process; it computes the minimum number~\PB{\|m} such that the values of the
current sorted list can be covered by \PB{\|m}~intervals of width~\PB{\|d}. It
also sets the global value \PB{\\{perturbation}} to the smallest value $d'>d$
such that the covering found by this algorithm would be different.

In particular, \PB{\\{min\_cover}(\T{0})} returns the number of distinct values
in the
current list and sets \PB{\\{perturbation}} to the minimum distance between
adjacent values.

\Y\B\&{static} \&{integer} \\{mp\_min\_cover}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \|d)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_node} \|p;\C{ runs through the current list }\6
\&{mp\_number} \|l;\C{ the least element covered by the current interval }\6
\&{mp\_number} \\{test};\6
\&{integer} \|m;\C{ lower bound on the size of the minimum cover }\7
${}\|m\K\T{0};{}$\6
\\{new\_number}(\|l);\6
\\{new\_number}(\\{test});\6
${}\|p\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});{}$\6
${}\\{set\_number\_to\_inf}(\\{mp}\MG\\{perturbation});{}$\6
\&{while} ${}(\|p\I\\{mp}\MG\\{inf\_val}){}$\5
${}\{{}$\1\6
\\{incr}(\|m);\6
${}\\{number\_clone}(\|l,\39\\{value\_number}(\|p));{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
${}\\{set\_number\_from\_addition}(\\{test},\39\|l,\39\|d);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{number\_lessequal}(\\{value\_number}(\|p),\39\\{test}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{test},\39\\{value\_number}(\|p),\39%
\|l);{}$\6
\&{if} ${}(\\{number\_less}(\\{test},\39\\{mp}\MG\\{perturbation})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{perturbation},\39\\{value\_number}(\|p));{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{perturbation},\39\|l);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{test});\6
\\{free\_number}(\|l);\6
\&{return} \|m;\6
\4${}\}{}$\2\par
\fi

\M{1197}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{perturbation};\C{ quantity related to \.{TFM} rounding }\6
\&{integer} \\{excess};\C{ the list is this much too long }\par
\fi

\M{1198}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{perturbation}){}$;\par
\fi

\M{1199}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{perturbation}){}$;\par
\fi

\M{1200}The smallest \PB{\|d} such that a given list can be covered with \PB{%
\|m} intervals
is determined by the \PB{\\{threshold}} routine, which is sort of an inverse
to \PB{\\{min\_cover}}. The idea is to increase the interval size rapidly until
finding the range, then to go sequentially until the exact borderline has
been discovered.

\Y\B\&{static} \&{void} \\{mp\_threshold}(\&{MP} \\{mp}${},\39{}$\&{mp\_number}
\\{ret}${},\39{}$\&{integer} \|m)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|d${},{}$ \\{arg1};\C{ lower bound on the smallest interval
size }\7
\\{new\_number}(\|d);\6
\\{new\_number}(\\{arg1});\6
${}\\{mp}\MG\\{excess}\K\\{mp\_min\_cover}(\\{mp},\39\\{zero\_t})-\|m;{}$\6
\&{if} ${}(\\{mp}\MG\\{excess}\Z\T{0}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{ret},\39\\{zero\_t});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{do}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d,\39\\{mp}\MG\\{perturbation});{}$\6
${}\\{set\_number\_from\_addition}(\\{arg1},\39\|d,\39\|d);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\\{mp\_min\_cover}(\\{mp},\39\\{arg1})>\|m);{}$\6
\&{while} ${}(\\{mp\_min\_cover}(\\{mp},\39\|d)>\|m){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\|d,\39\\{mp}\MG\\{perturbation});{}$\6
\4${}\}{}$\2\6
${}\\{number\_clone}(\\{ret},\39\|d);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|d);\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\par
\fi

\M{1201}The \PB{\\{skimp}} procedure reduces the current list to at most \PB{%
\|m} entries,
by changing values if necessary. It also sets \PB{\\{indep\_value}(\|p): $\K$ %
\|k} if \PB{\\{value}(\|p)}
is the \PB{\|k}th distinct value on the resulting list, and it sets
\PB{\\{perturbation}} to the maximum amount by which a \PB{\\{value}} field has
been changed. The size of the resulting list is returned as the
value of \PB{\\{skimp}}.

\Y\B\&{static} \&{integer} \\{mp\_skimp}(\&{MP} \\{mp}${},\39{}$\&{integer} %
\|m)\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|d;\C{ the size of intervals being coalesced }\6
\&{mp\_node} \|p${},{}$ \|q${},{}$ \|r;\C{ list manipulation registers }\6
\&{mp\_number} \|l;\C{ the least value in the current interval }\6
\&{mp\_number} \|v;\C{ a compromise value }\6
\&{mp\_number} \\{l\_d};\7
\\{new\_number}(\|d);\6
${}\\{mp\_threshold}(\\{mp},\39\|d,\39\|m);{}$\6
\\{new\_number}(\|l);\6
\\{new\_number}(\\{l\_d});\6
\\{new\_number}(\|v);\6
${}\\{set\_number\_to\_zero}(\\{mp}\MG\\{perturbation});{}$\6
${}\|q\K\\{mp}\MG\\{temp\_head};{}$\6
${}\|m\K\T{0};{}$\6
${}\|p\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});{}$\6
\&{while} ${}(\|p\I\\{mp}\MG\\{inf\_val}){}$\5
${}\{{}$\1\6
\\{incr}(\|m);\6
${}\\{number\_clone}(\|l,\39\\{value\_number}(\|p));{}$\6
${}\\{set\_indep\_value}(\|p,\39\|m);{}$\6
${}\\{set\_number\_from\_addition}(\\{l\_d},\39\|l,\39\|d);{}$\6
\&{if} ${}(\\{number\_lessequal}(\\{value\_number}(\\{mp\_link}(\|p)),\39\\{l%
\_d})){}$\5
${}\{{}$\1\6
\X1202:Replace an interval of values by its midpoint\X;\6
\4${}\}{}$\2\6
${}\|q\K\|p;{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{l\_d});\6
\\{free\_number}(\|d);\6
\\{free\_number}(\|l);\6
\\{free\_number}(\|v);\6
\&{return} \|m;\6
\4${}\}{}$\2\par
\fi

\M{1202}\B\X1202:Replace an interval of values by its midpoint\X${}\E{}$\6
${}\{{}$\1\6
\&{mp\_number} \\{test};\7
\\{new\_number}(\\{test});\6
\&{do}\5
${}\{{}$\1\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
${}\\{set\_indep\_value}(\|p,\39\|m);{}$\6
${}\\{decr}(\\{mp}\MG\\{excess});{}$\6
\&{if} ${}(\\{mp}\MG\\{excess}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{l\_d},\39\|l);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\5
\&{while} ${}(\\{number\_lessequal}(\\{value\_number}(\\{mp\_link}(\|p)),\39%
\\{l\_d}));{}$\6
${}\\{set\_number\_from\_substraction}(\\{test},\39\\{value\_number}(\|p),\39%
\|l);{}$\6
\\{number\_halfp}(\\{test});\6
${}\\{set\_number\_from\_addition}(\|v,\39\|l,\39\\{test});{}$\6
${}\\{set\_number\_from\_substraction}(\\{test},\39\\{value\_number}(\|p),\39%
\|v);{}$\6
\&{if} ${}(\\{number\_greater}(\\{test},\39\\{mp}\MG\\{perturbation})){}$\1\5
${}\\{number\_clone}(\\{mp}\MG\\{perturbation},\39\\{test});{}$\2\6
${}\|r\K\|q;{}$\6
\&{do}\5
${}\{{}$\1\6
${}\|r\K\\{mp\_link}(\|r);{}$\6
${}\\{set\_value\_number}(\|r,\39\|v);{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\|r\I\|p);{}$\6
${}\\{mp\_link}(\|q)\K\|p{}$;\C{ remove duplicate values from the current list
}\6
\\{free\_number}(\\{test});\6
\4${}\}{}$\2\par
\U1201.\fi

\M{1203}A warning message is issued whenever something is perturbed by
more than 1/16\thinspace pt.

\Y\B\&{static} \&{void} \\{mp\_tfm\_warning}(\&{MP} \\{mp}${},\39{}$%
\&{quarterword} \|m)\1\1\2\2\6
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(some\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{internal\_name}(\|m));{}$\6
;\6
${}\\{mp\_print}(\\{mp},\39\.{"\ values\ had\ to\ be\ a}\)\.{djusted\ by\ as\
much\ a}\)\.{s\ "});{}$\6
${}\\{print\_number}(\\{mp}\MG\\{perturbation});{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"pt)"});{}$\6
\4${}\}{}$\2\par
\fi

\M{1204}Here's an example of how we use these routines.
The width data needs to be perturbed only if there are 256 distinct
widths, but \MP\ must check for this case even though it is
highly unusual.

An integer variable \PB{\|k} will be defined when we use this code.
The \PB{\\{dimen\_head}} array will contain pointers to the sorted
lists of dimensions.

\Y\B\4\D$\\{tfm\_warn\_threshold\_k}$ \5
((\&{math\_data} ${}{*}){}$ \\{mp}${}\MG\\{math})\MG{}$\\{tfm\_warn\_threshold%
\_t}\par
\Y\B\4\X1204:Massage the \.{TFM} widths\X${}\E{}$\6
\\{clear\_the\_list};\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_exists}[\|k]){}$\1\5
${}\\{mp}\MG\\{tfm\_width}[\|k]\K\\{mp\_sort\_in}(\\{mp},\39\\{value\_number}(%
\\{mp}\MG\\{tfm\_width}[\|k]));{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{nw}\K(\&{short})(\\{mp\_skimp}(\\{mp},\39\T{255})+\T{1});{}$\6
${}\\{mp}\MG\\{dimen\_head}[\T{1}]\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});$ %
\&{if} ${}(\\{number\_greaterequal}(\\{mp}\MG\\{perturbation},\39\\{tfm\_warn%
\_threshold\_k}))$ $\\{mp\_tfm\_warning}(\\{mp},\39\\{mp\_char\_wd}{}$)\par
\U1291.\fi

\M{1205}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} \\{dimen\_head}[\T{5}];\C{ lists of \.{TFM} dimensions }\par
\fi

\M{1206}Heights, depths, and italic corrections are different from widths
not only because their list length is more severely restricted, but
also because zero values do not need to be put into the lists.

\Y\B\4\X1206:Massage the \.{TFM} heights, depths, and italic corrections\X${}%
\E{}$\6
\\{clear\_the\_list};\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_exists}[\|k]){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{tfm\_height}[\|k]\E\T{0}){}$\1\5
${}\\{mp}\MG\\{tfm\_height}[\|k]\K\\{mp}\MG\\{zero\_val};{}$\2\6
\&{else}\1\5
${}\\{mp}\MG\\{tfm\_height}[\|k]\K\\{mp\_sort\_in}(\\{mp},\39\\{value\_number}(%
\\{mp}\MG\\{tfm\_height}[\|k]));{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{nh}\K(\&{short})(\\{mp\_skimp}(\\{mp},\39\T{15})+\T{1});{}$\6
${}\\{mp}\MG\\{dimen\_head}[\T{2}]\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});{}$\6
\&{if} ${}(\\{number\_greaterequal}(\\{mp}\MG\\{perturbation},\39\\{tfm\_warn%
\_threshold\_k})){}$\1\5
${}\\{mp\_tfm\_warning}(\\{mp},\39\\{mp\_char\_ht});{}$\2\6
\\{clear\_the\_list};\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_exists}[\|k]){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{tfm\_depth}[\|k]\E\T{0}){}$\1\5
${}\\{mp}\MG\\{tfm\_depth}[\|k]\K\\{mp}\MG\\{zero\_val};{}$\2\6
\&{else}\1\5
${}\\{mp}\MG\\{tfm\_depth}[\|k]\K\\{mp\_sort\_in}(\\{mp},\39\\{value\_number}(%
\\{mp}\MG\\{tfm\_depth}[\|k]));{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{nd}\K(\&{short})(\\{mp\_skimp}(\\{mp},\39\T{15})+\T{1});{}$\6
${}\\{mp}\MG\\{dimen\_head}[\T{3}]\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});{}$\6
\&{if} ${}(\\{number\_greaterequal}(\\{mp}\MG\\{perturbation},\39\\{tfm\_warn%
\_threshold\_k})){}$\1\5
${}\\{mp\_tfm\_warning}(\\{mp},\39\\{mp\_char\_dp});{}$\2\6
\\{clear\_the\_list};\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_exists}[\|k]){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{tfm\_ital\_corr}[\|k]\E\T{0}){}$\1\5
${}\\{mp}\MG\\{tfm\_ital\_corr}[\|k]\K\\{mp}\MG\\{zero\_val};{}$\2\6
\&{else}\1\5
${}\\{mp}\MG\\{tfm\_ital\_corr}[\|k]\K\\{mp\_sort\_in}(\\{mp},\39\\{value%
\_number}(\\{mp}\MG\\{tfm\_ital\_corr}[\|k]));{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{ni}\K(\&{short})(\\{mp\_skimp}(\\{mp},\39\T{63})+\T{1});{}$\6
${}\\{mp}\MG\\{dimen\_head}[\T{4}]\K\\{mp\_link}(\\{mp}\MG\\{temp\_head});$ %
\&{if} ${}(\\{number\_greaterequal}(\\{mp}\MG\\{perturbation},\39\\{tfm\_warn%
\_threshold\_k}))$ $\\{mp\_tfm\_warning}(\\{mp},\39\\{mp\_char\_ic}{}$)\par
\U1291.\fi

\M{1207}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{zero\_val}\K\\{mp\_get\_value\_node}(\\{mp});{}$\6
${}\\{set\_value\_number}(\\{mp}\MG\\{zero\_val},\39\\{zero\_t}){}$;\par
\fi

\M{1208}\B\X183:Free table entries\X${}\mathrel+\E{}$\6
$\\{mp\_free\_value\_node}(\\{mp},\39\\{mp}\MG\\{zero\_val}){}$;\par
\fi

\M{1209}Bytes 5--8 of the header are set to the design size, unless the user
has
some crazy reason for specifying them differently.

Error messages are not allowed at the time this procedure is called,
so a warning is printed instead.

The value of \PB{\\{max\_tfm\_dimen}} is calculated so that
$$\hbox{\PB{$\\{make\_scaled}(\T{16}*\\{max\_tfm\_dimen},\\{internal\_value}(%
\\{mp\_design\_size}))$}}
< \\{three\_bytes}.$$

\Y\B\4\D$\\{three\_bytes}$ \5
\T{\~100000000}\C{ $2^{24}$ }\par
\Y\B\&{static} \&{void} \\{mp\_fix\_design\_size}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{mp\_number} \|d;\C{ the design size }\7
\\{new\_number}(\|d);\6
${}\\{number\_clone}(\|d,\39\\{internal\_value}(\\{mp\_design\_size}));{}$\6
\&{if} ${}(\\{number\_less}(\|d,\39\\{unity\_t})\V\\{number\_greaterequal}(\|d,%
\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{number\_zero}(\|d)){}$\1\5
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(illegal\ design\ siz}\)\.{e\ has\ been\
changed\ t}\)\.{o\ 128pt)"});{}$\2\6
;\6
${}\\{set\_number\_from\_scaled}(\|d,\39\T{\~40000000});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_design\_size}),\39\|d);{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{header\_byte}[\T{4}]\E\T{0}\W\\{mp}\MG\\{header\_byte}[%
\T{5}]\E\T{0}\W\\{mp}\MG\\{header\_byte}[\T{6}]\E\T{0}\W\\{mp}\MG\\{header%
\_byte}[\T{7}]\E\T{0}){}$\5
${}\{{}$\1\6
\&{integer} \\{dd}${}\K\\{number\_to\_scaled}(\|d);{}$\7
${}\\{mp}\MG\\{header\_byte}[\T{4}]\K(\&{char})(\\{dd}/\T{\~4000000});{}$\6
${}\\{mp}\MG\\{header\_byte}[\T{5}]\K(\&{char})((\\{dd}/\T{4096})\MOD%
\T{256});{}$\6
${}\\{mp}\MG\\{header\_byte}[\T{6}]\K(\&{char})((\\{dd}/\T{16})\MOD\T{256});{}$%
\6
${}\\{mp}\MG\\{header\_byte}[\T{7}]\K(\&{char})((\\{dd}\MOD\T{16})*\T{16});{}$\6
\4${}\}{}$\C{ mp->max\_tfm\_dimen = 16 * internal\_value (mp\_design\_size) - 1 -
internal\_value (mp\_design\_size) / 010000000 }\2\6
${}\{{}$\1\6
\&{mp\_number} \\{secondpart};\7
\\{new\_number}(\\{secondpart});\6
${}\\{number\_clone}(\\{secondpart},\39\\{internal\_value}(\\{mp\_design%
\_size}));{}$\6
${}\\{number\_clone}(\\{mp}\MG\\{max\_tfm\_dimen},\39\\{secondpart});{}$\6
${}\\{number\_divide\_int}(\\{secondpart},\39\T{\~10000000});{}$\6
${}\\{number\_multiply\_int}(\\{mp}\MG\\{max\_tfm\_dimen},\39\T{16});{}$\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{max\_tfm\_dimen},\39{-}\T{1});{}$\6
${}\\{number\_substract}(\\{mp}\MG\\{max\_tfm\_dimen},\39\\{secondpart});{}$\6
\\{free\_number}(\\{secondpart});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{number\_greaterequal}(\\{mp}\MG\\{max\_tfm\_dimen},\39\\{fraction%
\_half\_t})){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{mp}\MG\\{max\_tfm\_dimen},\39\\{fraction\_half\_t});{}$%
\6
${}\\{number\_add\_scaled}(\\{mp}\MG\\{max\_tfm\_dimen},\39{-}\T{1});{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\|d);\6
\4${}\}{}$\2\par
\fi

\M{1210}The \PB{\\{dimen\_out}} procedure computes a \PB{\\{fix\_word}}
relative to the
design size. If the data was out of range, it is corrected and the
global variable \PB{\\{tfm\_changed}} is increased by~one.

\Y\B\&{static} \&{integer} \\{mp\_dimen\_out}(\&{MP} \\{mp}${},\39{}$\&{mp%
\_number} \\{x\_orig})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \\{ret};\6
\&{mp\_number} \\{abs\_x};\6
\&{mp\_number} \|x;\7
\\{new\_number}(\\{abs\_x});\6
\\{new\_number}(\|x);\6
${}\\{number\_clone}(\|x,\39\\{x\_orig});{}$\6
${}\\{number\_clone}(\\{abs\_x},\39\\{x\_orig});{}$\6
\\{number\_abs}(\\{abs\_x});\6
\&{if} ${}(\\{number\_greater}(\\{abs\_x},\39\\{mp}\MG\\{max\_tfm\_dimen})){}$\5
${}\{{}$\1\6
${}\\{incr}(\\{mp}\MG\\{tfm\_changed});{}$\6
\&{if} (\\{number\_positive}(\|x))\1\5
${}\\{number\_clone}(\|x,\39\\{mp}\MG\\{max\_tfm\_dimen});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\|x,\39\\{mp}\MG\\{max\_tfm\_dimen});{}$\6
\\{number\_negate}(\|x);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{arg1};\7
\\{new\_number}(\\{arg1});\6
${}\\{number\_clone}(\\{arg1},\39\|x);{}$\6
${}\\{number\_multiply\_int}(\\{arg1},\39\T{16});{}$\6
${}\\{make\_scaled}(\|x,\39\\{arg1},\39\\{internal\_value}(\\{mp\_design%
\_size}));{}$\6
\\{free\_number}(\\{arg1});\6
\4${}\}{}$\2\6
\\{free\_number}(\\{abs\_x});\6
${}\\{ret}\K\\{number\_to\_scaled}(\|x);{}$\6
\\{free\_number}(\|x);\6
\&{return} \\{ret};\6
\4${}\}{}$\2\par
\fi

\M{1211}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_number} \\{max\_tfm\_dimen};\C{ bound on widths, heights, kerns, etc. }\6
\&{integer} \\{tfm\_changed};\C{ the number of data entries that were out of
bounds }\par
\fi

\M{1212}\B\X182:Initialize table entries\X${}\mathrel+\E{}$\6
$\\{new\_number}(\\{mp}\MG\\{max\_tfm\_dimen}){}$;\par
\fi

\M{1213}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{free\_number}(\\{mp}\MG\\{max\_tfm\_dimen}){}$;\par
\fi

\M{1214}If the user has not specified any of the first four header bytes,
the \PB{\\{fix\_check\_sum}} procedure replaces them by a ``check sum''
computed
from the \PB{\\{tfm\_width}} data relative to the design size.

\Y\B\&{static} \&{void} \\{mp\_fix\_check\_sum}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{eight\_bits} \|k;\C{ runs through character codes }\6
\&{eight\_bits} \.{B1}${},{}$ \.{B2}${},{}$ \.{B3}${},{}$ \.{B4};\C{ bytes of
the check sum }\6
\&{integer} \|x;\C{ hash value used in check sum computation }\7
\&{if} ${}(\\{mp}\MG\\{header\_byte}[\T{0}]\E\T{0}\W\\{mp}\MG\\{header\_byte}[%
\T{1}]\E\T{0}\W\\{mp}\MG\\{header\_byte}[\T{2}]\E\T{0}\W\\{mp}\MG\\{header%
\_byte}[\T{3}]\E\T{0}){}$\5
${}\{{}$\1\6
\X1215:Compute a check sum in \PB{$(\\{b1},\\{b2},\\{b3},\\{b4})$}\X;\6
${}\\{mp}\MG\\{header\_byte}[\T{0}]\K{}$(\&{char}) \.{B1};\6
${}\\{mp}\MG\\{header\_byte}[\T{1}]\K{}$(\&{char}) \.{B2};\6
${}\\{mp}\MG\\{header\_byte}[\T{2}]\K{}$(\&{char}) \.{B3};\6
${}\\{mp}\MG\\{header\_byte}[\T{3}]\K{}$(\&{char}) \.{B4};\6
\&{return};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1215}\B\X1215:Compute a check sum in \PB{$(\\{b1},\\{b2},\\{b3},\\{b4})$}%
\X${}\E{}$\6
$\.{B1}\K\\{mp}\MG\\{bc};{}$\6
${}\.{B2}\K\\{mp}\MG\\{ec};{}$\6
${}\.{B3}\K\\{mp}\MG\\{bc};{}$\6
${}\.{B4}\K\\{mp}\MG\\{ec};{}$\6
${}\\{mp}\MG\\{tfm\_changed}\K\T{0};{}$\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{char\_exists}[\|k]){}$\5
${}\{{}$\1\6
${}\|x\K\\{mp\_dimen\_out}(\\{mp},\39\\{value\_number}(\\{mp}\MG\\{tfm\_width}[%
\|k]))+(\|k+\T{4})*\T{\~20000000}{}$;\C{ this is positive }\6
${}\.{B1}\K(\&{eight\_bits})((\.{B1}+\.{B1}+\|x)\MOD\T{255});{}$\6
${}\.{B2}\K(\&{eight\_bits})((\.{B2}+\.{B2}+\|x)\MOD\T{253});{}$\6
${}\.{B3}\K(\&{eight\_bits})((\.{B3}+\.{B3}+\|x)\MOD\T{251});{}$\6
${}\.{B4}\K(\&{eight\_bits})((\.{B4}+\.{B4}+\|x)\MOD\T{247});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|k\E\\{mp}\MG\\{ec}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\par
\U1214.\fi

\M{1216}Finally we're ready to actually write the \.{TFM} information.
Here are some utility routines for this purpose.

\Y\B\4\D$\\{tfm\_out}(\|A)$ \5
\&{do} \6
${}\{{}$\C{ output one byte to \PB{\\{tfm\_file}} }\1\6
\&{unsigned} \&{char} \|s${}\K{}$(\&{unsigned} \&{char})(\|A);\7
${}(\\{mp}\MG\\{write\_binary\_file})(\\{mp},\39\\{mp}\MG\\{tfm\_file},\39{}$(%
\&{void} ${}{*}){}$ ${}{\AND}\|s,\39\T{1});{}$\6
\4${}\}{}$\2\6
\&{while} (\T{0})\par
\Y\B\&{static} \&{void} \\{mp\_tfm\_two}(\&{MP} \\{mp}${},\39{}$\&{integer} %
\|x)\1\1\2\2\6
${}\{{}$\C{ output two bytes to \PB{\\{tfm\_file}} }\1\6
${}\\{tfm\_out}(\|x/\T{256});{}$\6
${}\\{tfm\_out}(\|x\MOD\T{256});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_tfm\_four}(\&{MP} \\{mp}${},\39{}$\&{integer} \|x)\1%
\1\2\2\6
${}\{{}$\C{ output four bytes to \PB{\\{tfm\_file}} }\1\6
\&{if} ${}(\|x\G\T{0}){}$\1\5
${}\\{tfm\_out}(\|x/\\{three\_bytes});{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\|x\K\|x+\T{\~10000000000}{}$;\C{ use two's complement for negative values }%
\6
${}\|x\K\|x+\T{\~10000000000};{}$\6
${}\\{tfm\_out}((\|x/\\{three\_bytes})+\T{128});{}$\6
\4${}\}{}$\2\6
;\6
${}\|x\K\|x\MOD\\{three\_bytes};{}$\6
${}\\{tfm\_out}(\|x/\\{number\_to\_scaled}(\\{unity\_t}));{}$\6
${}\|x\K\|x\MOD\\{number\_to\_scaled}(\\{unity\_t});{}$\6
${}\\{tfm\_out}(\|x/\T{\~400});{}$\6
${}\\{tfm\_out}(\|x\MOD\T{\~400});{}$\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_tfm\_qqqq}(\&{MP} \\{mp}${},\39{}$\&{four\_quarters}
\|x)\1\1\2\2\6
${}\{{}$\C{ output four quarterwords to \PB{\\{tfm\_file}} }\1\6
${}\\{tfm\_out}(\\{qo}(\|x.\\{b0}));{}$\6
${}\\{tfm\_out}(\\{qo}(\|x.\\{b1}));{}$\6
${}\\{tfm\_out}(\\{qo}(\|x.\\{b2}));{}$\6
${}\\{tfm\_out}(\\{qo}(\|x.\\{b3}));{}$\6
\4${}\}{}$\2\par
\fi

\M{1217}\B\X1217:Finish the \.{TFM} file\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\1\5
\\{mp\_open\_log\_file}(\\{mp});\2\6
${}\\{mp\_pack\_job\_name}(\\{mp},\39\.{".tfm"});{}$\6
\&{while} ${}(\R\\{mp\_open\_out}(\\{mp},\39{\AND}\\{mp}\MG\\{tfm\_file},\39%
\\{mp\_filetype\_metrics})){}$\1\5
${}\\{mp\_prompt\_file\_name}(\\{mp},\39\.{"file\ name\ for\ font\ }\)%
\.{metrics"},\39\.{".tfm"});{}$\2\6
${}\\{mp}\MG\\{metric\_file\_name}\K\\{xstrdup}(\\{mp}\MG\\{name\_of%
\_file});{}$\6
\X1218:Output the subfile sizes and header bytes\X;\6
\X1219:Output the character information bytes, then output the dimensions
themselves\X;\6
\X1222:Output the ligature/kern program\X;\6
\X1223:Output the extensible character recipes and the font metric parameters%
\X;\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_stats})))\1\5
\X1224:Log the subfile sizes of the \.{TFM} file\X;\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Font\ metrics\ writte}\)\.{n\ on\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{metric\_file\_name});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'.'}));{}$\6
; $(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{tfm\_file}{}$)\par
\U1291.\fi

\M{1218}Integer variables \PB{\\{lh}}, \PB{\|k}, and \PB{\\{lk\_offset}} will
be defined when we use
this code.

\Y\B\4\X1218:Output the subfile sizes and header bytes\X${}\E{}$\6
$\|k\K\\{mp}\MG\\{header\_last};{}$\6
${}\.{LH}\K(\|k+\T{4})/\T{4}{}$;\C{ this is the number of header words }\6
\&{if} ${}(\\{mp}\MG\\{bc}>\\{mp}\MG\\{ec}){}$\1\5
${}\\{mp}\MG\\{bc}\K\T{1}{}$;\C{ if there are no characters, \PB{$\\{ec}\K%
\T{0}$} and \PB{$\\{bc}\K\T{1}$} }\2\6
\X1220:Compute the ligature/kern program offset and implant the left boundary
label\X;\6
${}\\{mp\_tfm\_two}(\\{mp},\39\T{6}+\.{LH}+(\\{mp}\MG\\{ec}-\\{mp}\MG\\{bc}+%
\T{1})+\\{mp}\MG\\{nw}+\\{mp}\MG\\{nh}+\\{mp}\MG\\{nd}+\\{mp}\MG\\{ni}+\\{mp}%
\MG\\{nl}+\\{lk\_offset}+\\{mp}\MG\\{nk}+\\{mp}\MG\\{ne}+\\{mp}\MG\\{np}){}$;%
\C{ this is the total number of file words that will be output }\6
${}\\{mp\_tfm\_two}(\\{mp},\39\.{LH});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{bc});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{ec});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{nw});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{nh});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{nd});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{ni});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{nl}+\\{lk\_offset});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{nk});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{ne});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{np});{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\T{4}*\.{LH};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{tfm\_out}(\\{mp}\MG\\{header\_byte}[\|k]);{}$\6
\4${}\}{}$\2\par
\U1217.\fi

\M{1219}\B\X1219:Output the character information bytes, then output the
dimensions themselves\X${}\E{}$\6
\&{for} ${}(\|k\K\\{mp}\MG\\{bc};{}$ ${}\|k\Z\\{mp}\MG\\{ec};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp}\MG\\{char\_exists}[\|k]){}$\5
${}\{{}$\1\6
${}\\{mp\_tfm\_four}(\\{mp},\39\T{0});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{tfm\_out}(\\{indep\_value}(\\{mp}\MG\\{tfm\_width}[\|k])){}$;\C{ the
width index }\6
${}\\{tfm\_out}((\\{indep\_value}(\\{mp}\MG\\{tfm\_height}[\|k]))*\T{16}+%
\\{indep\_value}(\\{mp}\MG\\{tfm\_depth}[\|k]));{}$\6
${}\\{tfm\_out}((\\{indep\_value}(\\{mp}\MG\\{tfm\_ital\_corr}[\|k]))*\T{4}+%
\\{mp}\MG\\{char\_tag}[\|k]);{}$\6
${}\\{tfm\_out}(\\{mp}\MG\\{char\_remainder}[\|k]);{}$\6
\4${}\}{}$\2\6
;\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{tfm\_changed}\K\T{0};{}$\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\|k\Z\T{4};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{mp\_tfm\_four}(\\{mp},\39\T{0});{}$\6
${}\|p\K\\{mp}\MG\\{dimen\_head}[\|k];{}$\6
\&{while} ${}(\|p\I\\{mp}\MG\\{inf\_val}){}$\5
${}\{{}$\1\6
${}\\{mp\_tfm\_four}(\\{mp},\39\\{mp\_dimen\_out}(\\{mp},\39\\{value\_number}(%
\|p)));{}$\6
${}\|p\K\\{mp\_link}(\|p);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1217.\fi

\M{1220}We need to output special instructions at the beginning of the
\PB{\\{lig\_kern}} array in order to specify the right boundary character
and/or to handle starting addresses that exceed 255. The \PB{\\{label\_loc}}
and \PB{\\{label\_char}} arrays have been set up to record all the
starting addresses; we have $-1=\PB{\\{label\_loc}}[0]<\PB{\\{label\_loc}}[1]%
\le\cdots
\le\PB{\\{label\_loc}}[\PB{\\{label\_ptr} ]}$.

\Y\B\4\X1220:Compute the ligature/kern program offset and implant the left
boundary label\X${}\E{}$\6
$\\{mp}\MG\\{bchar}\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_boundary%
\_char}));{}$\6
\&{if} ${}((\\{mp}\MG\\{bchar}<\T{0})\V(\\{mp}\MG\\{bchar}>\T{255})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{bchar}\K{-}\T{1};{}$\6
${}\\{mp}\MG\\{lk\_started}\K\\{false};{}$\6
${}\\{lk\_offset}\K\T{0};{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{lk\_started}\K\\{true};{}$\6
${}\\{lk\_offset}\K\T{1};{}$\6
\4${}\}{}$\2\6
\X1221:Find the minimum \PB{\\{lk\_offset}} and adjust all remainders\X;\6
\&{if} ${}(\\{mp}\MG\\{bch\_label}<\\{undefined\_label}){}$\5
${}\{{}$\1\6
${}\\{skip\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(\T{255});{}$\6
${}\\{next\_char}(\\{mp}\MG\\{nl})\K\\{qi}(\T{0});{}$\6
${}\\{op\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(((\\{mp}\MG\\{bch\_label}+\\{lk%
\_offset})/\T{256}));{}$\6
${}\\{rem\_byte}(\\{mp}\MG\\{nl})\K\\{qi}(((\\{mp}\MG\\{bch\_label}+\\{lk%
\_offset})\MOD\T{256}));{}$\6
${}\\{mp}\MG\\{nl}\PP{}$;\C{ possibly \PB{$\\{nl}\K\\{lig\_table\_size}+\T{1}$}
}\6
\4${}\}{}$\2\par
\U1218.\fi

\M{1221}\B\X1221:Find the minimum \PB{\\{lk\_offset}} and adjust all remainders%
\X${}\E{}$\6
$\|k\K\\{mp}\MG\\{label\_ptr}{}$;\C{ pointer to the largest unallocated label }%
\6
\&{if} ${}(\\{mp}\MG\\{label\_loc}[\|k]+\\{lk\_offset}>\T{255}){}$\5
${}\{{}$\1\6
${}\\{lk\_offset}\K\T{0};{}$\6
${}\\{mp}\MG\\{lk\_started}\K\\{false}{}$;\C{ location 0 can do double duty }\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{char\_remainder}[\\{mp}\MG\\{label\_char}[\|k]]\K\\{lk%
\_offset};{}$\6
\&{while} ${}(\\{mp}\MG\\{label\_loc}[\|k-\T{1}]\E\\{mp}\MG\\{label\_loc}[%
\|k]){}$\5
${}\{{}$\1\6
\\{decr}(\|k);\6
${}\\{mp}\MG\\{char\_remainder}[\\{mp}\MG\\{label\_char}[\|k]]\K\\{lk%
\_offset};{}$\6
\4${}\}{}$\2\6
\\{incr}(\\{lk\_offset});\6
\\{decr}(\|k);\6
\4${}\}{}$\2\5
\&{while} ${}(\R(\\{lk\_offset}+\\{mp}\MG\\{label\_loc}[\|k]<\T{256})){}$;\C{
N.B.: \PB{$\\{lk\_offset}\K\T{256}$} satisfies this when \PB{$\|k\K\T{0}$} }\6
\4${}\}{}$\2\6
\&{if} ${}(\\{lk\_offset}>\T{0}){}$\5
${}\{{}$\1\6
\&{while} ${}(\|k>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{char\_remainder}[\\{mp}\MG\\{label\_char}[\|k]]\K\\{mp}\MG%
\\{char\_remainder}[\\{mp}\MG\\{label\_char}[\|k]]+\\{lk\_offset};{}$\6
\\{decr}(\|k);\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1220.\fi

\M{1222}\B\X1222:Output the ligature/kern program\X${}\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{255};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{skip\_table}[\|k]<\\{undefined\_label}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(local\ label\ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\|k);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"::\ was\ missing)"});{}$\6
;\6
${}\\{cancel\_skips}(\\{mp}\MG\\{skip\_table}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{lk\_started}){}$\5
${}\{{}$\C{ \PB{$\\{lk\_offset}\K\T{1}$} for the special \PB{\\{bchar}} }\1\6
\\{tfm\_out}(\T{255});\6
${}\\{tfm\_out}(\\{mp}\MG\\{bchar});{}$\6
${}\\{mp\_tfm\_two}(\\{mp},\39\T{0});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\|k\Z\\{lk\_offset};{}$ ${}\|k\PP){}$\5
${}\{{}$\C{ output the redirection specs }\1\6
${}\\{mp}\MG\\{ll}\K\\{mp}\MG\\{label\_loc}[\\{mp}\MG\\{label\_ptr}];{}$\6
\&{if} ${}(\\{mp}\MG\\{bchar}<\T{0}){}$\5
${}\{{}$\1\6
\\{tfm\_out}(\T{254});\6
\\{tfm\_out}(\T{0});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{tfm\_out}(\T{255});\6
${}\\{tfm\_out}(\\{mp}\MG\\{bchar});{}$\6
\4${}\}{}$\2\6
;\6
${}\\{mp\_tfm\_two}(\\{mp},\39\\{mp}\MG\\{ll}+\\{lk\_offset});{}$\6
\&{do}\5
${}\{{}$\1\6
${}\\{mp}\MG\\{label\_ptr}\MM;{}$\6
\4${}\}{}$\2\5
\&{while} ${}(\R(\\{mp}\MG\\{label\_loc}[\\{mp}\MG\\{label\_ptr}]<\\{mp}\MG%
\\{ll}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{mp}\MG\\{nl};{}$ ${}\|k\PP){}$\1\5
${}\\{mp\_tfm\_qqqq}(\\{mp},\39\\{mp}\MG\\{lig\_kern}[\|k]);{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{arg};\7
\\{new\_number}(\\{arg});\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{mp}\MG\\{nk};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg},\39\\{mp}\MG\\{kern}[\|k]);{}$\6
${}\\{mp\_tfm\_four}(\\{mp},\39\\{mp\_dimen\_out}(\\{mp},\39\\{arg}));{}$\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg});\6
\4${}\}{}$\2\par
\U1217.\fi

\M{1223}\B\X1223:Output the extensible character recipes and the font metric
parameters\X${}\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{mp}\MG\\{ne};{}$ ${}\|k\PP){}$\1\5
${}\\{mp\_tfm\_qqqq}(\\{mp},\39\\{mp}\MG\\{exten}[\|k]);{}$\2\6
${}\{{}$\1\6
\&{mp\_number} \\{arg};\7
\\{new\_number}(\\{arg});\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\|k\Z\\{mp}\MG\\{np};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|k\E\T{1}){}$\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg},\39\\{mp}\MG\\{param}[\T{1}]);{}$\6
\\{number\_abs}(\\{arg});\6
\&{if} ${}(\\{number\_less}(\\{arg},\39\\{fraction\_half\_t})){}$\5
${}\{{}$\1\6
${}\\{mp\_tfm\_four}(\\{mp},\39\\{number\_to\_scaled}(\\{mp}\MG\\{param}[%
\T{1}])*\T{16});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{incr}(\\{mp}\MG\\{tfm\_changed});{}$\6
\&{if} ${}(\\{number\_positive}(\\{mp}\MG\\{param}[\T{1}])){}$\1\5
${}\\{mp\_tfm\_four}(\\{mp},\39\\{max\_integer});{}$\2\6
\&{else}\1\5
${}\\{mp\_tfm\_four}(\\{mp},\39{-}\\{max\_integer});{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{number\_clone}(\\{arg},\39\\{mp}\MG\\{param}[\|k]);{}$\6
${}\\{mp\_tfm\_four}(\\{mp},\39\\{mp\_dimen\_out}(\\{mp},\39\\{arg}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{arg});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{tfm\_changed}>\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{tfm\_changed}\E\T{1}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(a\ font\ metric\ dime}\)\.{nsion"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"("});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp}\MG\\{tfm\_changed});{}$\6
;\6
${}\\{mp\_print}(\\{mp},\39\.{"\ font\ metric\ dimens}\)\.{ions"});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ had\ to\ be\ decrease}\)\.{d)"});{}$\6
\4${}\}{}$\2\par
\U1217.\fi

\M{1224}\B\X1224:Log the subfile sizes of the \.{TFM} file\X${}\E{}$\6
${}\{{}$\1\6
\&{char} \|s[\T{200}];\7
\\{wlog\_ln}(\.{"\ "});\6
\&{if} ${}(\\{mp}\MG\\{bch\_label}<\\{undefined\_label}){}$\1\5
${}\\{mp}\MG\\{nl}\MM;{}$\2\6
${}\\{mp\_snprintf}(\|s,\39\T{128},\39\.{"(You\ used\ \%iw,\%ih,\%}\)\.{id,%
\%ii,\%il,\%ik,\%ie,\%}\)\.{ip\ metric\ file\ posit}\)\.{ions)"},\39\\{mp}\MG%
\\{nw},\39\\{mp}\MG\\{nh},\39\\{mp}\MG\\{nd},\39\\{mp}\MG\\{ni},\39\\{mp}\MG%
\\{nl},\39\\{mp}\MG\\{nk},\39\\{mp}\MG\\{ne},\39\\{mp}\MG\\{np});{}$\6
\\{wlog\_ln}(\|s);\6
\4${}\}{}$\2\par
\U1217.\fi

\N{1}{1225}Reading font metric data.

\MP\ isn't a typesetting program but it does need to find the bounding box
of a sequence of typeset characters.  Thus it needs to read \.{TFM} files as
well as write them.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{tfm\_infile}{}$;\par
\fi

\M{1226}All the width, height, and depth information is stored in an array
called
\PB{\\{font\_info}}.  This array is allocated sequentially and each font is
stored
as a series of \PB{\\{char\_info}} words followed by the width, height, and
depth
tables.  Since \PB{\\{font\_name}} entries are permanent, their \PB{\\{str%
\_ref}} values are
set to \PB{\.{MAX\_STR\_REF}}.

\Y\B\4\X33:Types in the outer block\X${}\mathrel+\E{}$\6
\&{typedef} \&{unsigned} \&{int} \&{font\_number};\C{ \PB{\T{0..\$F}\\{ont%
\_max}} }\par
\fi

\M{1227}The \PB{\\{font\_info}} array is indexed via a group directory arrays.
For example, the \PB{\\{char\_info}} data for character~\PB{\|c} in font~\PB{%
\|f} will be
in \PB{$\\{font\_info}[\\{char\_base}[\|f]+\|c].\\{qqqq}$}.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{font\_number} \\{font\_max};\C{ maximum font number for included text fonts
}\6
\&{size\_t} \\{font\_mem\_size};\C{ number of words for \.{TFM} information for
text fonts }\6
\&{font\_data} ${}{*}\\{font\_info}{}$;\C{ height, width, and depth data }\6
\&{char} ${}{*}{*}\\{font\_enc\_name}{}$;\C{ encoding names, if any }\6
\&{boolean} ${}{*}\\{font\_ps\_name\_fixed}{}$;\C{ are the postscript names
fixed already?  }\6
\&{size\_t} \\{next\_fmem};\C{ next unused entry in \PB{\\{font\_info}} }\6
\&{font\_number} \\{last\_fnum};\C{ last font number used so far }\6
\&{integer} ${}{*}\\{font\_dsize}{}$;\C{ 16 times the ``design'' size in \ps\
points }\6
\&{char} ${}{*}{*}\\{font\_name}{}$;\C{ name as specified in the \&{infont}
command }\6
\&{char} ${}{*}{*}\\{font\_ps\_name}{}$;\C{ PostScript name for use when \PB{$%
\\{internal}[\\{mp\_prologues}]>\T{0}$} }\6
\&{font\_number} \\{last\_ps\_fnum};\C{ last valid \PB{\\{font\_ps\_name}}
index }\6
\&{eight\_bits} ${}{*}\\{font\_bc};{}$\6
\&{eight\_bits} ${}{*}\\{font\_ec}{}$;\C{ first and last character code }\6
\&{int} ${}{*}\\{char\_base}{}$;\C{ base address for \PB{\\{char\_info}} }\6
\&{int} ${}{*}\\{width\_base}{}$;\C{ index for zeroth character width }\6
\&{int} ${}{*}\\{height\_base}{}$;\C{ index for zeroth character height }\6
\&{int} ${}{*}\\{depth\_base}{}$;\C{ index for zeroth character depth }\6
\&{mp\_node} ${}{*}\\{font\_sizes}{}$;\par
\fi

\M{1228}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{font\_mem\_size}\K\T{10000};{}$\6
${}\\{mp}\MG\\{font\_info}\K\\{xmalloc}((\\{mp}\MG\\{font\_mem\_size}+\T{1}),%
\39\&{sizeof}(\&{font\_data}));{}$\6
${}\\{memset}(\\{mp}\MG\\{font\_info},\39\T{0},\39\&{sizeof}(\&{font\_data})*(%
\\{mp}\MG\\{font\_mem\_size}+\T{1}));{}$\6
${}\\{mp}\MG\\{last\_fnum}\K\\{null\_font}{}$;\par
\fi

\M{1229}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\|k\Z{}$(\&{int}) \\{mp}${}\MG\\{last\_fnum};{}$
${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{xfree}(\\{mp}\MG\\{font\_enc\_name}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_name}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_ps\_name}[\|k]);{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k\Z\T{255};{}$ ${}\|k\PP){}$\5
${}\{{}$\C{ These are disabled for now following a bug-report about double free
   errors. TO BE FIXED, bug tracker id 831 }\C{   mp\_free\_value\_node (mp,
mp->tfm\_width[k]);   mp\_free\_value\_node (mp, mp->tfm\_height[k]);
mp\_free\_value\_node (mp, mp->tfm\_depth[k]);   mp\_free\_value\_node (mp,
mp->tfm\_ital\_corr[k]); }\6
\,${}\}{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_info});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_enc\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_ps\_name\_fixed});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_dsize});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_ps\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_bc});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_ec});{}$\6
${}\\{xfree}(\\{mp}\MG\\{char\_base});{}$\6
${}\\{xfree}(\\{mp}\MG\\{width\_base});{}$\6
${}\\{xfree}(\\{mp}\MG\\{height\_base});{}$\6
${}\\{xfree}(\\{mp}\MG\\{depth\_base});{}$\6
${}\\{xfree}(\\{mp}\MG\\{font\_sizes}){}$;\par
\fi

\M{1230}
\Y\B\&{void} \\{mp\_reallocate\_fonts}(\&{MP} \\{mp}${},\39{}$\&{font\_number} %
\|l)\1\1\2\2\6
${}\{{}$\1\6
\&{font\_number} \|f;\7
${}\.{XREALLOC}(\\{mp}\MG\\{font\_enc\_name},\39\|l,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_ps\_name\_fixed},\39\|l,\39\&{boolean});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_dsize},\39\|l,\39\&{integer});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_name},\39\|l,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_ps\_name},\39\|l,\39{}$\&{char} ${}{*});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_bc},\39\|l,\39\&{eight\_bits});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_ec},\39\|l,\39\&{eight\_bits});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{char\_base},\39\|l,\39\&{int});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{width\_base},\39\|l,\39\&{int});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{height\_base},\39\|l,\39\&{int});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{depth\_base},\39\|l,\39\&{int});{}$\6
${}\.{XREALLOC}(\\{mp}\MG\\{font\_sizes},\39\|l,\39\&{mp\_node});{}$\6
\&{for} ${}(\|f\K(\\{mp}\MG\\{last\_fnum}+\T{1});{}$ ${}\|f\Z\|l;{}$ ${}\|f%
\PP){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{font\_enc\_name}[\|f]\K\NULL;{}$\6
${}\\{mp}\MG\\{font\_ps\_name\_fixed}[\|f]\K\\{false};{}$\6
${}\\{mp}\MG\\{font\_name}[\|f]\K\NULL;{}$\6
${}\\{mp}\MG\\{font\_ps\_name}[\|f]\K\NULL;{}$\6
${}\\{mp}\MG\\{font\_sizes}[\|f]\K\NULL;{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{font\_max}\K\|l;{}$\6
\4${}\}{}$\2\par
\fi

\M{1231}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_reallocate\_fonts}(\&{MP} \\{mp}${},\39{}$\&{font\_number} %
\|l);\par
\fi

\M{1232}A \PB{\\{null\_font}} containing no characters is useful for error
recovery.  Its
\PB{\\{font\_name}} entry starts out empty but is reset each time an erroneous
font is
found.  This helps to cut down on the number of duplicate error messages
without
wasting a lot of space.

\Y\B\4\D$\\{null\_font}$ \5
\T{0}\C{ the \PB{\&{font\_number}} for an empty font }\par
\Y\B\4\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{font\_dsize}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{font\_bc}[\\{null\_font}]\K\T{1};{}$\6
${}\\{mp}\MG\\{font\_ec}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{char\_base}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{width\_base}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{height\_base}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{depth\_base}[\\{null\_font}]\K\T{0};{}$\6
${}\\{mp}\MG\\{next\_fmem}\K\T{0};{}$\6
${}\\{mp}\MG\\{last\_fnum}\K\\{null\_font};{}$\6
${}\\{mp}\MG\\{last\_ps\_fnum}\K\\{null\_font};{}$\6
${}\{{}$\1\6
\&{static} \&{char} \\{nullfont\_name}[\,]${}\K\.{"nullfont"};{}$\6
\&{static} \&{char} \\{nullfont\_psname}[\,]${}\K\.{""};{}$\7
${}\\{mp}\MG\\{font\_name}[\\{null\_font}]\K\\{nullfont\_name};{}$\6
${}\\{mp}\MG\\{font\_ps\_name}[\\{null\_font}]\K\\{nullfont\_psname};{}$\6
\4${}\}{}$\2\6
${}\\{mp}\MG\\{font\_ps\_name\_fixed}[\\{null\_font}]\K\\{false};{}$\6
${}\\{mp}\MG\\{font\_enc\_name}[\\{null\_font}]\K\NULL;{}$\6
${}\\{mp}\MG\\{font\_sizes}[\\{null\_font}]\K\NULL{}$;\par
\fi

\M{1233}Each \PB{\\{char\_info}} word is of type \PB{\&{four\_quarters}}.  The %
\PB{\\{b0}} field contains
the \PB{\\{width}\\{index}}; the \PB{\\{b1}} field contains the height
index; the \PB{\\{b2}} fields contains the depth index, and the \PB{\\{b3}}
field used only
for temporary storage. (It is used to keep track of which characters occur in
an edge structure that is being shipped out.)
The corresponding words in the width, height, and depth tables are stored as
\PB{\\{scaled}} values in units of \ps\ points.

With the macros below, the \PB{\\{char\_info}} word for character~\PB{\|c} in
font~\PB{\|f} is
\PB{$\\{char\_mp\_info}(\|f,\|c)$} and the width is
$$\hbox{\PB{$\\{char\_width}(\|f,\\{char\_mp\_info}(\|f,\|c)).\\{sc}$}.}$$

\Y\B\4\D$\\{char\_mp\_info}(\|A,\|B)$ \5
$\\{mp}\MG\\{font\_info}[\\{mp}\MG\\{char\_base}[(\|A)]+(\|B)].{}$\\{qqqq}\par
\B\4\D$\\{char\_width}(\|A,\|B)$ \5
$\\{mp}\MG\\{font\_info}[\\{mp}\MG\\{width\_base}[(\|A)]+(\|B).\\{b0}].{}$%
\\{sc}\par
\B\4\D$\\{char\_height}(\|A,\|B)$ \5
$\\{mp}\MG\\{font\_info}[\\{mp}\MG\\{height\_base}[(\|A)]+(\|B).\\{b1}].{}$%
\\{sc}\par
\B\4\D$\\{char\_depth}(\|A,\|B)$ \5
$\\{mp}\MG\\{font\_info}[\\{mp}\MG\\{depth\_base}[(\|A)]+(\|B).\\{b2}].{}$%
\\{sc}\par
\B\4\D$\\{ichar\_exists}(\|A)$ \5
$((\|A).\\{b0}>\T{0}{}$)\par
\fi

\M{1234}When we have a font name and we don't know whether it has been loaded
yet,
we scan the \PB{\\{font\_name}} array before calling \PB{\\{read\_font\_info}}.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{font\_number} \\{mp\_find\_font}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|f){}$;\par
\fi

\M{1235}\B\&{font\_number} \\{mp\_find\_font}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\|f){}$\1\1\2\2\6
${}\{{}$\1\6
\&{font\_number} \|n;\7
\&{for} ${}(\|n\K\T{0};{}$ ${}\|n\Z\\{mp}\MG\\{last\_fnum};{}$ ${}\|n\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_xstrcmp}(\|f,\39\\{mp}\MG\\{font\_name}[\|n])\E\T{0}){}$\5
${}\{{}$\1\6
\&{return} \|n;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|n\K\\{mp\_read\_font\_info}(\\{mp},\39\|f);{}$\6
\&{return} \|n;\6
\4${}\}{}$\2\par
\fi

\M{1236}This is an interface function for getting the width of character,
as a double in ps units

\Y\B\&{double} \\{mp\_get\_char\_dimension}(\&{MP} \\{mp}${},\39{}$\&{char}
${}{*}\\{fname},\39{}$\&{int} \|c${},\39{}$\&{int} \|t)\1\1\2\2\6
${}\{{}$\1\6
\&{unsigned} \|n;\6
\&{four\_quarters} \\{cc};\6
\&{font\_number} \|f${}\K\T{0};{}$\6
\&{double} \|w${}\K{-}\T{1.0};{}$\7
\&{for} ${}(\|n\K\T{0};{}$ ${}\|n\Z\\{mp}\MG\\{last\_fnum};{}$ ${}\|n\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp\_xstrcmp}(\\{fname},\39\\{mp}\MG\\{font\_name}[\|n])\E%
\T{0}){}$\5
${}\{{}$\1\6
${}\|f\K\|n;{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|f\E\T{0}){}$\1\5
\&{return} \T{0.0};\2\6
${}\\{cc}\K\\{char\_mp\_info}(\|f,\39\|c);{}$\6
\&{if} ${}(\R\\{ichar\_exists}(\\{cc})){}$\1\5
\&{return} \T{0.0};\2\6
\&{if} ${}(\|t\E\.{'w'}){}$\1\5
${}\|w\K{}$(\&{double}) \\{char\_width}${}(\|f,\39\\{cc});{}$\2\6
\&{else} \&{if} ${}(\|t\E\.{'h'}){}$\1\5
${}\|w\K{}$(\&{double}) \\{char\_height}${}(\|f,\39\\{cc});{}$\2\6
\&{else} \&{if} ${}(\|t\E\.{'d'}){}$\1\5
${}\|w\K{}$(\&{double}) \\{char\_depth}${}(\|f,\39\\{cc});{}$\2\6
\&{return} \|w${}/\T{655.35}*(\T{72.27}/\T{72});{}$\6
\4${}\}{}$\2\par
\fi

\M{1237}\B\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{double} \\{mp\_get\_char\_dimension}(\&{MP} \\{mp}${},\39{}$\&{char} ${}{*}%
\\{fname},\39{}$\&{int} \|n${},\39{}$\&{int} \|t);\par
\fi

\M{1238}If we discover that the font doesn't have a requested character, we
omit it
from the bounding box computation and expect the \ps\ interpreter to drop it.
This routine issues a warning message if the user has asked for it.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_lost\_warning}(\&{MP} \\{mp}${},\39{}$\&{font%
\_number} \|f${},\39{}$\&{int} \|k);\par
\fi

\M{1239}\B\&{void} \\{mp\_lost\_warning}(\&{MP} \\{mp}${},\39{}$\&{font%
\_number} \|f${},\39{}$\&{int} \|k)\1\1\2\2\6
${}\{{}$\1\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_lost%
\_chars})))\5
${}\{{}$\1\6
\\{mp\_begin\_diagnostic}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{selector}\E\\{log\_only}){}$\1\5
${}\\{incr}(\\{mp}\MG\\{selector});{}$\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Missing\ character:\ }\)\.{There\ is\ no\
"});{}$\6
;\6
${}\\{mp\_print\_int}(\\{mp},\39\|k);{}$\6
${}\\{mp\_print}(\\{mp},\39\.{"\ in\ font\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{font\_name}[\|f]);{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'!'}));{}$\6
${}\\{mp\_end\_diagnostic}(\\{mp},\39\\{false});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1240}The whole purpose of saving the height, width, and depth information is
to be
able to find the bounding box of an item of text in an edge structure.  The
\PB{\\{set\_text\_box}} procedure takes a text node and adds this information.

\Y\B\4\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_set\_text\_box}(\&{MP} \\{mp}${},\39{}$\&{mp\_text%
\_node} \|p);\par
\fi

\M{1241}\B\&{void} \\{mp\_set\_text\_box}(\&{MP} \\{mp}${},\39{}$\&{mp\_text%
\_node} \|p)\1\1\2\2\6
${}\{{}$\1\6
\&{font\_number} \|f;\C{ \PB{\\{mp\_font\_n}(\|p)} }\6
\&{ASCII\_code} \\{bc}${},{}$ \\{ec};\C{ range of valid characters for font %
\PB{\|f} }\6
\&{size\_t} \|k${},{}$ \\{kk};\C{ current character and character to stop at }\6
\&{four\_quarters} \\{cc};\C{ the \PB{\\{char\_info}} for the current character
}\6
\&{mp\_number} \|h${},{}$ \|d;\C{ dimensions of the current character }\7
\\{new\_number}(\|h);\6
\\{new\_number}(\|d);\6
${}\\{set\_number\_to\_zero}(\|p\MG\\{width});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|p\MG\\{height});{}$\6
${}\\{set\_number\_to\_neg\_inf}(\|p\MG\\{depth});{}$\6
${}\|f\K{}$(\&{font\_number}) \\{mp\_font\_n}(\|p);\6
${}\\{bc}\K\\{mp}\MG\\{font\_bc}[\|f];{}$\6
${}\\{ec}\K\\{mp}\MG\\{font\_ec}[\|f];{}$\6
${}\\{kk}\K\\{mp\_text\_p}(\|p)\MG\\{len};{}$\6
${}\|k\K\T{0};{}$\6
\&{while} ${}(\|k<\\{kk}){}$\5
${}\{{}$\1\6
\X1242:Adjust \PB{\|p}'s bounding box to contain \PB{\\{str\_pool}[\|k]};
advance \PB{\|k}\X;\6
\4${}\}{}$\2\6
\X1243:Set the height and depth to zero if the bounding box is empty\X;\6
\\{free\_number}(\|h);\6
\\{free\_number}(\|d);\6
\4${}\}{}$\2\par
\fi

\M{1242}\B\X1242:Adjust \PB{\|p}'s bounding box to contain \PB{\\{str\_pool}[%
\|k]}; advance \PB{\|k}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(({*}(\\{mp\_text\_p}(\|p)\MG\\{str}+\|k)<\\{bc})\V({*}(\\{mp\_text%
\_p}(\|p)\MG\\{str}+\|k)>\\{ec})){}$\5
${}\{{}$\1\6
${}\\{mp\_lost\_warning}(\\{mp},\39\|f,\39{*}(\\{mp\_text\_p}(\|p)\MG\\{str}+%
\|k));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{cc}\K\\{char\_mp\_info}(\|f,\39{*}(\\{mp\_text\_p}(\|p)\MG\\{str}+%
\|k));{}$\6
\&{if} ${}(\R\\{ichar\_exists}(\\{cc})){}$\5
${}\{{}$\1\6
${}\\{mp\_lost\_warning}(\\{mp},\39\|f,\39{*}(\\{mp\_text\_p}(\|p)\MG\\{str}+%
\|k));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{set\_number\_from\_scaled}(\|p\MG\\{width},\39\\{number\_to\_scaled}(\|p%
\MG\\{width})+\\{char\_width}(\|f,\39\\{cc}));{}$\6
${}\\{set\_number\_from\_scaled}(\|h,\39\\{char\_height}(\|f,\39\\{cc}));{}$\6
${}\\{set\_number\_from\_scaled}(\|d,\39\\{char\_depth}(\|f,\39\\{cc}));{}$\6
\&{if} ${}(\\{number\_greater}(\|h,\39\|p\MG\\{height})){}$\1\5
${}\\{number\_clone}(\|p\MG\\{height},\39\|h);{}$\2\6
\&{if} ${}(\\{number\_greater}(\|d,\39\|p\MG\\{depth})){}$\1\5
${}\\{number\_clone}(\|p\MG\\{depth},\39\|d);{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{incr}(\|k);\6
\4${}\}{}$\2\par
\U1241.\fi

\M{1243}Let's hope modern compilers do comparisons correctly when the
difference would
overflow.

\Y\B\4\X1243:Set the height and depth to zero if the bounding box is empty\X${}%
\E{}$\6
\&{if} ${}(\\{number\_to\_scaled}(\|p\MG\\{height})<{-}\\{number\_to\_scaled}(%
\|p\MG\\{depth})){}$\5
${}\{{}$\1\6
${}\\{set\_number\_to\_zero}(\|p\MG\\{height});{}$\6
${}\\{set\_number\_to\_zero}(\|p\MG\\{depth});{}$\6
\4${}\}{}$\2\par
\U1241.\fi

\M{1244}The new primitives fontmapfile and fontmapline.

\Y\B\4\X1048:Declare action procedures for use by \PB{\\{do\_statement}}\X${}%
\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_mapfile}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_do\_mapline}(\&{MP} \\{mp});\par
\fi

\M{1245}\B\&{static} \&{void} \\{mp\_do\_mapfile}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\X1246:Complain about improper map operation\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_map\_file}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{static} \&{void} \\{mp\_do\_mapline}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\X1246:Complain about improper map operation\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_map\_line}(\\{mp},\39\\{cur\_exp\_str}(\,));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1246}\B\X1246:Complain about improper map operation\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Only\ known\ strings\ }\)\.{can\ be%
\ map\ files\ or\ }\)\.{map\ lines."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Unsuitable\ expressi}\)\.{on"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\U1245.\fi

\M{1247}To print \PB{\\{scaled}} value to PDF output we need some subroutines
to ensure
accurary.

\Y\B\4\D$\\{max\_integer}$ \5
\T{\^7FFFFFFF}\C{ $2^{31}-1$ }\par
\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{integer} \\{ten\_pow}[\T{10}];\C{ $10^0..10^9$ }\6
\&{integer} \\{scaled\_out};\C{ amount of \PB{\\{scaled}} that was taken out in
\PB{\\{divide\_scaled}} }\par
\fi

\M{1248}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{ten\_pow}[\T{0}]\K\T{1};{}$\6
\&{for} ${}(\|i\K\T{1};{}$ ${}\|i\Z\T{9};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{ten\_pow}[\|i]\K\T{10}*\\{mp}\MG\\{ten\_pow}[\|i-\T{1}];{}$\6
\4${}\}{}$\2\par
\fi

\N{1}{1249}Shipping pictures out.
The \PB{\\{ship\_out}} procedure, to be described below, is given a pointer to
an edge structure. Its mission is to output a file containing the \ps\
description of an edge structure.

\fi

\M{1250}Each time an edge structure is shipped out we write a new \ps\ output
file named according to the current \&{charcode}.

This is the only backend function that remains in the main \PB{$\\{mpost}.\|w$}
file.
There are just too many variable accesses needed for status reporting
etcetera to make it worthwile to move the code to \PB{$\\{psout}.\|w$}.

\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_open\_output\_file}(\&{MP} \\{mp});\6
\&{char} ${}{*}{}$\\{mp\_get\_output\_file\_name}(\&{MP} \\{mp});\6
\&{char} ${}{*}{}$\\{mp\_set\_output\_file\_name}(\&{MP} \\{mp}${},\39{}$%
\&{integer} \|c);\par
\fi

\M{1251}\B\&{static} \&{void} \\{mp\_append\_to\_template}(\&{MP} \\{mp}${},%
\39{}$\&{integer} \\{ff}${},\39{}$\&{integer} \|c${},\39{}$\&{boolean} %
\\{rounding})\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{internal\_type}(\|c)\E\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\\{ss}\K\\{mp\_str}(\\{mp},\39\\{internal\_string}(\|c));{}$\7
${}\\{mp\_print}(\\{mp},\39\\{ss});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{internal\_type}(\|c)\E\\{mp\_known}){}$\5
${}\{{}$\1\6
\&{if} (\\{rounding})\5
${}\{{}$\1\6
\&{int} \\{cc}${}\K\\{round\_unscaled}(\\{internal\_value}(\|c));{}$\7
${}\\{print\_with\_leading\_zeroes}(\\{cc},\39\\{ff});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{print\_number}(\\{internal\_value}(\|c));\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\7
\&{char} ${}{*}{}$\\{mp\_set\_output\_file\_name}(\&{MP} \\{mp}${},\39{}$%
\&{integer} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\\{ss}\K\NULL{}$;\C{ filename extension proposal }\6
\&{char} ${}{*}\\{nn}\K\NULL{}$;\C{ temp string  for str() }\6
\&{unsigned} \\{old\_setting};\C{ previous \PB{\\{selector}} setting }\6
\&{size\_t} \|i;\C{  indexes into \PB{\\{filename\_template}}  }\6
\&{integer} \|f;\C{ field width }\7
\\{str\_room}(\T{1024});\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\1\5
\\{mp\_open\_log\_file}(\\{mp});\2\6
\&{if} ${}(\\{internal\_string}(\\{mp\_output\_template})\E\NULL){}$\5
${}\{{}$\1\6
\&{char} ${}{*}\|s{}$;\C{ a file extension derived from \PB{\|c} }\7
\&{if} ${}(\|c<\T{0}){}$\1\5
${}\|s\K\\{xstrdup}(\.{".ps"});{}$\2\6
\&{else}\1\5
\X1252:Use \PB{\|c} to compute the file extension \PB{\|s}\X;\2\6
${}\\{mp\_pack\_job\_name}(\\{mp},\39\|s);{}$\6
\\{free}(\|s);\6
${}\\{ss}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ initializations }\1\6
\&{mp\_string} \|s${},{}$ \|n${},{}$ \\{ftemplate};\C{ a file extension derived
from \PB{\|c} }\6
\&{mp\_number} \\{saved\_char\_code};\7
\\{new\_number}(\\{saved\_char\_code});\6
${}\\{number\_clone}(\\{saved\_char\_code},\39\\{internal\_value}(\\{mp\_char%
\_code}));{}$\6
${}\\{set\_internal\_from\_number}(\\{mp\_char\_code},\39\\{unity\_t});{}$\6
${}\\{number\_multiply\_int}(\\{internal\_value}(\\{mp\_char\_code}),\39%
\|c);{}$\6
\&{if} ${}(\\{internal\_string}(\\{mp\_job\_name})\E\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{job\_name}\K\\{xstrdup}(\.{"mpout"});{}$\6
\4${}\}{}$\2\6
\X868:Fix up \PB{$\\{mp}\MG\\{internal}[\\{mp\_job\_name}]$}\X;\6
\4${}\}{}$\2\6
${}\\{old\_setting}\K\\{mp}\MG\\{selector};{}$\6
${}\\{mp}\MG\\{selector}\K\\{new\_string};{}$\6
${}\|i\K\T{0};{}$\6
${}\|n\K\\{mp\_rts}(\\{mp},\39\.{""}){}$;\C{ initialize }\6
${}\\{ftemplate}\K\\{internal\_string}(\\{mp\_output\_template});{}$\6
\&{while} ${}(\|i<\\{ftemplate}\MG\\{len}){}$\5
${}\{{}$\1\6
${}\|f\K\T{0};{}$\6
\&{if} ${}({*}(\\{ftemplate}\MG\\{str}+\|i)\E\.{'\%'}){}$\5
${}\{{}$\1\6
\4\.{CONTINUE}:\5
\\{incr}(\|i);\6
\&{if} ${}(\|i<\\{ftemplate}\MG\\{len}){}$\5
${}\{{}$\1\6
\&{switch} ${}({*}(\\{ftemplate}\MG\\{str}+\|i)){}$\5
${}\{{}$\1\6
\4\&{case} \.{'j'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_job\_name},\39%
\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'c'}:\6
\&{if} (\\{number\_negative}(\\{internal\_value}(\\{mp\_char\_code})))\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"ps"});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_char\_code},\39%
\\{true});{}$\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \.{'o'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_output\_format},\39%
\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'d'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_day},\39\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'m'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_month},\39\\{true});{}$%
\6
\&{break};\6
\4\&{case} \.{'y'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_year},\39\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'H'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_hour},\39\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'M'}:\5
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{mp\_minute},\39%
\\{true});{}$\6
\&{break};\6
\4\&{case} \.{'\{'}:\6
${}\{{}$\C{ look up a name }\1\6
\&{size\_t} \|l${}\K\T{0};{}$\6
\&{size\_t} \\{frst}${}\K\|i+\T{1};{}$\7
\&{while} ${}(\|i<\\{ftemplate}\MG\\{len}){}$\5
${}\{{}$\1\6
${}\|i\PP;{}$\6
\&{if} ${}({*}(\\{ftemplate}\MG\\{str}+\|i)\E\.{'\}'}){}$\1\5
\&{break};\2\6
${}\|l\PP;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|l>\T{0}){}$\5
${}\{{}$\1\6
\&{mp\_sym} \|p${}\K\\{mp\_id\_lookup}(\\{mp},\39{}$(\&{char} ${}{*})(%
\\{ftemplate}\MG\\{str}+\\{frst}),\39\|l,\39\\{false});{}$\6
\&{char} ${}{*}\\{id}\K\\{xmalloc}((\|l+\T{1}),\39\T{1});{}$\7
(\&{void}) \\{memcpy}${}(\\{id},\39{}$(\&{char} ${}{*})(\\{ftemplate}\MG%
\\{str}+\\{frst}),\39{}$(\&{size\_t}) \|l);\6
${}{*}(\\{id}+\|l)\K\.{'\\0'};{}$\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
\&{char} \\{err}[\T{256}];\7
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"requested\ identifie}\)\.{r\ (%
\%s)\ in\ outputtemp}\)\.{late\ not\ found."},\39\\{id});{}$\6
${}\\{mp\_warn}(\\{mp},\39\\{err});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{eq\_type}(\|p)\E\\{mp\_internal\_quantity}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{equiv}(\|p)\E\\{mp\_output\_template}){}$\5
${}\{{}$\1\6
\&{char} \\{err}[\T{256}];\7
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"The\ appearance\ of\ o}\)%
\.{utputtemplate\ inside}\)\.{\ outputtemplate\ is\ i}\)\.{gnored."});{}$\6
${}\\{mp\_warn}(\\{mp},\39\\{err});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_append\_to\_template}(\\{mp},\39\|f,\39\\{equiv}(\|p),\39%
\\{false});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{char} \\{err}[\T{256}];\7
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"requested\ identifie}\)\.{r\ (%
\%s)\ in\ outputtemp}\)\.{late\ is\ not\ an\ inter}\)\.{nal."},\39\\{id});{}$\6
${}\\{mp\_warn}(\\{mp},\39\\{err});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{free}(\\{id});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{break};\6
\4\&{case} \.{'0'}:\5
\&{case} \.{'1'}:\5
\&{case} \.{'2'}:\5
\&{case} \.{'3'}:\5
\&{case} \.{'4'}:\5
\&{case} \.{'5'}:\5
\&{case} \.{'6'}:\5
\&{case} \.{'7'}:\5
\&{case} \.{'8'}:\5
\&{case} \.{'9'}:\6
\&{if} ${}((\|f<\T{10})){}$\1\5
${}\|f\K(\|f*\T{10})+\\{ftemplate}\MG\\{str}[\|i]-\.{'0'};{}$\2\6
\&{goto} \.{CONTINUE};\6
\&{break};\6
\4\&{case} \.{'\%'}:\5
${}\\{mp\_print\_char}(\\{mp},\39\.{'\%'});{}$\6
\&{break};\6
\4\&{default}:\6
${}\{{}$\1\6
\&{char} \\{err}[\T{256}];\7
${}\\{mp\_snprintf}(\\{err},\39\T{256},\39\.{"requested\ format\ (\%}\)\.{c)\
in\ outputtemplate}\)\.{\ is\ unknown."},\39{*}(\\{ftemplate}\MG\\{str}+%
\|i));{}$\6
${}\\{mp\_warn}(\\{mp},\39\\{err});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39{*}(\\{ftemplate}\MG\\{str}+\|i));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}({*}(\\{ftemplate}\MG\\{str}+\|i)\E\.{'.'}){}$\1\6
\&{if} ${}(\|n\MG\\{len}\E\T{0}){}$\1\5
${}\|n\K\\{mp\_make\_string}(\\{mp});{}$\2\2\6
${}\\{mp\_print\_char}(\\{mp},\39{*}(\\{ftemplate}\MG\\{str}+\|i));{}$\6
\4${}\}{}$\2\6
;\6
\\{incr}(\|i);\6
\4${}\}{}$\2\6
${}\|s\K\\{mp\_make\_string}(\\{mp});{}$\6
${}\\{number\_clone}(\\{internal\_value}(\\{mp\_char\_code}),\39\\{saved\_char%
\_code});{}$\6
\\{free\_number}(\\{saved\_char\_code});\6
${}\\{mp}\MG\\{selector}\K\\{old\_setting};{}$\6
\&{if} ${}(\|n\MG\\{len}\E\T{0}){}$\5
${}\{{}$\1\6
${}\|n\K\|s;{}$\6
${}\|s\K\\{mp\_rts}(\\{mp},\39\.{""});{}$\6
\4${}\}{}$\2\6
${}\\{ss}\K\\{mp\_str}(\\{mp},\39\|s);{}$\6
${}\\{nn}\K\\{mp\_str}(\\{mp},\39\|n);{}$\6
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{nn},\39\.{""},\39\\{ss});{}$\6
\\{delete\_str\_ref}(\|n);\6
\\{delete\_str\_ref}(\|s);\6
\4${}\}{}$\2\6
\&{return} \\{ss};\6
\4${}\}{}$\2\7
\&{char} ${}{*}{}$\\{mp\_get\_output\_file\_name}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|f;{}$\6
\&{char} ${}{*}\\{saved\_name}{}$;\C{ saved \PB{\\{name\_of\_file}} }\7
${}\\{saved\_name}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
(\&{void}) \\{mp\_set\_output\_file\_name}${}(\\{mp},\39\\{round\_unscaled}(%
\\{internal\_value}(\\{mp\_char\_code})));{}$\6
${}\|f\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
${}\\{mp\_pack\_file\_name}(\\{mp},\39\\{saved\_name},\39\NULL,\39\NULL);{}$\6
\\{free}(\\{saved\_name});\6
\&{return} \|f;\6
\4${}\}{}$\2\7
\&{void} \\{mp\_open\_output\_file}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\\{ss}{}$;\C{ filename extension proposal }\6
\&{int} \|c;\C{ \&{charcode} rounded to the nearest integer }\7
${}\|c\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_char\_code}));{}$\6
${}\\{ss}\K\\{mp\_set\_output\_file\_name}(\\{mp},\39\|c);{}$\6
\&{while} ${}(\R\\{mp\_open\_out}(\\{mp},\39{}$(\&{void} ${}{*}){}$ ${}{\AND}%
\\{mp}\MG\\{output\_file},\39\\{mp\_filetype\_postscript})){}$\1\5
${}\\{mp\_prompt\_file\_name}(\\{mp},\39\.{"file\ name\ for\ outpu}\)\.{t"},\39%
\\{ss});{}$\2\6
${}\\{mp\_store\_true\_output\_filename}(\\{mp},\39\|c);{}$\6
\4${}\}{}$\2\par
\fi

\M{1252}The file extension created here could be up to five characters long in
extreme cases so it may have to be shortened on some systems.

\Y\B\4\X1252:Use \PB{\|c} to compute the file extension \PB{\|s}\X${}\E{}$\6
${}\{{}$\1\6
${}\|s\K\\{xmalloc}(\T{7},\39\T{1});{}$\6
${}\\{mp\_snprintf}(\|s,\39\T{7},\39\.{".\%i"},\39{}$(\&{int}) \|c);\6
\4${}\}{}$\2\par
\U1251.\fi

\M{1253}The user won't want to see all the output file names so we only save
the
first and last ones and a count of how many there were.  For this purpose
files are ordered primarily by \&{charcode} and secondarily by order of
creation.

\Y\B\4\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{void} \\{mp\_store\_true\_output\_filename}(\&{MP} \\{mp}${},\39{}$\&{int} %
\|c);\par
\fi

\M{1254}\B\&{void} \\{mp\_store\_true\_output\_filename}(\&{MP} \\{mp}${},%
\39{}$\&{int} \|c)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}((\|c<\\{mp}\MG\\{first\_output\_code})\W(\\{mp}\MG\\{first\_output%
\_code}\G\T{0})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{first\_output\_code}\K\|c;{}$\6
${}\\{xfree}(\\{mp}\MG\\{first\_file\_name});{}$\6
${}\\{mp}\MG\\{first\_file\_name}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$%
\6
\4${}\}{}$\2\6
\&{if} ${}(\|c\G\\{mp}\MG\\{last\_output\_code}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{last\_output\_code}\K\|c;{}$\6
${}\\{xfree}(\\{mp}\MG\\{last\_file\_name});{}$\6
${}\\{mp}\MG\\{last\_file\_name}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
\4${}\}{}$\2\6
${}\\{set\_internal\_string}(\\{mp\_output\_filename},\39\\{mp\_rts}(\\{mp},\39%
\\{mp}\MG\\{name\_of\_file}));{}$\6
\4${}\}{}$\2\par
\fi

\M{1255}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{first\_file\_name};{}$\6
\&{char} ${}{*}\\{last\_file\_name}{}$;\C{ full file names }\6
\&{integer} \\{first\_output\_code};\6
\&{integer} \\{last\_output\_code};\C{ rounded \&{charcode} values }\6
\&{integer} \\{total\_shipped};\C{ total number of \PB{\\{ship\_out}}
operations completed }\par
\fi

\M{1256}\B\X38:Set initial values of key variables\X${}\mathrel+\E{}$\6
$\\{mp}\MG\\{first\_file\_name}\K\\{xstrdup}(\.{""});{}$\6
${}\\{mp}\MG\\{last\_file\_name}\K\\{xstrdup}(\.{""});{}$\6
${}\\{mp}\MG\\{first\_output\_code}\K\T{32768};{}$\6
${}\\{mp}\MG\\{last\_output\_code}\K{-}\T{32768};{}$\6
${}\\{mp}\MG\\{total\_shipped}\K\T{0}{}$;\par
\fi

\M{1257}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
$\\{xfree}(\\{mp}\MG\\{first\_file\_name});{}$\6
${}\\{xfree}(\\{mp}\MG\\{last\_file\_name}){}$;\par
\fi

\M{1258}\B\X1258:Begin the progress report for the output of picture~\PB{\|c}%
\X${}\E{}$\6
\&{if} ((\&{int}) \\{mp}${}\MG\\{term\_offset}>\\{mp}\MG\\{max\_print\_line}-%
\T{6}){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{term\_offset}>\T{0})\V(\\{mp}\MG\\{file%
\_offset}>\T{0})){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'['}));$ \&{if} ${}(\|c\G\T{0})$ $%
\\{mp\_print\_int}(\\{mp},\39\|c{}$)\par
\U1273.\fi

\M{1259}\B\X1259:End progress report\X${}\E{}$\6
$\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{']'}));{}$\6
\\{update\_terminal}(\,); $\\{incr}(\\{mp}\MG\\{total\_shipped}{}$)\par
\U1273.\fi

\M{1260}\B\X1260:Explain what output files were written\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{total\_shipped}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp}\MG\\{total\_shipped});{}$\6
\&{if} ${}(\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ figure"});{}$\6
\&{if} ${}(\\{mp}\MG\\{total\_shipped}>\T{1}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'s'}));{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ created."});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ output\ file"});{}$\6
\&{if} ${}(\\{mp}\MG\\{total\_shipped}>\T{1}){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'s'}));{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ written:\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{first\_file\_name});{}$\6
\&{if} ${}(\\{mp}\MG\\{total\_shipped}>\T{1}){}$\5
${}\{{}$\1\6
\&{if} ${}(\T{31}+\\{strlen}(\\{mp}\MG\\{first\_file\_name})+\\{strlen}(\\{mp}%
\MG\\{last\_file\_name})>{}$(\&{unsigned}) \\{mp}${}\MG\\{max\_print\_line}){}$%
\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ ..\ "});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{last\_file\_name});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{""});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1287.\fi

\M{1261}\B\X10:Internal library declarations\X${}\mathrel+\E{}$\6
\&{boolean} \\{mp\_has\_font\_size}(\&{MP} \\{mp}${},\39{}$\&{font\_number} %
\|f);\par
\fi

\M{1262}\B\&{boolean} \\{mp\_has\_font\_size}(\&{MP} \\{mp}${},\39{}$\&{font%
\_number} \|f)\1\1\2\2\6
${}\{{}$\1\6
\&{return} ${}(\\{mp}\MG\\{font\_sizes}[\|f]\I\NULL);{}$\6
\4${}\}{}$\2\par
\fi

\M{1263}The \&{special} command saves up lines of text to be printed during the
next
\PB{\\{ship\_out}} operation.  The saved items are stored as a list of capsule
tokens.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{mp\_node} \\{last\_pending};\C{ the last token in a list of pending specials
}\par
\fi

\M{1264}\B\X1048:Declare action procedures for use by \PB{\\{do\_statement}}%
\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_do\_special}(\&{MP} \\{mp});\par
\fi

\M{1265}\B\&{void} \\{mp\_do\_special}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\\{mp\_get\_x\_next}(\\{mp});\6
\\{mp\_scan\_expression}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{cur\_exp}.\\{type}\I\\{mp\_string\_type}){}$\5
${}\{{}$\1\6
\X1266:Complain about improper special operation\X;\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{mp\_link}(\\{mp}\MG\\{last\_pending})\K\\{mp\_stash\_cur\_exp}(%
\\{mp});{}$\6
${}\\{mp}\MG\\{last\_pending}\K\\{mp\_link}(\\{mp}\MG\\{last\_pending});{}$\6
${}\\{mp\_link}(\\{mp}\MG\\{last\_pending})\K\NULL;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1266}\B\X1266:Complain about improper special operation\X${}\E{}$\6
${}\{{}$\1\6
\&{const} \&{char} ${}{*}\\{hlp}[\,]\K\{\.{"Only\ known\ strings\ }\)\.{are\
allowed\ for\ outp}\)\.{ut\ as\ specials."},\39\NULL\};{}$\7
${}\\{mp\_disp\_err}(\\{mp},\39\NULL);{}$\6
${}\\{mp\_back\_error}(\\{mp},\39\.{"Unsuitable\ expressi}\)\.{on"},\39\\{hlp},%
\39\\{true});{}$\6
\\{mp\_get\_x\_next}(\\{mp});\6
\4${}\}{}$\2\par
\U1265.\fi

\M{1267}On the export side, we need an extra object type for special strings.

\Y\B\4\X459:Graphical object codes\X${}\mathrel+\E{}$\6
$\\{mp\_special\_code}\K\T{8}$ $,{}$\par
\fi

\M{1268}\B\X1268:Export pending specials\X${}\E{}$\6
$\|p\K\\{mp\_link}(\\{mp}\MG\\{spec\_head});$ \&{while} ${}(\|p\I\NULL)$ $\{$ $%
\\{mp\_special\_object}*\\{tp};$ \\{tp} $\K$ ( \\{mp\_special\_object} $*$ ) $%
\\{mp\_new\_graphic\_object}(\\{mp},\39\\{mp\_special\_code});{}$\6
${}\\{gr\_pre\_script}(\\{tp})\K\\{mp\_xstrdup}(\\{mp},\39\\{mp\_str}(\\{mp},%
\39\\{value\_str}(\|p)));$ \&{if} ${}(\\{hh}\MG\\{body}\E\NULL)$ $\\{hh}\MG%
\\{body}$ $\K$ ( \\{mp\_graphic\_object} $*$ ) \\{tp}; \&{else} \\{gr\_link}(%
\\{hp}) $\K$ ( \\{mp\_graphic\_object} $*$ ) \\{tp}; \\{hp} $\K$ ( \\{mp%
\_graphic\_object} $*$ ) \\{tp};\6
${}\|p\K\\{mp\_link}(\|p);$ $\}$ $\\{mp\_flush\_token\_list}(\\{mp},\39\\{mp%
\_link}(\\{mp}\MG\\{spec\_head}));{}$\6
${}\\{mp\_link}(\\{mp}\MG\\{spec\_head})\K\NULL;$ $\\{mp}\MG\\{last\_pending}\K%
\\{mp}\MG{}$\\{spec\_head}\par
\U1270.\fi

\M{1269}We are now ready for the main output procedure.  Note that the \PB{%
\\{selector}}
setting is saved in a global variable so that \PB{\\{begin\_diagnostic}} can
access it.

\Y\B\4\X1269:Declare the \ps\ output procedures\X${}\E{}$\6
\&{static} \&{void} \\{mp\_ship\_out}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|h);%
\par
\U1137.\fi

\M{1270}Once again, the \PB{\\{gr\_XXXX}} macros are defined in \PB{$%
\\{mppsout}.\|h$}

\Y\B\4\D$\\{export\_color}(\|q,\|p)$ \6
\&{if} ${}(\&{mp\_color\_model}(\|p)\E\\{mp\_uninitialized\_model}){}$\5
${}\{{}$\1\6
${}\\{gr\_color\_model}(\|q)\K{}$(\&{unsigned} \&{char})(${}\\{number\_to%
\_scaled}(\\{internal\_value}(\\{mp\_default\_color\_model}))/\T{65536});{}$\6
${}\\{gr\_cyan\_val}(\|q)\K\T{0};{}$\6
${}\\{gr\_magenta\_val}(\|q)\K\T{0};{}$\6
${}\\{gr\_yellow\_val}(\|q)\K\T{0};{}$\6
${}\\{gr\_black\_val}(\|q)\K((\\{gr\_color\_model}(\|q)\E\\{mp\_cmyk\_model}\?%
\\{number\_to\_scaled}(\\{unity\_t}):\T{0})/\T{65536.0});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{gr\_color\_model}(\|q)\K{}$(\&{unsigned} \&{char}) \&{mp\_color\_model}(%
\|p);\6
${}\\{gr\_cyan\_val}(\|q)\K\\{number\_to\_double}(\|p\MG\\{cyan});{}$\6
${}\\{gr\_magenta\_val}(\|q)\K\\{number\_to\_double}(\|p\MG\\{magenta});{}$\6
${}\\{gr\_yellow\_val}(\|q)\K\\{number\_to\_double}(\|p\MG\\{yellow});{}$\6
${}\\{gr\_black\_val}(\|q)\K\\{number\_to\_double}(\|p\MG\\{black});{}$\6
\4${}\}{}$\2\par
\B\4\D$\\{export\_scripts}(\|q,\|p)$ \6
\&{if} ${}(\\{mp\_pre\_script}(\|p)\I\NULL){}$\1\5
${}\\{gr\_pre\_script}(\|q)\K\\{mp\_xstrdup}(\\{mp},\39\\{mp\_str}(\\{mp},\39%
\\{mp\_pre\_script}(\|p)));{}$\2\6
\&{if} ${}(\\{mp\_post\_script}(\|p)\I\NULL){}$\1\5
${}\\{gr\_post\_script}(\|q)\K\\{mp\_xstrdup}(\\{mp},\39\\{mp\_str}(\\{mp},\39%
\\{mp\_post\_script}(\|p))){}$;\2\par
\Y\B\&{struct} \\{mp\_edge\_object} ${}{*}{}$\\{mp\_gr\_export}(\&{MP} %
\\{mp}${},\39{}$\&{mp\_edge\_header\_node} \|h)\1\1 $\{$ \&{mp\_node} \|p;\C{
the current graphical object }\6
\&{integer} \|t;\C{ a temporary value }\6
\&{integer} \|c;\C{ a rounded charcode }\6
\&{mp\_number} \\{d\_width};\C{ the current pen width }\7
${}\\{mp\_edge\_object}*\\{hh}{}$;\C{ the first graphical object }\6
${}\\{mp\_graphic\_object}*\\{hq}{}$;\C{ something \PB{\\{hp}} points to  }\6
${}\\{mp\_text\_object}*\\{tt};{}$\6
${}\\{mp\_fill\_object}*\\{tf};{}$\6
${}\\{mp\_stroked\_object}*\\{ts};{}$\6
${}\\{mp\_clip\_object}*\\{tc};{}$\6
${}\\{mp\_bounds\_object}*\\{tb};{}$\6
${}\\{mp\_graphic\_object}*\\{hp}\K\NULL{}$;\C{ the current graphical object }\6
${}\\{mp\_set\_bbox}(\\{mp},\39\|h,\39\\{true});{}$\6
${}\\{hh}\K\\{xmalloc}(\T{1},\39{}$\&{sizeof} (\\{mp\_edge\_object}));\6
${}\\{hh}\MG\\{body}\K\NULL;{}$\6
${}\\{hh}\MG\\{next}\K\NULL;{}$\6
${}\\{hh}\MG\\{parent}\K\\{mp};{}$\6
${}\\{hh}\MG\\{minx}\K\\{number\_to\_double}(\|h\MG\\{minx});{}$\6
${}\\{hh}\MG\\{minx}\K(\\{fabs}(\\{hh}\MG\\{minx})<\T{0.00001}\?\T{0}:\\{hh}\MG%
\\{minx});{}$\6
${}\\{hh}\MG\\{miny}\K\\{number\_to\_double}(\|h\MG\\{miny});{}$\6
${}\\{hh}\MG\\{miny}\K(\\{fabs}(\\{hh}\MG\\{miny})<\T{0.00001}\?\T{0}:\\{hh}\MG%
\\{miny});{}$\6
${}\\{hh}\MG\\{maxx}\K\\{number\_to\_double}(\|h\MG\\{maxx});{}$\6
${}\\{hh}\MG\\{maxx}\K(\\{fabs}(\\{hh}\MG\\{maxx})<\T{0.00001}\?\T{0}:\\{hh}\MG%
\\{maxx});{}$\6
${}\\{hh}\MG\\{maxy}\K\\{number\_to\_double}(\|h\MG\\{maxy});{}$\6
${}\\{hh}\MG\\{maxy}\K(\\{fabs}(\\{hh}\MG\\{maxy})<\T{0.00001}\?\T{0}:\\{hh}\MG%
\\{maxy});{}$\6
${}\\{hh}\MG\\{filename}\K\\{mp\_get\_output\_file\_name}(\\{mp});{}$\6
${}\|c\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_char\_code}));{}$\6
${}\\{hh}\MG\\{charcode}\K\|c;{}$\6
${}\\{hh}\MG\\{width}\K\\{number\_to\_double}(\\{internal\_value}(\\{mp\_char%
\_wd}));{}$\6
${}\\{hh}\MG\\{height}\K\\{number\_to\_double}(\\{internal\_value}(\\{mp\_char%
\_ht}));{}$\6
${}\\{hh}\MG\\{depth}\K\\{number\_to\_double}(\\{internal\_value}(\\{mp\_char%
\_dp}));{}$\6
${}\\{hh}\MG\\{ital\_corr}\K\\{number\_to\_double}(\\{internal\_value}(\\{mp%
\_char\_ic}));{}$\6
\X1268:Export pending specials\X;\6
${}\|p\K\\{mp\_link}(\\{edge\_list}(\|h));$ \&{while} ${}(\|p\I\NULL)$ $\{$ $%
\\{hq}\K\\{mp\_new\_graphic\_object}(\\{mp},\39(\&{int})((\\{mp\_type}(\|p)-%
\\{mp\_fill\_node\_type})+\T{1}));$ \&{switch} (\\{mp\_type}(\|p)) $\{$ %
\&{case} \\{mp\_fill\_node\_type}: $\{$ \&{mp\_fill\_node} \\{p0}${}\K{}$(\&{mp%
\_fill\_node}) \|p; \\{tf} $\K$ ( \\{mp\_fill\_object} $*$ ) \\{hq};\6
${}\\{gr\_pen\_p}(\\{tf})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{mp\_pen\_p}(%
\\{p0}));{}$\6
\\{new\_number}(\\{d\_width});\6
${}\\{mp\_get\_pen\_scale}(\\{mp},\39{\AND}\\{d\_width},\39\\{mp\_pen\_p}(%
\\{p0})){}$;\C{ whats the point ? }\6
\\{free\_number}(\\{d\_width});\6
\&{if} ${}((\\{mp\_pen\_p}(\\{p0})\E\NULL)\V\\{pen\_is\_elliptical}(\\{mp\_pen%
\_p}(\\{p0}))){}$\5
${}\{{}$\1\6
${}\\{gr\_path\_p}(\\{tf})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{mp\_path%
\_p}(\\{p0}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_knot} \\{pc}${},{}$ \\{pp};\7
${}\\{pc}\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(\\{p0}));{}$\6
${}\\{pp}\K\\{mp\_make\_envelope}(\\{mp},\39\\{pc},\39\\{mp\_pen\_p}(\\{p0}),%
\39\\{p0}\MG\\{ljoin},\39\T{0},\39\\{p0}\MG\\{miterlim});{}$\6
${}\\{gr\_path\_p}(\\{tf})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{pp});{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{pp});{}$\6
${}\\{pc}\K\\{mp\_htap\_ypoc}(\\{mp},\39\\{mp\_path\_p}(\\{p0}));{}$\6
${}\\{pp}\K\\{mp\_make\_envelope}(\\{mp},\39\\{pc},\39{}$\\{mp\_pen\_p}((\&{mp%
\_fill\_node}) \|p)${},\39\\{p0}\MG\\{ljoin},\39\T{0},\39\\{p0}\MG%
\\{miterlim});{}$\6
${}\\{gr\_htap\_p}(\\{tf})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{pp});{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{pp});{}$\6
\4${}\}{}$\2\6
${}\\{export\_color}(\\{tf},\39\\{p0});{}$\6
${}\\{export\_scripts}(\\{tf},\39\|p);{}$\6
${}\\{gr\_ljoin\_val}(\\{tf})\K\\{p0}\MG\\{ljoin};{}$\6
${}\\{gr\_miterlim\_val}(\\{tf})\K\\{number\_to\_double}(\\{p0}\MG%
\\{miterlim});$ $\}$ \&{break}; \&{case} \\{mp\_stroked\_node\_type}: $\{$ %
\&{mp\_stroked\_node} \\{p0}${}\K{}$(\&{mp\_stroked\_node}) \|p; \\{ts} $\K$ ( %
\\{mp\_stroked\_object} $*$ ) \\{hq};\6
${}\\{gr\_pen\_p}(\\{ts})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{mp\_pen\_p}(%
\\{p0}));{}$\6
\\{new\_number}(\\{d\_width});\6
${}\\{mp\_get\_pen\_scale}(\\{mp},\39{\AND}\\{d\_width},\39\\{mp\_pen\_p}(%
\\{p0}));{}$\6
\&{if} (\\{pen\_is\_elliptical}(\\{mp\_pen\_p}(\\{p0})))\5
${}\{{}$\1\6
${}\\{gr\_path\_p}(\\{ts})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{mp\_path%
\_p}(\\{p0}));{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{mp\_knot} \\{pc};\7
${}\\{pc}\K\\{mp\_copy\_path}(\\{mp},\39\\{mp\_path\_p}(\\{p0}));{}$\6
${}\|t\K\\{p0}\MG\\{lcap};{}$\6
\&{if} ${}(\\{mp\_left\_type}(\\{pc})\I\\{mp\_endpoint}){}$\5
${}\{{}$\1\6
${}\\{mp\_left\_type}(\\{mp\_insert\_knot}(\\{mp},\39\\{pc},\39\\{pc}\MG\\{x%
\_coord},\39\\{pc}\MG\\{y\_coord}))\K\\{mp\_endpoint};{}$\6
${}\\{mp\_right\_type}(\\{pc})\K\\{mp\_endpoint};{}$\6
${}\\{pc}\K\\{mp\_next\_knot}(\\{pc});{}$\6
${}\|t\K\T{1};{}$\6
\4${}\}{}$\2\6
${}\\{pc}\K\\{mp\_make\_envelope}(\\{mp},\39\\{pc},\39\\{mp\_pen\_p}(\\{p0}),%
\39\\{p0}\MG\\{ljoin},\39{}$(\&{quarterword}) \|t${},\39\\{p0}\MG%
\\{miterlim});{}$\6
${}\\{gr\_path\_p}(\\{ts})\K\\{mp\_export\_knot\_list}(\\{mp},\39\\{pc});{}$\6
${}\\{mp\_toss\_knot\_list}(\\{mp},\39\\{pc});{}$\6
\4${}\}{}$\2\6
${}\\{export\_color}(\\{ts},\39\\{p0});{}$\6
${}\\{export\_scripts}(\\{ts},\39\|p);{}$\6
${}\\{gr\_ljoin\_val}(\\{ts})\K\\{p0}\MG\\{ljoin};{}$\6
${}\\{gr\_miterlim\_val}(\\{ts})\K\\{number\_to\_double}(\\{p0}\MG%
\\{miterlim});{}$\6
${}\\{gr\_lcap\_val}(\\{ts})\K\\{p0}\MG\\{lcap};{}$\6
${}\\{gr\_dash\_p}(\\{ts})\K\\{mp\_export\_dashes}(\\{mp},\39\\{p0},\39\\{d%
\_width});{}$\6
\\{free\_number}(\\{d\_width}); $\}$ \&{break}; \&{case} \\{mp\_text\_node%
\_type}: $\{$ \&{mp\_text\_node} \\{p0}${}\K{}$(\&{mp\_text\_node}) \|p; \\{tt}
$\K$ ( \\{mp\_text\_object} $*$ ) \\{hq};\6
${}\\{gr\_text\_p}(\\{tt})\K\\{mp\_xstrldup}(\\{mp},\39\\{mp\_str}(\\{mp},\39%
\\{mp\_text\_p}(\|p)),\39\\{mp\_text\_p}(\|p)\MG\\{len});{}$\6
${}\\{gr\_text\_l}(\\{tt})\K{}$(\&{size\_t}) \\{mp\_text\_p}(\|p)${}\MG%
\\{len};{}$\6
${}\\{gr\_font\_n}(\\{tt})\K{}$(\&{unsigned} \&{int}) \\{mp\_font\_n}(\|p);\6
${}\\{gr\_font\_name}(\\{tt})\K\\{mp\_xstrdup}(\\{mp},\39\\{mp}\MG\\{font%
\_name}[\\{mp\_font\_n}(\|p)]);{}$\6
${}\\{gr\_font\_dsize}(\\{tt})\K\\{mp}\MG\\{font\_dsize}[\\{mp\_font\_n}(\|p)]/%
\T{65536.0};{}$\6
${}\\{export\_color}(\\{tt},\39\\{p0});{}$\6
${}\\{export\_scripts}(\\{tt},\39\|p);{}$\6
${}\\{gr\_width\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{width});{}$\6
${}\\{gr\_height\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{height});{}$%
\6
${}\\{gr\_depth\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{depth});{}$\6
${}\\{gr\_tx\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{tx});{}$\6
${}\\{gr\_ty\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{ty});{}$\6
${}\\{gr\_txx\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{txx});{}$\6
${}\\{gr\_txy\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{txy});{}$\6
${}\\{gr\_tyx\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{tyx});{}$\6
${}\\{gr\_tyy\_val}(\\{tt})\K\\{number\_to\_double}(\\{p0}\MG\\{tyy});$ $\}$ %
\&{break}; \&{case} \\{mp\_start\_clip\_node\_type}: \\{tc} $\K$ ( \\{mp\_clip%
\_object} $*$ ) \\{hq};\6
${}\\{gr\_path\_p}(\\{tc})\K\\{mp\_export\_knot\_list}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_start\_clip\_node}) \|p));\6
\&{break}; \&{case} \\{mp\_start\_bounds\_node\_type}: \\{tb} $\K$ ( \\{mp%
\_bounds\_object} $*$ ) \\{hq};\6
${}\\{gr\_path\_p}(\\{tb})\K\\{mp\_export\_knot\_list}(\\{mp},\39{}$\\{mp\_path%
\_p}((\&{mp\_start\_bounds\_node}) \|p));\6
\&{break};\6
\4\&{case} \\{mp\_stop\_clip\_node\_type}:\5
\&{case} \\{mp\_stop\_bounds\_node\_type}:\C{ nothing to do here }\6
\&{break};\6
\4\&{default}:\C{ there are no other valid cases, but please the compiler }\6
\&{break}; $\}$ \6
\&{if} ${}(\\{hh}\MG\\{body}\E\NULL){}$\1\5
${}\\{hh}\MG\\{body}\K\\{hq};{}$\2\6
\&{else}\1\5
${}\\{gr\_link}(\\{hp})\K\\{hq};{}$\2\6
${}\\{hp}\K\\{hq};{}$\6
${}\|p\K\\{mp\_link}(\|p);$ $\}$ \&{return} \\{hh}; $\}{}$\par
\fi

\M{1271}This function is only used for the \PB{\\{glyph}} operator, so
it takes quite a few shortcuts for cases that cannot appear
in the output of \PB{\\{mp\_ps\_font\_charstring}}.

\Y\B\&{mp\_edge\_header\_node} \\{mp\_gr\_import}(\&{MP} \\{mp}${},\39{}$%
\&{struct} \\{mp\_edge\_object} ${}{*}\\{hh}){}$\1\1 $\{$ \&{mp\_edge\_header%
\_node} \|h;\C{ the edge object }\6
\&{mp\_node} \\{ph}${},{}$ \\{pn}${},{}$ \\{pt};\C{ for adding items }\7
${}\\{mp\_graphic\_object}*\|p{}$;\C{ the current graphical object }\6
${}\|h\K\\{mp\_get\_edge\_header\_node}(\\{mp});{}$\6
${}\\{mp\_init\_edges}(\\{mp},\39\|h);{}$\6
${}\\{ph}\K\\{edge\_list}(\|h);{}$\6
${}\\{pt}\K\\{ph};{}$\6
${}\|p\K\\{hh}\MG\\{body};{}$\6
${}\\{set\_number\_from\_double}(\|h\MG\\{minx},\39\\{hh}\MG\\{minx});{}$\6
${}\\{set\_number\_from\_double}(\|h\MG\\{miny},\39\\{hh}\MG\\{miny});{}$\6
${}\\{set\_number\_from\_double}(\|h\MG\\{maxx},\39\\{hh}\MG\\{maxx});{}$\6
${}\\{set\_number\_from\_double}(\|h\MG\\{maxy},\39\\{hh}\MG\\{maxy});$ %
\&{while} ${}(\|p\I\NULL)$ $\{$ \&{switch} (\\{gr\_type}(\|p)) $\{$ \&{case} %
\\{mp\_fill\_code}: \&{if} ( \\{gr\_pen\_p} ( ( \\{mp\_fill\_object} $*$ ) \|p
) $\E$ $\NULL$ ) $\{$ \&{mp\_number} \\{turns};\7
\\{new\_number}(\\{turns});\6
${}\\{pn}\K\\{mp\_new\_fill\_node}(\\{mp},\39\NULL);$ \\{mp\_path\_p}((\&{mp%
\_fill\_node}) \\{pn})${}\K\\{mp\_import\_knot\_list}$ $(\\{mp},\39$ \\{gr%
\_path\_p} ( ( \\{mp\_fill\_object} $*$ ) \|p ) )  ;\6
${}\&{mp\_color\_model}(\\{pn})\K\\{mp\_grey\_model};{}$\6
${}\\{mp\_turn\_cycles}(\\{mp},\39{\AND}\\{turns},\39{}$\\{mp\_path\_p}((\&{mp%
\_fill\_node}) \\{pn}));\6
\&{if} (\\{number\_negative}(\\{turns}))\5
${}\{{}$\1\6
\\{set\_number\_to\_unity}(((\&{mp\_fill\_node}) \\{pn})${}\MG\\{grey});{}$\6
${}\\{mp\_link}(\\{pt})\K\\{pn};{}$\6
${}\\{pt}\K\\{mp\_link}(\\{pt});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
\\{set\_number\_to\_zero}(((\&{mp\_fill\_node}) \\{pn})${}\MG\\{grey});{}$\6
${}\\{mp\_link}(\\{pn})\K\\{mp\_link}(\\{ph});{}$\6
${}\\{mp\_link}(\\{ph})\K\\{pn};{}$\6
\&{if} ${}(\\{ph}\E\\{pt}){}$\1\5
${}\\{pt}\K\\{pn};{}$\2\6
\4${}\}{}$\2\6
\\{free\_number}(\\{turns}); $\}$ \&{break};\6
\4\&{case} \\{mp\_stroked\_code}:\5
\&{case} \\{mp\_text\_code}:\5
\&{case} \\{mp\_start\_clip\_code}:\5
\&{case} \\{mp\_stop\_clip\_code}:\5
\&{case} \\{mp\_start\_bounds\_code}:\5
\&{case} \\{mp\_stop\_bounds\_code}:\5
\&{case} \\{mp\_special\_code}:\5
\&{break}; $\}{}$\C{ all cases are enumerated }\6
$\|p\K\|p\MG\\{next};$ $\}$ \\{mp\_gr\_toss\_objects}(\\{hh});\6
\&{return} \|h; $\}{}$\par
\fi

\M{1272}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{struct} \\{mp\_edge\_object} ${}{*}{}$\\{mp\_gr\_export}(\&{MP} \\{mp}${},%
\39{}$\&{mp\_edge\_header\_node} \|h);\6
\&{mp\_edge\_header\_node} \\{mp\_gr\_import}(\&{MP} \\{mp}${},\39{}$\&{struct}
\\{mp\_edge\_object} ${}{*}\|h){}$;\par
\fi

\M{1273}This function is now nearly trivial.

\Y\B\&{void} \\{mp\_ship\_out}(\&{MP} \\{mp}${},\39{}$\&{mp\_node} \|h)\1\1\2\2%
\6
${}\{{}$\C{ output edge structure \PB{\|h} }\1\6
\&{int} \|c;\C{ \&{charcode} rounded to the nearest integer }\7
${}\|c\K\\{round\_unscaled}(\\{internal\_value}(\\{mp\_char\_code}));{}$\6
\X1258:Begin the progress report for the output of picture~\PB{\|c}\X;\6
${}(\\{mp}\MG\\{shipout\_backend})(\\{mp},\39\|h);{}$\6
\X1259:End progress report\X;\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_output})))\1\5
${}\\{mp\_print\_edges}(\\{mp},\39\|h,\39\.{"\ (just\ shipped\ out)}\)\.{"},\39%
\\{true});{}$\2\6
\4${}\}{}$\2\par
\fi

\M{1274}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_shipout\_backend}(\&{MP} \\{mp}${},\39{}$\&{void}
${}{*}\|h){}$;\par
\fi

\M{1275}
\Y\B\&{void} \\{mp\_shipout\_backend}(\&{MP} \\{mp}${},\39{}$\&{void} ${}{*}%
\\{voidh}){}$\1\1\2\2\6
${}\{{}$\1\6
\&{char} ${}{*}\|s;{}$\7
${}\\{mp\_edge\_object}*\\{hh}{}$;\C{ the first graphical object }\7
\&{mp\_edge\_header\_node} \|h${}\K{}$(\&{mp\_edge\_header\_node}) \\{voidh};\7
${}\\{hh}\K\\{mp\_gr\_export}(\\{mp},\39\|h);{}$\6
${}\|s\K\NULL;{}$\6
\&{if} ${}(\\{internal\_string}(\\{mp\_output\_format})\I\NULL){}$\1\5
${}\|s\K\\{mp\_str}(\\{mp},\39\\{internal\_string}(\\{mp\_output\_format}));{}$%
\2\6
\&{if} ${}(\|s\W\\{strcmp}(\|s,\39\.{"svg"})\E\T{0}){}$\5
${}\{{}$\1\6
(\&{void}) \\{mp\_svg\_gr\_ship\_out}${}(\\{hh},\39(\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_prologues}))/\T{65536}),\39\\{false});{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\|s\W\\{strcmp}(\|s,\39\.{"png"})\E\T{0}){}$\5
${}\{{}$\1\6
(\&{void}) \\{mp\_png\_gr\_ship\_out}${}(\\{hh},\39{}$(\&{const} \&{char}
${}{*})((\\{internal\_string}(\\{mp\_output\_format\_options}))\MG\\{str}),\39%
\\{false});{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
(\&{void}) \\{mp\_gr\_ship\_out}${}(\\{hh},\39(\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_prologues}))/\T{65536}),\39(\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_procset}))/\T{65536}),\39\\{false});{}$\6
\4${}\}{}$\2\6
\\{mp\_gr\_toss\_objects}(\\{hh});\6
\4${}\}{}$\2\par
\fi

\M{1276}\B\X15:Exported types\X${}\mathrel+\E{}$\6
\&{typedef} ${}\&{void}({*}\\{mp\_backend\_writer})(\&{MP},\39{}$\&{void}
${}{*}){}$;\par
\fi

\M{1277}\B\X26:Option variables\X${}\mathrel+\E{}$\6
\\{mp\_backend\_writer}\\{shipout\_backend};\par
\fi

\M{1278}Now that we've finished \PB{\\{ship\_out}}, let's look at the other
commands
by which a user can send things to the \.{GF} file.

\fi

\M{1279}\B\X14:Global variables\X${}\mathrel+\E{}$\6
\&{psout\_data} \\{ps};\6
\&{svgout\_data} \\{svg};\6
\&{pngout\_data} \\{png};\par
\fi

\M{1280}\B\X28:Allocate or initialize variables\X${}\mathrel+\E{}$\6
\\{mp\_ps\_backend\_initialize}(\\{mp});\6
\\{mp\_svg\_backend\_initialize}(\\{mp});\6
\\{mp\_png\_backend\_initialize}(\\{mp});\par
\fi

\M{1281}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\\{mp\_ps\_backend\_free}(\\{mp});\6
\\{mp\_svg\_backend\_free}(\\{mp});\6
\\{mp\_png\_backend\_free}(\\{mp});\par
\fi

\N{1}{1282}Dumping and undumping the tables.

When \.{MP} is started, it is possible to preload a macro file
containing definitions that will be usable in the main input
file. This action even takes place automatically, based on the
name of the executable (\.{mpost} will attempt to preload the
macros in the file \.{mpost.mp}). If such a preload is not
desired, the option variable \PB{\\{ini\_version}} has to be set \PB{\\{true}}.

The variable \PB{\\{mem\_file}} holds the open file pointer.

\Y\B\4\X14:Global variables\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{mem\_file}{}$;\C{ file for input or preloaded macros }\par
\fi

\M{1283}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{extern} \&{boolean} \\{mp\_load\_preload\_file}(\&{MP} \\{mp});\par
\fi

\M{1284}Preloading a file is a lot like \PB{\\{mp\_run}} itself, except that
\MP\ should not exit and that a bit of trickery is needed with
the input buffer to make sure that the preloading does not
interfere with the actual job.

\Y\B\&{boolean} \\{mp\_load\_preload\_file}(\&{MP} \\{mp})\1\1 $\{$ \&{size\_t}
\|k;\6
\&{in\_state\_record} \\{old\_state};\6
\&{integer} \\{old\_in\_open}${}\K\\{mp}\MG\\{in\_open};{}$\6
\&{void} ${}{*}\\{old\_cur\_file}\K\\{cur\_file};{}$\6
\&{char} ${}{*}\\{fname}\K\\{xstrdup}(\\{mp}\MG\\{name\_of\_file});{}$\6
\&{size\_t} \|l${}\K\\{strlen}(\\{fname});{}$\7
${}\\{old\_state}\K\\{mp}\MG\\{cur\_input};{}$\6
\\{str\_room}(\|l);\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\|l;{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{append\_char}({*}(\\{fname}+\|k));{}$\6
\4${}\}{}$\2\6
${}\\{name}\K\\{mp\_make\_string}(\\{mp});{}$\6
\&{if} ${}(\R\\{mp}\MG\\{log\_opened}){}$\5
${}\{{}$\1\6
\\{mp\_open\_log\_file}(\\{mp});\6
\4${}\}{}$\C{ \PB{\\{open\_log\_file}} doesn't \PB{\\{show\_context}}, so \PB{%
\\{limit}}                                    and \PB{\\{loc}} needn't be set
to meaningful values yet }\2\6
\&{if} (((\&{int}) \\{mp}${}\MG\\{term\_offset}+{}$(\&{int}) \\{strlen}(%
\\{fname}))${}>(\\{mp}\MG\\{max\_print\_line}-\T{2})){}$\1\5
\\{mp\_print\_ln}(\\{mp});\2\6
\&{else} \&{if} ${}((\\{mp}\MG\\{term\_offset}>\T{0})\V(\\{mp}\MG\\{file%
\_offset}>\T{0})){}$\1\5
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'\ '}));{}$\2\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'('}));{}$\6
${}\\{incr}(\\{mp}\MG\\{open\_parens});{}$\6
${}\\{mp\_print}(\\{mp},\39\\{fname});{}$\6
\\{update\_terminal}(\,); $\{$ \&{line} $\K$ \T{1};\6
${}\\{start}\K\\{loc}\K\\{limit}+(\\{mp}\MG\\{noninteractive}\?\T{0}:\T{1});{}$%
\6
${}\\{cur\_file}\K\\{mp}\MG\\{mem\_file};{}$\6
(\&{void}) \\{mp\_input\_ln}${}(\\{mp},\39\\{cur\_file});{}$\6
\\{mp\_firm\_up\_the\_line}(\\{mp});\6
${}\\{mp}\MG\\{buffer}[\\{limit}]\K\\{xord}(\.{'\%'});{}$\6
${}\\{mp}\MG\\{first}\K(\&{size\_t})(\\{limit}+\T{1});{}$\6
${}\\{loc}\K\\{start};$ $\}$ $\\{mp}\MG\\{reading\_preload}\K\\{true};{}$\6
\&{do}\5
${}\{{}$\1\6
\\{mp\_do\_statement}(\\{mp});\6
\4${}\}{}$\2\5
\&{while} ${}(\R(\\{cur\_cmd}(\,)\E\\{mp\_stop})){}$;\C{ "dump" or EOF }\6
${}\\{mp}\MG\\{reading\_preload}\K\\{false};{}$\6
${}\\{mp\_primitive}(\\{mp},\39\.{"dump"},\39\\{mp\_relax},\39\T{0}){}$;\C{
reset \PB{\\{dump}} }\6
\&{while} ${}(\\{mp}\MG\\{input\_ptr}>\T{0}){}$\5
${}\{{}$\1\6
\&{if} (\\{token\_state})\1\5
\\{mp\_end\_token\_list}(\\{mp});\2\6
\&{else}\1\5
\\{mp\_end\_file\_reading}(\\{mp});\2\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{loop\_ptr}\I\NULL){}$\1\5
\\{mp\_stop\_iteration}(\\{mp});\2\6
\&{while} ${}(\\{mp}\MG\\{open\_parens}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ )"});{}$\6
${}\\{decr}(\\{mp}\MG\\{open\_parens});{}$\6
\4${}\}{}$\2\6
;\6
\&{while} ${}(\\{mp}\MG\\{cond\_ptr}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(dump\ occurred\ when}\)\.{\ "});{}$\6
;\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{mp\_fi\_or\_else},\39\\{mp}\MG\\{cur%
\_if}){}$;\C{ `\.{if}' or `\.{elseif}' or `\.{else}' }\6
\&{if} ${}(\\{mp}\MG\\{if\_line}\I\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ on\ line\ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp}\MG\\{if\_line});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ was\ incomplete)"});{}$\6
${}\\{mp}\MG\\{if\_line}\K\\{if\_line\_field}(\\{mp}\MG\\{cond\_ptr});{}$\6
${}\\{mp}\MG\\{cur\_if}\K\\{mp\_name\_type}(\\{mp}\MG\\{cond\_ptr});{}$\6
${}\\{mp}\MG\\{cond\_ptr}\K\\{mp\_link}(\\{mp}\MG\\{cond\_ptr});{}$\6
\4${}\}{}$\C{  \PB{$(\\{mp}\MG\\{close\_file})(\\{mp},\\{mp}\MG\\{mem%
\_file});$} }\2\6
${}\\{cur\_file}\K\\{old\_cur\_file};{}$\6
${}\\{mp}\MG\\{cur\_input}\K\\{old\_state};{}$\6
${}\\{mp}\MG\\{in\_open}\K\\{old\_in\_open};{}$\6
\&{return} \\{true}; $\}{}$\par
\fi

\N{1}{1285}The main program.
This is it: the part of \MP\ that executes all those procedures we have
written.

Well---almost. We haven't put the parsing subroutines into the
program yet; and we'd better leave space for a few more routines that may
have been forgotten.

\Y\B\X931:Declare the basic parsing subroutines\X;\6
\X247:Declare miscellaneous procedures that were declared \PB{\\{forward}}\X\par
\fi

\M{1286}Here we do whatever is needed to complete \MP's job gracefully on the
local operating system. The code here might come into play after a fatal
error; it must therefore consist entirely of ``safe'' operations that
cannot produce error messages. For example, it would be a mistake to call
\PB{\\{str\_room}} or \PB{\\{make\_string}} at this time, because a call on %
\PB{\\{overflow}}
might lead to an infinite loop.

\fi

\M{1287}\B\&{void} \\{mp\_close\_files\_and\_terminate}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{integer} \|k;\C{ all-purpose index }\6
\&{integer} \.{LH};\C{ the length of the \.{TFM} header, in words }\6
\&{int} \\{lk\_offset};\C{ extra words inserted at beginning of \PB{\\{lig%
\_kern}} array }\6
\&{mp\_node} \|p;\C{ runs through a list of \.{TFM} dimensions }\7
\&{if} ${}(\\{mp}\MG\\{finished}){}$\1\5
\&{return};\2\6
\X1289:Close all open files in the \PB{\\{rd\_file}} and \PB{\\{wr\_file}}
arrays\X;\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_tracing\_stats})))\1\5
\X1292:Output statistics about this job\X;\2\6
\\{wake\_up\_terminal}(\,);\6
\X1291:Do all the finishing work on the \.{TFM} file\X;\6
\X1260:Explain what output files were written\X;\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}\W\R\\{mp}\MG\\{noninteractive}){}$\5
${}\{{}$\1\6
\\{wlog\_cr};\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{log\_file});{}$\6
${}\\{mp}\MG\\{selector}\K\\{mp}\MG\\{selector}-\T{2};{}$\6
\&{if} ${}(\\{mp}\MG\\{selector}\E\\{term\_only}){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"Transcript\ written\ }\)\.{on\ "});{}$\6
;\6
${}\\{mp\_print}(\\{mp},\39\\{mp}\MG\\{log\_name});{}$\6
${}\\{mp\_print\_char}(\\{mp},\39\\{xord}(\.{'.'}));{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\\{mp\_print\_ln}(\\{mp});\6
${}\\{mp}\MG\\{finished}\K\\{true};{}$\6
\4${}\}{}$\2\par
\fi

\M{1288}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_close\_files\_and\_terminate}(\&{MP} \\{mp});\par
\fi

\M{1289}\B\X1289:Close all open files in the \PB{\\{rd\_file}} and \PB{\\{wr%
\_file}} arrays\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{rd\_fname}\I\NULL){}$\5
${}\{{}$\1\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<{}$(\&{int}) \\{mp}${}\MG\\{read\_files};{}$
${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{rd\_fname}[\|k]\I\NULL){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{rd\_fname}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{wr\_fname}\I\NULL){}$\5
${}\{{}$\1\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<{}$(\&{int}) \\{mp}${}\MG\\{write\_files};{}$
${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{wr\_fname}[\|k]\I\NULL){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{wr\_file}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{wr\_fname}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U1287.\fi

\M{1290}\B\X27:Dealloc variables\X${}\mathrel+\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<{}$(\&{int}) \\{mp}${}\MG\\{max\_read%
\_files};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{rd\_fname}[\|k]\I\NULL){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{rd\_file}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{rd\_fname}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{rd\_file});{}$\6
${}\\{xfree}(\\{mp}\MG\\{rd\_fname});{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<{}$(\&{int}) \\{mp}${}\MG\\{max\_write%
\_files};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{mp}\MG\\{wr\_fname}[\|k]\I\NULL){}$\5
${}\{{}$\1\6
${}(\\{mp}\MG\\{close\_file})(\\{mp},\39\\{mp}\MG\\{wr\_file}[\|k]);{}$\6
${}\\{xfree}(\\{mp}\MG\\{wr\_fname}[\|k]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{xfree}(\\{mp}\MG\\{wr\_file});{}$\6
${}\\{xfree}(\\{mp}\MG\\{wr\_fname}){}$;\par
\fi

\M{1291}We want to produce a \.{TFM} file if and only if \PB{\\{mp%
\_fontmaking}} is positive.

We reclaim all of the variable-size memory at this point, so that
there is no chance of another memory overflow after the memory capacity
has already been exceeded.

\Y\B\4\X1291:Do all the finishing work on the \.{TFM} file\X${}\E{}$\6
\&{if} (\\{number\_positive}(\\{internal\_value}(\\{mp\_fontmaking})))\5
${}\{{}$\1\6
\X1204:Massage the \.{TFM} widths\X;\6
\\{mp\_fix\_design\_size}(\\{mp});\6
\\{mp\_fix\_check\_sum}(\\{mp});\6
\X1206:Massage the \.{TFM} heights, depths, and italic corrections\X;\6
\\{set\_number\_to\_zero}(\\{internal\_value}(\\{mp\_fontmaking}));\C{ avoid
loop in case of fatal error }\6
\X1217:Finish the \.{TFM} file\X;\6
\4${}\}{}$\2\par
\U1287.\fi

\M{1292}The present section goes directly to the log file instead of using
\PB{\\{print}} commands, because there's no need for these strings to take
up \PB{\\{str\_pool}} memory when a non-{\bf stat} version of \MP\ is being
used.

\Y\B\4\X1292:Output statistics about this job\X${}\E{}$\6
\&{if} ${}(\\{mp}\MG\\{log\_opened}){}$\5
${}\{{}$\1\6
\&{char} \|s[\T{128}];\7
\\{wlog\_ln}(\.{"\ "});\6
\\{wlog\_ln}(\.{"Here\ is\ how\ much\ of}\)\.{\ MetaPost's\ memory\ y}\)\.{ou\
used:"});\6
;\6
${}\\{mp\_snprintf}(\|s,\39\T{128},\39\.{"\ \%i\ string\%s\ using\ }\)\.{\%i\
character\%s"},\39{}$(\&{int}) \\{mp}${}\MG\\{max\_strs\_used},\39(\\{mp}\MG%
\\{max\_strs\_used}\I\T{1}\?\.{"s"}:\.{""}),\39{}$(\&{int}) \\{mp}${}\MG\\{max%
\_pl\_used},\39(\\{mp}\MG\\{max\_pl\_used}\I\T{1}\?\.{"s"}:\.{""}));{}$\6
\\{wlog\_ln}(\|s);\6
${}\\{mp\_snprintf}(\|s,\39\T{128},\39\.{"\ \%i\ bytes\ of\ node\ m}\)%
\.{emory"},\39{}$(\&{int}) \\{mp}${}\MG\\{var\_used\_max});{}$\6
\\{wlog\_ln}(\|s);\6
${}\\{mp\_snprintf}(\|s,\39\T{128},\39\.{"\ \%i\ symbolic\ tokens}\)\.{"},%
\39{}$(\&{int}) \\{mp}${}\MG\\{st\_count});{}$\6
\\{wlog\_ln}(\|s);\6
${}\\{mp\_snprintf}(\|s,\39\T{128},\39\.{"\ \%ii,\%in,\%ip,\%ib,\%i}\)\.{f\
stack\ positions\ ou}\)\.{t\ of\ \%ii,\%in,\%ip,\%ib}\)\.{,\%if"},\39{}$(%
\&{int}) \\{mp}${}\MG\\{max\_in\_stack},\39{}$(\&{int}) \\{mp}${}\MG\\{int%
\_ptr},\39{}$(\&{int}) \\{mp}${}\MG\\{max\_param\_stack},\39{}$(\&{int}) %
\\{mp}${}\MG\\{max\_buf\_stack}+\T{1},\39{}$(\&{int}) \\{mp}${}\MG\\{in\_open%
\_max}-\\{file\_bottom},\39{}$(\&{int}) \\{mp}${}\MG\\{stack\_size},\39{}$(%
\&{int}) \\{mp}${}\MG\\{max\_internal},\39{}$(\&{int}) \\{mp}${}\MG\\{param%
\_size},\39{}$(\&{int}) \\{mp}${}\MG\\{buf\_size},\39{}$(\&{int}) \\{mp}${}\MG%
\\{max\_in\_open}-\\{file\_bottom});{}$\6
\\{wlog\_ln}(\|s);\6
\4${}\}{}$\2\par
\U1287.\fi

\M{1293}It is nice to have have some of the stats available from the API.

\Y\B\4\X18:Exported function headers\X${}\mathrel+\E{}$\6
\&{int} \\{mp\_memory\_usage}(\&{MP} \\{mp});\6
\&{int} \\{mp\_hash\_usage}(\&{MP} \\{mp});\6
\&{int} \\{mp\_param\_usage}(\&{MP} \\{mp});\6
\&{int} \\{mp\_open\_usage}(\&{MP} \\{mp});\par
\fi

\M{1294}\B\&{int} \\{mp\_memory\_usage}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} (\&{int}) \\{mp}${}\MG\\{var\_used};{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_hash\_usage}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} (\&{int}) \\{mp}${}\MG\\{st\_count};{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_param\_usage}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} (\&{int}) \\{mp}${}\MG\\{max\_param\_stack};{}$\6
\4${}\}{}$\2\7
\&{int} \\{mp\_open\_usage}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\1\6
\&{return} (\&{int}) \\{mp}${}\MG\\{max\_in\_stack};{}$\6
\4${}\}{}$\2\par
\fi

\M{1295}We get to the \PB{\\{final\_cleanup}} routine when \&{end} or \&{dump}
has
been scanned.

\Y\B\&{void} \\{mp\_final\_cleanup}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ -Wunused: integer c; }\C{ 0 for \&{end}, 1 for \&{dump} }\C{ clang:
never read: c = cur\_mod(); }\1\6
\&{if} ${}(\\{mp}\MG\\{job\_name}\E\NULL){}$\1\5
\\{mp\_open\_log\_file}(\\{mp});\2\6
\&{while} ${}(\\{mp}\MG\\{input\_ptr}>\T{0}){}$\5
${}\{{}$\1\6
\&{if} (\\{token\_state})\1\5
\\{mp\_end\_token\_list}(\\{mp});\2\6
\&{else}\1\5
\\{mp\_end\_file\_reading}(\\{mp});\2\6
\4${}\}{}$\2\6
\&{while} ${}(\\{mp}\MG\\{loop\_ptr}\I\NULL){}$\1\5
\\{mp\_stop\_iteration}(\\{mp});\2\6
\&{while} ${}(\\{mp}\MG\\{open\_parens}>\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ )"});{}$\6
${}\\{decr}(\\{mp}\MG\\{open\_parens});{}$\6
\4${}\}{}$\2\6
;\6
\&{while} ${}(\\{mp}\MG\\{cond\_ptr}\I\NULL){}$\5
${}\{{}$\1\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(end\ occurred\ when\ }\)\.{"});{}$\6
;\6
${}\\{mp\_print\_cmd\_mod}(\\{mp},\39\\{mp\_fi\_or\_else},\39\\{mp}\MG\\{cur%
\_if}){}$;\C{ `\.{if}' or `\.{elseif}' or `\.{else}' }\6
\&{if} ${}(\\{mp}\MG\\{if\_line}\I\T{0}){}$\5
${}\{{}$\1\6
${}\\{mp\_print}(\\{mp},\39\.{"\ on\ line\ "});{}$\6
${}\\{mp\_print\_int}(\\{mp},\39\\{mp}\MG\\{if\_line});{}$\6
\4${}\}{}$\2\6
${}\\{mp\_print}(\\{mp},\39\.{"\ was\ incomplete)"});{}$\6
${}\\{mp}\MG\\{if\_line}\K\\{if\_line\_field}(\\{mp}\MG\\{cond\_ptr});{}$\6
${}\\{mp}\MG\\{cur\_if}\K\\{mp\_name\_type}(\\{mp}\MG\\{cond\_ptr});{}$\6
${}\\{mp}\MG\\{cond\_ptr}\K\\{mp\_link}(\\{mp}\MG\\{cond\_ptr});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{mp}\MG\\{history}\I\\{mp\_spotless}){}$\1\6
\&{if} ${}(((\\{mp}\MG\\{history}\E\\{mp\_warning\_issued})\V(\\{mp}\MG%
\\{interaction}<\\{mp\_error\_stop\_mode}))){}$\1\6
\&{if} ${}(\\{mp}\MG\\{selector}\E\\{term\_and\_log}){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{selector}\K\\{term\_only};{}$\6
${}\\{mp\_print\_nl}(\\{mp},\39\.{"(see\ the\ transcript}\)\.{\ file\ for\
additional}\)\.{\ information)"});{}$\6
;\6
${}\\{mp}\MG\\{selector}\K\\{term\_and\_log};{}$\6
\4${}\}{}$\2\2\2\6
\4${}\}{}$\2\par
\fi

\M{1296}\B\X8:Declarations\X${}\mathrel+\E{}$\6
\&{static} \&{void} \\{mp\_final\_cleanup}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_init\_prim}(\&{MP} \\{mp});\6
\&{static} \&{void} \\{mp\_init\_tab}(\&{MP} \\{mp});\par
\fi

\M{1297}\B\&{void} \\{mp\_init\_prim}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ initialize all the primitives }\1\6
\X200:Put each of \MP's primitives into the hash table\X;\6
\4${}\}{}$\2\7
\&{void} \\{mp\_init\_tab}(\&{MP} \\{mp})\1\1\2\2\6
${}\{{}$\C{ initialize other tables }\1\6
\X182:Initialize table entries\X;\6
\4${}\}{}$\2\par
\fi

\M{1298}When we begin the following code, \MP's tables may still contain
garbage;
thus we must proceed cautiously to get bootstrapped in.

But when we finish this part of the program, \MP\ is ready to call on the
\PB{\\{main\_control}} routine to do its work.

\Y\B\4\X1298:Get the first line of input and prepare to start\X${}\E{}$\6
${}\{{}$\1\6
\X717:Initialize the input routines\X;\6
\&{if} ${}(\R\\{mp}\MG\\{ini\_version}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{mp\_load\_preload\_file}(\\{mp})){}$\5
${}\{{}$\1\6
${}\\{mp}\MG\\{history}\K\\{mp\_fatal\_error\_stop};{}$\6
\&{return} \\{mp};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\X1299:Initializations following first line\X;\6
\4${}\}{}$\2\par
\U16.\fi

\M{1299}\B\X1299:Initializations following first line\X${}\E{}$\6
$\\{mp}\MG\\{buffer}[\\{limit}]\K{}$(\&{ASCII\_code}) \.{'\%'};\6
\\{mp\_fix\_date\_and\_time}(\\{mp});\6
\&{if} ${}(\\{mp}\MG\\{random\_seed}\E\T{0}){}$\1\5
${}\\{mp}\MG\\{random\_seed}\K(\\{number\_to\_scaled}(\\{internal\_value}(\\{mp%
\_time}))/\\{number\_to\_scaled}(\\{unity\_t}))+\\{number\_to\_scaled}(%
\\{internal\_value}(\\{mp\_day}));{}$\2\6
${}\\{init\_randoms}(\\{mp}\MG\\{random\_seed});{}$\6
\\{initialize\_print\_selector}(\,);\6
\\{mp\_normalize\_selector}(\\{mp});\6
\&{if} ${}(\\{loc}<\\{limit}){}$\1\6
\&{if} ${}(\\{mp}\MG\\{buffer}[\\{loc}]\I\.{'\\\\'}){}$\1\5
\\{mp\_start\_input}(\\{mp});\C{ \&{input} assumed }\2\2\par
\U1298.\fi

\N{1}{1300}Debugging.


\fi

\N{1}{1301}System-dependent changes.
This section should be replaced, if necessary, by any special
modification of the program
that are necessary to make \MP\ work at a particular installation.
It is usually best to design your change file so that all changes to
previous sections preserve the section numbering; then everybody's version
will be consistent with the published program. More extensive changes,
which introduce new sections, can be inserted here; then only the index
itself will get a new section number.

\fi

\N{1}{1302}Index.
Here is where you can find all uses of each identifier in the program,
with underlined entries pointing to where the identifier was defined.
If the identifier is only one letter long, however, you get to see only
the underlined entries. {\sl All references are to section numbers instead of
page numbers.}

This index also lists error messages and other aspects of the program
that you might want to look up some day. For example, the entry
for ``system dependencies'' lists all sections that should receive
special attention from people who are installing \MP\ in a new
operating environment. A list of various things that can't happen appears
under ``this can't happen''.
Approximately 25 sections are listed under ``inner loop''; these account
for more than 60\pct! of \MP's running time, exclusive of input and output.
\fi

\inx
\fin
\con
